<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › das08.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>das08.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  comedi/drivers/das08.c</span>
<span class="cm"> *  DAS08 driver</span>
<span class="cm"> *</span>
<span class="cm"> *  COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm"> *  Copyright (C) 2000 David A. Schleef &lt;ds@schleef.org&gt;</span>
<span class="cm"> *  Copyright (C) 2001,2002,2003 Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>
<span class="cm"> *  Copyright (C) 2004 Salvador E. Tropea &lt;set@users.sf.net&gt; &lt;set@ieee.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Driver: das08</span>
<span class="cm"> * Description: DAS-08 compatible boards</span>
<span class="cm"> * Author: Warren Jasper, ds, Frank Hess</span>
<span class="cm"> * Devices: [Keithley Metrabyte] DAS08 (isa-das08),</span>
<span class="cm"> *   [ComputerBoards] DAS08 (isa-das08), DAS08-PGM (das08-pgm),</span>
<span class="cm"> *   DAS08-PGH (das08-pgh), DAS08-PGL (das08-pgl), DAS08-AOH (das08-aoh),</span>
<span class="cm"> *   DAS08-AOL (das08-aol), DAS08-AOM (das08-aom), DAS08/JR-AO (das08/jr-ao),</span>
<span class="cm"> *   DAS08/JR-16-AO (das08jr-16-ao), PCI-DAS08 (das08),</span>
<span class="cm"> *   PC104-DAS08 (pc104-das08), DAS08/JR/16 (das08jr/16)</span>
<span class="cm"> * Status: works</span>
<span class="cm"> *</span>
<span class="cm"> * This is a rewrite of the das08 and das08jr drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * Options (for ISA cards):</span>
<span class="cm"> *		[0] - base io address</span>
<span class="cm"> *</span>
<span class="cm"> * Options (for pci-das08):</span>
<span class="cm"> *		[0] - bus  (optional)</span>
<span class="cm"> *		[1] = slot (optional)</span>
<span class="cm"> *</span>
<span class="cm"> * The das08 driver doesn&#39;t support asynchronous commands, since</span>
<span class="cm"> * the cheap das08 hardware doesn&#39;t really support them.  The</span>
<span class="cm"> * comedi_rt_timer driver can be used to emulate commands for this</span>
<span class="cm"> * driver.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &quot;comedi_pci.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>
<span class="cp">#include &quot;das08.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;das08&quot;</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA_MODULE</span>
<span class="cp">#define CONFIG_COMEDI_DAS08_ISA</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI_MODULE</span>
<span class="cp">#define CONFIG_COMEDI_DAS08_PCI</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_CS_MODULE</span>
<span class="cp">#define CONFIG_COMEDI_DAS08_CS</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_COMEDI_DAS08_ISA) || defined(CONFIG_COMEDI_DAS08_PCI)</span>
<span class="cp">#define DO_COMEDI_DRIVER_REGISTER</span>
<span class="cp">#endif</span>

<span class="cp">#define PCI_VENDOR_ID_COMPUTERBOARDS 0x1307</span>
<span class="cp">#define PCI_DEVICE_ID_PCIDAS08 0x29</span>
<span class="cp">#define PCIDAS08_SIZE 0x54</span>

<span class="cm">/* pci configuration registers */</span>
<span class="cp">#define INTCSR               0x4c</span>
<span class="cp">#define   INTR1_ENABLE         0x1</span>
<span class="cp">#define   INTR1_HIGH_POLARITY  0x2</span>
<span class="cp">#define   PCI_INTR_ENABLE      0x40</span>
<span class="cp">#define   INTR1_EDGE_TRIG      0x100	</span><span class="cm">/*  requires high polarity */</span><span class="cp"></span>
<span class="cp">#define CNTRL                0x50</span>
<span class="cp">#define   CNTRL_DIR            0x2</span>
<span class="cp">#define   CNTRL_INTR           0x4</span>

<span class="cm">/*</span>
<span class="cm">    cio-das08.pdf</span>

<span class="cm">  &quot;isa-das08&quot;</span>

<span class="cm">  0	a/d bits 0-3		start 8 bit</span>
<span class="cm">  1	a/d bits 4-11		start 12 bit</span>
<span class="cm">  2	eoc, ip1-3, irq, mux	op1-4, inte, mux</span>
<span class="cm">  3	unused			unused</span>
<span class="cm">  4567	8254</span>
<span class="cm">  89ab	8255</span>

<span class="cm">  requires hard-wiring for async ai</span>

<span class="cm">*/</span>

<span class="cp">#define DAS08_LSB		0</span>
<span class="cp">#define DAS08_MSB		1</span>
<span class="cp">#define DAS08_TRIG_12BIT	1</span>
<span class="cp">#define DAS08_STATUS		2</span>
<span class="cp">#define   DAS08_EOC			(1&lt;&lt;7)</span>
<span class="cp">#define   DAS08_IRQ			(1&lt;&lt;3)</span>
<span class="cp">#define   DAS08_IP(x)			(((x)&gt;&gt;4)&amp;0x7)</span>
<span class="cp">#define DAS08_CONTROL		2</span>
<span class="cp">#define   DAS08_MUX_MASK	0x7</span>
<span class="cp">#define   DAS08_MUX(x)		((x) &amp; DAS08_MUX_MASK)</span>
<span class="cp">#define   DAS08_INTE			(1&lt;&lt;3)</span>
<span class="cp">#define   DAS08_DO_MASK		0xf0</span>
<span class="cp">#define   DAS08_OP(x)		(((x) &lt;&lt; 4) &amp; DAS08_DO_MASK)</span>

<span class="cm">/*</span>
<span class="cm">    cio-das08jr.pdf</span>

<span class="cm">  &quot;das08/jr-ao&quot;</span>

<span class="cm">  0	a/d bits 0-3		unused</span>
<span class="cm">  1	a/d bits 4-11		start 12 bit</span>
<span class="cm">  2	eoc, mux		mux</span>
<span class="cm">  3	di			do</span>
<span class="cm">  4	unused			ao0_lsb</span>
<span class="cm">  5	unused			ao0_msb</span>
<span class="cm">  6	unused			ao1_lsb</span>
<span class="cm">  7	unused			ao1_msb</span>

<span class="cm">*/</span>

<span class="cp">#define DAS08JR_DIO		3</span>
<span class="cp">#define DAS08JR_AO_LSB(x)	((x) ? 6 : 4)</span>
<span class="cp">#define DAS08JR_AO_MSB(x)	((x) ? 7 : 5)</span>

<span class="cm">/*</span>
<span class="cm">    cio-das08_aox.pdf</span>

<span class="cm">  &quot;das08-aoh&quot;</span>
<span class="cm">  &quot;das08-aol&quot;</span>
<span class="cm">  &quot;das08-aom&quot;</span>

<span class="cm">  0	a/d bits 0-3		start 8 bit</span>
<span class="cm">  1	a/d bits 4-11		start 12 bit</span>
<span class="cm">  2	eoc, ip1-3, irq, mux	op1-4, inte, mux</span>
<span class="cm">  3	mux, gain status	gain control</span>
<span class="cm">  4567	8254</span>
<span class="cm">  8	unused			ao0_lsb</span>
<span class="cm">  9	unused			ao0_msb</span>
<span class="cm">  a	unused			ao1_lsb</span>
<span class="cm">  b	unused			ao1_msb</span>
<span class="cm">  89ab</span>
<span class="cm">  cdef	8255</span>
<span class="cm">*/</span>

<span class="cp">#define DAS08AO_GAIN_CONTROL	3</span>
<span class="cp">#define DAS08AO_GAIN_STATUS	3</span>

<span class="cp">#define DAS08AO_AO_LSB(x)	((x) ? 0xa : 8)</span>
<span class="cp">#define DAS08AO_AO_MSB(x)	((x) ? 0xb : 9)</span>
<span class="cp">#define DAS08AO_AO_UPDATE	8</span>

<span class="cm">/* gainlist same as _pgx_ below */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">das08_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08_di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08_do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08jr_di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08jr_do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08jr_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08ao_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i8254_set_mode_low</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das08_pgl</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">)</span>
							  <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das08_pgh</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">12</span><span class="p">,</span> <span class="p">{</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							   <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.005</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							   <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_das08_pgm</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
							  <span class="p">}</span>
<span class="p">};</span>				<span class="cm">/*</span>
<span class="cm">				   cio-das08jr.pdf</span>

<span class="cm">				   &quot;das08/jr-ao&quot;</span>

<span class="cm">				   0 a/d bits 0-3            unused</span>
<span class="cm">				   1 a/d bits 4-11           start 12 bit</span>
<span class="cm">				   2 eoc, mux                mux</span>
<span class="cm">				   3 di                      do</span>
<span class="cm">				   4 unused                  ao0_lsb</span>
<span class="cm">				   5 unused                  ao0_msb</span>
<span class="cm">				   6 unused                  ao1_lsb</span>
<span class="cm">				   7 unused                  ao1_msb</span>

<span class="cm">				 */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="k">const</span> <span class="n">das08_ai_lranges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_bipolar5</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das08_pgh</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das08_pgl</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">range_das08_pgm</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">das08_pgh_gainlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">das08_pgl_gainlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">das08_pgm_gainlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="k">const</span> <span class="n">das08_gainlists</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="n">das08_pgh_gainlist</span><span class="p">,</span>
	<span class="n">das08_pgl_gainlist</span><span class="p">,</span>
	<span class="n">das08_pgm_gainlist</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef DO_COMEDI_DRIVER_REGISTER</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">das08_board_struct</span> <span class="n">das08_boards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;isa-das08&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pg_none</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08-pgm&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08pgx.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pgm</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08-pgh&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08pgx.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pgh</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08-pgl&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08pgx.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pgl</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08-aoh&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08_aox.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pgh</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">das08ao_ao_winsn</span><span class="p">,</span>	<span class="cm">/*  8 */</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08-aol&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08_aox.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pgl</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">das08ao_ao_winsn</span><span class="p">,</span>	<span class="cm">/*  8 */</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08-aom&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08_aox.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pgm</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">das08ao_ao_winsn</span><span class="p">,</span>	<span class="cm">/*  8 */</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08/jr-ao&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08-jr-ao.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pg_none</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">das08jr_ao_winsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08jr_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08jr_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08jr-16-ao&quot;</span><span class="p">,</span>	<span class="cm">/*  cio-das08jr-16-ao.pdf */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pg_none</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">das08jr_ao_winsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08jr_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08jr_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pc104-das08&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">pc104</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pg_none</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;das08/f&quot;,</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;das08jr&quot;,</span>
<span class="c">	 },</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08jr/16&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">isa</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_pg_none</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode16</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08jr_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08jr_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/*  unchecked */</span>
	 <span class="p">},</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;das48-pga&quot;,	/*  cio-das48-pga.pdf */</span>
<span class="c">	 },</span>
<span class="c">	{</span>
<span class="c">	 .name = &quot;das08-pga-g2&quot;,	/*  a KM board */</span>
<span class="c">	 },</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMEDI_DAS08_ISA */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08&quot;</span><span class="p">,</span>	<span class="cm">/*  pci-das08 */</span>
	 <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_PCIDAS08</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">pci</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_bipolar5</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMEDI_DAS08_PCI */</span><span class="cp"></span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* DO_COMEDI_DRIVER_REGISTER */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_CS</span>
<span class="k">struct</span> <span class="n">das08_board_struct</span> <span class="n">das08_cs_boards</span><span class="p">[</span><span class="n">NUM_DAS08_CS_BOARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pcm-das08&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>		<span class="cm">/*  XXX */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">pcmcia</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_bipolar5</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_pcm_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="cm">/*  duplicate so driver name can be used also */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;das08_cs&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>		<span class="cm">/*  XXX */</span>
	 <span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">pcmcia</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">das08_ai_rinsn</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_nbits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_pg</span> <span class="o">=</span> <span class="n">das08_bipolar5</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ai_encoding</span> <span class="o">=</span> <span class="n">das08_pcm_encode12</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ao_nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">das08_di_rbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_</span> <span class="o">=</span> <span class="n">das08_do_wbits</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">do_nchan</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8255_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">i8254_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">iosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">das08_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_PCIDAS08</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">das08_pci_table</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define devpriv ((struct das08_private_struct *)dev-&gt;private)</span>
<span class="cp">#define thisboard ((const struct das08_board_struct *)dev-&gt;board_ptr)</span>

<span class="cp">#define TIMEOUT 100000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* clear crap */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_LSB</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_MSB</span><span class="p">);</span>

	<span class="cm">/* set multiplexer */</span>
	<span class="cm">/*  lock to prevent race with digital output */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAS08_MUX_MASK</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span> <span class="o">|=</span> <span class="n">DAS08_MUX</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_CONTROL</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set gain/range */</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pg_gainlist</span><span class="p">[</span><span class="n">range</span><span class="p">],</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08AO_GAIN_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear over-range bits for 16-bit boards */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_nbits</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_MSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;das08: over-range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* trigger conversion */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_TRIG_12BIT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DAS08_EOC</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;das08: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_MSB</span><span class="p">);</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_LSB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_encoding</span> <span class="o">==</span> <span class="n">das08_encode12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsb</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_encoding</span> <span class="o">==</span> <span class="n">das08_pcm_encode12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">lsb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_encoding</span> <span class="o">==</span> <span class="n">das08_encode16</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FPOS 16-bit boards are sign-magnitude */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">lsb</span> <span class="o">|</span> <span class="p">((</span><span class="n">msb</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">lsb</span> <span class="o">|</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! unknown ai encoding&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAS08_IP</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_STATUS</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wbits</span><span class="p">;</span>

	<span class="cm">/*  get current settings of digital output lines */</span>
	<span class="n">wbits</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="cm">/*  null bits we are going to set */</span>
	<span class="n">wbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/*  set new bit values */</span>
	<span class="n">wbits</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="cm">/*  remember digital output bits */</span>
	<span class="cm">/*  prevent race with setting of analog input mux */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAS08_DO_MASK</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span> <span class="o">|=</span> <span class="n">DAS08_OP</span><span class="p">(</span><span class="n">wbits</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_mux_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08_CONTROL</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wbits</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08jr_di_rbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08JR_DIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08jr_do_wbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  null bits we are going to set */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/*  set new bit values */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_bits</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08JR_DIO</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">do_bits</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08jr_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">lsb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		outb(lsb, dev-&gt;iobase + devpriv-&gt;ao_offset_lsb[chan]);</span>
<span class="c">		outb(msb, dev-&gt;iobase + devpriv-&gt;ao_offset_msb[chan]);</span>
<span class="cp">#else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08JR_AO_LSB</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08JR_AO_MSB</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="cm">/* load DACs */</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08JR_DIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * The -aox boards have the DACs at a different offset and use</span>
<span class="cm"> * a different method to force an update.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08ao_ao_winsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">lsb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		outb(lsb, dev-&gt;iobase + devpriv-&gt;ao_offset_lsb[chan]);</span>
<span class="c">		outb(msb, dev-&gt;iobase + devpriv-&gt;ao_offset_msb[chan]);</span>
<span class="cp">#else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08AO_AO_LSB</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08AO_AO_MSB</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="cm">/* load DACs */</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DAS08AO_AO_UPDATE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i8254_read_channel_low</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msb</span><span class="p">,</span> <span class="n">lsb</span><span class="p">;</span>

	<span class="cm">/* The following instructions must be in order.</span>
<span class="cm">	   We must avoid other process reading the counter&#39;s value in the</span>
<span class="cm">	   middle.</span>
<span class="cm">	   The spin_lock isn&#39;t needed since ioctl calls grab the big kernel</span>
<span class="cm">	   lock automatically */</span>
	<span class="cm">/*spin_lock(sp); */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">I8254_CTRL</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">lsb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">msb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="cm">/*spin_unlock(sp); */</span>

	<span class="k">return</span> <span class="n">lsb</span> <span class="o">|</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8254_write_channel_low</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msb</span><span class="p">,</span> <span class="n">lsb</span><span class="p">;</span>

	<span class="n">lsb</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">msb</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* write lsb, then msb */</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="cm">/* See comments in i8254_read_channel_low */</span>
	<span class="cm">/*spin_lock(sp); */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="cm">/*spin_unlock(sp); */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i8254_read_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">i8254_struct</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">logic2phys</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">i8254_read_channel_low</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8254_write_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">i8254_struct</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">logic2phys</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="n">i8254_write_channel_low</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8254_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">i8254_struct</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">i8254_set_mode_low</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8254_set_mode_low</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x30</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">I8254_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8254_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i8254_struct</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">logic2phys</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i8254_set_mode_low</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i8254_read_status_low</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xE0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">I8254_CTRL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i8254_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">i8254_struct</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">logic2phys</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">i8254_read_status_low</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_counter_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">;</span>

	<span class="cm">/* printk(&quot;Reading counter channel %d &quot;,chan); */</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i8254_read_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="cm">/* printk(&quot;=&gt; 0x%08X\n&quot;,data[0]); */</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_counter_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">;</span>

	<span class="cm">/* printk(&quot;Writing counter channel %d with 0x%04X\n&quot;,chan,data[0]); */</span>
	<span class="n">i8254_write_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_counter_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_COUNTER_MODE</span>:
		<span class="n">i8254_set_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_8254_READ_STATUS</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i8254_read_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DO_COMEDI_DRIVER_REGISTER</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">das08_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">driver_das08</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">das08_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">das08_common_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">das08_boards</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">das08_boards</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">das08_board_struct</span><span class="p">),</span>
	<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">das08_board_struct</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">das08_common_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*  allocate ioports for non-pcmcia, non-pci boards */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">pcmcia</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">pci</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; iobase 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">iosize</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* ai */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="cm">/* XXX some boards actually have differential</span>
<span class="cm">		 * inputs instead of single ended.</span>
<span class="cm">		 * The driver does nothing with arefs though,</span>
<span class="cm">		 * so it&#39;s no big deal.</span>
<span class="cm">		 */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">das08_ai_lranges</span><span class="p">[</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pg_gainlist</span> <span class="o">=</span> <span class="n">das08_gainlists</span><span class="p">[</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ai_pg</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* ao */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
<span class="cm">/* XXX lacks read-back insn */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao_nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar5</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* di */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">di</span> <span class="o">==</span> <span class="n">das08_di_rbits</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">do_</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">do_nchan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">do_</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* 8255 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">i8255_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
							       <span class="n">thisboard</span><span class="o">-&gt;</span>
							       <span class="n">i8255_offset</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="cm">/* 8254 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">i8254_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_COUNTER</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">das08_counter_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">das08_counter_write</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="n">das08_counter_config</span><span class="p">;</span>
		<span class="cm">/* Set-up the 8254 structure */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">logic2phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">logic2phys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">logic2phys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">i8254_offset</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">I8254_MODE0</span> <span class="o">|</span> <span class="n">I8254_BINARY</span><span class="p">;</span>
		<span class="n">i8254_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">das08_common_attach</span><span class="p">);</span>

<span class="cp">#ifdef DO_COMEDI_DRIVER_REGISTER</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">das08_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pci_iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">das08_private_struct</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: das08: &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
	<span class="cm">/*  deal with a pci board */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bus %i slot %i &quot;</span><span class="p">,</span>
			       <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*  find card */</span>
		<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_COMPUTERBOARDS</span>
			    <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_PCIDAS08</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					    <span class="o">&amp;&amp;</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span>
					    <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No pci das08 cards found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
		<span class="cm">/*  enable PCI device and reserve I/O spaces */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; Error enabling PCI device and &quot;</span>
						<span class="s">&quot;requesting regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  read base addresses */</span>
		<span class="n">pci_iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcibase 0x%lx  iobase 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">pci_iobase</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">=</span> <span class="n">pci_iobase</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* We could enable to pci-das08&#39;s interrupt here to make it possible</span>
<span class="c"> * to do timed input in this driver, but there is little point since</span>
<span class="c"> * conversions would have to be started by the interrupt handler</span>
<span class="c"> * so you might as well use comedi_rt_timer to emulate commands</span>
<span class="c"> */</span>
<span class="c">		/* set source of interrupt trigger to counter2 output */</span>
<span class="c">		outb(CNTRL_INTR | CNTRL_DIR, pci_iobase + CNTRL);</span>
<span class="c">		/* Enable local interrupt 1 and pci interrupt */</span>
<span class="c">		outw(INTR1_ENABLE | PCI_INTR_ENABLE, pci_iobase + INTCSR);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMEDI_DAS08_PCI */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">das08_common_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DO_COMEDI_DRIVER_REGISTER */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">das08_common_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span>
		<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">pcmcia</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">pci</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">thisboard</span><span class="o">-&gt;</span><span class="n">iosize</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">das08_common_detach</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">driver_das08_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_das08</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">driver_das08_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver_das08_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">das08_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver_das08_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_das08_pci_remove</span><span class="p">)</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMEDI_DAS08_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">driver_das08_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DO_COMEDI_DRIVER_REGISTER</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">comedi_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_das08</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
	<span class="n">driver_das08_pci_driver</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">driver_das08</span><span class="p">.</span><span class="n">driver_name</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_das08_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">driver_das08_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_COMEDI_DAS08_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_das08_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DO_COMEDI_DRIVER_REGISTER</span>
	<span class="n">comedi_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_das08</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">driver_das08_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">driver_das08_cleanup_module</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMEDI_DAS08_CS</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">das08_cs_boards</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
