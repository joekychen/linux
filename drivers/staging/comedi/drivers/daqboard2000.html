<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › daqboard2000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>daqboard2000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   comedi/drivers/daqboard2000.c</span>
<span class="cm">   hardware driver for IOtech DAQboard/2000</span>

<span class="cm">   COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">   Copyright (C) 1999 Anders Blomdell &lt;anders.blomdell@control.lth.se&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm">Driver: daqboard2000</span>
<span class="cm">Description: IOTech DAQBoard/2000</span>
<span class="cm">Author: Anders Blomdell &lt;anders.blomdell@control.lth.se&gt;</span>
<span class="cm">Status: works</span>
<span class="cm">Updated: Mon, 14 Apr 2008 15:28:52 +0100</span>
<span class="cm">Devices: [IOTech] DAQBoard/2000 (daqboard2000)</span>

<span class="cm">Much of the functionality of this driver was determined from reading</span>
<span class="cm">the source code for the Windows driver.</span>

<span class="cm">The FPGA on the board requires initialization code, which can</span>
<span class="cm">be loaded by comedi_config using the -i</span>
<span class="cm">option.  The initialization code is available from http://www.comedi.org</span>
<span class="cm">in the comedi_nonfree_firmware tarball.</span>

<span class="cm">Configuration options:</span>
<span class="cm">  [0] - PCI bus of device (optional)</span>
<span class="cm">  [1] - PCI slot of device (optional)</span>
<span class="cm">  If bus/slot is not specified, the first supported</span>
<span class="cm">  PCI device found will be used.</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">   This card was obviously never intended to leave the Windows world,</span>
<span class="cm">   since it lacked all kind of hardware documentation (except for cable</span>
<span class="cm">   pinouts, plug and pray has something to catch up with yet).</span>

<span class="cm">   With some help from our swedish distributor, we got the Windows sourcecode</span>
<span class="cm">   for the card, and here are the findings so far.</span>

<span class="cm">   1. A good document that describes the PCI interface chip is 9080db-106.pdf</span>
<span class="cm">      available from http://www.plxtech.com/products/io/pci9080 </span>

<span class="cm">   2. The initialization done so far is:</span>
<span class="cm">        a. program the FPGA (windows code sans a lot of error messages)</span>
<span class="cm">	b.</span>

<span class="cm">   3. Analog out seems to work OK with DAC&#39;s disabled, if DAC&#39;s are enabled,</span>
<span class="cm">      you have to output values to all enabled DAC&#39;s until result appears, I</span>
<span class="cm">      guess that it has something to do with pacer clocks, but the source</span>
<span class="cm">      gives me no clues. I&#39;ll keep it simple so far.</span>

<span class="cm">   4. Analog in.</span>
<span class="cm">        Each channel in the scanlist seems to be controlled by four</span>
<span class="cm">	control words:</span>

<span class="cm">        Word0:</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">          ! | | | ! | | | ! | | | ! | | | !</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<span class="cm">        Word1:</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">          ! | | | ! | | | ! | | | ! | | | !</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">	   |             |       | | | | |</span>
<span class="cm">           +------+------+       | | | | +-- Digital input (??)</span>
<span class="cm">		  |		 | | | +---- 10 us settling time</span>
<span class="cm">		  |		 | | +------ Suspend acquisition (last to scan)</span>
<span class="cm">		  |		 | +-------- Simultaneous sample and hold</span>
<span class="cm">		  |		 +---------- Signed data format</span>
<span class="cm">		  +------------------------- Correction offset low</span>

<span class="cm">        Word2:</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">          ! | | | ! | | | ! | | | ! | | | !</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">           |     | |     | | | | | |     |</span>
<span class="cm">           +-----+ +--+--+ +++ +++ +--+--+</span>
<span class="cm">              |       |     |   |     +----- Expansion channel</span>
<span class="cm">	      |       |     |   +----------- Expansion gain</span>
<span class="cm">              |       |     +--------------- Channel (low)</span>
<span class="cm">	      |       +--------------------- Correction offset high</span>
<span class="cm">	      +----------------------------- Correction gain low</span>
<span class="cm">        Word3:</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">          ! | | | ! | | | ! | | | ! | | | !</span>
<span class="cm">          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm">           |             | | | |   | | | |</span>
<span class="cm">           +------+------+ | | +-+-+ | | +-- Low bank enable</span>
<span class="cm">                  |        | |   |   | +---- High bank enable</span>
<span class="cm">                  |        | |   |   +------ Hi/low select</span>
<span class="cm">		  |    	   | |   +---------- Gain (1,?,2,4,8,16,32,64)</span>
<span class="cm">		  |    	   | +-------------- differential/single ended</span>
<span class="cm">		  |    	   +---------------- Unipolar</span>
<span class="cm">		  +------------------------- Correction gain high</span>

<span class="cm">   999. The card seems to have an incredible amount of capabilities, but</span>
<span class="cm">        trying to reverse engineer them from the Windows source is beyond my</span>
<span class="cm">	patience.</span>

<span class="cm"> */</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;comedi_pci.h&quot;</span>
<span class="cp">#include &quot;8255.h&quot;</span>

<span class="cp">#define DAQBOARD2000_SUBSYSTEM_IDS2 	0x00021616	</span><span class="cm">/* Daqboard/2000 - 2 Dacs */</span><span class="cp"></span>
<span class="cp">#define DAQBOARD2000_SUBSYSTEM_IDS4 	0x00041616	</span><span class="cm">/* Daqboard/2000 - 4 Dacs */</span><span class="cp"></span>

<span class="cp">#define DAQBOARD2000_DAQ_SIZE 		0x1002</span>
<span class="cp">#define DAQBOARD2000_PLX_SIZE 		0x100</span>

<span class="cm">/* Initialization bits for the Serial EEPROM Control Register */</span>
<span class="cp">#define DAQBOARD2000_SECRProgPinHi      0x8001767e</span>
<span class="cp">#define DAQBOARD2000_SECRProgPinLo      0x8000767e</span>
<span class="cp">#define DAQBOARD2000_SECRLocalBusHi     0xc000767e</span>
<span class="cp">#define DAQBOARD2000_SECRLocalBusLo     0x8000767e</span>
<span class="cp">#define DAQBOARD2000_SECRReloadHi       0xa000767e</span>
<span class="cp">#define DAQBOARD2000_SECRReloadLo       0x8000767e</span>

<span class="cm">/* SECR status bits */</span>
<span class="cp">#define DAQBOARD2000_EEPROM_PRESENT     0x10000000</span>

<span class="cm">/* CPLD status bits */</span>
<span class="cp">#define DAQBOARD2000_CPLD_INIT 		0x0002</span>
<span class="cp">#define DAQBOARD2000_CPLD_DONE 		0x0004</span>

<span class="cm">/* Available ranges */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_daqboard2000_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">13</span><span class="p">,</span> <span class="p">{</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span>
								       <span class="mf">2.5</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span>
								       <span class="mf">1.25</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.625</span><span class="p">,</span>
								       <span class="mf">0.625</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3125</span><span class="p">,</span>
								       <span class="mf">0.3125</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.156</span><span class="p">,</span>
								       <span class="mf">0.156</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
								       <span class="mf">0.625</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
								       <span class="mf">0.3125</span><span class="p">)</span>
								 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_daqboard2000_ao</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
								<span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">daqboard2000_hw</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqControl</span><span class="p">;</span>	<span class="cm">/*  0x00 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqScanListFIFO</span><span class="p">;</span>	<span class="cm">/*  0x02 */</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">acqPacerClockDivLow</span><span class="p">;</span>	<span class="cm">/*  0x04 */</span>

	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqScanCounter</span><span class="p">;</span>	<span class="cm">/*  0x08 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqPacerClockDivHigh</span><span class="p">;</span>	<span class="cm">/*  0x0a */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqTriggerCount</span><span class="p">;</span>	<span class="cm">/*  0x0c */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill2</span><span class="p">;</span>	<span class="cm">/*  0x0e */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqResultsFIFO</span><span class="p">;</span>	<span class="cm">/*  0x10 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill3</span><span class="p">;</span>	<span class="cm">/*  0x12 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqResultsShadow</span><span class="p">;</span>	<span class="cm">/*  0x14 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill4</span><span class="p">;</span>	<span class="cm">/*  0x16 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqAdcResult</span><span class="p">;</span>	<span class="cm">/*  0x18 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill5</span><span class="p">;</span>	<span class="cm">/*  0x1a */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">dacScanCounter</span><span class="p">;</span>	<span class="cm">/*  0x1c */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill6</span><span class="p">;</span>	<span class="cm">/*  0x1e */</span>

	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">dacControl</span><span class="p">;</span>	<span class="cm">/*  0x20 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill7</span><span class="p">;</span>	<span class="cm">/*  0x22 */</span>
	<span class="k">volatile</span> <span class="n">s16</span> <span class="n">dacFIFO</span><span class="p">;</span>	<span class="cm">/*  0x24 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill8</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  0x26 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">dacPacerClockDiv</span><span class="p">;</span>	<span class="cm">/*  0x2a */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">refDacs</span><span class="p">;</span>	<span class="cm">/*  0x2c */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill9</span><span class="p">;</span>	<span class="cm">/*  0x2e */</span>

	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">dioControl</span><span class="p">;</span>	<span class="cm">/*  0x30 */</span>
	<span class="k">volatile</span> <span class="n">s16</span> <span class="n">dioP3hsioData</span><span class="p">;</span>	<span class="cm">/*  0x32 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">dioP3Control</span><span class="p">;</span>	<span class="cm">/*  0x34 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">calEepromControl</span><span class="p">;</span>	<span class="cm">/*  0x36 */</span>
	<span class="k">volatile</span> <span class="n">s16</span> <span class="n">dacSetting</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/*  0x38 */</span>
	<span class="k">volatile</span> <span class="n">s16</span> <span class="n">dioP2ExpansionIO8Bit</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/*  0x40 */</span>

	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">ctrTmrControl</span><span class="p">;</span>	<span class="cm">/*  0x80 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill10</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/*  0x82 */</span>
	<span class="k">volatile</span> <span class="n">s16</span> <span class="n">ctrInput</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/*  0x88 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill11</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/*  0x90 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">timerDivisor</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  0xa0 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill12</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>	<span class="cm">/*  0xa4 */</span>

	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">dmaControl</span><span class="p">;</span>	<span class="cm">/*  0xb0 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">trigControl</span><span class="p">;</span>	<span class="cm">/*  0xb2 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill13</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*  0xb4 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">calEeprom</span><span class="p">;</span>	<span class="cm">/*  0xb8 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">acqDigitalMark</span><span class="p">;</span>	<span class="cm">/*  0xba */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">trigDacs</span><span class="p">;</span>	<span class="cm">/*  0xbc */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">fill14</span><span class="p">;</span>	<span class="cm">/*  0xbe */</span>
	<span class="k">volatile</span> <span class="n">s16</span> <span class="n">dioP2ExpansionIO16Bit</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/*  0xc0 */</span>
<span class="p">};</span>

<span class="cm">/* Scan Sequencer programming */</span>
<span class="cp">#define DAQBOARD2000_SeqStartScanList            0x0011</span>
<span class="cp">#define DAQBOARD2000_SeqStopScanList             0x0010</span>

<span class="cm">/* Prepare for acquisition */</span>
<span class="cp">#define DAQBOARD2000_AcqResetScanListFifo        0x0004</span>
<span class="cp">#define DAQBOARD2000_AcqResetResultsFifo         0x0002</span>
<span class="cp">#define DAQBOARD2000_AcqResetConfigPipe          0x0001</span>

<span class="cm">/* Acqusition status bits */</span>
<span class="cp">#define DAQBOARD2000_AcqResultsFIFOMore1Sample   0x0001</span>
<span class="cp">#define DAQBOARD2000_AcqResultsFIFOHasValidData  0x0002</span>
<span class="cp">#define DAQBOARD2000_AcqResultsFIFOOverrun       0x0004</span>
<span class="cp">#define DAQBOARD2000_AcqLogicScanning            0x0008</span>
<span class="cp">#define DAQBOARD2000_AcqConfigPipeFull           0x0010</span>
<span class="cp">#define DAQBOARD2000_AcqScanListFIFOEmpty        0x0020</span>
<span class="cp">#define DAQBOARD2000_AcqAdcNotReady              0x0040</span>
<span class="cp">#define DAQBOARD2000_ArbitrationFailure          0x0080</span>
<span class="cp">#define DAQBOARD2000_AcqPacerOverrun             0x0100</span>
<span class="cp">#define DAQBOARD2000_DacPacerOverrun             0x0200</span>
<span class="cp">#define DAQBOARD2000_AcqHardwareError            0x01c0</span>

<span class="cm">/* Scan Sequencer programming */</span>
<span class="cp">#define DAQBOARD2000_SeqStartScanList            0x0011</span>
<span class="cp">#define DAQBOARD2000_SeqStopScanList             0x0010</span>

<span class="cm">/* Pacer Clock Control */</span>
<span class="cp">#define DAQBOARD2000_AdcPacerInternal            0x0030</span>
<span class="cp">#define DAQBOARD2000_AdcPacerExternal            0x0032</span>
<span class="cp">#define DAQBOARD2000_AdcPacerEnable              0x0031</span>
<span class="cp">#define DAQBOARD2000_AdcPacerEnableDacPacer      0x0034</span>
<span class="cp">#define DAQBOARD2000_AdcPacerDisable             0x0030</span>
<span class="cp">#define DAQBOARD2000_AdcPacerNormalMode          0x0060</span>
<span class="cp">#define DAQBOARD2000_AdcPacerCompatibilityMode   0x0061</span>
<span class="cp">#define DAQBOARD2000_AdcPacerInternalOutEnable   0x0008</span>
<span class="cp">#define DAQBOARD2000_AdcPacerExternalRising      0x0100</span>

<span class="cm">/* DAC status */</span>
<span class="cp">#define DAQBOARD2000_DacFull                     0x0001</span>
<span class="cp">#define DAQBOARD2000_RefBusy                     0x0002</span>
<span class="cp">#define DAQBOARD2000_TrgBusy                     0x0004</span>
<span class="cp">#define DAQBOARD2000_CalBusy                     0x0008</span>
<span class="cp">#define DAQBOARD2000_Dac0Busy                    0x0010</span>
<span class="cp">#define DAQBOARD2000_Dac1Busy                    0x0020</span>
<span class="cp">#define DAQBOARD2000_Dac2Busy                    0x0040</span>
<span class="cp">#define DAQBOARD2000_Dac3Busy                    0x0080</span>

<span class="cm">/* DAC control */</span>
<span class="cp">#define DAQBOARD2000_Dac0Enable                  0x0021</span>
<span class="cp">#define DAQBOARD2000_Dac1Enable                  0x0031</span>
<span class="cp">#define DAQBOARD2000_Dac2Enable                  0x0041</span>
<span class="cp">#define DAQBOARD2000_Dac3Enable                  0x0051</span>
<span class="cp">#define DAQBOARD2000_DacEnableBit                0x0001</span>
<span class="cp">#define DAQBOARD2000_Dac0Disable                 0x0020</span>
<span class="cp">#define DAQBOARD2000_Dac1Disable                 0x0030</span>
<span class="cp">#define DAQBOARD2000_Dac2Disable                 0x0040</span>
<span class="cp">#define DAQBOARD2000_Dac3Disable                 0x0050</span>
<span class="cp">#define DAQBOARD2000_DacResetFifo                0x0004</span>
<span class="cp">#define DAQBOARD2000_DacPatternDisable           0x0060</span>
<span class="cp">#define DAQBOARD2000_DacPatternEnable            0x0061</span>
<span class="cp">#define DAQBOARD2000_DacSelectSignedData         0x0002</span>
<span class="cp">#define DAQBOARD2000_DacSelectUnsignedData       0x0000</span>

<span class="cm">/* Trigger Control */</span>
<span class="cp">#define DAQBOARD2000_TrigAnalog                  0x0000</span>
<span class="cp">#define DAQBOARD2000_TrigTTL                     0x0010</span>
<span class="cp">#define DAQBOARD2000_TrigTransHiLo               0x0004</span>
<span class="cp">#define DAQBOARD2000_TrigTransLoHi               0x0000</span>
<span class="cp">#define DAQBOARD2000_TrigAbove                   0x0000</span>
<span class="cp">#define DAQBOARD2000_TrigBelow                   0x0004</span>
<span class="cp">#define DAQBOARD2000_TrigLevelSense              0x0002</span>
<span class="cp">#define DAQBOARD2000_TrigEdgeSense               0x0000</span>
<span class="cp">#define DAQBOARD2000_TrigEnable                  0x0001</span>
<span class="cp">#define DAQBOARD2000_TrigDisable                 0x0000</span>

<span class="cm">/* Reference Dac Selection */</span>
<span class="cp">#define DAQBOARD2000_PosRefDacSelect             0x0100</span>
<span class="cp">#define DAQBOARD2000_NegRefDacSelect             0x0000</span>

<span class="k">struct</span> <span class="n">daq200_boardtype</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">daq200_boardtype</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;ids2&quot;</span><span class="p">,</span> <span class="n">DAQBOARD2000_SUBSYSTEM_IDS2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ids4&quot;</span><span class="p">,</span> <span class="n">DAQBOARD2000_SUBSYSTEM_IDS4</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define this_board ((const struct daq200_boardtype *)dev-&gt;board_ptr)</span>

<span class="k">struct</span> <span class="n">daqboard2000_private</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">card_daqboard_2000</span>
	<span class="p">}</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">daq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">plx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">got_regions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_readback</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct daqboard2000_private *)dev-&gt;private)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">writeAcqScanListEntry</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daqboard2000_hw</span> <span class="o">*</span><span class="n">fpga</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">;</span>

<span class="cm">/* udelay(4); */</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqScanListFIFO</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
<span class="cm">/* udelay(4); */</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqScanListFIFO</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_sampling</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">word0</span><span class="p">,</span> <span class="n">word1</span><span class="p">,</span> <span class="n">word2</span><span class="p">,</span> <span class="n">word3</span><span class="p">;</span>

	<span class="cm">/* Channel 0-7 diff, channel 8-23 single ended */</span>
	<span class="n">word0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word1</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">;</span>		<span class="cm">/* Last scan */</span>
	<span class="n">word2</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00c0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">word3</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">word3</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">word3</span> <span class="o">=</span> <span class="mh">0x0005</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">word3</span> <span class="o">=</span> <span class="mh">0x0006</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">word3</span> <span class="o">=</span> <span class="mh">0x0041</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">word3</span> <span class="o">=</span> <span class="mh">0x0042</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">word3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">  dev-&gt;eeprom.correctionDACSE[i][j][k].offset = 0x800;</span>
<span class="cm">  dev-&gt;eeprom.correctionDACSE[i][j][k].gain = 0xc00;</span>
<span class="cm">*/</span>
	<span class="cm">/* These should be read from EEPROM */</span>
	<span class="n">word2</span> <span class="o">|=</span> <span class="mh">0x0800</span><span class="p">;</span>
	<span class="n">word3</span> <span class="o">|=</span> <span class="mh">0xc000</span><span class="p">;</span>
<span class="cm">/*  printk(&quot;%d %4.4x %4.4x %4.4x %4.4x\n&quot;, chan, word0, word1, word2, word3);*/</span>
	<span class="n">writeAcqScanListEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">word0</span><span class="p">);</span>
	<span class="n">writeAcqScanListEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">word1</span><span class="p">);</span>
	<span class="n">writeAcqScanListEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">word2</span><span class="p">);</span>
	<span class="n">writeAcqScanListEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">word3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">daqboard2000_hw</span> <span class="o">*</span><span class="n">fpga</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gain</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span>
	    <span class="n">DAQBOARD2000_AcqResetScanListFifo</span> <span class="o">|</span>
	    <span class="n">DAQBOARD2000_AcqResetResultsFifo</span> <span class="o">|</span> <span class="n">DAQBOARD2000_AcqResetConfigPipe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If pacer clock is not set to some high value (&gt; 10 us), we</span>
<span class="cm">	 * risk multiple samples to be put into the result FIFO.</span>
<span class="cm">	 */</span>
	<span class="cm">/* 1 second, should be long enough */</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqPacerClockDivLow</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqPacerClockDivHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* This doesn&#39;t look efficient.  I decided to take the conservative</span>
<span class="cm">	 * approach when I did the insn conversion.  Perhaps it would be</span>
<span class="cm">	 * better to have broken it completely, then someone would have been</span>
<span class="cm">	 * forced to fix it.  --ds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setup_sampling</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
		<span class="cm">/* Enable reading from the scanlist FIFO */</span>
		<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_SeqStartScanList</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">&amp;</span> <span class="n">DAQBOARD2000_AcqConfigPipeFull</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* udelay(2); */</span>
		<span class="p">}</span>
		<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_AdcPacerEnable</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">&amp;</span> <span class="n">DAQBOARD2000_AcqLogicScanning</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* udelay(2); */</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">&amp;</span>
			    <span class="n">DAQBOARD2000_AcqResultsFIFOHasValidData</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* udelay(2); */</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqResultsFIFO</span><span class="p">;</span>
		<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_AdcPacerDisable</span><span class="p">;</span>
		<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_SeqStopScanList</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_ao_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">daqboard2000_hw</span> <span class="o">*</span><span class="n">fpga</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * OK, since it works OK without enabling the DAC&#39;s, let&#39;s keep</span>
<span class="cm">		 * it as simple as possible...</span>
<span class="cm">		 */</span>
		<span class="cm">/* fpga-&gt;dacControl = (chan + 2) * 0x0010 | 0x0001; udelay(1000); */</span>
		<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">dacSetting</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fpga</span><span class="o">-&gt;</span><span class="n">dacControl</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">chan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x0010</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* udelay(2); */</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_readback</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since we never enabled the DAC&#39;s, we don&#39;t need to disable it...</span>
<span class="cm">		 * fpga-&gt;dacControl = (chan + 2) * 0x0010 | 0x0000; udelay(1000);</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_resetLocalBus</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;daqboard2000_resetLocalBus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRLocalBusHi</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRLocalBusLo</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_reloadPLX</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;daqboard2000_reloadPLX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRReloadLo</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRReloadHi</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRReloadLo</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_pulseProgPin</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;daqboard2000_pulseProgPin 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRProgPinHi</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DAQBOARD2000_SECRProgPinLo</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>		<span class="cm">/* Not in the original code, but I like symmetry... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_pollCPLD</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpld</span><span class="p">;</span>

	<span class="cm">/* timeout after 50 tries -&gt; 5ms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpld</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cpld</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_writeCPLD</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DAQBOARD2000_CPLD_INIT</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">DAQBOARD2000_CPLD_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">initialize_daqboard2000</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cpld_array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="cm">/* Read the serial EEPROM control register */</span>
	<span class="kt">int</span> <span class="n">secr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Check to make sure the serial eeprom is present on the board */</span>
	<span class="n">secr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secr</span> <span class="o">&amp;</span> <span class="n">DAQBOARD2000_EEPROM_PRESENT</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_EEPROM</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;no serial eeprom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_EEPROM</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;Programming EEPROM try %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">daqboard2000_resetLocalBus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">daqboard2000_reloadPLX</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">daqboard2000_pulseProgPin</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">daqboard2000_pollCPLD</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DAQBOARD2000_CPLD_INIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpld_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span>
				    <span class="o">&amp;&amp;</span> <span class="n">cpld_array</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_EEPROM</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;Preamble found at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">data</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">cpld_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">cpld_array</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daqboard2000_writeCPLD</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_EEPROM</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;Programmed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">daqboard2000_resetLocalBus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">daqboard2000_reloadPLX</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_adcStopDmaTransfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*  printk(&quot;Implement: daqboard2000_adcStopDmaTransfer\n&quot;);*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_adcDisarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daqboard2000_hw</span> <span class="o">*</span><span class="n">fpga</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">;</span>

	<span class="cm">/* Disable hardware triggers */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">trigControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_TrigAnalog</span> <span class="o">|</span> <span class="n">DAQBOARD2000_TrigDisable</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">trigControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_TrigTTL</span> <span class="o">|</span> <span class="n">DAQBOARD2000_TrigDisable</span><span class="p">;</span>

	<span class="cm">/* Stop the scan list FIFO from loading the configuration pipe */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_SeqStopScanList</span><span class="p">;</span>

	<span class="cm">/* Stop the pacer clock */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">acqControl</span> <span class="o">=</span> <span class="n">DAQBOARD2000_AdcPacerDisable</span><span class="p">;</span>

	<span class="cm">/* Stop the input dma (abort channel 1) */</span>
	<span class="n">daqboard2000_adcStopDmaTransfer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_activateReferenceDacs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daqboard2000_hw</span> <span class="o">*</span><span class="n">fpga</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/*  Set the + reference dac value in the FPGA */</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">refDacs</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">DAQBOARD2000_PosRefDacSelect</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fpga</span><span class="o">-&gt;</span><span class="n">dacControl</span> <span class="o">&amp;</span> <span class="n">DAQBOARD2000_RefBusy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cm">/*  printk(&quot;DAQBOARD2000_PosRefDacSelect %d\n&quot;, timeout);*/</span>

	<span class="cm">/*  Set the - reference dac value in the FPGA */</span>
	<span class="n">fpga</span><span class="o">-&gt;</span><span class="n">refDacs</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">DAQBOARD2000_NegRefDacSelect</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fpga</span><span class="o">-&gt;</span><span class="n">dacControl</span> <span class="o">&amp;</span> <span class="n">DAQBOARD2000_RefBusy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cm">/*  printk(&quot;DAQBOARD2000_NegRefDacSelect %d\n&quot;, timeout);*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_initializeCtrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*  printk(&quot;Implement: daqboard2000_initializeCtrs\n&quot;);*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_initializeTmrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*  printk(&quot;Implement: daqboard2000_initializeTmrs\n&quot;);*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_dacDisarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*  printk(&quot;Implement: daqboard2000_dacDisarm\n&quot;);*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_initializeAdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">daqboard2000_adcDisarm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">daqboard2000_activateReferenceDacs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">daqboard2000_initializeCtrs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">daqboard2000_initializeTmrs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_initializeDac</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">daqboard2000_dacDisarm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">The test command, REMOVE!!:</span>

<span class="cm">rmmod daqboard2000 ; rmmod comedi; make install ; modprobe daqboard2000; /usr/sbin/comedi_config /dev/comedi0 daqboard/2000 ; tail -40 /var/log/messages</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_8255_cb</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">+</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">+</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">  printk(&quot;daqboard2000_8255_cb %x %d %d %2.2x -&gt; %2.2x\n&quot;,</span>
<span class="cm">        arg, dir, port, data, result);</span>
<span class="cm">*/</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daqboard2000_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">aux_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aux_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">daqboard2000_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x1616</span><span class="p">,</span> <span class="mh">0x0409</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	     <span class="n">card</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x1616</span><span class="p">,</span> <span class="mh">0x0409</span><span class="p">,</span> <span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">||</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* requested particular bus/slot */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">bus</span> <span class="o">||</span>
			    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* found one */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">||</span> <span class="n">slot</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;no daqboard2000 found at bus/slot: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;no daqboard2000 found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span>
		      <span class="n">subsystem_device</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">boardtypes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boardtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">boardtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">boardtypes</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot; unknown subsystem id %08x (pretend it is an ids2)&quot;</span><span class="p">,</span>
			     <span class="n">id</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_ptr</span> <span class="o">=</span> <span class="n">boardtypes</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;daqboard2000&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;failed to enable PCI device and request regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">got_regions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">=</span>
	    <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">DAQBOARD2000_PLX_SIZE</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span> <span class="o">=</span>
	    <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">DAQBOARD2000_DAQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">||</span> <span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">readl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	   u8 interrupt;</span>
<span class="cm">	   Windows code does restore interrupts, but since we don&#39;t use them...</span>
<span class="cm">	   pci_read_config_byte(card, PCI_INTERRUPT_LINE, &amp;interrupt);</span>
<span class="cm">	   printk(&quot;Interrupt before is: %x\n&quot;, interrupt);</span>
<span class="cm">	 */</span>

	<span class="n">aux_data</span> <span class="o">=</span> <span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aux_len</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LENGTH</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aux_data</span> <span class="o">&amp;&amp;</span> <span class="n">aux_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">initialize_daqboard2000</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">aux_data</span><span class="p">,</span> <span class="n">aux_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_dev</span><span class="p">,</span> <span class="s">&quot;no FPGA initialization code, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">daqboard2000_initializeAdc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">daqboard2000_initializeDac</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Windows code does restore interrupts, but since we don&#39;t use them...</span>
<span class="cm">	   pci_read_config_byte(card, PCI_INTERRUPT_LINE, &amp;interrupt);</span>
<span class="cm">	   printk(&quot;Interrupt after is: %x\n&quot;, interrupt);</span>
<span class="cm">	 */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* ai subdevice */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">daqboard2000_ai_insn_read</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_daqboard2000_ai</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* ao subdevice */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">daqboard2000_ao_insn_read</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">daqboard2000_ao_insn_write</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_daqboard2000_ao</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">daqboard2000_8255_cb</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">));</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">daqboard2000_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span>
		<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">daq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">plx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">got_regions</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">daqboard2000_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;daqboard2000&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">daqboard2000_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">daqboard2000_detach</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">daqboard2000_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">daqboard2000_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">daqboard2000_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">daqboard2000_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x1616</span><span class="p">,</span> <span class="mh">0x0409</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">daqboard2000_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">daqboard2000_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;daqboard2000&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">daqboard2000_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">daqboard2000_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">daqboard2000_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">daqboard2000_driver</span><span class="p">,</span> <span class="n">daqboard2000_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
