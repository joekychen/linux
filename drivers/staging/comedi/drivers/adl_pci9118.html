<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › adl_pci9118.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>adl_pci9118.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  comedi/drivers/adl_pci9118.c</span>
<span class="cm"> *</span>
<span class="cm"> *  hardware driver for ADLink cards:</span>
<span class="cm"> *   card:   PCI-9118DG, PCI-9118HG, PCI-9118HR</span>
<span class="cm"> *   driver: pci9118dg,  pci9118hg,  pci9118hr</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Michal Dobes &lt;dobes@tesnet.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: adl_pci9118</span>
<span class="cm">Description: Adlink PCI-9118DG, PCI-9118HG, PCI-9118HR</span>
<span class="cm">Author: Michal Dobes &lt;dobes@tesnet.cz&gt;</span>
<span class="cm">Devices: [ADLink] PCI-9118DG (pci9118dg), PCI-9118HG (pci9118hg),</span>
<span class="cm">  PCI-9118HR (pci9118hr)</span>
<span class="cm">Status: works</span>

<span class="cm">This driver supports AI, AO, DI and DO subdevices.</span>
<span class="cm">AI subdevice supports cmd and insn interface,</span>
<span class="cm">other subdevices support only insn interface.</span>
<span class="cm">For AI:</span>
<span class="cm">- If cmd-&gt;scan_begin_src=TRIG_EXT then trigger input is TGIN (pin 46).</span>
<span class="cm">- If cmd-&gt;convert_src=TRIG_EXT then trigger input is EXTTRG (pin 44).</span>
<span class="cm">- If cmd-&gt;start_src/stop_src=TRIG_EXT then trigger input is TGIN (pin 46).</span>
<span class="cm">- It is not necessary to have cmd.scan_end_arg=cmd.chanlist_len but</span>
<span class="cm">  cmd.scan_end_arg modulo cmd.chanlist_len must by 0.</span>
<span class="cm">- If return value of cmdtest is 5 then you&#39;ve bad channel list</span>
<span class="cm">  (it isn&#39;t possible mixture S.E. and DIFF inputs or bipolar and unipolar</span>
<span class="cm">  ranges).</span>

<span class="cm">There are some hardware limitations:</span>
<span class="cm">a) You cann&#39;t use mixture of unipolar/bipoar ranges or differencial/single</span>
<span class="cm">   ended inputs.</span>
<span class="cm">b) DMA transfers must have the length aligned to two samples (32 bit),</span>
<span class="cm">   so there is some problems if cmd-&gt;chanlist_len is odd. This driver tries</span>
<span class="cm">   bypass this with adding one sample to the end of the every scan and discard</span>
<span class="cm">   it on output but this cann&#39;t be used if cmd-&gt;scan_begin_src=TRIG_FOLLOW</span>
<span class="cm">   and is used flag TRIG_WAKE_EOS, then driver switch to interrupt driven mode</span>
<span class="cm">   with interrupt after every sample.</span>
<span class="cm">c) If isn&#39;t used DMA then you can use only mode where</span>
<span class="cm">   cmd-&gt;scan_begin_src=TRIG_FOLLOW.</span>

<span class="cm">Configuration options:</span>
<span class="cm">  [0] - PCI bus of device (optional)</span>
<span class="cm">  [1] - PCI slot of device (optional)</span>
<span class="cm">	If bus/slot is not specified, then first available PCI</span>
<span class="cm">	card will be used.</span>
<span class="cm">  [2] - 0= standard 8 DIFF/16 SE channels configuration</span>
<span class="cm">	n = external multiplexer connected, 1 &lt;= n &lt;= 256</span>
<span class="cm">  [3] - 0=autoselect DMA or EOC interrupts operation</span>
<span class="cm">	1 = disable DMA mode</span>
<span class="cm">	3 = disable DMA and INT, only insn interface will work</span>
<span class="cm">  [4] - sample&amp;hold signal - card can generate signal for external S&amp;H board</span>
<span class="cm">	0 = use SSHO(pin 45) signal is generated in onboard hardware S&amp;H logic</span>
<span class="cm">	0 != use ADCHN7(pin 23) signal is generated from driver, number say how</span>
<span class="cm">		long delay is requested in ns and sign polarity of the hold</span>
<span class="cm">		(in this case external multiplexor can serve only 128 channels)</span>
<span class="cm">  [5] - 0=stop measure on all hardware errors</span>
<span class="cm">	2 | = ignore ADOR - A/D Overrun status</span>
<span class="cm">	8|=ignore Bover - A/D Burst Mode Overrun status</span>
<span class="cm">	256|=ignore nFull - A/D FIFO Full status</span>

<span class="cm">*/</span>
<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &quot;amcc_s5933.h&quot;</span>
<span class="cp">#include &quot;8253.h&quot;</span>
<span class="cp">#include &quot;comedi_pci.h&quot;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>

<span class="cp">#define PCI_VENDOR_ID_AMCC	0x10e8</span>

<span class="cm">/* paranoid checks are broken */</span>
<span class="cp">#undef PCI9118_PARANOIDCHECK	</span><span class="cm">/*</span>
<span class="cm">				 * if defined, then is used code which control</span>
<span class="cm">				 * correct channel number on every 12 bit sample</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="cp">#undef PCI9118_EXTDEBUG		</span><span class="cm">/*</span>
<span class="cm">				 * if defined then driver prints</span>
<span class="cm">				 * a lot of messages</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="cp">#undef DPRINTK</span>
<span class="cp">#ifdef PCI9118_EXTDEBUG</span>
<span class="cp">#define DPRINTK(fmt, args...) printk(fmt, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define IORANGE_9118 	64	</span><span class="cm">/* I hope */</span><span class="cp"></span>
<span class="cp">#define PCI9118_CHANLEN	255	</span><span class="cm">/*</span>
<span class="cm">				 * len of chanlist, some source say 256,</span>
<span class="cm">				 * but reality looks like 255 :-(</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="cp">#define PCI9118_CNT0	0x00	</span><span class="cm">/* R/W: 8254 counter 0 */</span><span class="cp"></span>
<span class="cp">#define PCI9118_CNT1	0x04	</span><span class="cm">/* R/W: 8254 counter 0 */</span><span class="cp"></span>
<span class="cp">#define PCI9118_CNT2	0x08	</span><span class="cm">/* R/W: 8254 counter 0 */</span><span class="cp"></span>
<span class="cp">#define PCI9118_CNTCTRL	0x0c	</span><span class="cm">/* W:   8254 counter control */</span><span class="cp"></span>
<span class="cp">#define PCI9118_AD_DATA	0x10	</span><span class="cm">/* R:   A/D data */</span><span class="cp"></span>
<span class="cp">#define PCI9118_DA1	0x10	</span><span class="cm">/* W:   D/A registers */</span><span class="cp"></span>
<span class="cp">#define PCI9118_DA2	0x14</span>
<span class="cp">#define PCI9118_ADSTAT	0x18	</span><span class="cm">/* R:   A/D status register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_ADCNTRL	0x18	</span><span class="cm">/* W:   A/D control register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_DI	0x1c	</span><span class="cm">/* R:   digi input register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_DO	0x1c	</span><span class="cm">/* W:   digi output register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_SOFTTRG	0x20	</span><span class="cm">/* W:   soft trigger for A/D */</span><span class="cp"></span>
<span class="cp">#define PCI9118_GAIN	0x24	</span><span class="cm">/* W:   A/D gain/channel register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_BURST	0x28	</span><span class="cm">/* W:   A/D burst number register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_SCANMOD	0x2c	</span><span class="cm">/* W:   A/D auto scan mode */</span><span class="cp"></span>
<span class="cp">#define PCI9118_ADFUNC	0x30	</span><span class="cm">/* W:   A/D function register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_DELFIFO	0x34	</span><span class="cm">/* W:   A/D data FIFO reset */</span><span class="cp"></span>
<span class="cp">#define PCI9118_INTSRC	0x38	</span><span class="cm">/* R:   interrupt reason register */</span><span class="cp"></span>
<span class="cp">#define PCI9118_INTCTRL	0x38	</span><span class="cm">/* W:   interrupt control register */</span><span class="cp"></span>

<span class="cm">/* bits from A/D control register (PCI9118_ADCNTRL) */</span>
<span class="cp">#define AdControl_UniP	0x80	</span><span class="cm">/* 1=bipolar, 0=unipolar */</span><span class="cp"></span>
<span class="cp">#define AdControl_Diff	0x40	</span><span class="cm">/* 1=differential, 0= single end inputs */</span><span class="cp"></span>
<span class="cp">#define AdControl_SoftG	0x20	</span><span class="cm">/* 1=8254 counter works, 0=counter stops */</span><span class="cp"></span>
<span class="cp">#define	AdControl_ExtG	0x10	</span><span class="cm">/*</span>
<span class="cm">				 * 1=8254 countrol controlled by TGIN(pin 46),</span>
<span class="cm">				 * 0=controlled by SoftG</span>
<span class="cm">				 */</span><span class="cp"></span>
<span class="cp">#define AdControl_ExtM	0x08	</span><span class="cm">/*</span>
<span class="cm">				 * 1=external hardware trigger (pin 44),</span>
<span class="cm">				 * 0=internal trigger</span>
<span class="cm">				 */</span><span class="cp"></span>
<span class="cp">#define AdControl_TmrTr	0x04	</span><span class="cm">/*</span>
<span class="cm">				 * 1=8254 is iternal trigger source,</span>
<span class="cm">				 * 0=software trigger is source</span>
<span class="cm">				 * (register PCI9118_SOFTTRG)</span>
<span class="cm">				 */</span><span class="cp"></span>
<span class="cp">#define AdControl_Int	0x02	</span><span class="cm">/* 1=enable INT, 0=disable */</span><span class="cp"></span>
<span class="cp">#define AdControl_Dma	0x01	</span><span class="cm">/* 1=enable DMA, 0=disable */</span><span class="cp"></span>

<span class="cm">/* bits from A/D function register (PCI9118_ADFUNC) */</span>
<span class="cp">#define AdFunction_PDTrg	0x80	</span><span class="cm">/*</span>
<span class="cm">					 * 1=positive,</span>
<span class="cm">					 * 0=negative digital trigger</span>
<span class="cm">					 * (only positive is correct)</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define AdFunction_PETrg	0x40	</span><span class="cm">/*</span>
<span class="cm">					 * 1=positive,</span>
<span class="cm">					 * 0=negative external trigger</span>
<span class="cm">					 * (only positive is correct)</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define AdFunction_BSSH		0x20	</span><span class="cm">/* 1=with sample&amp;hold, 0=without */</span><span class="cp"></span>
<span class="cp">#define AdFunction_BM		0x10	</span><span class="cm">/* 1=burst mode, 0=normal mode */</span><span class="cp"></span>
<span class="cp">#define AdFunction_BS		0x08	</span><span class="cm">/*</span>
<span class="cm">					 * 1=burst mode start,</span>
<span class="cm">					 * 0=burst mode stop</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define AdFunction_PM		0x04	</span><span class="cm">/*</span>
<span class="cm">					 * 1=post trigger mode,</span>
<span class="cm">					 * 0=not post trigger</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define AdFunction_AM		0x02	</span><span class="cm">/*</span>
<span class="cm">					 * 1=about trigger mode,</span>
<span class="cm">					 * 0=not about trigger</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define AdFunction_Start	0x01	</span><span class="cm">/* 1=trigger start, 0=trigger stop */</span><span class="cp"></span>

<span class="cm">/* bits from A/D status register (PCI9118_ADSTAT) */</span>
<span class="cp">#define AdStatus_nFull	0x100	</span><span class="cm">/* 0=FIFO full (fatal), 1=not full */</span><span class="cp"></span>
<span class="cp">#define AdStatus_nHfull	0x080	</span><span class="cm">/* 0=FIFO half full, 1=FIFO not half full */</span><span class="cp"></span>
<span class="cp">#define AdStatus_nEpty	0x040	</span><span class="cm">/* 0=FIFO empty, 1=FIFO not empty */</span><span class="cp"></span>
<span class="cp">#define AdStatus_Acmp	0x020	</span><span class="cm">/*  */</span><span class="cp"></span>
<span class="cp">#define AdStatus_DTH	0x010	</span><span class="cm">/* 1=external digital trigger */</span><span class="cp"></span>
<span class="cp">#define AdStatus_Bover	0x008	</span><span class="cm">/* 1=burst mode overrun (fatal) */</span><span class="cp"></span>
<span class="cp">#define AdStatus_ADOS	0x004	</span><span class="cm">/* 1=A/D over speed (warning) */</span><span class="cp"></span>
<span class="cp">#define AdStatus_ADOR	0x002	</span><span class="cm">/* 1=A/D overrun (fatal) */</span><span class="cp"></span>
<span class="cp">#define AdStatus_ADrdy	0x001	</span><span class="cm">/* 1=A/D already ready, 0=not ready */</span><span class="cp"></span>

<span class="cm">/* bits for interrupt reason and control (PCI9118_INTSRC, PCI9118_INTCTRL) */</span>
<span class="cm">/* 1=interrupt occur, enable source,  0=interrupt not occur, disable source */</span>
<span class="cp">#define Int_Timer	0x08	</span><span class="cm">/* timer interrupt */</span><span class="cp"></span>
<span class="cp">#define Int_About	0x04	</span><span class="cm">/* about trigger complete */</span><span class="cp"></span>
<span class="cp">#define Int_Hfull	0x02	</span><span class="cm">/* A/D FIFO hlaf full */</span><span class="cp"></span>
<span class="cp">#define Int_DTrg	0x01	</span><span class="cm">/* external digital trigger */</span><span class="cp"></span>

<span class="cp">#define START_AI_EXT	0x01	</span><span class="cm">/* start measure on external trigger */</span><span class="cp"></span>
<span class="cp">#define STOP_AI_EXT	0x02	</span><span class="cm">/* stop measure on external trigger */</span><span class="cp"></span>
<span class="cp">#define START_AI_INT	0x04	</span><span class="cm">/* start measure on internal trigger */</span><span class="cp"></span>
<span class="cp">#define STOP_AI_INT	0x08	</span><span class="cm">/* stop measure on internal trigger */</span><span class="cp"></span>

<span class="cp">#define EXTTRG_AI	0	</span><span class="cm">/* ext trg is used by AI */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci9118dg_hr</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
							     <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.625</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">2.5</span><span class="p">),</span>
							     <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">1.25</span><span class="p">)</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_pci9118hg</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
							  <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">0.005</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
							  <span class="n">UNI_RANGE</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
							  <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define PCI9118_BIPOLAR_RANGES	4	</span><span class="cm">/*</span>
<span class="cm">					 * used for test on mixture</span>
<span class="cm">					 * of BIP/UNI ranges</span>
<span class="cm">					 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">boardtype</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* board name */</span>
	<span class="kt">int</span> <span class="n">vendor_id</span><span class="p">;</span>			<span class="cm">/* PCI vendor a device ID of card */</span>
	<span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iorange_amcc</span><span class="p">;</span>		<span class="cm">/* iorange for own S5933 region */</span>
	<span class="kt">int</span> <span class="n">iorange_9118</span><span class="p">;</span>		<span class="cm">/* pass thru card region size */</span>
	<span class="kt">int</span> <span class="n">n_aichan</span><span class="p">;</span>			<span class="cm">/* num of A/D chans */</span>
	<span class="kt">int</span> <span class="n">n_aichand</span><span class="p">;</span>			<span class="cm">/* num of A/D chans in diff mode */</span>
	<span class="kt">int</span> <span class="n">mux_aichan</span><span class="p">;</span>			<span class="cm">/*</span>
<span class="cm">					 * num of A/D chans with</span>
<span class="cm">					 * external multiplexor</span>
<span class="cm">					 */</span>
	<span class="kt">int</span> <span class="n">n_aichanlist</span><span class="p">;</span>		<span class="cm">/* len of chanlist */</span>
	<span class="kt">int</span> <span class="n">n_aochan</span><span class="p">;</span>			<span class="cm">/* num of D/A chans */</span>
	<span class="kt">int</span> <span class="n">ai_maxdata</span><span class="p">;</span>			<span class="cm">/* resolution of A/D */</span>
	<span class="kt">int</span> <span class="n">ao_maxdata</span><span class="p">;</span>			<span class="cm">/* resolution of D/A */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ai</span><span class="p">;</span>	<span class="cm">/* rangelist for A/D */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="n">rangelist_ao</span><span class="p">;</span>	<span class="cm">/* rangelist for D/A */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_ns_min</span><span class="p">;</span>		<span class="cm">/* max sample speed of card v ns */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_pacer_min</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * minimal pacer value</span>
<span class="cm">					 * (c1*c2 or c1 in burst)</span>
<span class="cm">					 */</span>
	<span class="kt">int</span> <span class="n">half_fifo_size</span><span class="p">;</span>		<span class="cm">/* size of FIFO/2 */</span>

<span class="p">};</span>

<span class="k">struct</span> <span class="n">pci9118_private</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase_a</span><span class="p">;</span>	<span class="cm">/* base+size for AMCC chip */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">master</span><span class="p">;</span>	<span class="cm">/* master capable */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>	<span class="cm">/* ptr to actual pcidev */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usemux</span><span class="p">;</span>	<span class="cm">/* we want to use external multiplexor! */</span>
<span class="cp">#ifdef PCI9118_PARANOIDCHECK</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">chanlist</span><span class="p">[</span><span class="n">PCI9118_CHANLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/*</span>
<span class="cm">							 * list of</span>
<span class="cm">							 * scanned channel</span>
<span class="cm">							 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chanlistlen</span><span class="p">;</span>	<span class="cm">/* number of scanlist */</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdControlReg</span><span class="p">;</span>	<span class="cm">/* A/D control register */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">IntControlReg</span><span class="p">;</span>	<span class="cm">/* Interrupt control register */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdFunctionReg</span><span class="p">;</span>	<span class="cm">/* A/D function register */</span>
	<span class="kt">char</span> <span class="n">valid</span><span class="p">;</span>			<span class="cm">/* driver is ok */</span>
	<span class="kt">char</span> <span class="n">ai_neverending</span><span class="p">;</span>		<span class="cm">/* we do unlimited AI */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i8254_osc_base</span><span class="p">;</span>	<span class="cm">/* frequence of onboard oscilator */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_do</span><span class="p">;</span>		<span class="cm">/* what do AI? 0=nothing, 1 to 4 mode */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_act_scan</span><span class="p">;</span>	<span class="cm">/* how many scans we finished */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_buf_ptr</span><span class="p">;</span>	<span class="cm">/* data buffer ptr in samples */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_n_chan</span><span class="p">;</span>		<span class="cm">/* how many channels is measured */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_n_scanlen</span><span class="p">;</span>	<span class="cm">/* len of actual scanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_n_realscanlen</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * what we must transfer for one</span>
<span class="cm">					 * outgoing scan include front/back adds</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_act_dmapos</span><span class="p">;</span>	<span class="cm">/* position in actual real stream */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_add_front</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * how many channels we must add</span>
<span class="cm">					 * before scan to satisfy S&amp;H?</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_add_back</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * how many channels we must add</span>
<span class="cm">					 * before scan to satisfy DMA?</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ai_chanlist</span><span class="p">;</span>	<span class="cm">/* actual chanlist */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_timer1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_timer2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ai12_startstop</span><span class="p">;</span>		<span class="cm">/*</span>
<span class="cm">					 * measure can start/stop</span>
<span class="cm">					 * on external trigger</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_divisor1</span><span class="p">,</span> <span class="n">ai_divisor2</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">						 * divisors for start of measure</span>
<span class="cm">						 * on external start</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_data_len</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">ai_data</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ao_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="cm">/* data output buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_scans</span><span class="p">;</span>			<span class="cm">/* number of scans to do */</span>
	<span class="kt">char</span> <span class="n">dma_doublebuf</span><span class="p">;</span>			<span class="cm">/* we can use double buffring */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_actbuf</span><span class="p">;</span>		<span class="cm">/* which buffer is used now */</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="cm">/*</span>
<span class="cm">						 * pointers to begin of</span>
<span class="cm">						 * DMA buffer</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* hw address of DMA buff */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmabuf_size</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/*</span>
<span class="cm">						 * size of dma buffer in bytes</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmabuf_use_size</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*</span>
<span class="cm">						 * which size we may now use</span>
<span class="cm">						 * for transfer</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmabuf_used_size</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* which size was truly used */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmabuf_panic_size</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmabuf_samples</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* size in samples */</span>
	<span class="kt">int</span> <span class="n">dmabuf_pages</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="cm">/* number of pages in buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cnt0_users</span><span class="p">;</span>		<span class="cm">/*</span>
<span class="cm">						 * bit field of 8254 CNT0 users</span>
<span class="cm">						 * (0-unused, 1-AO, 2-DI, 3-DO)</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">exttrg_users</span><span class="p">;</span>		<span class="cm">/*</span>
<span class="cm">						 * bit field of external trigger</span>
<span class="cm">						 * users(0-AI, 1-AO, 2-DI, 3-DO)</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt0_divisor</span><span class="p">;</span>		<span class="cm">/* actual CNT0 divisor */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">int_ai_func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>	<span class="cm">/*</span>
<span class="cm">					 * ptr to actual interrupt</span>
<span class="cm">					 * AI function</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ai16bits</span><span class="p">;</span>		<span class="cm">/* =1 16 bit card */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">usedma</span><span class="p">;</span>		<span class="cm">/* =1 use DMA transfer and not INT */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">useeoshandle</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * =1 change WAKE_EOS DMA transfer</span>
<span class="cm">					 * to fit on every second</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">usessh</span><span class="p">;</span>		<span class="cm">/* =1 turn on S&amp;H support */</span>
	<span class="kt">int</span> <span class="n">softsshdelay</span><span class="p">;</span>		<span class="cm">/*</span>
<span class="cm">					 * &gt;0 use software S&amp;H,</span>
<span class="cm">					 * numer is requested delay in ns</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">softsshsample</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * polarity of S&amp;H signal</span>
<span class="cm">					 * in sample state</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">softsshhold</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * polarity of S&amp;H signal</span>
<span class="cm">					 * in hold state</span>
<span class="cm">					 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_maskerr</span><span class="p">;</span>	<span class="cm">/* which warning was printed */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_maskharderr</span><span class="p">;</span>	<span class="cm">/* on which error bits stops */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_inttrig_start</span><span class="p">;</span>	<span class="cm">/* TRIG_INT for start */</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct pci9118_private *)dev-&gt;private)</span>
<span class="cp">#define this_board ((struct boardtype *)dev-&gt;board_ptr)</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">check_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frontadd</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">backadd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frontadd</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">backadd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">usedma</span><span class="p">,</span> <span class="kt">char</span> <span class="n">eoshandle</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci9118_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci9118_exttrg_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci9118_exttrg_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pci9118_calc_divisors</span><span class="p">(</span><span class="kt">char</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tim2</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chans</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="n">usessh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chnsshfront</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_insn_read_ai</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">=</span> <span class="n">AdControl_Int</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span> <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
						<span class="cm">/*</span>
<span class="cm">						 * positive triggers, no S&amp;H,</span>
<span class="cm">						 * no burst, burst stop,</span>
<span class="cm">						 * no post trigger,</span>
<span class="cm">						 * no about trigger,</span>
<span class="cm">						 * trigger stop</span>
<span class="cm">						 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DELFIFO</span><span class="p">);</span>	<span class="cm">/* flush FIFO */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SOFTTRG</span><span class="p">);</span>	<span class="cm">/* start conversion */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AdStatus_ADrdy</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">conv_finish</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D insn timeout&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DELFIFO</span><span class="p">);</span>	<span class="cm">/* flush FIFO */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

<span class="nl">conv_finish:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai16bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
				 <span class="n">PCI9118_AD_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_AD_DATA</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DELFIFO</span><span class="p">);</span>	<span class="cm">/* flush FIFO */</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_insn_write_ao</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">chanreg</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="n">chanreg</span> <span class="o">=</span> <span class="n">PCI9118_DA2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chanreg</span> <span class="o">=</span> <span class="n">PCI9118_DA1</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">chanreg</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_insn_read_ao</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_insn_bits_di</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_insn_bits_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupt_pci9118_ai_mode4_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span>
	    <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span> <span class="o">|</span> <span class="n">AdFunction_AM</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNTCTRL</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT0</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT0</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">|=</span> <span class="n">AdFunction_Start</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">defragment_dma_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					  <span class="kt">short</span> <span class="o">*</span><span class="n">dma_buffer</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="p">,</span>
	    <span class="n">stop_pos</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">raw_scanlen</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">+</span>
	    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_dmapos</span> <span class="o">&gt;=</span> <span class="n">start_pos</span> <span class="o">&amp;&amp;</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_dmapos</span> <span class="o">&lt;</span> <span class="n">stop_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_buffer</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_dmapos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_dmapos</span> <span class="o">%=</span> <span class="n">raw_scanlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">move_block_from_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					<span class="kt">short</span> <span class="o">*</span><span class="n">dma_buffer</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">;</span>

	<span class="n">num_samples</span> <span class="o">=</span> <span class="n">defragment_dma_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dma_buffer</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">+=</span>
	    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">+</span> <span class="n">num_samples</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">+=</span> <span class="n">num_samples</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">%=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span><span class="p">;</span>
	<span class="n">num_bytes</span> <span class="o">=</span>
	    <span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dma_buffer</span><span class="p">,</span>
				      <span class="n">num_samples</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">&lt;</span> <span class="n">num_samples</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">pci9118_decode_error_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D FIFO Full status (Fatal Error!)&quot;</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x100L</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="mh">0x008</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;A/D Burst Mode Overrun Status (Fatal Error!)&quot;</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x008L</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="mh">0x004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D Over Speed Status (Warning!)&quot;</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x004L</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="mh">0x002</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A/D Overrun Status (Fatal Error!)&quot;</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x002L</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskharderr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9118_ai_munge</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_chan_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai16bits</span><span class="p">)</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupt_pci9118_ai_onesample</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">int_adstat</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_amcc</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">int_daq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">short</span> <span class="n">sampl</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_adstat</span> <span class="o">&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci9118_decode_error_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">int_adstat</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">sampl</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_AD_DATA</span><span class="p">);</span>

<span class="cp">#ifdef PCI9118_PARANOIDCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai16bits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sampl</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="p">])</span> <span class="p">{</span>
							<span class="cm">/* data dropout! */</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;comedi: A/D  SAMPL - data dropout: &quot;</span>
				<span class="s">&quot;received channel %d, expected %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sampl</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="p">]);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sampl</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* one scan done */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">%=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* all data sampled */</span>
				<span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupt_pci9118_ai_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">int_adstat</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_amcc</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">int_daq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_dma_buf</span><span class="p">,</span> <span class="n">samplesinbuf</span><span class="p">,</span> <span class="n">sampls</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_amcc</span> <span class="o">&amp;</span> <span class="n">MASTER_ABORT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AMCC IRQ - MASTER DMA ABORT!&quot;</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_amcc</span> <span class="o">&amp;</span> <span class="n">TARGET_ABORT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AMCC IRQ - TARGET DMA ABORT!&quot;</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_adstat</span> <span class="o">&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span><span class="p">)</span>
					<span class="cm">/* if (int_adstat &amp; 0x106) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci9118_decode_error_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">int_adstat</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">samplesinbuf</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/* number of received real samples */</span>
<span class="cm">/* DPRINTK(&quot;dma_actbuf=%d\n&quot;,devpriv-&gt;dma_actbuf); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_doublebuf</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*</span>
<span class="cm">					 * switch DMA buffers if is used</span>
<span class="cm">					 * double buffering</span>
<span class="cm">					 */</span>
		<span class="n">next_dma_buf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">],</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWAR</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">],</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWTC</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_used_size</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="n">next_dma_buf</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">interrupt_pci9118_ai_mode4_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">samplesinbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">						 * how many samples is to</span>
<span class="cm">						 * end of buffer</span>
<span class="cm">						 */</span>
<span class="cm">/*</span>
<span class="cm"> * DPRINTK(&quot;samps=%d m=%d %d %d\n&quot;,</span>
<span class="cm"> * samplesinbuf,m,s-&gt;async-&gt;buf_int_count,s-&gt;async-&gt;buf_int_ptr);</span>
<span class="cm"> */</span>
		<span class="n">sampls</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
		<span class="n">move_block_from_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span><span class="p">],</span>
				    <span class="n">samplesinbuf</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">sampls</span><span class="p">;</span>		<span class="cm">/* m= how many samples was transferred */</span>
	<span class="p">}</span>
<span class="cm">/* DPRINTK(&quot;YYY\n&quot;); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">&gt;=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* all data sampled */</span>
			<span class="n">pci9118_ai_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_doublebuf</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* switch dma buffers */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* restart DMA if is not used double buffering */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWAR</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWTC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">interrupt_pci9118_ai_mode4_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_pci9118</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_daq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">int_amcc</span><span class="p">,</span> <span class="n">int_adstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* not fully initialized */</span>

	<span class="n">int_daq</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTSRC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
					<span class="cm">/* get IRQ reasons from card */</span>
	<span class="n">int_amcc</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
					<span class="cm">/* get INT register from AMCC chip */</span>

<span class="cm">/*</span>
<span class="cm"> * DPRINTK(&quot;INT daq=0x%01x amcc=0x%08x MWAR=0x%08x</span>
<span class="cm"> * MWTC=0x%08x ADSTAT=0x%02x ai_do=%d\n&quot;,</span>
<span class="cm"> * int_daq, int_amcc, inl(devpriv-&gt;iobase_a+AMCC_OP_REG_MWAR),</span>
<span class="cm"> * inl(devpriv-&gt;iobase_a+AMCC_OP_REG_MWTC),</span>
<span class="cm"> * inw(dev-&gt;iobase+PCI9118_ADSTAT)&amp;0x1ff,devpriv-&gt;ai_do);</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">int_daq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">int_amcc</span> <span class="o">&amp;</span> <span class="n">ANY_S593X_INT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* interrupt from other source */</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">int_amcc</span> <span class="o">|</span> <span class="mh">0x00ff0000</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
					<span class="cm">/* shutdown IRQ reasons in AMCC */</span>

	<span class="n">int_adstat</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
					<span class="cm">/* get STATUS register */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">int_adstat</span> <span class="o">&amp;</span> <span class="n">AdStatus_DTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="n">int_daq</span> <span class="o">&amp;</span> <span class="n">Int_DTrg</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* start stop of measure */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;</span> <span class="n">START_AI_EXT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;=</span>
					    <span class="o">~</span><span class="n">START_AI_EXT</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;</span>
							<span class="n">STOP_AI_EXT</span><span class="p">))</span>
							<span class="n">pci9118_exttrg_del</span>
							<span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EXTTRG_AI</span><span class="p">);</span>
						<span class="cm">/* deactivate EXT trigger */</span>
					<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor1</span><span class="p">,</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor2</span><span class="p">);</span>
						<span class="cm">/* start pacer */</span>
					<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;</span>
						<span class="n">STOP_AI_EXT</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;=</span>
							<span class="o">~</span><span class="n">STOP_AI_EXT</span><span class="p">;</span>
						<span class="n">pci9118_exttrg_del</span>
							<span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EXTTRG_AI</span><span class="p">);</span>
						<span class="cm">/* deactivate EXT trigger */</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="cm">/*</span>
<span class="cm">						 * well, on next interrupt from</span>
<span class="cm">						 * DMA/EOC measure will stop</span>
<span class="cm">						 */</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_ai_func</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">int_adstat</span><span class="p">,</span>
					<span class="n">int_amcc</span><span class="p">,</span> <span class="n">int_daq</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_ai_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trignum</span> <span class="o">!=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_inttrig_start</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">START_AI_INT</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor1</span><span class="p">,</span>
			    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor2</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_SoftG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_INT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span> <span class="o">|</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * step 2:</span>
<span class="cm">	 * make sure trigger sources are</span>
<span class="cm">	 * unique and mutually compatible</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_INT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_NOW</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_FOLLOW</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">=</span> <span class="n">TRIG_FOLLOW</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_NOW</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichanlist</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">%</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">/</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">);</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
<span class="cm">/* printk(&quot;S1 timer1=%u timer2=%u\n&quot;,cmd-&gt;scan_begin_arg,cmd-&gt;convert_arg); */</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
<span class="cm">/* printk(&quot;S2 timer1=%u timer2=%u\n&quot;,cmd-&gt;scan_begin_arg,cmd-&gt;convert_arg); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_NOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">divisor2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_MASK</span><span class="p">);</span>
<span class="cm">/* printk(&quot;s1 timer1=%u timer2=%u\n&quot;,cmd-&gt;scan_begin_arg,cmd-&gt;convert_arg); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span>
		    <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
				    <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span> <span class="o">*</span>
				    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
					    <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span> <span class="o">*</span>
					    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="cm">/* printk(&quot;s2 timer1=%u timer2=%u\n&quot;,cmd-&gt;scan_begin_arg,cmd-&gt;convert_arg); */</span>
					<span class="n">err</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
					    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span>
					    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
<span class="cm">/* printk(&quot;s3 timer1=%u timer2=%u\n&quot;,cmd-&gt;scan_begin_arg,cmd-&gt;convert_arg); */</span>
					<span class="n">err</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* incorrect channels list */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">Compute_and_setup_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmalen0</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: Compute_and_setup_dma()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_size</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;1 dmalen0=%d dmalen1=%d ai_data_len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span><span class="p">);</span>
	<span class="cm">/* isn&#39;t output buff smaller that our DMA buff? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">							 * align to 32bit down</span>
<span class="cm">							 */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">							 * align to 32bit down</span>
<span class="cm">							 */</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;2 dmalen0=%d dmalen1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">);</span>

	<span class="cm">/* we want wake up every scan? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* uff, too short DMA buffer, disable EOS support! */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TRIG_WAKE_EOS</span><span class="p">);</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;comedi%d: WAR: DMA0 buf too short, can&#39;t &quot;</span>
					<span class="s">&quot;support TRIG_WAKE_EOS (%d&lt;%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* short first DMA buffer to one scan */</span>
			<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">DPRINTK</span>
				<span class="p">(</span><span class="s">&quot;21 dmalen0=%d ai_n_realscanlen=%d &quot;</span>
							<span class="s">&quot;useeoshandle=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dmalen0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">useeoshandle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">useeoshandle</span><span class="p">)</span>
				<span class="n">dmalen0</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
					<span class="p">(</span><span class="s">&quot;comedi%d: ERR: DMA0 buf len bug? &quot;</span>
								<span class="s">&quot;(%d&lt;4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">);</span>
				<span class="n">dmalen0</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* uff, too short DMA buffer, disable EOS support! */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TRIG_WAKE_EOS</span><span class="p">);</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;comedi%d: WAR: DMA1 buf too short, &quot;</span>
					<span class="s">&quot;can&#39;t support TRIG_WAKE_EOS (%d&lt;%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* short second DMA buffer to one scan */</span>
			<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">DPRINTK</span>
			    <span class="p">(</span><span class="s">&quot;22 dmalen1=%d ai_n_realscanlen=%d &quot;</span>
							<span class="s">&quot;useeoshandle=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dmalen1</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">useeoshandle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">useeoshandle</span><span class="p">)</span>
				<span class="n">dmalen1</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
					<span class="p">(</span><span class="s">&quot;comedi%d: ERR: DMA1 buf len bug? &quot;</span>
								<span class="s">&quot;(%d&lt;4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">);</span>
				<span class="n">dmalen1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;3 dmalen0=%d dmalen1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">);</span>
	<span class="cm">/* transfer without TRIG_WAKE_EOS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if it&#39;s possible then align DMA buffers to length of scan */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dmalen0</span><span class="p">;</span>
		<span class="n">dmalen0</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">dmalen0</span> <span class="o">/</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dmalen0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmalen0</span><span class="p">)</span>
			<span class="n">dmalen0</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	<span class="cm">/* uff. very long scan? */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dmalen1</span><span class="p">;</span>
		<span class="n">dmalen1</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">dmalen1</span> <span class="o">/</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dmalen1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmalen1</span><span class="p">)</span>
			<span class="n">dmalen1</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	<span class="cm">/* uff. very long scan? */</span>
		<span class="cm">/*</span>
<span class="cm">		 * if measure isn&#39;t neverending then test, if it fits whole</span>
<span class="cm">		 * into one or two DMA buffers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fits whole measure into one DMA buffer? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmalen0</span> <span class="o">&gt;</span>
			    <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DPRINTK</span>
				    <span class="p">(</span><span class="s">&quot;3.0 ai_n_realscanlen=%d ai_scans=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span>
				     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">);</span>
				<span class="n">dmalen0</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">;</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;3.1 dmalen0=%d dmalen1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span>
					<span class="n">dmalen1</span><span class="p">);</span>
				<span class="n">dmalen0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/*</span>
<span class="cm">					 * fits whole measure into</span>
<span class="cm">					 * two DMA buffer?</span>
<span class="cm">					 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dmalen1</span> <span class="o">&gt;</span>
				    <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
				     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">-</span> <span class="n">dmalen0</span><span class="p">))</span>
					<span class="n">dmalen1</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">-</span> <span class="n">dmalen0</span><span class="p">;</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;3.2 dmalen0=%d dmalen1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span>
					<span class="n">dmalen1</span><span class="p">);</span>
				<span class="n">dmalen1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3L</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;4 dmalen0=%d dmalen1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">);</span>

	<span class="cm">/* these DMA buffer size will be used */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmalen0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmalen1</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;5 dmalen0=%d dmalen1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmalen0</span><span class="p">,</span> <span class="n">dmalen1</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (devpriv-&gt;ai_n_scanlen &lt; this_board-&gt;half_fifo_size) {</span>
<span class="c">		devpriv-&gt;dmabuf_panic_size[0] =</span>
<span class="c">		    (this_board-&gt;half_fifo_size / devpriv-&gt;ai_n_scanlen +</span>
<span class="c">		     1) * devpriv-&gt;ai_n_scanlen * sizeof(short);</span>
<span class="c">		devpriv-&gt;dmabuf_panic_size[1] =</span>
<span class="c">		    (this_board-&gt;half_fifo_size / devpriv-&gt;ai_n_scanlen +</span>
<span class="c">		     1) * devpriv-&gt;ai_n_scanlen * sizeof(short);</span>
<span class="c">	} else {</span>
<span class="c">		devpriv-&gt;dmabuf_panic_size[0] =</span>
<span class="c">		    (devpriv-&gt;ai_n_scanlen &lt;&lt; 1) % devpriv-&gt;dmabuf_size[0];</span>
<span class="c">		devpriv-&gt;dmabuf_panic_size[1] =</span>
<span class="c">		    (devpriv-&gt;ai_n_scanlen &lt;&lt; 1) % devpriv-&gt;dmabuf_size[1];</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">EN_A2P_TRANSFERS</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">);</span>	<span class="cm">/* stop DMA */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWAR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_use_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MWTC</span><span class="p">);</span>
	<span class="cm">/* init DMA transfer */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000</span> <span class="o">|</span> <span class="n">AINT_WRITE_COMPL</span><span class="p">,</span>
	     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
<span class="cm">/* outl(0x02000000|AINT_WRITE_COMPL, devpriv-&gt;iobase_a+AMCC_OP_REG_INTCSR); */</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span>
		 <span class="n">AMCC_OP_REG_MCSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">RESET_A2P_FLAGS</span> <span class="o">|</span> <span class="n">A2P_HI_PRIORITY</span> <span class="o">|</span>
	     <span class="n">EN_A2P_TRANSFERS</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">EN_A2P_TRANSFERS</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
						<span class="cm">/* allow bus mastering */</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: END: Compute_and_setup_dma()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_ai_docmd_sampl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: pci9118_ai_docmd_sampl(%d,) [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_TmrTr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci9118_ai_docmd_sampl() mode 2 bug!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_ExtM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci9118_ai_docmd_sampl() mode 4 bug!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;pci9118_ai_docmd_sampl() mode number bug!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_ai_func</span> <span class="o">=</span> <span class="n">interrupt_pci9118_ai_onesample</span><span class="p">;</span>
						<span class="cm">/* transfer function */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span><span class="p">)</span>
		<span class="n">pci9118_exttrg_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EXTTRG_AI</span><span class="p">);</span>
						<span class="cm">/* activate EXT trigger */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span> <span class="o">|=</span> <span class="n">Int_Timer</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_Int</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1f00</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
							<span class="cm">/* allow INT in AMCC */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">START_AI_EXT</span> <span class="o">|</span> <span class="n">START_AI_INT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor1</span><span class="p">,</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor2</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_SoftG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: END: pci9118_ai_docmd_sampl()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_ai_docmd_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: pci9118_ai_docmd_dma(%d,) [%d,%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">);</span>
	<span class="n">Compute_and_setup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span>
		    <span class="p">((</span><span class="n">AdControl_TmrTr</span> <span class="o">|</span> <span class="n">AdControl_Dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span>
		    <span class="p">((</span><span class="n">AdControl_TmrTr</span> <span class="o">|</span> <span class="n">AdControl_Dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span>
		    <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span> <span class="o">|</span> <span class="n">AdFunction_BM</span> <span class="o">|</span>
		    <span class="n">AdFunction_BS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span><span class="p">))</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">|=</span> <span class="n">AdFunction_BSSH</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_BURST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span>
		    <span class="p">((</span><span class="n">AdControl_ExtM</span> <span class="o">|</span> <span class="n">AdControl_Dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span> <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span>
		    <span class="p">((</span><span class="n">AdControl_TmrTr</span> <span class="o">|</span> <span class="n">AdControl_Dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span>
		    <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span> <span class="o">|</span> <span class="n">AdFunction_AM</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNTCTRL</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT0</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT0</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">|=</span> <span class="n">AdFunction_Start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci9118_ai_docmd_dma() mode number bug!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci9118_exttrg_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EXTTRG_AI</span><span class="p">);</span>
						<span class="cm">/* activate EXT trigger */</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_ai_func</span> <span class="o">=</span> <span class="n">interrupt_pci9118_ai_dma</span><span class="p">;</span>
						<span class="cm">/* transfer function */</span>

	<span class="n">outl</span><span class="p">(</span><span class="mh">0x02000000</span> <span class="o">|</span> <span class="n">AINT_WRITE_COMPL</span><span class="p">,</span>
	     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">START_AI_EXT</span> <span class="o">|</span> <span class="n">START_AI_INT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor1</span><span class="p">,</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor2</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_SoftG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: pci9118_ai_docmd_dma()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addchans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: pci9118_ai_cmd(%d,)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_data_len</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskerr</span> <span class="o">=</span> <span class="mh">0x10e</span><span class="p">;</span>

	<span class="cm">/* prepare for start/stop conditions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">|=</span> <span class="n">START_AI_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">|=</span> <span class="n">STOP_AI_EXT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span> <span class="o">|=</span> <span class="n">START_AI_INT</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_inttrig_start</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="n">pci9118_ai_inttrig</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (cmd-&gt;stop_src == TRIG_INT) {</span>
<span class="c">		devpriv-&gt;ai_neverending = 1;</span>
<span class="c">		devpriv-&gt;ai12_startstop |= STOP_AI_INT;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* use sample&amp;hold signal? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* yes */</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/*  no */</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;1 neverending=%d scans=%u usessh=%d ai_startstop=0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_scans</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai12_startstop</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * use additional sample at end of every scan</span>
<span class="cm">	 * to satisty DMA 32 bit transfer?</span>
<span class="cm">	 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">useeoshandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * use INT transfer if scanlist</span>
<span class="cm">					 * have only one channel</span>
<span class="cm">					 */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * vpriv-&gt;useeoshandle=1; // change DMA transfer</span>
<span class="cm">				 * block to fit EOS on every second call</span>
<span class="cm">				 */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * XXX maybe can be corrected to use 16 bit DMA</span>
<span class="cm">				 */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/*</span>
<span class="cm">					 * well, we must insert one sample</span>
<span class="cm">					 * to end of EOS to meet 32 bit transfer</span>
<span class="cm">					 */</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* interrupt transfer don&#39;t need any correction */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * we need software S&amp;H signal?</span>
<span class="cm">	 * It adds two samples before every scan as minimum</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span> <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
							<span class="cm">/* move it to front */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="o">++</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="n">addchans</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span> <span class="o">/</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span> <span class="o">%</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
			<span class="n">addchans</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addchans</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
							<span class="cm">/* uff, still short */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">=</span> <span class="n">addchans</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">+</span>
				     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">+</span>
				     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="o">++</span><span class="p">;</span>
							<span class="cm">/* round up to 32 bit */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* well, we now know what must be all added */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span> <span class="o">=</span>	<span class="cm">/*</span>
<span class="cm">					 * what we must take from card in real</span>
<span class="cm">					 * to have ai_n_scanlen on output?</span>
<span class="cm">					 */</span>
	    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span> <span class="o">+</span>
	     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span> <span class="o">/</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;2 usedma=%d realscan=%d af=%u n_chan=%d ab=%d n_scanlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span><span class="p">,</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_scanlen</span><span class="p">);</span>

	<span class="cm">/* check and setup channel list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup_channel_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_chan</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_chanlist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_back</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">,</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">useeoshandle</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* compute timers settings */</span>
	<span class="cm">/*</span>
<span class="cm">	 * simplest way, fr=4Mhz/(tim1*tim2),</span>
<span class="cm">	 * channel manipulation without timers effect</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_INT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* both timer is used for one time */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pci9118_calc_divisors</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor1</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor2</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)))</span> <span class="p">{</span>
						<span class="cm">/* double timed action */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;cmd-&gt;scan_begin_src=TRIG_TIMER works &quot;</span>
						<span class="s">&quot;only with bus mastering!&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pci9118_calc_divisors</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_flags</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_n_realscanlen</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor1</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_divisor2</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usessh</span><span class="p">,</span>
				      <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_add_front</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer1</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_timer2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_FOLLOW</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* stop pacer */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * bipolar, S.E., use 8254, stop 8354,</span>
<span class="cm">					 * internal trigger, soft trigger,</span>
<span class="cm">					 * disable DMA</span>
<span class="cm">					 */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span> <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * positive triggers, no S&amp;H, no burst,</span>
<span class="cm">					 * burst stop, no post trigger,</span>
<span class="cm">					 * no about trigger, trigger stop</span>
<span class="cm">					 */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DELFIFO</span><span class="p">);</span>	<span class="cm">/* flush FIFO */</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADSTAT</span><span class="p">);</span>	<span class="cm">/*</span>
<span class="cm">						 * flush A/D and INT</span>
<span class="cm">						 * status register</span>
<span class="cm">						 */</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTSRC</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_dmapos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_buf_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci9118_ai_docmd_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci9118_ai_docmd_sampl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: END: pci9118_ai_cmd()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frontadd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backadd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">differencial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bipolar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* correct channel and range number check itself comedi/range.c */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_chan</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;range/channel list is empty!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">frontadd</span> <span class="o">+</span> <span class="n">n_chan</span> <span class="o">+</span> <span class="n">backadd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;comedi%d: range/channel list is too long for &quot;</span>
						<span class="s">&quot;actual configuration (%d&gt;%d)!&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">-</span> <span class="n">frontadd</span> <span class="o">-</span> <span class="n">backadd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">differencial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* all input must be diff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">PCI9118_BIPOLAR_RANGES</span><span class="p">)</span>
		<span class="n">bipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* all input must be bipolar */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_chan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* check S.E/diff */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">differencial</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;Differencial and single ended &quot;</span>
						<span class="s">&quot;inputs can&#39;t be mixtured!&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">PCI9118_BIPOLAR_RANGES</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">bipolar</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;Bipolar and unipolar ranges &quot;</span>
							<span class="s">&quot;can&#39;t be mixtured!&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">differencial</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichand</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;If AREF_DIFF is used then is &quot;</span>
					<span class="s">&quot;available only first 8 channels!&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frontadd</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">backadd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">usedma</span><span class="p">,</span> <span class="kt">char</span> <span class="n">useeos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">differencial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bipolar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scanquad</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">ssh</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">DPRINTK</span>
	    <span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: setup_channel_list&quot;</span>
						<span class="s">&quot;(%d,.,%d,.,%d,%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">frontadd</span><span class="p">,</span> <span class="n">backadd</span><span class="p">,</span> <span class="n">usedma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usedma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rot</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">usedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">AREF_DIFF</span><span class="p">)</span>
		<span class="n">differencial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* all input must be diff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">PCI9118_BIPOLAR_RANGES</span><span class="p">)</span>
		<span class="n">bipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* all input must be bipolar */</span>

	<span class="cm">/* All is ok, so we can setup channel/range list */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bipolar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_UniP</span><span class="p">;</span>
							<span class="cm">/* set unibipolar */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">AdControl_UniP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
							<span class="cm">/* enable bipolar */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">differencial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">|=</span> <span class="n">AdControl_Diff</span><span class="p">;</span>
							<span class="cm">/* enable diff inputs */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">AdControl_Diff</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
						<span class="cm">/* set single ended inputs */</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
								<span class="cm">/* setup mode */</span>

	<span class="n">outl</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>
					<span class="cm">/* gods know why this sequence! */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>

<span class="cp">#ifdef PCI9118_PARANOIDCHECK</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlistlen</span> <span class="o">=</span> <span class="n">n_chan</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PCI9118_CHANLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55aa</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frontadd</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* insert channels for S&amp;H */</span>
		<span class="n">ssh</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshsample</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;FA: %04x: &quot;</span><span class="p">,</span> <span class="n">ssh</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frontadd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* store range list to card */</span>
			<span class="n">scanquad</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
						<span class="cm">/* get channel number; */</span>
			<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
						<span class="cm">/* get gain number */</span>
			<span class="n">scanquad</span> <span class="o">|=</span> <span class="p">((</span><span class="n">gain</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">scanquad</span> <span class="o">|</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_GAIN</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">scanquad</span> <span class="o">|</span> <span class="n">ssh</span><span class="p">);</span>
			<span class="n">ssh</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshhold</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;SL: &quot;</span><span class="p">,</span> <span class="n">ssh</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* store range list to card */</span>
		<span class="n">scanquad</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>	<span class="cm">/* get channel number */</span>
<span class="cp">#ifdef PCI9118_PARANOIDCHECK</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span> <span class="o">^</span> <span class="n">usedma</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scanquad</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">rot</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>		<span class="cm">/* get gain number */</span>
		<span class="n">scanquad</span> <span class="o">|=</span> <span class="p">((</span><span class="n">gain</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">scanquad</span> <span class="o">|</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_GAIN</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">scanquad</span> <span class="o">|</span> <span class="n">ssh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">backadd</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* insert channels for fit onto 32bit DMA */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;BA: %04x: &quot;</span><span class="p">,</span> <span class="n">ssh</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">backadd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* store range list to card */</span>
			<span class="n">scanquad</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
							<span class="cm">/* get channel number */</span>
			<span class="n">gain</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>	<span class="cm">/* get gain number */</span>
			<span class="n">scanquad</span> <span class="o">|=</span> <span class="p">((</span><span class="n">gain</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">scanquad</span> <span class="o">|</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_GAIN</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">scanquad</span> <span class="o">|</span> <span class="n">ssh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef PCI9118_PARANOIDCHECK</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">n_chan</span> <span class="o">^</span> <span class="n">usedma</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span> <span class="o">^</span> <span class="n">usedma</span><span class="p">];</span>
						<span class="cm">/* for 32bit operations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">useeos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* store range list to card */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[(</span><span class="n">n_chan</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">usedma</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">rot</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_chan</span><span class="p">)</span> <span class="o">^</span> <span class="n">usedma</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span> <span class="o">^</span> <span class="n">usedma</span><span class="p">];</span>
						<span class="cm">/* for 32bit operations */</span>
		<span class="n">useeos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">useeos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PCI9118_EXTDEBUG</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CHL: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">useeos</span> <span class="o">*</span> <span class="n">n_chan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%04x &quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>	<span class="cm">/* close scan queue */</span>
	<span class="cm">/* udelay(100); important delay, or first sample will be crippled */</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: END: setup_channel_list()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* we can serve this with scan logic */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">  calculate 8254 divisors if they are used for dual timing</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9118_calc_divisors</span><span class="p">(</span><span class="kt">char</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tim2</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chans</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="n">usessh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chnsshfront</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span>
	    <span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: BGN: pci9118_calc_divisors&quot;</span>
					<span class="s">&quot;(%d,%d,.,%u,%u,%u,%d,.,.,,%u,%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">chans</span><span class="p">,</span> <span class="n">usessh</span><span class="p">,</span> <span class="n">chnsshfront</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tim2</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tim2</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="n">i8253_cascade_ns_to_timer</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="n">div1</span><span class="p">,</span> <span class="n">div2</span><span class="p">,</span>
					  <span class="n">tim2</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_ROUND_NEAREST</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;OSC base=%u div1=%u div2=%u timer1=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span> <span class="o">*</span><span class="n">tim1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tim2</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tim2</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_ns_min</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;1 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">div1</span> <span class="o">=</span> <span class="o">*</span><span class="n">tim2</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">;</span>
						<span class="cm">/* convert timer (burst) */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;2 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">div1</span> <span class="o">&lt;</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_pacer_min</span><span class="p">)</span>
			<span class="o">*</span><span class="n">div1</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_pacer_min</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;3 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">div2</span> <span class="o">=</span> <span class="o">*</span><span class="n">tim1</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">;</span>	<span class="cm">/* scan timer */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;4 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">div2</span> <span class="o">=</span> <span class="o">*</span><span class="n">div2</span> <span class="o">/</span> <span class="o">*</span><span class="n">div1</span><span class="p">;</span>		<span class="cm">/* major timer is c1*c2 */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;5 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">div2</span> <span class="o">&lt;</span> <span class="n">chans</span><span class="p">)</span>
			<span class="o">*</span><span class="n">div2</span> <span class="o">=</span> <span class="n">chans</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;6 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>

		<span class="o">*</span><span class="n">tim2</span> <span class="o">=</span> <span class="o">*</span><span class="n">div1</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">;</span>
							<span class="cm">/* real convert timer */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usessh</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chnsshfront</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>	<span class="cm">/* use BSSH signal */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">div2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">chans</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
				<span class="o">*</span><span class="n">div2</span> <span class="o">=</span> <span class="n">chans</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;7 div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span>
			<span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tim1</span> <span class="o">=</span> <span class="o">*</span><span class="n">div1</span> <span class="o">*</span> <span class="o">*</span><span class="n">div2</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;OSC base=%u div1=%u div2=%u timer1=%u timer2=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span><span class="p">,</span> <span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">,</span> <span class="o">*</span><span class="n">tim1</span><span class="p">,</span> <span class="o">*</span><span class="n">tim2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;adl_pci9118 EDBG: END: pci9118_calc_divisors(%u,%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">div1</span><span class="p">,</span> <span class="o">*</span><span class="n">div2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_pacer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNTCTRL</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNTCTRL</span><span class="p">);</span>
<span class="cm">/* outl(0x30, dev-&gt;iobase + PCI9118_CNTCTRL); */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">divisor2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT2</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">divisor2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT2</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">divisor1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT1</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">((</span><span class="n">divisor1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNT1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_exttrg_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>				<span class="cm">/* incorrect source */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">exttrg_users</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">source</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span> <span class="o">|=</span> <span class="n">Int_DTrg</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1f00</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
							<span class="cm">/* allow INT in AMCC */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_exttrg_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* incorrect source */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">exttrg_users</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">source</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">exttrg_users</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* shutdown ext trg intterrupts */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Int_DTrg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">)</span>	<span class="cm">/* all IRQ disabled */</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="o">~</span><span class="mh">0x00001f00</span><span class="p">),</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
						<span class="cm">/* disable int in AMCC */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_ai_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="o">~</span><span class="n">EN_A2P_TRANSFERS</span><span class="p">),</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_MCSR</span><span class="p">);</span>	<span class="cm">/* stop DMA */</span>
	<span class="n">pci9118_exttrg_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EXTTRG_AI</span><span class="p">);</span>
	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* stop 8254 counters */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span> <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * positive triggers, no S&amp;H, no burst,</span>
<span class="cm">					 * burst stop, no post trigger,</span>
<span class="cm">					 * no about trigger, trigger stop</span>
<span class="cm">					 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * bipolar, S.E., use 8254, stop 8354,</span>
<span class="cm">					 * internal trigger, soft trigger,</span>
<span class="cm">					 * disable INT and DMA</span>
<span class="cm">					 */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_BURST</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>	<span class="cm">/* reset scan queue */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DELFIFO</span><span class="p">);</span>	<span class="cm">/* flush FIFO */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_do</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_act_dmapos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_buf_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_neverending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_actbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1f00</span><span class="p">,</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">+</span> <span class="n">AMCC_OP_REG_INTCSR</span><span class="p">);</span>
							<span class="cm">/* allow INT in AMCC */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">==============================================================================</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">exttrg_users</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">IntControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTCTRL</span><span class="p">);</span>
						<span class="cm">/* disable interrupts source */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_CNTCTRL</span><span class="p">);</span>
<span class="cm">/* outl(0xb4, dev-&gt;iobase + PCI9118_CNTCTRL); */</span>
	<span class="n">start_pacer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* stop 8254 counters */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
						<span class="cm">/*</span>
<span class="cm">						 * bipolar, S.E., use 8254,</span>
<span class="cm">						 * stop 8354, internal trigger,</span>
<span class="cm">						 * soft trigger,</span>
<span class="cm">						 * disable INT and DMA</span>
<span class="cm">						 */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_BURST</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_SCANMOD</span><span class="p">);</span>	<span class="cm">/* reset scan queue */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span> <span class="o">=</span> <span class="n">AdFunction_PDTrg</span> <span class="o">|</span> <span class="n">AdFunction_PETrg</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdFunctionReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADFUNC</span><span class="p">);</span>
						<span class="cm">/*</span>
<span class="cm">						 * positive triggers, no S&amp;H,</span>
<span class="cm">						 * no burst, burst stop,</span>
<span class="cm">						 * no post trigger,</span>
<span class="cm">						 * no about trigger,</span>
<span class="cm">						 * trigger stop</span>
<span class="cm">						 */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2047</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2047</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DA1</span><span class="p">);</span>
						<span class="cm">/* reset A/D outs to 0V */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DA2</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DO</span><span class="p">);</span>	<span class="cm">/* reset digi outs to L */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_AD_DATA</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_DELFIFO</span><span class="p">);</span>	<span class="cm">/* flush FIFO */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTSRC</span><span class="p">);</span>	<span class="cm">/* remove INT requests */</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADSTAT</span><span class="p">);</span>	<span class="cm">/* flush A/D status register */</span>
	<span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_INTSRC</span><span class="p">);</span>	<span class="cm">/* flush INT requests */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">AdControlReg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI9118_ADCNTRL</span><span class="p">);</span>
						<span class="cm">/*</span>
<span class="cm">						 * bipolar, S.E., use 8254,</span>
<span class="cm">						 * stop 8354, internal trigger,</span>
<span class="cm">						 * soft trigger,</span>
<span class="cm">						 * disable INT and DMA</span>
<span class="cm">						 */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cnt0_users</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">exttrg_users</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci9118_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">master</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase_a</span><span class="p">,</span> <span class="n">iobase_9</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opt_bus</span><span class="p">,</span> <span class="n">opt_slot</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_bus</span><span class="p">,</span> <span class="n">pci_slot</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">u16w</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;comedi%d: adl_pci9118: board=%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">opt_bus</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">opt_slot</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* user don&#39;t want use bus master */</span>
	<span class="k">else</span>
		<span class="n">master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci9118_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Allocation failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Look for matching PCI device */</span>
	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;not found!&quot;</span><span class="p">;</span>
	<span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="p">(</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMCC</span><span class="p">,</span>
						<span class="n">this_board</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span>
						<span class="n">pcidev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Found matching vendor/device. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_bus</span> <span class="o">||</span> <span class="n">opt_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check bus/slot. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_bus</span> <span class="o">!=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span>
			    <span class="o">||</span> <span class="n">opt_slot</span> <span class="o">!=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* no match */</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Look for device that isn&#39;t in use.</span>
<span class="cm">		 * Enable PCI device and request regions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_pci_enable</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;adl_pci9118&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">errstr</span> <span class="o">=</span>
			    <span class="s">&quot;failed to enable PCI device and request regions!&quot;</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_bus</span> <span class="o">||</span> <span class="n">opt_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; - Card at b:s %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">opt_bus</span><span class="p">,</span> <span class="n">opt_slot</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; - Card %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span>
		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>


	<span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">pci_slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">pci_func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">iobase_a</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iobase_9</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;, b:s:f=%d:%d:%d, io=0x%4lx, 0x%4lx&quot;</span><span class="p">,</span> <span class="n">pci_bus</span><span class="p">,</span>
				<span class="n">pci_slot</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">,</span> <span class="n">iobase_9</span><span class="p">,</span> <span class="n">iobase_a</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase_9</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">iobase_a</span> <span class="o">=</span> <span class="n">iobase_a</span><span class="p">;</span>

	<span class="n">pci9118_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* user don&#39;t want use IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">interrupt_pci9118</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="s">&quot;ADLink PCI-9118&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, unable to allocate IRQ %d, DISABLING IT&quot;</span><span class="p">,</span>
			       <span class="n">irq</span><span class="p">);</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t use IRQ */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, irq=%u&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, IRQ disabled&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* alloc DMA buffers */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_doublebuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">pages</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">pages</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span>
							      <span class="n">pages</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">pages</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, Can&#39;t allocate DMA buffer, DMA disabled!&quot;</span><span class="p">);</span>
			<span class="n">master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dma_doublebuf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, bus master&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, no bus master&quot;</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* max 256 channels! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
					<span class="cm">/* max 128 channels with softare S&amp;H! */</span>
			<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, ext. mux %d channels&quot;</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* select sample&amp;hold signal polarity */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span> <span class="o">=</span> <span class="o">-</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshdelay</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshsample</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshhold</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshsample</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">softsshhold</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u16w</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">u16w</span> <span class="o">|</span> <span class="mi">64</span><span class="p">);</span>
				<span class="cm">/* Enable parity check for parity error */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">usemux</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichan</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_maxdata</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aichanlist</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ai</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">pci9118_ai_cancel</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pci9118_insn_read_ai</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="n">pci9118_ai_cmdtest</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="n">pci9118_ai_cmd</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">munge</span> <span class="o">=</span> <span class="n">pci9118_ai_munge</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ao_maxdata</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">n_aochan</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">this_board</span><span class="o">-&gt;</span><span class="n">rangelist_ao</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="n">pci9118_insn_write_ao</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">pci9118_insn_read_ao</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* all bits input */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pci9118_insn_bits_di</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>	<span class="cm">/* all bits output */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">pci9118_insn_bits_do</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">i8254_osc_base</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>	<span class="cm">/* 250ns=4MHz */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskharderr</span> <span class="o">=</span> <span class="mh">0x10a</span><span class="p">;</span>
					<span class="cm">/* default measure crash condition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>		<span class="cm">/* disable some requested */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_maskharderr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">this_board</span><span class="o">-&gt;</span><span class="n">ai_maxdata</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0xffff</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai16bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai16bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci9118_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="n">pci9118_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
				<span class="n">comedi_pci_disable</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_virt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				   <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dmabuf_pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">boardtype</span> <span class="n">boardtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pci9118dg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor_id</span>	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_AMCC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device_id</span>	<span class="o">=</span> <span class="mh">0x80d9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange_amcc</span>	<span class="o">=</span> <span class="n">AMCC_OP_REG_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange_9118</span>	<span class="o">=</span> <span class="n">IORANGE_9118</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichan</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichand</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mux_aichan</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichanlist</span>	<span class="o">=</span> <span class="n">PCI9118_CHANLEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aochan</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ai</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci9118dg_hr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ao</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_ns_min</span>	<span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pacer_min</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">half_fifo_size</span>	<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pci9118hg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor_id</span>	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_AMCC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device_id</span>	<span class="o">=</span> <span class="mh">0x80d9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange_amcc</span>	<span class="o">=</span> <span class="n">AMCC_OP_REG_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange_9118</span>	<span class="o">=</span> <span class="n">IORANGE_9118</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichan</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichand</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mux_aichan</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichanlist</span>	<span class="o">=</span> <span class="n">PCI9118_CHANLEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aochan</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ai</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci9118hg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ao</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_ns_min</span>	<span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pacer_min</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">half_fifo_size</span>	<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pci9118hr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor_id</span>	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_AMCC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device_id</span>	<span class="o">=</span> <span class="mh">0x80d9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange_amcc</span>	<span class="o">=</span> <span class="n">AMCC_OP_REG_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iorange_9118</span>	<span class="o">=</span> <span class="n">IORANGE_9118</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichan</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichand</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mux_aichan</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aichanlist</span>	<span class="o">=</span> <span class="n">PCI9118_CHANLEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n_aochan</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_maxdata</span>	<span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ao_maxdata</span>	<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ai</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_pci9118dg_hr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rangelist_ao</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">range_bipolar10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_ns_min</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ai_pacer_min</span>	<span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">half_fifo_size</span>	<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">adl_pci9118_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;adl_pci9118&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">pci9118_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">pci9118_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_names</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">boardtypes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">board_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">boardtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boardtype</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">adl_pci9118_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">comedi_pci_auto_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adl_pci9118_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">adl_pci9118_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">comedi_pci_auto_unconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">adl_pci9118_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMCC</span><span class="p">,</span> <span class="mh">0x80d9</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">adl_pci9118_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">adl_pci9118_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;adl_pci9118&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">adl_pci9118_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">adl_pci9118_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">adl_pci9118_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_comedi_pci_driver</span><span class="p">(</span><span class="n">adl_pci9118_driver</span><span class="p">,</span> <span class="n">adl_pci9118_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
