<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › mpc624.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mpc624.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/mpc624.c</span>
<span class="cm">    Hardware driver for a Micro/sys inc. MPC-624 PC/104 board</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 2000 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">Driver: mpc624</span>
<span class="cm">Description: Micro/sys MPC-624 PC/104 board</span>
<span class="cm">Devices: [Micro/sys] MPC-624 (mpc624)</span>
<span class="cm">Author: Stanislaw Raczynski &lt;sraczynski@op.pl&gt;</span>
<span class="cm">Updated: Thu, 15 Sep 2005 12:01:18 +0200</span>
<span class="cm">Status: working</span>

<span class="cm">    The Micro/sys MPC-624 board is based on the LTC2440 24-bit sigma-delta</span>
<span class="cm">    ADC chip.</span>

<span class="cm">    Subdevices supported by the driver:</span>
<span class="cm">    - Analog In:   supported</span>
<span class="cm">    - Digital I/O: not supported</span>
<span class="cm">    - LEDs:        not supported</span>
<span class="cm">    - EEPROM:      not supported</span>

<span class="cm">Configuration Options:</span>
<span class="cm">  [0] - I/O base address</span>
<span class="cm">  [1] - conversion rate</span>
<span class="cm">	Conversion rate  RMS noise  Effective Number Of Bits</span>
<span class="cm">	0      3.52kHz        23uV                17</span>
<span class="cm">	1      1.76kHz       3.5uV                20</span>
<span class="cm">	2       880Hz         2uV                21.3</span>
<span class="cm">	3       440Hz        1.4uV               21.8</span>
<span class="cm">	4       220Hz         1uV                22.4</span>
<span class="cm">	5       110Hz        750uV               22.9</span>
<span class="cm">	6       55Hz         510nV               23.4</span>
<span class="cm">	7      27.5Hz        375nV                24</span>
<span class="cm">	8      13.75Hz       250nV               24.4</span>
<span class="cm">	9      6.875Hz       200nV               24.6</span>
<span class="cm">  [2] - voltage range</span>
<span class="cm">	0      -1.01V .. +1.01V</span>
<span class="cm">	1      -10.1V .. +10.1V</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;../comedidev.h&quot;</span>

<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cm">/* Consecutive I/O port addresses */</span>
<span class="cp">#define MPC624_SIZE             16</span>

<span class="cm">/* Offsets of different ports */</span>
<span class="cp">#define MPC624_MASTER_CONTROL	0 </span><span class="cm">/* not used */</span><span class="cp"></span>
<span class="cp">#define MPC624_GNMUXCH          1 </span><span class="cm">/* Gain, Mux, Channel of ADC */</span><span class="cp"></span>
<span class="cp">#define MPC624_ADC              2 </span><span class="cm">/* read/write to/from ADC */</span><span class="cp"></span>
<span class="cp">#define MPC624_EE               3 </span><span class="cm">/* read/write to/from serial EEPROM via I2C */</span><span class="cp"></span>
<span class="cp">#define MPC624_LEDS             4 </span><span class="cm">/* write to LEDs */</span><span class="cp"></span>
<span class="cp">#define MPC624_DIO              5 </span><span class="cm">/* read/write to/from digital I/O ports */</span><span class="cp"></span>
<span class="cp">#define MPC624_IRQ_MASK         6 </span><span class="cm">/* IRQ masking enable/disable */</span><span class="cp"></span>

<span class="cm">/* Register bits&#39; names */</span>
<span class="cp">#define MPC624_ADBUSY           (1&lt;&lt;5)</span>
<span class="cp">#define MPC624_ADSDO            (1&lt;&lt;4)</span>
<span class="cp">#define MPC624_ADFO             (1&lt;&lt;3)</span>
<span class="cp">#define MPC624_ADCS             (1&lt;&lt;2)</span>
<span class="cp">#define MPC624_ADSCK            (1&lt;&lt;1)</span>
<span class="cp">#define MPC624_ADSDI            (1&lt;&lt;0)</span>

<span class="cm">/* SDI Speed/Resolution Programming bits */</span>
<span class="cp">#define MPC624_OSR4             (1&lt;&lt;31)</span>
<span class="cp">#define MPC624_OSR3             (1&lt;&lt;30)</span>
<span class="cp">#define MPC624_OSR2             (1&lt;&lt;29)</span>
<span class="cp">#define MPC624_OSR1             (1&lt;&lt;28)</span>
<span class="cp">#define MPC624_OSR0             (1&lt;&lt;27)</span>

<span class="cm">/* 32-bit output value bits&#39; names */</span>
<span class="cp">#define MPC624_EOC_BIT          (1&lt;&lt;31)</span>
<span class="cp">#define MPC624_DMY_BIT          (1&lt;&lt;30)</span>
<span class="cp">#define MPC624_SGN_BIT          (1&lt;&lt;29)</span>

<span class="cm">/* Conversion speeds */</span>
<span class="cm">/* OSR4 OSR3 OSR2 OSR1 OSR0  Conversion rate  RMS noise  ENOB^</span>
<span class="cm"> *  X    0    0    0    1        3.52kHz        23uV      17</span>
<span class="cm"> *  X    0    0    1    0        1.76kHz       3.5uV      20</span>
<span class="cm"> *  X    0    0    1    1         880Hz         2uV      21.3</span>
<span class="cm"> *  X    0    1    0    0         440Hz        1.4uV     21.8</span>
<span class="cm"> *  X    0    1    0    1         220Hz         1uV      22.4</span>
<span class="cm"> *  X    0    1    1    0         110Hz        750uV     22.9</span>
<span class="cm"> *  X    0    1    1    1          55Hz        510nV     23.4</span>
<span class="cm"> *  X    1    0    0    0         27.5Hz       375nV      24</span>
<span class="cm"> *  X    1    0    0    1        13.75Hz       250nV     24.4</span>
<span class="cm"> *  X    1    1    1    1        6.875Hz       200nV     24.6</span>
<span class="cm"> *</span>
<span class="cm"> * ^ - Effective Number Of Bits</span>
<span class="cm"> */</span>

<span class="cp">#define MPC624_SPEED_3_52_kHz (MPC624_OSR4 | MPC624_OSR0)</span>
<span class="cp">#define MPC624_SPEED_1_76_kHz (MPC624_OSR4 | MPC624_OSR1)</span>
<span class="cp">#define MPC624_SPEED_880_Hz   (MPC624_OSR4 | MPC624_OSR1 | MPC624_OSR0)</span>
<span class="cp">#define MPC624_SPEED_440_Hz   (MPC624_OSR4 | MPC624_OSR2)</span>
<span class="cp">#define MPC624_SPEED_220_Hz   (MPC624_OSR4 | MPC624_OSR2 | MPC624_OSR0)</span>
<span class="cp">#define MPC624_SPEED_110_Hz   (MPC624_OSR4 | MPC624_OSR2 | MPC624_OSR1)</span>
<span class="cp">#define MPC624_SPEED_55_Hz \</span>
<span class="cp">	(MPC624_OSR4 | MPC624_OSR2 | MPC624_OSR1 | MPC624_OSR0)</span>
<span class="cp">#define MPC624_SPEED_27_5_Hz  (MPC624_OSR4 | MPC624_OSR3)</span>
<span class="cp">#define MPC624_SPEED_13_75_Hz (MPC624_OSR4 | MPC624_OSR3 | MPC624_OSR0)</span>
<span class="cp">#define MPC624_SPEED_6_875_Hz \</span>
<span class="cp">	(MPC624_OSR4 | MPC624_OSR3 | MPC624_OSR2 | MPC624_OSR1 | MPC624_OSR0)</span>
<span class="cm">/* -------------------------------------------------------------------------- */</span>
<span class="k">struct</span> <span class="n">skel_private</span> <span class="p">{</span>

	<span class="cm">/*  set by mpc624_attach() from driver&#39;s parameters */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">ulConvertionRate</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define devpriv ((struct skel_private *)dev-&gt;private)</span>
<span class="cm">/* -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_mpc624_bipolar1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="p">{</span>
<span class="cm">/* BIP_RANGE(1.01)  this is correct, */</span>
	 <span class="cm">/*  but my MPC-624 actually seems to have a range of 2.02 */</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">2.02</span><span class="p">)</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_mpc624_bipolar10</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="p">{</span>
<span class="cm">/* BIP_RANGE(10.1)   this is correct, */</span>
	 <span class="cm">/*  but my MPC-624 actually seems to have a range of 20.2 */</span>
	 <span class="n">BIP_RANGE</span><span class="p">(</span><span class="mf">20.2</span><span class="p">)</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Timeout 200ms */</span>
<span class="cp">#define TIMEOUT 200</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc624_ai_rinsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">data_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ucPort</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  WARNING:</span>
<span class="cm">	 *  We always write 0 to GNSWA bit, so the channel range is +-/10.1Vdc</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_GNMUXCH</span><span class="p">);</span>
<span class="cm">/* printk(&quot;Channel %d:\n&quot;, insn-&gt;chanspec); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MPC624: Warning, no data to acquire</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Trigger the conversion */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MPC624_ADSCK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MPC624_ADCS</span> <span class="o">|</span> <span class="n">MPC624_ADSCK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*  Wait for the conversion to end */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ucPort</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ucPort</span> <span class="o">&amp;</span> <span class="n">MPC624_ADBUSY</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPC624: timeout (%dms)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TIMEOUT</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  Start reading data */</span>
		<span class="n">data_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data_out</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Set the clock low */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data_out</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/*  the next bit is a 1 */</span>
				<span class="cm">/*  Set the ADSDI line (send to MPC624) */</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">MPC624_ADSDI</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="cm">/*  Set the clock high */</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">MPC624_ADSCK</span> <span class="o">|</span> <span class="n">MPC624_ADSDI</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/*  the next bit is a 0 */</span>

				<span class="cm">/*  Set the ADSDI line (send to MPC624) */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="cm">/*  Set the clock high */</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">MPC624_ADSCK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*  Read ADSDO on high clock (receive from MPC624) */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">data_in</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data_in</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MPC624_ADC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC624_ADSDO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">data_out</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *  Received 32-bit long value consist of:</span>
<span class="cm">		 *    31: EOC -</span>
<span class="cm">		 *          (End Of Transmission) bit - should be 0</span>
<span class="cm">		 *    30: DMY</span>
<span class="cm">		 *          (Dummy) bit - should be 0</span>
<span class="cm">		 *    29: SIG</span>
<span class="cm">		 *          (Sign) bit- 1 if the voltage is positive,</span>
<span class="cm">		 *                      0 if negative</span>
<span class="cm">		 *    28: MSB</span>
<span class="cm">		 *          (Most Significant Bit) - the first bit of</span>
<span class="cm">		 *                                   the conversion result</span>
<span class="cm">		 *    ....</span>
<span class="cm">		 *    05: LSB</span>
<span class="cm">		 *          (Least Significant Bit)- the last bit of the</span>
<span class="cm">		 *                                   conversion result</span>
<span class="cm">		 *    04-00: sub-LSB</span>
<span class="cm">		 *          - sub-LSBs are basically noise, but when</span>
<span class="cm">		 *            averaged properly, they can increase conversion</span>
<span class="cm">		 *            precision up to 29 bits; they can be discarded</span>
<span class="cm">		 *            without loss of resolution.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data_in</span> <span class="o">&amp;</span> <span class="n">MPC624_EOC_BIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MPC624:EOC bit is set (data_in=%lu)!&quot;</span><span class="p">,</span>
			       <span class="n">data_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_in</span> <span class="o">&amp;</span> <span class="n">MPC624_DMY_BIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MPC624:DMY bit is set (data_in=%lu)!&quot;</span><span class="p">,</span>
			       <span class="n">data_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_in</span> <span class="o">&amp;</span> <span class="n">MPC624_SGN_BIT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Volatge is positive */</span>
			<span class="cm">/*</span>
<span class="cm">			 * comedi operates on unsigned numbers, so mask off EOC</span>
<span class="cm">			 * and DMY and don&#39;t clear the SGN bit</span>
<span class="cm">			 */</span>
			<span class="n">data_in</span> <span class="o">&amp;=</span> <span class="mh">0x3FFFFFFF</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_in</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/*  The voltage is negative */</span>
			<span class="cm">/*</span>
<span class="cm">			 * data_in contains a number in 30-bit two&#39;s complement</span>
<span class="cm">			 * code and we must deal with it</span>
<span class="cm">			 */</span>
			<span class="n">data_in</span> <span class="o">|=</span> <span class="n">MPC624_SGN_BIT</span><span class="p">;</span>
			<span class="n">data_in</span> <span class="o">=</span> <span class="o">~</span><span class="n">data_in</span><span class="p">;</span>
			<span class="n">data_in</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data_in</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MPC624_EOC_BIT</span> <span class="o">|</span> <span class="n">MPC624_DMY_BIT</span><span class="p">);</span>
			<span class="cm">/*  clear EOC and DMY bits */</span>
			<span class="n">data_in</span> <span class="o">=</span> <span class="mh">0x20000000</span> <span class="o">-</span> <span class="n">data_in</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_in</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Return the number of samples read/written */</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc624_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi%d: mpc624 [0x%04lx, &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">MPC624_SIZE</span><span class="p">,</span> <span class="s">&quot;mpc624&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;I/O port(s) in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span> <span class="o">=</span> <span class="s">&quot;mpc624&quot;</span><span class="p">;</span>

	<span class="cm">/*  Private structure initialization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">skel_private</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_3_52_kHz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;3.52 kHz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_1_76_kHz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;1.76 kHz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_880_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;880 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_440_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;440 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_220_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;220 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_110_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;110 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_55_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;55 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_27_5_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;27.5 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_13_75_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;13.75 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_6_875_Hz</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;6.875 Hz, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;illegal conversion rate setting!&quot;</span>
			<span class="s">&quot; Valid numbers are 0..9. Using 9 =&gt; 6.875 Hz, &quot;</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ulConvertionRate</span> <span class="o">=</span> <span class="n">MPC624_SPEED_3_52_kHz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Subdevices structures */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_DIFF</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0x3FFFFFFF</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;30 bit, &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_mpc624_bipolar1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;1.01V]: &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_mpc624_bipolar10</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;10.1V]: &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">mpc624_ai_rinsn</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc624_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">MPC624_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_driver</span> <span class="n">mpc624_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;mpc624&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">mpc624_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">mpc624_detach</span>
<span class="p">};</span>
<span class="n">module_comedi_driver</span><span class="p">(</span><span class="n">mpc624_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Comedi http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
