<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › drivers › ni_mio_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ni_mio_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/drivers/ni_mio_common.c</span>
<span class="cm">    Hardware driver for DAQ-STC based boards</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1997-2001 David A. Schleef &lt;ds@schleef.org&gt;</span>
<span class="cm">    Copyright (C) 2002-2006 Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">	This file is meant to be included by another file, e.g.,</span>
<span class="cm">	ni_atmio.c or ni_pcimio.c.</span>

<span class="cm">	Interrupt support originally added by Truxton Fulton</span>
<span class="cm">	&lt;trux@truxton.com&gt;</span>

<span class="cm">	References (from ftp://ftp.natinst.com/support/manuals):</span>

<span class="cm">	   340747b.pdf  AT-MIO E series Register Level Programmer Manual</span>
<span class="cm">	   341079b.pdf  PCI E Series RLPM</span>
<span class="cm">	   340934b.pdf  DAQ-STC reference manual</span>
<span class="cm">	67xx and 611x registers (from ftp://ftp.ni.com/support/daq/mhddk/documentation/)</span>
<span class="cm">	release_ni611x.pdf</span>
<span class="cm">	release_ni67xx.pdf</span>
<span class="cm">	Other possibly relevant info:</span>

<span class="cm">	   320517c.pdf  User manual (obsolete)</span>
<span class="cm">	   320517f.pdf  User manual (new)</span>
<span class="cm">	   320889a.pdf  delete</span>
<span class="cm">	   320906c.pdf  maximum signal ratings</span>
<span class="cm">	   321066a.pdf  about 16x</span>
<span class="cm">	   321791a.pdf  discontinuation of at-mio-16e-10 rev. c</span>
<span class="cm">	   321808a.pdf  about at-mio-16e-10 rev P</span>
<span class="cm">	   321837a.pdf  discontinuation of at-mio-16de-10 rev d</span>
<span class="cm">	   321838a.pdf  about at-mio-16de-10 rev N</span>

<span class="cm">	ISSUES:</span>

<span class="cm">	 - the interrupt routine needs to be cleaned up</span>

<span class="cm">	2006-02-07: S-Series PCI-6143: Support has been added but is not</span>
<span class="cm">		fully tested as yet. Terry Barnaby, BEAM Ltd.</span>
<span class="cm">*/</span>

<span class="cm">/* #define DEBUG_INTERRUPT */</span>
<span class="cm">/* #define DEBUG_STATUS_A */</span>
<span class="cm">/* #define DEBUG_STATUS_B */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &quot;8255.h&quot;</span>
<span class="cp">#include &quot;mite.h&quot;</span>
<span class="cp">#include &quot;comedi_fc.h&quot;</span>

<span class="cp">#ifndef MDPRINTK</span>
<span class="cp">#define MDPRINTK(format, args...)</span>
<span class="cp">#endif</span>

<span class="cm">/* A timeout count */</span>
<span class="cp">#define NI_TIMEOUT 1000</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">old_RTSI_clock_channel</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

<span class="cm">/* Note: this table must match the ai_gain_* definitions */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">ni_gainlkup</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ai_gain_16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
			<span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">,</span> <span class="mh">0x102</span><span class="p">,</span> <span class="mh">0x103</span><span class="p">,</span> <span class="mh">0x104</span><span class="p">,</span> <span class="mh">0x105</span><span class="p">,</span> <span class="mh">0x106</span><span class="p">,</span> <span class="mh">0x107</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">,</span> <span class="mh">0x102</span><span class="p">,</span> <span class="mh">0x104</span><span class="p">,</span> <span class="mh">0x107</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
			<span class="mh">0x101</span><span class="p">,</span> <span class="mh">0x102</span><span class="p">,</span> <span class="mh">0x103</span><span class="p">,</span> <span class="mh">0x104</span><span class="p">,</span> <span class="mh">0x105</span><span class="p">,</span> <span class="mh">0x106</span><span class="p">,</span> <span class="mh">0x107</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_611x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00a</span><span class="p">,</span> <span class="mh">0x00b</span><span class="p">,</span> <span class="mh">0x001</span><span class="p">,</span> <span class="mh">0x002</span><span class="p">,</span>
			  <span class="mh">0x003</span><span class="p">,</span> <span class="mh">0x004</span><span class="p">,</span> <span class="mh">0x005</span><span class="p">,</span> <span class="mh">0x006</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_622x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_628x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ai_gain_6143</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_E_ai</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="p">{</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
							 <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
							 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_E_ai_limited</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
								      <span class="mf">0.1</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
								<span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
								<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_E_ai_limited14</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">14</span><span class="p">,</span> <span class="p">{</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span>
									 <span class="mi">10</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
									 <span class="mf">0.5</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span>
									 <span class="mf">0.2</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
									 <span class="mf">0.1</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
									 <span class="mf">0.5</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
									 <span class="mf">0.2</span><span class="p">),</span>
								   <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
									 <span class="mf">0.1</span><span class="p">),</span>
								   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_E_ai_bipolar4</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
								       <span class="mf">0.5</span><span class="p">),</span>
								 <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span>
								       <span class="mf">0.05</span><span class="p">),</span>
								 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_E_ai_611x</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_M_ai_622x</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_M_ai_628x</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_S_ai_6143</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
							     <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">+</span><span class="mi">5</span><span class="p">),</span>
							     <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="n">range_ni_E_ao_ext</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
							    <span class="n">RANGE</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							    <span class="n">RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
							    <span class="n">RANGE_ext</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							    <span class="n">RANGE_ext</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_lrange</span> <span class="o">*</span><span class="k">const</span> <span class="n">ni_range_lkup</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ai_gain_16</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_E_ai</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_8</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_E_ai_limited</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_14</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_E_ai_limited14</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_4</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_E_ai_bipolar4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_611x</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_E_ai_611x</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_622x</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_M_ai_622x</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_628x</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_M_ai_628x</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ai_gain_6143</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_ni_S_ai_6143</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_dio_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_dio_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_cdio_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_cdio_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_cdio_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_cdio_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_cdo_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_serial_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_serial_hw_readwrite8</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_out</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data_in</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_serial_sw_readwrite8</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_out</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data_in</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_calib_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_calib_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_eeprom_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_m_series_eeprom_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pfi_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pfi_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ni_old_get_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_rtsi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_rtsi_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_rtsi_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">caldac_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_STATUS_A</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_mio_print_status_a</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define ni_mio_print_status_a(a)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG_STATUS_B</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_mio_print_status_b</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define ni_mio_print_status_b(a)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ai_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="cp">#ifndef PCIDMA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_handle_fifo_half_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ao_fifo_half_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_handle_fifo_dregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ai_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_load_channelgain_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">shutdown_ai_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ao_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ao_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_8255_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_gpct_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">counter_index</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_cs5529</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cs5529_do_conversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cs5529_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#ifdef NI_CS5529_DEBUG</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs5529_config_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_select_bits</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cs5529_config_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_select_bits</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_m_series_pwm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_6143_pwm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_set_master_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">source</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">period_ns</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ack_a_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">a_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ack_b_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">b_status</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">aimodes</span> <span class="p">{</span>
	<span class="n">AIMODE_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">AIMODE_HALF_FULL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">AIMODE_SCAN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">AIMODE_SAMPLE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ni_common_subdevices</span> <span class="p">{</span>
	<span class="n">NI_AI_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_AO_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_DIO_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_8255_DIO_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_UNUSED_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_CALIBRATION_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_EEPROM_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_PFI_DIO_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_CS5529_CALIBRATION_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_SERIAL_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_RTSI_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_GPCT0_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_GPCT1_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_FREQ_OUT_SUBDEV</span><span class="p">,</span>
	<span class="n">NI_NUM_SUBDEVICES</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">NI_GPCT_SUBDEV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">counter_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">counter_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">NI_GPCT0_SUBDEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">NI_GPCT1_SUBDEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">NI_GPCT0_SUBDEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">timebase_nanoseconds</span> <span class="p">{</span>
	<span class="n">TIMEBASE_1_NS</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="n">TIMEBASE_2_NS</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="p">};</span>

<span class="cp">#define SERIAL_DISABLED		0</span>
<span class="cp">#define SERIAL_600NS		600</span>
<span class="cp">#define SERIAL_1_2US		1200</span>
<span class="cp">#define SERIAL_10US			10000</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_adc_stages_611x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_a_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">ai_mite_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_b_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">ao_mite_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_last_sample_611x</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_last_sample_6143</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_set_bitfield</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="n">bit_mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bit_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">soft_reg_copy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Interrupt_A_Enable_Register</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_a_enable_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_a_enable_reg</span> <span class="o">|=</span> <span class="n">bit_values</span> <span class="o">&amp;</span> <span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_a_enable_reg</span><span class="p">,</span>
				    <span class="n">Interrupt_A_Enable_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Interrupt_B_Enable_Register</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_b_enable_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_b_enable_reg</span> <span class="o">|=</span> <span class="n">bit_values</span> <span class="o">&amp;</span> <span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_b_enable_reg</span><span class="p">,</span>
				    <span class="n">Interrupt_B_Enable_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_Bidirection_Pin_Register</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_bidirection_pin_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_bidirection_pin_reg</span> <span class="o">|=</span> <span class="n">bit_values</span> <span class="o">&amp;</span> <span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_bidirection_pin_reg</span><span class="p">,</span>
				    <span class="n">IO_Bidirection_Pin_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AI_AO_Select</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_ao_select_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_ao_select_reg</span> <span class="o">|=</span> <span class="n">bit_values</span> <span class="o">&amp;</span> <span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_ao_select_reg</span><span class="p">,</span> <span class="n">AI_AO_Select</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">G0_G1_Select</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">g0_g1_select_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">g0_g1_select_reg</span> <span class="o">|=</span> <span class="n">bit_values</span> <span class="o">&amp;</span> <span class="n">bit_mask</span><span class="p">;</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">g0_g1_select_reg</span><span class="p">,</span> <span class="n">G0_G1_Select</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Warning %s() called with invalid register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;reg is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">soft_reg_copy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef PCIDMA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ai_drain_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* DMA channel setup */</span>

<span class="cm">/* negative channel means no channel */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_set_ai_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bitfield</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitfield</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">ni_stc_dma_channel_select_bitfield</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">AI_DMA_Select_Shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AI_DMA_Select_Mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bitfield</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_set_bitfield</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_AO_Select</span><span class="p">,</span> <span class="n">AI_DMA_Select_Mask</span><span class="p">,</span> <span class="n">bitfield</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* negative channel means no channel */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_set_ao_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bitfield</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitfield</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">ni_stc_dma_channel_select_bitfield</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">AO_DMA_Select_Shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AO_DMA_Select_Mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bitfield</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_set_bitfield</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_AO_Select</span><span class="p">,</span> <span class="n">AO_DMA_Select_Mask</span><span class="p">,</span> <span class="n">bitfield</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* negative mite_channel means no channel */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_set_gpct_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="n">gpct_index</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">mite_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bitfield</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mite_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitfield</span> <span class="o">=</span> <span class="n">GPCT_DMA_Select_Bits</span><span class="p">(</span><span class="n">gpct_index</span><span class="p">,</span> <span class="n">mite_channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bitfield</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_set_bitfield</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">G0_G1_Select</span><span class="p">,</span> <span class="n">GPCT_DMA_Select_Mask</span><span class="p">(</span><span class="n">gpct_index</span><span class="p">),</span>
			<span class="n">bitfield</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* negative mite_channel means no channel */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_set_cdo_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">mite_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">soft_reg_copy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdio_dma_select_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDO_DMA_Select_Mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mite_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*XXX just guessing ni_stc_dma_channel_select_bitfield() returns the right bits,</span>
<span class="cm">		   under the assumption the cdio dma selection works just like ai/ao/gpct.</span>
<span class="cm">		   Definitely works for dma channels 0 and 1. */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdio_dma_select_reg</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">ni_stc_dma_channel_select_bitfield</span><span class="p">(</span><span class="n">mite_channel</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">CDO_DMA_Select_Shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CDO_DMA_Select_Mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdio_dma_select_reg</span><span class="p">,</span> <span class="n">M_Offset_CDIO_DMA_Select</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">soft_reg_copy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_request_ai_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span> <span class="o">=</span>
	    <span class="n">mite_request_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;failed to reserve mite dma channel for analog input.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">COMEDI_INPUT</span><span class="p">;</span>
	<span class="n">ni_set_ai_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_request_ao_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span> <span class="o">=</span>
	    <span class="n">mite_request_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;failed to reserve mite dma channel for analog outut.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">COMEDI_OUTPUT</span><span class="p">;</span>
	<span class="n">ni_set_ao_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_request_gpct_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="n">gpct_index</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">comedi_io_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mite_channel</span> <span class="o">*</span><span class="n">mite_chan</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gpct_index</span> <span class="o">&gt;=</span> <span class="n">NUM_GPCT</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">gpct_index</span><span class="p">].</span><span class="n">mite_chan</span><span class="p">);</span>
	<span class="n">mite_chan</span> <span class="o">=</span>
	    <span class="n">mite_request_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">,</span>
				 <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">gpct_mite_ring</span><span class="p">[</span><span class="n">gpct_index</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mite_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;failed to reserve mite dma channel for counter.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mite_chan</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="n">ni_tio_set_mite_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">gpct_index</span><span class="p">],</span>
				<span class="n">mite_chan</span><span class="p">);</span>
	<span class="n">ni_set_gpct_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gpct_index</span><span class="p">,</span> <span class="n">mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_request_cdo_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span> <span class="o">=</span>
	    <span class="n">mite_request_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;failed to reserve mite dma channel for correlated digital outut.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">COMEDI_OUTPUT</span><span class="p">;</span>
	<span class="n">ni_set_cdo_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_release_ai_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_set_ai_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mite_release_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_release_ao_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_set_ao_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mite_release_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ni_release_gpct_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">gpct_index</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gpct_index</span> <span class="o">&gt;=</span> <span class="n">NUM_GPCT</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">gpct_index</span><span class="p">].</span><span class="n">mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mite_channel</span> <span class="o">*</span><span class="n">mite_chan</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">gpct_index</span><span class="p">].</span><span class="n">mite_chan</span><span class="p">;</span>

		<span class="n">ni_set_gpct_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gpct_index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ni_tio_set_mite_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span>
					<span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">gpct_index</span><span class="p">],</span>
					<span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mite_release_channel</span><span class="p">(</span><span class="n">mite_chan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_release_cdo_mite_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_set_cdo_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mite_release_channel</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/* e-series boards use the second irq signals to generate dma requests for their counters */</span>
<span class="cp">#ifdef PCIDMA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_e_series_enable_second_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="n">gpct_index</span><span class="p">,</span> <span class="kt">short</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">gpct_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">G0_Gate_Second_Irq_Enable</span><span class="p">,</span>
					    <span class="n">Second_IRQ_A_Enable_Register</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">Second_IRQ_A_Enable_Register</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">G1_Gate_Second_Irq_Enable</span><span class="p">,</span>
					    <span class="n">Second_IRQ_B_Enable_Register</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">Second_IRQ_B_Enable_Register</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_clear_ai_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Flush the 6143 data FIFO */</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">AIFIFO_Control_6143</span><span class="p">);</span>	<span class="cm">/*  Flush fifo */</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">AIFIFO_Control_6143</span><span class="p">);</span>	<span class="cm">/*  Flush fifo */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Status_6143</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/*  Wait for complete */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADC_FIFO_Clear</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_625x</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M_Offset_Static_AI_Control</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">M_Offset_Static_AI_Control</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			/* the NI example code does 3 convert pulses for 625x boards,</span>
<span class="c">			   but that appears to be wrong in practice. */</span>
<span class="c">			devpriv-&gt;stc_writew(dev, AI_CONVERT_Pulse,</span>
<span class="c">					    AI_Command_1_Register);</span>
<span class="c">			devpriv-&gt;stc_writew(dev, AI_CONVERT_Pulse,</span>
<span class="c">					    AI_Command_1_Register);</span>
<span class="c">			devpriv-&gt;stc_writew(dev, AI_CONVERT_Pulse,</span>
<span class="c">					    AI_Command_1_Register);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">win_out2</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">win_in2</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ao_win_out(data, addr) ni_ao_win_outw(dev, data, addr)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_ao_win_outw</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">data</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">AO_Window_Address_611x</span><span class="p">);</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">AO_Window_Data_611x</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_ao_win_outl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">AO_Window_Address_611x</span><span class="p">);</span>
	<span class="n">ni_writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">AO_Window_Data_611x</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">ni_ao_win_inw</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">AO_Window_Address_611x</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ni_readw</span><span class="p">(</span><span class="n">AO_Window_Data_611x</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ni_set_bits( ) allows different parts of the ni_mio_common driver to</span>
<span class="cm">* share registers (such as Interrupt_A_Register) without interfering with</span>
<span class="cm">* each other.</span>
<span class="cm">*</span>
<span class="cm">* NOTE: the switch/case statements are optimized out for a constant argument</span>
<span class="cm">* so this is actually quite fast---  If you must wrap another function around this</span>
<span class="cm">* make it inline to avoid a large speed penalty.</span>
<span class="cm">*</span>
<span class="cm">* value should only be 1 or 0.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ni_set_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bit_values</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">bit_values</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bit_values</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ni_set_bitfield</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">bit_values</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ni_E_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">a_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">b_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ai_mite_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ao_mite_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">struct</span> <span class="n">mite_struct</span> <span class="o">*</span><span class="n">mite</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">smp_mb</span><span class="p">();</span>		<span class="cm">/*  make sure dev-&gt;attached is checked before handler does anything else. */</span>

	<span class="cm">/*  lock to avoid race with comedi_poll */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">a_status</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Status_1_Register</span><span class="p">);</span>
	<span class="n">b_status</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Status_1_Register</span><span class="p">);</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mite</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags_too</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags_too</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai_mite_status</span> <span class="o">=</span> <span class="n">mite_get_status</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_LINKC</span><span class="p">)</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">CHOR_CLRLC</span><span class="p">,</span>
				       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">mite_io_addr</span> <span class="o">+</span>
				       <span class="n">MITE_CHOR</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
						 <span class="n">ai_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ao_mite_status</span> <span class="o">=</span> <span class="n">mite_get_status</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ao_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_LINKC</span><span class="p">)</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">CHOR_CLRLC</span><span class="p">,</span>
				       <span class="n">mite</span><span class="o">-&gt;</span><span class="n">mite_io_addr</span> <span class="o">+</span>
				       <span class="n">MITE_CHOR</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
						 <span class="n">ao_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags_too</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ack_a_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">a_status</span><span class="p">);</span>
	<span class="n">ack_b_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">Interrupt_A_St</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ai_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_INT</span><span class="p">))</span>
		<span class="n">handle_a_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">a_status</span><span class="p">,</span> <span class="n">ai_mite_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">Interrupt_B_St</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ao_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_INT</span><span class="p">))</span>
		<span class="n">handle_b_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b_status</span><span class="p">,</span> <span class="n">ao_mite_status</span><span class="p">);</span>
	<span class="n">handle_gpct_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">handle_gpct_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">handle_cdio_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef PCIDMA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_sync_ai_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">)</span>
		<span class="n">mite_sync_input_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mite_handle_b_linkc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mite_struct</span> <span class="o">*</span><span class="n">mite</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AO_SUBDEV</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mite_sync_output_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_wait_for_dma_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">b_status</span><span class="p">;</span>

		<span class="n">b_status</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Status_1_Register</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_FIFO_Half_Full_St</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* if we poll too often, the pci bus activity seems</span>
<span class="cm">		   to slow the dma transfer down */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timed out waiting for dma load&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* PCIDMA */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_handle_eos</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">aimode</span> <span class="o">==</span> <span class="n">AIMODE_SCAN</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_sync_ai_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">COMEDI_CB_EOS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">ni_handle_fifo_dregs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOS</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="cm">/* handle special case of single scan using AI_End_On_End_Of_Scan */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_cmd2</span> <span class="o">&amp;</span> <span class="n">AI_End_On_End_Of_Scan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shutdown_ai_command</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown_ai_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>

<span class="cp">#ifdef PCIDMA</span>
	<span class="n">ni_ai_drain_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ni_handle_fifo_dregs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">get_last_sample_611x</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">get_last_sample_6143</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span>
	    <span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_OVERFLOW</span> <span class="o">|</span>
			     <span class="n">COMEDI_CB_EOA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NI_AI_SUBDEV</span>:
			<span class="n">ni_ai_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NI_AO_SUBDEV</span>:
			<span class="n">ni_ao_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NI_GPCT0_SUBDEV</span>:
		<span class="k">case</span> <span class="n">NI_GPCT1_SUBDEV</span>:
			<span class="n">ni_gpct_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NI_DIO_SUBDEV</span>:
			<span class="n">ni_cdio_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">comedi_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_gpct_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">counter_index</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_GPCT_SUBDEV</span><span class="p">(</span><span class="n">counter_index</span><span class="p">);</span>

	<span class="n">ni_tio_handle_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">counter_index</span><span class="p">],</span>
				<span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="n">ni_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ack_a_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">a_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">AI_SC_TC_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AI_SC_TC_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">AI_START1_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AI_START1_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">AI_START_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AI_START_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">AI_STOP_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not sure why we used to ack the START here also, instead of doing it independently. Frank Hess 2007-07-06 */</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AI_STOP_Interrupt_Ack</span> <span class="cm">/*| AI_START_Interrupt_Ack */</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">Interrupt_A_Ack_Register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_a_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">ai_mite_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>

	<span class="cm">/* 67xx boards don&#39;t have ai subdevice, but their gpct0 might generate an a interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_INTERRUPT</span>
	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;ni_mio_common: interrupt: a_status=%04x ai_mite_status=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">status</span><span class="p">,</span> <span class="n">ai_mite_status</span><span class="p">);</span>
	<span class="n">ni_mio_print_status_a</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_LINKC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_sync_ai_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai_mite_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CHSR_INT</span> <span class="o">|</span> <span class="n">CHSR_LINKC</span> <span class="o">|</span> <span class="n">CHSR_DONE</span> <span class="o">|</span> <span class="n">CHSR_MRDY</span> <span class="o">|</span>
			       <span class="n">CHSR_DRDY</span> <span class="o">|</span> <span class="n">CHSR_DRQ1</span> <span class="o">|</span> <span class="n">CHSR_DRQ0</span> <span class="o">|</span> <span class="n">CHSR_ERROR</span> <span class="o">|</span>
			       <span class="n">CHSR_SABORT</span> <span class="o">|</span> <span class="n">CHSR_XFERR</span> <span class="o">|</span> <span class="n">CHSR_LxERR_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;unknown mite interrupt, ack! (ai_mite_status=%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ai_mite_status</span><span class="p">);</span>
		<span class="cm">/* mite_print_chsr(ai_mite_status); */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
		<span class="cm">/* disable_irq(dev-&gt;irq); */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* test for all uncommon interrupt events at the same time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AI_Overrun_St</span> <span class="o">|</span> <span class="n">AI_Overflow_St</span> <span class="o">|</span> <span class="n">AI_SC_TC_Error_St</span> <span class="o">|</span>
		      <span class="n">AI_SC_TC_St</span> <span class="o">|</span> <span class="n">AI_START1_St</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;ni_mio_common: a_status=0xffff.  Card removed?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* we probably aren&#39;t even running a command now,</span>
<span class="cm">			 * so it&#39;s a good idea to be careful. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_RUNNING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span>
				    <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
				<span class="n">ni_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AI_Overrun_St</span> <span class="o">|</span> <span class="n">AI_Overflow_St</span> <span class="o">|</span>
			      <span class="n">AI_SC_TC_Error_St</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_mio_common: ai error a_status=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">status</span><span class="p">);</span>
			<span class="n">ni_mio_print_status_a</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

			<span class="n">shutdown_ai_command</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AI_Overrun_St</span> <span class="o">|</span> <span class="n">AI_Overflow_St</span><span class="p">))</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>

			<span class="n">ni_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AI_SC_TC_St</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_INTERRUPT</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_mio_common: SC_TC interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_continuous</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">shutdown_ai_command</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifndef PCIDMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AI_FIFO_Half_Full_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="cm">/* pcmcia cards (at least 6036) seem to stop producing interrupts if we</span>
<span class="cm">		 *fail to get the fifo less than half full, so loop to be sure.*/</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_handle_fifo_half_full</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">AI_FIFO_Half_Full_St</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/*  !PCIDMA */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AI_STOP_St</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ni_handle_eos</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ni_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_INTERRUPT</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Status_1_Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Interrupt_A_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;handle_a_interrupt: didn&#39;t clear interrupt? status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ack_b_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">b_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_BC_TC_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_BC_TC_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_Overrun_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_Error_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_START_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_START_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_START1_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_START1_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_UC_TC_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_UC_TC_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_UI2_TC_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_UI2_TC_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_UPDATE_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">AO_UPDATE_Interrupt_Ack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">Interrupt_B_Ack_Register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_b_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">b_status</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ao_mite_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AO_SUBDEV</span><span class="p">;</span>
	<span class="cm">/* unsigned short ack=0; */</span>
<span class="cp">#ifdef DEBUG_INTERRUPT</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_mio_common: interrupt: b_status=%04x m1_status=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">b_status</span><span class="p">,</span> <span class="n">ao_mite_status</span><span class="p">);</span>
	<span class="n">ni_mio_print_status_b</span><span class="p">(</span><span class="n">b_status</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef PCIDMA</span>
	<span class="cm">/* Currently, mite.c requires us to handle LINKC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ao_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_LINKC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mite_handle_b_linkc</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ao_mite_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CHSR_INT</span> <span class="o">|</span> <span class="n">CHSR_LINKC</span> <span class="o">|</span> <span class="n">CHSR_DONE</span> <span class="o">|</span> <span class="n">CHSR_MRDY</span> <span class="o">|</span>
			       <span class="n">CHSR_DRDY</span> <span class="o">|</span> <span class="n">CHSR_DRQ1</span> <span class="o">|</span> <span class="n">CHSR_DRQ0</span> <span class="o">|</span> <span class="n">CHSR_ERROR</span> <span class="o">|</span>
			       <span class="n">CHSR_SABORT</span> <span class="o">|</span> <span class="n">CHSR_XFERR</span> <span class="o">|</span> <span class="n">CHSR_LxERR_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;unknown mite interrupt, ack! (ao_mite_status=%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ao_mite_status</span><span class="p">);</span>
		<span class="cm">/* mite_print_chsr(ao_mite_status); */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_Overrun_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;ni_mio_common: AO FIFO underrun status=0x%04x status2=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">b_status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Status_2_Register</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_BC_TC_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MDPRINTK</span>
		    <span class="p">(</span><span class="s">&quot;ni_mio_common: AO BC_TC status=0x%04x status2=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">b_status</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Status_2_Register</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOA</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifndef PCIDMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_status</span> <span class="o">&amp;</span> <span class="n">AO_FIFO_Request_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ni_ao_fifo_half_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_mio_common: AO buffer underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">,</span>
				    <span class="n">AO_FIFO_Interrupt_Enable</span> <span class="o">|</span>
				    <span class="n">AO_Error_Interrupt_Enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ni_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG_STATUS_A</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">status_a_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;passthru0&quot;</span><span class="p">,</span> <span class="s">&quot;fifo&quot;</span><span class="p">,</span> <span class="s">&quot;G0_gate&quot;</span><span class="p">,</span> <span class="s">&quot;G0_TC&quot;</span><span class="p">,</span>
	<span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">,</span> <span class="s">&quot;sc_tc&quot;</span><span class="p">,</span> <span class="s">&quot;start1&quot;</span><span class="p">,</span>
	<span class="s">&quot;start2&quot;</span><span class="p">,</span> <span class="s">&quot;sc_tc_error&quot;</span><span class="p">,</span> <span class="s">&quot;overflow&quot;</span><span class="p">,</span> <span class="s">&quot;overrun&quot;</span><span class="p">,</span>
	<span class="s">&quot;fifo_empty&quot;</span><span class="p">,</span> <span class="s">&quot;fifo_half_full&quot;</span><span class="p">,</span> <span class="s">&quot;fifo_full&quot;</span><span class="p">,</span> <span class="s">&quot;interrupt_a&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_mio_print_status_a</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;A status:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">status_a_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG_STATUS_B</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">status_b_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;passthru1&quot;</span><span class="p">,</span> <span class="s">&quot;fifo&quot;</span><span class="p">,</span> <span class="s">&quot;G1_gate&quot;</span><span class="p">,</span> <span class="s">&quot;G1_TC&quot;</span><span class="p">,</span>
	<span class="s">&quot;UI2_TC&quot;</span><span class="p">,</span> <span class="s">&quot;UPDATE&quot;</span><span class="p">,</span> <span class="s">&quot;UC_TC&quot;</span><span class="p">,</span> <span class="s">&quot;BC_TC&quot;</span><span class="p">,</span>
	<span class="s">&quot;start1&quot;</span><span class="p">,</span> <span class="s">&quot;overrun&quot;</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">,</span> <span class="s">&quot;bc_tc_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;fifo_empty&quot;</span><span class="p">,</span> <span class="s">&quot;fifo_half_full&quot;</span><span class="p">,</span> <span class="s">&quot;fifo_full&quot;</span><span class="p">,</span> <span class="s">&quot;interrupt_b&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_mio_print_status_b</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;B status:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">status_b_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PCIDMA</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_ao_fifo_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">packed_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">&amp;=</span> <span class="n">comedi_buf_get</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packed_data</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="cm">/* 6711 only has 16 bit wide ao fifo */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6711</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">&amp;=</span> <span class="n">comedi_buf_get</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">++</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="n">packed_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ni_writel</span><span class="p">(</span><span class="n">packed_data</span><span class="p">,</span> <span class="n">DAC_FIFO_Data_611x</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">DAC_FIFO_Data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">chan</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chan</span> <span class="o">%=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">cur_chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  There&#39;s a small problem if the FIFO gets really low and we</span>
<span class="cm"> *  don&#39;t have the data to fill it.  Basically, if after we fill</span>
<span class="cm"> *  the FIFO with all the data available, the FIFO is _still_</span>
<span class="cm"> *  less than half full, we never clear the interrupt.  If the</span>
<span class="cm"> *  IRQ is in edge mode, we never get another interrupt, because</span>
<span class="cm"> *  this one wasn&#39;t cleared.  If in level mode, we get flooded</span>
<span class="cm"> *  with interrupts that we can&#39;t fulfill, because nothing ever</span>
<span class="cm"> *  gets put into the buffer.</span>
<span class="cm"> *</span>
<span class="cm"> *  This kind of situation is recoverable, but it is easier to</span>
<span class="cm"> *  just pretend we had a FIFO underrun, since there is a good</span>
<span class="cm"> *  chance it will happen anyway.  This is _not_ the case for</span>
<span class="cm"> *  RT code, as RT code might purposely be running close to the</span>
<span class="cm"> *  metal.  Needs to be fixed eventually.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_fifo_half_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">comedi_buf_read_n_available</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ni_ao_fifo_load</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_BLOCK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_prep_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/* reset fifo */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DAC_FIFO_Clear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span>
		<span class="n">ni_ao_win_outl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="n">AO_FIFO_Offset_Load_611x</span><span class="p">);</span>

	<span class="cm">/* load some data */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">comedi_buf_read_n_available</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span><span class="p">;</span>

	<span class="n">ni_ao_fifo_load</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_ai_fifo_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">dl</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">ADC_FIFO_Data_611x</span><span class="p">);</span>
			<span class="cm">/* This may get the hi/lo data in the wrong order */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Check if there&#39;s a single sample stuck in the FIFO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">ADC_FIFO_Data_611x</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">dl</span><span class="p">;</span>

		<span class="cm">/*  This just reads the FIFO assuming the data is present, no checks on the FIFO status are performed */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Data_6143</span><span class="p">);</span>

			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Assume there is a single sample stuck in the FIFO */</span>
			<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">AIFIFO_Control_6143</span><span class="p">);</span>	<span class="cm">/*  Get stranded sample into FIFO */</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Data_6143</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">)</span> <span class="o">/</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bug! ai_fifo_buffer too small&quot;</span><span class="p">);</span>
			<span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_ERROR</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">ni_readw</span><span class="p">(</span><span class="n">ADC_FIFO_Data_Register</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">,</span>
					  <span class="n">n</span> <span class="o">*</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_handle_fifo_half_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ai_fifo_depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ni_ai_fifo_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef PCIDMA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_drain_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">AI_FIFO_Empty_St</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">mite_bytes_in_transit</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">)</span> <span class="o">==</span>
			    <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_mio_common: wait for dma drain timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;mite_bytes_in_transit=%i, AI_Status1_Register=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">mite_bytes_in_transit</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">),</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Status_1_Register</span><span class="p">));</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ni_sync_ai_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm">   Empties the AI fifo</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_handle_fifo_dregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dl</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">fifo_empty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">AI_FIFO_Empty_St</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">ADC_FIFO_Data_611x</span><span class="p">);</span>

			<span class="cm">/* This may get the hi/lo data in the wrong order */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Status_6143</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Data_6143</span><span class="p">);</span>

			<span class="cm">/* This may get the hi/lo data in the wrong order */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  Check if stranded sample is present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Status_6143</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">AIFIFO_Control_6143</span><span class="p">);</span>	<span class="cm">/*  Get stranded sample into FIFO */</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Data_6143</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fifo_empty</span> <span class="o">=</span>
		    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AI_FIFO_Empty_St</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fifo_empty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">&lt;</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">)</span> <span class="o">/</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fifo_empty</span> <span class="o">=</span>
				    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">AI_FIFO_Empty_St</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo_empty</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">ni_readw</span><span class="p">(</span><span class="n">ADC_FIFO_Data_Register</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cfc_write_array_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_fifo_buffer</span><span class="p">,</span>
						  <span class="n">i</span> <span class="o">*</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							 <span class="n">ai_fifo_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_last_sample_611x</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check if there&#39;s a single sample stuck in the FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ni_readb</span><span class="p">(</span><span class="n">XXX_Status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">ADC_FIFO_Data_611x</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_last_sample_6143</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check if there&#39;s a single sample stuck in the FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Status_6143</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">AIFIFO_Control_6143</span><span class="p">);</span>	<span class="cm">/*  Get stranded sample into FIFO */</span>
		<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Data_6143</span><span class="p">);</span>

		<span class="cm">/* This may get the hi/lo data in the wrong order */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">cfc_write_to_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_ai_munge</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="n">bytes_per_sample</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">larray</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_LSAMPL</span><span class="p">)</span>
			<span class="n">larray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">larray</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_LSAMPL</span><span class="p">)</span>
			<span class="n">larray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_offset</span><span class="p">[</span><span class="n">chan_index</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_offset</span><span class="p">[</span><span class="n">chan_index</span><span class="p">];</span>
		<span class="n">chan_index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chan_index</span> <span class="o">%=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef PCIDMA</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_setup_MITE_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_request_ai_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cm">/* printk(&quot;comedi_debug: using mite channel %i for ai.\n&quot;, devpriv-&gt;ai_mite_chan-&gt;channel); */</span>

	<span class="cm">/* write alloc the entire buffer */</span>
	<span class="n">comedi_buf_write_alloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ni_reg_611x</span>:
	<span class="k">case</span> <span class="n">ni_reg_6143</span>:
		<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ni_reg_628x</span>:
		<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*start the MITE */</span>
	<span class="n">mite_dma_arm</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_mite_chan</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_setup_MITE_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AO_SUBDEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_request_ao_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* read alloc the entire buffer */</span>
	<span class="n">comedi_buf_read_alloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ni_reg_611x</span> <span class="o">|</span> <span class="n">ni_reg_6713</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* doing 32 instead of 16 bit wide transfers from memory</span>
<span class="cm">			   makes the mite do 32 bit pci transfers, doubling pci bandwidth. */</span>
			<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mite_dma_arm</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mite_chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/*  PCIDMA */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">   used for both cancel ioctl and board initialization</span>

<span class="cm">   this is pretty harsh for a cancel, but it works...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ni_release_ai_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* ai configuration */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Configuration_Start</span> <span class="o">|</span> <span class="n">AI_Reset</span><span class="p">,</span>
			    <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_A_Enable_Register</span><span class="p">,</span>
		    <span class="n">AI_SC_TC_Interrupt_Enable</span> <span class="o">|</span> <span class="n">AI_START1_Interrupt_Enable</span> <span class="o">|</span>
		    <span class="n">AI_START2_Interrupt_Enable</span> <span class="o">|</span> <span class="n">AI_START_Interrupt_Enable</span> <span class="o">|</span>
		    <span class="n">AI_STOP_Interrupt_Enable</span> <span class="o">|</span> <span class="n">AI_Error_Interrupt_Enable</span> <span class="o">|</span>
		    <span class="n">AI_FIFO_Interrupt_Enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ni_clear_ai_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">)</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Misc_Command</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Disarm</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>	<span class="cm">/* reset pulses */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="n">AI_Start_Stop</span> <span class="o">|</span> <span class="n">AI_Mode_1_Reserved</span>
			    <span class="cm">/*| AI_Trigger_Once */</span> <span class="p">,</span>
			    <span class="n">AI_Mode_1_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">AI_Mode_2_Register</span><span class="p">);</span>
	<span class="cm">/* generate FIFO interrupts on non-empty */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">AI_Mode_3_Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SHIFTIN_Pulse_Width</span> <span class="o">|</span>
				    <span class="n">AI_SOC_Polarity</span> <span class="o">|</span>
				    <span class="n">AI_LOCALMUX_CLK_Pulse_Width</span><span class="p">,</span>
				    <span class="n">AI_Personal_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">AI_SCAN_IN_PROG_Output_Select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_EXTMUX_CLK_Output_Select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_LOCALMUX_CLK_Output_Select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_SC_TC_Output_Select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_CONVERT_Output_Select</span>
				    <span class="p">(</span><span class="n">AI_CONVERT_Output_Enable_High</span><span class="p">),</span>
				    <span class="n">AI_Output_Control_Register</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SHIFTIN_Pulse_Width</span> <span class="o">|</span>
				    <span class="n">AI_SOC_Polarity</span> <span class="o">|</span>
				    <span class="n">AI_LOCALMUX_CLK_Pulse_Width</span><span class="p">,</span>
				    <span class="n">AI_Personal_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">AI_SCAN_IN_PROG_Output_Select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_EXTMUX_CLK_Output_Select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_LOCALMUX_CLK_Output_Select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_SC_TC_Output_Select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_CONVERT_Output_Select</span>
				    <span class="p">(</span><span class="n">AI_CONVERT_Output_Enable_Low</span><span class="p">),</span>
				    <span class="n">AI_Output_Control_Register</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">ai_output_control_bits</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SHIFTIN_Pulse_Width</span> <span class="o">|</span>
				    <span class="n">AI_SOC_Polarity</span> <span class="o">|</span>
				    <span class="n">AI_CONVERT_Pulse_Width</span> <span class="o">|</span>
				    <span class="n">AI_LOCALMUX_CLK_Pulse_Width</span><span class="p">,</span>
				    <span class="n">AI_Personal_Register</span><span class="p">);</span>
		<span class="n">ai_output_control_bits</span> <span class="o">=</span>
		    <span class="n">AI_SCAN_IN_PROG_Output_Select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">AI_EXTMUX_CLK_Output_Select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">AI_LOCALMUX_CLK_Output_Select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">AI_SC_TC_Output_Select</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_622x</span><span class="p">)</span>
			<span class="n">ai_output_control_bits</span> <span class="o">|=</span>
			    <span class="n">AI_CONVERT_Output_Select</span>
			    <span class="p">(</span><span class="n">AI_CONVERT_Output_Enable_High</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ai_output_control_bits</span> <span class="o">|=</span>
			    <span class="n">AI_CONVERT_Output_Select</span>
			    <span class="p">(</span><span class="n">AI_CONVERT_Output_Enable_Low</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ai_output_control_bits</span><span class="p">,</span>
				    <span class="n">AI_Output_Control_Register</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* the following registers should not be changed, because there</span>
<span class="cm">	 * are no backup registers in devpriv.  If you want to change</span>
<span class="cm">	 * any of these, add a backup register and other appropriate code:</span>
<span class="cm">	 *      AI_Mode_1_Register</span>
<span class="cm">	 *      AI_Mode_3_Register</span>
<span class="cm">	 *      AI_Personal_Register</span>
<span class="cm">	 *      AI_Output_Control_Register</span>
<span class="cm">	 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SC_TC_Error_Confirm</span> <span class="o">|</span> <span class="n">AI_START_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_START2_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_START1_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_SC_TC_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_Error_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_STOP_Interrupt_Ack</span><span class="p">,</span> <span class="n">Interrupt_A_Ack_Register</span><span class="p">);</span>	<span class="cm">/* clear interrupts */</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Configuration_End</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*  lock to avoid race with interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifndef PCIDMA</span>
	<span class="n">ni_handle_fifo_dregs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">ni_sync_ai_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">adbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">signbits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dl</span><span class="p">;</span>

	<span class="n">ni_load_channelgain_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="n">ni_clear_ai_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">signbits</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">num_adc_stages_611x</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_CONVERT_Pulse</span><span class="p">,</span>
					    <span class="n">AI_Command_1_Register</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_CONVERT_Pulse</span><span class="p">,</span>
					    <span class="n">AI_Command_1_Register</span><span class="p">);</span>
			<span class="cm">/* The 611x has screwy 32-bit FIFOs. */</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NI_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ni_readb</span><span class="p">(</span><span class="n">XXX_Status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">ADC_FIFO_Data_611x</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
				      <span class="n">AI_FIFO_Empty_St</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">ADC_FIFO_Data_611x</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="mh">0xffff</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NI_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;ni_mio_common: timeout in 611x ni_ai_insn_read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">d</span> <span class="o">+=</span> <span class="n">signbits</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_CONVERT_Pulse</span><span class="p">,</span>
					    <span class="n">AI_Command_1_Register</span><span class="p">);</span>

			<span class="cm">/* The 6143 has 32-bit FIFOs. You need to strobe a bit to move a single 16bit stranded sample into the FIFO */</span>
			<span class="n">dl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NI_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Status_6143</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">AIFIFO_Control_6143</span><span class="p">);</span>	<span class="cm">/*  Get stranded sample into FIFO */</span>
					<span class="n">dl</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">AIFIFO_Data_6143</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NI_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;ni_mio_common: timeout in 6143 ni_ai_insn_read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">+</span> <span class="n">signbits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_CONVERT_Pulse</span><span class="p">,</span>
					    <span class="n">AI_Command_1_Register</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NI_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
				      <span class="n">AI_FIFO_Empty_St</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NI_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;ni_mio_common: timeout in ni_ai_insn_read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">ni_readl</span><span class="p">(</span><span class="n">M_Offset_AI_FIFO_Data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">ni_readw</span><span class="p">(</span><span class="n">ADC_FIFO_Data_Register</span><span class="p">);</span>
				<span class="n">d</span> <span class="o">+=</span> <span class="n">signbits</span><span class="p">;</span>	<span class="cm">/* subtle: needs to be short addition */</span>
				<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ni_prime_channelgain_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_CONVERT_Pulse</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NI_TIMEOUT</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">AI_Status_1_Register</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">AI_FIFO_Empty_St</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADC_FIFO_Clear</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_mio_common: timeout loading channel/gain list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_m_series_load_channelgain_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">aref</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dither</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">range_code</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Configuration_Memory_Clear</span><span class="p">);</span>

<span class="cm">/* offset = 1 &lt;&lt; (boardtype.adbits - 1); */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">bypass_bits</span><span class="p">;</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">range_code</span> <span class="o">=</span> <span class="n">ni_gainlkup</span><span class="p">[</span><span class="n">boardtype</span><span class="p">.</span><span class="n">gainlkup</span><span class="p">][</span><span class="n">range</span><span class="p">];</span>
		<span class="n">dither</span> <span class="o">=</span> <span class="p">((</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_FILTER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bypass_bits</span> <span class="o">=</span> <span class="n">MSeries_AI_Bypass_Config_FIFO_Bit</span><span class="p">;</span>
		<span class="n">bypass_bits</span> <span class="o">|=</span> <span class="n">chan</span><span class="p">;</span>
		<span class="n">bypass_bits</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">MSeries_AI_Bypass_Cal_Sel_Pos_Mask</span> <span class="o">|</span>
		     <span class="n">MSeries_AI_Bypass_Cal_Sel_Neg_Mask</span> <span class="o">|</span>
		     <span class="n">MSeries_AI_Bypass_Mode_Mux_Mask</span> <span class="o">|</span>
		     <span class="n">MSeries_AO_Bypass_AO_Cal_Sel_Mask</span><span class="p">);</span>
		<span class="n">bypass_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Bypass_Gain_Bits</span><span class="p">(</span><span class="n">range_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dither</span><span class="p">)</span>
			<span class="n">bypass_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Bypass_Dither_Bit</span><span class="p">;</span>
		<span class="cm">/*  don&#39;t use 2&#39;s complement encoding */</span>
		<span class="n">bypass_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Bypass_Polarity_Bit</span><span class="p">;</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">bypass_bits</span><span class="p">,</span> <span class="n">M_Offset_AI_Config_FIFO_Bypass</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M_Offset_AI_Config_FIFO_Bypass</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">config_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">aref</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dither</span> <span class="o">=</span> <span class="p">((</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_FILTER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">range_code</span> <span class="o">=</span> <span class="n">ni_gainlkup</span><span class="p">[</span><span class="n">boardtype</span><span class="p">.</span><span class="n">gainlkup</span><span class="p">][</span><span class="n">range</span><span class="p">];</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">aref</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AREF_DIFF</span>:
			<span class="n">config_bits</span> <span class="o">|=</span>
			    <span class="n">MSeries_AI_Config_Channel_Type_Differential_Bits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AREF_COMMON</span>:
			<span class="n">config_bits</span> <span class="o">|=</span>
			    <span class="n">MSeries_AI_Config_Channel_Type_Common_Ref_Bits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AREF_GROUND</span>:
			<span class="n">config_bits</span> <span class="o">|=</span>
			    <span class="n">MSeries_AI_Config_Channel_Type_Ground_Ref_Bits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AREF_OTHER</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">config_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Config_Channel_Bits</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">config_bits</span> <span class="o">|=</span>
		    <span class="n">MSeries_AI_Config_Bank_Bits</span><span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">config_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Config_Gain_Bits</span><span class="p">(</span><span class="n">range_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">config_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Config_Last_Channel_Bit</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dither</span><span class="p">)</span>
			<span class="n">config_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Config_Dither_Bit</span><span class="p">;</span>
		<span class="cm">/*  don&#39;t use 2&#39;s complement encoding */</span>
		<span class="n">config_bits</span> <span class="o">|=</span> <span class="n">MSeries_AI_Config_Polarity_Bit</span><span class="p">;</span>
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">config_bits</span><span class="p">,</span> <span class="n">M_Offset_AI_Config_FIFO_Data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ni_prime_channelgain_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notes on the 6110 and 6111:</span>
<span class="cm"> * These boards a slightly different than the rest of the series, since</span>
<span class="cm"> * they have multiple A/D converters.</span>
<span class="cm"> * From the driver side, the configuration memory is a</span>
<span class="cm"> * little different.</span>
<span class="cm"> * Configuration Memory Low:</span>
<span class="cm"> *   bits 15-9: same</span>
<span class="cm"> *   bit 8: unipolar/bipolar (should be 0 for bipolar)</span>
<span class="cm"> *   bits 0-3: gain.  This is 4 bits instead of 3 for the other boards</span>
<span class="cm"> *       1001 gain=0.1 (+/- 50)</span>
<span class="cm"> *       1010 0.2</span>
<span class="cm"> *       1011 0.1</span>
<span class="cm"> *       0001 1</span>
<span class="cm"> *       0010 2</span>
<span class="cm"> *       0011 5</span>
<span class="cm"> *       0100 10</span>
<span class="cm"> *       0101 20</span>
<span class="cm"> *       0110 50</span>
<span class="cm"> * Configuration Memory High:</span>
<span class="cm"> *   bits 12-14: Channel Type</span>
<span class="cm"> *       001 for differential</span>
<span class="cm"> *       000 for calibration</span>
<span class="cm"> *   bit 11: coupling  (this is not currently handled)</span>
<span class="cm"> *       1 AC coupling</span>
<span class="cm"> *       0 DC coupling</span>
<span class="cm"> *   bits 0-2: channel</span>
<span class="cm"> *       valid channels are 0-3</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_load_channelgain_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">aref</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dither</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_m_series_load_channelgain_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_chan</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">changain_state</span>
		    <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">changain_spec</span> <span class="o">==</span> <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/*  ready to go. */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">changain_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">changain_spec</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">changain_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Configuration_Memory_Clear</span><span class="p">);</span>

	<span class="cm">/*  Set up Calibration mode if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Strobe Relay enable bit */</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span> <span class="o">|</span>
				  <span class="n">Calibration_Channel_6143_RelayOn</span><span class="p">,</span>
				  <span class="n">Calibration_Channel_6143</span><span class="p">);</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span><span class="p">,</span>
				  <span class="n">Calibration_Channel_6143</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>	<span class="cm">/*  Allow relays to change */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Strobe Relay disable bit */</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span> <span class="o">|</span>
				  <span class="n">Calibration_Channel_6143_RelayOff</span><span class="p">,</span>
				  <span class="n">Calibration_Channel_6143</span><span class="p">);</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span><span class="p">,</span>
				  <span class="n">Calibration_Channel_6143</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>	<span class="cm">/*  Allow relays to change */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">adbits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">aref</span> <span class="o">=</span> <span class="n">CR_AREF</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dither</span> <span class="o">=</span> <span class="p">((</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_FILTER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* fix the external/internal range differences */</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">ni_gainlkup</span><span class="p">[</span><span class="n">boardtype</span><span class="p">.</span><span class="n">gainlkup</span><span class="p">][</span><span class="n">range</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">range</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
				<span class="n">ni_writew</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">,</span>
					  <span class="n">Calibration_Channel_Select_611x</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
				<span class="n">aref</span> <span class="o">=</span> <span class="n">AREF_DIFF</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span>
				<span class="n">aref</span> <span class="o">=</span> <span class="n">AREF_OTHER</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">aref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AREF_DIFF</span>:
				<span class="n">hi</span> <span class="o">|=</span> <span class="n">AI_DIFFERENTIAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AREF_COMMON</span>:
				<span class="n">hi</span> <span class="o">|=</span> <span class="n">AI_COMMON</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AREF_GROUND</span>:
				<span class="n">hi</span> <span class="o">|=</span> <span class="n">AI_GROUND</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AREF_OTHER</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">hi</span> <span class="o">|=</span> <span class="n">AI_CONFIG_CHANNEL</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">ni_writew</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">Configuration_Memory_High</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">lo</span> <span class="o">|=</span> <span class="n">AI_LAST_CHANNEL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dither</span><span class="p">)</span>
				<span class="n">lo</span> <span class="o">|=</span> <span class="n">AI_DITHER</span><span class="p">;</span>

			<span class="n">ni_writew</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">Configuration_Memory_Low</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* prime the channel/gain list */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ni_prime_channelgain_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ns_to_timer</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nanosec</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">round_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">round_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
	<span class="nl">default:</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">nanosec</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">nanosec</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">nanosec</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">divider</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ni_timer_to_ns</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="p">(</span><span class="n">timer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ni_min_ai_scan_period_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ni_reg_611x</span>:
	<span class="k">case</span> <span class="n">ni_reg_6143</span>:
		<span class="cm">/*  simultaneously-sampled inputs */</span>
		<span class="k">return</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ai_speed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*  multiplexed inputs */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ai_speed</span> <span class="o">*</span> <span class="n">num_channels</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sources</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMDF_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMDF_WRITE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span> <span class="o">|</span> <span class="n">TRIG_INT</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">sources</span> <span class="o">=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">))</span>
		<span class="n">sources</span> <span class="o">|=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">sources</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="cm">/* note that mutual compatibility is not an issue here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_OTHER</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* external trigger */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CR_INVERT</span> <span class="o">|</span> <span class="n">CR_EDGE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* true for both TRIG_NOW and TRIG_INT */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">ni_min_ai_scan_period_ns</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">cmd</span><span class="o">-&gt;</span>
								   <span class="n">chanlist_len</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
			    <span class="n">ni_min_ai_scan_period_ns</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="mh">0xffffff</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* external trigger */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CR_INVERT</span> <span class="o">|</span> <span class="n">CR_EDGE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TRIG_OTHER */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ai_speed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ai_speed</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* external trigger */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CR_ALT_FILTER</span> <span class="o">|</span> <span class="n">CR_INVERT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_count</span> <span class="o">=</span> <span class="mh">0x01000000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
			<span class="n">max_count</span> <span class="o">-=</span> <span class="n">num_adc_stages_611x</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&gt;</span> <span class="n">max_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="n">max_count</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
		    <span class="n">ni_timer_to_ns</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ni_ns_to_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
						       <span class="n">cmd</span><span class="o">-&gt;</span>
						       <span class="n">flags</span> <span class="o">&amp;</span>
						       <span class="n">TRIG_ROUND_MASK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_6143</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span>
			    <span class="n">ni_timer_to_ns</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ni_ns_to_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
							       <span class="n">cmd</span><span class="o">-&gt;</span>
							       <span class="n">flags</span> <span class="o">&amp;</span>
							       <span class="n">TRIG_ROUND_MASK</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">*</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span><span class="p">;</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* mode1 is needed for both stop and convert */</span>
	<span class="kt">int</span> <span class="n">mode2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_stop_select</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stop_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interrupt_a_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">MDPRINTK</span><span class="p">(</span><span class="s">&quot;ni_ai_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot run command without an irq&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_clear_ai_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ni_load_channelgain_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">);</span>

	<span class="cm">/* start configuration */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Configuration_Start</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="cm">/* disable analog triggering for now, since it</span>
<span class="cm">	 * interferes with the use of pfi0 */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">an_trig_etc_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Analog_Trigger_Enable</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">an_trig_etc_reg</span><span class="p">,</span>
			    <span class="n">Analog_Trigger_Etc_Register</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_INT</span>:
	<span class="k">case</span> <span class="n">TRIG_NOW</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_START2_Select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AI_START1_Sync</span> <span class="o">|</span> <span class="n">AI_START1_Edge</span> <span class="o">|</span>
				    <span class="n">AI_START1_Select</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				    <span class="n">AI_Trigger_Select_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">AI_START2_Select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">AI_START1_Sync</span> <span class="o">|</span> <span class="n">AI_START1_Select</span><span class="p">(</span><span class="n">chan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
				<span class="n">bits</span> <span class="o">|=</span> <span class="n">AI_START1_Polarity</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_EDGE</span><span class="p">)</span>
				<span class="n">bits</span> <span class="o">|=</span> <span class="n">AI_START1_Edge</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span>
					    <span class="n">AI_Trigger_Select_Register</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AI_Pre_Trigger</span><span class="p">;</span>
	<span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AI_SC_Initial_Load_Source</span><span class="p">;</span>
	<span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AI_SC_Reload_Mode</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">AI_Mode_2_Register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_STOP_Polarity</span><span class="p">;</span>
		<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_STOP_Select</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>	<span class="cm">/*  logic low */</span>
		<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_STOP_Sync</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_STOP_Select</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span>	<span class="cm">/*  ai configuration memory */</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">start_stop_select</span><span class="p">,</span>
			    <span class="n">AI_START_STOP_Select_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_cmd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="n">stop_count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  have to take 3 stage adc pipeline into account */</span>
			<span class="n">stop_count</span> <span class="o">+=</span> <span class="n">num_adc_stages_611x</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* stage number of scans */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">stop_count</span><span class="p">,</span> <span class="n">AI_SC_Load_A_Registers</span><span class="p">);</span>

		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">AI_Start_Stop</span> <span class="o">|</span> <span class="n">AI_Mode_1_Reserved</span> <span class="o">|</span> <span class="n">AI_Trigger_Once</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode1</span><span class="p">,</span> <span class="n">AI_Mode_1_Register</span><span class="p">);</span>
		<span class="cm">/* load SC (Scan Count) */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SC_Load</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_continuous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stop_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_cmd2</span> <span class="o">|=</span> <span class="n">AI_End_On_End_Of_Scan</span><span class="p">;</span>
			<span class="n">interrupt_a_enable</span> <span class="o">|=</span> <span class="n">AI_STOP_Interrupt_Enable</span><span class="p">;</span>
			<span class="cm">/*  this is required to get the last sample for chanlist_len &gt; 1, not sure why */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">start_stop_select</span> <span class="o">|=</span>
				    <span class="n">AI_STOP_Polarity</span> <span class="o">|</span> <span class="n">AI_STOP_Edge</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="cm">/* stage number of scans */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AI_SC_Load_A_Registers</span><span class="p">);</span>

		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">AI_Start_Stop</span> <span class="o">|</span> <span class="n">AI_Mode_1_Reserved</span> <span class="o">|</span> <span class="n">AI_Continuous</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode1</span><span class="p">,</span> <span class="n">AI_Mode_1_Register</span><span class="p">);</span>

		<span class="cm">/* load SC (Scan Count) */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SC_Load</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_continuous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="cm">/*</span>
<span class="cm">		   stop bits for non 611x boards</span>
<span class="cm">		   AI_SI_Special_Trigger_Delay=0</span>
<span class="cm">		   AI_Pre_Trigger=0</span>
<span class="cm">		   AI_START_STOP_Select_Register:</span>
<span class="cm">		   AI_START_Polarity=0 (?)      rising edge</span>
<span class="cm">		   AI_START_Edge=1              edge triggered</span>
<span class="cm">		   AI_START_Sync=1 (?)</span>
<span class="cm">		   AI_START_Select=0            SI_TC</span>
<span class="cm">		   AI_STOP_Polarity=0           rising edge</span>
<span class="cm">		   AI_STOP_Edge=0               level</span>
<span class="cm">		   AI_STOP_Sync=1</span>
<span class="cm">		   AI_STOP_Select=19            external pin (configuration mem)</span>
<span class="cm">		 */</span>
		<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_START_Edge</span> <span class="o">|</span> <span class="n">AI_START_Sync</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">start_stop_select</span><span class="p">,</span>
				    <span class="n">AI_START_STOP_Select_Register</span><span class="p">);</span>

		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">AI_SI_Reload_Mode</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* AI_SI_Initial_Load_Source=A */</span>
		<span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AI_SI_Initial_Load_Source</span><span class="p">;</span>
		<span class="cm">/* mode2 |= AI_SC_Reload_Mode; */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">AI_Mode_2_Register</span><span class="p">);</span>

		<span class="cm">/* load SI */</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">ni_ns_to_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
				       <span class="n">TRIG_ROUND_NEAREST</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">AI_SI_Load_A_Registers</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SI_Load</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_EDGE</span><span class="p">)</span>
			<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_START_Edge</span><span class="p">;</span>
		<span class="cm">/* AI_START_Polarity==1 is falling edge */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
			<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_START_Polarity</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_EDGE</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_EDGE</span><span class="p">))</span>
			<span class="n">start_stop_select</span> <span class="o">|=</span> <span class="n">AI_START_Sync</span><span class="p">;</span>
		<span class="n">start_stop_select</span> <span class="o">|=</span>
		    <span class="n">AI_START_Select</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">));</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">start_stop_select</span><span class="p">,</span>
				    <span class="n">AI_START_STOP_Select_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
	<span class="k">case</span> <span class="n">TRIG_NOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
			<span class="n">timer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">timer</span> <span class="o">=</span> <span class="n">ni_ns_to_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">,</span>
					       <span class="n">TRIG_ROUND_NEAREST</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AI_SI2_Load_A_Register</span><span class="p">);</span>	<span class="cm">/* 0,0 does not work. */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">AI_SI2_Load_B_Register</span><span class="p">);</span>

		<span class="cm">/* AI_SI2_Reload_Mode = alternate */</span>
		<span class="cm">/* AI_SI2_Initial_Load_Source = A */</span>
		<span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AI_SI2_Initial_Load_Source</span><span class="p">;</span>
		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">AI_SI2_Reload_Mode</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">AI_Mode_2_Register</span><span class="p">);</span>

		<span class="cm">/* AI_SI2_Load */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_SI2_Load</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>

		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">AI_SI2_Reload_Mode</span><span class="p">;</span>	<span class="cm">/*  alternate */</span>
		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">AI_SI2_Initial_Load_Source</span><span class="p">;</span>	<span class="cm">/*  B */</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">AI_Mode_2_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">AI_CONVERT_Source_Select</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mode1</span> <span class="o">|=</span> <span class="n">AI_CONVERT_Source_Polarity</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode1</span><span class="p">,</span> <span class="n">AI_Mode_1_Register</span><span class="p">);</span>

		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">AI_Start_Stop_Gate_Enable</span> <span class="o">|</span> <span class="n">AI_SC_Gate_Enable</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode2</span><span class="p">,</span> <span class="n">AI_Mode_2_Register</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* interrupt on FIFO, errors, SC_TC */</span>
		<span class="n">interrupt_a_enable</span> <span class="o">|=</span> <span class="n">AI_Error_Interrupt_Enable</span> <span class="o">|</span>
		    <span class="n">AI_SC_TC_Interrupt_Enable</span><span class="p">;</span>

<span class="cp">#ifndef PCIDMA</span>
		<span class="n">interrupt_a_enable</span> <span class="o">|=</span> <span class="n">AI_FIFO_Interrupt_Enable</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_cmd2</span> <span class="o">&amp;</span> <span class="n">AI_End_On_End_Of_Scan</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* wake on end-of-scan */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">aimode</span> <span class="o">=</span> <span class="n">AIMODE_SCAN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">aimode</span> <span class="o">=</span> <span class="n">AIMODE_HALF_FULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">aimode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AIMODE_HALF_FULL</span>:
			<span class="cm">/*generate FIFO interrupts and DMA requests on half-full */</span>
<span class="cp">#ifdef PCIDMA</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_FIFO_Mode_HF_to_E</span><span class="p">,</span>
					    <span class="n">AI_Mode_3_Register</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_FIFO_Mode_HF</span><span class="p">,</span>
					    <span class="n">AI_Mode_3_Register</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AIMODE_SAMPLE</span>:
			<span class="cm">/*generate FIFO interrupts on non-empty */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_FIFO_Mode_NE</span><span class="p">,</span>
					    <span class="n">AI_Mode_3_Register</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AIMODE_SCAN</span>:
<span class="cp">#ifdef PCIDMA</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_FIFO_Mode_NE</span><span class="p">,</span>
					    <span class="n">AI_Mode_3_Register</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_FIFO_Mode_HF</span><span class="p">,</span>
					    <span class="n">AI_Mode_3_Register</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">interrupt_a_enable</span> <span class="o">|=</span> <span class="n">AI_STOP_Interrupt_Enable</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Error_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_STOP_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_START_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_START2_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_START1_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_SC_TC_Interrupt_Ack</span> <span class="o">|</span> <span class="n">AI_SC_TC_Error_Confirm</span><span class="p">,</span> <span class="n">Interrupt_A_Ack_Register</span><span class="p">);</span>	<span class="cm">/* clear interrupts */</span>

		<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_A_Enable_Register</span><span class="p">,</span>
			    <span class="n">interrupt_a_enable</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">MDPRINTK</span><span class="p">(</span><span class="s">&quot;Interrupt_A_Enable_Register = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">int_a_enable_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* interrupt on nothing */</span>
		<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_A_Enable_Register</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* XXX start polling if necessary */</span>
		<span class="n">MDPRINTK</span><span class="p">(</span><span class="s">&quot;interrupting on nothing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* end configuration */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_Configuration_End</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">AI_SI2_Arm</span> <span class="o">|</span> <span class="n">AI_SI_Arm</span> <span class="o">|</span> <span class="n">AI_DIV_Arm</span> <span class="o">|</span>
				    <span class="n">AI_SC_Arm</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="cm">/* XXX AI_SI_Arm? */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">AI_SI2_Arm</span> <span class="o">|</span> <span class="n">AI_SI_Arm</span> <span class="o">|</span> <span class="n">AI_DIV_Arm</span> <span class="o">|</span>
				    <span class="n">AI_SC_Arm</span><span class="p">,</span> <span class="n">AI_Command_1_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef PCIDMA</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">ni_ai_setup_MITE_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* mite_dump_regs(devpriv-&gt;mite); */</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_NOW</span>:
		<span class="cm">/* AI_START1_Pulse */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_START1_Pulse</span> <span class="o">|</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_cmd2</span><span class="p">,</span>
				    <span class="n">AI_Command_2_Register</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_INT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_inttrig</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">MDPRINTK</span><span class="p">(</span><span class="s">&quot;exit ni_ai_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trignum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AI_START1_Pulse</span> <span class="o">|</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_cmd2</span><span class="p">,</span>
			    <span class="n">AI_Command_2_Register</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_ai_config_analog_trig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_ANALOG_TRIG</span>:
		<span class="k">return</span> <span class="n">ni_ai_config_analog_trig</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_ALT_SOURCE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSeries_AI_Bypass_Cal_Sel_Pos_Mask</span> <span class="o">|</span>
					<span class="n">MSeries_AI_Bypass_Cal_Sel_Neg_Mask</span> <span class="o">|</span>
					<span class="n">MSeries_AI_Bypass_Mode_Mux_Mask</span> <span class="o">|</span>
					<span class="n">MSeries_AO_Bypass_AO_Cal_Sel_Mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">calib_source</span><span class="p">;</span>

			<span class="n">calib_source</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">calib_source</span> <span class="o">&gt;</span> <span class="mh">0xF</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span> <span class="o">=</span> <span class="n">calib_source</span><span class="p">;</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">calib_source</span><span class="p">,</span> <span class="n">Calibration_Channel_6143</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">calib_source</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">calib_source_adjust</span><span class="p">;</span>

			<span class="n">calib_source</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">calib_source_adjust</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">calib_source</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_calib_source</span> <span class="o">=</span> <span class="n">calib_source</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_611x</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ni_writeb</span><span class="p">(</span><span class="n">calib_source_adjust</span><span class="p">,</span>
					  <span class="n">Cal_Gain_Select_611x</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ai_config_analog_trig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">modebits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* data[1] is flags</span>
<span class="cm">	 * data[2] is analog line</span>
<span class="cm">	 * data[3] is set level</span>
<span class="cm">	 * data[4] is reset level */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boardtype</span><span class="p">.</span><span class="n">has_analog_trig</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">!=</span> <span class="n">COMEDI_EV_SCAN_BEGIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">COMEDI_EV_SCAN_BEGIN</span> <span class="o">|</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_adchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_adchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* a */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* b */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * 00 ignore</span>
<span class="cm">	 * 01 set</span>
<span class="cm">	 * 10 reset</span>
<span class="cm">	 *</span>
<span class="cm">	 * modes:</span>
<span class="cm">	 *   1 level:                    +b-   +a-</span>
<span class="cm">	 *     high mode                00 00 01 10</span>
<span class="cm">	 *     low mode                 00 00 10 01</span>
<span class="cm">	 *   2 level: (a&lt;b)</span>
<span class="cm">	 *     hysteresis low mode      10 00 00 01</span>
<span class="cm">	 *     hysteresis high mode     01 00 00 10</span>
<span class="cm">	 *     middle mode              10 01 01 10</span>
<span class="cm">	 */</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">modebits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modebits</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* two level mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* swap order */</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">modebits</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_low</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_high</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">modebits</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x81</span>:	<span class="cm">/* low hysteresis mode */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_mode</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x42</span>:	<span class="cm">/* high hysteresis mode */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x96</span>:	<span class="cm">/* middle window mode */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* one level mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">modebits</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x06</span>:	<span class="cm">/* high window mode */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_high</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:	<span class="cm">/* low window mode */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_low</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">atrig_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* munge data from unsigned to 2&#39;s complement for analog output bipolar modes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_ao_munge</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">aobits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">ao_unipolar</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">range</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
		<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">chan_index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chan_index</span> <span class="o">%=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_m_series_ao_config_chanlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanspec</span><span class="p">[],</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chans</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_conf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSeries_AO_Update_Timed_Bit</span><span class="p">;</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_conf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="n">M_Offset_AO_Config_Bank</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">M_Offset_AO_Waveform_Order</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_krange</span> <span class="o">*</span><span class="n">krange</span><span class="p">;</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanspec</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanspec</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">krange</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span><span class="o">-&gt;</span><span class="n">range</span> <span class="o">+</span> <span class="n">range</span><span class="p">;</span>
		<span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">krange</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="n">krange</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">20000000</span>:
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_DAC_Reference_10V_Internal_Bits</span><span class="p">;</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M_Offset_AO_Reference_Attenuation</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10000000</span>:
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_DAC_Reference_5V_Internal_Bits</span><span class="p">;</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M_Offset_AO_Reference_Attenuation</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4000000</span>:
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_DAC_Reference_10V_Internal_Bits</span><span class="p">;</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="n">MSeries_Attenuate_x5_Bit</span><span class="p">,</span>
				  <span class="n">M_Offset_AO_Reference_Attenuation</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2000000</span>:
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_DAC_Reference_5V_Internal_Bits</span><span class="p">;</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="n">MSeries_Attenuate_x5_Bit</span><span class="p">,</span>
				  <span class="n">M_Offset_AO_Reference_Attenuation</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bug! unhandled ao reference voltage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">krange</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">+</span> <span class="n">krange</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_DAC_Offset_0V_Bits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10000000</span>:
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_DAC_Offset_5V_Bits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bug! unhandled ao offset voltage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timed</span><span class="p">)</span>
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">MSeries_AO_Update_Timed_Bit</span><span class="p">;</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">M_Offset_AO_Config_Bank</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_conf</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">M_Offset_AO_Waveform_Order</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">invert</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_old_ao_config_chanlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanspec</span><span class="p">[],</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chans</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">chanspec</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">CR_RANGE</span><span class="p">(</span><span class="n">chanspec</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">AO_Channel</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">ao_unipolar</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">range</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conf</span> <span class="o">|=</span> <span class="n">AO_Bipolar</span><span class="p">;</span>
				<span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">aobits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">conf</span> <span class="o">|=</span> <span class="n">AO_Ext_Ref</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">AO_Bipolar</span><span class="p">;</span>
			<span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">aobits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* not all boards can deglitch, but this shouldn&#39;t hurt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CR_DEGLITCH</span><span class="p">)</span>
			<span class="n">conf</span> <span class="o">|=</span> <span class="n">AO_Deglitch</span><span class="p">;</span>

		<span class="cm">/* analog reference */</span>
		<span class="cm">/* AREF_OTHER connects AO ground to AI ground, i think */</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CR_AREF</span><span class="p">(</span><span class="n">chanspec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span>
			 <span class="n">AREF_OTHER</span><span class="p">)</span> <span class="o">?</span> <span class="n">AO_Ground_Ref</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ni_writew</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AO_Configuration</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_conf</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">invert</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_config_chanlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chanspec</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_chans</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">timed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ni_m_series_ao_config_chanlist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">,</span> <span class="n">n_chans</span><span class="p">,</span>
						      <span class="n">timed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ni_old_ao_config_chanlist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">,</span> <span class="n">n_chans</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">;</span>

	<span class="n">invert</span> <span class="o">=</span> <span class="n">ni_ao_config_chanlist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M_Offset_DAC_Direct_Data</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">invert</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">?</span> <span class="n">DAC1_Direct_Data</span> <span class="o">:</span> <span class="n">DAC0_Direct_Data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_insn_write_671x</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">;</span>

	<span class="n">ao_win_out</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">,</span> <span class="n">AO_Immediate_671x</span><span class="p">);</span>
	<span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">aobits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ni_ao_config_chanlist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ao_win_out</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">invert</span><span class="p">,</span> <span class="n">DACx_Direct_Data_671x</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_HARDWARE_BUFFER_SIZE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">COMEDI_OUTPUT</span>:
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="p">)</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMEDI_INPUT</span>:
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interrupt_b_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trignum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Null trig at beginning prevent ao start trigger from executing more than</span>
<span class="cm">	   once per command (and doing things like trying to allocate the ao dma channel</span>
<span class="cm">	   multiple times) */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">,</span>
		    <span class="n">AO_FIFO_Interrupt_Enable</span> <span class="o">|</span> <span class="n">AO_Error_Interrupt_Enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">interrupt_b_bits</span> <span class="o">=</span> <span class="n">AO_Error_Interrupt_Enable</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DAC_FIFO_Clear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span>
		<span class="n">ni_ao_win_outl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="n">AO_FIFO_Offset_Load_611x</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ni_ao_setup_MITE_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ni_ao_wait_for_dma_load</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ni_ao_prep_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

	<span class="n">interrupt_b_bits</span> <span class="o">|=</span> <span class="n">AO_FIFO_Interrupt_Enable</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span> <span class="o">|</span> <span class="n">AO_Not_An_UPDATE</span><span class="p">,</span>
			    <span class="n">AO_Mode_3_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span><span class="p">,</span> <span class="n">AO_Mode_3_Register</span><span class="p">);</span>
	<span class="cm">/* wait for DACs to be loaded */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">Joint_Status_2_Register</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">AO_TMRDACWRs_In_Progress_St</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;timed out waiting for AO_TMRDACWRs_In_Progress_St to clear&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  stc manual says we are need to clear error interrupt after AO_TMRDACWRs_In_Progress_St clears */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Error_Interrupt_Ack</span><span class="p">,</span>
			    <span class="n">Interrupt_B_Ack_Register</span><span class="p">);</span>

	<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">,</span> <span class="n">interrupt_b_bits</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd1</span> <span class="o">|</span> <span class="n">AO_UI_Arm</span> <span class="o">|</span> <span class="n">AO_UC_Arm</span> <span class="o">|</span> <span class="n">AO_BC_Arm</span>
			    <span class="o">|</span> <span class="n">AO_DAC1_Update_Mode</span> <span class="o">|</span> <span class="n">AO_DAC0_Update_Mode</span><span class="p">,</span>
			    <span class="n">AO_Command_1_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd2</span> <span class="o">|</span> <span class="n">AO_START1_Pulse</span><span class="p">,</span>
			    <span class="n">AO_Command_2_Register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">trigvar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot run command without an irq&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Configuration_Start</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Disarm</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ao_win_out</span><span class="p">(</span><span class="n">CLEAR_WG</span><span class="p">,</span> <span class="n">AO_Misc_611x</span><span class="p">);</span>

		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

			<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">;</span>
			<span class="n">ao_win_out</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">AO_Waveform_Generation_611x</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ao_win_out</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">AO_Timed_611x</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ni_ao_config_chanlist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">|=</span> <span class="n">AO_Continuous</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_Trigger_Once</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_Continuous</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">|=</span> <span class="n">AO_Trigger_Once</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span><span class="p">,</span> <span class="n">AO_Mode_1_Register</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_INT</span>:
	<span class="k">case</span> <span class="n">TRIG_NOW</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">AO_START1_Polarity</span> <span class="o">|</span> <span class="n">AO_START1_Select</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span> <span class="o">|=</span> <span class="n">AO_START1_Edge</span> <span class="o">|</span> <span class="n">AO_START1_Sync</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span><span class="p">,</span>
				    <span class="n">AO_Trigger_Select_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span> <span class="o">=</span>
		    <span class="n">AO_START1_Select</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span> <span class="o">|=</span> <span class="n">AO_START1_Polarity</span><span class="p">;</span>	<span class="cm">/*  0=active high, 1=active low. see daq-stc 3-24 (p186) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="n">CR_EDGE</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span> <span class="o">|=</span> <span class="n">AO_START1_Edge</span><span class="p">;</span>	<span class="cm">/*  0=edge detection disabled, 1=enabled */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span><span class="p">,</span>
				    <span class="n">AO_Trigger_Select_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_Trigger_Length</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span><span class="p">,</span> <span class="n">AO_Mode_3_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span><span class="p">,</span> <span class="n">AO_Mode_1_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_BC_Initial_Load_Source</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span><span class="p">,</span> <span class="n">AO_Mode_2_Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">AO_BC_Load_A_Register</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AO_BC_Load_A_Register</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_BC_Load</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_UC_Initial_Load_Source</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span><span class="p">,</span> <span class="n">AO_Mode_2_Register</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_COUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  this is how the NI example code does it for m-series boards, verified correct with 6259 */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_UC_Load</span><span class="p">,</span>
					    <span class="n">AO_Command_1_Register</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span>
					    <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_UC_Load</span><span class="p">,</span>
					    <span class="n">AO_Command_1_Register</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_NONE</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_UC_Load</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_UC_Load</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span><span class="p">,</span> <span class="n">AO_UC_Load_A_Register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="p">(</span><span class="n">AO_UI_Source_Select</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="n">AO_UI_Source_Polarity</span> <span class="o">|</span>
	      <span class="n">AO_UPDATE_Source_Select</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="n">AO_UPDATE_Source_Polarity</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_TIMER</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_BC_Gate_Enable</span><span class="p">;</span>
		<span class="n">trigvar</span> <span class="o">=</span>
		    <span class="n">ni_ns_to_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
				   <span class="n">TRIG_ROUND_NEAREST</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AO_UI_Load_A_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_UI_Load</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">trigvar</span><span class="p">,</span> <span class="n">AO_UI_Load_A_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">|=</span>
		    <span class="n">AO_UPDATE_Source_Select</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">|=</span> <span class="n">AO_UPDATE_Source_Polarity</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd2</span> <span class="o">|=</span> <span class="n">AO_BC_Gate_Enable</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd2</span><span class="p">,</span> <span class="n">AO_Command_2_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span><span class="p">,</span> <span class="n">AO_Mode_1_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="p">(</span><span class="n">AO_UI_Reload_Mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">AO_UI_Initial_Load_Source</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span><span class="p">,</span> <span class="n">AO_Mode_2_Register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">|=</span> <span class="n">AO_Multiple_Channels</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">AO_Number_Of_Channels</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">-</span>
							  <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">AO_UPDATE_Output_Select</span>
				    <span class="p">(</span><span class="n">AO_Update_Output_High_Z</span><span class="p">),</span>
				    <span class="n">AO_Output_Control_Register</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">bits</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_Multiple_Channels</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">AO_UPDATE_Output_Select</span><span class="p">(</span><span class="n">AO_Update_Output_High_Z</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span>
		    <span class="n">reg_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ni_reg_m_series_mask</span> <span class="o">|</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">AO_Number_Of_Channels</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">|=</span>
			    <span class="n">AO_Number_Of_Channels</span><span class="p">(</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">AO_Output_Control_Register</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span><span class="p">,</span> <span class="n">AO_Mode_1_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_DAC0_Update_Mode</span> <span class="o">|</span> <span class="n">AO_DAC1_Update_Mode</span><span class="p">,</span>
			    <span class="n">AO_Command_1_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span> <span class="o">|=</span> <span class="n">AO_Stop_On_Overrun_Error</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span><span class="p">,</span> <span class="n">AO_Mode_3_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_FIFO_Mode_Mask</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">|=</span> <span class="n">AO_FIFO_Mode_HF_to_F</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">|=</span> <span class="n">AO_FIFO_Mode_HF</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AO_FIFO_Retransmit_Enable</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span><span class="p">,</span> <span class="n">AO_Mode_2_Register</span><span class="p">);</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">AO_BC_Source_Select</span> <span class="o">|</span> <span class="n">AO_UPDATE_Pulse_Width</span> <span class="o">|</span>
	    <span class="n">AO_TMRDACWR_Pulse_Width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">AO_FIFO_Enable</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">AO_DMA_PIO_Control</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* F Hess: windows driver does not set AO_Number_Of_DAC_Packages bit for 6281,</span>
<span class="c">	   verified with bus analyzer. */</span>
<span class="c">	if (boardtype.reg_type &amp; ni_reg_m_series_mask)</span>
<span class="c">		bits |= AO_Number_Of_DAC_Packages;</span>
<span class="cp">#endif</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">AO_Personal_Register</span><span class="p">);</span>
	<span class="cm">/*  enable sending of ao dma requests */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_AOFREQ_Enable</span><span class="p">,</span> <span class="n">AO_Start_Select_Register</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Configuration_End</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_BC_TC_Interrupt_Ack</span><span class="p">,</span>
				    <span class="n">Interrupt_B_Ack_Register</span><span class="p">);</span>
		<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">,</span>
			    <span class="n">AO_BC_TC_Interrupt_Enable</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_inttrig</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMDF_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMDF_WRITE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_INT</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_TIMER</span> <span class="o">|</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span> <span class="o">|</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique and mutually compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* external trigger */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CR_INVERT</span> <span class="o">|</span> <span class="n">CR_EDGE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* true for both TRIG_NOW and TRIG_INT */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_speed</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&gt;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* XXX check */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">*</span> <span class="mh">0xffffff</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_COUNT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* XXX check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">&gt;</span> <span class="mh">0x00ffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TRIG_NONE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">=</span>
		    <span class="n">ni_timer_to_ns</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ni_ns_to_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">,</span>
						       <span class="n">cmd</span><span class="o">-&gt;</span>
						       <span class="n">flags</span> <span class="o">&amp;</span>
						       <span class="n">TRIG_ROUND_MASK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* step 5: fix up chanlist */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_ao_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* devpriv-&gt;ao0p=0x0000; */</span>
	<span class="cm">/* ni_writew(devpriv-&gt;ao0p,AO_Configuration); */</span>

	<span class="cm">/* devpriv-&gt;ao1p=AO_Channel(1); */</span>
	<span class="cm">/* ni_writew(devpriv-&gt;ao1p,AO_Configuration); */</span>

	<span class="n">ni_release_ao_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Configuration_Start</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Disarm</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>
	<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_BC_Source_Select</span><span class="p">,</span> <span class="n">AO_Personal_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3f98</span><span class="p">,</span> <span class="n">Interrupt_B_Ack_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_BC_Source_Select</span> <span class="o">|</span> <span class="n">AO_UPDATE_Pulse_Width</span> <span class="o">|</span>
			    <span class="n">AO_TMRDACWR_Pulse_Width</span><span class="p">,</span> <span class="n">AO_Personal_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AO_Output_Control_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AO_Start_Select_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd1</span><span class="p">,</span> <span class="n">AO_Command_1_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_cmd2</span><span class="p">,</span> <span class="n">AO_Command_2_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode1</span><span class="p">,</span> <span class="n">AO_Mode_1_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode2</span><span class="p">,</span> <span class="n">AO_Mode_2_Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span> <span class="o">=</span> <span class="n">AO_Last_Gate_Disable</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_mode3</span><span class="p">,</span> <span class="n">AO_Mode_3_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ao_trigger_select</span><span class="p">,</span>
			    <span class="n">AO_Trigger_Select_Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">immediate_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">immediate_bits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ao_win_out</span><span class="p">(</span><span class="n">immediate_bits</span><span class="p">,</span> <span class="n">AO_Immediate_671x</span><span class="p">);</span>
		<span class="n">ao_win_out</span><span class="p">(</span><span class="n">CLEAR_WG</span><span class="p">,</span> <span class="n">AO_Misc_611x</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Configuration_End</span><span class="p">,</span> <span class="n">Joint_Reset_Register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* digital io */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_dio_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_dio_insn_config() chan=%d io=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span>
		     <span class="n">io_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)))</span> <span class="o">?</span> <span class="n">COMEDI_OUTPUT</span> <span class="o">:</span>
		    <span class="n">COMEDI_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_Pins_Dir_Mask</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">|=</span> <span class="n">DIO_Pins_Dir</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span> <span class="n">DIO_Control_Register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_dio_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_dio_insn_bits() mask=0x%x bits=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Perform check to make sure we&#39;re not using the</span>
<span class="cm">		   serial part of the dio */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DIO_SDIN</span> <span class="o">|</span> <span class="n">DIO_SDOUT</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_Parallel_Data_Mask</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span> <span class="o">|=</span> <span class="n">DIO_Parallel_Data_Out</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span><span class="p">,</span>
				    <span class="n">DIO_Output_Register</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIO_Parallel_Input_Register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_m_series_dio_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_m_series_dio_insn_config() chan=%d io=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span>
		     <span class="n">io_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)))</span> <span class="o">?</span> <span class="n">COMEDI_OUTPUT</span> <span class="o">:</span>
		    <span class="n">COMEDI_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ni_writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">,</span> <span class="n">M_Offset_DIO_Direction</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_m_series_dio_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_m_series_dio_insn_bits() mask=0x%x bits=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">M_Offset_Static_Digital_Output</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">M_Offset_Static_Digital_Input</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_cdio_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sources</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* step 1: make sure trigger sources are trivially valid */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">;</span>
	<span class="n">sources</span> <span class="o">=</span> <span class="n">TRIG_INT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">&amp;=</span> <span class="n">sources</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">&amp;=</span> <span class="n">TRIG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* step 2: make sure trigger sources are unique... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">!=</span> <span class="n">TRIG_INT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">!=</span> <span class="n">TRIG_EXT</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">!=</span> <span class="n">TRIG_NOW</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">!=</span> <span class="n">TRIG_NONE</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* ... and mutually compatible */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* step 3: make sure arguments are trivially compatible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_src</span> <span class="o">==</span> <span class="n">TRIG_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">start_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span> <span class="o">==</span> <span class="n">TRIG_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">CR_PACK_FLAGS</span><span class="p">(</span><span class="n">CDO_Sample_Source_Select_Mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">CR_INVERT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_src</span> <span class="o">==</span> <span class="n">TRIG_NOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">convert_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_end_arg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_src</span> <span class="o">==</span> <span class="n">TRIG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* step 4: fix up any arguments */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* step 5: check chanlist */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">chanlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_cdio_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cdo_mode_bits</span> <span class="o">=</span> <span class="n">CDO_FIFO_Mode_Bit</span> <span class="o">|</span> <span class="n">CDO_Halt_On_Error_Bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_Reset_Bit</span><span class="p">,</span> <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRIG_EXT</span>:
		<span class="n">cdo_mode_bits</span> <span class="o">|=</span>
		    <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">CDO_Sample_Source_Select_Mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scan_begin_arg</span> <span class="o">&amp;</span> <span class="n">CR_INVERT</span><span class="p">)</span>
		<span class="n">cdo_mode_bits</span> <span class="o">|=</span> <span class="n">CDO_Polarity_Bit</span><span class="p">;</span>
	<span class="n">ni_writel</span><span class="p">(</span><span class="n">cdo_mode_bits</span><span class="p">,</span> <span class="n">M_Offset_CDO_Mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">M_Offset_CDO_FIFO_Data</span><span class="p">);</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_SW_Update_Bit</span><span class="p">,</span> <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">,</span> <span class="n">M_Offset_CDO_Mask_Enable</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;attempted to run digital output command with no lines configured as outputs&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_request_cdo_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_cdo_inttrig</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_cdo_inttrig</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trignum</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* read alloc the entire buffer */</span>
	<span class="n">comedi_buf_read_alloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>

<span class="cp">#ifdef PCIDMA</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mite_prep_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">mite_dma_arm</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG: no cdo mite channel?&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm">* XXX not sure what interrupt C group does</span>
<span class="cm">* ni_writeb(Interrupt_Group_C_Enable_Bit,</span>
<span class="cm">* M_Offset_Interrupt_C_Enable); wait for dma to fill output fifo</span>
<span class="cm">*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ni_readl</span><span class="p">(</span><span class="n">M_Offset_CDIO_Status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CDO_FIFO_Full_Bit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma failed to fill cdo fifo!&quot;</span><span class="p">);</span>
		<span class="n">ni_cdio_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_Arm_Bit</span> <span class="o">|</span> <span class="n">CDO_Error_Interrupt_Enable_Set_Bit</span> <span class="o">|</span>
		  <span class="n">CDO_Empty_FIFO_Interrupt_Enable_Set_Bit</span><span class="p">,</span>
		  <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_cdio_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_Disarm_Bit</span> <span class="o">|</span> <span class="n">CDO_Error_Interrupt_Enable_Clear_Bit</span> <span class="o">|</span>
		  <span class="n">CDO_Empty_FIFO_Interrupt_Enable_Clear_Bit</span> <span class="o">|</span>
		  <span class="n">CDO_FIFO_Request_Interrupt_Enable_Clear_Bit</span><span class="p">,</span>
		  <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">* XXX not sure what interrupt C group does ni_writeb(0,</span>
<span class="cm">* M_Offset_Interrupt_C_Enable);</span>
<span class="cm">*/</span>
	<span class="n">ni_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M_Offset_CDO_Mask_Enable</span><span class="p">);</span>
	<span class="n">ni_release_cdo_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_cdio_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cdio_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_DIO_SUBDEV</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">cdo_mite_status</span> <span class="o">=</span>
		    <span class="n">mite_get_status</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdo_mite_status</span> <span class="o">&amp;</span> <span class="n">CHSR_LINKC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">CHOR_CLRLC</span><span class="p">,</span>
			       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite</span><span class="o">-&gt;</span><span class="n">mite_io_addr</span> <span class="o">+</span>
			       <span class="n">MITE_CHOR</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">mite_sync_output_dma</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">cdo_mite_chan</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">cdio_status</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">M_Offset_CDIO_Status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdio_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CDO_Overrun_Bit</span> <span class="o">|</span> <span class="n">CDO_Underflow_Bit</span><span class="p">))</span> <span class="p">{</span>
<span class="cm">/* printk(&quot;cdio error: statux=0x%x\n&quot;, cdio_status); */</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_Error_Interrupt_Confirm_Bit</span><span class="p">,</span> <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>	<span class="cm">/*  XXX just guessing this is needed and does something useful */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdio_status</span> <span class="o">&amp;</span> <span class="n">CDO_FIFO_Empty_Bit</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* printk(&quot;cdio fifo empty\n&quot;); */</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_Empty_FIFO_Interrupt_Enable_Clear_Bit</span><span class="p">,</span>
			  <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>
<span class="cm">/* s-&gt;async-&gt;events |= COMEDI_CB_EOA; */</span>
	<span class="p">}</span>
	<span class="n">ni_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_serial_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte_out</span><span class="p">,</span> <span class="n">byte_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SERIAL_CLOCK</span>:

<span class="cp">#ifdef DEBUG_DIO</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SPI serial clock Config cd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_hw_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">|=</span> <span class="n">DIO_HW_Serial_Enable</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SERIAL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_hw_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DIO_HW_Serial_Enable</span> <span class="o">|</span>
						  <span class="n">DIO_Software_Serial_Control</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERIAL_DISABLED</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">SERIAL_600NS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Warning: this clock speed is too fast to reliably</span>
<span class="cm">			   control SCXI. */</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_HW_Serial_Timebase</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">|=</span> <span class="n">Slow_Internal_Timebase</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_Serial_Out_Divide_By_2</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERIAL_600NS</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">SERIAL_1_2US</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_HW_Serial_Timebase</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">|=</span> <span class="n">Slow_Internal_Timebase</span> <span class="o">|</span>
			    <span class="n">DIO_Serial_Out_Divide_By_2</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERIAL_1_2US</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">SERIAL_10US</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">|=</span> <span class="n">DIO_HW_Serial_Timebase</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">|=</span> <span class="n">Slow_Internal_Timebase</span> <span class="o">|</span>
			    <span class="n">DIO_Serial_Out_Divide_By_2</span><span class="p">;</span>
			<span class="cm">/* Note: DIO_Serial_Out_Divide_By_2 only affects</span>
<span class="cm">			   600ns/1.2us. If you turn divide_by_2 off with the</span>
<span class="cm">			   slow clock, you will still get 10us, except then</span>
<span class="cm">			   all your delays are wrong. */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERIAL_10US</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DIO_HW_Serial_Enable</span> <span class="o">|</span>
						  <span class="n">DIO_Software_Serial_Control</span><span class="p">);</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_hw_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span>
				    <span class="n">DIO_Control_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span><span class="p">,</span>
				    <span class="n">Clock_and_FOUT_Register</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INSN_CONFIG_BIDIRECTIONAL_DATA</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">byte_out</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_hw_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ni_serial_hw_readwrite8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">byte_out</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">byte_in</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ni_serial_sw_readwrite8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">byte_out</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">byte_in</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_serial_insn_config: serial disabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte_in</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_serial_hw_readwrite8</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_out</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_serial_hw_readwrite8: outputting 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_out</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_Serial_Data_Mask</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span> <span class="o">|=</span> <span class="n">DIO_Serial_Data_Out</span><span class="p">(</span><span class="n">data_out</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span><span class="p">,</span> <span class="n">DIO_Output_Register</span><span class="p">);</span>

	<span class="n">status1</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Joint_Status_1_Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">DIO_Serial_IO_In_Progress_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">|=</span> <span class="n">DIO_HW_Serial_Start</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span> <span class="n">DIO_Control_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_HW_Serial_Start</span><span class="p">;</span>

	<span class="cm">/* Wait until STC says we&#39;re done, but don&#39;t loop infinitely. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">status1</span> <span class="o">=</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">Joint_Status_1_Register</span><span class="p">))</span> <span class="o">&amp;</span>
	       <span class="n">DIO_Serial_IO_In_Progress_St</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Delay one bit per loop */</span>
		<span class="n">udelay</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;ni_serial_hw_readwrite8: SPI serial I/O didn&#39;t finish in time!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">Error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Delay for last bit. This delay is absolutely necessary, because</span>
<span class="cm">	   DIO_Serial_IO_In_Progress_St goes high one bit too early. */</span>
	<span class="n">udelay</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_in</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data_in</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIO_Serial_Input_Register</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG_DIO</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_serial_hw_readwrite8: inputted 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">data_in</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="nl">Error:</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span> <span class="n">DIO_Control_Register</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_serial_sw_readwrite8</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_out</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_serial_sw_readwrite8: outputting 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_out</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Wait for one bit before transfer */</span>
	<span class="n">udelay</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">mask</span><span class="p">;</span> <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Output current bit; note that we cannot touch s-&gt;state</span>
<span class="cm">		   because it is a per-subdevice field, and serial is</span>
<span class="cm">		   a separate subdevice from DIO. */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_SDOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_out</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span> <span class="o">|=</span> <span class="n">DIO_SDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_output</span><span class="p">,</span>
				    <span class="n">DIO_Output_Register</span><span class="p">);</span>

		<span class="cm">/* Assert SDCLK (active low, inverted), wait for half of</span>
<span class="cm">		   the delay, deassert SDCLK, and wait for the other half. */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">|=</span> <span class="n">DIO_Software_Serial_Control</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span>
				    <span class="n">DIO_Control_Register</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">);</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIO_Software_Serial_Control</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span>
				    <span class="n">DIO_Control_Register</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">((</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">);</span>

		<span class="cm">/* Input current bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">DIO_Parallel_Input_Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DIO_SDIN</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cm">/*			printk(&quot;DIO_P_I_R: 0x%x\n&quot;, devpriv-&gt;stc_readw(dev, DIO_Parallel_Input_Register)); */</span>
			<span class="n">input</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG_DIO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_serial_sw_readwrite8: inputted 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_in</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data_in</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mio_common_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_gpct_device_destroy</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">&amp;&amp;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">has_8255</span><span class="p">)</span>
		<span class="n">subdev_8255_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_8255_DIO_SUBDEV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_ao_67xx</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_ao_win_outw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AO_Channel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0</span><span class="p">,</span>
			       <span class="n">AO_Configuration_2_67xx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ao_win_out</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">AO_Later_Single_Point_Updates</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ni_gpct_to_stc_register</span><span class="p">(</span><span class="k">enum</span> <span class="n">ni_gpct_register</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">stc_register</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Autoincrement_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Autoincrement_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Autoincrement_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Autoincrement_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Command_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Command_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Command_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Command_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_HW_Save_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_HW_Save_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_HW_Save_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_HW_Save_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_SW_Save_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Save_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_SW_Save_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Save_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Mode_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Mode_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Mode_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Mode_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_LoadA_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Load_A_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_LoadA_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Load_A_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_LoadB_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Load_B_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_LoadB_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Load_B_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Input_Select_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Input_Select_Register</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Input_Select_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Input_Select_Register</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G01_Status_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">G_Status_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G01_Joint_Reset_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Joint_Reset_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G01_Joint_Status1_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Joint_Status_1_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G01_Joint_Status2_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Joint_Status_2_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Interrupt_Acknowledge_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Interrupt_A_Ack_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Interrupt_Acknowledge_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Interrupt_B_Ack_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Status_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">AI_Status_1_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Status_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">AO_Status_1_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Interrupt_Enable_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Interrupt_A_Enable_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Interrupt_Enable_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unhandled register 0x%x in switch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">stc_register</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_gpct_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bits</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ni_gpct_register</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stc_register</span><span class="p">;</span>
	<span class="cm">/* bits in the join reset register which are relevant to counters */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">gpct_joint_reset_mask</span> <span class="o">=</span> <span class="n">G0_Reset</span> <span class="o">|</span> <span class="n">G1_Reset</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">gpct_interrupt_a_enable_mask</span> <span class="o">=</span>
	    <span class="n">G0_Gate_Interrupt_Enable</span> <span class="o">|</span> <span class="n">G0_TC_Interrupt_Enable</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">gpct_interrupt_b_enable_mask</span> <span class="o">=</span>
	    <span class="n">G1_Gate_Interrupt_Enable</span> <span class="o">|</span> <span class="n">G1_TC_Interrupt_Enable</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* m-series-only registers */</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Counting_Mode_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G0_Counting_Mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Counting_Mode_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G1_Counting_Mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Second_Gate_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G0_Second_Gate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Second_Gate_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G1_Second_Gate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_DMA_Config_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G0_DMA_Config</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_DMA_Config_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G1_DMA_Config</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G0_ABZ_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G0_MSeries_ABZ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_ABZ_Reg</span>:
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_G1_MSeries_ABZ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* 32 bit registers */</span>
	<span class="k">case</span> <span class="n">NITIO_G0_LoadA_Reg</span>:
	<span class="k">case</span> <span class="n">NITIO_G1_LoadA_Reg</span>:
	<span class="k">case</span> <span class="n">NITIO_G0_LoadB_Reg</span>:
	<span class="k">case</span> <span class="n">NITIO_G1_LoadB_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">ni_gpct_to_stc_register</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">stc_register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* 16 bit registers */</span>
	<span class="k">case</span> <span class="n">NITIO_G0_Interrupt_Enable_Reg</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpct_interrupt_a_enable_mask</span><span class="p">);</span>
		<span class="n">ni_set_bitfield</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_A_Enable_Register</span><span class="p">,</span>
				<span class="n">gpct_interrupt_a_enable_mask</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_Interrupt_Enable_Reg</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpct_interrupt_b_enable_mask</span><span class="p">);</span>
		<span class="n">ni_set_bitfield</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Interrupt_B_Enable_Register</span><span class="p">,</span>
				<span class="n">gpct_interrupt_b_enable_mask</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G01_Joint_Reset_Reg</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpct_joint_reset_mask</span><span class="p">);</span>
		<span class="cm">/* fall-through */</span>
	<span class="nl">default:</span>
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">ni_gpct_to_stc_register</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">stc_register</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ni_gpct_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">ni_gpct_register</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stc_register</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* m-series only registers */</span>
	<span class="k">case</span> <span class="n">NITIO_G0_DMA_Status_Reg</span>:
		<span class="k">return</span> <span class="n">ni_readw</span><span class="p">(</span><span class="n">M_Offset_G0_DMA_Status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NITIO_G1_DMA_Status_Reg</span>:
		<span class="k">return</span> <span class="n">ni_readw</span><span class="p">(</span><span class="n">M_Offset_G1_DMA_Status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* 32 bit registers */</span>
	<span class="k">case</span> <span class="n">NITIO_G0_HW_Save_Reg</span>:
	<span class="k">case</span> <span class="n">NITIO_G1_HW_Save_Reg</span>:
	<span class="k">case</span> <span class="n">NITIO_G0_SW_Save_Reg</span>:
	<span class="k">case</span> <span class="n">NITIO_G1_SW_Save_Reg</span>:
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">ni_gpct_to_stc_register</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">stc_register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* 16 bit registers */</span>
	<span class="nl">default:</span>
		<span class="n">stc_register</span> <span class="o">=</span> <span class="n">ni_gpct_to_stc_register</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">stc_register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_freq_out_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">&amp;</span> <span class="n">FOUT_Divider_mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_freq_out_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FOUT_Enable</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span><span class="p">,</span>
			    <span class="n">Clock_and_FOUT_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FOUT_Divider_mask</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">|=</span> <span class="n">FOUT_Divider</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">|=</span> <span class="n">FOUT_Enable</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span><span class="p">,</span>
			    <span class="n">Clock_and_FOUT_Register</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_set_freq_out_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock_source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clock_source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NI_FREQ_OUT_TIMEBASE_1_DIV_2_CLOCK_SRC</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FOUT_Timebase_Select</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NI_FREQ_OUT_TIMEBASE_2_CLOCK_SRC</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">|=</span> <span class="n">FOUT_Timebase_Select</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span><span class="p">,</span>
			    <span class="n">Clock_and_FOUT_Register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni_get_freq_out_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">clock_source</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">clock_period_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">&amp;</span> <span class="n">FOUT_Timebase_Select</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">NI_FREQ_OUT_TIMEBASE_2_CLOCK_SRC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clock_period_ns</span> <span class="o">=</span> <span class="n">TIMEBASE_2_NS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">NI_FREQ_OUT_TIMEBASE_1_DIV_2_CLOCK_SRC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clock_period_ns</span> <span class="o">=</span> <span class="n">TIMEBASE_1_NS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_freq_out_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_CLOCK_SRC</span>:
		<span class="k">return</span> <span class="n">ni_set_freq_out_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_CLOCK_SRC</span>:
		<span class="n">ni_get_freq_out_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_alloc_private</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_private</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ni_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">window_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">soft_reg_copy_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">mite_channel_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni_E_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ni_gpct_variant</span> <span class="n">counter_variant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span> <span class="o">&gt;</span> <span class="n">MAX_N_AO_CHAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bug! boardtype.n_aochan &gt; MAX_N_AO_CHAN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_subdevices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NI_NUM_SUBDEVICES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* analog input subdevice */</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">n_adchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span>
		    <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_DIFF</span> <span class="o">|</span> <span class="n">SDF_DITHER</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">!=</span> <span class="n">ni_reg_611x</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_GROUND</span> <span class="o">|</span> <span class="n">SDF_COMMON</span> <span class="o">|</span> <span class="n">SDF_OTHER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">adbits</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_LSAMPL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_SOFT_CALIBRATED</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_adchan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">adbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">ni_range_lkup</span><span class="p">[</span><span class="n">boardtype</span><span class="p">.</span><span class="n">gainlkup</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_insn_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_insn_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_cmdtest</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_cmd</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_reset</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_poll</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">munge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ai_munge</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async_dma_dir</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* analog output subdevice */</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AO_SUBDEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AO</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_DEGLITCH</span> <span class="o">|</span> <span class="n">SDF_GROUND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_SOFT_CALIBRATED</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">aobits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">ao_range_table</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_insn_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_insn_write_671x</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_insn_write</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_insn_config</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">async_dma_dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">ao_fifo_depth</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_subdev</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span> <span class="n">SDF_CMD_WRITE</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_cmd</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_cmdtest</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">munge</span> <span class="o">=</span> <span class="n">ni_ao_munge</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_ao_reset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_67xx_mask</span><span class="p">))</span>
		<span class="n">init_ao_67xx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="cm">/* digital i/o subdevice */</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_DIO_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DIO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_READABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* all bits input */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_digital</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">num_p0_dio_channels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">|=</span>
		    <span class="n">SDF_LSAMPL</span> <span class="o">|</span> <span class="n">SDF_CMD_WRITE</span> <span class="cm">/* | SDF_CMD_READ */</span> <span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_m_series_dio_insn_bits</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_m_series_dio_insn_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_cdio_cmd</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_cdio_cmdtest</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_cdio_cancel</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async_dma_dir</span> <span class="o">=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span>

		<span class="n">ni_writel</span><span class="p">(</span><span class="n">CDO_Reset_Bit</span> <span class="o">|</span> <span class="n">CDI_Reset_Bit</span><span class="p">,</span> <span class="n">M_Offset_CDIO_Command</span><span class="p">);</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">,</span> <span class="n">M_Offset_DIO_Direction</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_dio_insn_bits</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_dio_insn_config</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span> <span class="o">=</span> <span class="n">DIO_Pins_Dir</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_bits</span><span class="p">);</span>
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">dio_control</span><span class="p">,</span> <span class="n">DIO_Control_Register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* 8255 device */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_8255_DIO_SUBDEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">has_8255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">subdev_8255_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ni_8255_callback</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* formerly general purpose counter/timer device, but no longer used */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_UNUSED_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>

	<span class="cm">/* calibration subdevice -- ai and ao */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_CALIBRATION_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_CALIB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  internal PWM analog output used for AI nonlinearity calibration */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_m_series_pwm_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">M_Offset_Cal_PWM</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">ni_reg_6143</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  internal PWM analog output used for AI nonlinearity calibration */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_6143_pwm_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_calib_insn_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_calib_insn_write</span><span class="p">;</span>
		<span class="n">caldac_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* EEPROM */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_EEPROM_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_MEMORY</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">M_SERIES_EEPROM_SIZE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_m_series_eeprom_insn_read</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_eeprom_insn_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PFI */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_PFI_DIO_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DIO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">M_Offset_PFI_DO</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PFI_OUTPUT_SELECT_REGS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pfi_output_select_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="n">M_Offset_PFI_Output_Select</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pfi_insn_bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_pfi_insn_config</span><span class="p">;</span>
	<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IO_Bidirection_Pin_Register</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* cs5529 calibration adc */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_CS5529_CALIBRATION_SUBDEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_67xx_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_AI</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_DIFF</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
		<span class="cm">/*  one channel for each analog output channel */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">range_unknown</span><span class="p">;</span>	<span class="cm">/* XXX */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="n">cs5529_ai_insn_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">init_cs5529</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Serial */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_SERIAL_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_SERIAL</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="n">ni_serial_insn_config</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_interval_ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">serial_hw_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* RTSI */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_RTSI_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_DIO</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_INTERNAL</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">=</span> <span class="n">ni_rtsi_insn_bits</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="n">ni_rtsi_insn_config</span><span class="p">;</span>
	<span class="n">ni_rtsi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">counter_variant</span> <span class="o">=</span> <span class="n">ni_gpct_variant_m_series</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">counter_variant</span> <span class="o">=</span> <span class="n">ni_gpct_variant_e_series</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span> <span class="o">=</span> <span class="n">ni_gpct_device_construct</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ni_gpct_write_register</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ni_gpct_read_register</span><span class="p">,</span>
							<span class="n">counter_variant</span><span class="p">,</span>
							<span class="n">NUM_GPCT</span><span class="p">);</span>
	<span class="cm">/* General purpose counters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_GPCT</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_GPCT_SUBDEV</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_COUNTER</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span>
		    <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span> <span class="o">|</span> <span class="n">SDF_LSAMPL</span> <span class="o">|</span> <span class="n">SDF_CMD_READ</span>
		    <span class="cm">/* | SDF_CMD_WRITE */</span> <span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_gpct_insn_read</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_gpct_insn_write</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_gpct_insn_config</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_gpct_cmd</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_gpct_cmdtest</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_gpct_cancel</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">async_dma_dir</span> <span class="o">=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chip_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">counter_index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">ni_tio_init_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">counter_dev</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Frequency output */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_FREQ_OUT_SUBDEV</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMEDI_SUBD_COUNTER</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">=</span> <span class="n">SDF_READABLE</span> <span class="o">|</span> <span class="n">SDF_WRITABLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_freq_out_insn_read</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_freq_out_insn_write</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni_freq_out_insn_config</span><span class="p">;</span>

	<span class="cm">/* ai configuration */</span>
	<span class="n">ni_ai_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AI_SUBDEV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  BEAM is this needed for PCI-6143 ?? */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">=</span>
		    <span class="n">Slow_Internal_Time_Divide_By_2</span> <span class="o">|</span>
		    <span class="n">Slow_Internal_Timebase</span> <span class="o">|</span>
		    <span class="n">Clock_To_Board_Divide_By_2</span> <span class="o">|</span>
		    <span class="n">Clock_To_Board</span> <span class="o">|</span>
		    <span class="n">AI_Output_Divide_By_2</span> <span class="o">|</span> <span class="n">AO_Output_Divide_By_2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span> <span class="o">=</span>
		    <span class="n">Slow_Internal_Time_Divide_By_2</span> <span class="o">|</span>
		    <span class="n">Slow_Internal_Timebase</span> <span class="o">|</span>
		    <span class="n">Clock_To_Board_Divide_By_2</span> <span class="o">|</span> <span class="n">Clock_To_Board</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout</span><span class="p">,</span>
			    <span class="n">Clock_and_FOUT_Register</span><span class="p">);</span>

	<span class="cm">/* analog output configuration */</span>
	<span class="n">ni_ao_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">NI_AO_SUBDEV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">IRQ_POLARITY</span> <span class="o">?</span> <span class="n">Interrupt_Output_Polarity</span> <span class="o">:</span>
				     <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Interrupt_Output_On_3_Pins</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">Interrupt_A_Enable</span> <span class="o">|</span> <span class="n">Interrupt_B_Enable</span> <span class="o">|</span>
				    <span class="n">Interrupt_A_Output_Select</span><span class="p">(</span><span class="n">interrupt_pin</span>
							      <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span> <span class="o">|</span>
				    <span class="n">Interrupt_B_Output_Select</span><span class="p">(</span><span class="n">interrupt_pin</span>
							      <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)),</span>
				    <span class="n">Interrupt_Control_Register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* DMA setup */</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">ai_ao_select_reg</span><span class="p">,</span> <span class="n">AI_AO_Select</span><span class="p">);</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">g0_g1_select_reg</span><span class="p">,</span> <span class="n">G0_G1_Select</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_6xxx_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Magic_611x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">n_aochan</span><span class="p">;</span> <span class="o">++</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">M_Offset_AO_Waveform_Order</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
			<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span>
				  <span class="n">M_Offset_AO_Reference_Attenuation</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">M_Offset_AO_Calibration</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_8255_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Port_A</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ni_readb</span><span class="p">(</span><span class="n">Port_A</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	presents the EEPROM as a subdevice</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_eeprom_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni_read_eeprom</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	reads bytes out of eeprom</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitstring</span><span class="p">;</span>

	<span class="n">bitstring</span> <span class="o">=</span> <span class="mh">0x0300</span> <span class="o">|</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">Serial_Command</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x04</span> <span class="o">|</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">bitstring</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			  <span class="n">Serial_Command</span><span class="p">);</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x05</span> <span class="o">|</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">bitstring</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			  <span class="n">Serial_Command</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bitstring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">Serial_Command</span><span class="p">);</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">Serial_Command</span><span class="p">);</span>
		<span class="n">bitstring</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ni_readb</span><span class="p">(</span><span class="n">XXX_Status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PROMOUT</span><span class="p">)</span> <span class="o">?</span> <span class="n">bit</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">Serial_Command</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bitstring</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_m_series_eeprom_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">eeprom_buffer</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_get_pwm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pwm_up_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pwm_down_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_m_series_pwm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">up_count</span><span class="p">,</span> <span class="n">down_count</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_OUTPUT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
			<span class="n">up_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">up_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">up_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">-</span>
			     <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
			<span class="n">down_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">down_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">down_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">-</span>
			     <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">down_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">up_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">down_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">MSeries_Cal_PWM_High_Time_Bits</span><span class="p">(</span><span class="n">up_count</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">MSeries_Cal_PWM_Low_Time_Bits</span><span class="p">(</span><span class="n">down_count</span><span class="p">),</span>
			  <span class="n">M_Offset_Cal_PWM</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pwm_up_count</span> <span class="o">=</span> <span class="n">up_count</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pwm_down_count</span> <span class="o">=</span> <span class="n">down_count</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_PWM_OUTPUT</span>:
		<span class="k">return</span> <span class="n">ni_get_pwm_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_6143_pwm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">up_count</span><span class="p">,</span> <span class="n">down_count</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_OUTPUT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
			<span class="n">up_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">up_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">up_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">-</span>
			     <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_NEAREST</span>:
			<span class="n">down_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
			     <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_DOWN</span>:
			<span class="n">down_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRIG_ROUND_UP</span>:
			<span class="n">down_count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">-</span>
			     <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">down_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">up_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">down_count</span> <span class="o">*</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">up_count</span><span class="p">,</span> <span class="n">Calibration_HighTime_6143</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pwm_up_count</span> <span class="o">=</span> <span class="n">up_count</span><span class="p">;</span>
		<span class="n">ni_writel</span><span class="p">(</span><span class="n">down_count</span><span class="p">,</span> <span class="n">Calibration_LowTime_6143</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pwm_down_count</span> <span class="o">=</span> <span class="n">down_count</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_PWM_OUTPUT</span>:
		<span class="k">return</span> <span class="n">ni_get_pwm_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_write_caldac</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">	calibration subdevice</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_calib_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ni_write_caldac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_calib_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldacs</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_mb88341</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_dac8800</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_dac8043</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_ad8522</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_ad8804</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_ad8842</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">caldac_struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">n_chans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">packbits</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">caldac_struct</span> <span class="n">caldacs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">mb88341</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pack_mb88341</span><span class="p">},</span>
	<span class="p">[</span><span class="n">dac8800</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pack_dac8800</span><span class="p">},</span>
	<span class="p">[</span><span class="n">dac8043</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">pack_dac8043</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ad8522</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">pack_ad8522</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ad8804</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pack_ad8804</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ad8842</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pack_ad8842</span><span class="p">},</span>
	<span class="p">[</span><span class="n">ad8804_debug</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pack_ad8804</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">caldac_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_dacs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_chans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diffbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">caldac</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">caldac_none</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">n_bits</span> <span class="o">=</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_bits</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">caldac</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">caldac_none</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_bits</span> <span class="o">!=</span> <span class="n">n_bits</span><span class="p">)</span>
			<span class="n">diffbits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">n_chans</span> <span class="o">+=</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_chans</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n_dacs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">n_chans</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diffbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">maxdata_list</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_chans</span> <span class="o">&gt;</span> <span class="n">MAX_N_CALDACS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUG! MAX_N_CALDACS too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span> <span class="o">=</span> <span class="n">maxdata_list</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldac_maxdata_list</span><span class="p">;</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_dacs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">caldac</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_chans</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">maxdata_list</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ni_write_caldac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">caldac</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ni_write_caldac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_write_caldac</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loadbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bitstring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="cm">/* printk(&quot;ni_write_caldac: chan=%d val=%d\n&quot;,addr,val); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldacs</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">caldacs</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">boardtype</span><span class="p">.</span><span class="n">caldac</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">caldac_none</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_chans</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">packbits</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitstring</span><span class="p">);</span>
			<span class="n">loadbit</span> <span class="o">=</span> <span class="n">SerDacLd</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="cm">/* printk(&quot;caldac: using i=%d addr=%d %x\n&quot;,i,addr,bitstring); */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="n">caldacs</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">n_chans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">bit</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_writeb</span><span class="p">(((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">bitstring</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Serial_Command</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">1</span> <span class="o">|</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">bitstring</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Serial_Command</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="n">loadbit</span><span class="p">,</span> <span class="n">Serial_Command</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ni_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Serial_Command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_mb88341</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   Fujitsu MB 88341</span>
<span class="cm">	   Note that address bits are reversed.  Thanks to</span>
<span class="cm">	   Ingo Keen for noticing this.</span>

<span class="cm">	   Note also that the 88341 expects address values from</span>
<span class="cm">	   1-12, whereas we use channel numbers 0-11.  The NI</span>
<span class="cm">	   docs use 1-12, also, so be careful here.</span>
<span class="cm">	 */</span>
	<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bitstring</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_dac8800</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">bitstring</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">11</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_dac8043</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">bitstring</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_ad8522</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">bitstring</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">?</span> <span class="mh">0xc000</span> <span class="o">:</span> <span class="mh">0xa000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_ad8804</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">bitstring</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pack_ad8842</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">bitstring</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> *	Read the GPCTs current value.</span>
<span class="c"> */</span>
<span class="c">static int GPCT_G_Watch(struct comedi_device *dev, int chan)</span>
<span class="c">{</span>
<span class="c">	unsigned int hi1, hi2, lo;</span>

<span class="c">	devpriv-&gt;gpct_command[chan] &amp;= ~G_Save_Trace;</span>
<span class="c">	devpriv-&gt;stc_writew(dev, devpriv-&gt;gpct_command[chan],</span>
<span class="c">			    G_Command_Register(chan));</span>

<span class="c">	devpriv-&gt;gpct_command[chan] |= G_Save_Trace;</span>
<span class="c">	devpriv-&gt;stc_writew(dev, devpriv-&gt;gpct_command[chan],</span>
<span class="c">			    G_Command_Register(chan));</span>

<span class="c">	/* This procedure is used because the two registers cannot</span>
<span class="c">	 * be read atomically. */</span>
<span class="c">	do {</span>
<span class="c">		hi1 = devpriv-&gt;stc_readw(dev, G_Save_Register_High(chan));</span>
<span class="c">		lo = devpriv-&gt;stc_readw(dev, G_Save_Register_Low(chan));</span>
<span class="c">		hi2 = devpriv-&gt;stc_readw(dev, G_Save_Register_High(chan));</span>
<span class="c">	} while (hi1 != hi2);</span>

<span class="c">	return (hi1 &lt;&lt; 16) | lo;</span>
<span class="c">}</span>

<span class="c">static void GPCT_Reset(struct comedi_device *dev, int chan)</span>
<span class="c">{</span>
<span class="c">	int temp_ack_reg = 0;</span>

<span class="c">	/* printk(&quot;GPCT_Reset...&quot;); */</span>
<span class="c">	devpriv-&gt;gpct_cur_operation[chan] = GPCT_RESET;</span>

<span class="c">	switch (chan) {</span>
<span class="c">	case 0:</span>
<span class="c">		devpriv-&gt;stc_writew(dev, G0_Reset, Joint_Reset_Register);</span>
<span class="c">		ni_set_bits(dev, Interrupt_A_Enable_Register,</span>
<span class="c">			    G0_TC_Interrupt_Enable, 0);</span>
<span class="c">		ni_set_bits(dev, Interrupt_A_Enable_Register,</span>
<span class="c">			    G0_Gate_Interrupt_Enable, 0);</span>
<span class="c">		temp_ack_reg |= G0_Gate_Error_Confirm;</span>
<span class="c">		temp_ack_reg |= G0_TC_Error_Confirm;</span>
<span class="c">		temp_ack_reg |= G0_TC_Interrupt_Ack;</span>
<span class="c">		temp_ack_reg |= G0_Gate_Interrupt_Ack;</span>
<span class="c">		devpriv-&gt;stc_writew(dev, temp_ack_reg,</span>
<span class="c">				    Interrupt_A_Ack_Register);</span>

<span class="c">		/* problem...this interferes with the other ctr... */</span>
<span class="c">		devpriv-&gt;an_trig_etc_reg |= GPFO_0_Output_Enable;</span>
<span class="c">		devpriv-&gt;stc_writew(dev, devpriv-&gt;an_trig_etc_reg,</span>
<span class="c">				    Analog_Trigger_Etc_Register);</span>
<span class="c">		break;</span>
<span class="c">	case 1:</span>
<span class="c">		devpriv-&gt;stc_writew(dev, G1_Reset, Joint_Reset_Register);</span>
<span class="c">		ni_set_bits(dev, Interrupt_B_Enable_Register,</span>
<span class="c">			    G1_TC_Interrupt_Enable, 0);</span>
<span class="c">		ni_set_bits(dev, Interrupt_B_Enable_Register,</span>
<span class="c">			    G0_Gate_Interrupt_Enable, 0);</span>
<span class="c">		temp_ack_reg |= G1_Gate_Error_Confirm;</span>
<span class="c">		temp_ack_reg |= G1_TC_Error_Confirm;</span>
<span class="c">		temp_ack_reg |= G1_TC_Interrupt_Ack;</span>
<span class="c">		temp_ack_reg |= G1_Gate_Interrupt_Ack;</span>
<span class="c">		devpriv-&gt;stc_writew(dev, temp_ack_reg,</span>
<span class="c">				    Interrupt_B_Ack_Register);</span>

<span class="c">		devpriv-&gt;an_trig_etc_reg |= GPFO_1_Output_Enable;</span>
<span class="c">		devpriv-&gt;stc_writew(dev, devpriv-&gt;an_trig_etc_reg,</span>
<span class="c">				    Analog_Trigger_Etc_Register);</span>
<span class="c">		break;</span>
<span class="c">	}</span>

<span class="c">	devpriv-&gt;gpct_mode[chan] = 0;</span>
<span class="c">	devpriv-&gt;gpct_input_select[chan] = 0;</span>
<span class="c">	devpriv-&gt;gpct_command[chan] = 0;</span>

<span class="c">	devpriv-&gt;gpct_command[chan] |= G_Synchronized_Gate;</span>

<span class="c">	devpriv-&gt;stc_writew(dev, devpriv-&gt;gpct_mode[chan],</span>
<span class="c">			    G_Mode_Register(chan));</span>
<span class="c">	devpriv-&gt;stc_writew(dev, devpriv-&gt;gpct_input_select[chan],</span>
<span class="c">			    G_Input_Select_Register(chan));</span>
<span class="c">	devpriv-&gt;stc_writew(dev, 0, G_Autoincrement_Register(chan));</span>

<span class="c">	/* printk(&quot;exit GPCT_Reset\n&quot;); */</span>
<span class="c">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ni_tio_insn_config</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ni_tio_rinsn</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_insn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ni_tio_winsn</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="cm">/* const struct comedi_cmd *cmd = &amp;s-&gt;async-&gt;cmd; */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_request_gpct_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter_index</span><span class="p">,</span>
					      <span class="n">COMEDI_INPUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;no dma channel available for use by counter&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_tio_acknowledge_and_confirm</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ni_e_series_enable_second_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_tio_cmd</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_cmdtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ni_tio_cmdtest</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_gpct_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PCIDMA</span>
	<span class="k">struct</span> <span class="n">ni_gpct</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_tio_cancel</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
	<span class="n">ni_e_series_enable_second_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ni_release_gpct_mite_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter_index</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  Programmable Function Inputs</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_m_series_set_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pfi_reg_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">array_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">source</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">source</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pfi_reg_index</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">chan</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">array_offset</span> <span class="o">=</span> <span class="n">pfi_reg_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pfi_output_select_reg</span><span class="p">[</span><span class="n">array_offset</span><span class="p">]</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="n">MSeries_PFI_Output_Select_Mask</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pfi_output_select_reg</span><span class="p">[</span><span class="n">array_offset</span><span class="p">]</span> <span class="o">|=</span>
	    <span class="n">MSeries_PFI_Output_Select_Bits</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">pfi_output_select_reg</span><span class="p">[</span><span class="n">array_offset</span><span class="p">],</span>
		  <span class="n">M_Offset_PFI_Output_Select</span><span class="p">(</span><span class="n">pfi_reg_index</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_old_set_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  pre-m-series boards have fixed signals on pfi pins */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">!=</span> <span class="n">ni_old_get_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_set_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ni_m_series_set_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ni_old_set_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ni_m_series_get_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">array_offset</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">MSeries_PFI_Output_Select_Source</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
						<span class="n">devpriv</span><span class="o">-&gt;</span>
						<span class="n">pfi_output_select_reg</span>
						<span class="p">[</span><span class="n">array_offset</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ni_old_get_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  pre-m-series boards have fixed signals on pfi pins */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_AI_START1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_AI_START2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_AI_CONVERT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_G_SRC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_G_GATE1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_AO_UPDATE_N</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_AO_START1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_AI_START_PULSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_G_SRC0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="k">return</span> <span class="n">NI_PFI_OUTPUT_G_GATE0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bug, unhandled case in switch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ni_get_pfi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ni_m_series_get_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ni_old_get_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_config_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pfi_channel</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ni_pfi_filter_select</span> <span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">ni_readl</span><span class="p">(</span><span class="n">M_Offset_PFI_Filter</span><span class="p">);</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSeries_PFI_Filter_Select_Mask</span><span class="p">(</span><span class="n">pfi_channel</span><span class="p">);</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="n">MSeries_PFI_Filter_Select_Bits</span><span class="p">(</span><span class="n">pfi_channel</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
	<span class="n">ni_writel</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">M_Offset_PFI_Filter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pfi_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ni_writew</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">M_Offset_PFI_DO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni_readw</span><span class="p">(</span><span class="n">M_Offset_PFI_DI</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_pfi_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMEDI_OUTPUT</span>:
		<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IO_Bidirection_Pin_Register</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_INPUT</span>:
		<span class="n">ni_set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IO_Bidirection_Pin_Register</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">io_bidirection_pin_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chan</span><span class="p">))</span> <span class="o">?</span>
		    <span class="n">COMEDI_OUTPUT</span> <span class="o">:</span> <span class="n">COMEDI_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_ROUTING</span>:
		<span class="k">return</span> <span class="n">ni_set_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_ROUTING</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni_get_pfi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_FILTER</span>:
		<span class="k">return</span> <span class="n">ni_config_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  NI RTSI Bus Functions</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni_rtsi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  Initialises the RTSI bus signal switch to a default state */</span>

	<span class="cm">/*  Set clock mode to internal */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">=</span> <span class="n">MSeries_RTSI_10MHz_Bit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ni_set_master_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NI_MIO_INTERNAL_CLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ni_set_master_clock failed, bug?&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*  default internal lines routing to RTSI bus lines */</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_a_output_reg</span> <span class="o">=</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
				  <span class="n">NI_RTSI_OUTPUT_ADR_START1</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="n">NI_RTSI_OUTPUT_ADR_START2</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				  <span class="n">NI_RTSI_OUTPUT_SCLKG</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">NI_RTSI_OUTPUT_DACUPDN</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_a_output_reg</span><span class="p">,</span>
			    <span class="n">RTSI_Trig_A_Output_Register</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span> <span class="o">=</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
				  <span class="n">NI_RTSI_OUTPUT_DA_START1</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span>
				  <span class="n">NI_RTSI_OUTPUT_G_SRC0</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">NI_RTSI_OUTPUT_G_GATE0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span> <span class="o">|=</span>
		    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">NI_RTSI_OUTPUT_RTSI_OSC</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span><span class="p">,</span>
			    <span class="n">RTSI_Trig_B_Output_Register</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">* Sets the source and direction of the 4 on board lines</span>
<span class="cm">* devpriv-&gt;stc_writew(dev, 0x0000, RTSI_Board_Register);</span>
<span class="cm">*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_rtsi_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find best multiplier/divider to try and get the PLL running at 80 MHz</span>
<span class="cm"> * given an arbitrary frequency input clock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_mseries_get_pll_parameters</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">reference_period_ns</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="o">*</span><span class="n">freq_divider</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="o">*</span><span class="n">freq_multiplier</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="o">*</span><span class="n">actual_period_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">best_div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">max_div</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mult</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">best_mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">max_mult</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">pico_per_nano</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">reference_picosec</span> <span class="o">=</span> <span class="n">reference_period_ns</span> <span class="o">*</span> <span class="n">pico_per_nano</span><span class="p">;</span>
	<span class="cm">/* m-series wants the phased-locked loop to output 80MHz, which is divided by 4 to</span>
<span class="cm">	 * 20 MHz for most timing clocks */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">target_picosec</span> <span class="o">=</span> <span class="mi">12500</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">fudge_factor_80_to_20Mhz</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_period_picosec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;=</span> <span class="n">max_div</span><span class="p">;</span> <span class="o">++</span><span class="n">div</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">mult</span> <span class="o">&lt;=</span> <span class="n">max_mult</span><span class="p">;</span> <span class="o">++</span><span class="n">mult</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">new_period_ps</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">reference_picosec</span> <span class="o">*</span> <span class="n">div</span><span class="p">)</span> <span class="o">/</span> <span class="n">mult</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">new_period_ps</span> <span class="o">-</span> <span class="n">target_picosec</span><span class="p">)</span> <span class="o">&lt;</span>
			    <span class="n">abs</span><span class="p">(</span><span class="n">best_period_picosec</span> <span class="o">-</span> <span class="n">target_picosec</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">best_period_picosec</span> <span class="o">=</span> <span class="n">new_period_ps</span><span class="p">;</span>
				<span class="n">best_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
				<span class="n">best_mult</span> <span class="o">=</span> <span class="n">mult</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_period_picosec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bug, failed to find pll parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">freq_divider</span> <span class="o">=</span> <span class="n">best_div</span><span class="p">;</span>
	<span class="o">*</span><span class="n">freq_multiplier</span> <span class="o">=</span> <span class="n">best_mult</span><span class="p">;</span>
	<span class="o">*</span><span class="n">actual_period_ns</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">best_period_picosec</span> <span class="o">*</span> <span class="n">fudge_factor_80_to_20Mhz</span> <span class="o">+</span>
	     <span class="p">(</span><span class="n">pico_per_nano</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">pico_per_nano</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="n">num_configurable_rtsi_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_mseries_set_pll_master_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">period_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">min_period_ns</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">max_period_ns</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pll_control_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">freq_divider</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">freq_multiplier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">NI_MIO_PLL_PXI10_CLOCK</span><span class="p">)</span>
		<span class="n">period_ns</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/*  these limits are somewhat arbitrary, but NI advertises 1 to 20MHz range so we&#39;ll use that */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">period_ns</span> <span class="o">&lt;</span> <span class="n">min_period_ns</span> <span class="o">||</span> <span class="n">period_ns</span> <span class="o">&gt;</span> <span class="n">max_period_ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: you must specify an input clock frequency between %i and %i nanosec &quot;</span>
		     <span class="s">&quot;for the phased-lock loop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">min_period_ns</span><span class="p">,</span> <span class="n">max_period_ns</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Use_RTSI_Clock_Bit</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span><span class="p">,</span>
			    <span class="n">RTSI_Trig_Direction_Register</span><span class="p">);</span>
	<span class="n">pll_control_bits</span> <span class="o">=</span>
	    <span class="n">MSeries_PLL_Enable_Bit</span> <span class="o">|</span> <span class="n">MSeries_PLL_VCO_Mode_75_150MHz_Bits</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">|=</span>
	    <span class="n">MSeries_Timebase1_Select_Bit</span> <span class="o">|</span> <span class="n">MSeries_Timebase3_Select_Bit</span><span class="p">;</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSeries_PLL_In_Source_Select_Mask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NI_MIO_PLL_PXI_STAR_TRIGGER_CLOCK</span>:
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">|=</span>
		    <span class="n">MSeries_PLL_In_Source_Select_Star_Trigger_Bits</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_mseries_get_pll_parameters</span><span class="p">(</span><span class="n">period_ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq_divider</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">freq_multiplier</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NI_MIO_PLL_PXI10_CLOCK</span>:
		<span class="cm">/* pxi clock is 10MHz */</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">|=</span>
		    <span class="n">MSeries_PLL_In_Source_Select_PXI_Clock10</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_mseries_get_pll_parameters</span><span class="p">(</span><span class="n">period_ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq_divider</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">freq_multiplier</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">rtsi_channel</span><span class="p">;</span>
			<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">max_rtsi_channel</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rtsi_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rtsi_channel</span> <span class="o">&lt;=</span> <span class="n">max_rtsi_channel</span><span class="p">;</span>
			     <span class="o">++</span><span class="n">rtsi_channel</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span>
				    <span class="n">NI_MIO_PLL_RTSI_CLOCK</span><span class="p">(</span><span class="n">rtsi_channel</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">|=</span>
					    <span class="n">MSeries_PLL_In_Source_Select_RTSI_Bits</span>
					    <span class="p">(</span><span class="n">rtsi_channel</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtsi_channel</span> <span class="o">&gt;</span> <span class="n">max_rtsi_channel</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ni_mseries_get_pll_parameters</span><span class="p">(</span><span class="n">period_ns</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">freq_divider</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">freq_multiplier</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">devpriv</span><span class="o">-&gt;</span>
							       <span class="n">clock_ns</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span><span class="p">,</span> <span class="n">M_Offset_Clock_and_Fout2</span><span class="p">);</span>
	<span class="n">pll_control_bits</span> <span class="o">|=</span>
	    <span class="n">MSeries_PLL_Divisor_Bits</span><span class="p">(</span><span class="n">freq_divider</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">MSeries_PLL_Multiplier_Bits</span><span class="p">(</span><span class="n">freq_multiplier</span><span class="p">);</span>

	<span class="cm">/* printk(&quot;using divider=%i, multiplier=%i for PLL. pll_control_bits = 0x%x\n&quot;,</span>
<span class="cm">	 * freq_divider, freq_multiplier, pll_control_bits); */</span>
	<span class="cm">/* printk(&quot;clock_ns=%d\n&quot;, devpriv-&gt;clock_ns); */</span>
	<span class="n">ni_writew</span><span class="p">(</span><span class="n">pll_control_bits</span><span class="p">,</span> <span class="n">M_Offset_PLL_Control</span><span class="p">);</span>
	<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
	<span class="cm">/* it seems to typically take a few hundred microseconds for PLL to lock */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ni_readw</span><span class="p">(</span><span class="n">M_Offset_PLL_Status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSeries_PLL_Locked_Bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: timed out waiting for PLL to lock to reference clock source %i with period %i ns.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">period_ns</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_set_master_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">source</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">period_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">NI_MIO_INTERNAL_CLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Use_RTSI_Clock_Bit</span><span class="p">;</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span><span class="p">,</span>
				    <span class="n">RTSI_Trig_Direction_Register</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">=</span> <span class="n">TIMEBASE_1_NS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">MSeries_Timebase1_Select_Bit</span> <span class="o">|</span>
			      <span class="n">MSeries_Timebase3_Select_Bit</span><span class="p">);</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_and_fout2</span><span class="p">,</span>
				  <span class="n">M_Offset_Clock_and_Fout2</span><span class="p">);</span>
			<span class="n">ni_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M_Offset_PLL_Control</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ni_mseries_set_pll_master_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
							       <span class="n">period_ns</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">NI_MIO_RTSI_CLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">|=</span>
				    <span class="n">Use_RTSI_Clock_Bit</span><span class="p">;</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">devpriv</span><span class="o">-&gt;</span>
						    <span class="n">rtsi_trig_direction_reg</span><span class="p">,</span>
						    <span class="n">RTSI_Trig_Direction_Register</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">period_ns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;%s: we don&#39;t handle an unspecified clock period correctly yet, returning error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">__func__</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span> <span class="o">=</span> <span class="n">period_ns</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_valid_rtsi_output_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">num_configurable_rtsi_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">old_RTSI_clock_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">NI_RTSI_OUTPUT_RTSI_OSC</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;%s: invalid source for channel=%i, channel %i is always the RTSI clock for pre-m-series boards.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">old_RTSI_clock_channel</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_ADR_START1</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_ADR_START2</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_SCLKG</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_DACUPDN</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_DA_START1</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_G_SRC0</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_G_GATE0</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_RGOUT0</span>:
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_RTSI_BRD_0</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NI_RTSI_OUTPUT_RTSI_OSC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_set_rtsi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ni_valid_rtsi_output_source</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_a_output_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTSI_Trig_Output_Mask</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_a_output_reg</span> <span class="o">|=</span>
		    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_a_output_reg</span><span class="p">,</span>
				    <span class="n">RTSI_Trig_A_Output_Register</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTSI_Trig_Output_Mask</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span> <span class="o">|=</span>
		    <span class="n">RTSI_Trig_Output_Bits</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span><span class="p">,</span>
				    <span class="n">RTSI_Trig_B_Output_Register</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ni_get_rtsi_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">RTSI_Trig_Output_Source</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_a_output_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_configurable_rtsi_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">RTSI_Trig_Output_Source</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
					       <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_b_output_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">old_RTSI_clock_channel</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NI_RTSI_OUTPUT_RTSI_OSC</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bug! should never get here?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ni_rtsi_insn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_configurable_rtsi_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">|=</span>
			    <span class="n">RTSI_Output_Bit</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span>
					     <span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span> <span class="o">!=</span>
					    <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">old_RTSI_clock_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">|=</span>
			    <span class="n">Drive_RTSI_Clock_Bit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span><span class="p">,</span>
				    <span class="n">RTSI_Trig_Direction_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_configurable_rtsi_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">RTSI_Output_Bit</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span>
					      <span class="n">reg_type</span> <span class="o">&amp;</span> <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
					     <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">old_RTSI_clock_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">Drive_RTSI_Clock_Bit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">stc_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span><span class="p">,</span>
				    <span class="n">RTSI_Trig_Direction_Register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_configurable_rtsi_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">&amp;</span>
			     <span class="n">RTSI_Output_Bit</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">boardtype</span><span class="p">.</span><span class="n">reg_type</span> <span class="o">&amp;</span>
					      <span class="n">ni_reg_m_series_mask</span><span class="p">)</span>
					     <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">?</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span> <span class="o">:</span>
			    <span class="n">INSN_CONFIG_DIO_INPUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">old_RTSI_clock_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">rtsi_trig_direction_reg</span> <span class="o">&amp;</span>
			     <span class="n">Drive_RTSI_Clock_Bit</span><span class="p">)</span>
			    <span class="o">?</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span> <span class="o">:</span> <span class="n">INSN_CONFIG_DIO_INPUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_CLOCK_SRC</span>:
		<span class="k">return</span> <span class="n">ni_set_master_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_CLOCK_SRC</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_source</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpriv</span><span class="o">-&gt;</span><span class="n">clock_ns</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_ROUTING</span>:
		<span class="k">return</span> <span class="n">ni_set_rtsi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_ROUTING</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni_get_rtsi_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cs5529_wait_for_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ni_ao_win_inw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CAL_ADC_Status_67xx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CSS_ADC_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/* printk(&quot;looped %i times waiting for idle\n&quot;, i); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cs5529_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ni_ao_win_outw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">CAL_ADC_Command_67xx</span><span class="p">);</span>
	<span class="cm">/* give time for command to start being serially clocked into cs5529.</span>
<span class="cm">	 * this insures that the CSS_ADC_BUSY bit will get properly</span>
<span class="cm">	 * set before we exit this function.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ni_ao_win_inw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CAL_ADC_Status_67xx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSS_ADC_BUSY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cm">/* printk(&quot;looped %i times writing command to cs5529\n&quot;, i); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;possible problem - never saw adc go busy?&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* write to cs5529 register */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cs5529_config_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_select_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ni_ao_win_outw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
		       <span class="n">CAL_ADC_Config_Data_High_Word_67xx</span><span class="p">);</span>
	<span class="n">ni_ao_win_outw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span>
		       <span class="n">CAL_ADC_Config_Data_Low_Word_67xx</span><span class="p">);</span>
	<span class="n">reg_select_bits</span> <span class="o">&amp;=</span> <span class="n">CSCMD_REGISTER_SELECT_MASK</span><span class="p">;</span>
	<span class="n">cs5529_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CSCMD_COMMAND</span> <span class="o">|</span> <span class="n">reg_select_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs5529_wait_for_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;time or signal in cs5529_config_write()&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef NI_CS5529_DEBUG</span>
<span class="cm">/* read from cs5529 register */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs5529_config_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_select_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">reg_select_bits</span> <span class="o">&amp;=</span> <span class="n">CSCMD_REGISTER_SELECT_MASK</span><span class="p">;</span>
	<span class="n">cs5529_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CSCMD_COMMAND</span> <span class="o">|</span> <span class="n">CSCMD_READ</span> <span class="o">|</span> <span class="n">reg_select_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs5529_wait_for_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout or signal in cs5529_config_read()&quot;</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">ni_ao_win_inw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">CAL_ADC_Config_Data_High_Word_67xx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="mh">0xff0000</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">ni_ao_win_inw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CAL_ADC_Config_Data_Low_Word_67xx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cs5529_do_conversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cs5529_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CSCMD_COMMAND</span> <span class="o">|</span> <span class="n">CSCMD_SINGLE_CONVERSION</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cs5529_wait_for_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;timeout or signal in cs5529_do_conversion()&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ni_ao_win_inw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CAL_ADC_Status_67xx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CSS_OSC_DETECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;ni_mio_common: cs5529 conversion error, status CSS_OSC_DETECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CSS_OVERRANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;ni_mio_common: cs5529 conversion error, overrange (ignoring)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">ni_ao_win_inw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CAL_ADC_Data_67xx</span><span class="p">);</span>
		<span class="cm">/* cs5529 returns 16 bit signed data in bipolar mode */</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cs5529_ai_insn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sample</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel_select</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">INTERNAL_REF</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="cm">/* Set calibration adc source.  Docs lie, reference select bits 8 to 11</span>
<span class="cm">	 * do nothing. bit 12 seems to chooses internal reference voltage, bit</span>
<span class="cm">	 * 13 causes the adc input to go overrange (maybe reads external reference?) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">&amp;</span> <span class="n">CR_ALT_SOURCE</span><span class="p">)</span>
		<span class="n">channel_select</span> <span class="o">=</span> <span class="n">INTERNAL_REF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">channel_select</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">ni_ao_win_outw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel_select</span><span class="p">,</span> <span class="n">AO_Calibration_Channel_Select_67xx</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cs5529_do_conversion</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_cs5529</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config_bits</span> <span class="o">=</span>
	    <span class="n">CSCFG_PORT_MODE</span> <span class="o">|</span> <span class="n">CSCFG_WORD_RATE_2180_CYCLES</span><span class="p">;</span>

<span class="cp">#if 1</span>
	<span class="cm">/* do self-calibration */</span>
	<span class="n">cs5529_config_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">config_bits</span> <span class="o">|</span> <span class="n">CSCFG_SELF_CAL_OFFSET_GAIN</span><span class="p">,</span>
			    <span class="n">CSCMD_CONFIG_REGISTER</span><span class="p">);</span>
	<span class="cm">/* need to force a conversion for calibration to run */</span>
	<span class="n">cs5529_do_conversion</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/* force gain calibration to 1 */</span>
	<span class="n">cs5529_config_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x400000</span><span class="p">,</span> <span class="n">CSCMD_GAIN_REGISTER</span><span class="p">);</span>
	<span class="n">cs5529_config_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">config_bits</span> <span class="o">|</span> <span class="n">CSCFG_SELF_CAL_OFFSET</span><span class="p">,</span>
			    <span class="n">CSCMD_CONFIG_REGISTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs5529_wait_for_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">comedi_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout or signal in init_cs5529()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef NI_CS5529_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;config: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs5529_config_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">CSCMD_CONFIG_REGISTER</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;gain: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs5529_config_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CSCMD_GAIN_REGISTER</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;offset: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs5529_config_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">CSCMD_OFFSET_REGISTER</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
