<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › comedi › comedi_fops.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>comedi_fops.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    comedi/comedi_fops.c</span>
<span class="cm">    comedi kernel module</span>

<span class="cm">    COMEDI - Linux Control and Measurement Device Interface</span>
<span class="cm">    Copyright (C) 1997-2000 David A. Schleef &lt;ds@schleef.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#define __NO_VERSION__</span>
<span class="cp">#include &quot;comedi_fops.h&quot;</span>
<span class="cp">#include &quot;comedi_compat32.h&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &quot;comedidev.h&quot;</span>
<span class="cp">#include &lt;linux/cdev.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &quot;internal.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;http://www.comedi.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comedi core module&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMEDI_DEBUG</span>
<span class="kt">int</span> <span class="n">comedi_debug</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">comedi_debug</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">comedi_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">comedi_debug</span><span class="p">,</span>
		 <span class="s">&quot;enable comedi core and driver debugging if non-zero (default 0)&quot;</span>
		<span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">bool</span> <span class="n">comedi_autoconfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">comedi_autoconfig</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">comedi_autoconfig</span><span class="p">,</span>
		 <span class="s">&quot;enable drivers to auto-configure comedi devices (default 1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">comedi_num_legacy_minors</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">comedi_num_legacy_minors</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">comedi_num_legacy_minors</span><span class="p">,</span>
		 <span class="s">&quot;number of comedi minor devices to reserve for non-auto-configured devices (default 0)&quot;</span>
		<span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">comedi_default_buf_size_kb</span> <span class="o">=</span> <span class="n">CONFIG_COMEDI_DEFAULT_BUF_SIZE_KB</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">comedi_default_buf_size_kb</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">comedi_default_buf_size_kb</span><span class="p">,</span>
		 <span class="s">&quot;default asynchronous buffer size in KiB (default &quot;</span>
		 <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">CONFIG_COMEDI_DEFAULT_BUF_SIZE_KB</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">comedi_default_buf_maxsize_kb</span>
	<span class="o">=</span> <span class="n">CONFIG_COMEDI_DEFAULT_BUF_MAXSIZE_KB</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">comedi_default_buf_maxsize_kb</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">comedi_default_buf_maxsize_kb</span><span class="p">,</span>
		 <span class="s">&quot;default maximum size of asynchronous buffer in KiB (default &quot;</span>
		 <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">CONFIG_COMEDI_DEFAULT_BUF_MAXSIZE_KB</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">comedi_device_file_info</span>
<span class="o">*</span><span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">COMEDI_NUM_MINORS</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_devconfig_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_bufconfig_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_bufconfig</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_devinfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_devinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_subdinfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_chaninfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_chaninfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_bufinfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_bufinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_cmd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_lock_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_unlock_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_cancel_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_cmdtest_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_insnlist_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insnlist</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_insn_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_poll_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subd</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_become_nonbusy</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">comedi_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">is_device_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resize_async_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">new_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&gt;</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice is busy, cannot resize buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice is mmapped, cannot resize buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* make sure buffer is an integral number of pages</span>
<span class="cm">	 * (we round up) */</span>
	<span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">comedi_buf_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_change</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;comedi%i subd %d buffer resized to %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">s</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">),</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sysfs attribute files */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">bytes_per_kibi</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_max_read_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">max_buffer_size_kb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">read_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_subdevice</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_buffer_size_kb</span> <span class="o">=</span> <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span> <span class="o">/</span>
		    <span class="n">bytes_per_kibi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_buffer_size_kb</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_max_read_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_max_size_kb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_max_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">read_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_max_size_kb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_max_size_kb</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">/</span> <span class="n">bytes_per_kibi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">new_max_size</span> <span class="o">=</span> <span class="n">new_max_size_kb</span> <span class="o">*</span> <span class="n">bytes_per_kibi</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_subdevice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_READ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span> <span class="o">=</span> <span class="n">new_max_size</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_read_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">buffer_size_kb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">read_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_subdevice</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_size_kb</span> <span class="o">=</span> <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span> <span class="o">/</span>
		    <span class="n">bytes_per_kibi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_size_kb</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_read_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_size_kb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">read_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_size_kb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_size_kb</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">/</span> <span class="n">bytes_per_kibi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">new_size</span> <span class="o">=</span> <span class="n">new_size_kb</span> <span class="o">*</span> <span class="n">bytes_per_kibi</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_subdevice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_READ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">resize_async_buffer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">read_subdevice</span><span class="p">,</span>
				     <span class="n">read_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_max_write_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">max_buffer_size_kb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">write_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_subdevice</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_buffer_size_kb</span> <span class="o">=</span> <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span> <span class="o">/</span>
		    <span class="n">bytes_per_kibi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_buffer_size_kb</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_max_write_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_max_size_kb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_max_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">write_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_max_size_kb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_max_size_kb</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">/</span> <span class="n">bytes_per_kibi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">new_max_size</span> <span class="o">=</span> <span class="n">new_max_size_kb</span> <span class="o">*</span> <span class="n">bytes_per_kibi</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_subdevice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span> <span class="o">=</span> <span class="n">new_max_size</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_write_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">buffer_size_kb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">write_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_subdevice</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_size_kb</span> <span class="o">=</span> <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span> <span class="o">/</span>
		    <span class="n">bytes_per_kibi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_size_kb</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_write_buffer_kb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_size_kb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="k">const</span> <span class="n">write_subdevice</span> <span class="o">=</span>
	    <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_size_kb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_size_kb</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">/</span> <span class="n">bytes_per_kibi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">new_size</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">new_size_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">bytes_per_kibi</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_subdevice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">resize_async_buffer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">write_subdevice</span><span class="p">,</span>
				     <span class="n">write_subdevice</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">comedi_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">max_read_buffer_kb</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="n">show_max_read_buffer_kb</span><span class="p">,</span> <span class="n">store_max_read_buffer_kb</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">read_buffer_kb</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">,</span>
		<span class="n">show_read_buffer_kb</span><span class="p">,</span> <span class="n">store_read_buffer_kb</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">max_write_buffer_kb</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="n">show_max_write_buffer_kb</span><span class="p">,</span> <span class="n">store_max_write_buffer_kb</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">write_buffer_kb</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">,</span>
		<span class="n">show_write_buffer_kb</span><span class="p">,</span> <span class="n">store_write_buffer_kb</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">comedi_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span> <span class="o">=</span>
	    <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Device config is special, because it must work on</span>
<span class="cm">	 * an unconfigured device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">COMEDI_DEVCONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_devconfig_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no driver configured on /dev/comedi%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMEDI_BUFCONFIG</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_bufconfig_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">comedi_bufconfig</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_DEVINFO</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_devinfo_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_devinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				      <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_SUBDINFO</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_subdinfo_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_subdinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				       <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_CHANINFO</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_chaninfo_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_RANGEINFO</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_rangeinfo_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_BUFINFO</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_bufinfo_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				      <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_bufinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				      <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_LOCK</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_lock_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_UNLOCK</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_unlock_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_CANCEL</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_cancel_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_CMD</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_cmd_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_CMDTEST</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_cmdtest_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				      <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_INSNLIST</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_insnlist_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insnlist</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				       <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_INSN</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_insn_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insn</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMEDI_POLL</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_poll_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_DEVCONFIG</span>
<span class="cm">	device config ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		pointer to devconfig structure</span>

<span class="cm">	reads:</span>
<span class="cm">		devconfig structure at arg</span>

<span class="cm">	writes:</span>
<span class="cm">		none</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_devconfig_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_devconfig</span> <span class="n">it</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aux_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aux_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_device_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">driver_module</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">;</span>
			<span class="n">comedi_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">driver_module</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_devconfig</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">it</span><span class="p">.</span><span class="n">board_name</span><span class="p">[</span><span class="n">COMEDI_NAMELEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LENGTH</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bit_shift</span><span class="p">;</span>
		<span class="n">aux_len</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LENGTH</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aux_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">aux_data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">aux_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aux_data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">aux_data</span><span class="p">,</span>
				   <span class="n">comedi_aux_data</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">aux_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">aux_data</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_LO</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">aux_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bit_shift</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_HI</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">aux_data</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">bit_shift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">it</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="n">COMEDI_DEVCONF_AUX_DATA_HI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">comedi_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">it</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">comedi_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aux_data</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">aux_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_BUFCONFIG</span>
<span class="cm">	buffer configuration ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		pointer to bufconfig structure</span>

<span class="cm">	reads:</span>
<span class="cm">		bufconfig at arg</span>

<span class="cm">	writes:</span>
<span class="cm">		modified bufconfig at arg</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_bufconfig_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">comedi_bufconfig</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_bufconfig</span> <span class="n">bc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_bufconfig</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span> <span class="o">||</span> <span class="n">bc</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">bc</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice does not have async capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bc</span><span class="p">.</span><span class="n">maximum_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">copyback</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">.</span><span class="n">maximum_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span> <span class="o">=</span> <span class="n">bc</span><span class="p">.</span><span class="n">maximum_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">resize_async_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">bc</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">;</span>
	<span class="n">bc</span><span class="p">.</span><span class="n">maximum_size</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">max_bufsize</span><span class="p">;</span>

<span class="nl">copyback:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_bufconfig</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_DEVINFO</span>
<span class="cm">	device info ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		pointer to devinfo structure</span>

<span class="cm">	reads:</span>
<span class="cm">		none</span>

<span class="cm">	writes:</span>
<span class="cm">		devinfo structure</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_devinfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_devinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span> <span class="o">=</span>
	    <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">read_subdev</span> <span class="o">=</span>
	    <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">write_subdev</span> <span class="o">=</span>
	    <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="p">));</span>

	<span class="cm">/* fill devinfo structure */</span>
	<span class="n">devinfo</span><span class="p">.</span><span class="n">version_code</span> <span class="o">=</span> <span class="n">COMEDI_VERSION_CODE</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="p">.</span><span class="n">n_subdevs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">devinfo</span><span class="p">.</span><span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver_name</span><span class="p">,</span> <span class="n">COMEDI_NAMELEN</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">devinfo</span><span class="p">.</span><span class="n">board_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">COMEDI_NAMELEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_subdev</span><span class="p">)</span>
		<span class="n">devinfo</span><span class="p">.</span><span class="n">read_subdevice</span> <span class="o">=</span> <span class="n">read_subdev</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devinfo</span><span class="p">.</span><span class="n">read_subdevice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_subdev</span><span class="p">)</span>
		<span class="n">devinfo</span><span class="p">.</span><span class="n">write_subdevice</span> <span class="o">=</span> <span class="n">write_subdev</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devinfo</span><span class="p">.</span><span class="n">write_subdevice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_devinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_SUBDINFO</span>
<span class="cm">	subdevice info ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		pointer to array of subdevice info structures</span>

<span class="cm">	reads:</span>
<span class="cm">		none</span>

<span class="cm">	writes:</span>
<span class="cm">		array of subdevice info structures at arg</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_subdinfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_subdinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdinfo</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">us</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span>
	    <span class="n">kcalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_subdinfo</span><span class="p">),</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* fill subdinfo structs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">us</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">us</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_RUNNING</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_RUNNING</span><span class="p">;</span>
<span class="cp">#define TIMER_nanosec 5		</span><span class="cm">/* backwards compatibility */</span><span class="cp"></span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">=</span> <span class="n">TIMER_nanosec</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">len_chanlist</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">range_type</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">range_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* XXX */</span>
		<span class="p">}</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_BUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_BUSY_OWNER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_LOCKED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_LOCK_OWNER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_MAXDATA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">flaglist</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_FLAGS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table_list</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_RANGETYPE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">subd_flags</span> <span class="o">|=</span> <span class="n">SDF_CMD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">insn_inval</span><span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">insn_bits_support</span> <span class="o">=</span> <span class="n">COMEDI_SUPPORTED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">insn_bits_support</span> <span class="o">=</span> <span class="n">COMEDI_UNSUPPORTED</span><span class="p">;</span>

		<span class="n">us</span><span class="o">-&gt;</span><span class="n">settling_time_0</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">settling_time_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_subdinfo</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_CHANINFO</span>
<span class="cm">	subdevice info ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		pointer to chaninfo structure</span>

<span class="cm">	reads:</span>
<span class="cm">		chaninfo structure at arg</span>

<span class="cm">	writes:</span>
<span class="cm">		arrays at elements of chaninfo structure</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_chaninfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_chaninfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_chaninfo</span> <span class="n">it</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_chaninfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">subdev</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">it</span><span class="p">.</span><span class="n">subdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">maxdata_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span> <span class="o">||</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">maxdata_list</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">flaglist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">flaglist</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">flaglist</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">flaglist</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">rangelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table_list</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

			<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">subdev</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">range_table_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">rangelist</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if (copy_to_user(it.rangelist, s-&gt;range_type_list,</span>
<span class="c">				 s-&gt;n_chan * sizeof(unsigned int)))</span>
<span class="c">			return -EFAULT;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

 <span class="cm">/*</span>
<span class="cm">    COMEDI_BUFINFO</span>
<span class="cm">    buffer information ioctl</span>

<span class="cm">    arg:</span>
<span class="cm">    pointer to bufinfo structure</span>

<span class="cm">    reads:</span>
<span class="cm">    bufinfo at arg</span>

<span class="cm">    writes:</span>
<span class="cm">    modified bufinfo at arg</span>

<span class="cm">  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_bufinfo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_bufinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_bufinfo</span> <span class="n">bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_bufinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span> <span class="o">||</span> <span class="n">bi</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">bi</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice does not have async capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">buf_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">buf_read_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">buf_write_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">buf_read_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">copyback</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">copyback_position</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">bytes_read</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="n">comedi_buf_read_alloc</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">bi</span><span class="p">.</span><span class="n">bytes_read</span><span class="p">);</span>
		<span class="n">comedi_buf_read_free</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">bi</span><span class="p">.</span><span class="n">bytes_read</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRF_ERROR</span> <span class="o">|</span>
							  <span class="n">SRF_RUNNING</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span> <span class="o">==</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_become_nonbusy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">bytes_written</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">bytes_written</span> <span class="o">=</span>
		    <span class="n">comedi_buf_write_alloc</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">bi</span><span class="p">.</span><span class="n">bytes_written</span><span class="p">);</span>
		<span class="n">comedi_buf_write_free</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">bi</span><span class="p">.</span><span class="n">bytes_written</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">copyback_position:</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">buf_write_count</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">buf_write_ptr</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_ptr</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">buf_read_count</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">buf_read_ptr</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_ptr</span><span class="p">;</span>

<span class="nl">copyback:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_bufinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">parse_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *	COMEDI_INSNLIST</span>
<span class="cm"> *	synchronous instructions</span>
<span class="cm"> *</span>
<span class="cm"> *	arg:</span>
<span class="cm"> *		pointer to sync cmd structure</span>
<span class="cm"> *</span>
<span class="cm"> *	reads:</span>
<span class="cm"> *		sync cmd struct at arg</span>
<span class="cm"> *		instruction list</span>
<span class="cm"> *		data (for writes)</span>
<span class="cm"> *</span>
<span class="cm"> *	writes:</span>
<span class="cm"> *		data (for reads)</span>
<span class="cm"> */</span>
<span class="cm">/* arbitrary limits */</span>
<span class="cp">#define MAX_SAMPLES 256</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_insnlist_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">comedi_insnlist</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_insnlist</span> <span class="n">insnlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">insnlist</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insnlist</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_SAMPLES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">insns</span> <span class="o">=</span>
	    <span class="n">kcalloc</span><span class="p">(</span><span class="n">insnlist</span><span class="p">.</span><span class="n">n_insns</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insn</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">insns</span><span class="p">,</span> <span class="n">insnlist</span><span class="p">.</span><span class="n">insns</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insn</span><span class="p">)</span> <span class="o">*</span> <span class="n">insnlist</span><span class="p">.</span><span class="n">n_insns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;copy_from_user failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insnlist</span><span class="p">.</span><span class="n">n_insns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX_SAMPLES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;number of samples too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="n">INSN_MASK_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span>
					   <span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;copy_from_user failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_insn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">insns</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="n">INSN_MASK_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					 <span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;copy_to_user failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">insns</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_insn_config_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_OUTPUT</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_INPUT</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_DISARM</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_ARM</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_DIO_QUERY</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_BLOCK_SIZE</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_FILTER</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_SERIAL_CLOCK</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_BIDIRECTIONAL_DATA</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_ALT_SOURCE</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_COUNTER_MODE</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_8254_READ_STATUS</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_ROUTING</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_ROUTING</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_PWM_STATUS</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_SET_PERIOD</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_GET_PERIOD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_GATE_SRC</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_GATE_SRC</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_CLOCK_SRC</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_CLOCK_SRC</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_SET_OTHER_SRC</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_COUNTER_STATUS</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_SET_H_BRIDGE</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_GET_H_BRIDGE</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_GET_HARDWARE_BUFFER_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INSN_CONFIG_PWM_OUTPUT</span>:
	<span class="k">case</span> <span class="n">INSN_CONFIG_ANALOG_TRIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* by default we allow the insn since we don&#39;t have checks for</span>
<span class="cm">		 * all possible cases yet */</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;comedi: no check for data length of config insn id &quot;</span>
		       <span class="s">&quot;%i is implemented.</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; Add a check to %s in %s.</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; Assuming n=%i is correct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="n">INSN_MASK_SPECIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* a non-subdevice instruction */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INSN_GTOD</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">INSN_WAIT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INSN_INTTRIG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d not usable subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no async</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no inttrig</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid insn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* a subdevice instruction */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice %d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d not usable subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* are we locked? (ioctl lock) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;device locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">comedi_check_chanlist</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad chanspec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* This looks arbitrary.  It is. */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parse_insn</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INSN_READ</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INSN_WRITE</span>:
			<span class="n">maxdata</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span>
			    <span class="o">?</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata_list</span><span class="p">[</span><span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)]</span>
			    <span class="o">:</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">maxdata</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxdata</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad data value(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INSN_BITS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Most drivers ignore the base channel in</span>
<span class="cm">				 * insn-&gt;chanspec.  Fix this here if</span>
<span class="cm">				 * the subdevice has &lt;= 32 channels.  */</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">orig_mask</span><span class="p">;</span>

				<span class="n">orig_mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">n_chan</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">shift</span> <span class="o">=</span> <span class="n">CR_CHAN</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">insn</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
						<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_mask</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INSN_CONFIG</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">check_insn_config_length</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">insn_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	COMEDI_INSN</span>
<span class="cm"> *	synchronous instructions</span>
<span class="cm"> *</span>
<span class="cm"> *	arg:</span>
<span class="cm"> *		pointer to insn</span>
<span class="cm"> *</span>
<span class="cm"> *	reads:</span>
<span class="cm"> *		struct comedi_insn struct at arg</span>
<span class="cm"> *		data (for writes)</span>
<span class="cm"> *</span>
<span class="cm"> *	writes:</span>
<span class="cm"> *		data (for reads)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_insn_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">comedi_insn</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_insn</span> <span class="n">insn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_SAMPLES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">insn</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_insn</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is where the behavior of insn and insnlist deviate. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX_SAMPLES</span><span class="p">)</span>
		<span class="n">insn</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">MAX_SAMPLES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="n">INSN_MASK_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">insn</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">insn</span><span class="p">.</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_insn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="n">INSN_MASK_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				 <span class="n">data</span><span class="p">,</span>
				 <span class="n">insn</span><span class="p">.</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">insn</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">comedi_set_subdevice_runflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">runflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">runflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_cmd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">user_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">chanlist_saver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad cmd address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* save user&#39;s chanlist pointer so it can be restored later */</span>
	<span class="n">chanlist_saver</span> <span class="o">=</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d no such subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">;</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d not valid subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span> <span class="o">||</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice %i does not support commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* are we locked? (ioctl lock) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* are we busy? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

	<span class="cm">/* make sure channel/gain list isn&#39;t too long */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;channel/gain list too long %u &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure channel/gain list isn&#39;t too short */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;channel/gain list too short %u &lt; 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">);</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">user_cmd</span><span class="p">;</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* load channel/gain list */</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span> <span class="o">=</span>
	    <span class="n">kmalloc</span><span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">,</span>
			   <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;fault reading chanlist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure each element in channel/gain list is valid */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">comedi_check_chanlist</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
				    <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">,</span>
				    <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad chanlist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_BOGUS</span> <span class="o">||</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;test returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">user_cmd</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="cm">/* restore chanlist pointer before copying back */</span>
		<span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span> <span class="o">=</span> <span class="n">chanlist_saver</span><span class="p">;</span>
		<span class="n">user_cmd</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;fault writing cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no buffer (?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">comedi_reset_async_buf</span><span class="p">(</span><span class="n">async</span><span class="p">);</span>

	<span class="n">async</span><span class="o">-&gt;</span><span class="n">cb_mask</span> <span class="o">=</span>
	    <span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_BLOCK</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span>
	    <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRIG_WAKE_EOS</span><span class="p">)</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">cb_mask</span> <span class="o">|=</span> <span class="n">COMEDI_CB_EOS</span><span class="p">;</span>

	<span class="n">comedi_set_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">SRF_USER</span> <span class="o">|</span> <span class="n">SRF_RUNNING</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">do_become_nonbusy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_CMDTEST</span>
<span class="cm">	command testing ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		pointer to cmd structure</span>

<span class="cm">	reads:</span>
<span class="cm">		cmd structure at arg</span>
<span class="cm">		channel/range list</span>

<span class="cm">	writes:</span>
<span class="cm">		modified cmd structure at arg</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_cmdtest_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_cmd</span> <span class="n">user_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chanlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">chanlist_saver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad cmd address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* save user&#39;s chanlist pointer so it can be restored later */</span>
	<span class="n">chanlist_saver</span> <span class="o">=</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d no such subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COMEDI_SUBD_UNUSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d not valid subdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subdevice %i does not support commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">user_cmd</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure channel/gain list isn&#39;t too long */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;channel/gain list too long %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len_chanlist</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* load channel/gain list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chanlist</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chanlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">chanlist</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span><span class="p">,</span>
				   <span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;fault reading chanlist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* make sure each element in channel/gain list is valid */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">comedi_check_chanlist</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist_len</span><span class="p">,</span> <span class="n">chanlist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad chanlist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span> <span class="o">=</span> <span class="n">chanlist</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">do_cmdtest</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_cmd</span><span class="p">);</span>

	<span class="cm">/* restore chanlist pointer before copying back */</span>
	<span class="n">user_cmd</span><span class="p">.</span><span class="n">chanlist</span> <span class="o">=</span> <span class="n">chanlist_saver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_cmd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad cmd address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">cleanup:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chanlist</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_LOCK</span>
<span class="cm">	lock subdevice</span>

<span class="cm">	arg:</span>
<span class="cm">		subdevice number</span>

<span class="cm">	reads:</span>
<span class="cm">		none</span>

<span class="cm">	writes:</span>
<span class="cm">		none</span>

<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_lock_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (ret &lt; 0)</span>
<span class="c">		return ret;</span>

<span class="c">	if (s-&gt;lock_f)</span>
<span class="c">		ret = s-&gt;lock_f(dev, s);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_UNLOCK</span>
<span class="cm">	unlock subdevice</span>

<span class="cm">	arg:</span>
<span class="cm">		subdevice number</span>

<span class="cm">	reads:</span>
<span class="cm">		none</span>

<span class="cm">	writes:</span>
<span class="cm">		none</span>

<span class="cm">	This function isn&#39;t protected by the semaphore, since</span>
<span class="cm">	we already own the lock.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_unlock_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if (s-&gt;unlock)</span>
<span class="c">			s-&gt;unlock(dev, s);</span>
<span class="cp">#endif</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_CANCEL</span>
<span class="cm">	cancel acquisition ioctl</span>

<span class="cm">	arg:</span>
<span class="cm">		subdevice number</span>

<span class="cm">	reads:</span>
<span class="cm">		nothing</span>

<span class="cm">	writes:</span>
<span class="cm">		nothing</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_cancel_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	COMEDI_POLL ioctl</span>
<span class="cm">	instructs driver to synchronize buffers</span>

<span class="cm">	arg:</span>
<span class="cm">		subdevice number</span>

<span class="cm">	reads:</span>
<span class="cm">		nothing</span>

<span class="cm">	writes:</span>
<span class="cm">		nothing</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_poll_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">do_become_nonbusy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">comedi_vm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">async</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">comedi_vm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">async</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">async</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">comedi_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">comedi_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">comedi_vm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">comedi_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_file_info</span> <span class="o">=</span> <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no driver configured on comedi%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_WRITE</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">async</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;comedi: mmap() offset must be 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n_pages</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_pages</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span>
				    <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">virt_to_page</span>
						<span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_page_list</span>
						 <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">)),</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">PAGE_SHARED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">comedi_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">async</span><span class="p">;</span>

	<span class="n">async</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">comedi_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">read_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">write_subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_file_info</span> <span class="o">=</span> <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no driver configured on comedi%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">read_subdev</span> <span class="o">=</span> <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_subdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">busy</span>
		    <span class="o">||</span> <span class="n">comedi_buf_read_n_available</span><span class="p">(</span><span class="n">read_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">read_subdev</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">SRF_RUNNING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_subdev</span> <span class="o">=</span> <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_subdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="n">comedi_buf_write_alloc</span><span class="p">(</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span>
				       <span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">busy</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">write_subdev</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">SRF_RUNNING</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">comedi_buf_write_n_allocated</span><span class="p">(</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="o">&gt;=</span>
		    <span class="n">bytes_per_sample</span><span class="p">(</span><span class="n">write_subdev</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">comedi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_file_info</span> <span class="o">=</span> <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no driver configured on comedi%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">comedi_get_write_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_RUNNING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">SRF_ERROR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">do_become_nonbusy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>

		<span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_ptr</span> <span class="o">+</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span> <span class="o">-</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_ptr</span><span class="p">;</span>
		<span class="n">comedi_buf_write_alloc</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="n">comedi_buf_write_n_allocated</span><span class="p">(</span><span class="n">async</span><span class="p">))</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">comedi_buf_write_n_allocated</span><span class="p">(</span><span class="n">async</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">m</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span> <span class="o">+</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_ptr</span><span class="p">,</span>
				   <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="n">m</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">comedi_buf_write_free</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* makes device work like a pipe */</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">comedi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
				<span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_file_info</span> <span class="o">=</span> <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no driver configured on comedi%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">comedi_get_read_subdevice</span><span class="p">(</span><span class="n">dev_file_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>

		<span class="n">m</span> <span class="o">=</span> <span class="n">comedi_buf_read_n_available</span><span class="p">(</span><span class="n">async</span><span class="p">);</span>
		<span class="cm">/* printk(&quot;%d available\n&quot;,m); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_ptr</span> <span class="o">+</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_bufsz</span> <span class="o">-</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_ptr</span><span class="p">;</span>
		<span class="cm">/* printk(&quot;%d contiguous\n&quot;,m); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_RUNNING</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">do_become_nonbusy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">SRF_ERROR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">prealloc_buf</span> <span class="o">+</span>
				 <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="n">m</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">comedi_buf_read_alloc</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">comedi_buf_read_free</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* makes device work like a pipe */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRF_ERROR</span> <span class="o">|</span> <span class="n">SRF_RUNNING</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_read_count</span> <span class="o">-</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">buf_write_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_become_nonbusy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   This function restores a subdevice to an idle state.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">do_become_nonbusy</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>

	<span class="n">comedi_set_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SRF_RUNNING</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_reset_async_buf</span><span class="p">(</span><span class="n">async</span><span class="p">);</span>
		<span class="n">async</span><span class="o">-&gt;</span><span class="n">inttrig</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;BUG: (?) do_become_nonbusy called with async=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">comedi_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span> <span class="o">=</span>
	    <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
	    <span class="n">dev_file_info</span> <span class="o">?</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid minor number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is slightly hacky, but we want module autoloading</span>
<span class="cm">	 * to work for root.</span>
<span class="cm">	 * case: user opens device, attached -&gt; ok</span>
<span class="cm">	 * case: user opens device, unattached, in_request_module=0 -&gt; autoload</span>
<span class="cm">	 * case: user opens device, unattached, in_request_module=1 -&gt; fail</span>
<span class="cm">	 * case: root opens device, attached -&gt; ok</span>
<span class="cm">	 * case: root opens device, unattached, in_request_module=1 -&gt; ok</span>
<span class="cm">	 *   (typically called from modprobe)</span>
<span class="cm">	 * case: root opens device, unattached, in_request_module=0 -&gt; autoload</span>
<span class="cm">	 *</span>
<span class="cm">	 * The last could be changed to &quot;-&gt; ok&quot;, which would deny root</span>
<span class="cm">	 * autoloading.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_request_module</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;in request module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_request_module</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ok</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_request_module</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KMOD</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;char-major-%i-%i&quot;</span><span class="p">,</span> <span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_request_module</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;not attached and not CAP_NET_ADMIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">ok:</span>
	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">comedi_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_file_info</span> <span class="o">=</span> <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span>
				<span class="n">do_cancel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">FASYNC</span><span class="p">)</span>
		<span class="n">comedi_fasync</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">comedi_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">dev_file_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_file_info</span> <span class="o">=</span> <span class="n">comedi_get_device_file_info</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_file_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_file_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fasync_helper</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">comedi_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">comedi_unlocked_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">comedi_compat_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">comedi_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">comedi_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">comedi_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">comedi_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">comedi_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">comedi_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span> <span class="o">=</span> <span class="n">comedi_fasync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">comedi_class</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">comedi_cdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">comedi_cleanup_legacy_minors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">comedi_num_legacy_minors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">comedi_free_board_minor</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">comedi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;comedi: version &quot;</span> <span class="n">COMEDI_RELEASE</span>
	       <span class="s">&quot; - http://www.comedi.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_num_legacy_minors</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">comedi_num_legacy_minors</span> <span class="o">&gt;</span> <span class="n">COMEDI_NUM_BOARD_MINORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi: error: invalid value for module &quot;</span>
		       <span class="s">&quot;parameter </span><span class="se">\&quot;</span><span class="s">comedi_num_legacy_minors</span><span class="se">\&quot;</span><span class="s">.  Valid values &quot;</span>
		       <span class="s">&quot;are 0 through %i.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMEDI_NUM_BOARD_MINORS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * comedi is unusable if both comedi_autoconfig and</span>
<span class="cm">	 * comedi_num_legacy_minors are zero, so we might as well adjust the</span>
<span class="cm">	 * defaults in that case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comedi_autoconfig</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">comedi_num_legacy_minors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">comedi_num_legacy_minors</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">comedi_file_info_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">COMEDI_NUM_MINORS</span><span class="p">,</span> <span class="s">&quot;comedi&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comedi_fops</span><span class="p">);</span>
	<span class="n">comedi_cdev</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">kobject_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_cdev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;comedi&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_cdev</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					 <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">comedi_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;comedi&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi: failed to create class&quot;</span><span class="p">);</span>
		<span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_cdev</span><span class="p">);</span>
		<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					 <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">comedi_class</span><span class="o">-&gt;</span><span class="n">dev_attrs</span> <span class="o">=</span> <span class="n">comedi_dev_attrs</span><span class="p">;</span>

	<span class="cm">/* XXX requires /proc interface */</span>
	<span class="n">comedi_proc_init</span><span class="p">();</span>

	<span class="cm">/* create devices files for legacy/manual use */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">comedi_num_legacy_minors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="n">comedi_alloc_board_minor</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_cleanup_legacy_minors</span><span class="p">();</span>
			<span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_cdev</span><span class="p">);</span>
			<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						 <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">minor</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">comedi_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">comedi_cleanup_legacy_minors</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">class_destroy</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">);</span>
	<span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_cdev</span><span class="p">);</span>
	<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>

	<span class="n">comedi_proc_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">comedi_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">comedi_cleanup</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">comedi_error</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;comedi%d: %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver_name</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">comedi_error</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">comedi_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_async</span> <span class="o">*</span><span class="n">async</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">runflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">runflags_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DPRINTK(&quot;comedi_event 0x%x\n&quot;,mask); */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_RUNNING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span>
	    <span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">COMEDI_CB_EOA</span> <span class="o">|</span> <span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span>
			     <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">runflags_mask</span> <span class="o">|=</span> <span class="n">SRF_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* remember if an error event has occurred, so an error</span>
<span class="cm">	 * can be returned the next time the user does a read() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">COMEDI_CB_ERROR</span> <span class="o">|</span> <span class="n">COMEDI_CB_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">runflags_mask</span> <span class="o">|=</span> <span class="n">SRF_ERROR</span><span class="p">;</span>
		<span class="n">runflags</span> <span class="o">|=</span> <span class="n">SRF_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runflags_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*sets SRF_ERROR and SRF_RUNNING together atomically */</span>
		<span class="n">comedi_set_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">runflags_mask</span><span class="p">,</span> <span class="n">runflags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cb_mask</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SRF_USER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">wait_head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_READ</span><span class="p">)</span>
				<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">subdev_flags</span> <span class="o">&amp;</span> <span class="n">SDF_CMD_WRITE</span><span class="p">)</span>
				<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_OUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">cb_func</span><span class="p">)</span>
				<span class="n">async</span><span class="o">-&gt;</span><span class="n">cb_func</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">async</span><span class="o">-&gt;</span><span class="n">cb_arg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">comedi_event</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="nf">comedi_get_subdevice_runflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">runflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">runflags</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">runflags</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">runflags</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">comedi_get_subdevice_runflags</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_device_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_subdevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">comedi_device_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">comedi_device_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">comedi_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">comedi_alloc_board_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hardware_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">csdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device_file_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">hardware_device</span> <span class="o">=</span> <span class="n">hardware_device</span><span class="p">;</span>
	<span class="n">comedi_device_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COMEDI_NUM_BOARD_MINORS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">COMEDI_NUM_BOARD_MINORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comedi_device_cleanup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;comedi: error: &quot;</span>
		       <span class="s">&quot;ran out of minor numbers for board device files.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">csdev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">,</span> <span class="n">hardware_device</span><span class="p">,</span>
			      <span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;comedi%i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">csdev</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">class_dev</span> <span class="o">=</span> <span class="n">csdev</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">csdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">comedi_free_board_minor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">COMEDI_NUM_BOARD_MINORS</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">minor</span><span class="p">];</span>
	<span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">minor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">device_destroy</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">,</span>
					       <span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">comedi_device_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">comedi_find_board_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hardware_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">minor</span> <span class="o">&lt;</span> <span class="n">COMEDI_NUM_BOARD_MINORS</span><span class="p">;</span> <span class="n">minor</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">minor</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hardware_device</span> <span class="o">==</span> <span class="n">hardware_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">minor</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">comedi_alloc_subdevice_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">csdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_device_file_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_subdevice</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">write_subdevice</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">COMEDI_FIRST_SUBDEVICE_MINOR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;comedi: error: &quot;</span>
		       <span class="s">&quot;ran out of minor numbers for board device files.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">csdev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
			      <span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;comedi%i_subd%i&quot;</span><span class="p">,</span>
			      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">s</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subdevices</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">csdev</span><span class="p">))</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">class_dev</span> <span class="o">=</span> <span class="n">csdev</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">csdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">comedi_free_subdevice_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">comedi_subdevice</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">COMEDI_FIRST_SUBDEVICE_MINOR</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">];</span>
	<span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_destroy</span><span class="p">(</span><span class="n">comedi_class</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">COMEDI_MAJOR</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">class_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="nf">comedi_get_device_file_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">comedi_device_file_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">COMEDI_NUM_MINORS</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">comedi_file_info_table</span><span class="p">[</span><span class="n">minor</span><span class="p">];</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comedi_file_info_table_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">comedi_get_device_file_info</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
