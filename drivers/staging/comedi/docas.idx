f | internal.h | s | 696B | 15 | Ian Abbott | abbotti@mev.co.uk | 1334341103 |  | staging: comedi: Add module parameters for default buffer size  For comedi subdevices that support asynchronous transfer commands, the initial buffer size and maximum buffer size for the transfer are both set to 64 KiB when the comedi device is "attached" to the hardware device.  For many applications with reasonable fast sample rates and slow user-space (e.g. Python) these sizes are a bit too small.  A task with CAP_SYS_ADMIN privileges can change the maximum buffer size for a comedi subdevice with an ioctl call or by writing to a device attribute file in sysfs, but that's not very convenient.  For comedi devices attached during system startup, this could be done by a start-up script, but for hot-plugged devices it would require scripts run by udev rules, etc.  Rather than use hardwired values, this patch introduces a couple of module parameters to set the defaults for the initial buffer size (comedi_default_buf_size_kb) and maximum buffer size (comedi_default_buf_maxsize_kb).  These values are applied in place of the previous hard-wired values when the comedi device is "attached". The module parameter values are in units of KiB for consistency with the existing device attribute files.  Signed-off-by: Ian Abbott <abbotti@mev.co.uk> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | Makefile | g | 193B |  | Tracey Dent | tdent48227@gmail.com | 1286547832 |  | Staging: comedi: Makefile: replace the use of <module>-objs with <module>-y  Changed <module>-objs to <module>-y in Makefile.  Signed-off-by: Tracey Dent <tdent48227@gmail.com> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | comedi_fops.h | s | 262B | 8 | Rusty Russell | rusty@rustcorp.com.au | 1326409340 |  | module_param: make bool parameters really bool (drivers & misc)  module_param(bool) used to counter-intuitively take an int.  In fddd5201 (mid-2009) we allowed bool or int/unsigned int using a messy trick.  It's time to remove the int/unsigned int option.  For this version it'll simply give a warning, but it'll break next kernel version.  Acked-by: Mauro Carvalho Chehab <mchehab@redhat.com> Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
f | range.c | s | 4.3K | 145 | Greg Kroah-Hartman | gregkh@suse.de | 1273602963 |  | Staging: comedi: range.c: properly mark up __user pointers  This is the start of cleaning up the user pointer markings in the comedi core.  Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Frank Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
d | drivers |  | 150 items |  | H Hartley Sweeten | hartleys@visionengravers.com | 1337387395 |  | staging: comedi: cleanup all the comedi_driver 'detach' functions  1. Change the return type from int to void  All the detach functions, except for the comedi usb drivers, simply return success (0). Plus, the return code is never checked in the comedi core.  The comedi usb drivers do return error codes but the conditions can never happen.  The first check is:  	if (!dev) 		return -EFAULT;  This checks that the passed comedi_device pointer is valid. The detach function itself is called using this pointer so it MUST always be valid or there is a bug in the core:  	if (dev->driver) 		dev->driver->detach(dev);  And the second check:  	usb = dev->private; 	if (!usb) 		return -EFAULT;  The dev->private pointer is setup in the attach function to point to the probed usb device. This value could be NULL if the attach fails. But, since the comedi core is going to unload the driver anyway and does not check for errors there is no gain by returning one.  After removing these checks from the comedi usb drivers the detach functions required a bit of cleanup.  2. Remove all the printk noise in the detach functions  All of the printk output is really just noise. The user did a rmmod to unload the driver, we really don't need to tell them about it.  Also, some of the messages are output using:  	dev_dbg(dev->hw_dev, ... or 	dev_info(dev->hw_dev, ...  Unfortunately the hw_dev value is only used by drivers that are doing DMA. For most drivers this variable is going to be NULL so the output is not going to work as expected.  3. Refactor a couple static 'free_resource' functions into the detach    functions.  The 'free_resource' function is only being called by the detach and it makes more sense to just absorb the code.  4. Remove a couple unnecessary braces for single statements.  5. Remove unnecessary comments.  Most of the comedi drivers appear to be based on the comedi skel driver and have the comments from that driver included. These comments make sense in the skel driver for reference but they don't need to be in any of the actual drivers.  6. Remove all the extra whitespace.  It's not needed to make the functions any more readable.  7. Remove the now unused 'attached_successfully' variable in the    cb_pcimdda driver.  This variable was only used to conditionally output some driver noise during the detach. Since all the printk's have been removed this variable is no longer necessary.  Signed-off-by: H Hartley Sweeten <hsweeten@visionengravers.com> Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | comedi_fops.c | s | 60K | 2244 | H Hartley Sweeten | hartleys@visionengravers.com | 1337025655 |  | staging: comedi: register sysfs device attributes with driver core  Currently the sysfs device attributes are created by the comedi core after each comedi device is created. This can lead to a race condition where userspace gets an add event before the files are created.  Register the device attributes with the comedi class so that the driver core handles creating them and we avoid the race.  Signed-off-by: H Hartley Sweeten <hsweeten@visionengravers.com> Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | comedi_compat32.h | s | 1.4K | 30 | Shawn Bohrer | shawn.bohrer@gmail.com | 1260562981 |  | Staging: comedi: remove check for HAVE_COMPAT_IOCTL  All new kernels have support for compat_ioctl so remove the check and support for older kernels.  Signed-off-by: Shawn Bohrer <shawn.bohrer@gmail.com> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | TODO | g | 318B |  | Arun Thomas | arun.thomas@gmail.com | 1276807747 |  | Staging: comedi: Remove typedefs  Remove all remaining typedefs from comedi drivers  Signed-off-by: Arun Thomas <arun.thomas@gmail.com> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | comedidev.h | s | 15K | 446 | H Hartley Sweeten | hartleys@visionengravers.com | 1337387395 |  | staging: comedi: cleanup all the comedi_driver 'detach' functions  1. Change the return type from int to void  All the detach functions, except for the comedi usb drivers, simply return success (0). Plus, the return code is never checked in the comedi core.  The comedi usb drivers do return error codes but the conditions can never happen.  The first check is:  	if (!dev) 		return -EFAULT;  This checks that the passed comedi_device pointer is valid. The detach function itself is called using this pointer so it MUST always be valid or there is a bug in the core:  	if (dev->driver) 		dev->driver->detach(dev);  And the second check:  	usb = dev->private; 	if (!usb) 		return -EFAULT;  The dev->private pointer is setup in the attach function to point to the probed usb device. This value could be NULL if the attach fails. But, since the comedi core is going to unload the driver anyway and does not check for errors there is no gain by returning one.  After removing these checks from the comedi usb drivers the detach functions required a bit of cleanup.  2. Remove all the printk noise in the detach functions  All of the printk output is really just noise. The user did a rmmod to unload the driver, we really don't need to tell them about it.  Also, some of the messages are output using:  	dev_dbg(dev->hw_dev, ... or 	dev_info(dev->hw_dev, ...  Unfortunately the hw_dev value is only used by drivers that are doing DMA. For most drivers this variable is going to be NULL so the output is not going to work as expected.  3. Refactor a couple static 'free_resource' functions into the detach    functions.  The 'free_resource' function is only being called by the detach and it makes more sense to just absorb the code.  4. Remove a couple unnecessary braces for single statements.  5. Remove unnecessary comments.  Most of the comedi drivers appear to be based on the comedi skel driver and have the comments from that driver included. These comments make sense in the skel driver for reference but they don't need to be in any of the actual drivers.  6. Remove all the extra whitespace.  It's not needed to make the functions any more readable.  7. Remove the now unused 'attached_successfully' variable in the    cb_pcimdda driver.  This variable was only used to conditionally output some driver noise during the detach. Since all the printk's have been removed this variable is no longer necessary.  Signed-off-by: H Hartley Sweeten <hsweeten@visionengravers.com> Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | comedi.h | s | 29K | 808 | W. Trevor King | wking@drexel.edu | 1334792226 |  | staging: comedi: COMEDI_CB_EOA is also used to report end-of-output.  Update comments in comedi.h accordingly.  Signed-off-by: W. Trevor King <wking@drexel.edu> Acked-by: Ian Abbott <abbotti@mev.co.uk> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | proc.c | s | 2.6K | 81 | Greg Kroah-Hartman | gregkh@suse.de | 1273602963 |  | Staging: comedi: clean up sparse issues in proc.c  The whole file should be converted to use seqfile, if it's even still needed.  Or move to debugfs.  Anyway, I fixed up the minor issues here.  Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Frank Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | comedilib.h | s | 1.4K | 29 | Greg Kroah-Hartman | gregkh@suse.de | 1273602962 |  | Staging: comedi: kcomedilib: make it typesafe  If we really are passing in a struct comedi_device, then say we are, don't mess around with void pointers for no reason.  This also fixes up the comedi_bond.c driver, which is the only user of the kcomedilib code.  Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Frank Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | drivers.c | s | 26K | 902 | Randy Dunlap | rdunlap@xenotime.net | 1339458575 |  | staging/comedi: fix build for USB not enabled  Calls to optional subsystems cannot be made indiscriminately. Enclose all of the usb helper functions inside #if IS_ENABLED(CONFIG_USB) to fix these build errors.  (The pci helper functions are OK since there are stubs in linux/pci.h for the called functions when PCI is not enabled. Possibly the same could be done for the called USB functions.)  ERROR: "usb_deregister" [drivers/staging/comedi/comedi.ko] undefined! ERROR: "usb_register_driver" [drivers/staging/comedi/comedi.ko] undefined!  Signed-off-by: Randy Dunlap <rdunlap@xenotime.net> Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Frank Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | Kconfig | g | 40K |  | H Hartley Sweeten | hartleys@visionengravers.com | 1337386547 |  | staging: comedi: remove all 'default N' in Kconfig  Remove all the 'default N' lines in the comedi Kconfig. They should all be 'default n' but that is the default anyway.  Signed-off-by: H Hartley Sweeten <hsweeten@visionengravers.com> Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
d | kcomedilib |  | 2 items |  | Gustavo Silva | silvagustavosilva@gmail.com | 1278620116 |  | Staging: comedi: kcomedilib: fix coding style issues in kcomedilib_main.c  This is a patch to the kcomedilib_main.c file that fixes up some printk() warning issues.  Signed-off-by: Gustavo Silva <silvagustavo@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | comedi_compat32.c | s | 13K | 404 | Greg Kroah-Hartman | gregkh@suse.de | 1273602963 |  | Staging: comedi: range.c: properly mark up __user pointers  This is the start of cleaning up the user pointer markings in the comedi core.  Cc: Ian Abbott <abbotti@mev.co.uk> Cc: Frank Mori Hess <fmhess@users.sourceforge.net> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
