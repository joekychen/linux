<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › cxt1e1 › musycc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>musycc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_intcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm"> * musycc.c -</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007  One Stop Systems, Inc.</span>
<span class="cm"> * Copyright (C) 2003-2006  SBE, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * For further information, contact via email: support@onestopsystems.com</span>
<span class="cm"> * One Stop Systems, Inc.  Escondido, California  U.S.A.</span>
<span class="cm"> *-----------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &quot;pmcc4_sysdep.h&quot;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;sbecom_inline_linux.h&quot;</span>
<span class="cp">#include &quot;libsbew.h&quot;</span>
<span class="cp">#include &quot;pmcc4_private.h&quot;</span>
<span class="cp">#include &quot;pmcc4.h&quot;</span>
<span class="cp">#include &quot;musycc.h&quot;</span>

<span class="cp">#ifdef SBE_INCLUDE_SYMBOLS</span>
<span class="cp">#define STATIC</span>
<span class="cp">#else</span>
<span class="cp">#define STATIC  static</span>
<span class="cp">#endif</span>

<span class="cp">#define sd_find_chan(ci,ch)   c4_find_chan(ch)</span>


<span class="cm">/*******************************************************************/</span>
<span class="cm">/* global driver variables */</span>
<span class="k">extern</span> <span class="n">ci_t</span> <span class="o">*</span><span class="n">c4_list</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">drvr_state</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">cxt1e1_log_level</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">int</span>  <span class="n">cxt1e1_max_mru</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">cxt1e1_max_mtu</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">max_rxdesc_used</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">max_txdesc_used</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">ci_t</span> <span class="o">*</span><span class="n">CI</span><span class="p">;</span>                <span class="cm">/* dummy pointr to board ZEROE&#39;s data - DEBUG</span>
<span class="cm">                                 * USAGE */</span>


<span class="cm">/*******************************************************************/</span>
<span class="cm">/* forward references */</span>
<span class="kt">void</span>        <span class="n">c4_fifo_free</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">c4_wk_chan_restart</span> <span class="p">(</span><span class="n">mch_t</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">musycc_bh_tx_eom</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">musycc_chan_up</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="n">status_t</span> <span class="n">__init</span> <span class="n">musycc_init</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">musycc_init_port</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">musycc_intr_bh_tasklet</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">u_int32_t</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">musycc_update_timeslots</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*******************************************************************/</span>

<span class="cp">#if 1</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">musycc_dump_rxbuffer_ring</span> <span class="p">(</span><span class="n">mch_t</span> <span class="o">*</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lockit</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">u_int32_t</span> <span class="n">status</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">n</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lockit</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rxlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxd_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  ZERO receive buffers allocated for this channel.&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
        <span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxd_num</span><span class="p">;</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
            <span class="p">{</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%c  %08lx[%2d]: sts %08x (%c%c%c%c:%d.) Data [%08x] Next [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">])</span> <span class="o">?</span> <span class="sc">&#39;F&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                        <span class="n">status</span><span class="p">,</span>
                        <span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">?</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HOST_RX_OWNED</span> <span class="o">?</span> <span class="sc">&#39;H&#39;</span> <span class="o">:</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">POLL_DISABLED</span> <span class="o">?</span> <span class="sc">&#39;P&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOBIRQ_ENABLE</span> <span class="o">?</span> <span class="sc">&#39;b&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOMIRQ_ENABLE</span> <span class="o">?</span> <span class="sc">&#39;m&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">LENGTH_MASK</span><span class="p">,</span>
                        <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
<span class="cp">#ifdef RLD_DUMP_BUFDATA</span>
                <span class="p">{</span>
                    <span class="n">u_int32_t</span>  <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
                    <span class="kt">int</span>         <span class="n">len</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">LENGTH_MASK</span><span class="p">;</span>

<span class="cp">#if 1</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HOST_RX_OWNED</span><span class="p">))</span>
<span class="cp">#else</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>    <span class="cm">/* always dump regardless of valid RX</span>
<span class="cm">                                     * data */</span>
<span class="cp">#endif</span>
                    <span class="p">{</span>
                        <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">OS_phystov</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)));</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    %x[%x]: %08X %08X %08X %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
                                    <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mh">0x08</span><span class="p">)</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    %x[%x]: %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
                                    <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
                        <span class="k">else</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    %x[%x]: %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="p">}</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">snext</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>                               <span class="cm">/* -for- */</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lockit</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rxlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if 1</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">musycc_dump_txbuffer_ring</span> <span class="p">(</span><span class="n">mch_t</span> <span class="o">*</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lockit</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_int32_t</span>   <span class="n">status</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">n</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lockit</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  ZERO transmit buffers allocated for this channel.&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span><span class="p">;</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
            <span class="p">{</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%c%c %08lx[%2d]: sts %08x (%c%c%c%c:%d.) Data [%08x] Next [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;F&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;L&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                        <span class="n">status</span><span class="p">,</span>
                     <span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">?</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MUSYCC_TX_OWNED</span> <span class="o">?</span> <span class="sc">&#39;M&#39;</span> <span class="o">:</span> <span class="sc">&#39;H&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">POLL_DISABLED</span> <span class="o">?</span> <span class="sc">&#39;P&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOBIRQ_ENABLE</span> <span class="o">?</span> <span class="sc">&#39;b&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOMIRQ_ENABLE</span> <span class="o">?</span> <span class="sc">&#39;m&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">status</span> <span class="o">&amp;</span> <span class="n">LENGTH_MASK</span><span class="p">,</span>
                        <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
<span class="cp">#ifdef RLD_DUMP_BUFDATA</span>
                <span class="p">{</span>
                    <span class="n">u_int32_t</span>  <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
                    <span class="kt">int</span>         <span class="n">len</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">LENGTH_MASK</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">OS_phystov</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)));</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    %x[%x]: %08X %08X %08X %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
                                    <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mh">0x08</span><span class="p">)</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    %x[%x]: %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
                                    <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
                        <span class="k">else</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    %x[%x]: %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="p">}</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">snext</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>                               <span class="cm">/* -for- */</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lockit</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * The following supports a backdoor debug facility which can be used to</span>
<span class="cm"> * display the state of a board&#39;s channel.</span>
<span class="cm"> */</span>

<span class="n">status_t</span>
<span class="nf">musycc_dump_ring</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANS_USED</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">SBE_DRVR_FAIL</span><span class="p">;</span>       <span class="cm">/* E2BIG */</span>
    <span class="p">}</span>
    <span class="p">{</span>
        <span class="kt">int</span>         <span class="n">bh</span><span class="p">;</span>

        <span class="n">bh</span> <span class="o">=</span> <span class="n">atomic_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">bh_pending</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; bh_pend %d [%d] ihead %d itail %d [%d] th_cnt %d bh_cnt %d wdcnt %d note %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">bh</span><span class="p">,</span> <span class="n">max_bh</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_headx</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_tailx</span><span class="p">,</span> <span class="n">max_intcnt</span><span class="p">,</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">drvr_intr_thcount</span><span class="p">,</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">drvr_intr_bhcount</span><span class="p">,</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">wdcount</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">wd_notify</span><span class="p">);</span>
        <span class="n">max_bh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                 <span class="cm">/* reset counter */</span>
        <span class="n">max_intcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>             <span class="cm">/* reset counter */</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">sd_find_chan</span> <span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">chan</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; musycc_dump_ring: channel %d not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ENOENT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; CI %p CHANNEL %3d @ %p: state %x status/p %x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;--------------------------------</span><span class="se">\n</span><span class="s">TX Buffer Ring - Channel %d, txd_num %d. (bd/ch pend %d %d), TXD required %d, txpkt %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">chan</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span><span class="p">,</span>
            <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">atomic_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">),</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">atomic_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">),</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_required</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ User 0x%p IRQ_SRV 0x%p USR_ADD 0x%p QStopped %x, start_tx %x tx_full %d txd_free %d mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="p">,</span>
            <span class="n">sd_queue_stopped</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">),</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">);</span>
    <span class="n">musycc_dump_txbuffer_ring</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RX Buffer Ring - Channel %d, rxd_num %d. IRQ_SRV[%d] 0x%p, start_rx %x rxpkt %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">chan</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxd_num</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">],</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
    <span class="n">musycc_dump_rxbuffer_ring</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">SBE_DRVR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">status_t</span>
<span class="nf">musycc_dump_rings</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_chan</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="n">start_chan</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">start_chan</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
        <span class="n">musycc_dump_ring</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">SBE_DRVR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NOTE on musycc_init_mdt():  These MUSYCC writes are only operational after</span>
<span class="cm"> * a MUSYCC GROUP_INIT command has been issued.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">musycc_init_mdt</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_int32_t</span>  <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">i</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * This Idle Code insertion takes effect prior to channel&#39;s first</span>
<span class="cm">     * transmitted  message.  After that, each message contains its own Idle</span>
<span class="cm">     * Code information which is to be issued after the message is</span>
<span class="cm">     * transmitted (Ref.MUSYCC 5.2.2.3: MCENBL bit in Group Configuration</span>
<span class="cm">     * Descriptor).</span>
<span class="cm">     */</span>

    <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">MUSYCC_MDT_BASE03_ADDR</span><span class="p">);</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">CFG_CH_FLAG_7E</span> <span class="o">&lt;&lt;</span> <span class="n">IDLE_CODE</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pci_write_32</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Set TX thp to the next unprocessed md */</span>

<span class="kt">void</span>
<span class="nf">musycc_update_tx_thp</span> <span class="p">(</span><span class="n">mch_t</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">;</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* No MDs with buffers to process */</span>
            <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MUSYCC_TX_OWNED</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* this is the MD to restart TX with */</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">         * Otherwise, we have a valid, host-owned message descriptor which</span>
<span class="cm">         * has been successfully transmitted and whose buffer can be freed,</span>
<span class="cm">         * so... process this MD, it&#39;s owned by the host.  (This might give</span>
<span class="cm">         * as a new, updated txd_irq_srv.)</span>
<span class="cm">         */</span>
        <span class="n">musycc_bh_tx_eom</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">gchan</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">;</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">thp</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">gchan</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">OS_vtophys</span> <span class="p">(</span><span class="n">md</span><span class="p">));</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sd_enable_xmit</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>  <span class="cm">/* re-enable to catch flow controlled</span>
<span class="cm">                                     * channel */</span>
    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_txlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ musycc_update_tx_thp[%d]: setting thp = %p, sts %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is the workq task executed by the OS when our queue_work() is</span>
<span class="cm"> * scheduled and run.  It can fire off either RX or TX ACTIVATION depending</span>
<span class="cm"> * upon the channel&#39;s ch_start_tx and ch_start_rx variables.  This routine</span>
<span class="cm"> * is implemented as a work queue so that the call to the service request is</span>
<span class="cm"> * able to sleep, awaiting an interrupt acknowledgment response (SACK) from</span>
<span class="cm"> * the hardware.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">musycc_wq_chan_restart</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>      <span class="cm">/* channel private structure */</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
    <span class="n">mpi_t</span>      <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    unsigned long flags;</span>
<span class="cp">#endif</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4_chan_info</span><span class="p">,</span> <span class="n">ch_work</span><span class="p">);</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>

<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;wq_chan_restart[%d]: start_RT[%d/%d] status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

<span class="cp">#endif</span>

    <span class="cm">/**********************************/</span>
    <span class="cm">/** check for RX restart request **/</span>
    <span class="cm">/**********************************/</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_ENABLED</span><span class="p">))</span>
    <span class="p">{</span>

        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(RLD_TRANS_DEBUG) || defined(RLD_RXACT_DEBUG)</span>
        <span class="p">{</span>
            <span class="k">static</span> <span class="kt">int</span>  <span class="n">hereb4</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">hereb4</span><span class="p">)</span>             <span class="cm">/* RLD DEBUG */</span>
            <span class="p">{</span>
                <span class="n">hereb4</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
                <span class="n">md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">];</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ musycc_wq_chan_restart[%d] CHAN RX ACTIVATE: rxix_irq_srv %d, md %p sts %x, rxpkt %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
                        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
<span class="cp">#elif defined(RLD_RXACT_DEBUG)</span>
                <span class="n">md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">];</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ musycc_wq_chan_restart[%d] CHAN RX ACTIVATE: rxix_irq_srv %d, md %p sts %x, rxpkt %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
                        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
                <span class="n">musycc_dump_rxbuffer_ring</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>      <span class="cm">/* RLD DEBUG */</span>
<span class="cp">#endif</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_CHANNEL_ACTIVATE</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span> <span class="o">|</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">gchan</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/**********************************/</span>
    <span class="cm">/** check for TX restart request **/</span>
    <span class="cm">/**********************************/</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_ENABLED</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="cm">/* find next unprocessed message, then set TX thp to it */</span>
        <span class="n">musycc_update_tx_thp</span> <span class="p">(</span><span class="n">ch</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        spin_lock_irqsave (&amp;ch-&gt;ch_txlock, flags);</span>
<span class="cp">#endif</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
        <span class="p">{</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;-- musycc_wq_chan_restart[%d]: WARNING, starting NULL md</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">            spin_unlock_irqrestore (&amp;ch-&gt;ch_txlock, flags);</span>
<span class="cp">#endif</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MUSYCC_TX_OWNED</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">            spin_unlock_irqrestore (&amp;ch-&gt;ch_txlock, flags);   /* allow interrupts for service request */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ musycc_wq_chan_restart() CHAN TX ACTIVATE: chan %d txd_irq_srv %p = sts %x, txpkt %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
<span class="cp">#endif</span>
            <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_CHANNEL_ACTIVATE</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span> <span class="o">|</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">gchan</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#ifdef RLD_RESTART_DEBUG</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="cm">/* retain request to start until retried and we have data to xmit */</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;-- musycc_wq_chan_restart[%d]: DELAYED due to md %p sts %x data %x, start_tx %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span>
                    <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
                    <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">);</span>
            <span class="n">musycc_dump_txbuffer_ring</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">            spin_unlock_irqrestore (&amp;ch-&gt;ch_txlock, flags);   /* allow interrupts for service request */</span>
<span class="cp">#endif</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>


 <span class="cm">/*</span>
<span class="cm">  * Channel restart either fires of a workqueue request (2.6) or lodges a</span>
<span class="cm">  * watchdog activation sequence (2.4).</span>
<span class="cm">  */</span>

<span class="kt">void</span>
<span class="nf">musycc_chan_restart</span> <span class="p">(</span><span class="n">mch_t</span> <span class="o">*</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef RLD_RESTART_DEBUG</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ musycc_chan_restart[%d]: txd_irq_srv @ %p = sts %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="cm">/* 2.6 - find next unprocessed message, then set TX thp to it */</span>
<span class="cp">#ifdef RLD_RESTART_DEBUG</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; musycc_chan_restart: scheduling Chan %x workQ @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_work</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">c4_wk_chan_restart</span> <span class="p">(</span><span class="n">ch</span><span class="p">);</span>        <span class="cm">/* work queue mechanism fires off: Ref:</span>
<span class="cm">                                     * musycc_wq_chan_restart () */</span>

<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">rld_put_led</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="n">u_int32_t</span> <span class="n">ledval</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">u_int32_t</span> <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ledval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">led</span> <span class="o">|=</span> <span class="n">ledval</span><span class="p">;</span>

    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cpldbase</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>  <span class="cm">/* RLD DEBUG TRANHANG */</span>
<span class="p">}</span>


<span class="cp">#define MUSYCC_SR_RETRY_CNT  9</span>

<span class="kt">void</span>
<span class="nf">musycc_serv_req</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="n">u_int32_t</span> <span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">volatile</span> <span class="n">u_int32_t</span> <span class="n">r</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">rcnt</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * PORT NOTE: Semaphore protect service loop guarantees only a single</span>
<span class="cm">     * operation at a time.  Per MUSYCC Manual - &quot;Issuing service requests to</span>
<span class="cm">     * the same channel group without first receiving ACK from each request</span>
<span class="cm">     * may cause the host to lose track of which service request has been</span>
<span class="cm">     * acknowledged.&quot;</span>
<span class="cm">     */</span>

    <span class="n">SD_SEM_TAKE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_busy</span><span class="p">,</span> <span class="s">&quot;serv&quot;</span><span class="p">);</span>     <span class="cm">/* only 1 thru here, per</span>
<span class="cm">                                                 * group */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_last</span> <span class="o">==</span> <span class="n">req</span><span class="p">)</span>
    <span class="p">{</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; same SR, Port %d Req %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="cp">#endif</span>

        <span class="cm">/*</span>
<span class="cm">         * The most likely repeated request is the channel activation command</span>
<span class="cm">         * which follows the occurrence of a Transparent mode TX ONR or a</span>
<span class="cm">         * BUFF error.  If the previous command was a CHANNEL ACTIVATE,</span>
<span class="cm">         * precede it with a NOOP command in order maintain coherent control</span>
<span class="cm">         * of this current (re)ACTIVATE.</span>
<span class="cm">         */</span>

        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_last</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SR_GCHANNEL_MASK</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="p">(</span><span class="n">SR_CHANNEL_ACTIVATE</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span><span class="p">))</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="p">(</span><span class="n">SR_CHANNEL_ACTIVATE</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span><span class="p">)))</span>
        <span class="p">{</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; same CHAN ACT SR, Port %d Req %x =&gt; issue SR_NOOP CMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="cp">#endif</span>
            <span class="n">SD_SEM_GIVE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_busy</span><span class="p">);</span>     <span class="cm">/* allow this next request */</span>
            <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_NOOP</span><span class="p">);</span>
            <span class="n">SD_SEM_TAKE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_busy</span><span class="p">,</span> <span class="s">&quot;serv&quot;</span><span class="p">);</span>     <span class="cm">/* relock &amp; continue w/</span>
<span class="cm">                                                         * original req */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">SR_NOOP</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* no need to issue back-to-back SR_NOOP commands at this time */</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&gt;&gt; same Port SR_NOOP skipped, Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
<span class="cp">#endif</span>
            <span class="n">SD_SEM_GIVE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_busy</span><span class="p">);</span>     <span class="cm">/* allow this next request */</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">rcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_last</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
<span class="nl">rewrite:</span>
    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">srd</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

    <span class="cm">/*</span>
<span class="cm">     * Per MUSYCC Manual, Section 6.1,2 - &quot;When writing an SCR service</span>
<span class="cm">     * request, the host must ensure at least one PCI bus clock cycle has</span>
<span class="cm">     * elapsed before writing another service request.  To meet this minimum</span>
<span class="cm">     * elapsed service request write timing interval, it is recommended that</span>
<span class="cm">     * the host follow any SCR write with another operation which reads from</span>
<span class="cm">     * the same address.&quot;</span>
<span class="cm">     */</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pci_read_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">srd</span><span class="p">);</span>      <span class="cm">/* adhere to write</span>
<span class="cm">                                                         * timing imposition */</span>


    <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">!=</span> <span class="n">req</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="n">SR_CHIP_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">rcnt</span> <span class="o">&lt;=</span> <span class="n">MUSYCC_SR_RETRY_CNT</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %d - reissue srv req/last %x/%x (hdw reads %x), Chan %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_last</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="n">MUSYCC_NCHANS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
        <span class="n">OS_uwait_dummy</span> <span class="p">();</span>          <span class="cm">/* this delay helps reduce reissue counts</span>
<span class="cm">                                     * (reason not yet researched) */</span>
        <span class="k">goto</span> <span class="n">rewrite</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="n">MUSYCC_SR_RETRY_CNT</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: failed service request (#%d)= %x, group %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">MUSYCC_SR_RETRY_CNT</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
        <span class="n">SD_SEM_GIVE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_busy</span><span class="p">);</span> <span class="cm">/* allow any next request */</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">SR_CHIP_RESET</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * PORT NOTE: the CHIP_RESET command is NOT ack&#39;d by the MUSYCC, thus</span>
<span class="cm">         * the upcoming delay is used.  Though the MUSYCC documentation</span>
<span class="cm">         * suggests a read-after-write would supply the required delay, it&#39;s</span>
<span class="cm">         * unclear what CPU/BUS clock speeds might have been assumed when</span>
<span class="cm">         * suggesting this &#39;lack of ACK&#39; workaround.  Thus the use of uwait.</span>
<span class="cm">         */</span>
        <span class="n">OS_uwait</span> <span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="s">&quot;icard&quot;</span><span class="p">);</span> <span class="cm">/* 100ms */</span>
    <span class="p">}</span> <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
        <span class="n">SD_SEM_TAKE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_wait</span><span class="p">,</span> <span class="s">&quot;sakack&quot;</span><span class="p">);</span>       <span class="cm">/* sleep until SACK</span>
<span class="cm">                                                         * interrupt occurs */</span>
    <span class="p">}</span>
    <span class="n">SD_SEM_GIVE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_busy</span><span class="p">);</span> <span class="cm">/* allow any next request */</span>
<span class="p">}</span>


<span class="cp">#ifdef  SBE_PMCC4_ENABLE</span>
<span class="kt">void</span>
<span class="nf">musycc_update_timeslots</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>         <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
    <span class="kt">char</span>        <span class="n">e1mode</span> <span class="o">=</span> <span class="n">IS_FRAME_ANY_E1</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">port_mode</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span>         <span class="n">usedby</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

        <span class="n">u_int8_t</span> <span class="n">lastval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">e1mode</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* disable if  E1 mode */</span>
            <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">CFG_FRAME_E1CRC_CAS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">CFG_FRAME_E1CRC_CAS_AMI</span><span class="p">)))</span>
            <span class="o">||</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">e1mode</span><span class="p">)))</span> <span class="cm">/* disable if T1 mode */</span>
        <span class="p">{</span>
            <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>      <span class="cm">/* make tslot unavailable for this mode */</span>
        <span class="p">}</span> <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>      <span class="cm">/* make tslot available for assignment */</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="n">bits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">MUSYCC_NCHANS</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">bitmask</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="p">{</span>
                <span class="n">usedby</span><span class="o">++</span><span class="p">;</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
                <span class="n">lastval</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">bitmask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">lastval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span>
                        <span class="n">bits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
                <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lastval</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usedby</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">usedby</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lastval</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">last</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">usedby</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lastval</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">))</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">last</span><span class="p">;</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">int</span>         <span class="n">idx</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">last</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">rscm</span><span class="p">[</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">bits</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
                <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">tscm</span><span class="p">[</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">bits</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">rtsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">ttsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_TIMESLOT_MAP</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span><span class="p">);</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_TIMESLOT_MAP</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span><span class="p">);</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_SUBCHANNEL_MAP</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span><span class="p">);</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_SUBCHANNEL_MAP</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cp">#ifdef SBE_WAN256T3_ENABLE</span>
<span class="kt">void</span>
<span class="nf">musycc_update_timeslots</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

    <span class="n">u_int8_t</span>    <span class="n">ts</span><span class="p">,</span> <span class="n">hmask</span><span class="p">,</span> <span class="n">tsen</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">gchan</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef SBE_PMCC4_ENABLE</span>
    <span class="n">hmask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">hypersize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SBE_WAN256T3_ENABLE</span>
    <span class="n">hmask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">hyperdummy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">gchan</span> <span class="o">=</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="n">MUSYCC_NCHANS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">hmask</span><span class="p">))</span> <span class="o">%</span> <span class="n">MUSYCC_NCHANS</span><span class="p">;</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">gchan</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">mode_56k</span><span class="p">)</span>
            <span class="n">tsen</span> <span class="o">=</span> <span class="n">MODE_56KBPS</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">tsen</span> <span class="o">=</span> <span class="n">MODE_64KBPS</span><span class="p">;</span>     <span class="cm">/* also the default */</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">32</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="n">tsen</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">hmask</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">rtsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">ttsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_TIMESLOT_MAP</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span><span class="p">);</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_TIMESLOT_MAP</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


 <span class="cm">/*</span>
<span class="cm">  * This routine converts a generic library channel configuration parameter</span>
<span class="cm">  * into a hardware specific register value (IE. MUSYCC CCD Register).</span>
<span class="cm">  */</span>
<span class="n">u_int32_t</span>
<span class="nf">musycc_chan_proto</span> <span class="p">(</span><span class="kt">int</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>         <span class="n">reg</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">CFG_CH_PROTO_TRANS</span>:        <span class="cm">/* 0 */</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">MUSYCC_CCD_TRANS</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CFG_CH_PROTO_SS7</span>:          <span class="cm">/* 1 */</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">MUSYCC_CCD_SS7</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
    <span class="k">case</span> <span class="n">CFG_CH_PROTO_ISLP_MODE</span>:   <span class="cm">/* 4 */</span>
    <span class="k">case</span> <span class="n">CFG_CH_PROTO_HDLC_FCS16</span>:  <span class="cm">/* 2 */</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">MUSYCC_CCD_HDLC_FCS16</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CFG_CH_PROTO_HDLC_FCS32</span>:  <span class="cm">/* 3 */</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">MUSYCC_CCD_HDLC_FCS32</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SBE_WAN256T3_ENABLE</span>
<span class="n">STATIC</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">musycc_init_port</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gbp</span><span class="p">,</span> <span class="n">OS_vtophys</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="p">));</span>

    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">grcd</span> <span class="o">=</span>
        <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">MUSYCC_GRCD_RX_ENABLE</span> <span class="o">|</span>
                                <span class="n">MUSYCC_GRCD_TX_ENABLE</span> <span class="o">|</span>
                                <span class="n">MUSYCC_GRCD_SF_ALIGN</span> <span class="o">|</span>
                                <span class="n">MUSYCC_GRCD_SUBCHAN_DISABLE</span> <span class="o">|</span>
                                <span class="n">MUSYCC_GRCD_OOFMP_DISABLE</span> <span class="o">|</span>
                                <span class="n">MUSYCC_GRCD_COFAIRQ_DISABLE</span> <span class="o">|</span>
                                <span class="n">MUSYCC_GRCD_MC_ENABLE</span> <span class="o">|</span>
                       <span class="p">(</span><span class="n">MUSYCC_GRCD_POLLTH_32</span> <span class="o">&lt;&lt;</span> <span class="n">MUSYCC_GRCD_POLLTH_SHIFT</span><span class="p">));</span>

    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">pcd</span> <span class="o">=</span>
        <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">MUSYCC_PCD_E1X4_MODE</span> <span class="o">|</span>
                                <span class="n">MUSYCC_PCD_TXDATA_RISING</span> <span class="o">|</span>
                                <span class="n">MUSYCC_PCD_TX_DRIVEN</span><span class="p">);</span>

    <span class="cm">/* Message length descriptor */</span>
       <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">mld</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">cxt1e1_max_mru</span> <span class="o">|</span> <span class="p">(</span><span class="n">cxt1e1_max_mru</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_GROUP_INIT</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span><span class="p">);</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_GROUP_INIT</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span><span class="p">);</span>

    <span class="n">musycc_init_mdt</span> <span class="p">(</span><span class="n">pi</span><span class="p">);</span>

    <span class="n">musycc_update_timeslots</span> <span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="n">status_t</span>    <span class="n">__init</span>
<span class="nf">musycc_init</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span>       <span class="o">*</span><span class="n">regaddr</span><span class="p">;</span>        <span class="cm">/* temp for address boundary calculations */</span>
    <span class="kt">int</span>         <span class="n">i</span><span class="p">,</span> <span class="n">gchan</span><span class="p">;</span>

    <span class="n">OS_sem_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">sem_wdbusy</span><span class="p">,</span> <span class="n">SEM_AVAILABLE</span><span class="p">);</span>       <span class="cm">/* watchdog exclusion */</span>

    <span class="cm">/*</span>
<span class="cm">     * Per MUSYCC manual, Section 6.3.4 - &quot;The host must allocate a dword</span>
<span class="cm">     * aligned memory segment for interrupt queue pointers.&quot;</span>
<span class="cm">     */</span>

<span class="cp">#define INT_QUEUE_BOUNDARY  4</span>

    <span class="n">regaddr</span> <span class="o">=</span> <span class="n">OS_kmalloc</span> <span class="p">((</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">regaddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p_saved</span> <span class="o">=</span> <span class="n">regaddr</span><span class="p">;</span>      <span class="cm">/* save orig value for free&#39;s usage */</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">regaddr</span> <span class="o">+</span> <span class="n">INT_QUEUE_BOUNDARY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                               <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">INT_QUEUE_BOUNDARY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>    <span class="cm">/* this calculates</span>
<span class="cm">                                                                 * closest boundary */</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">INT_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">INT_EMPTY_ENTRY</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">max_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">mpi_t</span>      <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="cm">/*</span>
<span class="cm">         * Per MUSYCC manual, Section 6.3.2 - &quot;The host must allocate a 2KB</span>
<span class="cm">         * bound memory segment for Channel Group 0.&quot;</span>
<span class="cm">         */</span>

<span class="cp">#define GROUP_BOUNDARY   0x800</span>

        <span class="n">regaddr</span> <span class="o">=</span> <span class="n">OS_kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">musycc_groupr</span><span class="p">)</span> <span class="o">+</span> <span class="n">GROUP_BOUNDARY</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">regaddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">gchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">gchan</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">gchan</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">gchan</span><span class="p">];</span>
                <span class="n">OS_kfree</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
                <span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram_saved</span> <span class="o">=</span> <span class="n">regaddr</span><span class="p">;</span> <span class="cm">/* save orig value for free&#39;s usage */</span>
        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">musycc_groupr</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">regaddr</span> <span class="o">+</span> <span class="n">GROUP_BOUNDARY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">GROUP_BOUNDARY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>        <span class="cm">/* this calculates</span>
<span class="cm">                                                                                 * closest boundary */</span>
    <span class="p">}</span>

    <span class="cm">/* any board centric MUSYCC commands will use group ZERO as its &quot;home&quot; */</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">regram</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regram</span><span class="p">;</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SR_CHIP_RESET</span><span class="p">);</span>

    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gbp</span><span class="p">,</span> <span class="n">OS_vtophys</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">regram</span><span class="p">));</span>
    <span class="n">pci_flush_write</span> <span class="p">(</span><span class="n">ci</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SBE_PMCC4_NCOMM</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">__glcd</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">GCD_MAGIC</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="cm">/* standard driver POLLS for INTB via CPLD register */</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">__glcd</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">GCD_MAGIC</span> <span class="o">|</span> <span class="n">MUSYCC_GCD_INTB_DISABLE</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">__iqp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">OS_vtophys</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">__iql</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">dacbp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">C_RUNNING</span><span class="p">;</span>          <span class="cm">/* mark as full interrupt processing</span>
<span class="cm">                                     * available */</span>

    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SR_GLOBAL_INIT</span><span class="p">);</span>     <span class="cm">/* FIRST INTERRUPT ! */</span>

    <span class="cm">/* sanity check settable parameters */</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_max_mru</span> <span class="o">&gt;</span> <span class="mh">0xffe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Maximum allowed MRU exceeded, resetting %d to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                  <span class="n">cxt1e1_max_mru</span><span class="p">,</span> <span class="mh">0xffe</span><span class="p">);</span>
               <span class="n">cxt1e1_max_mru</span> <span class="o">=</span> <span class="mh">0xffe</span><span class="p">;</span>
    <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_max_mtu</span> <span class="o">&gt;</span> <span class="mh">0xffe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Maximum allowed MTU exceeded, resetting %d to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                  <span class="n">cxt1e1_max_mtu</span><span class="p">,</span> <span class="mh">0xffe</span><span class="p">);</span>
               <span class="n">cxt1e1_max_mtu</span> <span class="o">=</span> <span class="mh">0xffe</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#ifdef SBE_WAN256T3_ENABLE</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MUSYCC_NPORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">musycc_init_port</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">SBE_DRVR_SUCCESS</span><span class="p">;</span>        <span class="cm">/* no error */</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">musycc_bh_tx_eom</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gchan</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">#ifndef SBE_ISR_INLINE</span>
<span class="c">    unsigned long flags;</span>

<span class="cp">#endif</span>
<span class="cp">#endif</span>
    <span class="k">volatile</span> <span class="n">u_int32_t</span> <span class="n">status</span><span class="p">;</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">gchan</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">UP</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_ERROR</span><span class="p">)</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: intr: xmit EOM on uninitialized channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">gchan</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>                     <span class="cm">/* note: mdt==0 implies a malloc()</span>
<span class="cm">                                     * failure w/in chan_up() routine */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">#ifdef SBE_ISR_INLINE</span>
<span class="c">    spin_lock_irq (&amp;ch-&gt;ch_txlock);</span>
<span class="cp">#else</span>
<span class="c">    spin_lock_irqsave (&amp;ch-&gt;ch_txlock, flags);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * Note: Per MUSYCC Ref 6.4.9, the host does not poll a host-owned</span>
<span class="cm">         * Transmit Buffer Descriptor during Transparent Mode.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MUSYCC_TX_OWNED</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span>         <span class="n">readCount</span><span class="p">,</span> <span class="n">loopCount</span><span class="p">;</span>

            <span class="cm">/***********************************************************/</span>
            <span class="cm">/* HW Bug Fix                                              */</span>
            <span class="cm">/* ----------                                              */</span>
            <span class="cm">/* Under certain PCI Bus loading conditions, the data      */</span>
            <span class="cm">/* associated with an update of Shared Memory is delayed   */</span>
            <span class="cm">/* relative to its PCI Interrupt.  This is caught when     */</span>
            <span class="cm">/* the host determines it does not yet OWN the descriptor. */</span>
            <span class="cm">/***********************************************************/</span>

            <span class="n">readCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MUSYCC_TX_OWNED</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">loopCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loopCount</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">loopCount</span><span class="o">++</span><span class="p">)</span>
                    <span class="n">OS_uwait_dummy</span> <span class="p">();</span>  <span class="cm">/* use call to avoid optimization</span>
<span class="cm">                                         * removal of dummy delay */</span>
                <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readCount</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>          <span class="cm">/* don&#39;t wait any longer */</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MUSYCC_TX_OWNED</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Port %d Chan %2d - unexpected TX msg ownership intr (md %p sts %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span>
                            <span class="n">md</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
                    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ User 0x%p IRQ_SRV 0x%p USR_ADD 0x%p QStopped %x, start_tx %x tx_full %d txd_free %d mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="p">,</span>
                            <span class="n">sd_queue_stopped</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">),</span>
                            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">);</span>
                    <span class="n">musycc_dump_txbuffer_ring</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>              <span class="cm">/* Not our mdesc, done */</span>
            <span class="p">}</span> <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
                    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Port %d Chan %2d - recovered TX msg ownership [%d] (md %p sts %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">readCount</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">snext</span><span class="p">;</span>

        <span class="n">md</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* upcount channel */</span>
            <span class="n">atomic_sub</span> <span class="p">(</span><span class="n">OS_mem_token_tlen</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">);</span>
            <span class="cm">/* upcount card */</span>
            <span class="n">atomic_sub</span> <span class="p">(</span><span class="n">OS_mem_token_tlen</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">);</span>
<span class="cp">#ifdef SBE_WAN256T3_ENABLE</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">))</span>
                <span class="n">wan256t3_led</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">LED_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SBE_WAN256T3_NCOMM</span>
            <span class="cm">/* callback that our packet was sent */</span>
            <span class="p">{</span>
                <span class="kt">int</span>         <span class="n">hdlcnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">gchan</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hdlcnum</span> <span class="o">&gt;=</span> <span class="mi">228</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">nciProcess_TX_complete</span><span class="p">)</span>
                        <span class="p">(</span><span class="o">*</span><span class="n">nciProcess_TX_complete</span><span class="p">)</span> <span class="p">(</span><span class="n">hdlcnum</span><span class="p">,</span>
                                                   <span class="n">getuserbychan</span> <span class="p">(</span><span class="n">gchan</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>
<span class="cp">#endif                              </span><span class="cm">/*** CONFIG_SBE_WAN256T3_NCOMM ***/</span><span class="cp"></span>

            <span class="n">OS_mem_token_free_irq</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span><span class="p">);</span>
            <span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef RLD_TXFULL_DEBUG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;~~ tx_eom: tx_full %x  txd_free %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
        <span class="o">++</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">;</span>
        <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">!=</span> <span class="n">CFG_CH_PROTO_TRANS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOBIRQ_ENABLE</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Mode (%x) incorrect EOB status (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOMIRQ_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">!=</span> <span class="n">CFG_CH_PROTO_TRANS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EOMIRQ_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
    <span class="cm">/*</span>
<span class="cm">     * NOTE: (The above &#39;while&#39; is coupled w/ previous &#39;do&#39;, way above.) Each</span>
<span class="cm">     * Transparent data buffer has the EOB bit, and NOT the EOM bit, set and</span>
<span class="cm">     * will furthermore have a separate IQD associated with each messages</span>
<span class="cm">     * buffer.</span>
<span class="cm">     */</span>

    <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
    <span class="cm">/*</span>
<span class="cm">     * Smooth flow control hysterisis by maintaining task stoppage until half</span>
<span class="cm">     * the available write buffers are available.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Then, only releave task stoppage if we actually have enough</span>
<span class="cm">         * buffers to service the last requested packet.  It may require MORE</span>
<span class="cm">         * than half the available!</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span> <span class="o">&gt;=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_required</span><span class="p">)</span>
        <span class="p">{</span>

<span class="cp">#ifdef RLD_TXFULL_DEBUG</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tx_eom[%d]: enable xmit tx_full no more, txd_free %d txd_num/2 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span>
                        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">sd_enable_xmit</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>  <span class="cm">/* re-enable to catch flow controlled</span>
<span class="cm">                                         * channel */</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#ifdef RLD_TXFULL_DEBUG</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tx_eom[%d]: bypass TX enable though room available? (txd_free %d txd_num/2 %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">#ifdef SBE_ISR_INLINE</span>
<span class="c">    spin_unlock_irq (&amp;ch-&gt;ch_txlock);</span>
<span class="cp">#else</span>
<span class="c">    spin_unlock_irqrestore (&amp;ch-&gt;ch_txlock, flags);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">musycc_bh_rx_eom</span> <span class="p">(</span><span class="n">mpi_t</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gchan</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
    <span class="kt">void</span>       <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">m2</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="n">u_int32_t</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">u_int32_t</span>   <span class="n">error</span><span class="p">;</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">gchan</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">UP</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;</span> <span class="n">LOG_ERROR</span><span class="p">)</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: intr: receive EOM on uninitialized channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">gchan</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>                     <span class="cm">/* can this happen ? */</span>

    <span class="k">for</span> <span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
        <span class="n">md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span><span class="p">];</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HOST_RX_OWNED</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>                  <span class="cm">/* Not our mdesc, done */</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span><span class="p">;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SBE_WAN256T3_NCOMM</span>
            <span class="kt">int</span>         <span class="n">hdlcnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">gchan</span><span class="p">);</span>

            <span class="cm">/*</span>
<span class="cm">             * if the packet number belongs to NCOMM, then send it to the TMS</span>
<span class="cm">             * driver</span>
<span class="cm">             */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">hdlcnum</span> <span class="o">&gt;=</span> <span class="mi">228</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nciProcess_RX_packet</span><span class="p">)</span>
                    <span class="p">(</span><span class="o">*</span><span class="n">nciProcess_RX_packet</span><span class="p">)</span> <span class="p">(</span><span class="n">hdlcnum</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif                              </span><span class="cm">/*** CONFIG_SBE_WAN256T3_NCOMM ***/</span><span class="cp"></span>

            <span class="p">{</span>
                               <span class="k">if</span> <span class="p">((</span><span class="n">m2</span> <span class="o">=</span> <span class="n">OS_mem_token_alloc</span> <span class="p">(</span><span class="n">cxt1e1_max_mru</span><span class="p">)))</span>
                <span class="p">{</span>
                    <span class="cm">/* substitute the mbuf+cluster */</span>
                    <span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span> <span class="o">=</span> <span class="n">m2</span><span class="p">;</span>
                    <span class="n">md</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">OS_vtophys</span> <span class="p">(</span><span class="n">OS_mem_token_data</span> <span class="p">(</span><span class="n">m2</span><span class="p">)));</span>

                    <span class="cm">/* pass the received mbuf upward */</span>
                    <span class="n">sd_recv_consume</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">LENGTH_MASK</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">LENGTH_MASK</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_FCS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_ALIGN</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_ABT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_LNG</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_SHT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
               <span class="n">status</span> <span class="o">=</span> <span class="n">cxt1e1_max_mru</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">==</span> <span class="n">CFG_CH_PROTO_TRANS</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">|=</span> <span class="n">EOBIRQ_ENABLE</span><span class="p">;</span>
        <span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>

        <span class="cm">/* Check next mdesc in the ring */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span> <span class="o">&gt;=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxd_num</span><span class="p">)</span>
            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxix_irq_srv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="n">irqreturn_t</span>
<span class="nf">musycc_intr_th_handler</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ci_t</span>       <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">devp</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="n">u_int32_t</span> <span class="n">status</span><span class="p">,</span> <span class="n">currInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_int32_t</span>   <span class="n">nextInt</span><span class="p">,</span> <span class="n">intCnt</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Hardware not available, potential interrupt hang.  But since interrupt</span>
<span class="cm">     * might be shared, just return.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">C_INIT</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * Marked as hardware available. Don&#39;t service interrupts, just clear the</span>
<span class="cm">     * event.</span>
<span class="cm">     */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">C_IDLE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">pci_read_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">);</span>

        <span class="cm">/* clear the interrupt but process nothing else */</span>
        <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">FLUSH_PCI_READ</span> <span class="p">();</span>
    <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">pci_read_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">);</span>
    <span class="n">nextInt</span> <span class="o">=</span> <span class="n">INTRPTS_NEXTINT</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="n">intCnt</span> <span class="o">=</span> <span class="n">INTRPTS_INTCNT</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">drvr_intr_thcount</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/*********************************************************/</span>
    <span class="cm">/* HW Bug Fix                                            */</span>
    <span class="cm">/* ----------                                            */</span>
    <span class="cm">/* Under certain PCI Bus loading conditions, the         */</span>
    <span class="cm">/* MUSYCC looses the data associated with an update      */</span>
    <span class="cm">/* of its ISD and erroneously returns the immediately    */</span>
    <span class="cm">/* preceding &#39;nextInt&#39; value.  However, the &#39;intCnt&#39;     */</span>
    <span class="cm">/* value appears to be correct.  By not starting service */</span>
    <span class="cm">/* where the &#39;missing&#39; &#39;nextInt&#39; SHOULD point causes     */</span>
    <span class="cm">/* the IQD not to be serviced - the &#39;not serviced&#39;       */</span>
    <span class="cm">/* entries then remain and continue to increase as more  */</span>
    <span class="cm">/* incorrect ISD&#39;s are encountered.                      */</span>
    <span class="cm">/*********************************************************/</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">nextInt</span> <span class="o">!=</span> <span class="n">INTRPTS_NEXTINT</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">this_status_new</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: note - updated ISD from %08x to %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
              <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">INTRPTS_NEXTINT_M</span><span class="p">))</span> <span class="o">|</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">this_status_new</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">         * Replace bogus status with software corrected value.</span>
<span class="cm">         *</span>
<span class="cm">         * It&#39;s not known whether, during this problem occurrence, if the</span>
<span class="cm">         * INTFULL bit is correctly reported or not.</span>
<span class="cm">         */</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">INTRPTS_NEXTINT_M</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">this_status_new</span><span class="p">);</span>
        <span class="n">nextInt</span> <span class="o">=</span> <span class="n">INTRPTS_NEXTINT</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/**********************************************/</span>
    <span class="cm">/* Cn847x Bug Fix                             */</span>
    <span class="cm">/* --------------                             */</span>
    <span class="cm">/* Fix for inability to write back same index */</span>
    <span class="cm">/* as read for a full interrupt queue.        */</span>
    <span class="cm">/**********************************************/</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">intCnt</span> <span class="o">==</span> <span class="n">INT_QUEUE_SIZE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">currInt</span> <span class="o">=</span> <span class="p">((</span><span class="n">intCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">nextInt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="cm">/************************************************/</span>
        <span class="cm">/* Interrupt Write Location Issues              */</span>
        <span class="cm">/* -------------------------------              */</span>
        <span class="cm">/* When the interrupt status descriptor is      */</span>
        <span class="cm">/* written, the interrupt line is de-asserted   */</span>
        <span class="cm">/* by the Cn847x.  In the case of MIPS          */</span>
        <span class="cm">/* microprocessors, this must occur at the      */</span>
        <span class="cm">/* beginning of the interrupt handler so that   */</span>
        <span class="cm">/* the interrupt handle is not re-entered due   */</span>
        <span class="cm">/* to interrupt dis-assertion latency.          */</span>
        <span class="cm">/* In the case of all other processors, this    */</span>
        <span class="cm">/* action should occur at the end of the        */</span>
        <span class="cm">/* interrupt handler to avoid overwriting the   */</span>
        <span class="cm">/* interrupt queue.                             */</span>
        <span class="cm">/************************************************/</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">intCnt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">currInt</span> <span class="o">=</span> <span class="p">(</span><span class="n">intCnt</span> <span class="o">+</span> <span class="n">nextInt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * NOTE: Servicing an interrupt whose ISD contains a count of ZERO</span>
<span class="cm">         * can be indicative of a Shared Interrupt chain.  Our driver can be</span>
<span class="cm">         * called from the system&#39;s interrupt handler as a matter of the OS</span>
<span class="cm">         * walking the chain.  As the chain is walked, the interrupt will</span>
<span class="cm">         * eventually be serviced by the correct driver/handler.</span>
<span class="cm">         */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        /* chained interrupt = not ours */</span>
<span class="c">        pr_info(&quot;&gt;&gt; %s: intCnt NULL, sts %x, possibly a chained interrupt!\n&quot;,</span>
<span class="c">                ci-&gt;devname, status);</span>
<span class="cp">#endif</span>
        <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_tailx</span> <span class="o">=</span> <span class="n">currInt</span><span class="p">;</span>

    <span class="n">currInt</span> <span class="o">&lt;&lt;=</span> <span class="n">INTRPTS_NEXTINT_S</span><span class="p">;</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">last_status_new</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">this_status_new</span><span class="p">;</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">this_status_new</span> <span class="o">=</span> <span class="n">currInt</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_WARN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">INTRPTS_INTFULL_M</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Interrupt queue full condition occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_DEBUG</span><span class="p">)</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: interrupts pending, isd @ 0x%p: %x curr %d cnt %d NEXT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">,</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">nextInt</span><span class="p">,</span> <span class="n">intCnt</span><span class="p">,</span> <span class="p">(</span><span class="n">intCnt</span> <span class="o">+</span> <span class="n">nextInt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
<span class="cp">#if defined(SBE_ISR_TASKLET)</span>
    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">,</span> <span class="n">currInt</span><span class="p">);</span>
    <span class="n">atomic_inc</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">bh_pending</span><span class="p">);</span>
    <span class="n">tasklet_schedule</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">ci_musycc_isr_tasklet</span><span class="p">);</span>
<span class="cp">#elif defined(SBE_ISR_IMMEDIATE)</span>
    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">,</span> <span class="n">currInt</span><span class="p">);</span>
    <span class="n">atomic_inc</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">bh_pending</span><span class="p">);</span>
    <span class="n">queue_task</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">ci_musycc_isr_tq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tq_immediate</span><span class="p">);</span>
    <span class="n">mark_bh</span> <span class="p">(</span><span class="n">IMMEDIATE_BH</span><span class="p">);</span>
<span class="cp">#elif defined(SBE_ISR_INLINE)</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">musycc_intr_bh_tasklet</span> <span class="p">(</span><span class="n">ci</span><span class="p">);</span>
    <span class="n">pci_write_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isd</span><span class="p">,</span> <span class="n">currInt</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if defined(SBE_ISR_IMMEDIATE)</span>
<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="cp">#else</span>
<span class="kt">void</span>
<span class="cp">#endif</span>
<span class="n">musycc_intr_bh_tasklet</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mpi_t</span>      <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intCnt</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="n">u_int32_t</span> <span class="n">currInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">headx</span><span class="p">,</span> <span class="n">tailx</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">readCount</span><span class="p">,</span> <span class="n">loopCount</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">group</span><span class="p">,</span> <span class="n">gchan</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">tx</span><span class="p">;</span>
    <span class="n">u_int32_t</span>   <span class="n">badInt</span> <span class="o">=</span> <span class="n">INT_EMPTY_ENTRY</span><span class="p">;</span>
    <span class="n">u_int32_t</span>   <span class="n">badInt2</span> <span class="o">=</span> <span class="n">INT_EMPTY_ENTRY2</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Hardware not available, potential interrupt hang.  But since interrupt</span>
<span class="cm">     * might be shared, just return.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">drvr_state</span> <span class="o">!=</span> <span class="n">SBE_DRVR_AVAILABLE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">C_INIT</span><span class="p">))</span>
    <span class="p">{</span>
<span class="cp">#if defined(SBE_ISR_IMMEDIATE)</span>
        <span class="k">return</span> <span class="mi">0L</span><span class="p">;</span>
<span class="cp">#else</span>
        <span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="cp">#if defined(SBE_ISR_TASKLET) || defined(SBE_ISR_IMMEDIATE)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">drvr_state</span> <span class="o">!=</span> <span class="n">SBE_DRVR_AVAILABLE</span><span class="p">)</span>
    <span class="p">{</span>
<span class="cp">#if defined(SBE_ISR_TASKLET)</span>
        <span class="k">return</span><span class="p">;</span>
<span class="cp">#elif defined(SBE_ISR_IMMEDIATE)</span>
        <span class="k">return</span> <span class="mi">0L</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="cp">#elif defined(SBE_ISR_INLINE)</span>
    <span class="cm">/* no semaphore taken, no double checks */</span>
<span class="cp">#endif</span>

    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">drvr_intr_bhcount</span><span class="o">++</span><span class="p">;</span>
    <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bh</span> <span class="o">=</span> <span class="n">atomic_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">bh_pending</span><span class="p">);</span>

        <span class="n">max_bh</span> <span class="o">=</span> <span class="n">max</span> <span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">max_bh</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">atomic_set</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">bh_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="cm">/* if here, no longer pending */</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">headx</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_headx</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tailx</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_tailx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">intCnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">tailx</span> <span class="o">&gt;=</span> <span class="n">headx</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">tailx</span> <span class="o">-</span> <span class="n">headx</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">tailx</span> <span class="o">-</span> <span class="n">headx</span> <span class="o">+</span> <span class="n">INT_QUEUE_SIZE</span><span class="p">);</span>
        <span class="n">currInt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">headx</span><span class="p">]);</span>

        <span class="n">max_intcnt</span> <span class="o">=</span> <span class="n">max</span> <span class="p">(</span><span class="n">intCnt</span><span class="p">,</span> <span class="n">max_intcnt</span><span class="p">);</span>  <span class="cm">/* RLD DEBUG */</span>

        <span class="cm">/**************************************************/</span>
        <span class="cm">/* HW Bug Fix                                     */</span>
        <span class="cm">/* ----------                                     */</span>
        <span class="cm">/* The following code checks for the condition    */</span>
        <span class="cm">/* of interrupt assertion before interrupt        */</span>
        <span class="cm">/* queue update.  This is a problem on several    */</span>
        <span class="cm">/* PCI-Local bridge chips found on some products. */</span>
        <span class="cm">/**************************************************/</span>

        <span class="n">readCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt2</span><span class="p">))</span>
            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">intlog</span><span class="p">.</span><span class="n">drvr_int_failure</span><span class="o">++</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">((</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt2</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">loopCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loopCount</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">loopCount</span><span class="o">++</span><span class="p">)</span>
                <span class="n">OS_uwait_dummy</span> <span class="p">();</span>  <span class="cm">/* use call to avoid optimization removal</span>
<span class="cm">                                     * of dummy delay */</span>
            <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
            <span class="n">currInt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">headx</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">readCount</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt2</span><span class="p">))</span>        <span class="cm">/* catch failure of Bug</span>
<span class="cm">                                                                 * Fix checking */</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_WARN</span><span class="p">)</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Illegal Interrupt Detected @ 0x%p, mod %d.)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">headx</span><span class="p">],</span> <span class="n">headx</span><span class="p">);</span>

            <span class="cm">/*</span>
<span class="cm">             * If the descriptor has not recovered, then leaving the EMPTY</span>
<span class="cm">             * entry set will not signal to the MUSYCC that this descriptor</span>
<span class="cm">             * has been serviced. The Interrupt Queue can then start losing</span>
<span class="cm">             * available descriptors and MUSYCC eventually encounters and</span>
<span class="cm">             * reports the INTFULL condition.  Per manual, changing any bit</span>
<span class="cm">             * marks descriptor as available, thus the use of different</span>
<span class="cm">             * EMPTY_ENTRY values.</span>
<span class="cm">             */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">currInt</span> <span class="o">==</span> <span class="n">badInt</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">headx</span><span class="p">]</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">INT_EMPTY_ENTRY2</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">headx</span><span class="p">]</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">INT_EMPTY_ENTRY</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_headx</span> <span class="o">=</span> <span class="p">(</span><span class="n">headx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* insure wrapness */</span>
            <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
            <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">INTRPT_GRP</span> <span class="p">(</span><span class="n">currInt</span><span class="p">);</span>
        <span class="n">gchan</span> <span class="o">=</span> <span class="n">INTRPT_CH</span> <span class="p">(</span><span class="n">currInt</span><span class="p">);</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">INTRPT_EVENT</span> <span class="p">(</span><span class="n">currInt</span><span class="p">);</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">INTRPT_ERROR</span> <span class="p">(</span><span class="n">currInt</span><span class="p">);</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">currInt</span> <span class="o">&amp;</span> <span class="n">INTRPT_DIR_M</span><span class="p">;</span>

        <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqd_p</span><span class="p">[</span><span class="n">headx</span><span class="p">]</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">INT_EMPTY_ENTRY</span><span class="p">);</span>
        <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_DEBUG</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; %08x -&gt; err: %2d,&quot;</span><span class="p">,</span> <span class="n">currInt</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;+ interrupt event: %d, grp: %d, chan: %2d, side: %cX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">gchan</span><span class="p">,</span> <span class="n">tx</span> <span class="o">?</span> <span class="sc">&#39;T&#39;</span> <span class="o">:</span> <span class="sc">&#39;R&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">group</span><span class="p">];</span>      <span class="cm">/* notice that here we assume 1-1 group -</span>
<span class="cm">                                     * port mapping */</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">gchan</span><span class="p">];</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="n">EVE_SACK</span>:              <span class="cm">/* Service Request Acknowledge */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_DEBUG</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">volatile</span> <span class="n">u_int32_t</span> <span class="n">r</span><span class="p">;</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">pci_read_32</span> <span class="p">((</span><span class="n">u_int32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">srd</span><span class="p">);</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;- SACK cmd: %08x (hdw= %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_last</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">SD_SEM_GIVE</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sr_sem_wait</span><span class="p">);</span>     <span class="cm">/* wake up waiting process */</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EVE_CHABT</span>:     <span class="cm">/* Change To Abort Code (0x7e -&gt; 0xff) */</span>
        <span class="k">case</span> <span class="n">EVE_CHIC</span>:              <span class="cm">/* Change To Idle Code (0xff -&gt; 0x7e) */</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EVE_EOM</span>:               <span class="cm">/* End Of Message */</span>
        <span class="k">case</span> <span class="n">EVE_EOB</span>:               <span class="cm">/* End Of Buffer (Transparent mode) */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">musycc_bh_tx_eom</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">gchan</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">musycc_bh_rx_eom</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">gchan</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">            break;</span>
<span class="cp">#else</span>
            <span class="cm">/*</span>
<span class="cm">             * MUSYCC Interrupt Descriptor section states that EOB and EOM</span>
<span class="cm">             * can be combined with the NONE error (as well as others).  So</span>
<span class="cm">             * drop thru to catch this...</span>
<span class="cm">             */</span>
<span class="cp">#endif</span>
        <span class="k">case</span> <span class="n">EVE_NONE</span>:
            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">ERR_SHT</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_WARN</span><span class="p">)</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unexpected interrupt event: %d, iqd[%d]: %08x, port: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span>
                        <span class="n">event</span><span class="p">,</span> <span class="n">headx</span><span class="p">,</span> <span class="n">currInt</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>                           <span class="cm">/* switch on event */</span>


        <span class="cm">/*</span>
<span class="cm">         * Per MUSYCC Manual, Section 6.4.8.3 [Transmit Errors], TX errors</span>
<span class="cm">         * are service-affecting and require action to resume normal</span>
<span class="cm">         * bit-level processing.</span>
<span class="cm">         */</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="n">ERR_ONR</span>:
            <span class="cm">/*</span>
<span class="cm">             * Per MUSYCC manual, Section  6.4.8.3 [Transmit Errors], this</span>
<span class="cm">             * error requires Transmit channel reactivation.</span>
<span class="cm">             *</span>
<span class="cm">             * Per MUSYCC manual, Section  6.4.8.4 [Receive Errors], this error</span>
<span class="cm">             * requires Receive channel reactivation.</span>
<span class="cm">             */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
            <span class="p">{</span>

                <span class="cm">/*</span>
<span class="cm">                 * TX ONR Error only occurs when channel is configured for</span>
<span class="cm">                 * Transparent Mode.  However, this code will catch and</span>
<span class="cm">                 * re-activate on ANY TX ONR error.</span>
<span class="cm">                 */</span>

                <span class="cm">/*</span>
<span class="cm">                 * Set flag to re-enable on any next transmit attempt.</span>
<span class="cm">                 */</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span> <span class="o">=</span> <span class="n">CH_START_TX_ONR</span><span class="p">;</span>

                <span class="p">{</span>
<span class="cp">#ifdef RLD_TRANS_DEBUG</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">||</span> <span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
<span class="cp">#else</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
<span class="cp">#endif</span>
                    <span class="p">{</span>
                        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: TX buffer underflow [ONR] on channel %d, mode %x QStopped %x free %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">,</span> <span class="n">sd_queue_stopped</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">),</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">);</span>
<span class="cp">#ifdef RLD_DEBUG</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>       <span class="cm">/* problem = ONR on HDLC</span>
<span class="cm">                                                         * mode */</span>
                        <span class="p">{</span>
                            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ Failed Last %x Next %x QStopped %x, start_tx %x tx_full %d txd_free %d mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_irq_srv</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span><span class="p">)</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="p">,</span>
                                    <span class="n">sd_queue_stopped</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">),</span>
                                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">);</span>
                            <span class="n">musycc_dump_txbuffer_ring</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="p">}</span>
<span class="cp">#endif</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span>                  <span class="cm">/* RX buffer overrun */</span>
            <span class="p">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * Per MUSYCC manual, Section 6.4.8.4 [Receive Errors],</span>
<span class="cm">                 * channel recovery for this RX ONR error IS required.  It is</span>
<span class="cm">                 * also suggested to increase the number of receive buffers</span>
<span class="cm">                 * for this channel.  Receive channel reactivation IS</span>
<span class="cm">                 * required, and data has been lost.</span>
<span class="cm">                 */</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span> <span class="o">=</span> <span class="n">CH_START_RX_ONR</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_WARN</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: RX buffer overflow [ONR] on channel %d, mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>musycc<em>dump</em>rxbuffer_ring (ch, 0);        /* RLD DEBUG */</p></td><td class="code"><div class="highlight"><pre>                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">musycc_chan_restart</span> <span class="p">(</span><span class="n">ch</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">ERR_BUF</span>:
            <span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span> <span class="o">=</span> <span class="n">CH_START_TX_BUF</span><span class="p">;</span>
                <span class="cm">/*</span>
<span class="cm">                 * Per MUSYCC manual, Section  6.4.8.3 [Transmit Errors],</span>
<span class="cm">                 * this BUFF error requires Transmit channel reactivation.</span>
<span class="cm">                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR</span><span class="p">)</span>
                    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: TX buffer underrun [BUFF] on channel %d, mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span>                  <span class="cm">/* RX buffer overrun */</span>
            <span class="p">{</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
                <span class="cm">/*</span>
<span class="cm">                 * Per MUSYCC manual, Section 6.4.8.4 [Receive Errors], HDLC</span>
<span class="cm">                 * mode requires NO recovery for this RX BUFF error is</span>
<span class="cm">                 * required.  It is suggested to increase the FIFO buffer</span>
<span class="cm">                 * space for this channel.  Receive channel reactivation is</span>
<span class="cm">                 * not required, but data has been lost.</span>
<span class="cm">                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_WARN</span><span class="p">)</span>
                    <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: RX buffer overrun [BUFF] on channel %d, mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span><span class="p">);</span>
                <span class="cm">/*</span>
<span class="cm">                 * Per MUSYCC manual, Section 6.4.9.4 [Receive Errors],</span>
<span class="cm">                 * Transparent mode DOES require recovery for the RX BUFF</span>
<span class="cm">                 * error.  It is suggested to increase the FIFO buffer space</span>
<span class="cm">                 * for this channel.  Receive channel reactivation IS</span>
<span class="cm">                 * required and data has been lost.</span>
<span class="cm">                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">==</span> <span class="n">CFG_CH_PROTO_TRANS</span><span class="p">)</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span> <span class="o">=</span> <span class="n">CH_START_RX_BUF</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">||</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">==</span> <span class="n">CFG_CH_PROTO_TRANS</span><span class="p">))</span>
                <span class="n">musycc_chan_restart</span> <span class="p">(</span><span class="n">ch</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>                           <span class="cm">/* switch on err */</span>

        <span class="cm">/* Check for interrupt lost condition */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">currInt</span> <span class="o">&amp;</span> <span class="n">INTRPT_ILOST_M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_ERROR</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Interrupt queue overflow - ILOST asserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_headx</span> <span class="o">=</span> <span class="p">(</span><span class="n">headx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_QUEUE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>     <span class="cm">/* insure wrapness */</span>
        <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
        <span class="n">FLUSH_MEM_READ</span> <span class="p">();</span>
    <span class="p">}</span>                               <span class="cm">/* while */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_headx</span> <span class="o">!=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_tailx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">int</span>         <span class="n">bh</span><span class="p">;</span>

        <span class="n">bh</span> <span class="o">=</span> <span class="n">atomic_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">bh_pending</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;_bh_: late arrivals, head %d != tail %d, pending %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_headx</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">iqp_tailx</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#if defined(SBE_ISR_IMMEDIATE)</span>
    <span class="k">return</span> <span class="mi">0L</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="cm">/* else, nothing returned */</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">int         __init</span>
<span class="c">musycc_new_chan (ci_t * ci, int channum, void *user)</span>
<span class="c">{</span>
<span class="c">    mch_t      *ch;</span>

<span class="c">    ch = ci-&gt;port[channum / MUSYCC_NCHANS].chan[channum % MUSYCC_NCHANS];</span>

<span class="c">    if (ch-&gt;state != UNASSIGNED)</span>
<span class="c">        return EEXIST;</span>
<span class="c">    /* NOTE: mch_t already cleared during OS_kmalloc() */</span>
<span class="c">    ch-&gt;state = DOWN;</span>
<span class="c">    ch-&gt;user = user;</span>
<span class="cp">#if 0</span>
<span class="c">    ch-&gt;status = 0;</span>
<span class="c">    ch-&gt;p.status = 0;</span>
<span class="c">    ch-&gt;p.intr_mask = 0;</span>
<span class="cp">#endif</span>
<span class="c">    ch-&gt;p.chan_mode = CFG_CH_PROTO_HDLC_FCS16;</span>
<span class="c">    ch-&gt;p.idlecode = CFG_CH_FLAG_7E;</span>
<span class="c">    ch-&gt;p.pad_fill_count = 2;</span>
<span class="c">    spin_lock_init (&amp;ch-&gt;ch_rxlock);</span>
<span class="c">    spin_lock_init (&amp;ch-&gt;ch_txlock);</span>

<span class="c">    return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="cp">#ifdef SBE_PMCC4_ENABLE</span>
<span class="n">status_t</span>
<span class="n">musycc_chan_down</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mpi_t</span>      <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">i</span><span class="p">,</span> <span class="n">gchan</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">sd_find_chan</span> <span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">channum</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>
    <span class="n">gchan</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">gchan</span><span class="p">;</span>

    <span class="cm">/* Deactivate the channel */</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_CHANNEL_DEACTIVATE</span> <span class="o">|</span> <span class="n">SR_RX_DIRECTION</span> <span class="o">|</span> <span class="n">gchan</span><span class="p">);</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">musycc_serv_req</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SR_CHANNEL_DEACTIVATE</span> <span class="o">|</span> <span class="n">SR_TX_DIRECTION</span> <span class="o">|</span> <span class="n">gchan</span><span class="p">);</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DOWN</span><span class="p">;</span>

    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">thp</span><span class="p">[</span><span class="n">gchan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">[</span><span class="n">gchan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">[</span><span class="n">gchan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regram</span><span class="o">-&gt;</span><span class="n">rmp</span><span class="p">[</span><span class="n">gchan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_token</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">OS_mem_token_free</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_token</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxd_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_token</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">OS_mem_token_free</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_token</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">OS_kfree</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">);</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rxd_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">OS_kfree</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdt</span><span class="p">);</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">mdt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">musycc_update_timeslots</span> <span class="p">(</span><span class="n">pi</span><span class="p">);</span>
    <span class="n">c4_fifo_free</span> <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">gchan</span><span class="p">);</span>

    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">openchans</span><span class="o">--</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="kt">int</span>
<span class="n">musycc_del_chan</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">channum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channum</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">MUSYCC_NPORTS</span> <span class="o">*</span> <span class="n">MUSYCC_NCHANS</span><span class="p">)))</span>  <span class="cm">/* sanity chk param */</span>
        <span class="k">return</span> <span class="n">ECHRNG</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">sd_find_chan</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">channum</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ENOENT</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UP</span><span class="p">)</span>
        <span class="n">musycc_chan_down</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">channum</span><span class="p">);</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UNASSIGNED</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="n">musycc_del_chan_stats</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">channum</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channum</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">MUSYCC_NPORTS</span> <span class="o">*</span> <span class="n">MUSYCC_NCHANS</span><span class="p">))</span>      <span class="cm">/* sanity chk param */</span>
        <span class="k">return</span> <span class="n">ECHRNG</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">sd_find_chan</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">channum</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ENOENT</span><span class="p">;</span>

    <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sbecom_chan_stats</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="n">musycc_start_xmit</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channum</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem_token</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mch_t</span>      <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mdesc</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
    <span class="kt">void</span>       <span class="o">*</span><span class="n">m2</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    unsigned long flags;</span>
<span class="cp">#endif</span>
    <span class="kt">int</span>         <span class="n">txd_need_cnt</span><span class="p">;</span>
    <span class="n">u_int32_t</span>   <span class="n">len</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">sd_find_chan</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">channum</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ENOENT</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">C_RUNNING</span><span class="p">)</span>     <span class="cm">/* full interrupt processing available */</span>
        <span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">UP</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_ENABLED</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">EROFS</span><span class="p">;</span>               <span class="cm">/* how else to flag unwritable state ? */</span>

<span class="cp">#ifdef RLD_TRANS_DEBUGx</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">||</span> <span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
<span class="cp">#else</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
<span class="cp">#endif</span>
    <span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;++ start_xmt[%d]: state %x start %x full %d free %d required %d stopped %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span><span class="p">,</span>
                <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_required</span><span class="p">,</span> <span class="n">sd_queue_stopped</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="cm">/***********************************************/</span>
    <span class="cm">/** Determine total amount of data to be sent **/</span>
    <span class="cm">/***********************************************/</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">mem_token</span><span class="p">;</span>
    <span class="n">txd_need_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">OS_mem_token_tlen</span> <span class="p">(</span><span class="n">m2</span><span class="p">);</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">OS_mem_token_next</span> <span class="p">(</span><span class="n">m2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OS_mem_token_len</span> <span class="p">(</span><span class="n">m2</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="n">txd_need_cnt</span><span class="o">++</span><span class="p">;</span>
        <span class="n">len</span> <span class="o">-=</span> <span class="n">OS_mem_token_len</span> <span class="p">(</span><span class="n">m2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">txd_need_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s channel %d: no TX data in User buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">channum</span><span class="p">);</span>
        <span class="n">OS_mem_token_free</span> <span class="p">(</span><span class="n">mem_token</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                   <span class="cm">/* no data to send */</span>
    <span class="p">}</span>
    <span class="cm">/*************************************************/</span>
    <span class="cm">/** Are there sufficient descriptors available? **/</span>
    <span class="cm">/*************************************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">txd_need_cnt</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span><span class="p">)</span> <span class="cm">/* never enough descriptors for this</span>
<span class="cm">                                     * large a buffer */</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_DEBUG</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;start_xmit: discarding buffer, insufficient descriptor cnt %d, need %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span><span class="p">,</span> <span class="n">txd_need_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
        <span class="n">OS_mem_token_free</span> <span class="p">(</span><span class="n">mem_token</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    spin_lock_irqsave (&amp;ch-&gt;ch_txlock, flags);</span>
<span class="cp">#endif</span>
    <span class="cm">/************************************************************/</span>
    <span class="cm">/** flow control the line if not enough descriptors remain **/</span>
    <span class="cm">/************************************************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">txd_need_cnt</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cxt1e1_log_level</span> <span class="o">&gt;=</span> <span class="n">LOG_MONITOR2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;start_xmit[%d]: EBUSY - need more descriptors, have %d of %d need %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">channum</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_num</span><span class="p">,</span> <span class="n">txd_need_cnt</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_required</span> <span class="o">=</span> <span class="n">txd_need_cnt</span><span class="p">;</span>
        <span class="n">sd_disable_xmit</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        spin_unlock_irqrestore (&amp;ch-&gt;ch_txlock, flags);</span>
<span class="cp">#endif</span>
        <span class="k">return</span> <span class="n">EBUSY</span><span class="p">;</span>               <span class="cm">/* tell user to try again later */</span>
    <span class="p">}</span>
    <span class="cm">/**************************************************/</span>
    <span class="cm">/** Put the user data into MUSYCC data buffer(s) **/</span>
    <span class="cm">/**************************************************/</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">mem_token</span><span class="p">;</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="p">;</span>           <span class="cm">/* get current available descriptor */</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">OS_mem_token_tlen</span> <span class="p">(</span><span class="n">m2</span><span class="p">);</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">OS_mem_token_next</span> <span class="p">(</span><span class="n">m2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">int</span>         <span class="n">u</span> <span class="o">=</span> <span class="n">OS_mem_token_len</span> <span class="p">(</span><span class="n">m2</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="n">len</span> <span class="o">-=</span> <span class="n">u</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * Enable following chunks, yet wait to enable the FIRST chunk until</span>
<span class="cm">         * after ALL subsequent chunks are setup.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">md</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="p">)</span>  <span class="cm">/* not first chunk */</span>
            <span class="n">u</span> <span class="o">|=</span> <span class="n">MUSYCC_TX_OWNED</span><span class="p">;</span>   <span class="cm">/* transfer ownership from HOST to MUSYCC */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>                    <span class="cm">/* not last chunk */</span>
            <span class="n">u</span> <span class="o">|=</span> <span class="n">EOBIRQ_ENABLE</span><span class="p">;</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">chan_mode</span> <span class="o">==</span> <span class="n">CFG_CH_PROTO_TRANS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * Per MUSYCC Ref 6.4.9 for Transparent Mode, the host must</span>
<span class="cm">             * always clear EOMIRQ_ENABLE in every Transmit Buffer Descriptor</span>
<span class="cm">             * (IE. don&#39;t set herein).</span>
<span class="cm">             */</span>
            <span class="n">u</span> <span class="o">|=</span> <span class="n">EOBIRQ_ENABLE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">u</span> <span class="o">|=</span> <span class="n">EOMIRQ_ENABLE</span><span class="p">;</span>     <span class="cm">/* EOM, last HDLC chunk */</span>


        <span class="cm">/* last chunk in hdlc mode */</span>
        <span class="n">u</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">idlecode</span> <span class="o">&lt;&lt;</span> <span class="n">IDLE_CODE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pad_fill_count</span><span class="p">)</span>
        <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">            /* NOOP NOTE: u_int8_t cannot be &gt; 0xFF */</span>
<span class="c">            /* sanitize pad_fill_count for maximums allowed by hardware */</span>
<span class="c">            if (ch-&gt;p.pad_fill_count &gt; EXTRA_FLAGS_MASK)</span>
<span class="c">                ch-&gt;p.pad_fill_count = EXTRA_FLAGS_MASK;</span>
<span class="cp">#endif</span>
            <span class="n">u</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PADFILL_ENABLE</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pad_fill_count</span> <span class="o">&lt;&lt;</span> <span class="n">EXTRA_FLAGS</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">md</span><span class="o">-&gt;</span><span class="n">mem_token</span> <span class="o">=</span> <span class="n">len</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mem_token</span><span class="p">;</span>    <span class="cm">/* Fill in mds on last</span>
<span class="cm">                                                 * segment, others set ZERO</span>
<span class="cm">                                                 * so that entire token is</span>
<span class="cm">                                                 * removed ONLY when ALL</span>
<span class="cm">                                                 * segments have been</span>
<span class="cm">                                                 * transmitted. */</span>

        <span class="n">md</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">OS_vtophys</span> <span class="p">(</span><span class="n">OS_mem_token_data</span> <span class="p">(</span><span class="n">m2</span><span class="p">)));</span>
        <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
        <span class="n">md</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">u</span><span class="p">);</span>
        <span class="o">--</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_free</span><span class="p">;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">snext</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>


    <span class="cm">/*</span>
<span class="cm">     * Now transfer ownership of first chunk from HOST to MUSYCC in order to</span>
<span class="cm">     * fire-off this XMIT.</span>
<span class="cm">     */</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span> <span class="p">(</span><span class="n">MUSYCC_TX_OWNED</span><span class="p">);</span>
    <span class="n">FLUSH_MEM_WRITE</span> <span class="p">();</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">txd_usr_add</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>

    <span class="n">len</span> <span class="o">=</span> <span class="n">OS_mem_token_tlen</span> <span class="p">(</span><span class="n">mem_token</span><span class="p">);</span>
    <span class="n">atomic_add</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">);</span>
    <span class="n">atomic_add</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">);</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * If an ONR was seen, then channel requires poking to restart</span>
<span class="cm">     * transmission.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_start_tx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">musycc_chan_restart</span> <span class="p">(</span><span class="n">ch</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifdef SBE_WAN256T3_ENABLE</span>
    <span class="n">wan256t3_led</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">LED_TX</span><span class="p">,</span> <span class="n">LEDV_G</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*** End-of-File ***/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
