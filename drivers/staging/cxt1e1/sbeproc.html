<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › cxt1e1 › sbeproc.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sbeproc.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _INC_SBEPROC_H_</span>
<span class="cp">#define _INC_SBEPROC_H_</span>

<span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm"> * sbeproc.h -</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-2005  SBE, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * For further information, contact via email: support@sbei.com</span>
<span class="cm"> * SBE, Inc.  San Ramon, California  U.S.A.</span>
<span class="cm"> *-----------------------------------------------------------------------------</span>
<span class="cm"> */</span>


<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cp">#ifdef __KERNEL__</span>
<span class="kt">void</span>        <span class="n">sbecom_proc_brd_cleanup</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">__init</span>  <span class="n">sbecom_proc_brd_init</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#endif                          </span><span class="cm">/*** __KERNEL__ ***/</span><span class="cp"></span>
<span class="cp">#endif                          </span><span class="cm">/*** CONFIG_PROC_FS ***/</span><span class="cp"></span>
<span class="cp">#endif                          </span><span class="cm">/*** _INC_SBEPROC_H_ ***/</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="kt">char</span> <span class="n">dir</span><span class="p">[</span><span class="mi">7</span> <span class="o">+</span> <span class="n">SBE_IFACETMPL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="s">&quot;driver/%s&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
        <span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
        <span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">ci</span><span class="o">-&gt;</span><span class="n">dir_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sbecom_proc_get_sbe_info</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
                          <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ci_t</span>       <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
    <span class="kt">int</span>         <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span>       <span class="o">*</span><span class="n">spd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sbe_brd_info</span> <span class="o">*</span><span class="n">bip</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bip</span> <span class="o">=</span> <span class="n">OS_kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sbe_brd_info</span><span class="p">))))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    /** RLD DEBUG **/</span>
<span class="c">    pr_info(&quot;&gt;&gt; sbecom_proc_get_sbe_info: entered, offset %d. length %d.\n&quot;,</span>
<span class="c">            (int) offset, (int) length);</span>
<span class="cp">#endif</span>

    <span class="p">{</span>
        <span class="n">hdw_info_t</span> <span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw_info</span><span class="p">[</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">brdno</span><span class="p">];</span>

        <span class="n">u_int8_t</span> <span class="o">*</span><span class="n">bsn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">promfmt</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="n">PROM_FORMAT_TYPE1</span>:
            <span class="n">bsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">hi</span><span class="o">-&gt;</span><span class="n">mfg_info</span><span class="p">.</span><span class="n">pft1</span><span class="p">.</span><span class="n">Serial</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">PROM_FORMAT_TYPE2</span>:
            <span class="n">bsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">hi</span><span class="o">-&gt;</span><span class="n">mfg_info</span><span class="p">.</span><span class="n">pft2</span><span class="p">.</span><span class="n">Serial</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sbecom_get_brdinfo</span> <span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">bip</span><span class="p">,</span> <span class="n">bsn</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    /** RLD DEBUG **/</span>
<span class="c">    pr_info(&quot;&gt;&gt; sbecom_get_brdinfo: returned, first_if %p &lt;%s&gt; last_if %p &lt;%s&gt;\n&quot;,</span>
<span class="c">            (char *) &amp;bip-&gt;first_iname, (char *) &amp;bip-&gt;first_iname,</span>
<span class="c">            (char *) &amp;bip-&gt;last_iname, (char *) &amp;bip-&gt;last_iname);</span>
<span class="cp">#endif</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Board Type:    &quot;</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">brd_id</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C1T3</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPMC-C1T3&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPTMC_256T3_E1</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPTMC-256T3 &lt;E1&gt;&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPTMC_256T3_T1</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPTMC-256T3 &lt;T1&gt;&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPTMC_C24TE1</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPTMC-C24TE1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C4T1E1</span><span class="p">)</span>:
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C4T1E1_L</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPMC-C4T1E1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C2T1E1</span><span class="p">)</span>:
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C2T1E1_L</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPMC-C2T1E1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C1T1E1</span><span class="p">)</span>:
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPMC_C1T1E1_L</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPMC-C1T1E1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPCI_C4T1E1</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPCI-C4T1E1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPCI_C2T1E1</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPCI-C2T1E1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SBE_BOARD_ID</span> <span class="p">(</span><span class="n">PCI_VENDOR_ID_SBE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WANPCI_C1T1E1</span><span class="p">)</span>:
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;wanPCI-C1T1E1&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;  [%08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bip</span><span class="o">-&gt;</span><span class="n">brd_id</span><span class="p">);</span>

    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Board Number:  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bip</span><span class="o">-&gt;</span><span class="n">brdno</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Hardware ID:   0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hdw_bid</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Board SN:      %06X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bip</span><span class="o">-&gt;</span><span class="n">brd_sn</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Board MAC:     %pMF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bip</span><span class="o">-&gt;</span><span class="n">brd_mac_addr</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Ports:         %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">max_port</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Channels:      %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bip</span><span class="o">-&gt;</span><span class="n">brd_chan_cnt</span><span class="p">);</span>
<span class="cp">#if 1</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Interface:     %s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">first_iname</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">last_iname</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Interface:     &lt;not available&gt; 1st %p lst %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">first_iname</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">last_iname</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">brd_pci_speed</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">BINFO_PCI_SPEED_33</span>:
        <span class="n">spd</span> <span class="o">=</span> <span class="s">&quot;33Mhz&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BINFO_PCI_SPEED_66</span>:
        <span class="n">spd</span> <span class="o">=</span> <span class="s">&quot;66Mhz&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="s">&quot;&lt;not available&gt;&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;PCI Bus Speed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spd</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Release:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">);</span>

<span class="cp">#ifdef SBE_PMCC4_ENABLE</span>
    <span class="p">{</span>
               <span class="k">extern</span> <span class="kt">int</span> <span class="n">cxt1e1_max_mru</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        extern int max_chans_used;</span>
<span class="c">        extern int cxt1e1_max_mtu;</span>
<span class="cp">#endif</span>
        <span class="k">extern</span> <span class="kt">int</span> <span class="n">max_rxdesc_used</span><span class="p">,</span> <span class="n">max_txdesc_used</span><span class="p">;</span>

        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">cxt1e1_max_mru:         %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cxt1e1_max_mru</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        len += sprintf (buffer + len, &quot;\nmax_chans_used:  %d\n&quot;, max_chans_used);</span>
<span class="c">        len += sprintf (buffer + len, &quot;cxt1e1_max_mtu:         %d\n&quot;, cxt1e1_max_mtu);</span>
<span class="cp">#endif</span>
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;max_rxdesc_used: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_rxdesc_used</span><span class="p">);</span>
        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;max_txdesc_used: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_txdesc_used</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="n">OS_kfree</span> <span class="p">(</span><span class="n">bip</span><span class="p">);</span>                 <span class="cm">/* cleanup */</span>

    <span class="cm">/***</span>
<span class="cm">     * How to be a proc read function</span>
<span class="cm">     * ------------------------------</span>
<span class="cm">     * Prototype:</span>
<span class="cm">     *    int f(char *buffer, char **start, off_t offset,</span>
<span class="cm">     *          int count, int *peof, void *dat)</span>
<span class="cm">     *</span>
<span class="cm">     * Assume that the buffer is &quot;count&quot; bytes in size.</span>
<span class="cm">     *</span>
<span class="cm">     * If you know you have supplied all the data you</span>
<span class="cm">     * have, set *peof.</span>
<span class="cm">     *</span>
<span class="cm">     * You have three ways to return data:</span>
<span class="cm">     * 0) Leave *start = NULL.  (This is the default.)</span>
<span class="cm">     *    Put the data of the requested offset at that</span>
<span class="cm">     *    offset within the buffer.  Return the number (n)</span>
<span class="cm">     *    of bytes there are from the beginning of the</span>
<span class="cm">     *    buffer up to the last byte of data.  If the</span>
<span class="cm">     *    number of supplied bytes (= n - offset) is</span>
<span class="cm">     *    greater than zero and you didn&#39;t signal eof</span>
<span class="cm">     *    and the reader is prepared to take more data</span>
<span class="cm">     *    you will be called again with the requested</span>
<span class="cm">     *    offset advanced by the number of bytes</span>
<span class="cm">     *    absorbed.  This interface is useful for files</span>
<span class="cm">     *    no larger than the buffer.</span>
<span class="cm">     * 1) Set *start = an unsigned long value less than</span>
<span class="cm">     *    the buffer address but greater than zero.</span>
<span class="cm">     *    Put the data of the requested offset at the</span>
<span class="cm">     *    beginning of the buffer.  Return the number of</span>
<span class="cm">     *    bytes of data placed there.  If this number is</span>
<span class="cm">     *    greater than zero and you didn&#39;t signal eof</span>
<span class="cm">     *    and the reader is prepared to take more data</span>
<span class="cm">     *    you will be called again with the requested</span>
<span class="cm">     *    offset advanced by *start.  This interface is</span>
<span class="cm">     *    useful when you have a large file consisting</span>
<span class="cm">     *    of a series of blocks which you want to count</span>
<span class="cm">     *    and return as wholes.</span>
<span class="cm">     *    (Hack by Paul.Russell@rustcorp.com.au)</span>
<span class="cm">     * 2) Set *start = an address within the buffer.</span>
<span class="cm">     *    Put the data of the requested offset at *start.</span>
<span class="cm">     *    Return the number of bytes of data placed there.</span>
<span class="cm">     *    If this number is greater than zero and you</span>
<span class="cm">     *    didn&#39;t signal eof and the reader is prepared to</span>
<span class="cm">     *    take more data you will be called again with the</span>
<span class="cm">     *    requested offset advanced by the number of bytes</span>
<span class="cm">     *    absorbed.</span>
<span class="cm">     */</span>

<span class="cp">#if 1</span>
    <span class="cm">/* #4 - interpretation of above = set EOF, return len */</span>
    <span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    /*</span>
<span class="c">     * #1 - from net/wireless/atmel.c RLD NOTE -there&#39;s something wrong with</span>
<span class="c">     * this plagarized code which results in this routine being called TWICE.</span>
<span class="c">     * The second call returns ZERO, resulting in hidden failure, but at</span>
<span class="c">     * least only a single message set is being displayed.</span>
<span class="c">     */</span>
<span class="c">    if (len &lt;= offset + length)</span>
<span class="c">        *eof = 1;</span>
<span class="c">    *start = buffer + offset;</span>
<span class="c">    len -= offset;</span>
<span class="c">    if (len &gt; length)</span>
<span class="c">        len = length;</span>
<span class="c">    if (len &lt; 0)</span>
<span class="c">        len = 0;</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c">                               /* #2 from net/tokenring/olympic.c +</span>
<span class="c">                                     * lanstreamer.c */</span>
<span class="c">    {</span>
<span class="c">        off_t       begin = 0;</span>
<span class="c">        int         size = 0;</span>
<span class="c">        off_t       pos = 0;</span>

<span class="c">        size = len;</span>
<span class="c">        pos = begin + size;</span>
<span class="c">        if (pos &lt; offset)</span>
<span class="c">        {</span>
<span class="c">            len = 0;</span>
<span class="c">            begin = pos;</span>
<span class="c">        }</span>
<span class="c">        *start = buffer + (offset - begin);     /* Start of wanted data */</span>
<span class="c">        len -= (offset - begin);    /* Start slop */</span>
<span class="c">        if (len &gt; length)</span>
<span class="c">            len = length;           /* Ending slop */</span>
<span class="c">    }</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c">                               /* #3 from</span>
<span class="c">                                     * char/ftape/lowlevel/ftape-proc.c */</span>
<span class="c">    len = strlen (buffer);</span>
<span class="c">    *start = NULL;</span>
<span class="c">    if (offset + length &gt;= len)</span>
<span class="c">        *eof = 1;</span>
<span class="c">    else</span>
<span class="c">        *eof = 0;</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    pr_info(&quot;&gt;&gt; proc_fs: returned len = %d., start %p\n&quot;, len, start);  /* RLD DEBUG */</span>
<span class="cp">#endif</span>

<span class="cm">/***</span>
<span class="cm">   using NONE: returns = 314.314.314.</span>
<span class="cm">   using #1  : returns = 314, 0.</span>
<span class="cm">   using #2  : returns = 314, 0, 0.</span>
<span class="cm">   using #3  : returns = 314, 314.</span>
<span class="cm">   using #4  : returns = 314, 314.</span>
<span class="cm">***/</span>

    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize the /proc subsystem for the specific SBE driver */</span>

<span class="kt">int</span>         <span class="n">__init</span>
<span class="nf">sbecom_proc_brd_init</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">dir</span><span class="p">[</span><span class="mi">7</span> <span class="o">+</span> <span class="n">SBE_IFACETMPL_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

    <span class="cm">/* create a directory in the root procfs */</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="s">&quot;driver/%s&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
    <span class="n">ci</span><span class="o">-&gt;</span><span class="n">dir_dev</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to create directory /proc/driver/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span> <span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
                                <span class="n">ci</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">sbecom_proc_get_sbe_info</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to create entry /proc/driver/%s/info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
    <span class="n">sbecom_proc_brd_cleanup</span> <span class="p">(</span><span class="n">ci</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else                           </span><span class="cm">/*** ! CONFIG_PROC_FS ***/</span><span class="cp"></span>

<span class="cm">/* stubbed off dummy routines */</span>

<span class="kt">void</span>
<span class="nf">sbecom_proc_brd_cleanup</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span>         <span class="n">__init</span>
<span class="nf">sbecom_proc_brd_init</span> <span class="p">(</span><span class="n">ci_t</span> <span class="o">*</span> <span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif                          </span><span class="cm">/*** CONFIG_PROC_FS ***/</span><span class="cp"></span>


<span class="cm">/*** End-of-File ***/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
