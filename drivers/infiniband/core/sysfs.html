<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › core › sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Mellanox Technologies Ltd.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;core_priv.h&quot;</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &lt;rdma/ib_mad.h&gt;</span>

<span class="k">struct</span> <span class="n">ib_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kobject</span>         <span class="n">kobj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device</span>      <span class="o">*</span><span class="n">ibdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">gid_group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">pkey_group</span><span class="p">;</span>
	<span class="n">u8</span>                     <span class="n">port_num</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">port_attribute</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define PORT_ATTR(_name, _mode, _show, _store) \</span>
<span class="cp">struct port_attribute port_attr_##_name = __ATTR(_name, _mode, _show, _store)</span>

<span class="cp">#define PORT_ATTR_RO(_name) \</span>
<span class="cp">struct port_attribute port_attr_##_name = __ATTR_RO(_name)</span>

<span class="k">struct</span> <span class="n">port_table_attribute</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_attribute</span>	<span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">index</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">port_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">port_attr</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_port</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">port_attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">port_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">port_attr_show</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">IB_PORT_NOP</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;NOP&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IB_PORT_DOWN</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;DOWN&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IB_PORT_INIT</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;INIT&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IB_PORT_ARMED</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;ARMED&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IB_PORT_ACTIVE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ACTIVE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IB_PORT_ACTIVE_DEFER</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ACTIVE_DEFER&quot;</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
		       <span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span> <span class="o">?</span>
		       <span class="n">state_name</span><span class="p">[</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lid_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">lid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lid_mask_count_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">lmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sm_lid_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">sm_lid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sm_sl_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">sm_sl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cap_mask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">port_cap_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rate_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>		<span class="cm">/* in deci-Gb/sec */</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">active_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_SPEED_DDR</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot; DDR&quot;</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_SPEED_QDR</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot; QDR&quot;</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_SPEED_FDR10</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot; FDR10&quot;</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_SPEED_FDR</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot; FDR&quot;</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_SPEED_EDR</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot; EDR&quot;</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_SPEED_SDR</span>:
	<span class="nl">default:</span>		<span class="cm">/* default to SDR for invalid rates */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">*=</span> <span class="n">ib_width_enum_to_int</span><span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">active_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d%s Gb/sec (%dX%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">?</span> <span class="s">&quot;.5&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">ib_width_enum_to_int</span><span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">active_width</span><span class="p">),</span> <span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">phys_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>

	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">phys_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1: Sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;2: Polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;3: Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;4: PortConfigurationTraining</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;5: LinkUp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">6</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;6: LinkErrorRecovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">7</span>:  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;7: Phy Test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: &lt;unknown&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">phys_state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">link_layer_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdma_port_get_link_layer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_LINK_LAYER_INFINIBAND</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;InfiniBand&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IB_LINK_LAYER_ETHERNET</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Ethernet&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">lid</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">lid_mask_count</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">sm_lid</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">sm_sl</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">cap_mask</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">phys_state</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_ATTR_RO</span><span class="p">(</span><span class="n">link_layer</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">port_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">port_attr_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_lid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_lid_mask_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_sm_lid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_sm_sl</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_cap_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_rate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_phys_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_attr_link_layer</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_port_gid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_table_attribute</span> <span class="o">*</span><span class="n">tab_attr</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_table_attribute</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">ib_gid</span> <span class="n">gid</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_gid</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="n">tab_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gid</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_port_pkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_table_attribute</span> <span class="o">*</span><span class="n">tab_attr</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_table_attribute</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pkey</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_pkey</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="n">tab_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkey</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkey</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PORT_PMA_ATTR(_name, _counter, _width, _offset)			\</span>
<span class="cp">struct port_table_attribute port_pma_attr_##_name = {			\</span>
<span class="cp">	.attr  = __ATTR(_name, S_IRUGO, show_pma_counter, NULL),	\</span>
<span class="cp">	.index = (_offset) | ((_width) &lt;&lt; 16) | ((_counter) &lt;&lt; 24)	\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pma_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_table_attribute</span> <span class="o">*</span><span class="n">tab_attr</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_table_attribute</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">tab_attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span>  <span class="o">=</span> <span class="p">(</span><span class="n">tab_attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad</span> <span class="o">*</span><span class="n">in_mad</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad</span> <span class="o">*</span><span class="n">out_mad</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="o">-&gt;</span><span class="n">process_mad</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;N/A (no PMA)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">in_mad</span>  <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">in_mad</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">out_mad</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">out_mad</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_mad</span> <span class="o">||</span> <span class="o">!</span><span class="n">out_mad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">in_mad</span><span class="o">-&gt;</span><span class="n">mad_hdr</span><span class="p">.</span><span class="n">base_version</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">in_mad</span><span class="o">-&gt;</span><span class="n">mad_hdr</span><span class="p">.</span><span class="n">mgmt_class</span>    <span class="o">=</span> <span class="n">IB_MGMT_CLASS_PERF_MGMT</span><span class="p">;</span>
	<span class="n">in_mad</span><span class="o">-&gt;</span><span class="n">mad_hdr</span><span class="p">.</span><span class="n">class_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">in_mad</span><span class="o">-&gt;</span><span class="n">mad_hdr</span><span class="p">.</span><span class="n">method</span>        <span class="o">=</span> <span class="n">IB_MGMT_METHOD_GET</span><span class="p">;</span>
	<span class="n">in_mad</span><span class="o">-&gt;</span><span class="n">mad_hdr</span><span class="p">.</span><span class="n">attr_id</span>       <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0x12</span><span class="p">);</span> <span class="cm">/* PortCounters */</span>

	<span class="n">in_mad</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">;</span>	<span class="cm">/* PortSelect field */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="o">-&gt;</span><span class="n">process_mad</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">IB_MAD_IGNORE_MKEY</span><span class="p">,</span>
		 <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">in_mad</span><span class="p">,</span> <span class="n">out_mad</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">IB_MAD_RESULT_SUCCESS</span> <span class="o">|</span> <span class="n">IB_MAD_RESULT_REPLY</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">IB_MAD_RESULT_SUCCESS</span> <span class="o">|</span> <span class="n">IB_MAD_RESULT_REPLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">out_mad</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">40</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span>
					    <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out_mad</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">40</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">be16_to_cpup</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">out_mad</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">be32_to_cpup</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">out_mad</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">in_mad</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">out_mad</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">symbol_error</span>		    <span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">link_error_recovery</span>	    <span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">48</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">link_downed</span>		    <span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">56</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_rcv_errors</span>		    <span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">64</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_rcv_remote_physical_errors</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">80</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_rcv_switch_relay_errors</span>   <span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">96</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_xmit_discards</span>		    <span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">112</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_xmit_constraint_errors</span>    <span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_rcv_constraint_errors</span>	    <span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">136</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">local_link_integrity_errors</span>    <span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">152</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">excessive_buffer_overrun_errors</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">156</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">VL15_dropped</span>		    <span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">176</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_xmit_data</span>		    <span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">192</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_rcv_data</span>		    <span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">224</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_xmit_packets</span>		    <span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
<span class="k">static</span> <span class="n">PORT_PMA_ATTR</span><span class="p">(</span><span class="n">port_rcv_packets</span>		    <span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">288</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">pma_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_symbol_error</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_link_error_recovery</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_link_downed</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_rcv_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_rcv_remote_physical_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_rcv_switch_relay_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_xmit_discards</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_xmit_constraint_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_rcv_constraint_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_local_link_integrity_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_excessive_buffer_overrun_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_VL15_dropped</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_xmit_data</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_rcv_data</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_xmit_packets</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">port_pma_attr_port_rcv_packets</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">pma_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;counters&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span>  <span class="o">=</span> <span class="n">pma_attrs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ib_port_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_port</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">port_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>       <span class="o">=</span> <span class="n">ib_port_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">port_default_attrs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ib_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ib_device_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;NAME=%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It would be nice to pass the node GUID with the event...</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">**</span>
<span class="nf">alloc_group_attrs</span><span class="p">(</span><span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">port_attribute</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">),</span>
		  <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">**</span><span class="n">tab_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_table_attribute</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tab_attr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tab_attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_table_attribute</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">element</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snprintf</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			     <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">element</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">element</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span>  <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="n">element</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">show</span>       <span class="o">=</span> <span class="n">show</span><span class="p">;</span>
		<span class="n">element</span><span class="o">-&gt;</span><span class="n">index</span>		 <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

		<span class="n">tab_attr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tab_attr</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tab_attr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tab_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_num</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">port_callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="p">,</span>
					 <span class="n">u8</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_port</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ibdev</span>      <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">port_num</span>   <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_type</span><span class="p">,</span>
				   <span class="n">kobject_get</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ports_parent</span><span class="p">),</span>
				   <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">port_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pma_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;gids&quot;</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">alloc_group_attrs</span><span class="p">(</span><span class="n">show_port_gid</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">gid_tbl_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_remove_pma</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_gid</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;pkeys&quot;</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">alloc_group_attrs</span><span class="p">(</span><span class="n">show_port_pkey</span><span class="p">,</span>
						<span class="n">attr</span><span class="p">.</span><span class="n">pkey_tbl_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_remove_gid</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_pkey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">port_callback</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">port_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_pkey</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_remove_pkey:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">);</span>

<span class="nl">err_free_pkey:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attr</span><span class="p">.</span><span class="n">pkey_tbl_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">);</span>

<span class="nl">err_remove_gid:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">);</span>

<span class="nl">err_free_gid:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attr</span><span class="p">.</span><span class="n">gid_tbl_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">.</span><span class="n">attrs</span><span class="p">);</span>

<span class="nl">err_remove_pma:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pma_group</span><span class="p">);</span>

<span class="nl">err_put:</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ports_parent</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_node_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RDMA_NODE_IB_CA</span>:	  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: CA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RDMA_NODE_RNIC</span>:	  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: RNIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RDMA_NODE_IB_SWITCH</span>: <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RDMA_NODE_IB_ROUTER</span>: <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: router</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">);</span>
	<span class="nl">default:</span>		  <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d: &lt;unknown&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_sys_image_guid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">dev_attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_query_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%04x:%04x:%04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">.</span><span class="n">sys_image_guid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">.</span><span class="n">sys_image_guid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">.</span><span class="n">sys_image_guid</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">.</span><span class="n">sys_image_guid</span><span class="p">)[</span><span class="mi">3</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_node_guid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%04x:%04x:%04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_guid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_guid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_guid</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
		       <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_guid</span><span class="p">)[</span><span class="mi">3</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_node_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%.64s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_node_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ib_device_modify</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">modify_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">node_desc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">64</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_modify_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IB_DEVICE_MODIFY_NODE_DESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_node_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">sys_image_guid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_sys_image_guid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">node_guid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_node_guid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">node_desc</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_node_desc</span><span class="p">,</span> <span class="n">set_node_desc</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">ib_class_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_node_type</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_sys_image_guid</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_node_guid</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_node_desc</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">ib_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;infiniband&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_release</span> <span class="o">=</span> <span class="n">ib_device_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_uevent</span> <span class="o">=</span> <span class="n">ib_device_uevent</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Show a given an attribute in the statistics group */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_protocol_stat</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">rdma_protocol_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_protocol_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">)[</span><span class="n">offset</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* generate a read-only iwarp statistics attribute */</span>
<span class="cp">#define IW_STATS_ENTRY(name)						\</span>
<span class="cp">static ssize_t show_##name(struct device *device,			\</span>
<span class="cp">			   struct device_attribute *attr, char *buf)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return show_protocol_stat(device, attr, buf,			\</span>
<span class="cp">				  offsetof(struct iw_protocol_stats, name) / \</span>
<span class="cp">				  sizeof (u64));			\</span>
<span class="cp">}									\</span>
<span class="cp">static DEVICE_ATTR(name, S_IRUGO, show_##name, NULL)</span>

<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInReceives</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInHdrErrors</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInTooBigErrors</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInNoRoutes</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInAddrErrors</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInUnknownProtos</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInTruncatedPkts</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInDiscards</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInDelivers</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipOutForwDatagrams</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipOutRequests</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipOutDiscards</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipOutNoRoutes</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipReasmTimeout</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipReasmReqds</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipReasmOKs</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipReasmFails</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipFragOKs</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipFragFails</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipFragCreates</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInMcastPkts</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipOutMcastPkts</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipInBcastPkts</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">ipOutBcastPkts</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpRtoAlgorithm</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpRtoMin</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpRtoMax</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpMaxConn</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpActiveOpens</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpPassiveOpens</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpAttemptFails</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpEstabResets</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpCurrEstab</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpInSegs</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpOutSegs</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpRetransSegs</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpInErrs</span><span class="p">);</span>
<span class="n">IW_STATS_ENTRY</span><span class="p">(</span><span class="n">tcpOutRsts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">iw_proto_stats_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInReceives</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInHdrErrors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInTooBigErrors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInNoRoutes</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInAddrErrors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInUnknownProtos</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInTruncatedPkts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInDiscards</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInDelivers</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipOutForwDatagrams</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipOutRequests</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipOutDiscards</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipOutNoRoutes</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipReasmTimeout</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipReasmReqds</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipReasmOKs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipReasmFails</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipFragOKs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipFragFails</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipFragCreates</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInMcastPkts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipOutMcastPkts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipInBcastPkts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ipOutBcastPkts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpRtoAlgorithm</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpRtoMin</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpRtoMax</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpMaxConn</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpActiveOpens</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpPassiveOpens</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpAttemptFails</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpEstabResets</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpCurrEstab</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpInSegs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpOutSegs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpRetransSegs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpInErrs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tcpOutRsts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">iw_stats_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;proto_stats&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span>	<span class="o">=</span> <span class="n">iw_proto_stats_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">ib_device_register_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">port_callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="p">,</span>
						  <span class="n">u8</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">class_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">class_dev</span><span class="o">-&gt;</span><span class="n">class</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib_class</span><span class="p">;</span>
	<span class="n">class_dev</span><span class="o">-&gt;</span><span class="n">parent</span>     <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="n">class_dev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">class_dev</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">class_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ib_class_attributes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">class_dev</span><span class="p">,</span> <span class="n">ib_class_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">ports_parent</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">&quot;ports&quot;</span><span class="p">,</span>
					<span class="n">kobject_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">class_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ports_parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">RDMA_NODE_IB_SWITCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">add_port</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port_callback</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">phys_port_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">add_port</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">port_callback</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">RDMA_NODE_RNIC</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">get_protocol_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">class_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iw_stats_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_put:</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_port</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
			<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pma_group</span><span class="p">);</span>
			<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">);</span>
			<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">);</span>
			<span class="n">kobject_put</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">class_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>

<span class="nl">err_unregister:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="n">class_dev</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ib_device_unregister_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/* Hold kobject until ib_dealloc_device() */</span>
	<span class="n">kobject_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_port</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pma_group</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">pkey_group</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">gid_group</span><span class="p">);</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kobject_put</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ports_parent</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ib_sysfs_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_class</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ib_sysfs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_class</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
