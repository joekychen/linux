<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › core › uverbs.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>uverbs.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005 Topspin Communications.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005, 2006 Cisco Systems.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Voltaire, Inc. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 PathScale, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef UVERBS_H</span>
<span class="cp">#define UVERBS_H</span>

<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/cdev.h&gt;</span>

<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_umem.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_user_verbs.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Our lifetime rules for these structs are the following:</span>
<span class="cm"> *</span>
<span class="cm"> * struct ib_uverbs_device: One reference is held by the module and</span>
<span class="cm"> * released in ib_uverbs_remove_one().  Another reference is taken by</span>
<span class="cm"> * ib_uverbs_open() each time the character special file is opened,</span>
<span class="cm"> * and released in ib_uverbs_release_file() when the file is released.</span>
<span class="cm"> *</span>
<span class="cm"> * struct ib_uverbs_file: One reference is held by the VFS and</span>
<span class="cm"> * released when the file is closed.  Another reference is taken when</span>
<span class="cm"> * an asynchronous event queue file is created and released when the</span>
<span class="cm"> * event file is closed.</span>
<span class="cm"> *</span>
<span class="cm"> * struct ib_uverbs_event_file: One reference is held by the VFS and</span>
<span class="cm"> * released when the file is closed.  For asynchronous event files,</span>
<span class="cm"> * another reference is held by the corresponding main context file</span>
<span class="cm"> * and released when that file is closed.  For completion event files,</span>
<span class="cm"> * a reference is taken when a CQ is created that uses the file, and</span>
<span class="cm"> * released when the CQ is destroyed.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ib_uverbs_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span>				<span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">num_comp_vectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>			<span class="n">comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>			       <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device</span>		       <span class="o">*</span><span class="n">ib_dev</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">devnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdev</span>			        <span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span>				<span class="n">xrcd_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>				<span class="n">xrcd_tree_mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uverbs_event_file</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span>				<span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">is_async</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_uverbs_file</span>		       <span class="o">*</span><span class="n">uverbs_file</span><span class="p">;</span>
	<span class="n">spinlock_t</span>				<span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">is_closed</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>			<span class="n">poll_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fasync_struct</span>		       <span class="o">*</span><span class="n">async_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="n">event_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uverbs_file</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span>				<span class="n">ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>				<span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_uverbs_device</span>		       <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_ucontext</span>		       <span class="o">*</span><span class="n">ucontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_event_handler</span>			<span class="n">event_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_uverbs_event_file</span>	       <span class="o">*</span><span class="n">async_file</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uverbs_event</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ib_uverbs_async_event_desc</span>	<span class="n">async</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ib_uverbs_comp_event_desc</span>	<span class="n">comp</span><span class="p">;</span>
	<span class="p">}</span>					<span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="n">obj_list</span><span class="p">;</span>
	<span class="n">u32</span>				       <span class="o">*</span><span class="n">counter</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uverbs_mcast_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ib_gid</span> 		<span class="n">gid</span><span class="p">;</span>
	<span class="n">u16</span> 			<span class="n">lid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uevent_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_uobject</span>	<span class="n">uobject</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">event_list</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">events_reported</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uxrcd_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_uobject</span>	<span class="n">uobject</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">refcnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_usrq_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_uevent_object</span>	<span class="n">uevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_uxrcd_object</span> <span class="o">*</span><span class="n">uxrcd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_uqp_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_uevent_object</span>	<span class="n">uevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> 	<span class="n">mcast_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_ucq_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_uobject</span>	<span class="n">uobject</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_uverbs_file</span>  <span class="o">*</span><span class="n">uverbs_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">comp_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">async_list</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">comp_events_reported</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">async_events_reported</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="n">spinlock_t</span> <span class="n">ib_uverbs_idr_lock</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_pd_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_mr_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_mw_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_ah_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_cq_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_qp_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_srq_idr</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">ib_uverbs_xrcd_idr</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">idr_remove_uobj</span><span class="p">(</span><span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_uobject</span> <span class="o">*</span><span class="n">uobj</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">ib_uverbs_alloc_event_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_uverbs_file</span> <span class="o">*</span><span class="n">uverbs_file</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">is_async</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_uverbs_event_file</span> <span class="o">*</span><span class="n">ib_uverbs_lookup_comp_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">ib_uverbs_release_ucq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_uverbs_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_uverbs_event_file</span> <span class="o">*</span><span class="n">ev_file</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_ucq_object</span> <span class="o">*</span><span class="n">uobj</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ib_uverbs_release_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_uverbs_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ib_uevent_object</span> <span class="o">*</span><span class="n">uobj</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">ib_uverbs_comp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cq_context</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ib_uverbs_cq_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context_ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ib_uverbs_qp_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context_ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ib_uverbs_srq_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context_ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ib_uverbs_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ib_uverbs_dealloc_xrcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_uverbs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_xrcd</span> <span class="o">*</span><span class="n">xrcd</span><span class="p">);</span>

<span class="cp">#define IB_UVERBS_DECLARE_CMD(name)					\</span>
<span class="cp">	ssize_t ib_uverbs_##name(struct ib_uverbs_file *file,		\</span>
<span class="cp">				 const char __user *buf, int in_len,	\</span>
<span class="cp">				 int out_len)</span>

<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">get_context</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">query_device</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">query_port</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">alloc_pd</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">dealloc_pd</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">reg_mr</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">dereg_mr</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">create_comp_channel</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">create_cq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">resize_cq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">poll_cq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">req_notify_cq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">destroy_cq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">create_qp</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">open_qp</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">query_qp</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">modify_qp</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">destroy_qp</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">post_send</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">post_recv</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">post_srq_recv</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">create_ah</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">destroy_ah</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">attach_mcast</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">detach_mcast</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">create_srq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">modify_srq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">query_srq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">destroy_srq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">create_xsrq</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">open_xrcd</span><span class="p">);</span>
<span class="n">IB_UVERBS_DECLARE_CMD</span><span class="p">(</span><span class="n">close_xrcd</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* UVERBS_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
