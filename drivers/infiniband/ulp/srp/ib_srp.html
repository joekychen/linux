<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › ulp › srp › ib_srp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ib_srp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005 Cisco Systems.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) PFX fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &lt;scsi/srp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_srp.h&gt;</span>

<span class="cp">#include &quot;ib_srp.h&quot;</span>

<span class="cp">#define DRV_NAME	&quot;ib_srp&quot;</span>
<span class="cp">#define PFX		DRV_NAME &quot;: &quot;</span>
<span class="cp">#define DRV_VERSION	&quot;0.2&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;November 1, 2005&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Roland Dreier&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;InfiniBand SCSI RDMA Protocol initiator &quot;</span>
		   <span class="s">&quot;v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srp_sg_tablesize</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_sg_entries</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">indirect_sg_entries</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">allow_ext_sg</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">topspin_workarounds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">srp_sg_tablesize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">srp_sg_tablesize</span><span class="p">,</span> <span class="s">&quot;Deprecated name for cmd_sg_entries&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">cmd_sg_entries</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cmd_sg_entries</span><span class="p">,</span>
		 <span class="s">&quot;Default number of gather/scatter entries in the SRP command (default is 12, max 255)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">indirect_sg_entries</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">indirect_sg_entries</span><span class="p">,</span>
		 <span class="s">&quot;Default max number of gather/scatter entries (default is 12, max is &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">SCSI_MAX_SG_CHAIN_SEGMENTS</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">allow_ext_sg</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">allow_ext_sg</span><span class="p">,</span>
		  <span class="s">&quot;Default behavior when there are more than cmd_sg_entries S/G entries after mapping; fails the request when false (default false)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">topspin_workarounds</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">topspin_workarounds</span><span class="p">,</span>
		 <span class="s">&quot;Enable workarounds for Topspin/Cisco SRP target bugs if != 0&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">srp_add_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">srp_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">srp_recv_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">target_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">srp_send_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">target_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">srp_cm_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">ib_srp_transport_template</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ib_client</span> <span class="n">srp_client</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;srp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span>    <span class="o">=</span> <span class="n">srp_add_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">srp_remove_one</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ib_sa_client</span> <span class="n">srp_sa_client</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="nf">host_to_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">srp_target_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">host</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_target_is_topspin</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">topspin_oui</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xad</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cisco_oui</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x0d</span> <span class="p">};</span>

	<span class="k">return</span> <span class="n">topspin_workarounds</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">,</span> <span class="n">topspin_oui</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">topspin_oui</span><span class="p">)</span> <span class="o">||</span>
		 <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">,</span> <span class="n">cisco_oui</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">cisco_oui</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="nf">srp_alloc_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				   <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>

	<span class="n">iu</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">iu</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_iu</span><span class="p">;</span>

	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				    <span class="n">direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_buf</span><span class="p">;</span>

	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">size</span>      <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iu</span><span class="p">;</span>

<span class="nl">out_free_buf:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="nl">out_free_iu:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iu</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_free_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">iu</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_qp_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;QP event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_init_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">attr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_find_pkey</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			   <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">pkey</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pkey_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_state</span>        <span class="o">=</span> <span class="n">IB_QPS_INIT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_access_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">IB_ACCESS_REMOTE_READ</span> <span class="o">|</span>
				    <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_num</span>        <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span>
			   <span class="n">IB_QP_STATE</span>		<span class="o">|</span>
			   <span class="n">IB_QP_PKEY_INDEX</span>	<span class="o">|</span>
			   <span class="n">IB_QP_ACCESS_FLAGS</span>	<span class="o">|</span>
			   <span class="n">IB_QP_PORT</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_new_cm_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_cm_id</span> <span class="o">*</span><span class="n">new_cm_id</span><span class="p">;</span>

	<span class="n">new_cm_id</span> <span class="o">=</span> <span class="n">ib_create_cm_id</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">srp_cm_handler</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new_cm_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">new_cm_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span>
		<span class="n">ib_destroy_cm_id</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">new_cm_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_create_target_ib</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">init_attr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span> <span class="o">=</span> <span class="n">ib_create_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">srp_recv_completion</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">SRP_RQ_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">ib_create_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">srp_send_completion</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">SRP_SQ_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_recv_cq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>

	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">event_handler</span>       <span class="o">=</span> <span class="n">srp_qp_event</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span>     <span class="o">=</span> <span class="n">SRP_SQ_SIZE</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span>     <span class="o">=</span> <span class="n">SRP_RQ_SIZE</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">sq_sig_type</span>         <span class="o">=</span> <span class="n">IB_SIGNAL_ALL_WR</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">qp_type</span>             <span class="o">=</span> <span class="n">IB_QPT_RC</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">send_cq</span>             <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">recv_cq</span>             <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="n">ib_create_qp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="n">init_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_send_cq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_init_qp</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_qp</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">init_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_qp:</span>
	<span class="n">ib_destroy_qp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>

<span class="nl">err_send_cq:</span>
	<span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>

<span class="nl">err_recv_cq:</span>
	<span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">init_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_free_target_ib</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ib_destroy_qp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>
	<span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
	<span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_RQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">srp_free_iu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">srp_free_iu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_path_rec_completion</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ib_sa_path_rec</span> <span class="o">*</span><span class="n">pathrec</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">target_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">target_ptr</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Got failed path rec status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="o">*</span><span class="n">pathrec</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_lookup_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">numb_path</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">path_query_id</span> <span class="o">=</span> <span class="n">ib_sa_path_rec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_sa_client</span><span class="p">,</span>
						   <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span>
						   <span class="n">IB_SA_PATH_REC_SERVICE_ID</span>	<span class="o">|</span>
						   <span class="n">IB_SA_PATH_REC_DGID</span>		<span class="o">|</span>
						   <span class="n">IB_SA_PATH_REC_SGID</span>		<span class="o">|</span>
						   <span class="n">IB_SA_PATH_REC_NUMB_PATH</span>	<span class="o">|</span>
						   <span class="n">IB_SA_PATH_REC_PKEY</span><span class="p">,</span>
						   <span class="n">SRP_PATH_REC_TIMEOUT_MS</span><span class="p">,</span>
						   <span class="n">GFP_KERNEL</span><span class="p">,</span>
						   <span class="n">srp_path_rec_completion</span><span class="p">,</span>
						   <span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path_query</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path_query_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">path_query_id</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Path record query failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_send_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ib_cm_req_param</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">srp_login_req</span>   <span class="n">priv</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">primary_path</span> 	      <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">alternate_path</span> 	      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">service_id</span> 		      <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">service_id</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">qp_num</span> 		      <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">qp_type</span> 		      <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">private_data</span> 	      <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">private_data_len</span> 	      <span class="o">=</span> <span class="k">sizeof</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">flow_control</span> 	      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">starting_psn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">starting_psn</span> 	     <span class="o">&amp;=</span> <span class="mh">0xffffff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pick some arbitrary defaults here; we could make these</span>
<span class="cm">	 * module parameters if anyone cared about setting them.</span>
<span class="cm">	 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">responder_resources</span>	      <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">remote_cm_response_timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">local_cm_response_timeout</span>  <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">retry_count</span> 		      <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">rnr_retry_count</span> 	      <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">max_cm_retries</span> 	      <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">opcode</span>     	<span class="o">=</span> <span class="n">SRP_LOGIN_REQ</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">tag</span>        	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">req_it_iu_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">max_iu_len</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">req_buf_fmt</span> 	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">SRP_BUF_FORMAT_DIRECT</span> <span class="o">|</span>
					      <span class="n">SRP_BUF_FORMAT_INDIRECT</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * In the published SRP specification (draft rev. 16a), the</span>
<span class="cm">	 * port identifier format is 8 bytes of ID extension followed</span>
<span class="cm">	 * by 8 bytes of GUID.  Older drafts put the two halves in the</span>
<span class="cm">	 * opposite order, so that the GUID comes first.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Targets conforming to these obsolete drafts can be</span>
<span class="cm">	 * recognized by the I/O Class they report.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">io_class</span> <span class="o">==</span> <span class="n">SRP_REV10_IB_IO_CLASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">initiator_port_id</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">sgid</span><span class="p">.</span><span class="n">global</span><span class="p">.</span><span class="n">interface_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">initiator_port_id</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">initiator_ext</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">target_port_id</span><span class="p">,</span>     <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">target_port_id</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">initiator_port_id</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">initiator_ext</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">initiator_port_id</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">sgid</span><span class="p">.</span><span class="n">global</span><span class="p">.</span><span class="n">interface_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">target_port_id</span><span class="p">,</span>     <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">target_port_id</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Topspin/Cisco SRP targets will reject our login unless we</span>
<span class="cm">	 * zero out the first 8 bytes of our initiator port ID and set</span>
<span class="cm">	 * the second 8 bytes to the local node GUID.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srp_target_is_topspin</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Topspin/Cisco initiator port ID workaround &quot;</span>
			     <span class="s">&quot;activated for target GUID %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">initiator_port_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">initiator_port_id</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node_guid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ib_send_cm_req</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_disconnect_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX should send SRP_I_LOGOUT request */</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_send_cm_dreq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Sending CM DREQ failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">srp_change_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">srp_target_state</span> <span class="n">old</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">srp_target_state</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_free_req_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">req_ring</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">fmr_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">map_page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_dma_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_dma_addr</span><span class="p">,</span>
					    <span class="n">target</span><span class="o">-&gt;</span><span class="n">indirect_size</span><span class="p">,</span>
					    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * srp_del_scsi_host_attr() - Remove attributes defined in the host template.</span>
<span class="cm"> * @shost: SCSI host whose attributes to remove from sysfs.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Any attributes defined in the host template and that did not exist</span>
<span class="cm"> * before invocation of this function will be ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_del_scsi_host_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">**</span><span class="n">attr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">attr</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">shost_attrs</span><span class="p">;</span> <span class="n">attr</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span> <span class="o">++</span><span class="n">attr</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_remove_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_target_port</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srp_change_state</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_TARGET_DEAD</span><span class="p">,</span> <span class="n">SRP_TARGET_REMOVED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>

	<span class="n">srp_del_scsi_host_attr</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">srp_remove_host</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">ib_destroy_cm_id</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">srp_free_target_ib</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="n">srp_free_req_data</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_connect_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_lookup_path</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_send_req</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The CM event handling code will set status to</span>
<span class="cm">		 * SRP_PORT_REDIRECT if we get a port redirect REJ</span>
<span class="cm">		 * back, or SRP_DLID_REDIRECT if we get a lid/qp</span>
<span class="cm">		 * redirect REJ back.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_PORT_REDIRECT</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_lookup_path</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_DLID_REDIRECT</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_STALE_CONN</span>:
			<span class="cm">/* Our current CM id was stale, and is now in timewait.</span>
<span class="cm">			 * Try to reconnect with a new one.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retries</span><span class="o">--</span> <span class="o">||</span> <span class="n">srp_new_cm_id</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
					     <span class="s">&quot;giving up on stale connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
				     <span class="s">&quot;retrying stale connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_unmap_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_pool_fmr</span> <span class="o">**</span><span class="n">pfmr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scmnd</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">&amp;&amp;</span>
	     <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pfmr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">fmr_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">nfmr</span><span class="o">--</span><span class="p">)</span>
		<span class="n">ib_fmr_pool_unmap</span><span class="p">(</span><span class="o">*</span><span class="n">pfmr</span><span class="o">++</span><span class="p">);</span>

	<span class="n">ib_dma_unmap_sg</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scmnd</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scmnd</span><span class="p">),</span>
			<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_remove_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">s32</span> <span class="n">req_lim_delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">srp_unmap_data</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span> <span class="o">+=</span> <span class="n">req_lim_delta</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_reset_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="p">);</span>
	<span class="n">srp_remove_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_reconnect_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">qp_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srp_change_state</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_TARGET_LIVE</span><span class="p">,</span> <span class="n">SRP_TARGET_CONNECTING</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">srp_disconnect_target</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now get a new local CM ID so that we avoid confusing the</span>
<span class="cm">	 * target in case things are really fouled up.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_new_cm_id</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">qp_attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_RESET</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp_attr</span><span class="p">,</span> <span class="n">IB_QP_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_init_qp</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* nothing */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* nothing */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="p">)</span>
			<span class="n">srp_reset_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">qp_in_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_connect_target</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srp_change_state</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_TARGET_CONNECTING</span><span class="p">,</span> <span class="n">SRP_TARGET_LIVE</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
		     <span class="n">PFX</span> <span class="s">&quot;reconnect failed (%d), removing target port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We couldn&#39;t reconnect, so kill our target port off.</span>
<span class="cm">	 * However, we have to defer the real removal because we</span>
<span class="cm">	 * are in the context of the SCSI error handler now, which</span>
<span class="cm">	 * will deadlock if we call scsi_remove_host().</span>
<span class="cm">	 *</span>
<span class="cm">	 * Schedule our work inside the lock to avoid a race with</span>
<span class="cm">	 * the flush_scheduled_work() in srp_remove_one().</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SRP_TARGET_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRP_TARGET_DEAD</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">srp_remove_work</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_map_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_map_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_direct_buf</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_len</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">total_len</span> <span class="o">+=</span> <span class="n">dma_len</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">++</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ndesc</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_map_finish_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_map_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_pool_fmr</span> <span class="o">*</span><span class="n">fmr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">io_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srp_map_desc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">base_dma_addr</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fmr_len</span><span class="p">,</span>
			     <span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fmr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fmr</span> <span class="o">=</span> <span class="n">ib_fmr_pool_map_phys</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span>
				   <span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span><span class="p">,</span> <span class="n">io_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fmr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fmr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">next_fmr</span><span class="o">++</span> <span class="o">=</span> <span class="n">fmr</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">nfmr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">srp_map_desc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fmr_len</span><span class="p">,</span> <span class="n">fmr</span><span class="o">-&gt;</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fmr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_map_update_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_map_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sg_index</span><span class="p">,</span>
				 <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">unmapped_sg</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">unmapped_index</span> <span class="o">=</span> <span class="n">sg_index</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">unmapped_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_map_sg_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_map_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sg_index</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">use_fmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ib_sg_dma_address</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_len</span> <span class="o">=</span> <span class="n">ib_sg_dma_len</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_fmr</span> <span class="o">==</span> <span class="n">SRP_MAP_NO_FMR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Once we&#39;re in direct map mode for a request, we don&#39;t</span>
<span class="cm">		 * go back to FMR mode, so no need to update anything</span>
<span class="cm">		 * other than the descriptor.</span>
<span class="cm">		 */</span>
		<span class="n">srp_map_desc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we start at an offset into the FMR page, don&#39;t merge into</span>
<span class="cm">	 * the current FMR. Finish it out, and use the kernel&#39;s MR for this</span>
<span class="cm">	 * sg entry. This is to avoid potential bugs on some SRP targets</span>
<span class="cm">	 * that were never quite defined, but went away when the initiator</span>
<span class="cm">	 * avoided using FMR on such page fragments.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fmr_page_mask</span> <span class="o">||</span> <span class="n">dma_len</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fmr_max_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_map_finish_fmr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">srp_map_desc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
		<span class="n">srp_map_update_start</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If this is the first sg to go into the FMR, save our position.</span>
<span class="cm">	 * We need to know the first unmapped entry, its index, and the</span>
<span class="cm">	 * first unmapped address within that entry to be able to restart</span>
<span class="cm">	 * mapping after an error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">unmapped_sg</span><span class="p">)</span>
		<span class="n">srp_map_update_start</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_index</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dma_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">==</span> <span class="n">SRP_FMR_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_map_finish_fmr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">srp_map_update_start</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_index</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">base_dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">npages</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fmr_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">dma_addr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">dma_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the last entry of the FMR wasn&#39;t a full page, then we need to</span>
<span class="cm">	 * close it out and start a new one -- we can only merge at page</span>
<span class="cm">	 * boundries.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_map_finish_fmr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">srp_map_update_start</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_map_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scat</span><span class="p">,</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">nents</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">use_fmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_map_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_indirect_buf</span> <span class="o">*</span><span class="n">indirect_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">table_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scmnd</span><span class="p">)</span> <span class="o">||</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_FROM_DEVICE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Unhandled data direction %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nents</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scmnd</span><span class="p">);</span>
	<span class="n">scat</span>  <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scmnd</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="p">;</span>
	<span class="n">ibdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">ib_dma_map_sg</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">scat</span><span class="p">,</span> <span class="n">nents</span><span class="p">,</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">SRP_DATA_DESC_DIRECT</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_cmd</span><span class="p">)</span> <span class="o">+</span>	<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_direct_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The midlayer only generated a single gather/scatter</span>
<span class="cm">		 * entry, or DMA mapping coalesced everything to a</span>
<span class="cm">		 * single entry.  So a direct descriptor along with</span>
<span class="cm">		 * the DMA MR suffices.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">srp_direct_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">;</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">va</span>  <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ib_sg_dma_address</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">scat</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ib_sg_dma_len</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">scat</span><span class="p">));</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">nfmr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">map_complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have more than one scatter/gather entry, so build our indirect</span>
<span class="cm">	 * descriptor table, trying to merge as many entries with FMR as we</span>
<span class="cm">	 * can.</span>
<span class="cm">	 */</span>
	<span class="n">indirect_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_dma_addr</span><span class="p">,</span>
				   <span class="n">target</span><span class="o">-&gt;</span><span class="n">indirect_size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="n">state</span><span class="p">.</span><span class="n">desc</span>	<span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span><span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">pages</span>	<span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">map_page</span><span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">next_fmr</span>	<span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">fmr_list</span><span class="p">;</span>

	<span class="n">use_fmr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span> <span class="o">?</span> <span class="n">SRP_MAP_ALLOW_FMR</span> <span class="o">:</span> <span class="n">SRP_MAP_NO_FMR</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">scat</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srp_map_sg_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">use_fmr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* FMR mapping failed, so backtrack to the first</span>
<span class="cm">			 * unmapped entry and continue on without using FMR.</span>
<span class="cm">			 */</span>
			<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_len</span><span class="p">;</span>

<span class="nl">backtrack:</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">unmapped_sg</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">unmapped_index</span><span class="p">;</span>

			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ib_sg_dma_address</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">ib_sg_dma_len</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
			<span class="n">dma_len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">unmapped_addr</span> <span class="o">-</span> <span class="n">dma_addr</span><span class="p">);</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">unmapped_addr</span><span class="p">;</span>
			<span class="n">use_fmr</span> <span class="o">=</span> <span class="n">SRP_MAP_NO_FMR</span><span class="p">;</span>
			<span class="n">srp_map_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_fmr</span> <span class="o">==</span> <span class="n">SRP_MAP_ALLOW_FMR</span> <span class="o">&amp;&amp;</span> <span class="n">srp_map_finish_fmr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">backtrack</span><span class="p">;</span>

	<span class="cm">/* We&#39;ve mapped the request, now pull as much of the indirect</span>
<span class="cm">	 * descriptor table as we can into the command buffer. If this</span>
<span class="cm">	 * target is not using an external indirect table, we are</span>
<span class="cm">	 * guaranteed to fit into the command, as the SCSI layer won&#39;t</span>
<span class="cm">	 * give us more S/G entries than we allow.</span>
<span class="cm">	 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">nfmr</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">nfmr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">ndesc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FMR mapping was able to collapse this to one entry,</span>
<span class="cm">		 * so use a direct descriptor.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">srp_direct_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">;</span>

		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">goto</span> <span class="n">map_complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">.</span><span class="n">ndesc</span> <span class="o">&amp;&amp;</span>
						<span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">allow_ext_sg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="s">&quot;Could not fit S/G list into SRP_CMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">ndesc</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span><span class="p">);</span>
	<span class="n">table_len</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">ndesc</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_direct_buf</span><span class="p">);</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">SRP_DATA_DESC_INDIRECT</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_indirect_buf</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_direct_buf</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">indirect_hdr</span><span class="o">-&gt;</span><span class="n">desc_list</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span><span class="p">,</span>
	       <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_direct_buf</span><span class="p">));</span>

	<span class="n">indirect_hdr</span><span class="o">-&gt;</span><span class="n">table_desc</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_dma_addr</span><span class="p">);</span>
	<span class="n">indirect_hdr</span><span class="o">-&gt;</span><span class="n">table_desc</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">indirect_hdr</span><span class="o">-&gt;</span><span class="n">table_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">table_len</span><span class="p">);</span>
	<span class="n">indirect_hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">total_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_out_desc_cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_in_desc_cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_dma_addr</span><span class="p">,</span> <span class="n">table_len</span><span class="p">,</span>
				      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

<span class="nl">map_complete:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf_fmt</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return an IU and possible credit to the free pool</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_put_tx_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">srp_iu_type</span> <span class="n">iu_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iu_type</span> <span class="o">!=</span> <span class="n">SRP_IU_RSP</span><span class="p">)</span>
		<span class="o">++</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must be called with target-&gt;lock held to protect req_lim and free_tx.</span>
<span class="cm"> * If IU is not sent, it must be returned using srp_put_tx_iu().</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> * An upper limit for the number of allocated information units for each</span>
<span class="cm"> * request type is:</span>
<span class="cm"> * - SRP_IU_CMD: SRP_CMD_SQ_SIZE, since the SCSI mid-layer never queues</span>
<span class="cm"> *   more than Scsi_Host.can_queue requests.</span>
<span class="cm"> * - SRP_IU_TSK_MGMT: SRP_TSK_MGMT_SQ_SIZE.</span>
<span class="cm"> * - SRP_IU_RSP: 1, since a conforming SRP target never sends more than</span>
<span class="cm"> *   one unanswered SRP request to an initiator.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="nf">__srp_get_tx_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">srp_iu_type</span> <span class="n">iu_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rsv</span> <span class="o">=</span> <span class="p">(</span><span class="n">iu_type</span> <span class="o">==</span> <span class="n">SRP_IU_TSK_MGMT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SRP_TSK_MGMT_SQ_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>

	<span class="n">srp_send_completion</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Initiator responses to target requests do not consume credits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iu_type</span> <span class="o">!=</span> <span class="n">SRP_IU_RSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span> <span class="o">&lt;=</span> <span class="n">rsv</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">zero_req_lim</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">--</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iu</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_iu</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">wr</span><span class="p">,</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>

	<span class="n">list</span><span class="p">.</span><span class="n">addr</span>   <span class="o">=</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">list</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">list</span><span class="p">.</span><span class="n">lkey</span>   <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>

	<span class="n">wr</span><span class="p">.</span><span class="n">next</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">wr_id</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">iu</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">sg_list</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">num_sge</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">opcode</span>     <span class="o">=</span> <span class="n">IB_WR_SEND</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ib_post_send</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_post_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="n">wr</span><span class="p">,</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">list</span><span class="p">.</span><span class="n">addr</span>   <span class="o">=</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">list</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">list</span><span class="p">.</span><span class="n">lkey</span>   <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>

	<span class="n">wr</span><span class="p">.</span><span class="n">next</span>     <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">wr_id</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">iu</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">sg_list</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">num_sge</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ib_post_recv</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_process_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SRP_TAG_TSK_MGMT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span> <span class="o">+=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req_lim_delta</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resp_data_len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_done</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_ring</span><span class="p">[</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">];</span>
		<span class="n">scmnd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scmnd</span><span class="p">)</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
				     <span class="s">&quot;Null scmnd for RSP w/tag %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRP_RSP_FLAG_SNSVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resp_data_len</span><span class="p">),</span>
			       <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">sense_data_len</span><span class="p">),</span>
				     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRP_RSP_FLAG_DOOVER</span> <span class="o">|</span> <span class="n">SRP_RSP_FLAG_DOUNDER</span><span class="p">))</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scmnd</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data_out_res_cnt</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRP_RSP_FLAG_DIOVER</span> <span class="o">|</span> <span class="n">SRP_RSP_FLAG_DIUNDER</span><span class="p">))</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scmnd</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data_in_res_cnt</span><span class="p">));</span>

		<span class="n">srp_remove_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req_lim_delta</span><span class="p">));</span>
		<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmnd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_response_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">s32</span> <span class="n">req_delta</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span> <span class="o">+=</span> <span class="n">req_delta</span><span class="p">;</span>
	<span class="n">iu</span> <span class="o">=</span> <span class="n">__srp_get_tx_iu</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_IU_RSP</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
			     <span class="s">&quot;no IU available to send response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">srp_post_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
			     <span class="s">&quot;unable to post response: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">srp_put_tx_iu</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">SRP_IU_RSP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_process_cred_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">srp_cred_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_cred_rsp</span> <span class="n">rsp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">SRP_CRED_RSP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">s32</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_lim_delta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srp_response_common</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">rsp</span><span class="p">))</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
			     <span class="s">&quot;problems processing SRP_CRED_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_process_aer_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">srp_aer_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_aer_rsp</span> <span class="n">rsp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">SRP_AER_RSP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">s32</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_lim_delta</span><span class="p">);</span>

	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
		     <span class="s">&quot;ignoring AER for LUN %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srp_response_common</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">rsp</span><span class="p">))</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
			     <span class="s">&quot;problems processing SRP_AER_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_handle_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_ti_iu_len</span><span class="p">,</span>
				   <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">opcode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;recv completion, opcode 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SRP_RSP</span>:
		<span class="n">srp_process_rsp</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRP_CRED_REQ</span>:
		<span class="n">srp_process_cred_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRP_AER_REQ</span>:
		<span class="n">srp_process_aer_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRP_T_LOGOUT</span>:
		<span class="cm">/* XXX Handle target logout */</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Got target logout request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Unhandled SRP opcode 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_ti_iu_len</span><span class="p">,</span>
				      <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">srp_post_recv</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Recv failed with error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_recv_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">target_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">target_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="n">wc</span><span class="p">;</span>

	<span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
				     <span class="n">PFX</span> <span class="s">&quot;failed receive status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">qp_in_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">srp_handle_recv</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_send_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">target_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">target_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="n">wc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
				     <span class="n">PFX</span> <span class="s">&quot;failed send status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">qp_in_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">wc</span><span class="p">.</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SRP_TARGET_CONNECTING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SRP_TARGET_DEAD</span> <span class="o">||</span>
	    <span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SRP_TARGET_REMOVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmnd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iu</span> <span class="o">=</span> <span class="n">__srp_get_tx_iu</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_IU_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_request</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_iu_len</span><span class="p">,</span>
				   <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">result</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">SRP_CMD</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lun</span>    <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span>    <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span>    <span class="o">=</span> <span class="n">scmnd</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span>      <span class="o">=</span> <span class="n">iu</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">srp_map_data</span><span class="p">(</span><span class="n">scmnd</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Failed to map data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_iu_len</span><span class="p">,</span>
				      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srp_post_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span> <span class="s">&quot;Send failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap:</span>
	<span class="n">srp_unmap_data</span><span class="p">(</span><span class="n">scmnd</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

<span class="nl">err_iu:</span>
	<span class="n">srp_put_tx_iu</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">SRP_IU_CMD</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">);</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_alloc_iu_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_RQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">srp_alloc_iu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="p">,</span>
						  <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_ti_iu_len</span><span class="p">,</span>
						  <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">srp_alloc_iu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="p">,</span>
						  <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_iu_len</span><span class="p">,</span>
						  <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_RQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srp_free_iu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srp_free_iu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_cm_rep_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">srp_login_rsp</span> <span class="o">*</span><span class="n">lrsp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">qp_attr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attr_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lrsp</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">SRP_LOGIN_RSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">max_ti_iu_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">lrsp</span><span class="o">-&gt;</span><span class="n">max_ti_iu_len</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span>       <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">lrsp</span><span class="o">-&gt;</span><span class="n">req_lim_delta</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reserve credits for task management so we don&#39;t</span>
<span class="cm">		 * bounce requests back to the SCSI mid-layer.</span>
<span class="cm">		 */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">can_queue</span>
			<span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span> <span class="o">-</span> <span class="n">SRP_TSK_MGMT_SQ_SIZE</span><span class="p">,</span>
			      <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Unhandled RSP opcode %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lrsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_alloc_iu_bufs</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">qp_attr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">qp_attr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp_attr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">qp_attr</span><span class="o">-&gt;</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_RTR</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_cm_init_qp_attr</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">qp_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">qp_attr</span><span class="p">,</span> <span class="n">attr_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_RQ_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_post_recv</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qp_attr</span><span class="o">-&gt;</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_RTS</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_cm_init_qp_attr</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">qp_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">qp_attr</span><span class="p">,</span> <span class="n">attr_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_send_cm_rtu</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qp_attr</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_cm_rej_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ib_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_class_port_info</span> <span class="o">*</span><span class="n">cpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">rej_rcvd</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_CM_REJ_PORT_CM_REDIRECT</span>:
		<span class="n">cpi</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">rej_rcvd</span><span class="p">.</span><span class="n">ari</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dlid</span> <span class="o">=</span> <span class="n">cpi</span><span class="o">-&gt;</span><span class="n">redirect_lid</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">pkey</span> <span class="o">=</span> <span class="n">cpi</span><span class="o">-&gt;</span><span class="n">redirect_pkey</span><span class="p">;</span>
		<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_cm_qpn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cpi</span><span class="o">-&gt;</span><span class="n">redirect_qp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">cpi</span><span class="o">-&gt;</span><span class="n">redirect_gid</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dlid</span> <span class="o">?</span>
			<span class="n">SRP_DLID_REDIRECT</span> <span class="o">:</span> <span class="n">SRP_PORT_REDIRECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_REJ_PORT_REDIRECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">srp_target_is_topspin</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Topspin/Cisco SRP gateways incorrectly send</span>
<span class="cm">			 * reject reason code 25 when they mean 24</span>
<span class="cm">			 * (port redirect).</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span>
			       <span class="n">event</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">rej_rcvd</span><span class="p">.</span><span class="n">ari</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
				     <span class="n">PFX</span> <span class="s">&quot;Topspin/Cisco redirect to target port GID %016llx%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">global</span><span class="p">.</span><span class="n">subnet_prefix</span><span class="p">),</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">global</span><span class="p">.</span><span class="n">interface_id</span><span class="p">));</span>

			<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SRP_PORT_REDIRECT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;  REJ reason: IB_CM_REJ_PORT_REDIRECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_REJ_DUPLICATE_LOCAL_COMM_ID</span>:
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
			    <span class="s">&quot;  REJ reason: IB_CM_REJ_DUPLICATE_LOCAL_COMM_ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_REJ_CONSUMER_DEFINED</span>:
		<span class="n">opcode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">SRP_LOGIN_REJ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">srp_login_rej</span> <span class="o">*</span><span class="n">rej</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rej</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">SRP_LOGIN_REJ_REQ_IT_IU_LENGTH_TOO_LARGE</span><span class="p">)</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
					     <span class="n">PFX</span> <span class="s">&quot;SRP_LOGIN_REJ: requested max_it_iu_len too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
					    <span class="n">PFX</span> <span class="s">&quot;SRP LOGIN REJECTED, reason 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;  REJ reason: IB_CM_REJ_CONSUMER_DEFINED,&quot;</span>
				     <span class="s">&quot; opcode 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_REJ_STALE_CONN</span>:
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;  REJ reason: stale connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SRP_STALE_CONN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;  REJ reason 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">event</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">rej_rcvd</span><span class="p">.</span><span class="n">reason</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_cm_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">comp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_CM_REQ_ERROR</span>:
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Sending CM REQ failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_REP_RECEIVED</span>:
		<span class="n">comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">srp_cm_rep_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_REJ_RECEIVED</span>:
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span> <span class="s">&quot;REJ received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">srp_cm_rej_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_DREQ_RECEIVED</span>:
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;DREQ received - connection closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_send_cm_drep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
				     <span class="n">PFX</span> <span class="s">&quot;Sending CM DREP failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_TIMEWAIT_EXIT</span>:
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;connection closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_CM_MRA_RECEIVED</span>:
	<span class="k">case</span> <span class="n">IB_CM_DREQ_ERROR</span>:
	<span class="k">case</span> <span class="n">IB_CM_DREP_RECEIVED</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Unhandled CM event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_send_tsk_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="n">req_tag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_tsk_mgmt</span> <span class="o">*</span><span class="n">tsk_mgmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SRP_TARGET_DEAD</span> <span class="o">||</span>
	    <span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SRP_TARGET_REMOVED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_done</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">iu</span> <span class="o">=</span> <span class="n">__srp_get_tx_iu</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_IU_TSK_MGMT</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">tsk_mgmt</span><span class="p">,</span>
				   <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">tsk_mgmt</span> <span class="o">=</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tsk_mgmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">tsk_mgmt</span><span class="p">);</span>

	<span class="n">tsk_mgmt</span><span class="o">-&gt;</span><span class="n">opcode</span> 	<span class="o">=</span> <span class="n">SRP_TSK_MGMT</span><span class="p">;</span>
	<span class="n">tsk_mgmt</span><span class="o">-&gt;</span><span class="n">lun</span>		<span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">tsk_mgmt</span><span class="o">-&gt;</span><span class="n">tag</span>		<span class="o">=</span> <span class="n">req_tag</span> <span class="o">|</span> <span class="n">SRP_TAG_TSK_MGMT</span><span class="p">;</span>
	<span class="n">tsk_mgmt</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">tsk_mgmt</span><span class="o">-&gt;</span><span class="n">task_tag</span>	<span class="o">=</span> <span class="n">req_tag</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iu</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">tsk_mgmt</span><span class="p">,</span>
				      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srp_post_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">tsk_mgmt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">srp_put_tx_iu</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">SRP_IU_TSK_MGMT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_done</span><span class="p">,</span>
					 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SRP_ABORT_TIMEOUT_MS</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="s">&quot;SRP abort called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span> <span class="o">||</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">qp_in_error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srp_send_tsk_mgmt</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			      <span class="n">SRP_TSK_ABORT_TASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srp_remove_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_reset_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="s">&quot;SRP reset_device called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">qp_in_error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srp_send_tsk_mgmt</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">SRP_TAG_NO_REQ</span><span class="p">,</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			      <span class="n">SRP_TSK_LUN_RESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tsk_mgmt_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="n">srp_reset_req</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_reset_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span> <span class="s">&quot;SRP reset_host called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srp_reconnect_target</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_id_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ioc_guid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_service_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">service_id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">pkey</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_dgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_orig_dgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">orig_dgid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_req_lim</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">req_lim</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_zero_req_lim</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">zero_req_lim</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_local_ib_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_local_ib_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cmd_sg_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_allow_ext_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">allow_ext_sg</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">id_ext</span><span class="p">,</span>	    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_id_ext</span><span class="p">,</span>	   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ioc_guid</span><span class="p">,</span>	    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_ioc_guid</span><span class="p">,</span>	   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">service_id</span><span class="p">,</span>	    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_service_id</span><span class="p">,</span>	   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span>	    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_pkey</span><span class="p">,</span>		   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dgid</span><span class="p">,</span>	    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_dgid</span><span class="p">,</span>		   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">orig_dgid</span><span class="p">,</span>	    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_orig_dgid</span><span class="p">,</span>	   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">req_lim</span><span class="p">,</span>         <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_req_lim</span><span class="p">,</span>         <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">zero_req_lim</span><span class="p">,</span>    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_zero_req_lim</span><span class="p">,</span>	   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">local_ib_port</span><span class="p">,</span>   <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_local_ib_port</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">local_ib_device</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_local_ib_device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cmd_sg_entries</span><span class="p">,</span>  <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_cmd_sg_entries</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">allow_ext_sg</span><span class="p">,</span>    <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_allow_ext_sg</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">srp_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_id_ext</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ioc_guid</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_service_id</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pkey</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_dgid</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_orig_dgid</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_req_lim</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_zero_req_lim</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_local_ib_port</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_local_ib_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cmd_sg_entries</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_allow_ext_sg</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">srp_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;InfiniBand SRP initiator&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>				<span class="o">=</span> <span class="n">srp_target_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">srp_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">srp_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">srp_reset_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">srp_reset_host</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">SRP_DEF_SG_TABLESIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">srp_host_attrs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_add_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_rport_identifiers</span> <span class="n">ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">,</span> <span class="s">&quot;SRP.T10:%016llX&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">SRP_RPORT_ROLE_TARGET</span><span class="p">;</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">srp_rport_add</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRP_TARGET_LIVE</span><span class="p">;</span>

	<span class="n">scsi_scan_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span> <span class="n">SCAN_WILD_CARD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_host</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">released</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">srp_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;infiniband_srp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_release</span> <span class="o">=</span> <span class="n">srp_release_dev</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Target ports are added by writing</span>
<span class="cm"> *</span>
<span class="cm"> *     id_ext=&lt;SRP ID ext&gt;,ioc_guid=&lt;SRP IOC GUID&gt;,dgid=&lt;dest GID&gt;,</span>
<span class="cm"> *     pkey=&lt;P_Key&gt;,service_id=&lt;service ID&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * to the add_target sysfs attribute.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">SRP_OPT_ERR</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SRP_OPT_ID_EXT</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SRP_OPT_IOC_GUID</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">SRP_OPT_DGID</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">SRP_OPT_PKEY</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">SRP_OPT_SERVICE_ID</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">SRP_OPT_MAX_SECT</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">SRP_OPT_MAX_CMD_PER_LUN</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">SRP_OPT_IO_CLASS</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">SRP_OPT_INITIATOR_EXT</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">SRP_OPT_CMD_SG_ENTRIES</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">SRP_OPT_ALLOW_EXT_SG</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">SRP_OPT_SG_TABLESIZE</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">SRP_OPT_ALL</span>		<span class="o">=</span> <span class="p">(</span><span class="n">SRP_OPT_ID_EXT</span>	<span class="o">|</span>
				   <span class="n">SRP_OPT_IOC_GUID</span>	<span class="o">|</span>
				   <span class="n">SRP_OPT_DGID</span>		<span class="o">|</span>
				   <span class="n">SRP_OPT_PKEY</span>		<span class="o">|</span>
				   <span class="n">SRP_OPT_SERVICE_ID</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">srp_opt_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SRP_OPT_ID_EXT</span><span class="p">,</span>		<span class="s">&quot;id_ext=%s&quot;</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_IOC_GUID</span><span class="p">,</span>		<span class="s">&quot;ioc_guid=%s&quot;</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_DGID</span><span class="p">,</span>			<span class="s">&quot;dgid=%s&quot;</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_PKEY</span><span class="p">,</span>			<span class="s">&quot;pkey=%x&quot;</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_SERVICE_ID</span><span class="p">,</span>		<span class="s">&quot;service_id=%s&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_MAX_SECT</span><span class="p">,</span>		<span class="s">&quot;max_sect=%d&quot;</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_MAX_CMD_PER_LUN</span><span class="p">,</span>	<span class="s">&quot;max_cmd_per_lun=%d&quot;</span> 	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_IO_CLASS</span><span class="p">,</span>		<span class="s">&quot;io_class=%x&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_INITIATOR_EXT</span><span class="p">,</span>	<span class="s">&quot;initiator_ext=%s&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_CMD_SG_ENTRIES</span><span class="p">,</span>	<span class="s">&quot;cmd_sg_entries=%u&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_ALLOW_EXT_SG</span><span class="p">,</span>		<span class="s">&quot;allow_ext_sg=%u&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_SG_TABLESIZE</span><span class="p">,</span>		<span class="s">&quot;sg_tablesize=%u&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SRP_OPT_ERR</span><span class="p">,</span>			<span class="nb">NULL</span> 			<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srp_parse_options</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">sep_opt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dgid</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">opt_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sep_opt</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sep_opt</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">srp_opt_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="n">opt_mask</span> <span class="o">|=</span> <span class="n">token</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SRP_OPT_ID_EXT</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">simple_strtoull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_IOC_GUID</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">simple_strtoull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_DGID</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad dest GID parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">dgid</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">dgid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">orig_dgid</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_PKEY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_hex</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad P_Key parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">pkey</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_SERVICE_ID</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">simple_strtoull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">service_id</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_MAX_SECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad max sect parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_MAX_CMD_PER_LUN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad max cmd_per_lun parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_IO_CLASS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_hex</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad IO class parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="n">SRP_REV10_IB_IO_CLASS</span> <span class="o">&amp;&amp;</span>
			    <span class="n">token</span> <span class="o">!=</span> <span class="n">SRP_REV16A_IB_IO_CLASS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;unknown IO class parameter value %x specified (use %x or %x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">token</span><span class="p">,</span> <span class="n">SRP_REV10_IB_IO_CLASS</span><span class="p">,</span>
					<span class="n">SRP_REV16A_IB_IO_CLASS</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">io_class</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_INITIATOR_EXT</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">initiator_ext</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">simple_strtoull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_CMD_SG_ENTRIES</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">||</span> <span class="n">token</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">token</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad max cmd_sg_entries parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_ALLOW_EXT_SG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad allow_ext_sg parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">allow_ext_sg</span> <span class="o">=</span> <span class="o">!!</span><span class="n">token</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SRP_OPT_SG_TABLESIZE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">||</span> <span class="n">token</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
					<span class="n">token</span> <span class="o">&gt;</span> <span class="n">SCSI_MAX_SG_CHAIN_SEGMENTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad max sg_tablesize parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;unknown parameter or missing value &#39;%s&#39; in target creation request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">opt_mask</span> <span class="o">&amp;</span> <span class="n">SRP_OPT_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="n">SRP_OPT_ALL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">srp_opt_tokens</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">srp_opt_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span> <span class="o">&amp;</span> <span class="n">SRP_OPT_ALL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">srp_opt_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span> <span class="o">&amp;</span> <span class="n">opt_mask</span><span class="p">))</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;target creation request is missing parameter &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">srp_opt_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">srp_create_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_host</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">target_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">target_host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_template</span><span class="p">,</span>
				      <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_target_port</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">target_host</span><span class="o">-&gt;</span><span class="n">transportt</span>  <span class="o">=</span> <span class="n">ib_srp_transport_template</span><span class="p">;</span>
	<span class="n">target_host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">target_host</span><span class="o">-&gt;</span><span class="n">max_id</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">target_host</span><span class="o">-&gt;</span><span class="n">max_lun</span>     <span class="o">=</span> <span class="n">SRP_MAX_LUN</span><span class="p">;</span>
	<span class="n">target_host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">((</span><span class="k">struct</span> <span class="n">srp_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0L</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">host_to_target</span><span class="p">(</span><span class="n">target_host</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">io_class</span>	<span class="o">=</span> <span class="n">SRP_REV16A_IB_IO_CLASS</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span>	<span class="o">=</span> <span class="n">target_host</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">srp_host</span>	<span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">lkey</span>		<span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">rkey</span>		<span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span>	<span class="o">=</span> <span class="n">cmd_sg_entries</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span>	<span class="o">=</span> <span class="n">indirect_sg_entries</span> <span class="o">?</span> <span class="o">:</span> <span class="n">cmd_sg_entries</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">allow_ext_sg</span>	<span class="o">=</span> <span class="n">allow_ext_sg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_parse_options</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">allow_ext_sg</span> <span class="o">&amp;&amp;</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No FMR pool and no external indirect descriptors, limiting sg_tablesize to cmd_sg_cnt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target_host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">indirect_size</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">*</span>
				<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_direct_buf</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">max_iu_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_cmd</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_indirect_buf</span><span class="p">)</span> <span class="o">+</span>
			     <span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srp_direct_buf</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_tx</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SRP_CMD_SQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srp_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">req_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">fmr_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cmd_sg_cnt</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">map_page</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SRP_FMR_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">indirect_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">fmr_list</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">map_page</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>

		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_desc</span><span class="p">,</span>
					     <span class="n">target</span><span class="o">-&gt;</span><span class="n">indirect_size</span><span class="p">,</span>
					     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">indirect_dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ib_query_gid</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">sgid</span><span class="p">);</span>

	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">PFX</span>
		     <span class="s">&quot;new target: id_ext %016llx ioc_guid %016llx pkey %04x &quot;</span>
		     <span class="s">&quot;service_id %016llx dgid %pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id_ext</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ioc_guid</span><span class="p">),</span>
	       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">pkey</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">service_id</span><span class="p">),</span>
	       <span class="n">target</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_create_target_ib</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_new_cm_id</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_ib</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">qp_in_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_connect_target</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
			     <span class="n">PFX</span> <span class="s">&quot;Connection failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cm_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">srp_add_target</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_disconnect</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">err_disconnect:</span>
	<span class="n">srp_disconnect_target</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

<span class="nl">err_cm_id:</span>
	<span class="n">ib_destroy_cm_id</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>

<span class="nl">err_free_ib:</span>
	<span class="n">srp_free_target_ib</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

<span class="nl">err_free_mem:</span>
	<span class="n">srp_free_req_data</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">target_host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">add_target</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">srp_create_target</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ibdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_host</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_ibdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srp_host</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="nf">srp_add_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">srp_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">released</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">srp_dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">srp_class</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;srp-%s-%d&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_host</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_add_target</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_class</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_ibdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_class</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_port</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_class</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">host</span><span class="p">;</span>

<span class="nl">err_class:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">free_host:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_add_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_device</span> <span class="o">*</span><span class="n">srp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="o">*</span><span class="n">dev_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_fmr_pool_param</span> <span class="n">fmr_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_pages_per_fmr</span><span class="p">,</span> <span class="n">fmr_page_shift</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">dev_attr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">dev_attr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_attr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_query_device</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dev_attr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Query device failed for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_attr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">srp_dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">srp_dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srp_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_attr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the smallest page size supported by the HCA, down to a</span>
<span class="cm">	 * minimum of 4096 bytes. We&#39;re unlikely to build large sglists</span>
<span class="cm">	 * out of smaller entries.</span>
<span class="cm">	 */</span>
	<span class="n">fmr_page_shift</span>		<span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">ffs</span><span class="p">(</span><span class="n">dev_attr</span><span class="o">-&gt;</span><span class="n">page_size_cap</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fmr_page_shift</span><span class="p">;</span>
	<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_page_mask</span>	<span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_max_size</span>	<span class="o">=</span> <span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">*</span> <span class="n">SRP_FMR_SIZE</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>

	<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span>  <span class="o">=</span> <span class="n">ib_alloc_pd</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_dev</span><span class="p">;</span>

	<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">ib_get_dma_mr</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span>
				    <span class="n">IB_ACCESS_LOCAL_WRITE</span> <span class="o">|</span>
				    <span class="n">IB_ACCESS_REMOTE_READ</span> <span class="o">|</span>
				    <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_pd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">max_pages_per_fmr</span> <span class="o">=</span> <span class="n">SRP_FMR_SIZE</span><span class="p">;</span>
			<span class="n">max_pages_per_fmr</span> <span class="o">&gt;=</span> <span class="n">SRP_FMR_MIN_SIZE</span><span class="p">;</span>
			<span class="n">max_pages_per_fmr</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_max_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmr_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">fmr_param</span><span class="p">);</span>
		<span class="n">fmr_param</span><span class="p">.</span><span class="n">pool_size</span>	    <span class="o">=</span> <span class="n">SRP_FMR_POOL_SIZE</span><span class="p">;</span>
		<span class="n">fmr_param</span><span class="p">.</span><span class="n">dirty_watermark</span>   <span class="o">=</span> <span class="n">SRP_FMR_DIRTY_SIZE</span><span class="p">;</span>
		<span class="n">fmr_param</span><span class="p">.</span><span class="n">cache</span>		    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fmr_param</span><span class="p">.</span><span class="n">max_pages_per_fmr</span> <span class="o">=</span> <span class="n">max_pages_per_fmr</span><span class="p">;</span>
		<span class="n">fmr_param</span><span class="p">.</span><span class="n">page_shift</span>	    <span class="o">=</span> <span class="n">fmr_page_shift</span><span class="p">;</span>
		<span class="n">fmr_param</span><span class="p">.</span><span class="n">access</span>	    <span class="o">=</span> <span class="p">(</span><span class="n">IB_ACCESS_LOCAL_WRITE</span> <span class="o">|</span>
					       <span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">|</span>
					       <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">);</span>

		<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span> <span class="o">=</span> <span class="n">ib_create_fmr_pool</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmr_param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span><span class="p">))</span>
		<span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">RDMA_NODE_IB_SWITCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">phys_port_cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span> <span class="o">=</span> <span class="n">srp_add_port</span><span class="p">(</span><span class="n">srp_dev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ib_set_client_data</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srp_client</span><span class="p">,</span> <span class="n">srp_dev</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">free_attr</span><span class="p">;</span>

<span class="nl">err_pd:</span>
	<span class="n">ib_dealloc_pd</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>

<span class="nl">free_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">srp_dev</span><span class="p">);</span>

<span class="nl">free_attr:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">srp_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srp_device</span> <span class="o">*</span><span class="n">srp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srp_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_host</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">target_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">srp_target_port</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_target</span><span class="p">;</span>

	<span class="n">srp_dev</span> <span class="o">=</span> <span class="n">ib_get_client_data</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srp_client</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">tmp_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait for the sysfs entry to go away, so that no new</span>
<span class="cm">		 * target ports can be created.</span>
<span class="cm">		 */</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">released</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Mark all target ports as removed, so we stop queueing</span>
<span class="cm">		 * commands and don&#39;t try to reconnect.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRP_TARGET_REMOVED</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_lock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for any reconnection tasks that may have</span>
<span class="cm">		 * started before we marked our target ports as</span>
<span class="cm">		 * removed, and any target port removal tasks.</span>
<span class="cm">		 */</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">);</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tmp_target</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">target_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srp_del_scsi_host_attr</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
			<span class="n">srp_remove_host</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
			<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
			<span class="n">srp_disconnect_target</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
			<span class="n">ib_destroy_cm_id</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
			<span class="n">srp_free_target_ib</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
			<span class="n">srp_free_req_data</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
			<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span><span class="p">)</span>
		<span class="n">ib_destroy_fmr_pool</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">fmr_pool</span><span class="p">);</span>
	<span class="n">ib_dereg_mr</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">);</span>
	<span class="n">ib_dealloc_pd</span><span class="p">(</span><span class="n">srp_dev</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">srp_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">srp_function_template</span> <span class="n">ib_srp_transport_functions</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">srp_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">FIELD_SIZEOF</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_wc</span><span class="p">,</span> <span class="n">wr_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srp_sg_tablesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;srp_sg_tablesize is deprecated, please use cmd_sg_entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_sg_entries</span><span class="p">)</span>
			<span class="n">cmd_sg_entries</span> <span class="o">=</span> <span class="n">srp_sg_tablesize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_sg_entries</span><span class="p">)</span>
		<span class="n">cmd_sg_entries</span> <span class="o">=</span> <span class="n">SRP_DEF_SG_TABLESIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sg_entries</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Clamping cmd_sg_entries to 255</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd_sg_entries</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">indirect_sg_entries</span><span class="p">)</span>
		<span class="n">indirect_sg_entries</span> <span class="o">=</span> <span class="n">cmd_sg_entries</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">indirect_sg_entries</span> <span class="o">&lt;</span> <span class="n">cmd_sg_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Bumping up indirect_sg_entries to match cmd_sg_entries (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd_sg_entries</span><span class="p">);</span>
		<span class="n">indirect_sg_entries</span> <span class="o">=</span> <span class="n">cmd_sg_entries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_srp_transport_template</span> <span class="o">=</span>
		<span class="n">srp_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_srp_transport_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ib_srp_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_class</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t register class infiniband_srp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">srp_release_transport</span><span class="p">(</span><span class="n">ib_srp_transport_template</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_sa_register_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_sa_client</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_register_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t register IB client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">srp_release_transport</span><span class="p">(</span><span class="n">ib_srp_transport_template</span><span class="p">);</span>
		<span class="n">ib_sa_unregister_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_sa_client</span><span class="p">);</span>
		<span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_class</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">srp_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ib_unregister_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_client</span><span class="p">);</span>
	<span class="n">ib_sa_unregister_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_sa_client</span><span class="p">);</span>
	<span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srp_class</span><span class="p">);</span>
	<span class="n">srp_release_transport</span><span class="p">(</span><span class="n">ib_srp_transport_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">srp_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">srp_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
