<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › ulp › ipoib › ipoib_ib.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ipoib_ib.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2004, 2005 Voltaire, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>

<span class="cp">#include &quot;ipoib.h&quot;</span>

<span class="cp">#ifdef CONFIG_INFINIBAND_IPOIB_DEBUG_DATA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">data_debug_level</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">data_debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">data_debug_level</span><span class="p">,</span>
		 <span class="s">&quot;Enable data path debug tracing if &gt; 0&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pkey_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ipoib_ah</span> <span class="o">*</span><span class="nf">ipoib_create_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_ah_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_ah</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_ah</span> <span class="o">*</span><span class="n">vah</span><span class="p">;</span>

	<span class="n">ah</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span>       <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">last_send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

	<span class="n">vah</span> <span class="o">=</span> <span class="n">ib_create_ah</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipoib_ah</span> <span class="o">*</span><span class="p">)</span><span class="n">vah</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="n">vah</span><span class="p">;</span>
		<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="s">&quot;Created ah %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ah</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_free_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_ah</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_ah</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dead_ahs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_ud_dma_unmap_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="n">mapping</span><span class="p">[</span><span class="n">IPOIB_UD_RX_SG</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_ud_need_sg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_ib_mtu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">IPOIB_UD_HEAD_SIZE</span><span class="p">,</span>
				    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">ib_dma_unmap_page</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">IPOIB_UD_BUF_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_ib_mtu</span><span class="p">),</span>
				    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_ud_skb_put_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_ud_need_sg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_ib_mtu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * There is only two buffers needed for max_payload = 4K,</span>
<span class="cm">		 * first buf size is IPOIB_UD_HEAD_SIZE</span>
<span class="cm">		 */</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">IPOIB_UD_HEAD_SIZE</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span>  <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">IPOIB_UD_HEAD_SIZE</span><span class="p">;</span>

		<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipoib_ib_post_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_wr</span><span class="p">.</span><span class="n">wr_id</span>   <span class="o">=</span> <span class="n">id</span> <span class="o">|</span> <span class="n">IPOIB_OP_RECV</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_sge</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_post_recv</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;receive failed for buf %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ipoib_ud_dma_unmap_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ipoib_alloc_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_ud_need_sg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_ib_mtu</span><span class="p">))</span>
		<span class="n">buf_size</span> <span class="o">=</span> <span class="n">IPOIB_UD_HEAD_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf_size</span> <span class="o">=</span> <span class="n">IPOIB_UD_BUF_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_ib_mtu</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">buf_size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IB will leave a 40 byte gap for a GRH and IPoIB adds a 4 byte</span>
<span class="cm">	 * header.  So we need 4 more bytes to get to 48 and align the</span>
<span class="cm">	 * IP header to a multiple of 16.</span>
<span class="cm">	 */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mapping</span><span class="p">;</span>
	<span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
				       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_ud_need_sg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_ib_mtu</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">partial_error</span><span class="p">;</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ib_dma_map_page</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
			<span class="k">goto</span> <span class="n">partial_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">partial_error:</span>
	<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipoib_ib_post_receives</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipoib_recvq_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipoib_alloc_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed to allocate receive buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_ib_post_receive</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;ipoib_ib_post_receive failed for buf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_ib_handle_rx_wc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_id</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IPOIB_OP_RECV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mapping</span><span class="p">[</span><span class="n">IPOIB_UD_RX_SG</span><span class="p">];</span>
	<span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">dgid</span><span class="p">;</span>

	<span class="n">ipoib_dbg_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;recv completion: id %d, status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">wr_id</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wr_id</span> <span class="o">&gt;=</span> <span class="n">ipoib_recvq_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;recv completion event with wrid %d (&gt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">wr_id</span><span class="p">,</span> <span class="n">ipoib_recvq_size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">wr_id</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">)</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed recv event &quot;</span>
				   <span class="s">&quot;(status=%d, wrid=%d vend_err %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">wr_id</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">vendor_err</span><span class="p">);</span>
		<span class="n">ipoib_ud_dma_unmap_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">wr_id</span><span class="p">].</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">wr_id</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop packets that this interface sent, ie multicast packets</span>
<span class="cm">	 * that the HCA has replicated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">slid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_lid</span> <span class="o">&amp;&amp;</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">src_qp</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">repost</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">wr_id</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
	       <span class="n">IPOIB_UD_RX_SG</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">mapping</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we can&#39;t allocate a new RX buffer, dump</span>
<span class="cm">	 * this packet and reuse the old buffer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ipoib_alloc_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wr_id</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">repost</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipoib_dbg_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;received %d bytes, SLID 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">slid</span><span class="p">);</span>

	<span class="n">ipoib_ud_dma_unmap_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
	<span class="n">ipoib_ud_skb_put_frags</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span><span class="p">);</span>

	<span class="cm">/* First byte of dgid signals multicast when 0xff */</span>
	<span class="n">dgid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">ib_grh</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dgid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">&amp;</span> <span class="n">IB_WC_GRH</span><span class="p">)</span> <span class="o">||</span> <span class="n">dgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dgid</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_BROADCAST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_MULTICAST</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IB_GRH_BYTES</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ipoib_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IPOIB_ENCAP_LEN</span><span class="p">);</span>

	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">likely</span><span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">&amp;</span> <span class="n">IB_WC_IP_CSUM_OK</span><span class="p">))</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>

	<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">repost:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ipoib_ib_post_receive</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wr_id</span><span class="p">)))</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;ipoib_ib_post_receive failed &quot;</span>
			   <span class="s">&quot;for buf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wr_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipoib_dma_map_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ipoib_tx_buf</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib_dma_map_page</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span>
						 <span class="n">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						 <span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">off</span><span class="p">])))</span>
			<span class="k">goto</span> <span class="n">partial_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">partial_error:</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">ib_dma_unmap_page</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="o">!</span><span class="n">off</span><span class="p">],</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_dma_unmap_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ipoib_tx_buf</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ib_dma_unmap_page</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">off</span><span class="p">],</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
				  <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_ib_handle_tx_wc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_id</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipoib_tx_buf</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">;</span>

	<span class="n">ipoib_dbg_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;send completion: id %d, status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">wr_id</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wr_id</span> <span class="o">&gt;=</span> <span class="n">ipoib_sendq_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;send completion event with wrid %d (&gt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">wr_id</span><span class="p">,</span> <span class="n">ipoib_sendq_size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">wr_id</span><span class="p">];</span>

	<span class="n">ipoib_dma_unmap_tx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">tx_req</span><span class="p">);</span>

	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">--</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_outstanding</span> <span class="o">==</span> <span class="n">ipoib_sendq_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_ADMIN_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">IB_WC_SUCCESS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">)</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed send event &quot;</span>
			   <span class="s">&quot;(status=%d, wrid=%d vend_err %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">wr_id</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">vendor_err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">poll_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">,</span> <span class="n">MAX_SEND_CQE</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">send_wc</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ipoib_ib_handle_tx_wc</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">send_wc</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">n</span> <span class="o">==</span> <span class="n">MAX_SEND_CQE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_dev_priv</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">done</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">poll_more:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">budget</span> <span class="o">-</span> <span class="n">done</span><span class="p">);</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">IPOIB_NUM_WC</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">&amp;</span> <span class="n">IPOIB_OP_RECV</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">done</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">&amp;</span> <span class="n">IPOIB_OP_CM</span><span class="p">)</span>
					<span class="n">ipoib_cm_handle_rx_wc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wc</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ipoib_ib_handle_rx_wc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ipoib_cm_handle_tx_wc</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">wc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">t</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">,</span>
					      <span class="n">IB_CQ_NEXT_COMP</span> <span class="o">|</span>
					      <span class="n">IB_CQ_REPORT_MISSED_EVENTS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">napi_reschedule</span><span class="p">(</span><span class="n">napi</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">poll_more</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_ib_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_tx_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_tx_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">poll_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="p">;</span> <span class="cm">/* nothing */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">netif_tx_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_send_comp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev_ptr</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_id</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ib_ah</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpn</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ipoib_tx_buf</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span>         <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span>       <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_sge</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">off</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">off</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_sge</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">off</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">num_sge</span>	     <span class="o">=</span> <span class="n">nr_frags</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">wr_id</span> 	     <span class="o">=</span> <span class="n">wr_id</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">remote_qpn</span> <span class="o">=</span> <span class="n">qpn</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">ah</span> 	     <span class="o">=</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">mss</span>	 <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">hlen</span>	 <span class="o">=</span> <span class="n">hlen</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">opcode</span>	 <span class="o">=</span> <span class="n">IB_WR_LSO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">opcode</span>	 <span class="o">=</span> <span class="n">IB_WR_SEND</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ib_post_send</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ipoib_ah</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipoib_tx_buf</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">phead</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">phead</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;linear data too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcast_mtu</span> <span class="o">+</span> <span class="n">IPOIB_ENCAP_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;packet len %d (&gt; %d) too long to send, dropping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcast_mtu</span> <span class="o">+</span> <span class="n">IPOIB_ENCAP_LEN</span><span class="p">);</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
			<span class="n">ipoib_cm_skb_too_long</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcast_mtu</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hlen</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipoib_dbg_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;sending packet, length=%d address=%p qpn=0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">qpn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We put the skb into the tx_ring _before_ we call post_send()</span>
<span class="cm">	 * because it&#39;s entirely possible that the completion handler will</span>
<span class="cm">	 * run before we execute anything after the post_send().  That</span>
<span class="cm">	 * means we have to make sure everything is properly recorded and</span>
<span class="cm">	 * our state is consistent before we call post_send().</span>
<span class="cm">	 */</span>
	<span class="n">tx_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ipoib_sendq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
	<span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ipoib_dma_map_tx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">tx_req</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">|=</span> <span class="n">IB_SEND_IP_CSUM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IB_SEND_IP_CSUM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_outstanding</span> <span class="o">==</span> <span class="n">ipoib_sendq_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;TX ring full, stopping kernel net queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">))</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;request notify on send CQ failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">post_send</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ipoib_sendq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		       <span class="n">address</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">qpn</span><span class="p">,</span> <span class="n">tx_req</span><span class="p">,</span> <span class="n">phead</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;post_send failed, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
		<span class="o">--</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_outstanding</span><span class="p">;</span>
		<span class="n">ipoib_dma_unmap_tx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">tx_req</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="n">address</span><span class="o">-&gt;</span><span class="n">last_send</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="n">skb_orphan</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_outstanding</span> <span class="o">&gt;</span> <span class="n">MAX_SEND_CQE</span><span class="p">))</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">poll_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="p">;</span> <span class="cm">/* nothing */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ipoib_reap_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipoib_ah</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="o">*</span><span class="n">tah</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">remove_list</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dead_ahs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">last_send</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ib_destroy_ah</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_reap_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_dev_priv</span><span class="p">,</span> <span class="n">ah_reap_task</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">__ipoib_reap_ah</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_STOP_REAPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ipoib_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah_reap_task</span><span class="p">,</span>
				   <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_ib_tx_timer_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drain_tx_cq</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_ib_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_find_pkey</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey_index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;P_Key 0x%04x not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipoib_init_qp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;ipoib_init_qp returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipoib_ib_post_receives</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;ipoib_ib_post_receives returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ipoib_ib_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipoib_cm_dev_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;ipoib_cm_dev_open returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ipoib_ib_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IPOIB_STOP_REAPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ipoib_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah_reap_task</span><span class="p">,</span>
			   <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipoib_pkey_dev_check_presence</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pkey_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_find_pkey</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkey_index</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_ib_dev_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ipoib_pkey_dev_check_presence</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;PKEY is not assigned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_OPER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ipoib_mcast_start_thread</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_ib_dev_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;downing ib_dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_OPER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Shutdown the P_Key thread if still active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_mutex</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey_poll_task</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
			<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ipoib_workqueue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipoib_mcast_stop_thread</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flush</span><span class="p">);</span>
	<span class="n">ipoib_mcast_dev_flush</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ipoib_flush_paths</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">recvs_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipoib_recvq_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span>
			<span class="o">++</span><span class="n">pending</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_drain_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We call completion handling routines that expect to be</span>
<span class="cm">	 * called from the BH-disabled NAPI poll context, so disable</span>
<span class="cm">	 * BHs here too.</span>
<span class="cm">	 */</span>
	<span class="n">local_bh_disable</span><span class="p">();</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">,</span> <span class="n">IPOIB_NUM_WC</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Convert any successful completions to flush</span>
<span class="cm">			 * errors to avoid passing packets up the</span>
<span class="cm">			 * stack after bringing the device down.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">==</span> <span class="n">IB_WC_SUCCESS</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wr_id</span> <span class="o">&amp;</span> <span class="n">IPOIB_OP_RECV</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wr_id</span> <span class="o">&amp;</span> <span class="n">IPOIB_OP_CM</span><span class="p">)</span>
					<span class="n">ipoib_cm_handle_rx_wc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ipoib_ib_handle_rx_wc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ipoib_cm_handle_tx_wc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibwc</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">IPOIB_NUM_WC</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">poll_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="p">;</span> <span class="cm">/* nothing */</span>

	<span class="n">local_bh_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_ib_dev_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">qp_attr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">begin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipoib_tx_buf</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">ipoib_cm_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Move our QP to the error state and then reinitialize in</span>
<span class="cm">	 * when all work requests have completed or have been flushed.</span>
<span class="cm">	 */</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp_attr</span><span class="p">,</span> <span class="n">IB_QP_STATE</span><span class="p">))</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to modify QP to ERROR state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait for all sends and receives to complete */</span>
	<span class="n">begin</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">||</span> <span class="n">recvs_pending</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">begin</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;timing out; %d sends %d receives not completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">,</span> <span class="n">recvs_pending</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

			<span class="cm">/*</span>
<span class="cm">			 * assume the HW is wedged and just free up</span>
<span class="cm">			 * all our pending work requests.</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tx_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="n">ipoib_sendq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
				<span class="n">ipoib_dma_unmap_tx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">tx_req</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">;</span>
				<span class="o">--</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_outstanding</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipoib_recvq_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ipoib_rx_buf</span> <span class="o">*</span><span class="n">rx_req</span><span class="p">;</span>

				<span class="n">rx_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">ipoib_ud_dma_unmap_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rx_req</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">rx_req</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">goto</span> <span class="n">timeout</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipoib_drain_cq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;All sends and receives done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">timeout:</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">);</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_RESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp_attr</span><span class="p">,</span> <span class="n">IB_QP_STATE</span><span class="p">))</span>
		<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to modify QP to RESET state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait for all AHs to be reaped */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IPOIB_STOP_REAPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah_reap_task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ipoib_workqueue</span><span class="p">);</span>

	<span class="n">begin</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dead_ahs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__ipoib_reap_ah</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipoib_warn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;timing out; will leak address handles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_ib_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span> <span class="o">=</span> <span class="n">ca</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_transport_dev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ca</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ipoib_transport_dev_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">,</span> <span class="n">ipoib_ib_tx_timer_func</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_ib_dev_open</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipoib_transport_dev_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ipoib_ib_dev_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ipoib_flush_level</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">cpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">new_index</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vlan_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flush any child interfaces too -- they might be up even if</span>
<span class="cm">	 * the parent is down.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cpriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">child_intfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">__ipoib_ib_dev_flush</span><span class="p">(</span><span class="n">cpriv</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vlan_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Not flushing - IPOIB_FLAG_INITIALIZED not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_ADMIN_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Not flushing - IPOIB_FLAG_ADMIN_UP not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">IPOIB_FLUSH_HEAVY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_find_pkey</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ipoib_ib_dev_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ipoib_ib_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipoib_pkey_dev_delay_open</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* restart QP only if P_Key index is changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">new_index</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Not flushing - P_Key index not changed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey_index</span> <span class="o">=</span> <span class="n">new_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">IPOIB_FLUSH_LIGHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipoib_mark_paths_invalid</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ipoib_mcast_dev_flush</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">IPOIB_FLUSH_NORMAL</span><span class="p">)</span>
		<span class="n">ipoib_ib_dev_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">IPOIB_FLUSH_HEAVY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipoib_ib_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ipoib_ib_dev_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The device could have been brought down between the start and when</span>
<span class="cm">	 * we get here, don&#39;t bring it back up if it&#39;s not configured up</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_FLAG_ADMIN_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">IPOIB_FLUSH_NORMAL</span><span class="p">)</span>
			<span class="n">ipoib_ib_dev_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ipoib_mcast_restart_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_ib_dev_flush_light</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_dev_priv</span><span class="p">,</span> <span class="n">flush_light</span><span class="p">);</span>

	<span class="n">__ipoib_ib_dev_flush</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPOIB_FLUSH_LIGHT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_ib_dev_flush_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_dev_priv</span><span class="p">,</span> <span class="n">flush_normal</span><span class="p">);</span>

	<span class="n">__ipoib_ib_dev_flush</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPOIB_FLUSH_NORMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_ib_dev_flush_heavy</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_dev_priv</span><span class="p">,</span> <span class="n">flush_heavy</span><span class="p">);</span>

	<span class="n">__ipoib_ib_dev_flush</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPOIB_FLUSH_HEAVY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipoib_ib_dev_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ipoib_dbg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;cleaning up ib_dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ipoib_mcast_stop_thread</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ipoib_mcast_dev_flush</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ipoib_transport_dev_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delayed P_Key Assigment Interim Support</span>
<span class="cm"> *</span>
<span class="cm"> * The following is initial implementation of delayed P_Key assigment</span>
<span class="cm"> * mechanism. It is using the same approach implemented for the multicast</span>
<span class="cm"> * group join. The single goal of this implementation is to quickly address</span>
<span class="cm"> * Bug #2507. This implementation will probably be removed when the P_Key</span>
<span class="cm"> * change async notification is available.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ipoib_pkey_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipoib_dev_priv</span><span class="p">,</span> <span class="n">pkey_poll_task</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ipoib_pkey_dev_check_presence</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ipoib_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ipoib_workqueue</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey_poll_task</span><span class="p">,</span>
					   <span class="n">HZ</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipoib_pkey_dev_delay_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipoib_dev_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Look for the interface pkey value in the IB Port P_Key table and */</span>
	<span class="cm">/* set the interface pkey assigment flag                            */</span>
	<span class="n">ipoib_pkey_dev_check_presence</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* P_Key value not assigned yet - start polling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_mutex</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IPOIB_PKEY_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ipoib_workqueue</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkey_poll_task</span><span class="p">,</span>
				   <span class="n">HZ</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
