<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › ulp › iser › iser_initiator.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iser_initiator.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004, 2005, 2006 Voltaire, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *	- Redistributions of source code must retain the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *	- Redistributions in binary form must reproduce the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer in the documentation and/or other materials</span>
<span class="cm"> *	  provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;iscsi_iser.h&quot;</span>

<span class="cm">/* Register user buffer memory and initialize passive rdma</span>
<span class="cm"> *  dto descriptor. Total data size is stored in</span>
<span class="cm"> *  iser_task-&gt;data[ISER_DIR_IN].data_len</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iser_prepare_read_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edtl</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_regd_buf</span> <span class="o">*</span><span class="n">regd_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iser_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_data_buf</span> <span class="o">*</span><span class="n">buf_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_dma_map_task_data</span><span class="p">(</span><span class="n">iser_task</span><span class="p">,</span>
				     <span class="n">buf_in</span><span class="p">,</span>
				     <span class="n">ISER_DIR_IN</span><span class="p">,</span>
				     <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edtl</span> <span class="o">&gt;</span> <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">].</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;Total data length: %ld, less than EDTL: &quot;</span>
			 <span class="s">&quot;%d, in READ cmd BHS itt: %d, conn: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">].</span><span class="n">data_len</span><span class="p">,</span> <span class="n">edtl</span><span class="p">,</span>
			 <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">iser_conn</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_reg_rdma_mem</span><span class="p">(</span><span class="n">iser_task</span><span class="p">,</span><span class="n">ISER_DIR_IN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;Failed to set up Data-IN RDMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regd_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">];</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span>    <span class="o">|=</span> <span class="n">ISER_RSV</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">read_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">read_va</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">va</span><span class="p">);</span>

	<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;Cmd itt:%d READ tags RKEY:%#.4X VA:%#llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">rkey</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">va</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Register user buffer memory and initialize passive rdma</span>
<span class="cm"> *  dto descriptor. Total data size is stored in</span>
<span class="cm"> *  task-&gt;data[ISER_DIR_OUT].data_len</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iser_prepare_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">imm_sz</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unsol_sz</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edtl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_regd_buf</span> <span class="o">*</span><span class="n">regd_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iser_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_data_buf</span> <span class="o">*</span><span class="n">buf_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">tx_dsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tx_sg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_dma_map_task_data</span><span class="p">(</span><span class="n">iser_task</span><span class="p">,</span>
				     <span class="n">buf_out</span><span class="p">,</span>
				     <span class="n">ISER_DIR_OUT</span><span class="p">,</span>
				     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edtl</span> <span class="o">&gt;</span> <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">].</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;Total data length: %ld, less than EDTL: %d, &quot;</span>
			 <span class="s">&quot;in WRITE cmd BHS itt: %d, conn: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">].</span><span class="n">data_len</span><span class="p">,</span>
			 <span class="n">edtl</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_reg_rdma_mem</span><span class="p">(</span><span class="n">iser_task</span><span class="p">,</span><span class="n">ISER_DIR_OUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;Failed to register write cmd RDMA mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regd_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unsol_sz</span> <span class="o">&lt;</span> <span class="n">edtl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span>     <span class="o">|=</span> <span class="n">ISER_WSV</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">write_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">write_va</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">unsol_sz</span><span class="p">);</span>

		<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;Cmd itt:%d, WRITE tags, RKEY:%#.4X &quot;</span>
			 <span class="s">&quot;VA:%#llX + unsol:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">rkey</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">unsol_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imm_sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;Cmd itt:%d, WRITE, adding imm.data sz: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">imm_sz</span><span class="p">);</span>
		<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">addr</span>   <span class="o">=</span> <span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
		<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">imm_sz</span><span class="p">;</span>
		<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">lkey</span>   <span class="o">=</span> <span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* creates a new tx descriptor and adds header regd buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iser_create_send_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_conn</span>	<span class="o">*</span><span class="n">ib_conn</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iser_tx_desc</span>	<span class="o">*</span><span class="n">tx_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iser_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ISER_HEADERS_LEN</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">iser_header</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_hdr</span><span class="p">));</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">iser_header</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISER_VER</span><span class="p">;</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">tx_sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lkey</span> <span class="o">!=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">tx_sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;sdesc %p lkey mismatch, fixing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">iser_alloc_rx_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_conn</span> <span class="o">*</span><span class="n">ib_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sge</span>       <span class="o">*</span><span class="n">rx_sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_device</span>  <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ISER_QP_MAX_RECV_DTOS</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_rx_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_desc_alloc_fail</span><span class="p">;</span>

	<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISER_QP_MAX_RECV_DTOS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rx_desc</span><span class="o">++</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_desc</span><span class="p">,</span>
					<span class="n">ISER_RX_PAYLOAD_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">rx_desc_dma_map_failed</span><span class="p">;</span>

		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">rx_sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">rx_sg</span><span class="p">;</span>
		<span class="n">rx_sg</span><span class="o">-&gt;</span><span class="n">addr</span>   <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">rx_sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ISER_RX_PAYLOAD_SIZE</span><span class="p">;</span>
		<span class="n">rx_sg</span><span class="o">-&gt;</span><span class="n">lkey</span>   <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rx_desc_dma_map_failed:</span>
	<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">rx_desc</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="n">ISER_RX_PAYLOAD_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">);</span>
	<span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">rx_desc_alloc_fail:</span>
	<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;failed allocating rx descriptors / data buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iser_free_rx_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_conn</span> <span class="o">*</span><span class="n">ib_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISER_QP_MAX_RECV_DTOS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rx_desc</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="n">ISER_RX_PAYLOAD_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">rx_descs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iser_post_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_conn</span> <span class="o">*</span><span class="n">iser_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;req op %x flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* check if this is the last login - going to full feature phase */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FULL_FEATURE_PHASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ISCSI_FULL_FEATURE_PHASE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that there is one posted recv buffer (for the last login</span>
<span class="cm">	 * response) and no posted send buffers left - they must have been</span>
<span class="cm">	 * consumed during previous login phases.</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">post_recv_buf_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">post_send_buf_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;Initially post: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISER_MIN_POSTED_RX</span><span class="p">);</span>
	<span class="cm">/* Initial post receive buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iser_post_recvm</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">ISER_MIN_POSTED_RX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iser_send_command - send command PDU</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iser_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_conn</span> <span class="o">*</span><span class="n">iser_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">edtl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_data_buf</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_scsi_req</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_scsi_req</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span>  <span class="o">=</span>  <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">edtl</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>

	<span class="cm">/* build the tx desc regd header and add it to the tx desc dto */</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ISCSI_TX_SCSI_COMMAND</span><span class="p">;</span>
	<span class="n">iser_create_send_desc</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_CMD_READ</span><span class="p">)</span>
		<span class="n">data_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">data_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* using a scatter list */</span>
		<span class="n">data_buf</span><span class="o">-&gt;</span><span class="n">buf</span>  <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">data_buf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data_buf</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_CMD_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iser_prepare_read_cmd</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">edtl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">send_command_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_CMD_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iser_prepare_write_cmd</span><span class="p">(</span><span class="n">task</span><span class="p">,</span>
					     <span class="n">task</span><span class="o">-&gt;</span><span class="n">imm_count</span><span class="p">,</span>
				             <span class="n">task</span><span class="o">-&gt;</span><span class="n">imm_count</span> <span class="o">+</span>
					     <span class="n">task</span><span class="o">-&gt;</span><span class="n">unsol_r2t</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span>
					     <span class="n">edtl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">send_command_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ISER_TASK_STATUS_STARTED</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_post_send</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">send_command_error:</span>
	<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;conn %p failed task-&gt;itt %d err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iser_send_data_out - send data out PDU</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iser_send_data_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">iscsi_data</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_conn</span> <span class="o">*</span><span class="n">iser_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_regd_buf</span> <span class="o">*</span><span class="n">regd_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_seg_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">itt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">tx_dsg</span><span class="p">;</span>

	<span class="n">itt</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">uint32_t</span><span class="p">)</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">data_seg_len</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">);</span>
	<span class="n">buf_offset</span>   <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;%s itt %d dseg_len %d offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">itt</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">data_seg_len</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">buf_offset</span><span class="p">);</span>

	<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">ig</span><span class="p">.</span><span class="n">desc_cache</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;Failed to alloc desc for post dataout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ISCSI_TX_DATAOUT</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">iser_header</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISER_VER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">iscsi_header</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>

	<span class="cm">/* build the tx desc */</span>
	<span class="n">iser_initialize_task_headers</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>

	<span class="n">regd_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">];</span>
	<span class="n">tx_dsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">tx_sg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">addr</span>    <span class="o">=</span> <span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">buf_offset</span><span class="p">;</span>
	<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">length</span>  <span class="o">=</span> <span class="n">data_seg_len</span><span class="p">;</span>
	<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">lkey</span>    <span class="o">=</span> <span class="n">regd_buf</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_offset</span> <span class="o">+</span> <span class="n">data_seg_len</span> <span class="o">&gt;</span> <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">].</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;Offset:%ld &amp; DSL:%ld in Data-Out &quot;</span>
			 <span class="s">&quot;inconsistent with total len:%ld, itt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">buf_offset</span><span class="p">,</span> <span class="n">data_seg_len</span><span class="p">,</span>
			 <span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">].</span><span class="n">data_len</span><span class="p">,</span> <span class="n">itt</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_data_out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;data-out itt: %d, offset: %ld, sz: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">itt</span><span class="p">,</span> <span class="n">buf_offset</span><span class="p">,</span> <span class="n">data_seg_len</span><span class="p">);</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_post_send</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">send_data_out_error:</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ig</span><span class="p">.</span><span class="n">desc_cache</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;conn %p failed err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iser_send_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_conn</span> <span class="o">*</span><span class="n">iser_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_tx_desc</span> <span class="o">*</span><span class="n">mdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_seg_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_conn</span> <span class="o">*</span><span class="n">ib_conn</span> <span class="o">=</span> <span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">;</span>

	<span class="cm">/* build the tx desc regd header and add it to the tx desc dto */</span>
	<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ISCSI_TX_CONTROL</span><span class="p">;</span>
	<span class="n">iser_create_send_desc</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">mdesc</span><span class="p">);</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">data_seg_len</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_seg_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">tx_dsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">tx_sg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">!=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">login_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;data present on non login task!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">send_control_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span>
			<span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_req_dma</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_req_buf</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							<span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">);</span>

		<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span>
			<span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_req_dma</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">addr</span>    <span class="o">=</span> <span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_req_dma</span><span class="p">;</span>
		<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">length</span>  <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">;</span>
		<span class="n">tx_dsg</span><span class="o">-&gt;</span><span class="n">lkey</span>    <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">login_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iser_post_recvl</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">send_control_error</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iser_post_rx_bufs</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">send_control_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iser_post_send</span><span class="p">(</span><span class="n">iser_conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">mdesc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">send_control_error:</span>
	<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;conn %p failed err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iser_rcv_dto_completion - recv DTO completion</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iser_rcv_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_xfer_len</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iser_conn</span> <span class="o">*</span><span class="n">ib_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iser_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">iser_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_buflen</span><span class="p">,</span> <span class="n">outstanding</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* differentiate between login to all other PDUs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_desc</span> <span class="o">==</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_resp_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_dma</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_resp_dma</span><span class="p">;</span>
		<span class="n">rx_buflen</span> <span class="o">=</span> <span class="n">ISER_RX_LOGIN_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_dma</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">rx_buflen</span> <span class="o">=</span> <span class="n">ISER_RX_PAYLOAD_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="n">rx_dma</span><span class="p">,</span>
			<span class="n">rx_buflen</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">iscsi_header</span><span class="p">;</span>

	<span class="n">iser_dbg</span><span class="p">(</span><span class="s">&quot;op 0x%x itt 0x%x dlen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">rx_xfer_len</span> <span class="o">-</span> <span class="n">ISER_HEADERS_LEN</span><span class="p">));</span>

	<span class="n">iscsi_iser_recv</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">iscsi_conn</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rx_xfer_len</span> <span class="o">-</span> <span class="n">ISER_HEADERS_LEN</span><span class="p">);</span>

	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="n">rx_dma</span><span class="p">,</span>
			<span class="n">rx_buflen</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="cm">/* decrementing conn-&gt;post_recv_buf_count only --after-- freeing the   *</span>
<span class="cm">	 * task eliminates the need to worry on tasks which are completed in   *</span>
<span class="cm">	 * parallel to the execution of iser_conn_term. So the code that waits *</span>
<span class="cm">	 * for the posted rx bufs refcount to become zero handles everything   */</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">post_recv_buf_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_dma</span> <span class="o">==</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">login_resp_dma</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">outstanding</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">post_recv_buf_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outstanding</span> <span class="o">+</span> <span class="n">ISER_MIN_POSTED_RX</span> <span class="o">&lt;=</span> <span class="n">ISER_QP_MAX_RECV_DTOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ISER_QP_MAX_RECV_DTOS</span> <span class="o">-</span> <span class="n">outstanding</span><span class="p">,</span>
						<span class="n">ISER_MIN_POSTED_RX</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iser_post_recvm</span><span class="p">(</span><span class="n">ib_conn</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">iser_err</span><span class="p">(</span><span class="s">&quot;posting %d rx bufs err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iser_snd_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iser_conn</span> <span class="o">*</span><span class="n">ib_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ISCSI_TX_DATAOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
					<span class="n">ISER_HEADERS_LEN</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ig</span><span class="p">.</span><span class="n">desc_cache</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_conn</span><span class="o">-&gt;</span><span class="n">post_send_buf_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ISCSI_TX_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this arithmetic is legal by libiscsi dd_data allocation */</span>
		<span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_desc</span> <span class="o">-</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">==</span> <span class="n">RESERVED_ITT</span><span class="p">)</span>
			<span class="n">iscsi_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iser_task_rdma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ISER_TASK_STATUS_INIT</span><span class="p">;</span>

	<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">].</span><span class="n">data_len</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_regd_buf</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iser_regd_buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iser_task_rdma_finalize</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iser_task</span> <span class="o">*</span><span class="n">iser_task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_rdma_aligned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iser_regd_buf</span> <span class="o">*</span><span class="n">regd</span><span class="p">;</span>

	<span class="cm">/* if we were reading, copy back to unaligned sglist,</span>
<span class="cm">	 * anyway dma_unmap and free the copy</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data_copy</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">].</span><span class="n">copy_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_rdma_aligned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iser_finalize_rdma_unaligned_sg</span><span class="p">(</span><span class="n">iser_task</span><span class="p">,</span> <span class="n">ISER_DIR_IN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">data_copy</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">].</span><span class="n">copy_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_rdma_aligned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iser_finalize_rdma_unaligned_sg</span><span class="p">(</span><span class="n">iser_task</span><span class="p">,</span> <span class="n">ISER_DIR_OUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">regd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_IN</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regd</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">is_fmr</span><span class="p">)</span>
			<span class="n">iser_unreg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regd</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">regd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iser_task</span><span class="o">-&gt;</span><span class="n">rdma_regd</span><span class="p">[</span><span class="n">ISER_DIR_OUT</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regd</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">is_fmr</span><span class="p">)</span>
			<span class="n">iser_unreg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regd</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

       <span class="cm">/* if the data was unaligned, it was already unmapped and then copied */</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">is_rdma_aligned</span><span class="p">)</span>
		<span class="n">iser_dma_unmap_task_data</span><span class="p">(</span><span class="n">iser_task</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
