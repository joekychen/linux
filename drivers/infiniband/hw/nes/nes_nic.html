<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › nes › nes_nic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nes_nic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 - 2011 Intel Corporation.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>

<span class="cp">#include &lt;net/inet_common.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>

<span class="cp">#include &quot;nes.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">24</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">28</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">32</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">26</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">34</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">18</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">25</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">29</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">33</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">22</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">27</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">31</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">35</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">18</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">25</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">29</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">33</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">22</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">27</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">31</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">35</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">26</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">34</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">22</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="mi">27</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">31</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">35</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">28</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">32</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_5</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">29</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">33</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_6</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">34</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="n">nic_qp_mapping_7</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">35</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="o">*</span><span class="n">nic_qp_mapping_per_function</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">nic_qp_mapping_0</span><span class="p">,</span> <span class="n">nic_qp_mapping_1</span><span class="p">,</span> <span class="n">nic_qp_mapping_2</span><span class="p">,</span> <span class="n">nic_qp_mapping_3</span><span class="p">,</span>
	<span class="n">nic_qp_mapping_4</span><span class="p">,</span> <span class="n">nic_qp_mapping_5</span><span class="p">,</span> <span class="n">nic_qp_mapping_6</span><span class="p">,</span> <span class="n">nic_qp_mapping_7</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">default_msg</span> <span class="o">=</span> <span class="n">NETIF_MSG_DRV</span> <span class="o">|</span> <span class="n">NETIF_MSG_PROBE</span> <span class="o">|</span> <span class="n">NETIF_MSG_LINK</span>
		<span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFDOWN</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nics_per_function</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * nes_netdev_poll</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_cq</span> <span class="o">*</span><span class="n">nescq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">budget</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cqes_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">rx_cqes_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cqe_allocs_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">rx_pkts_indicated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nes_nic_ce_handler</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nescq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cqes_pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/* clear out completed cqes and arm */</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">NES_CQE_ALLOC_NOTIFY_NEXT</span> <span class="o">|</span>
				<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cqe_allocs_pending</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* clear out completed cqes but don&#39;t arm */</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span>
				<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">cqe_allocs_pending</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NETDEV</span><span class="p">,</span> <span class="s">&quot;%s: exiting with work pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nescq</span><span class="o">-&gt;</span><span class="n">rx_pkts_indicated</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_open - Activate the network interface; ifconfig</span>
<span class="cm"> * ethx up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macaddr_low</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macaddr_high</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">first_nesvnic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_pos</span><span class="p">,</span> <span class="o">*</span><span class="n">list_temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">nesdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;%s: enabling interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nes_init_nic_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rdma_enabled</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span> <span class="o">=</span> <span class="n">nes_init_ofa_device</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: nesvnic-&gt;nesibdev alloc failed&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span><span class="o">-&gt;</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nes_register_ofa_device</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Unable to register RDMA device, ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Set packet filters */</span>
	<span class="n">nic_active_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_ACTIVE</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_ACTIVE</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ENABLE</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ENABLE</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_BROADCAST_ON</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_BROADCAST_ON</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>

	<span class="n">macaddr_high</span>  <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">macaddr_high</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">macaddr_low</span>   <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="cm">/* Program the various MAC regs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NES_MAX_PORT_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NETDEV</span><span class="p">,</span> <span class="s">&quot;i=%d, perfect filter table index= %d, PERF FILTER LOW&quot;</span>
				<span class="s">&quot; (Addr:%08X) = %08X, HIGH = %08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">NES_IDX_PERFECT_FILTER_LOW</span><span class="o">+</span>
					<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
				<span class="n">macaddr_low</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">macaddr_high</span> <span class="o">|</span> <span class="n">NES_MAC_ADDR_VALID</span> <span class="o">|</span>
				<span class="p">((((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_PERFECT_FILTER_LOW</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
				<span class="n">macaddr_low</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_PERFECT_FILTER_HIGH</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">macaddr_high</span> <span class="o">|</span> <span class="n">NES_MAC_ADDR_VALID</span> <span class="o">|</span>
				<span class="p">((((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="p">}</span>


	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">NES_CQE_ALLOC_NOTIFY_NEXT</span> <span class="o">|</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_number</span><span class="p">);</span>
	<span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="n">list_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">first_nesvnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Setting up MAC interrupt mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_MASK</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x200</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">),</span>
				<span class="o">~</span><span class="p">(</span><span class="n">NES_MAC_INT_LINK_STAT_CHG</span> <span class="o">|</span> <span class="n">NES_MAC_INT_XGMII_EXT</span> <span class="o">|</span>
				<span class="n">NES_MAC_INT_TX_UNDERFLOW</span> <span class="o">|</span> <span class="n">NES_MAC_INT_TX_ERROR</span><span class="p">));</span>
		<span class="n">first_nesvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable network packets */</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_SFP_D</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_recheck</span><span class="p">)</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_recheck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">NES_LINK_RECHECK_DELAY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">send_term_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">nes_port_ibevent</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_stop</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">first_nesvnic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_pos</span><span class="p">,</span> <span class="o">*</span><span class="n">list_temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;nesvnic=%p, nesdev=%p, netdev=%p %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifdown</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;%s: disabling interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Disable network packets */</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="n">list_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">first_nesvnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first_nesvnic</span> <span class="o">!=</span> <span class="n">nesvnic</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first_nesvnic</span> <span class="o">!=</span> <span class="n">nesvnic</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span>
		<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_MASK</span><span class="o">+</span>
				<span class="p">(</span><span class="mh">0x200</span><span class="o">*</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">),</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MAC_INT_MASK</span><span class="o">+</span>
				<span class="p">(</span><span class="mh">0x200</span><span class="o">*</span><span class="n">first_nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">),</span>
			<span class="o">~</span><span class="p">(</span><span class="n">NES_MAC_INT_LINK_STAT_CHG</span> <span class="o">|</span> <span class="n">NES_MAC_INT_XGMII_EXT</span> <span class="o">|</span>
			<span class="n">NES_MAC_INT_TX_UNDERFLOW</span> <span class="o">|</span> <span class="n">NES_MAC_INT_TX_ERROR</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_MASK</span><span class="o">+</span><span class="p">(</span><span class="mh">0x200</span><span class="o">*</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">),</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nic_active_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">));</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PERFECT_FILTER_HIGH</span><span class="o">+</span>
			<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">perfect_filter_index</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_ACTIVE</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="n">nic_active_mask</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_ACTIVE</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="n">nic_active_mask</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ENABLE</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="n">nic_active_mask</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ENABLE</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="n">nic_active_mask</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_BROADCAST_ON</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="n">nic_active_mask</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_BROADCAST_ON</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">send_term_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">nes_port_ibevent</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">event_timer</span><span class="p">);</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">event_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nes_destroy_nic_qp</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_nic_send</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_nic_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic</span> <span class="o">*</span><span class="n">nesnic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span> <span class="o">*</span><span class="n">nic_sqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">wqe_fragment_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wqe_misc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqe_fragment_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* first fragment (0) is used by copy buffer */</span>
	<span class="n">u16</span> <span class="n">skb_fragment_index</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_address</span><span class="p">;</span>

	<span class="n">nic_sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">];</span>
	<span class="n">wqe_fragment_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_LENGTH_0_TAG_IDX</span><span class="p">];</span>

	<span class="cm">/* setup the VLAN tag if present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;%s: VLAN packet to send... VLAN = %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">wqe_misc</span> <span class="o">=</span> <span class="n">NES_NIC_SQ_WQE_TAGVALUE_ENABLE</span><span class="p">;</span>
		<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__le16</span><span class="p">)</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wqe_misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* bump past the vlan tag */</span>
	<span class="n">wqe_fragment_length</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/*	wqe_fragment_address = (u64 *)&amp;nic_sqe-&gt;wqe_words[NES_NIC_SQ_WQE_FRAG0_LOW_IDX]; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* nes_debug(NES_DBG_NIC_TX, &quot;%s: TSO request... seg size = %u\n&quot;,</span>
<span class="cm">						netdev-&gt;name, skb_is_gso(skb)); */</span>
				<span class="n">wqe_misc</span> <span class="o">|=</span> <span class="n">NES_NIC_SQ_WQE_LSO_ENABLE</span> <span class="o">|</span>
						<span class="n">NES_NIC_SQ_WQE_COMPLETION</span> <span class="o">|</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_LSO_INFO_IDX</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(((</span><span class="n">u32</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tcph</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">wqe_misc</span> <span class="o">|=</span> <span class="n">NES_NIC_SQ_WQE_COMPLETION</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* CHECKSUM_HW */</span>
		<span class="n">wqe_misc</span> <span class="o">|=</span> <span class="n">NES_NIC_SQ_WQE_DISABLE_CHKSUM</span> <span class="o">|</span> <span class="n">NES_NIC_SQ_WQE_COMPLETION</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_TOTAL_LENGTH_IDX</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">min</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">),</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)));</span>
	<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">min</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">),</span>
			<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)));</span>
	<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;%s: Packet with %u fragments not sent, skb_headlen=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">tx_sw_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_LOCKED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_overflow</span><span class="p">);</span>
		<span class="n">bus_address</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">,</span>
				<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">);</span>
		<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG1_LOW_IDX</span><span class="p">,</span>
				<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">bus_address</span><span class="p">)));</span>
		<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_LENGTH_2_1_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Deal with Fragments */</span>
		<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">skb_fragment_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">skb_fragment_index</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
				<span class="n">skb_fragment_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">skb_fragment_index</span><span class="p">];</span>
			<span class="n">bus_address</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">skb_fragment_index</span><span class="p">]));</span>
			<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">wqe_fragment_index</span><span class="p">),</span>
				<span class="n">bus_address</span><span class="p">);</span>
			<span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wqe_fragment_index</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_MISC_IDX</span><span class="p">,</span> <span class="n">wqe_misc</span><span class="p">);</span>
	<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_start_xmit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic</span> <span class="o">*</span><span class="n">nesnic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span> <span class="o">*</span><span class="n">nic_sqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="cm">/* struct udphdr *udph; */</span>
<span class="cp">#define NES_MAX_TSO_FRAGS MAX_SKB_FRAGS</span>
	<span class="cm">/* 64K segment plus overflow on each side */</span>
	<span class="n">dma_addr_t</span> <span class="n">tso_bus_address</span><span class="p">[</span><span class="n">NES_MAX_TSO_FRAGS</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tso_frag_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tso_frag_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tso_wqe_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curr_tcp_seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wqe_count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">send_rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">wqe_fragment_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">original_first_length</span><span class="p">;</span>
	<span class="cm">/* u64 *wqe_fragment_address; */</span>
	<span class="cm">/* first fragment (0) is used by copy buffer */</span>
	<span class="n">u16</span> <span class="n">wqe_fragment_index</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hoffset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nhoffset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqes_needed</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqes_available</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wqe_misc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * nes_debug(NES_DBG_NIC_TX, &quot;%s Request to tx NIC packet length %u, headlen %u,&quot;</span>
<span class="cm">	 *		&quot; (%u frags), tso_size=%u\n&quot;,</span>
<span class="cm">	 *		netdev-&gt;name, skb-&gt;len, skb_headlen(skb),</span>
<span class="cm">	 *		skb_shinfo(skb)-&gt;nr_frags, skb_is_gso(skb));</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="cm">/* Check if SQ is full */</span>
	<span class="k">if</span> <span class="p">((((</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="o">+</span><span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">((((((</span><span class="k">volatile</span> <span class="n">u16</span><span class="p">)</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">sq_no_longer_full</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">sq_full</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">sq_no_longer_full:</span>
	<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr_frags</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check if too many fragments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">nr_frags</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">segmented_tso_requests</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">tso_requests</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Basically 4 fragments available per WQE with extended fragments */</span>
			<span class="n">wqes_needed</span> <span class="o">=</span> <span class="n">nr_frags</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">wqes_needed</span> <span class="o">+=</span> <span class="p">(</span><span class="n">nr_frags</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
			<span class="n">wqes_available</span> <span class="o">=</span> <span class="p">(((</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="o">+</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="p">)</span><span class="o">-</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wqes_needed</span> <span class="o">&gt;</span> <span class="n">wqes_available</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
					<span class="n">barrier</span><span class="p">();</span>
					<span class="n">wqes_available</span> <span class="o">=</span> <span class="p">(((((</span><span class="k">volatile</span> <span class="n">u16</span><span class="p">)</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="p">)</span><span class="o">+</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="p">)</span><span class="o">-</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">wqes_needed</span> <span class="o">&lt;=</span> <span class="n">wqes_available</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">tso_sq_no_longer_full</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">sq_full</span><span class="o">++</span><span class="p">;</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;%s: HNIC SQ full- TSO request has too many frags!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
			<span class="p">}</span>
<span class="nl">tso_sq_no_longer_full:</span>
			<span class="cm">/* Map all the buffers */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">tso_frag_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">tso_frag_count</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
					<span class="n">tso_frag_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">tso_frag_count</span><span class="p">];</span>
				<span class="n">tso_bus_address</span><span class="p">[</span><span class="n">tso_frag_count</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
							 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">tso_frag_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">curr_tcp_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">hoffset</span> <span class="o">=</span> <span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">nhoffset</span> <span class="o">=</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">original_first_length</span> <span class="o">=</span> <span class="n">hoffset</span> <span class="o">+</span> <span class="p">((((</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">doff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">wqe_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">wqe_count</span><span class="o">&lt;</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">wqes_needed</span><span class="p">);</span> <span class="n">wqe_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tso_wqe_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">nic_sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">];</span>
				<span class="n">wqe_fragment_length</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_LENGTH_0_TAG_IDX</span><span class="p">];</span>
				<span class="cm">/* setup the VLAN tag if present */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;%s: VLAN packet to send... VLAN = %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">);</span>
					<span class="n">wqe_misc</span> <span class="o">=</span> <span class="n">NES_NIC_SQ_WQE_TAGVALUE_ENABLE</span><span class="p">;</span>
					<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__le16</span><span class="p">)</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">wqe_misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* bump past the vlan tag */</span>
				<span class="n">wqe_fragment_length</span><span class="o">++</span><span class="p">;</span>

				<span class="cm">/* Assumes header totally fits in allocated buffer and is in first fragment */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">original_first_length</span> <span class="o">&gt;</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;ERROR: SKB header too big, headlen=%u, FIRST_FRAG_SIZE=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">original_first_length</span><span class="p">,</span> <span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">);</span>
					<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;%s Request to tx NIC packet length %u, headlen %u,&quot;</span>
							<span class="s">&quot; (%u frags), tso_size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
							<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span> <span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">min</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">),</span>
						<span class="n">original_first_length</span><span class="p">));</span>
				<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">].</span><span class="n">buffer</span><span class="p">[</span><span class="n">nhoffset</span><span class="p">]);</span>
				<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">].</span><span class="n">buffer</span><span class="p">[</span><span class="n">hoffset</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">wqe_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">wqes_needed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">psh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">urg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wqe_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">curr_tcp_seq</span><span class="p">);</span>
				<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">min</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">NES_FIRST_FRAG_SIZE</span><span class="p">),</span>
						<span class="n">original_first_length</span><span class="p">));</span>

				<span class="n">wqe_fragment_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">wqe_count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">original_first_length</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_overflow</span><span class="p">);</span>
					<span class="n">bus_address</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">original_first_length</span><span class="p">,</span>
							<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">original_first_length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
					<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">original_first_length</span><span class="p">);</span>
					<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG1_LOW_IDX</span><span class="p">,</span>
									<span class="n">bus_address</span><span class="p">);</span>
					<span class="n">tso_wqe_length</span> <span class="o">+=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span>
							<span class="n">original_first_length</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">wqe_fragment_index</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">tso_frag_index</span><span class="p">]));</span>
					<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">wqe_fragment_index</span><span class="p">),</span>
						<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">tso_bus_address</span><span class="p">[</span><span class="n">tso_frag_index</span><span class="p">]);</span>
					<span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">;</span>
					<span class="n">tso_wqe_length</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">tso_frag_index</span><span class="o">++</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">wqe_fragment_index</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
						<span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tso_frag_index</span> <span class="o">==</span> <span class="n">tso_frag_count</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">wqe_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">wqes_needed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">wqe_misc</span> <span class="o">|=</span> <span class="n">NES_NIC_SQ_WQE_COMPLETION</span> <span class="o">|</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tso_wqe_length</span> <span class="o">+</span> <span class="n">original_first_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">wqe_misc</span> <span class="o">|=</span> <span class="n">NES_NIC_SQ_WQE_LSO_ENABLE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">tso_wqe_length</span> <span class="o">+</span> <span class="n">original_first_length</span> <span class="o">-</span> <span class="n">nhoffset</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_MISC_IDX</span><span class="p">,</span>
						 <span class="n">wqe_misc</span><span class="p">);</span>
				<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_LSO_INFO_IDX</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hoffset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

				<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_TOTAL_LENGTH_IDX</span><span class="p">,</span>
						<span class="n">tso_wqe_length</span> <span class="o">+</span> <span class="n">original_first_length</span><span class="p">);</span>
				<span class="n">curr_tcp_seq</span> <span class="o">+=</span> <span class="n">tso_wqe_length</span><span class="p">;</span>
				<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
				<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linearized_skbs</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hoffset</span> <span class="o">=</span> <span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">nhoffset</span> <span class="o">=</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hoffset</span><span class="p">);</span>
			<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nhoffset</span><span class="p">);</span>
			<span class="n">send_rc</span> <span class="o">=</span> <span class="n">nes_nic_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">send_rc</span> <span class="o">!=</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">send_rc</span> <span class="o">=</span> <span class="n">nes_nic_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">send_rc</span> <span class="o">!=</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wqe_count</span><span class="p">)</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span>
				<span class="p">(</span><span class="n">wqe_count</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_stats</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">nes_netdev_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_DISCARD</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_discard</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_OCTETS_LO</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_OCTETS_HI</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_octets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_FRAMES_LO</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_FRAMES_HI</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_frames</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_OCTETS_LO</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_OCTETS_HI</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_tx_octets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_FRAMES_LO</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_FRAMES_HI</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_tx_frames</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_SHORT_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_short_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_OVERSIZED_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_oversized_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_JABBER_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_jabber_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_SYMBOL_ERR_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_symbol_err_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_LENGTH_ERR_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_CRC_ERR_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_crc_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_TX_ERRORS</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_tx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_tx_timeout</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_netdev_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_timer</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">))</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_TX</span><span class="p">,</span> <span class="s">&quot;%s: tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_set_mac_address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macaddr_low</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macaddr_high</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: Address length = %d, Address = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">,</span> <span class="n">mac_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">);</span>
	<span class="n">macaddr_high</span>  <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">macaddr_high</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">macaddr_low</span>   <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NES_MAX_PORT_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_PERFECT_FILTER_LOW</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
				<span class="n">macaddr_low</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_PERFECT_FILTER_HIGH</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">macaddr_high</span> <span class="o">|</span> <span class="n">NES_MAC_ADDR_VALID</span> <span class="o">|</span>
				<span class="p">((((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_allmulti</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nic_active_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nic_active</span><span class="p">;</span>

	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">);</span>
	<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define get_addr(addrs, index) ((addrs) + (index) * ETH_ALEN)</span>

<span class="cm">/**</span>
<span class="cm"> * nes_netdev_set_multicast_list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_netdev_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">perfect_filter_register_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macaddr_low</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macaddr_high</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mc_all_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mc_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_nic_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pft_entries_preallocated</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">adapter_fcn_count</span> <span class="o">*</span>
					<span class="n">nics_per_function</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">max_pft_entries_avaiable</span> <span class="o">=</span> <span class="n">NES_PFT_SIZE</span> <span class="o">-</span> <span class="n">pft_entries_preallocated</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nic_active_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">nic_active_bit</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">nic_active_bit</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
		<span class="n">mc_all_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_allmulti</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nic_active_bit</span><span class="p">);</span>
		<span class="n">mc_all_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">nic_active_bit</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">nic_active_bit</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_RX</span><span class="p">,</span> <span class="s">&quot;Number of MC entries = %d, Promiscuous = %d, All Multicast = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">mc_count</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">),</span>
		  <span class="o">!!</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc_all_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">addrs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">addrs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="n">mc_count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addrs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_allmulti</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nic_active_bit</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">get_addr</span><span class="p">(</span><span class="n">addrs</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">perfect_filter_register_address</span> <span class="o">=</span> <span class="n">NES_IDX_PERFECT_FILTER_LOW</span> <span class="o">+</span>
						<span class="n">pft_entries_preallocated</span> <span class="o">*</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mc_index</span> <span class="o">&lt;</span> <span class="n">max_pft_entries_avaiable</span><span class="p">;</span>
		     <span class="n">mc_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">mc_count</span> <span class="o">&amp;&amp;</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mcrq_mcast_filter</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">mc_nic_index</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mcrq_mcast_filter</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span>
					<span class="n">get_addr</span><span class="p">(</span><span class="n">addrs</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mc_nic_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mc_nic_index</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">[</span><span class="n">mc_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">[</span><span class="n">mc_index</span><span class="p">]</span> <span class="o">!=</span>
					<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">&amp;&amp;</span>
					<span class="n">mc_index</span> <span class="o">&lt;</span> <span class="n">max_pft_entries_avaiable</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_RX</span><span class="p">,</span>
					<span class="s">&quot;mc_index=%d skipping nic_index=%d, &quot;</span>
					<span class="s">&quot;used for=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc_index</span><span class="p">,</span>
					<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">,</span>
					<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">[</span><span class="n">mc_index</span><span class="p">]);</span>
				<span class="n">mc_index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mc_index</span> <span class="o">&gt;=</span> <span class="n">max_pft_entries_avaiable</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">mc_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">get_addr</span><span class="p">(</span><span class="n">addrs</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>

				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_RX</span><span class="p">,</span> <span class="s">&quot;Assigning MC Address %pM to register 0x%04X nic_idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">addr</span><span class="p">,</span>
					  <span class="n">perfect_filter_register_address</span><span class="o">+</span><span class="p">(</span><span class="n">mc_index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
					  <span class="n">mc_nic_index</span><span class="p">);</span>
				<span class="n">macaddr_high</span>  <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">macaddr_high</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">macaddr_low</span>   <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
				<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">macaddr_low</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						<span class="n">perfect_filter_register_address</span><span class="o">+</span><span class="p">(</span><span class="n">mc_index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
						<span class="n">macaddr_low</span><span class="p">);</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						<span class="n">perfect_filter_register_address</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="p">(</span><span class="n">mc_index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
						<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">macaddr_high</span> <span class="o">|</span> <span class="n">NES_MAC_ADDR_VALID</span> <span class="o">|</span>
						<span class="p">((((</span><span class="n">u32</span><span class="p">)(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">mc_nic_index</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">[</span><span class="n">mc_index</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NIC_RX</span><span class="p">,</span> <span class="s">&quot;Clearing MC Address at register 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">perfect_filter_register_address</span><span class="o">+</span><span class="p">(</span><span class="n">mc_index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						<span class="n">perfect_filter_register_address</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="p">(</span><span class="n">mc_index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">);</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">[</span><span class="n">mc_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">addrs</span><span class="p">);</span>
		<span class="cm">/* PFT is not large enough */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">mc_count</span><span class="p">)</span>
			<span class="n">set_allmulti</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nic_active_bit</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_change_mtu</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span>	<span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">jumbomode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_active_bit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uc_all_active</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_all_active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">max_mtu</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span>	<span class="o">=</span> <span class="n">new_mtu</span> <span class="o">+</span> <span class="n">VLAN_ETH_HLEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span>	<span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">jumbomode</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nes_nic_init_timer_defaults</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">jumbomode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nic_active_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
		<span class="n">mc_all_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">nic_active_bit</span><span class="p">;</span>
		<span class="n">uc_all_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="n">nic_active_bit</span><span class="p">;</span>

		<span class="n">nes_netdev_stop</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">nes_netdev_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

		<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">mc_all_active</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_MULTICAST_ALL</span><span class="p">,</span>
							<span class="n">nic_active</span><span class="p">);</span>

		<span class="n">nic_active</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">);</span>
		<span class="n">nic_active</span> <span class="o">|=</span> <span class="n">uc_all_active</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_UNICAST_ALL</span><span class="p">,</span> <span class="n">nic_active</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">nes_ethtool_stringset</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Link Change Interrupts&quot;</span><span class="p">,</span>
	<span class="s">&quot;Linearized SKBs&quot;</span><span class="p">,</span>
	<span class="s">&quot;T/GSO Requests&quot;</span><span class="p">,</span>
	<span class="s">&quot;Pause Frames Sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;Pause Frames Received&quot;</span><span class="p">,</span>
	<span class="s">&quot;Internal Routing Errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;SQ SW Dropped SKBs&quot;</span><span class="p">,</span>
	<span class="s">&quot;SQ Full&quot;</span><span class="p">,</span>
	<span class="s">&quot;Segmented TSO Requests&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx Symbol Errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx Jabber Errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx Oversized Frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx Short Frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx Length Errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx CRC Errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rx Port Discard&quot;</span><span class="p">,</span>
	<span class="s">&quot;Endnode Rx Discards&quot;</span><span class="p">,</span>
	<span class="s">&quot;Endnode Rx Octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;Endnode Rx Frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;Endnode Tx Octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;Endnode Tx Frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;Tx Errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;mh detected&quot;</span><span class="p">,</span>
	<span class="s">&quot;mh pauses&quot;</span><span class="p">,</span>
	<span class="s">&quot;Retransmission Count&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Connects&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Accepts&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disconnects&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connected Events&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connect Requests&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Rejects&quot;</span><span class="p">,</span>
	<span class="s">&quot;ModifyQP Timeouts&quot;</span><span class="p">,</span>
	<span class="s">&quot;CreateQPs&quot;</span><span class="p">,</span>
	<span class="s">&quot;SW DestroyQPs&quot;</span><span class="p">,</span>
	<span class="s">&quot;DestroyQPs&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Closes&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Packets Sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Packets Bounced&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Packets Created&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Packets Rcvd&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Packets Dropped&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Packets Retrans&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Listens Created&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Listens Destroyed&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Backlog Drops&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Loopbacks&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Nodes Created&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Nodes Destroyed&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Accel Drops&quot;</span><span class="p">,</span>
	<span class="s">&quot;CM Resets Received&quot;</span><span class="p">,</span>
	<span class="s">&quot;Free 4Kpbls&quot;</span><span class="p">,</span>
	<span class="s">&quot;Free 256pbls&quot;</span><span class="p">,</span>
	<span class="s">&quot;Timer Inits&quot;</span><span class="p">,</span>
	<span class="s">&quot;LRO aggregated&quot;</span><span class="p">,</span>
	<span class="s">&quot;LRO flushed&quot;</span><span class="p">,</span>
	<span class="s">&quot;LRO no_desc&quot;</span><span class="p">,</span>
	<span class="s">&quot;PAU CreateQPs&quot;</span><span class="p">,</span>
	<span class="s">&quot;PAU DestroyQPs&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define NES_ETHTOOL_STAT_COUNT  ARRAY_SIZE(nes_ethtool_stringset)</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_sset_count</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stringset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NES_ETHTOOL_STAT_COUNT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_strings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_netdev_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ethtool_strings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ethtool_strings</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">nes_ethtool_stringset</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">nes_ethtool_stringset</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_ethtool_stats</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_netdev_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">target_ethtool_stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">target_stat_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">target_ethtool_stats</span><span class="o">-&gt;</span><span class="n">n_stats</span> <span class="o">=</span> <span class="n">NES_ETHTOOL_STAT_COUNT</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_status_interrupts</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linearized_skbs</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">tso_requests</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_TX_PAUSE_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_pause_frames_sent</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_pause_frames_sent</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_PAUSE_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_pause_frames_received</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_PORT_RX_DISCARDS</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x40</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">port_rx_discards</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_PORT_TX_DISCARDS</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x40</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">port_tx_discards</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_SHORT_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_short_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_OVERSIZED_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_oversized_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_JABBER_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_jabber_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_SYMBOL_ERR_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_symbol_err_frames</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_LENGTH_ERR_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_RX_CRC_ERR_FRAMES</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_crc_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_MAC_TX_ERRORS</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_tx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nic_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nic_count</span> <span class="o">&lt;</span> <span class="n">NES_MAX_PORT_COUNT</span><span class="p">;</span> <span class="n">nic_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_DISCARD</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_discard</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>

		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_OCTETS_LO</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_OCTETS_HI</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_octets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_FRAMES_LO</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_RX_FRAMES_HI</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_frames</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_OCTETS_LO</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_OCTETS_HI</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_tx_octets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_FRAMES_LO</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_ENDNODE0_NSTAT_TX_FRAMES_HI</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_tx_frames</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">u64temp</span><span class="p">;</span>

		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_IPV4_TCP_REXMITS</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="n">nic_count</span><span class="p">]</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_ipv4_tcp_retransmits</span> <span class="o">+=</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_pause_frames_received</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nic_rx_eth_route_err</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">tx_sw_dropped</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">sq_full</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">segmented_tso_requests</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_symbol_err_frames</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_jabber_frames</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_oversized_frames</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_short_frames</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_rx_crc_errors</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">port_rx_discards</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_discard</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_octets</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_rx_frames</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_tx_octets</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_nstat_tx_frames</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_tx_errors</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mh_detected</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mh_pauses_sent</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">endnode_ipv4_tcp_retransmits</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connects</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_accepts</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_disconnects</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connecteds</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connect_reqs</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_rejects</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod_qp_timouts</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qps_created</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_qps_destroyed</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qps_destroyed</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_closes</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_packets_sent</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_packets_bounced</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_packets_created</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_packets_received</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_packets_dropped</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_packets_retrans</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_listens_created</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_listens_destroyed</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_backlog_drops</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_loopbacks</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_nodes_created</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_nodes_destroyed</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_accel_dropped_pkts</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_resets_recvd</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">free_4kpbl</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">free_256pbl</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_mod_timer_init</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">aggregated</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">flushed</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">no_desc</span><span class="p">;</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pau_qps_created</span><span class="p">);</span>
	<span class="n">target_stat_values</span><span class="p">[</span><span class="o">++</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pau_qps_destroyed</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_drvinfo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_netdev_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;%u.%u&quot;</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">firmware_version</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">,</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">firmware_version</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">testinfo_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_set_coalesce</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_coalesce</span>	<span class="o">*</span><span class="n">et_coalesce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span>	<span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_tune_timer</span> <span class="o">*</span><span class="n">shared_timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">tune_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_low</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_low</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_target</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_high</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_high</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_low</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_min</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_low</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_high</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_max</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_high</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* using this to drive total interrupt moderation */</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_limit</span> <span class="o">=</span> <span class="n">NES_TIMER_INT_LIMIT_DYNAMIC</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">pkt_rate_low</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_pkt_rate_low</span> <span class="o">=</span> <span class="n">et_coalesce</span><span class="o">-&gt;</span><span class="n">pkt_rate_low</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_limit</span> <span class="o">=</span> <span class="n">NES_TIMER_INT_LIMIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_PERIODIC_CONTROL</span><span class="p">,</span>
					<span class="mh">0x80000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_coalesce</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_coalesce</span>	<span class="o">*</span><span class="n">et_coalesce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span>	<span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_coalesce</span>	<span class="n">temp_et_coalesce</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_tune_timer</span> <span class="o">*</span><span class="n">shared_timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">tune_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_et_coalesce</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_et_coalesce</span><span class="p">));</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_coalesce_usecs_irq</span>    <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rate_sample_interval</span>     <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rate_sample_interval</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">pkt_rate_low</span> <span class="o">=</span>	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_pkt_rate_low</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span>	<span class="n">flags</span><span class="p">);</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_max_coalesced_frames_low</span>  <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_max_coalesced_frames_irq</span>  <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_target</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_max_coalesced_frames_high</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_coalesce_usecs_low</span>  <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_min</span><span class="p">;</span>
	<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_coalesce_usecs_high</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_et_coalesce</span><span class="p">.</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">et_coalesce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_et_coalesce</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">et_coalesce</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_pauseparam</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_netdev_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">et_pauseparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_rx_flow_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_tx_flow_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_set_pauseparam</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">et_pauseparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: should return unsupported */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_tx_flow_control</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MAC_TX_CONFIG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">u32temp</span> <span class="o">|=</span> <span class="n">NES_IDX_MAC_TX_CONFIG_ENABLE_PAUSE</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MAC_TX_CONFIG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">),</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_tx_flow_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_tx_flow_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MAC_TX_CONFIG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">));</span>
		<span class="n">u32temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_IDX_MAC_TX_CONFIG_ENABLE_PAUSE</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MAC_TX_CONFIG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x200</span><span class="p">),</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_tx_flow_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_rx_flow_control</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MPP_DEBUG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x40</span><span class="p">));</span>
		<span class="n">u32temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_IDX_MPP_DEBUG_PORT_DISABLE_PAUSE</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MPP_DEBUG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x40</span><span class="p">),</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_rx_flow_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">et_pauseparam</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_rx_flow_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MPP_DEBUG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x40</span><span class="p">));</span>
		<span class="n">u32temp</span> <span class="o">|=</span> <span class="n">NES_IDX_MPP_DEBUG_PORT_DISABLE_PAUSE</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_MPP_DEBUG</span> <span class="o">+</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="o">*</span><span class="mh">0x40</span><span class="p">),</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">disable_rx_flow_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_get_settings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">et_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_type</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">phy_index</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">port</span>   <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
	<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>
	<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">et_cmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">supported</span>   <span class="o">=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span>     <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">mac_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">supported</span>   <span class="o">=</span> <span class="n">SUPPORTED_1000baseT_Full</span>
					    <span class="o">|</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_1000baseT_Full</span>
					    <span class="o">|</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
				<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
			<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_ARGUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_SFP_D</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_KR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">port</span>        <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">supported</span>   <span class="o">=</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">supported</span>   <span class="o">=</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">;</span>
		<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">mac_index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">et_cmd</span><span class="p">,</span> <span class="n">SPEED_10000</span><span class="p">);</span>
	<span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_set_settings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_netdev_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">et_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">phy_index</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">];</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">et_cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Turn on Full duplex, Autoneg, and restart autonegotiation */</span>
			<span class="n">phy_data</span> <span class="o">|=</span> <span class="mh">0x1300</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Turn off autoneg */</span>
			<span class="n">phy_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">nes_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">nes_netdev_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">nes_netdev_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">nes_netdev_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">nes_netdev_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">nes_netdev_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">nes_netdev_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span> <span class="o">=</span> <span class="n">nes_netdev_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span> <span class="o">=</span> <span class="n">nes_netdev_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">nes_netdev_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span> <span class="o">=</span> <span class="n">nes_netdev_set_pauseparam</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_vlan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NETDEV</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable VLAN Stripping */</span>
	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PCIX_DIAG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">u32temp</span> <span class="o">&amp;=</span> <span class="mh">0xfdffffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">u32temp</span>	<span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>

	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PCIX_DIAG</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">nes_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since there is no support for separate rx/tx vlan accel</span>
<span class="cm">	 * enable/disable make sure tx flag is always in same state as rx.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">nes_vlan_mode</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">nes_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">nes_netdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">nes_netdev_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">nes_netdev_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">nes_netdev_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">nes_netdev_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">nes_netdev_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">nes_netdev_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">nes_netdev_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">nes_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">nes_set_features</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * nes_netdev_init - initialize network device</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">nes_netdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nic_qp_map</span> <span class="o">*</span><span class="n">curr_qp_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_type</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">];</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;nesvnic etherdev alloc failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;netdev = %p, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">NES_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">ETH_DATA_LEN</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nes_netdev_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nes_ethtool_ops</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">nes_netdev_poll</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Enabling VLAN Insert/Delete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="cm">/* Fill in the port structure */</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesdev</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">default_msg</span><span class="p">);</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">perfect_filter_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">netdev_count</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>

	<span class="n">curr_qp_map</span> <span class="o">=</span> <span class="n">nic_qp_mapping_per_function</span><span class="p">[</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)];</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span> <span class="o">=</span> <span class="n">curr_qp_map</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span><span class="p">].</span><span class="n">qpid</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">=</span> <span class="n">curr_qp_map</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span><span class="p">].</span><span class="n">nic_index</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">logical_port</span> <span class="o">=</span> <span class="n">curr_qp_map</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span><span class="p">].</span><span class="n">logical_port</span><span class="p">;</span>

	<span class="cm">/* Setup the burned in MAC address */</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_addr_low</span><span class="p">;</span>
	<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_addr_high</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">u64temp</span> <span class="o">+=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">u64temp</span><span class="o">&gt;&gt;</span><span class="mi">40</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">u64temp</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">u64temp</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">u64temp</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">u64temp</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u64temp</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
			      <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">logical_port</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV</span><span class="p">))</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;nesvnic = %p, reported features = 0x%lX, QPid = %d,&quot;</span>
			<span class="s">&quot; nic_index = %d, logical_port = %d, mac_index = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">logical_port</span><span class="p">,</span>  <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">adapter_fcn_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nes_drv_opt</span> <span class="o">&amp;</span> <span class="n">NES_DRV_OPT_DUAL_LOGICAL_PORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">adapter_fcn_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span>
									<span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span><span class="p">;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">qp_nic_index</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">next_qp_nic_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rdma_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rdma_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">event_timer</span><span class="p">);</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">event_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Adding nesvnic (%p) to the adapters nesvnic_list for MAC%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">netdev_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(((</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">((</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))))))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">link_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">link_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">temp_phy_data</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">phy_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span>
				<span class="p">(</span><span class="mh">0x200</span> <span class="o">*</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00200000</span><span class="p">;</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span>
				<span class="p">(</span><span class="mh">0x200</span> <span class="o">*</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Check and set linkup here.  This is for back to back */</span>
		<span class="cm">/* configuration where second port won&#39;t get link interrupt */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">link_mask</span> <span class="o">=</span> <span class="mh">0x01010000</span><span class="p">;</span>
				<span class="n">link_val</span> <span class="o">=</span> <span class="mh">0x01010000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">link_mask</span> <span class="o">=</span> <span class="mh">0x02020000</span><span class="p">;</span>
				<span class="n">link_val</span> <span class="o">=</span> <span class="mh">0x02020000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_SFP_D</span>:
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					     <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">],</span>
					     <span class="mi">1</span><span class="p">,</span> <span class="mh">0x9003</span><span class="p">);</span>
			<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
			<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					     <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">],</span>
					     <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">);</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
			<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					     <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">],</span>
					     <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">);</span>
			<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_phy_data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">link_mask</span> <span class="o">=</span> <span class="mh">0x0f1f0000</span><span class="p">;</span>
			<span class="n">link_val</span> <span class="o">=</span> <span class="mh">0x0f0f0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					   <span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span>
					   <span class="p">(</span><span class="mh">0x200</span> <span class="o">*</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_SFP_D</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="n">link_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">link_val</span><span class="p">)</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear the MAC interrupt status, assumes direct logical to physical mapping */</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_STATUS</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x200</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">));</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Phy interrupt status = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_STATUS</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x200</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">),</span> <span class="n">u32temp</span><span class="p">);</span>

		<span class="n">nes_init_phy</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nes_vlan_mode</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">netdev</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_netdev_destroy - destroy network device structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_netdev_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* make sure &#39;stop&#39; method is called by Linux stack */</span>
	<span class="cm">/* nes_netdev_stop(netdev); */</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_destroy_ofa_device</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_nic_cm_xmit -- CM calls this to send out pkts</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_nic_cm_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Bad return code from dev_queue_xmit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
