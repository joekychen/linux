<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › nes › nes_cm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nes_cm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 - 2011 Intel Corporation.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#define TCPOPT_TIMESTAMP 8</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/threads.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/neighbour.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/ip_fib.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>

<span class="cp">#include &quot;nes.h&quot;</span>

<span class="n">u32</span> <span class="n">cm_packets_sent</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">cm_packets_bounced</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">cm_packets_dropped</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">cm_packets_retrans</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">cm_packets_created</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">cm_packets_received</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_listens_created</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_listens_destroyed</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">cm_backlog_drops</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_loopbacks</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_nodes_created</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_nodes_destroyed</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_accel_dropped_pkts</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_resets_recvd</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">mini_cm_accelerated</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">mini_cm_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_del_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">mini_cm_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_recv_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_dealloc_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mini_cm_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">form_cm_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">add_ref_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nes_cm_disconn_true</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nes_cm_post_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nes_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abrupt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_disconnect_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">send_mpa_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_mpa_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_syn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_fin</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">active_open_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">passive_open_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_rcv_mpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_retrans_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">handle_tcp_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optionsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">passive</span><span class="p">);</span>

<span class="cm">/* CM event handler functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cm_event_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cm_event_connect_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cm_event_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cm_event_mpa_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cm_event_mpa_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_recv_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rem_node</span><span class="p">);</span>

<span class="cm">/* MPA build functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cm_build_mpa_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">build_mpa_v2</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">build_mpa_v1</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">build_rdma0_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">**</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">print_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">core</span><span class="p">);</span>

<span class="cm">/* External CM API Interface */</span>
<span class="cm">/* instance of function pointers for client API */</span>
<span class="cm">/* set address of this instance to cm_core-&gt;cm_ops at cm_core alloc */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_ops</span> <span class="n">nes_cm_api</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">mini_cm_accelerated</span><span class="p">,</span>
	<span class="n">mini_cm_listen</span><span class="p">,</span>
	<span class="n">mini_cm_del_listen</span><span class="p">,</span>
	<span class="n">mini_cm_connect</span><span class="p">,</span>
	<span class="n">mini_cm_close</span><span class="p">,</span>
	<span class="n">mini_cm_accept</span><span class="p">,</span>
	<span class="n">mini_cm_reject</span><span class="p">,</span>
	<span class="n">mini_cm_recv_pkt</span><span class="p">,</span>
	<span class="n">mini_cm_dealloc_core</span><span class="p">,</span>
	<span class="n">mini_cm_get</span><span class="p">,</span>
	<span class="n">mini_cm_set</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">g_cm_core</span><span class="p">;</span>

<span class="n">atomic_t</span> <span class="n">cm_connects</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_accepts</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_disconnects</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_closes</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_connecteds</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_connect_reqs</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">cm_rejects</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">nes_add_ref_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nes_rem_ref_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * create_event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="nf">create_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span>	<span class="n">cm_node</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">nes_cm_event_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* allocate an empty event */</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span> <span class="o">=</span> <span class="n">cm_node</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node=%p Created event=%p, type=%u, &quot;</span>
		  <span class="s">&quot;dst_addr=%08x[%x], src_addr=%08x[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_node</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span><span class="p">,</span>
		  <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span><span class="p">,</span>
		  <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span><span class="p">);</span>

	<span class="n">nes_cm_post_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * send_mpa_request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_mpa_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">start_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">start_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buff_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;skb set to NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send an MPA Request frame */</span>
	<span class="n">cm_build_mpa_frame</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">start_buff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buff_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MPA_KEY_REQUEST</span><span class="p">);</span>
	<span class="n">form_cm_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">start_buff</span><span class="p">,</span> <span class="n">buff_len</span><span class="p">,</span> <span class="n">SET_ACK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_mpa_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">start_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buff_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ietf_mpa_v1</span> <span class="o">*</span><span class="n">mpa_frame</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_CM_BUFFER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Failed to get a Free pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send an MPA reject frame */</span>
	<span class="n">cm_build_mpa_frame</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">start_buff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buff_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MPA_KEY_REPLY</span><span class="p">);</span>
	<span class="n">mpa_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v1</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">start_buff</span><span class="p">;</span>
	<span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IETF_MPA_FLAGS_REJECT</span><span class="p">;</span>
	<span class="n">form_cm_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">start_buff</span><span class="p">,</span> <span class="n">buff_len</span><span class="p">,</span> <span class="n">SET_ACK</span> <span class="o">|</span> <span class="n">SET_FIN</span><span class="p">);</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * recv_mpa - process a received TCP pkt, we are expecting an</span>
<span class="cm"> * IETF MPA frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_mpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ietf_mpa_v1</span> <span class="o">*</span><span class="n">mpa_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ietf_mpa_v2</span> <span class="o">*</span><span class="n">mpa_v2_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ietf_rtr_msg</span> <span class="o">*</span><span class="n">rtr_msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpa_hdr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priv_data_len</span><span class="p">;</span>

	<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">NES_MPA_REQUEST_ACCEPT</span><span class="p">;</span>

	<span class="cm">/* assume req frame is in tcp data payload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;The received ietf buffer was too small (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* points to the beginning of the frame, which could be MPA V1 or V2 */</span>
	<span class="n">mpa_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v1</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">mpa_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v1</span><span class="p">);</span>
	<span class="n">priv_data_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">priv_data_len</span><span class="p">);</span>

	<span class="cm">/* make sure mpa private data len is less than 512 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv_data_len</span> <span class="o">&gt;</span> <span class="n">IETF_MAX_PRIV_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;The received Length of Private&quot;</span>
			  <span class="s">&quot; Data field exceeds 512 octets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * make sure MPA receiver interoperate with the</span>
<span class="cm">	 * received MPA version and MPA key information</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">IETF_MPA_V1</span> <span class="o">&amp;&amp;</span> <span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">IETF_MPA_V2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;The received mpa version&quot;</span>
			  <span class="s">&quot; is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	* backwards compatibility only</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;The received mpa version&quot;</span>
			<span class="s">&quot; can not be interoperated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span> <span class="o">=</span> <span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">IEFT_MPA_KEY_REQ</span><span class="p">,</span> <span class="n">IETF_MPA_KEY_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unexpected MPA Key received </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">IEFT_MPA_KEY_REP</span><span class="p">,</span> <span class="n">IETF_MPA_KEY_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unexpected MPA Key received </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv_data_len</span> <span class="o">+</span> <span class="n">mpa_hdr_len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;The received ietf buffer was not right&quot;</span>
			<span class="s">&quot; complete (%x + %x != %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv_data_len</span><span class="p">,</span> <span class="n">mpa_hdr_len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* make sure it does not exceed the max size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_CM_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;The received ietf buffer was too large&quot;</span>
			<span class="s">&quot; (%x + %x != %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv_data_len</span><span class="p">,</span> <span class="n">mpa_hdr_len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">=</span> <span class="n">priv_data_len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IETF_MPA_V2</span>: <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ird_size</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ord_size</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rtr_ctrl_ird</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rtr_ctrl_ord</span><span class="p">;</span>

		<span class="n">mpa_v2_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">mpa_hdr_len</span> <span class="o">+=</span> <span class="n">IETF_RTR_MSG_SIZE</span><span class="p">;</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">-=</span> <span class="n">IETF_RTR_MSG_SIZE</span><span class="p">;</span>
		<span class="n">rtr_msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpa_v2_frame</span><span class="o">-&gt;</span><span class="n">rtr_msg</span><span class="p">;</span>

		<span class="cm">/* parse rtr message */</span>
		<span class="n">rtr_ctrl_ird</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">rtr_msg</span><span class="o">-&gt;</span><span class="n">ctrl_ird</span><span class="p">);</span>
		<span class="n">rtr_ctrl_ord</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">rtr_msg</span><span class="o">-&gt;</span><span class="n">ctrl_ord</span><span class="p">);</span>
		<span class="n">ird_size</span> <span class="o">=</span> <span class="n">rtr_ctrl_ird</span> <span class="o">&amp;</span> <span class="n">IETF_NO_IRD_ORD</span><span class="p">;</span>
		<span class="n">ord_size</span> <span class="o">=</span> <span class="n">rtr_ctrl_ord</span> <span class="o">&amp;</span> <span class="n">IETF_NO_IRD_ORD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rtr_ctrl_ird</span> <span class="o">&amp;</span> <span class="n">IETF_PEER_TO_PEER</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* send reset */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* responder */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span> <span class="o">&gt;</span> <span class="n">ird_size</span><span class="p">)</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span> <span class="o">=</span> <span class="n">ird_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* initiator */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span> <span class="o">&gt;</span> <span class="n">ird_size</span><span class="p">)</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span> <span class="o">=</span> <span class="n">ird_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ird_size</span> <span class="o">&lt;</span> <span class="n">ord_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no resources available */</span>
				<span class="cm">/* send terminate message */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtr_ctrl_ord</span> <span class="o">&amp;</span> <span class="n">IETF_RDMA0_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span> <span class="o">=</span> <span class="n">SEND_RDMA_READ_ZERO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtr_ctrl_ord</span> <span class="o">&amp;</span> <span class="n">IETF_RDMA0_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span> <span class="o">=</span> <span class="n">SEND_RDMA_WRITE_ZERO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="cm">/* Not supported RDMA0 operation */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">IETF_MPA_V1</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy entire MPA frame to our cm_node&#39;s frame */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">mpa_hdr_len</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IETF_MPA_FLAGS_REJECT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">NES_MPA_REQUEST_REJECT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * form_cm_frame - get a free packet and build empty frame Use</span>
<span class="cm"> * node info to build.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">form_cm_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="n">u32</span> <span class="n">optionsize</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datasize</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">ethh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">packetsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">);</span>

	<span class="n">packetsize</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcph</span><span class="p">);</span>
	<span class="n">packetsize</span> <span class="o">+=</span> <span class="n">optionsize</span> <span class="o">+</span> <span class="n">datasize</span><span class="p">;</span>

	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcph</span><span class="p">));</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">packetsize</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>

	<span class="n">ethh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">);</span>
	<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">));</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcph</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x800</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_len</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ethh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ethh</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ethh</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x0800</span><span class="p">);</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">IPVERSION</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>           <span class="cm">/* 5 * 4Byte words, IP headr len */</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">packetsize</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="o">++</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_id</span><span class="p">);</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>   <span class="cm">/* IPPROTO_TCP */</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">);</span>

	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">);</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">);</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SET_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_ack_num</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="p">;</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_ack_num</span><span class="p">);</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SET_SYN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span> <span class="o">+=</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SET_FIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SET_RST</span><span class="p">)</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcph</span><span class="p">)</span> <span class="o">+</span> <span class="n">optionsize</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span><span class="p">);</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">urg_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optionsize</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">optionsize</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">optionsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datasize</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">datasize</span><span class="p">);</span>

	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cm_packets_created</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * print_core - dump a cm core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;---------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;CM Core  -- (core = %p )</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;---------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;State         : %u </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Listen Nodes  : %u </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">listen_node_cnt</span><span class="p">));</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Active Nodes  : %u </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">node_cnt</span><span class="p">));</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;core          : %p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;-------------- end core ---------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cm_build_mpa_frame - build a MPA V1 frame or MPA V2 frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cm_build_mpa_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">start_buff</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="o">*</span><span class="n">buff_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pci_mem</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mpa_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">start_buff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_mem</span><span class="p">)</span> <span class="o">?</span> <span class="n">pci_mem</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IETF_MPA_V1</span>:
		<span class="o">*</span><span class="n">start_buff</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">start_buff</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_rtr_msg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">buff_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v1</span><span class="p">)</span> <span class="o">+</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">;</span>
		<span class="n">build_mpa_v1</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="o">*</span><span class="n">start_buff</span><span class="p">,</span> <span class="n">mpa_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IETF_MPA_V2</span>:
		<span class="o">*</span><span class="n">buff_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span><span class="p">)</span> <span class="o">+</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">;</span>
		<span class="n">build_mpa_v2</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="o">*</span><span class="n">start_buff</span><span class="p">,</span> <span class="n">mpa_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * build_mpa_v2 - build a MPA V2 frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_mpa_v2</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mpa_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ietf_mpa_v2</span> <span class="o">*</span><span class="n">mpa_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span> <span class="o">*</span><span class="p">)</span><span class="n">start_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ietf_rtr_msg</span> <span class="o">*</span><span class="n">rtr_msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rtr_msg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl_ird</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl_ord</span><span class="p">;</span>

	<span class="cm">/* initialize the upper 5 bytes of the frame */</span>
	<span class="n">build_mpa_v1</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">mpa_key</span><span class="p">);</span>
	<span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IETF_MPA_V2_FLAG</span><span class="p">;</span> <span class="cm">/* set a bit to indicate MPA V2 */</span>
	<span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">priv_data_len</span> <span class="o">+=</span> <span class="n">htons</span><span class="p">(</span><span class="n">IETF_RTR_MSG_SIZE</span><span class="p">);</span>

	<span class="cm">/* initialize RTR msg */</span>
	<span class="n">ctrl_ird</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ird_size</span> <span class="o">&gt;</span> <span class="n">IETF_NO_IRD_ORD</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">IETF_NO_IRD_ORD</span> <span class="o">:</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ird_size</span><span class="p">;</span>
	<span class="n">ctrl_ord</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span> <span class="o">&gt;</span> <span class="n">IETF_NO_IRD_ORD</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">IETF_NO_IRD_ORD</span> <span class="o">:</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span><span class="p">;</span>

	<span class="n">ctrl_ird</span> <span class="o">|=</span> <span class="n">IETF_PEER_TO_PEER</span><span class="p">;</span>
	<span class="n">ctrl_ird</span> <span class="o">|=</span> <span class="n">IETF_FLPDU_ZERO_LEN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mpa_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_KEY_REQUEST</span>:
		<span class="n">ctrl_ord</span> <span class="o">|=</span> <span class="n">IETF_RDMA0_WRITE</span><span class="p">;</span>
		<span class="n">ctrl_ord</span> <span class="o">|=</span> <span class="n">IETF_RDMA0_READ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_KEY_REPLY</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SEND_RDMA_WRITE_ZERO</span>:
			<span class="n">ctrl_ord</span> <span class="o">|=</span> <span class="n">IETF_RDMA0_WRITE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEND_RDMA_READ_ZERO</span>:
			<span class="n">ctrl_ord</span> <span class="o">|=</span> <span class="n">IETF_RDMA0_READ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtr_msg</span><span class="o">-&gt;</span><span class="n">ctrl_ird</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ctrl_ird</span><span class="p">);</span>
	<span class="n">rtr_msg</span><span class="o">-&gt;</span><span class="n">ctrl_ord</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ctrl_ord</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * build_mpa_v1 - build a MPA V1 frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_mpa_v1</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mpa_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ietf_mpa_v1</span> <span class="o">*</span><span class="n">mpa_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v1</span> <span class="o">*</span><span class="p">)</span><span class="n">start_addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mpa_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_KEY_REQUEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">IEFT_MPA_KEY_REQ</span><span class="p">,</span> <span class="n">IETF_MPA_KEY_SIZE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_KEY_REPLY</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">IEFT_MPA_KEY_REP</span><span class="p">,</span> <span class="n">IETF_MPA_KEY_SIZE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IETF_MPA_FLAGS_CRC</span><span class="p">;</span>
	<span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span><span class="p">;</span>
	<span class="n">mpa_frame</span><span class="o">-&gt;</span><span class="n">priv_data_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_rdma0_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">**</span><span class="n">nesqp_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span> <span class="o">=</span> <span class="o">*</span><span class="n">nesqp_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_qp_wqe</span> <span class="o">*</span><span class="n">wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="n">u64temp</span> <span class="o">|=</span> <span class="n">NES_SW_CONTEXT_ALIGN</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_IWARP_SQ_WQE_COMP_CTX_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_FRAG0_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEND_RDMA_WRITE_ZERO</span>:
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Sending first write.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_IWARP_SQ_OP_RDMAW</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_TOTAL_PAYLOAD_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_LENGTH0_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_STAG0_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEND_RDMA_READ_ZERO</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span> <span class="o">!=</span> <span class="n">SEND_RDMA_READ_ZERO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u]: Unsupported RDMA0 len operation=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Sending first rdma operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_IWARP_SQ_OP_RDMAR</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_RDMA_TO_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_RDMA_TO_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_RDMA_LENGTH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_RDMA_STAG_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_STAG0_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">sq_kmapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">sq_kmapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*use the reserved spot on the WQ for the extra first WQE*/</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">NES_QPCONTEXT_ORDIRD_LSMM_PRESENT</span> <span class="o">|</span>
							     <span class="n">NES_QPCONTEXT_ORDIRD_WRPDU</span> <span class="o">|</span>
							     <span class="n">NES_QPCONTEXT_ORDIRD_ALSMM</span><span class="p">));</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">skip_lsmm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * schedule_nes_timer</span>
<span class="cm"> * note - cm_node needs to be protected before calling this. Encase in:</span>
<span class="cm"> *			rem_ref_cm_node(cm_core, cm_node);add_ref_cm_node(cm_node);</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">schedule_nes_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">nes_timer_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">send_retrans</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">close_when_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_timer_entry</span> <span class="o">*</span><span class="n">new_send</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">was_timer_set</span><span class="p">;</span>

	<span class="n">new_send</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_send</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_send</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* new_send-&gt;timetosend = currenttime */</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">retrycount</span> <span class="o">=</span> <span class="n">NES_DEFAULT_RETRYS</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">retranscount</span> <span class="o">=</span> <span class="n">NES_DEFAULT_RETRANS</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">send_retrans</span> <span class="o">=</span> <span class="n">send_retrans</span><span class="p">;</span>
	<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">close_when_complete</span> <span class="o">=</span> <span class="n">close_when_complete</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NES_TIMER_TYPE_CLOSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">+=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_send</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span> <span class="o">=</span> <span class="n">new_send</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_send</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span> <span class="o">=</span> <span class="n">new_send</span><span class="p">;</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NES_RETRY_TIMEOUT</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">nes_nic_cm_xmit</span><span class="p">(</span><span class="n">new_send</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Error sending packet %p &quot;</span>
				  <span class="s">&quot;(jiffies = %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_send</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="n">new_send</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cm_packets_sent</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_retrans</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">close_when_complete</span><span class="p">)</span>
					<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">was_timer_set</span> <span class="o">=</span> <span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">was_timer_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">new_send</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_retrans_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nes_cm_node_state</span> <span class="n">state</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSING</span>:
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_LAST_ACK</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">create_event</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">NES_CM_EVENT_ABORTED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_recv_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rem_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_timer_entry</span> <span class="o">*</span><span class="n">recv_entry</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">qplockflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recv_entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">)</span><span class="n">recv_entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">qplockflags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u: cm_id = %p, &quot;</span>
				  <span class="s">&quot;refcount = %d: HIT A &quot;</span>
				  <span class="s">&quot;NES_TIMER_TYPE_CLOSE with something &quot;</span>
				  <span class="s">&quot;to do!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">,</span>
				  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">));</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">NES_AEQE_TCP_STATE_CLOSED</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_RESET_SENT</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp_state</span> <span class="o">=</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">qplockflags</span><span class="p">);</span>
			<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">qplockflags</span><span class="p">);</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u: cm_id = %p, &quot;</span>
				  <span class="s">&quot;refcount = %d: HIT A &quot;</span>
				  <span class="s">&quot;NES_TIMER_TYPE_CLOSE with nothing &quot;</span>
				  <span class="s">&quot;to do!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">,</span>
				  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rem_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TIME_WAIT state */</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span>
		<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">recv_entry</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_cm_timer_tick</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_cm_timer_tick</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nexttimeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NES_LONG_TIME</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_timer_entry</span> <span class="o">*</span><span class="n">send_entry</span><span class="p">,</span> <span class="o">*</span><span class="n">recv_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_core_temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span> <span class="o">=</span> <span class="n">g_cm_core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">settimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timetosend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">timer_list</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer_list</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">list_core_temp</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">connected_nodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">timer_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">list_core_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span><span class="p">,</span>
				       <span class="n">timer_entry</span><span class="p">);</span>
		<span class="n">recv_entry</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">recv_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">recv_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nexttimeout</span> <span class="o">&gt;</span> <span class="n">recv_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">settimer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nexttimeout</span> <span class="o">=</span> <span class="n">recv_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">;</span>
					<span class="n">settimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">handle_recv_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">send_entry</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_entry</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">nexttimeout</span> <span class="o">&gt;</span>
					     <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">)</span> <span class="o">||</span>
					    <span class="o">!</span><span class="n">settimer</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">nexttimeout</span> <span class="o">=</span>
							<span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">;</span>
						<span class="n">settimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">free_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">free_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retranscount</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retrycount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cm_packets_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">free_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>

				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">nes_retrans_expired</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span>
						  <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">cm_packets_retrans</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Retransmitting send_entry %p &quot;</span>
				  <span class="s">&quot;for node %p, jiffies = %lu, time to send = &quot;</span>
				  <span class="s">&quot;%lu, retranscount = %u, send_entry-&gt;seq_num = &quot;</span>
				  <span class="s">&quot;0x%08X, cm_node-&gt;tcp_cntxt.rem_ack_num = &quot;</span>
				  <span class="s">&quot;0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">send_entry</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span>
				  <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">,</span>
				  <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retranscount</span><span class="p">,</span>
				  <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">,</span>
				  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rem_ack_num</span><span class="p">);</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span>
					       <span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nes_nic_cm_xmit</span><span class="p">(</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;rexmit failed for &quot;</span>
					  <span class="s">&quot;node=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
				<span class="n">cm_packets_bounced</span><span class="o">++</span><span class="p">;</span>
				<span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retrycount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">nexttimeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NES_SHORT_TIME</span><span class="p">;</span>
				<span class="n">settimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cm_packets_sent</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Packet Sent: retrans count = &quot;</span>
				  <span class="s">&quot;%u, retry count = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retranscount</span><span class="p">,</span>
				  <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retrycount</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">send_retrans</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retranscount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">timetosend</span> <span class="o">=</span> <span class="p">(</span><span class="n">NES_RETRY_TIMEOUT</span> <span class="o">&lt;&lt;</span>
					      <span class="p">(</span><span class="n">NES_DEFAULT_RETRANS</span> <span class="o">-</span> <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">retranscount</span><span class="p">));</span>

				<span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
							 <span class="n">min</span><span class="p">(</span><span class="n">timetosend</span><span class="p">,</span> <span class="n">NES_MAX_TIMEOUT</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nexttimeout</span> <span class="o">&gt;</span> <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">settimer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nexttimeout</span> <span class="o">=</span> <span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">timetosend</span><span class="p">;</span>
					<span class="n">settimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">close_when_complete</span><span class="p">;</span>
				<span class="n">close_when_complete</span> <span class="o">=</span>
					<span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">close_when_complete</span><span class="p">;</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node=%p state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">free_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">close_when_complete</span><span class="p">)</span>
					<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span>
							<span class="n">cm_node</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">settimer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">nexttimeout</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * send_syn</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_syn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sendack</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">SET_SYN</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">optionsbuffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_mss</span><span class="p">)</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_windowscale</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_base</span><span class="p">)</span> <span class="o">+</span>
			   <span class="n">TCP_OPTIONS_PADDING</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">optionssize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Sending MSS option */</span>
	<span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="n">options</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optionsbuffer</span><span class="p">[</span><span class="n">optionssize</span><span class="p">];</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_mss</span><span class="p">.</span><span class="n">optionnum</span> <span class="o">=</span> <span class="n">OPTION_NUMBER_MSS</span><span class="p">;</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_mss</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_mss</span><span class="p">);</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_mss</span><span class="p">.</span><span class="n">mss</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span><span class="p">);</span>
	<span class="n">optionssize</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_mss</span><span class="p">);</span>

	<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optionsbuffer</span><span class="p">[</span><span class="n">optionssize</span><span class="p">];</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_windowscale</span><span class="p">.</span><span class="n">optionnum</span> <span class="o">=</span> <span class="n">OPTION_NUMBER_WINDOW_SCALE</span><span class="p">;</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_windowscale</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_windowscale</span><span class="p">);</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_windowscale</span><span class="p">.</span><span class="n">shiftcount</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span><span class="p">;</span>
	<span class="n">optionssize</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_windowscale</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sendack</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">NES_DRV_OPT_SUPRESS_OPTION_BC</span> <span class="o">&amp;</span> <span class="n">nes_drv_opt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optionsbuffer</span><span class="p">[</span><span class="n">optionssize</span><span class="p">];</span>
		<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_base</span><span class="p">.</span><span class="n">optionnum</span> <span class="o">=</span> <span class="n">OPTION_NUMBER_WRITE0</span><span class="p">;</span>
		<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_base</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_base</span><span class="p">);</span>
		<span class="n">optionssize</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">option_base</span><span class="p">);</span>
		<span class="cm">/* we need the size to be a multiple of 4 */</span>
		<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optionsbuffer</span><span class="p">[</span><span class="n">optionssize</span><span class="p">];</span>
		<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">optionssize</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optionsbuffer</span><span class="p">[</span><span class="n">optionssize</span><span class="p">];</span>
		<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">optionssize</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optionsbuffer</span><span class="p">[</span><span class="n">optionssize</span><span class="p">];</span>
	<span class="n">options</span><span class="o">-&gt;</span><span class="n">as_end</span> <span class="o">=</span> <span class="n">OPTION_NUMBER_END</span><span class="p">;</span>
	<span class="n">optionssize</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_CM_BUFFER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Failed to get a Free pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sendack</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">SET_ACK</span><span class="p">;</span>

	<span class="n">form_cm_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">optionsbuffer</span><span class="p">,</span> <span class="n">optionssize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * send_reset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">SET_RST</span> <span class="o">|</span> <span class="n">SET_ACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_CM_BUFFER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Failed to get a Free pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">form_cm_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * send_ack</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_CM_BUFFER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Failed to get a Free pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">form_cm_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SET_ACK</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * send_fin</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_fin</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* if we didn&#39;t get a frame get one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_CM_BUFFER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Failed to get a Free pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">form_cm_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SET_ACK</span> <span class="o">|</span> <span class="n">SET_FIN</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NES_TIMER_TYPE_SEND</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * find_node - find a cm node that matches the reference cm node</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="nf">find_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">rem_port</span><span class="p">,</span> <span class="n">nes_addr_t</span> <span class="n">rem_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">loc_port</span><span class="p">,</span> <span class="n">nes_addr_t</span> <span class="n">loc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">hte</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>

	<span class="cm">/* get a handle on the hte */</span>
	<span class="n">hte</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">connected_nodes</span><span class="p">;</span>

	<span class="cm">/* walk list and find cm_node associated with this session ID */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">hte</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* compare quad, return node handle if a match */</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;finding node %x:%x =? %x:%x ^ %x:%x =? %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">,</span>
			  <span class="n">loc_addr</span><span class="p">,</span> <span class="n">loc_port</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">,</span>
			  <span class="n">rem_addr</span><span class="p">,</span> <span class="n">rem_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">==</span> <span class="n">loc_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span> <span class="o">==</span> <span class="n">loc_port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span> <span class="o">==</span> <span class="n">rem_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span> <span class="o">==</span> <span class="n">rem_port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">cm_node</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* no owner node */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * find_listener - find a cm node listening on this addr-port pair</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="nf">find_listener</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
					     <span class="n">nes_addr_t</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dst_port</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nes_cm_listener_state</span> <span class="n">listener_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">listen_node</span><span class="p">;</span>

	<span class="cm">/* walk list and find cm_node associated with this session ID */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">listen_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* compare node pair, return node handle if a match */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">listen_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">==</span> <span class="n">dst_addr</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">listen_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">listen_node</span><span class="o">-&gt;</span><span class="n">loc_port</span> <span class="o">==</span> <span class="n">dst_port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">listener_state</span> <span class="o">&amp;</span> <span class="n">listen_node</span><span class="o">-&gt;</span><span class="n">listener_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listen_node</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">listen_node</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* no listener */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * add_hte_node - add a cm node to the hash table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_hte_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">hte</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span> <span class="o">||</span> <span class="o">!</span><span class="n">cm_core</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Adding Node %p to Active Connection HT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_node</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* get a handle on the hash table element (list head for this slot) */</span>
	<span class="n">hte</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">connected_nodes</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">hte</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_node_cnt</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_dec_refcnt_listen</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_dec_refcnt_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="kt">int</span> <span class="n">free_hanging_nodes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">reset_list</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;attempting listener= %p free_nodes= %d, &quot;</span>
		  <span class="s">&quot;refcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">free_hanging_nodes</span><span class="p">,</span>
		  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">));</span>
	<span class="cm">/* free non-accelerated child nodes for this listener */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reset_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_hanging_nodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="n">list_temp</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">connected_nodes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span><span class="p">,</span>
					       <span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span> <span class="o">==</span> <span class="n">listener</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accelerated</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">reset_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset_list</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="n">list_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">list_pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span><span class="p">,</span>
				       <span class="n">reset_entry</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">;</span>
			<span class="k">enum</span> <span class="n">nes_cm_node_state</span> <span class="n">old_state</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NES_CM_STATE_FIN_WAIT1</span> <span class="o">&lt;=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
							<span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
						<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">old_state</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
						<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_LISTENER_DESTROYED</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span><span class="p">)</span>
							<span class="n">rem_ref_cm_node</span><span class="p">(</span>
								<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span>
								<span class="n">cm_node</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="n">event</span><span class="p">;</span>

					<span class="n">event</span><span class="p">.</span><span class="n">cm_node</span> <span class="o">=</span> <span class="n">loopback</span><span class="p">;</span>
					<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span> <span class="o">=</span>
							<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">;</span>
					<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span> <span class="o">=</span>
							<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
					<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span> <span class="o">=</span>
							<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">;</span>
					<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span>
							 <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">;</span>
					<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
					<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">loopback</span><span class="p">);</span>
					<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
					<span class="n">cm_event_connect_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
					<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_LISTENER_DESTROYED</span><span class="p">;</span>

					<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span>
							 <span class="n">cm_node</span><span class="p">);</span>

				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="cm">/* decrement our listen node count */</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_node_cnt</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">)</span>
			<span class="n">nes_manage_apbvt</span><span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">,</span>
					 <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">NES_MANAGE_APBVT_DEL</span><span class="p">);</span>

		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;destroying listener (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">listener</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
		<span class="n">listener</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_listens_destroyed</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;destroying listener (%p)&quot;</span>
				  <span class="s">&quot; with non-zero pending accepts=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">listener</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_del_listen</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_del_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">listener</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">listener_state</span> <span class="o">=</span> <span class="n">NES_CM_LISTENER_PASSIVE_STATE</span><span class="p">;</span>
	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* going to be destroyed pretty soon */</span>
	<span class="k">return</span> <span class="n">mini_cm_dec_refcnt_listen</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_accelerated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mini_cm_accelerated</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">was_timer_set</span><span class="p">;</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accelerated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accept_pend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accept_pend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">was_timer_set</span> <span class="o">=</span> <span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">was_timer_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NES_SHORT_TIME</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_addr_resolve_neigh</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_addr_resolve_neigh</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arpindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">neigh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">arpindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ip_route_output_key failed for 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dst_ip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_is_bond_slave</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">netdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">neigh</span> <span class="o">=</span> <span class="n">dst_neigh_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_ip</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">neigh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">neigh</span><span class="o">-&gt;</span><span class="n">nud_state</span> <span class="o">&amp;</span> <span class="n">NUD_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Neighbor MAC address for 0x%08X&quot;</span>
				  <span class="s">&quot; is %pM, Gateway is 0x%08X </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dst_ip</span><span class="p">,</span>
				  <span class="n">neigh</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">arpindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">arp_table</span><span class="p">[</span><span class="n">arpindex</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">,</span>
					    <span class="n">neigh</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Mac address same as in nes_arp_table */</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">nes_manage_arp_cache</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
						     <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">arp_table</span><span class="p">[</span><span class="n">arpindex</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">,</span>
						     <span class="n">dst_ip</span><span class="p">,</span> <span class="n">NES_ARP_DELETE</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">nes_manage_arp_cache</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">neigh</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">,</span>
					     <span class="n">dst_ip</span><span class="p">,</span> <span class="n">NES_ARP_ADD</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">nes_arp_table</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					   <span class="n">NES_ARP_RESOLVE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">neigh_event_send</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">neigh</span><span class="p">)</span>
		<span class="n">neigh_release</span><span class="p">(</span><span class="n">neigh</span><span class="p">);</span>

	<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * make_cm_node - create a new instance of a cm node</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="nf">make_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="o">*</span><span class="n">cm_info</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">listener</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldarpindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arpindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="cm">/* create an hte and cm_node for this instance */</span>
	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cm_node</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* set our node specific transport info */</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">;</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span> <span class="o">=</span> <span class="n">mpa_version</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_rdma0_op</span> <span class="o">=</span> <span class="n">SEND_RDMA_READ_ZERO</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ird_size</span> <span class="o">=</span> <span class="n">IETF_NO_IRD_ORD</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span> <span class="o">=</span> <span class="n">IETF_NO_IRD_ORD</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Make node addresses : loc = %pI4:%x, rem = %pI4:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span> <span class="o">=</span> <span class="n">listener</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_mac</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;listener=%p, cm_id=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span>
		  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">);</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* associate our parent CM core */</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span> <span class="o">=</span> <span class="n">cm_core</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_id</span> <span class="o">=</span> <span class="n">NES_CM_DEF_LOCAL_ID</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span> <span class="o">=</span> <span class="n">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span> <span class="o">=</span> <span class="n">NES_CM_DEFAULT_RCV_WND_SCALED</span> <span class="o">&gt;&gt;</span>
				     <span class="n">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="n">current_kernel_time</span><span class="p">();</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">-</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)</span> <span class="o">-</span> <span class="n">ETH_HLEN</span> <span class="o">-</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* get a unique session ID , add thread_id to an upcounter to handle race */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">node_cnt</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">conn_type</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">conn_type</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">apbvt_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accept_pend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="p">;</span>
	<span class="cm">/* get some device handles, for arp lookup */</span>
	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* get the mac addr for the remote node */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">htonl</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">arpindex</span> <span class="o">=</span> <span class="n">nes_arp_table</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NES_ARP_RESOLVE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">oldarpindex</span> <span class="o">=</span> <span class="n">nes_arp_table</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NES_ARP_RESOLVE</span><span class="p">);</span>
		<span class="n">arpindex</span> <span class="o">=</span> <span class="n">nes_addr_resolve_neigh</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">,</span> <span class="n">oldarpindex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arpindex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy the mac addr to node context */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_mac</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">arp_table</span><span class="p">[</span><span class="n">arpindex</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Remote mac addr from arp table: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_mac</span><span class="p">);</span>

	<span class="n">add_hte_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_nodes_created</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cm_node</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * add_ref_cm_node - destroy an instance of a cm node</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_ref_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * rem_ref_cm_node - destroy an instance of a cm node</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rem_ref_cm_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_node_cnt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if the node is destroyed before connection was accelerated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accelerated</span> <span class="o">&amp;&amp;</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accept_pend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">recv_entry</span><span class="p">)</span>
		<span class="n">handle_recv_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mini_cm_dec_refcnt_listen</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">apbvt_set</span> <span class="o">&amp;&amp;</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_manage_apbvt</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">,</span>
					 <span class="n">PCI_FUNC</span><span class="p">(</span>
						 <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
					 <span class="n">NES_MANAGE_APBVT_DEL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">node_cnt</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_nodes_destroyed</span><span class="p">);</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nes_rem_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * process_options</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">optionsloc</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">optionsize</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syn_packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="n">all_options</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">got_mss_option</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">optionsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">all_options</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">all_known_options</span> <span class="o">*</span><span class="p">)(</span><span class="n">optionsloc</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_base</span><span class="p">.</span><span class="n">optionnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OPTION_NUMBER_END</span>:
			<span class="n">offset</span> <span class="o">=</span> <span class="n">optionsize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OPTION_NUMBER_NONE</span>:
			<span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OPTION_NUMBER_MSS</span>:
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s: MSS Length: %d Offset: %d &quot;</span>
				  <span class="s">&quot;Size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_mss</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">optionsize</span><span class="p">);</span>
			<span class="n">got_mss_option</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_mss</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_mss</span><span class="p">.</span><span class="n">mss</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;</span>
				    <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span><span class="p">)</span>
					<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OPTION_NUMBER_WINDOW_SCALE</span>:
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wscale</span> <span class="o">=</span>
				<span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_windowscale</span><span class="p">.</span><span class="n">shiftcount</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;TCP Option not understood: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_base</span><span class="p">.</span><span class="n">optionnum</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">all_options</span><span class="o">-&gt;</span><span class="n">as_base</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">got_mss_option</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">syn_packet</span><span class="p">))</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span> <span class="o">=</span> <span class="n">NES_CM_DEFAULT_MSS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drop_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_accel_dropped_pkts</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_fin_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Received FIN, cm_node = %p, state = %u. &quot;</span>
		  <span class="s">&quot;refcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
		  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREJ_RCVD</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_LAST_ACK</span><span class="p">;</span>
		<span class="n">send_fin</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
		<span class="n">create_event</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">NES_CM_EVENT_ABORTED</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSING</span><span class="p">;</span>
		<span class="n">send_ack</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* Wait for ACK as this is simultaneous close..</span>
<span class="cm">		* After we receive ACK, do not send anything..</span>
<span class="cm">		* Just rm the node.. Done.. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_TIME_WAIT</span><span class="p">;</span>
		<span class="n">send_ack</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">NES_TIMER_TYPE_CLOSE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TIME_WAIT</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
	<span class="nl">default:</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Error Rcvd FIN for node-%p state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_rst_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span>	<span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* whether to send reset in case of err.. */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_resets_recvd</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Received Reset, cm_node = %p, state = %u.&quot;</span>
			<span class="s">&quot; refcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">));</span>
	<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s[%u] create abort for cm_node=%p &quot;</span>
			<span class="s">&quot;listener=%p state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IETF_MPA_V2</span>:
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span> <span class="o">=</span> <span class="n">IETF_MPA_V1</span><span class="p">;</span>
			<span class="cm">/* send a syn and goto syn sent state */</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_SYN_SENT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">send_syn</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IETF_MPA_V1</span>:
		<span class="nl">default:</span>
			<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span>:
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">passive_state</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_LISTENING</span>:
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Bad state %s[%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
		<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSED</span>:
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_LAST_ACK</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TIME_WAIT</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_rcv_mpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datasize</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dataloc</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">nes_cm_event_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">NES_CM_EVENT_UNKNOWN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res_type</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_mpa</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">dataloc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_type</span><span class="p">,</span> <span class="n">datasize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;didn&#39;t like MPA Request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s[%u] create abort for &quot;</span>
				  <span class="s">&quot;cm_node=%p listener=%p state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">__LINE__</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span>
				  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">res_type</span> <span class="o">==</span> <span class="n">NES_MPA_REQUEST_REJECT</span><span class="p">)</span>
			<span class="cm">/*BIG problem as we are receiving the MPA.. So should</span>
<span class="cm">			 * not be REJECT.. This is Passive Open.. We can</span>
<span class="cm">			 * only receive it Reject for Active Open...*/</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">NES_CM_EVENT_MPA_REQ</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">passive_state</span><span class="p">,</span>
			   <span class="n">NES_PASSIVE_STATE_INDICATED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_type</span> <span class="o">==</span> <span class="n">NES_MPA_REQUEST_REJECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">NES_CM_EVENT_MPA_REJECT</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_MPAREJ_RCVD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">NES_CM_EVENT_CONNECTED</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">create_event</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">indicate_pkt_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s[%u] create abort for cm_node=%p &quot;</span>
			  <span class="s">&quot;listener=%p state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_RCVD</span>:
		<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
	<span class="nl">default:</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_syn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="p">((</span><span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">)</span> <span class="o">==</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ack_seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loc_seq_num</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv_wnd</span><span class="p">;</span>

	<span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">ack_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
	<span class="n">rcv_wnd</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack_seq</span> <span class="o">!=</span> <span class="n">loc_seq_num</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">between</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rcv_nxt</span><span class="p">,</span> <span class="p">(</span><span class="n">rcv_nxt</span> <span class="o">+</span> <span class="n">rcv_wnd</span><span class="p">)))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s[%u] create abort for cm_node=%p &quot;</span>
			  <span class="s">&quot;listener=%p state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">indicate_pkt_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;seq ERROR cm_node =%p seq=0x%08X &quot;</span>
			  <span class="s">&quot;rcv_nxt=0x%08X rcv_wnd=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">rcv_nxt</span><span class="p">,</span>
			  <span class="n">rcv_wnd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle_syn_pkt() is for Passive node. The syn packet is received when a node</span>
<span class="cm"> * is created with a listener or it may comein as rexmitted packet which in</span>
<span class="cm"> * that case will be just dropped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_syn_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inc_sequence</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">optionsize</span><span class="p">;</span>

	<span class="n">optionsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">inc_sequence</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
		<span class="cm">/* Rcvd syn on active open connection*/</span>
		<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_LISTENING</span>:
		<span class="cm">/* Passive OPEN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;drop syn due to backlog &quot;</span>
				  <span class="s">&quot;pressure </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cm_backlog_drops</span><span class="o">++</span><span class="p">;</span>
			<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_tcp_options</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">optionsize</span><span class="p">,</span>
					 <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* drop pkt */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">inc_sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">accept_pend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">);</span>

		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_SYN_RCVD</span><span class="p">;</span>
		<span class="n">send_syn</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSED</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_LAST_ACK</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSING</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_UNKNOWN</span>:
	<span class="nl">default:</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_synack_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inc_sequence</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">optionsize</span><span class="p">;</span>

	<span class="n">optionsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">inc_sequence</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="cm">/* active open */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_syn</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rem_ack_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
		<span class="cm">/* setup options */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_tcp_options</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">optionsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node=%p tcp_options failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">cm_node</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">inc_sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">send_mpa_request</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span>:
		<span class="cm">/* passive open, so should not be here */</span>
		<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_LISTENING</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSED</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_LAST_ACK</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSING</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_UNKNOWN</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
	<span class="nl">default:</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_ack_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">datasize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inc_sequence</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">optionsize</span><span class="p">;</span>

	<span class="n">optionsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_seq</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">inc_sequence</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">datasize</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_RCVD</span>:
		<span class="cm">/* Passive OPEN */</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_tcp_options</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">optionsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rem_ack_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_ESTABLISHED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">datasize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">inc_sequence</span> <span class="o">+</span> <span class="n">datasize</span><span class="p">;</span>
			<span class="n">handle_rcv_mpa</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* rcvd ACK only */</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
		<span class="cm">/* Passive OPEN */</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">datasize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">inc_sequence</span> <span class="o">+</span> <span class="n">datasize</span><span class="p">;</span>
			<span class="n">handle_rcv_mpa</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rem_ack_num</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">datasize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">inc_sequence</span> <span class="o">+</span> <span class="n">datasize</span><span class="p">;</span>
			<span class="n">handle_rcv_mpa</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Could be just an ack pkt.. */</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_LISTENING</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSED</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_LAST_ACK</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSING</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_UNKNOWN</span>:
	<span class="nl">default:</span>
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_tcp_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optionsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">passive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">optionsloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tcph</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optionsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">process_options</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">optionsloc</span><span class="p">,</span> <span class="n">optionsize</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s: Node %p, Sending RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">passive</span><span class="p">)</span>
				<span class="n">passive_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">active_open_err</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wnd</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				     <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wscale</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wnd</span> <span class="o">&gt;</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">max_snd_wnd</span><span class="p">)</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">max_snd_wnd</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wnd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * active_open_err() will send reset() if flag set..</span>
<span class="cm"> * It will also send ABORT event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">active_open_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;ERROR active err called for cm_node=%p, &quot;</span>
			  <span class="s">&quot;state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
	<span class="n">create_event</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">NES_CM_EVENT_ABORTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * passive_open_err() will either do a reset() or will free up the skb and</span>
<span class="cm"> * remove the cm_node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">passive_open_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;passive_open_err sending RST for &quot;</span>
			  <span class="s">&quot;cm_node=%p state =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * free_retrans_entry() routines assumes that the retrans_list_lock has</span>
<span class="cm"> * been acquired before calling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_retrans_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_timer_entry</span> <span class="o">*</span><span class="n">send_entry</span><span class="p">;</span>

	<span class="n">send_entry</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">send_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">send_entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">send_entry</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_retrans_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">free_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">retrans_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * process_packet</span>
<span class="cm"> * Returns skb if to be freed, else it will return NULL if already used..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">nes_tcpip_pkt_type</span> <span class="n">pkt_type</span> <span class="o">=</span> <span class="n">NES_PKT_TYPE_UNKNOWN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fin_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;process_packet: cm_node=%p state =%d syn=%d &quot;</span>
		  <span class="s">&quot;ack=%d rst=%d fin=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">,</span>
		  <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">,</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">,</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_type</span> <span class="o">=</span> <span class="n">NES_PKT_TYPE_RST</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_type</span> <span class="o">=</span> <span class="n">NES_PKT_TYPE_SYN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span>
			<span class="n">pkt_type</span> <span class="o">=</span> <span class="n">NES_PKT_TYPE_SYNACK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_type</span> <span class="o">=</span> <span class="n">NES_PKT_TYPE_ACK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">)</span>
		<span class="n">fin_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_PKT_TYPE_SYN</span>:
		<span class="n">handle_syn_pkt</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcph</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_PKT_TYPE_SYNACK</span>:
		<span class="n">handle_synack_pkt</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcph</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_PKT_TYPE_ACK</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_ack_pkt</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcph</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fin_set</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">handle_fin_pkt</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_PKT_TYPE_RST</span>:
		<span class="n">handle_rst_pkt</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcph</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fin_set</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">check_seq</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span>
			<span class="n">handle_fin_pkt</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">drop_packet</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mini_cm_listen - create a listen node with params</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="nf">mini_cm_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="o">*</span><span class="n">cm_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">listener</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Search for 0x%08x : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">);</span>

	<span class="cm">/* cannot have multiple matching listeners */</span>
	<span class="n">listener</span> <span class="o">=</span> <span class="n">find_listener</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">),</span>
				 <span class="n">htons</span><span class="p">(</span><span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">),</span> <span class="n">NES_CM_LISTENER_EITHER_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">listener</span> <span class="o">&amp;&amp;</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">listener_state</span> <span class="o">==</span> <span class="n">NES_CM_LISTENER_ACTIVE_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* find automatically incs ref count ??? */</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Not creating listener since it already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* create a CM listen node (1/2 node to compare incoming traffic to) */</span>
		<span class="n">listener</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">listener</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Not creating listener memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">listener</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">);</span>
		<span class="n">listener</span><span class="o">-&gt;</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">);</span>
		<span class="n">listener</span><span class="o">-&gt;</span><span class="n">reused_node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* pasive case */</span>
	<span class="cm">/* find already inc&#39;ed the ref count */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">listener</span><span class="o">-&gt;</span><span class="n">reused_node</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">pend_accepts_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">cm_core</span> <span class="o">=</span> <span class="n">cm_core</span><span class="p">;</span>
	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">node_cnt</span><span class="p">);</span>

	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">conn_type</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">conn_type</span><span class="p">;</span>
	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">backlog</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">;</span>
	<span class="n">listener</span><span class="o">-&gt;</span><span class="n">listener_state</span> <span class="o">=</span> <span class="n">NES_CM_LISTENER_ACTIVE_STATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">reused_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_node_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Api - listen(): addr=0x%08X, port=0x%04x,&quot;</span>
		  <span class="s">&quot; listener = %p, backlog = %d, cm_id = %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">,</span>
		  <span class="n">listener</span><span class="p">,</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">,</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">listener</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_connect - make a connection node with params</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="nf">mini_cm_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">u16</span> <span class="n">private_data_len</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="o">*</span><span class="n">cm_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">loopbackremotelistener</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">loopbackremotenode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="n">loopback_cm_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start_buff</span><span class="p">;</span>

	<span class="cm">/* create a CM connection node */</span>
	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">make_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="n">cm_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* set our node side to client (active) side */</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span> <span class="o">=</span> <span class="n">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">==</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loopbackremotelistener</span> <span class="o">=</span> <span class="n">find_listener</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span>
						       <span class="n">ntohl</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">),</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">,</span>
						       <span class="n">NES_CM_LISTENER_ACTIVE_STATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loopbackremotelistener</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">create_event</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">NES_CM_EVENT_ABORTED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">loopback_cm_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">cm_info</span><span class="p">;</span>
			<span class="n">loopback_cm_info</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">;</span>
			<span class="n">loopback_cm_info</span><span class="p">.</span><span class="n">rem_port</span> <span class="o">=</span> <span class="n">cm_info</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">;</span>
			<span class="n">loopback_cm_info</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">loopbackremotelistener</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span> <span class="o">=</span> <span class="n">make_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">loopback_cm_info</span><span class="p">,</span> <span class="n">loopbackremotelistener</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loopbackremotenode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_loopbacks</span><span class="p">);</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span> <span class="o">=</span> <span class="n">cm_node</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span> <span class="o">=</span>
				<span class="n">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span> <span class="o">=</span> <span class="n">loopbackremotenode</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">,</span> <span class="n">private_data</span><span class="p">,</span>
			       <span class="n">private_data_len</span><span class="p">);</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">=</span> <span class="n">private_data_len</span><span class="p">;</span>

			<span class="cm">/* we are done handling this state. */</span>
			<span class="cm">/* set node to a TSA state */</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span>
				<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span> <span class="o">=</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">max_snd_wnd</span> <span class="o">=</span>
				<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">max_snd_wnd</span> <span class="o">=</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wnd</span> <span class="o">=</span>
				<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wnd</span> <span class="o">=</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span><span class="p">;</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wscale</span> <span class="o">=</span>
				<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wscale</span> <span class="o">=</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span><span class="p">;</span>
			<span class="n">loopbackremotenode</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span><span class="p">;</span>
			<span class="n">create_event</span><span class="p">(</span><span class="n">loopbackremotenode</span><span class="p">,</span> <span class="n">NES_CM_EVENT_MPA_REQ</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">cm_node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">=</span> <span class="n">private_data_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">start_buff</span><span class="p">,</span> <span class="n">private_data</span><span class="p">,</span> <span class="n">private_data_len</span><span class="p">);</span>

	<span class="cm">/* send a syn and goto syn sent state */</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_SYN_SENT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">send_syn</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error in sending the syn free up the cm_node struct */</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Api - connect() FAILED: dest &quot;</span>
			  <span class="s">&quot;addr=0x%08X, port=0x%04x, cm_node=%p, cm_id = %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Api - connect(): dest addr=0x%08X,&quot;</span>
			  <span class="s">&quot;port=0x%04x, cm_node=%p, cm_id = %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cm_node</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_accept - accept a connection</span>
<span class="cm"> * This function is never called</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_reject - reject and teardown a connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">passive_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%s cm_node=%p type=%d state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">__func__</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">passive_state</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">passive_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">passive_state</span> <span class="o">==</span> <span class="n">NES_SEND_RESET_EVENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
			<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_LISTENER_DESTROYED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">send_mpa_reject</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSED</span><span class="p">;</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
						<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_LISTENER_DESTROYED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
			<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">loopback</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">event</span><span class="p">.</span><span class="n">cm_node</span> <span class="o">=</span> <span class="n">loopback</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">rem_port</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">loc_port</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
			<span class="n">cm_event_mpa_reject</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
			<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
			<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_CLOSING</span><span class="p">;</span>

			<span class="n">cm_id</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
			<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">loopback</span><span class="p">);</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_close</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_core</span> <span class="o">||</span> <span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_ONE_SIDE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_ACCEPTING</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_SENT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREQ_RCVD</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSE_WAIT</span>:
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_LAST_ACK</span><span class="p">;</span>
		<span class="n">send_fin</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT1</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_FIN_WAIT2</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_LAST_ACK</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_TIME_WAIT</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSING</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_LISTENING</span>:
		<span class="n">cleanup_retrans_entry</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">send_reset</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_MPAREJ_RCVD</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_UNKNOWN</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_INITED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_CLOSED</span>:
	<span class="k">case</span> <span class="n">NES_CM_STATE_LISTENER_DESTROYED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_STATE_TSA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR Close got called from STATE_TSA &quot;</span>
			       <span class="s">&quot;send_entry=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">send_entry</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * recv_pkt - recv an ETHERNET packet, and process it through CM</span>
<span class="cm"> * node state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_recv_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">listener</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="n">nfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tmp_daddr</span><span class="p">,</span> <span class="n">tmp_saddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">));</span>

	<span class="n">nfo</span><span class="p">.</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">nfo</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>
	<span class="n">nfo</span><span class="p">.</span><span class="n">rem_addr</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
	<span class="n">nfo</span><span class="p">.</span><span class="n">rem_port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>

	<span class="n">tmp_daddr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">tmp_saddr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Received packet: dest=%pI4:0x%04X src=%pI4:0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">tmp_daddr</span><span class="p">,</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_saddr</span><span class="p">,</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cm_node</span> <span class="o">=</span> <span class="n">find_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span>
				    <span class="n">nfo</span><span class="p">.</span><span class="n">rem_port</span><span class="p">,</span> <span class="n">nfo</span><span class="p">.</span><span class="n">rem_addr</span><span class="p">,</span>
				    <span class="n">nfo</span><span class="p">.</span><span class="n">loc_port</span><span class="p">,</span> <span class="n">nfo</span><span class="p">.</span><span class="n">loc_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Only type of packet accepted are for */</span>
			<span class="cm">/* the PASSIVE open (syn only) */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">skb_handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">listener</span> <span class="o">=</span> <span class="n">find_listener</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">nfo</span><span class="p">.</span><span class="n">loc_addr</span><span class="p">,</span>
						 <span class="n">nfo</span><span class="p">.</span><span class="n">loc_port</span><span class="p">,</span>
						 <span class="n">NES_CM_LISTENER_ACTIVE_STATE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nfo</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">nfo</span><span class="p">.</span><span class="n">conn_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unable to find listener for the pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">skb_handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nfo</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
			<span class="n">nfo</span><span class="p">.</span><span class="n">conn_type</span> <span class="o">=</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">conn_type</span><span class="p">;</span>
			<span class="n">cm_node</span> <span class="o">=</span> <span class="n">make_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfo</span><span class="p">,</span>
					       <span class="n">listener</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unable to allocate &quot;</span>
					  <span class="s">&quot;node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">cm_packets_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_LISTENING</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cm_packets_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_mode</span><span class="p">)</span>
				<span class="n">nes_queue_mgt_skbs</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_accel_dropped_pkts</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcph</span><span class="p">));</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>
		<span class="n">process_packet</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cm_core</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb_handled</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_alloc_core - allocate a top level instance of a cm core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="nf">nes_cm_alloc_core</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">;</span>

	<span class="cm">/* setup the CM core */</span>
	<span class="cm">/* alloc top level core control structure */</span>
	<span class="n">cm_core</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cm_core</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_core</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">connected_nodes</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>
	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nes_cm_timer_tick</span><span class="p">;</span>

	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">NES_CM_DEFAULT_MTU</span><span class="p">;</span>
	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_INITED</span><span class="p">;</span>
	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">free_tx_pkt_max</span> <span class="o">=</span> <span class="n">NES_CM_DEFAULT_FREE_PKTS</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">events_posted</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">api</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nes_cm_api</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">ht_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">listen_list</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Init CM Core completed -- cm_core=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_core</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Enable QUEUE EVENTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">event_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;nesewq&quot;</span><span class="p">);</span>
	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">post_event</span> <span class="o">=</span> <span class="n">nes_cm_post_event</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Enable QUEUE DISCONNECTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">disconn_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;nesdwq&quot;</span><span class="p">);</span>

	<span class="n">print_core</span><span class="p">(</span><span class="n">cm_core</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cm_core</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_dealloc_core - deallocate a top level instance of a cm core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_dealloc_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;De-Alloc CM Core (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_core</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_core</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">tcp_timer</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">disconn_wq</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm_core</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_get</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mini_cm_set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mini_cm_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_SET_PKT_SIZE</span>:
		<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_SET_FREE_PKT_Q_SIZE</span>:
		<span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">free_tx_pkt_max</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* unknown set option */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_init_tsa_conn setup HW; MPA frames must be</span>
<span class="cm"> * successfully exchanged when this is called</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_cm_init_tsa_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesqp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_QPCONTEXT_MISC_IPV4</span> <span class="o">|</span>
						  <span class="n">NES_QPCONTEXT_MISC_NO_NAGLE</span> <span class="o">|</span> <span class="n">NES_QPCONTEXT_MISC_DO_NOT_FRAG</span> <span class="o">|</span>
						  <span class="n">NES_QPCONTEXT_MISC_DROS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wscale</span> <span class="o">||</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span><span class="p">)</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_QPCONTEXT_MISC_WSCALE</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="n">NES_QPCONTEXT_MISC2_TTL_SHIFT</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcp_state_flow_label</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">NES_QPCONTEXT_TCPSTATE_EST</span> <span class="o">&lt;&lt;</span> <span class="n">NES_QPCONTEXT_TCPFLOW_TCP_STATE_SHIFT</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">pd_index_wscale</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wscale</span> <span class="o">&lt;&lt;</span> <span class="n">NES_QPCONTEXT_PDWSCALE_SND_WSCALE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">NES_QPCONTEXT_PDWSCALE_SND_WSCALE_MASK</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">pd_index_wscale</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span> <span class="o">&lt;&lt;</span> <span class="n">NES_QPCONTEXT_PDWSCALE_RCV_WSCALE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">NES_QPCONTEXT_PDWSCALE_RCV_WSCALE_MASK</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">keepalive</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ts_recent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ts_age</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_nxt</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_wnd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">snd_wnd</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wnd</span> <span class="o">&lt;&lt;</span>
						    <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_wscale</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_max</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">srtt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rttvar</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x6</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ssthresh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x3FFFC000</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_wl1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">rcv_nxt</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_wl2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">loc_seq_num</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">max_snd_wnd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">max_snd_wnd</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u: rcv_nxt = 0x%08X, snd_nxt = 0x%08X,&quot;</span>
		  <span class="s">&quot; Setting MSS to %u, PDWscale = 0x%08X, rcv_wnd = %u, context misc = 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">),</span>
		  <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">tcp_cntxt</span><span class="p">.</span><span class="n">mss</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">pd_index_wscale</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">));</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;  snd_wnd  = 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_wnd</span><span class="p">));</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;  snd_cwnd = 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">));</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;  max_swnd = 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">max_snd_wnd</span><span class="p">));</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Change cm_node state to TSA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_disconn</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_cm_disconn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">disconn_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>

	<span class="n">work</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>  <span class="cm">/* Timer will clean up */</span>

	<span class="n">nes_add_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">nes_disconnect_worker</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">disconn_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_disconnect_worker</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_disconnect_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">disconn_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">disconn_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">dwork</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dwork</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;processing AEQE id 0x%04X for QP%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="n">nes_cm_disconn_true</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
	<span class="n">nes_rem_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_disconn_true</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_cm_disconn_true</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">last_ae</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">original_hw_tcp_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">original_ibqp_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disconn_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">issue_disconn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">issue_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">issue_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flush_q</span> <span class="o">=</span> <span class="n">NES_CQP_FLUSH_RQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">ibevent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;disconnect_worker nesqp is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cm_id</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="cm">/* make sure we havent already closed this connection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u disconnect_worker cmid is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Disconnecting QP%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">original_hw_tcp_state</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span><span class="p">;</span>
	<span class="n">original_ibqp_state</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp_state</span><span class="p">;</span>
	<span class="n">last_ae</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">issue_disconn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">issue_close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">flush_issued</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">flush_issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">issue_flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">original_hw_tcp_state</span> <span class="o">==</span> <span class="n">NES_AEQE_TCP_STATE_CLOSE_WAIT</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">original_ibqp_state</span> <span class="o">==</span> <span class="n">IB_QPS_RTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">last_ae</span> <span class="o">==</span> <span class="n">NES_AEQE_AEID_LLP_CONNECTION_RESET</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">issue_disconn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_ae</span> <span class="o">==</span> <span class="n">NES_AEQE_AEID_LLP_CONNECTION_RESET</span><span class="p">)</span>
			<span class="n">disconn_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">original_hw_tcp_state</span> <span class="o">==</span> <span class="n">NES_AEQE_TCP_STATE_CLOSED</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">original_hw_tcp_state</span> <span class="o">==</span> <span class="n">NES_AEQE_TCP_STATE_TIME_WAIT</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">last_ae</span> <span class="o">==</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_BAD_LLP_CLOSE</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">last_ae</span> <span class="o">==</span> <span class="n">NES_AEQE_AEID_LLP_CONNECTION_RESET</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">issue_close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">flush_issued</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">flush_issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">issue_flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">issue_flush</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">destroyed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Flush the queue(s) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">&gt;=</span> <span class="n">NES_AEQE_IWARP_STATE_TERMINATE</span><span class="p">)</span>
			<span class="n">flush_q</span> <span class="o">|=</span> <span class="n">NES_CQP_FLUSH_SQ</span><span class="p">;</span>
		<span class="n">flush_wqes</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">flush_q</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ibevent</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
			<span class="n">ibevent</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_eventtype</span><span class="p">;</span>
			<span class="n">ibevent</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">event_handler</span><span class="p">)</span>
				<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">event_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibevent</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">qp_context</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cm_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">issue_disconn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_disconnects</span><span class="p">);</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_DISCONNECT</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">disconn_status</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Generating a CM Disconnect Event&quot;</span>
				  <span class="s">&quot; for  QP%u, SQ Head = %u, SQ Tail = %u. &quot;</span>
				  <span class="s">&quot;cm_id = %p, refcount = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">,</span>
				  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">,</span>
				  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">));</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;OFA CM event_handler &quot;</span>
					  <span class="s">&quot;returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">issue_close</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_closes</span><span class="p">);</span>
			<span class="n">nes_disconnect</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
			<span class="cm">/* Send up the close complete event */</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CLOSE</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;OFA CM event_handler returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_disconnect</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abrupt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_ib_device</span> <span class="o">*</span><span class="n">nesibdev</span><span class="p">;</span>

	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesvnic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">nesibdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;netdev refcnt = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev_refcnt_read</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">active_conn</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* indicate this connection is NOT active */</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">active_conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Need to free the Last Streaming Mode Message */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lsmm_mr</span><span class="p">)</span>
				<span class="n">nesibdev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dereg_mr</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lsmm_mr</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">private_data_len</span> <span class="o">+</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_size</span><span class="p">,</span>
					    <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_pbase</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* close the CM node down if it is still active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Call close API</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_accept</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_qp_wqe</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_v4_quad</span> <span class="n">nes_quad</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">passive_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_ib_device</span> <span class="o">*</span><span class="n">nesibdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ibmr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="n">ibphysbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_pd</span> <span class="o">*</span><span class="n">nespd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tagged_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mpa_frame_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ietf_mpa_v2</span> <span class="o">*</span><span class="n">mpa_v2_frame</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">start_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buff_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ibqp</span> <span class="o">=</span> <span class="n">nes_get_qp</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibqp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* get all our handles */</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="n">to_nesqp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="n">cm_node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;nes_accept: cm_node= %p nesvnic=%p, netdev=%p,&quot;</span>
		<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NES_CM_STATE_LISTENER_DESTROYED</span> <span class="o">==</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">)</span>
			<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">);</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">passive_state</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">passive_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">passive_state</span> <span class="o">==</span> <span class="n">NES_SEND_RESET_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* associate the node with the QP */</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u, cm_node=%p, jiffies = %lu listener = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_accepts</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;netdev refcnt = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev_refcnt_read</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">));</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span><span class="p">);</span>
	<span class="cm">/* allocate the ietf frame and space for private data */</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						 <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_size</span> <span class="o">+</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_pbase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for private data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpa_v2_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span> <span class="o">*</span><span class="p">)</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_rev</span> <span class="o">==</span> <span class="n">IETF_MPA_V1</span><span class="p">)</span>
		<span class="n">mpa_frame_offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa_v2_frame</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
	       <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">);</span>

	<span class="n">cm_build_mpa_frame</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">start_buff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buff_len</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span><span class="p">,</span> <span class="n">MPA_KEY_REPLY</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">;</span>

	<span class="cm">/* setup our first outgoing iWarp send WQE (the IETF frame response) */</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span>
	    <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesqp</span><span class="p">;</span>
		<span class="n">nesibdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesibdev</span><span class="p">;</span>
		<span class="n">nespd</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nespd</span><span class="p">;</span>
		<span class="n">ibphysbuf</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_pbase</span> <span class="o">+</span> <span class="n">mpa_frame_offset</span><span class="p">;</span>
		<span class="n">ibphysbuf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">buff_len</span><span class="p">;</span>
		<span class="n">tagged_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">start_buff</span><span class="p">;</span>
		<span class="n">ibmr</span> <span class="o">=</span> <span class="n">nesibdev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">reg_phys_mr</span><span class="p">((</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="p">)</span><span class="n">nespd</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">ibphysbuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						   <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">tagged_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibmr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unable to register memory region&quot;</span>
				  <span class="s">&quot;for lSMM for cm_node = %p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">cm_node</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">private_data_len</span> <span class="o">+</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_size</span><span class="p">,</span>
					    <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame_pbase</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ibmr</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nespd</span><span class="o">-&gt;</span><span class="n">ibpd</span><span class="p">;</span>
		<span class="n">ibmr</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">nespd</span><span class="o">-&gt;</span><span class="n">ibpd</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lsmm_mr</span> <span class="o">=</span> <span class="n">ibmr</span><span class="p">;</span>

		<span class="n">u64temp</span> <span class="o">|=</span> <span class="n">NES_SW_CONTEXT_ALIGN</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span>
				    <span class="n">NES_IWARP_SQ_WQE_COMP_CTX_LOW_IDX</span><span class="p">,</span>
				    <span class="n">u64temp</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_IWARP_SQ_WQE_STREAMING</span> <span class="o">|</span>
				    <span class="n">NES_IWARP_SQ_WQE_WRPDU</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_TOTAL_PAYLOAD_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buff_len</span><span class="p">);</span>
		<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span>
				    <span class="n">NES_IWARP_SQ_WQE_FRAG0_LOW_IDX</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="n">start_buff</span><span class="p">));</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_LENGTH0_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buff_len</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_IWARP_SQ_WQE_STAG0_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibmr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">sq_kmapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">sq_kmapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kunmap</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_QPCONTEXT_ORDIRD_LSMM_PRESENT</span> <span class="o">|</span>
				    <span class="n">NES_QPCONTEXT_ORDIRD_WRPDU</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_QPCONTEXT_ORDIRD_WRPDU</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">skip_lsmm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/* Cache the cm_id in the qp */</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>

	<span class="cm">/*  nesqp-&gt;cm_node = (void *)cm_id-&gt;provider_data; */</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">active_conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">)</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Already state = TSA for cm_node=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cm_node</span><span class="p">);</span>

	<span class="n">nes_cm_init_tsa_conn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcpPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcpPorts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">))</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">NES_QPCONTEXT_MISC2_SRC_IP_SHIFT</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">arp_index_vlan</span> <span class="o">|=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nes_arp_table</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="n">NES_ARP_RESOLVE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ts_val_delta</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="n">jiffies</span> <span class="o">-</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TCP_NOW</span><span class="p">));</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NES_QPCONTEXT_ORDIRD_IWARP_MODE_SHIFT</span><span class="p">));</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nes_quad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nes_quad</span><span class="p">));</span>
	<span class="n">nes_quad</span><span class="p">.</span><span class="n">DstIpAdrIndex</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">))</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">SrcIpadr</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">SrcIpadr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">nes_quad</span><span class="p">.</span><span class="n">TcpPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">nes_quad</span><span class="p">.</span><span class="n">TcpPorts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>

	<span class="cm">/* Produce hash key */</span>
	<span class="n">crc_value</span> <span class="o">=</span> <span class="n">get_crc_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nes_quad</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">crc_value</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;HTE Index = 0x%08X, CRC = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">&amp;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span><span class="p">);</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">accelerated</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u, Destination IP = 0x%08X:0x%04X, local = &quot;</span>
		  <span class="s">&quot;0x%08X:0x%04X, rcv_nxt=0x%08X, snd_nxt=0x%08X, mpa + &quot;</span>
		  <span class="s">&quot;private data length=%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
		  <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
		  <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">),</span>
		  <span class="n">buff_len</span><span class="p">);</span>

	<span class="cm">/* notify OF layer that accept event was successful */</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">nes_add_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">);</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_ESTABLISHED</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_RTS</span><span class="p">;</span>
	<span class="n">nes_modify_qp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">IB_QP_STATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">=</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">;</span>
		<span class="cm">/* copy entire MPA frame to our cm_node&#39;s frame */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">,</span>
		       <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">);</span>
		<span class="n">create_event</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">,</span> <span class="n">NES_CM_EVENT_CONNECTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u] OFA CM event_handler returned, &quot;</span>
		       <span class="s">&quot;ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_reject</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pdata_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">loopback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start_buff</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_rejects</span><span class="p">);</span>
	<span class="n">cm_node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">loopback</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">loopbackpartner</span><span class="p">;</span>
	<span class="n">cm_core</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_CM_BUFFER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loopback</span><span class="o">-&gt;</span><span class="n">mpa_frame</span><span class="p">.</span><span class="n">priv_data</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">pdata_len</span><span class="p">);</span>
		<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">mpa_frame</span><span class="p">.</span><span class="n">priv_data_len</span> <span class="o">=</span> <span class="n">pdata_len</span><span class="p">;</span>
		<span class="n">loopback</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">=</span> <span class="n">pdata_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">start_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ietf_mpa_v2</span><span class="p">);</span>
		<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span> <span class="o">=</span> <span class="n">pdata_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">start_buff</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">pdata_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">reject</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_connect</span>
<span class="cm"> * setup and launch cm connect node</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="n">cm_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">apbvt_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ibqp</span> <span class="o">=</span> <span class="n">nes_get_qp</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibqp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="n">to_nesqp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesqp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesvnic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u, current IP = 0x%08X, Destination IP = &quot;</span>
		  <span class="s">&quot;0x%08X:0x%04X, local = 0x%08X:0x%04X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">),</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
		  <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
		  <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connects</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">active_conn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* cache the cm_id in the qp */</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>
	<span class="cm">/* space for rdma0 read msg */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;requested ord = 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;mpa private data len =%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span>
	    <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_manage_apbvt</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
				 <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">NES_MANAGE_APBVT_ADD</span><span class="p">);</span>
		<span class="n">apbvt_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up the connection params for the node */</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">conn_type</span> <span class="o">=</span> <span class="n">NES_CM_IWARP_CONN_TYPE</span><span class="p">;</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="cm">/* create a connect CM node connection */</span>
	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span>
					  <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">cm_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apbvt_set</span><span class="p">)</span>
			<span class="n">nes_manage_apbvt</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
					 <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
					 <span class="n">NES_MANAGE_APBVT_DEL</span><span class="p">);</span>

		<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">apbvt_set</span> <span class="o">=</span> <span class="n">apbvt_set</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span> <span class="o">=</span> <span class="n">cm_node</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
	<span class="n">nes_add_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_create_listen</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_create_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_listener</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_info</span> <span class="n">cm_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_id = %p, local port = 0x%04X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesvnic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;nesvnic=%p, netdev=%p, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;nesvnic-&gt;local_ipaddr=0x%08x, sin_addr.s_addr=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">,</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>

	<span class="cm">/* setup listen params in our api call struct */</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">;</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>

	<span class="n">cm_info</span><span class="p">.</span><span class="n">conn_type</span> <span class="o">=</span> <span class="n">NES_CM_IWARP_CONN_TYPE</span><span class="p">;</span>


	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">listen</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u] Error returned from listen API call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">reused_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nes_manage_apbvt</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span>
				       <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
				       <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				       <span class="n">NES_MANAGE_APBVT_ADD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;nes_manage_apbvt call returned %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err</span><span class="p">);</span>
			<span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">stop_listener</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_node</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_listens_created</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_node</span><span class="p">;</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_destroy_listen</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_destroy_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">)</span>
		<span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">stop_listener</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">,</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_id-&gt;provider_data was NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_recv</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_cm_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cm_packets_received</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">g_cm_core</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">recv_pkt</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">,</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdevice</span><span class="p">),</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Unable to process packet for CM,&quot;</span>
			  <span class="s">&quot; cm is not setup properly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_start</span>
<span class="cm"> * Start and init a cm core module</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_cm_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* create the primary CM core, pass this handle to subsequent core inits */</span>
	<span class="n">g_cm_core</span> <span class="o">=</span> <span class="n">nes_cm_alloc_core</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g_cm_core</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_stop</span>
<span class="cm"> * stop and dealloc all cm core instances</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_cm_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">g_cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">destroy_cm_core</span><span class="p">(</span><span class="n">g_cm_core</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cm_event_connected</span>
<span class="cm"> * handle a connected event, setup QPs and HW</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_event_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_v4_quad</span> <span class="n">nes_quad</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* get all our handles */</span>
	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_event_connected - %p - cm_id = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">);</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">destroyed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connecteds</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;QP%u attempting to connect to  0x%08X:0x%04X on&quot;</span>
		  <span class="s">&quot; local port 0x%04X. jiffies = %lu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
		  <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		  <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		  <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">nes_cm_init_tsa_conn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>

	<span class="cm">/* set the QP tsa context */</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcpPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcpPorts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">))</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">NES_QPCONTEXT_MISC2_SRC_IP_SHIFT</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">arp_index_vlan</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">nes_arp_table</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span><span class="p">),</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="n">NES_ARP_RESOLVE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ts_val_delta</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">jiffies</span> <span class="o">-</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TCP_NOW</span><span class="p">));</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ird_ord_sizes</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
			<span class="n">NES_QPCONTEXT_ORDIRD_IWARP_MODE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Adjust tail for not having a LSMM */</span>
	<span class="cm">/*nesqp-&gt;hwqp.sq_tail = 1;*/</span>

	<span class="n">build_rdma0_msg</span><span class="p">(</span><span class="n">cm_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="p">);</span>

	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_WQE_ALLOC</span><span class="p">,</span>
		    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00800000</span> <span class="o">|</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nes_quad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nes_quad</span><span class="p">));</span>

	<span class="n">nes_quad</span><span class="p">.</span><span class="n">DstIpAdrIndex</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">))</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">SrcIpadr</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">local_ipaddr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">SrcIpadr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">nes_quad</span><span class="p">.</span><span class="n">TcpPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">nes_quad</span><span class="p">.</span><span class="n">TcpPorts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>

	<span class="cm">/* Produce hash key */</span>
	<span class="n">crc_value</span> <span class="o">=</span> <span class="n">get_crc_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nes_quad</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">crc_value</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;HTE Index = 0x%08X, After CRC = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">&amp;</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">&amp;=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ietf_frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">;</span>
	<span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">accelerated</span><span class="p">(</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">cm_node</span><span class="p">);</span>

	<span class="cm">/* notify OF layer we successfully created the requested connection */</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REPLY</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ird_size</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span><span class="p">;</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;OFA CM event_handler returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u] OFA CM event_handler returned, &quot;</span>
		       <span class="s">&quot;ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_RTS</span><span class="p">;</span>
	<span class="n">nes_modify_qp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">IB_QP_STATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Exiting connect thread for QP%u. jiffies = &quot;</span>
		  <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cm_event_connect_error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_event_connect_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="cm">/* struct nes_cm_info cm_info; */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cm_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node=%p, cm_id=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">);</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesqp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* notify OF layer about this connection error event */</span>
	<span class="cm">/* cm_id-&gt;rem_ref(cm_id); */</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REPLY</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;call CM_EVENT REJECTED, local_addr=%08x, &quot;</span>
		  <span class="s">&quot;remove_addr=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
		  <span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;OFA CM event_handler returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u] OFA CM event_handler returned, &quot;</span>
		       <span class="s">&quot;ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cm_event_reset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_event_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="cm">/* struct nes_cm_info cm_info; */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cm_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;%p - cm_id = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">);</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesqp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* cm_id-&gt;provider_data = NULL; */</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_DISCONNECT</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_closes</span><span class="p">);</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CLOSE</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;NODE %p Generating CLOSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;OFA CM event_handler returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>


	<span class="cm">/* notify OF layer about this connection error event */</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cm_event_mpa_req</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_event_mpa_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>

	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connect_reqs</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node = %p - cm_id = %p, jiffies = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REQUEST</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cm_node</span><span class="p">;</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span><span class="p">);</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span><span class="p">);</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span><span class="p">);</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span><span class="p">);</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ird_size</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">ord_size</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u] OFA CM event_handler returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_event_mpa_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">cm_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cm_node</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_connect_reqs</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node = %p - cm_id = %p, jiffies = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_node</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REPLY</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_port</span><span class="p">);</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">loc_addr</span><span class="p">);</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_port</span><span class="p">);</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">rem_addr</span><span class="p">);</span>

	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_buf</span><span class="p">;</span>
	<span class="n">cm_event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">mpa_frame_size</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;call CM_EVENT_MPA_REJECTED, local_addr=%08x, &quot;</span>
		  <span class="s">&quot;remove_addr=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cm_event</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
		  <span class="n">cm_event</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s[%u] OFA CM event_handler returned, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_cm_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nes_cm_post_event</span>
<span class="cm"> * post an event to the cm event handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_cm_post_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">events_posted</span><span class="p">);</span>
	<span class="n">add_ref_cm_node</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">nes_cm_event_handler</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node=%p queue_work, event=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_cm_event_handler</span>
<span class="cm"> * worker function to handle cm events</span>
<span class="cm"> * will free instance of nes_cm_event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_cm_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cm_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cm_event</span><span class="p">,</span>
						  <span class="n">event_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_cm_core</span> <span class="o">*</span><span class="n">cm_core</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">event</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cm_core</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_core</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;event=%p, event-&gt;type=%u, events posted=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">event</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">events_posted</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_CM_EVENT_MPA_REQ</span>:
		<span class="n">cm_event_mpa_req</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node=%p CM Event: MPA REQUEST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_EVENT_RESET</span>:
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;cm_node = %p CM Event: RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">cm_event_reset</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_EVENT_CONNECTED</span>:
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cm_event_connected</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;CM Event: CONNECTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_EVENT_MPA_REJECT</span>:
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cm_event_mpa_reject</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;CM Event: REJECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NES_CM_EVENT_ABORTED</span>:
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NES_CM_STATE_TSA</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cm_event_connect_error</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;CM Event: ABORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_CM_EVENT_DROPPED_PKT</span>:
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;CM Event: DROPPED PKT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CM</span><span class="p">,</span> <span class="s">&quot;CM Event: UNKNOWN EVENT TYPE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_core</span><span class="o">-&gt;</span><span class="n">events_posted</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_info</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">rem_ref_cm_node</span><span class="p">(</span><span class="n">cm_core</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
