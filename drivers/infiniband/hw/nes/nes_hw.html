<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › nes › nes_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nes_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 - 2011 Intel Corporation.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/inet_lro.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;nes.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nes_lro_max_aggr</span> <span class="o">=</span> <span class="n">NES_LRO_MAX_AGGR</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nes_lro_max_aggr</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nes_lro_max_aggr</span><span class="p">,</span> <span class="s">&quot;NIC LRO max packet aggregation&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wide_ppm_offset</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wide_ppm_offset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wide_ppm_offset</span><span class="p">,</span> <span class="s">&quot;Increase CX4 interface clock ppm offset, 0=100ppm (default), 1=300ppm&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">crit_err_count</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_timer_init</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_256</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_128</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_32</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_24</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_16</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_4</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">int_mod_cq_depth_1</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">nes_max_critical_error_count</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="cp">#include &quot;nes_cm.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_cqp_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_init_csr_ne020</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hw_rev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nes_init_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hw_rev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_count</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span><span class="p">,</span> <span class="n">u8</span>  <span class="n">OneG_Mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_nic_napi_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_nic_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_process_aeq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_aeq</span> <span class="o">*</span><span class="n">aeq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_process_ceq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_ceq</span> <span class="o">*</span><span class="n">ceq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_process_iwarp_aeqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="o">*</span><span class="n">aeqe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_critical_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_process_mac_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mac_number</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nes_reset_adapter_ne020</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">OneG_Mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_terminate_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nes_terminate_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INFINIBAND_NES_DEBUG</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nes_iwarp_state_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Non-Existent&quot;</span><span class="p">,</span>
	<span class="s">&quot;Idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;RTS&quot;</span><span class="p">,</span>
	<span class="s">&quot;Closing&quot;</span><span class="p">,</span>
	<span class="s">&quot;RSVD1&quot;</span><span class="p">,</span>
	<span class="s">&quot;Terminate&quot;</span><span class="p">,</span>
	<span class="s">&quot;Error&quot;</span><span class="p">,</span>
	<span class="s">&quot;RSVD2&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nes_tcp_state_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Non-Existent&quot;</span><span class="p">,</span>
	<span class="s">&quot;Closed&quot;</span><span class="p">,</span>
	<span class="s">&quot;Listen&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYN Sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYN Rcvd&quot;</span><span class="p">,</span>
	<span class="s">&quot;Established&quot;</span><span class="p">,</span>
	<span class="s">&quot;Close Wait&quot;</span><span class="p">,</span>
	<span class="s">&quot;FIN Wait 1&quot;</span><span class="p">,</span>
	<span class="s">&quot;Closing&quot;</span><span class="p">,</span>
	<span class="s">&quot;Last Ack&quot;</span><span class="p">,</span>
	<span class="s">&quot;FIN Wait 2&quot;</span><span class="p">,</span>
	<span class="s">&quot;Time Wait&quot;</span><span class="p">,</span>
	<span class="s">&quot;RSVD1&quot;</span><span class="p">,</span>
	<span class="s">&quot;RSVD2&quot;</span><span class="p">,</span>
	<span class="s">&quot;RSVD3&quot;</span><span class="p">,</span>
	<span class="s">&quot;RSVD4&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cm_node</span> <span class="o">*</span><span class="n">cm_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rem_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rem_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cm_node</span><span class="o">-&gt;</span><span class="n">rem_addr</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Remote IP addr: %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rem_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_nic_init_timer_defaults</span>
<span class="cm"> */</span>
<span class="kt">void</span>  <span class="nf">nes_nic_init_timer_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">jumbomode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_tune_timer</span> <span class="o">*</span><span class="n">shared_timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">tune_timer</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_min</span> <span class="o">=</span> <span class="n">NES_NIC_FAST_TIMER_LOW</span><span class="p">;</span>
	<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_max</span> <span class="o">=</span> <span class="n">NES_NIC_FAST_TIMER_HIGH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jumbomode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span>    <span class="o">=</span> <span class="n">DEFAULT_JUMBO_NES_QL_LOW</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_target</span> <span class="o">=</span> <span class="n">DEFAULT_JUMBO_NES_QL_TARGET</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span>   <span class="o">=</span> <span class="n">DEFAULT_JUMBO_NES_QL_HIGH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span>    <span class="o">=</span> <span class="n">DEFAULT_NES_QL_LOW</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_target</span> <span class="o">=</span> <span class="n">DEFAULT_NES_QL_TARGET</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span>   <span class="o">=</span> <span class="n">DEFAULT_NES_QL_HIGH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* todo use netdev-&gt;mtu to set thresholds */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_nic_init_timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="nf">nes_nic_init_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_tune_timer</span> <span class="o">*</span><span class="n">shared_timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">tune_timer</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_old</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">deepcq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">=</span> <span class="n">NES_NIC_FAST_TIMER</span><span class="p">;</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">!=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use_old</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span><span class="p">;</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_PERIODIC_CONTROL</span><span class="p">,</span>
			<span class="mh">0x80000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="cm">/* todo use netdev-&gt;mtu to set thresholds */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_nic_tune_timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_nic_tune_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_tune_timer</span> <span class="o">*</span><span class="n">shared_timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">tune_timer</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cq_count</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">cq_count_old</span> <span class="o">&lt;=</span> <span class="n">cq_count</span><span class="p">)</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">cq_direction_downward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">cq_direction_downward</span><span class="o">++</span><span class="p">;</span>
	<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">cq_count_old</span> <span class="o">=</span> <span class="n">cq_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">cq_direction_downward</span> <span class="o">&gt;</span> <span class="n">NES_NIC_CQ_DOWNWARD_TREND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq_count</span> <span class="o">&lt;=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span> <span class="o">&amp;&amp;</span>
		    <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">cq_direction_downward</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">deepcq_count</span> <span class="o">+=</span> <span class="n">cq_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq_count</span> <span class="o">&lt;=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span><span class="p">)</span> <span class="p">{</span>       <span class="cm">/* increase timer gently */</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span><span class="o">++</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cq_count</span> <span class="o">&lt;=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_target</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* balanced */</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cq_count</span> <span class="o">&lt;=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* decrease timer gently */</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span><span class="o">++</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cq_count</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>  <span class="cm">/* using history */</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* using history */</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">-=</span> <span class="mi">4</span> <span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_downward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_direction_upward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* boundary checking */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">&gt;</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span><span class="p">)</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_high</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">&lt;</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span><span class="p">)</span>
		<span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">timer_in_use</span> <span class="o">=</span> <span class="n">shared_timer</span><span class="o">-&gt;</span><span class="n">threshold_low</span><span class="p">;</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_adapter - initialize adapter</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="nf">nes_init_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hw_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_pds</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_count</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_rq_wrs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_sq_wrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_mr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_256pbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_4kpbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_qp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_irrq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_cq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hte_index_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adapter_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arp_table_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">OneG_Mode</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">func_index</span><span class="p">;</span>

	<span class="cm">/* search the list of existing adapters */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nes_adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Searching Adapter list for PCI devfn = 0x%X,&quot;</span>
				<span class="s">&quot; adapter PCI slot/bus = %u/%u, pci devices PCI slot/bus = %u/%u, .</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">bus_number</span><span class="p">,</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">bus_number</span> <span class="o">==</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">nesadapter</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no adapter found */</span>
	<span class="n">num_pds</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">BAR_1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;NE020 driver detected unknown hardware revision 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hw_rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Determine Soft Reset, QP_control=0x%x, CPU0=0x%x, CPU1=0x%x, CPU2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_QP_CONTROL</span> <span class="o">+</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_INT_CPU_STATUS</span><span class="p">),</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_INT_CPU_STATUS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_INT_CPU_STATUS</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Reset and init NE020</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">port_count</span> <span class="o">=</span> <span class="n">nes_reset_adapter_ne020</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OneG_Mode</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">max_qp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_QP_CTX_SIZE</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;QP_CTX_SIZE=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_qp</span><span class="p">);</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_QUAD_HASH_TABLE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_qp</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x001f</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Reducing Max QPs to %u due to hash table size = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">max_qp</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">max_qp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x001f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hte_index_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x001f</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Max QP = %u, hte_index_mask = 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">max_qp</span><span class="p">,</span> <span class="n">hte_index_mask</span><span class="p">);</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_IRRQ_COUNT</span><span class="p">);</span>

	<span class="n">max_irrq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x001f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_qp</span> <span class="o">&gt;</span> <span class="n">max_irrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_qp</span> <span class="o">=</span> <span class="n">max_irrq</span><span class="p">;</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Reducing Max QPs to %u due to Available Q1s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">max_qp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* there should be no reason to allocate more pds than qps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_pds</span> <span class="o">&gt;</span> <span class="n">max_qp</span><span class="p">)</span>
		<span class="n">num_pds</span> <span class="o">=</span> <span class="n">max_qp</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MRT_SIZE</span><span class="p">);</span>
	<span class="n">max_mr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PBL_REGION_SIZE</span><span class="p">);</span>
	<span class="n">max_256pbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">);</span>
	<span class="n">max_4kpbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">u32temp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">);</span>
	<span class="n">max_cq</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_CQ_CTX_SIZE</span><span class="p">);</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ARP_CACHE_SIZE</span><span class="p">);</span>
	<span class="n">arp_table_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">adapter_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_adapter</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">adapter_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">max_qp</span><span class="p">);</span>
	<span class="n">adapter_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">max_mr</span><span class="p">);</span>
	<span class="n">adapter_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">max_cq</span><span class="p">);</span>
	<span class="n">adapter_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">num_pds</span><span class="p">);</span>
	<span class="n">adapter_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">arp_table_size</span><span class="p">);</span>
	<span class="n">adapter_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">**</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_qp</span><span class="p">;</span>

	<span class="cm">/* allocate a new adapter struct */</span>
	<span class="n">nesadapter</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">adapter_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Allocating new nesadapter @ %p, size = %u (actual size = %u).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesadapter</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_adapter</span><span class="p">),</span> <span class="n">adapter_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nes_read_eeprom_values</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unable to read EEPROM data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_addr_high</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_addr_low</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span>
				 <span class="n">PCI_DEVICE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">vendor_part_id</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nes_init_serdes</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">hw_rev</span><span class="p">,</span> <span class="n">port_count</span><span class="p">,</span> <span class="n">nesadapter</span><span class="p">,</span>
							<span class="n">OneG_Mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nes_init_csr_ne020</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">hw_rev</span><span class="p">,</span> <span class="n">port_count</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
	       <span class="k">sizeof</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pft_mcast_map</span><span class="p">);</span>

	<span class="cm">/* populate the new nesadapter */</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">bus_number</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_req</span> <span class="o">=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span> <span class="o">=</span> <span class="n">OneG_Mode</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">doorbell_start</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">doorbell_region</span><span class="p">;</span>

	<span class="cm">/* nesadapter-&gt;tick_delta = clk_divisor; */</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">=</span> <span class="n">hw_rev</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">=</span> <span class="n">port_count</span><span class="p">;</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_qp</span> <span class="o">=</span> <span class="n">max_qp</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span> <span class="o">=</span> <span class="n">hte_index_mask</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_irrq</span> <span class="o">=</span> <span class="n">max_irrq</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_mr</span> <span class="o">=</span> <span class="n">max_mr</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_256pbl</span> <span class="o">=</span> <span class="n">max_256pbl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_4kpbl</span> <span class="o">=</span> <span class="n">max_4kpbl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_cq</span> <span class="o">=</span> <span class="n">max_cq</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">free_256pbl</span> <span class="o">=</span> <span class="n">max_256pbl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">free_4kpbl</span> <span class="o">=</span> <span class="n">max_4kpbl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_pd</span> <span class="o">=</span> <span class="n">num_pds</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">arp_table_size</span> <span class="o">=</span> <span class="n">arp_table_size</span><span class="p">;</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_pkt_rate_low</span> <span class="o">=</span> <span class="n">NES_TIMER_ENABLE_LIMIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nes_drv_opt</span> <span class="o">&amp;</span> <span class="n">NES_DRV_OPT_DISABLE_INT_MOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_limit</span> <span class="o">=</span> <span class="n">NES_TIMER_INT_LIMIT</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">interrupt_mod_interval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_limit</span> <span class="o">=</span> <span class="n">NES_TIMER_INT_LIMIT_DYNAMIC</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: Using Adaptive Interrupt Moderation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Setup and enable the periodic timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="p">)</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_PERIODIC_CONTROL</span><span class="p">,</span> <span class="mh">0x80000000</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_PERIODIC_CONTROL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">base_pd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">=</span> <span class="n">IB_DEVICE_LOCAL_DMA_LKEY</span> <span class="o">|</span>
				       <span class="n">IB_DEVICE_MEM_WINDOW</span> <span class="o">|</span>
				       <span class="n">IB_DEVICE_MEM_MGT_EXTENSIONS</span><span class="p">;</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_qps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nesadapter</span><span class="p">)</span>
			<span class="p">[(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_adapter</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))]);</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_cqs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_qps</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">max_qp</span><span class="p">)];</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_mrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_cqs</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">max_cq</span><span class="p">)];</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_pds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_mrs</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">max_mr</span><span class="p">)];</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_arps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_pds</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">num_pds</span><span class="p">)];</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">qp_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_arps</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">arp_table_size</span><span class="p">)]);</span>


	<span class="cm">/* mark the usual suspect QPs, MR and CQs as in use */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">u32temp</span> <span class="o">&lt;</span> <span class="n">NES_FIRST_QPN</span><span class="p">;</span> <span class="n">u32temp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">u32temp</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_qps</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">u32temp</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_cqs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_mrs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">u32temp</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">u32temp</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">u32temp</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_pds</span><span class="p">);</span>
	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_QP_MAX_CFG_SIZES</span><span class="p">);</span>

	<span class="n">max_rq_wrs</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">max_rq_wrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">max_rq_wrs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">max_rq_wrs</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">max_rq_wrs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">max_rq_wrs</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_sq_wrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">max_sq_wrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">max_sq_wrs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">max_sq_wrs</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">max_sq_wrs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">max_sq_wrs</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_qp_wr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_rq_wrs</span><span class="p">,</span> <span class="n">max_sq_wrs</span><span class="p">);</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_irrq_wr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_sge</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_cqe</span> <span class="o">=</span> <span class="mi">32766</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nes_read_eeprom_values</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unable to read EEPROM data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TCP_TIMER_CONFIG</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TCP_TIMER_CONFIG</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">tcp_timer_core_clk_divisor</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">));</span>

	<span class="cm">/* setup port configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">log_port</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nes_drv_opt</span> <span class="o">&amp;</span> <span class="n">NES_DRV_OPT_DUAL_LOGICAL_PORT</span><span class="p">)</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TX_POOL_SIZE</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TX_POOL_SIZE</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">log_port</span> <span class="o">=</span> <span class="mh">0x000000D8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">log_port</span> <span class="o">=</span> <span class="mh">0x00000044</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">log_port</span> <span class="o">=</span> <span class="mh">0x000000e4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_TX_POOL_SIZE</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_LOGPORT_TO_PHYPORT</span><span class="p">,</span>
						<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">log_port</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Probe time, LOG2PHY=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_NIC_LOGPORT_TO_PHYPORT</span><span class="p">));</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">pbl_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">periodic_timer_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pcs_control_status0</span><span class="p">,</span> <span class="n">pcs_control_status1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">reset_value</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">int_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">ext_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pcs_control_status0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span><span class="p">);</span>
		<span class="n">pcs_control_status1</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NES_MAX_LINK_CHECK</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcs_control_status0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span><span class="p">);</span>
			<span class="n">pcs_control_status1</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="mh">0x0F000100</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status0</span> <span class="o">&amp;</span> <span class="mh">0x0F000100</span><span class="p">))</span>
			    <span class="o">||</span> <span class="p">(</span><span class="mh">0x0F000100</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status1</span> <span class="o">&amp;</span> <span class="mh">0x0F000100</span><span class="p">)))</span>
				<span class="n">int_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="mh">0x0000F0C8</span><span class="p">);</span>
			<span class="n">mh_detected</span><span class="o">++</span><span class="p">;</span>
			<span class="n">reset_value</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">);</span>
			<span class="n">reset_value</span> <span class="o">|=</span> <span class="mh">0x0000003d</span><span class="p">;</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">,</span> <span class="n">reset_value</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">pcs_control_status0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span><span class="p">);</span>
			<span class="n">pcs_control_status1</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NES_MAX_LINK_CHECK</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pcs_control_status0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span><span class="p">);</span>
				<span class="n">pcs_control_status1</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="mh">0x0F000100</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status0</span> <span class="o">&amp;</span> <span class="mh">0x0F000100</span><span class="p">))</span>
					<span class="o">||</span> <span class="p">(</span><span class="mh">0x0F000100</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status1</span> <span class="o">&amp;</span> <span class="mh">0x0F000100</span><span class="p">)))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ext_cnt</span> <span class="o">&gt;</span> <span class="n">int_cnt</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span>
								<span class="mh">0x0000F088</span><span class="p">);</span>
						<span class="n">mh_detected</span><span class="o">++</span><span class="p">;</span>
						<span class="n">reset_value</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">);</span>
						<span class="n">reset_value</span> <span class="o">|=</span> <span class="mh">0x0000003d</span><span class="p">;</span>
						<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">,</span> <span class="n">reset_value</span><span class="p">);</span>

						<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span>
							<span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">));</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="n">NE020_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mh_timer</span><span class="p">);</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mh_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nes_mh_fix</span><span class="p">;</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mh_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">5</span><span class="p">);</span>  <span class="cm">/* 1 second */</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mh_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesdev</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mh_timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_STAT</span><span class="p">,</span> <span class="mh">0x0f000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">lc_timer</span><span class="p">);</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">lc_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nes_clc</span><span class="p">;</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">lc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>  <span class="cm">/* 1 hour */</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">lc_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">lc_timer</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nes_adapter_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">func_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">func_index</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">func_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
					<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
					<span class="n">func_index</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;%s %d functions found for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">func_index</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">));</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">adapter_fcn_count</span> <span class="o">=</span> <span class="n">func_index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nesadapter</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_reset_adapter_ne020</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">nes_reset_adapter_ne020</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">OneG_Mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">port_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">);</span>
	<span class="n">port_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x00000300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* TODO: assuming that both SERDES are set the same for now */</span>
	<span class="o">*</span><span class="n">OneG_Mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32temp</span> <span class="o">&amp;</span> <span class="mh">0x00003c00</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Initial Software Reset = 0x%08X, port_count=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">u32temp</span><span class="p">,</span> <span class="n">port_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OneG_Mode</span><span class="p">)</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Running in 1G mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">u32temp</span> <span class="o">&amp;=</span> <span class="mh">0xff00ffc0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00ee0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00cc0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check and do full reset if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_QP_CONTROL</span><span class="o">+</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Issuing Full Soft reset = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u32temp</span> <span class="o">|</span> <span class="mh">0xd</span><span class="p">);</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">,</span> <span class="n">u32temp</span> <span class="o">|</span> <span class="mh">0xd</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Did not see full soft reset done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_INT_CPU_STATUS</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Internal CPU not ready, status = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_INT_CPU_STATUS</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* port reset */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00ee0010</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00cc0030</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x00000030</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Issuing Port Soft reset = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u32temp</span> <span class="o">|</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">,</span> <span class="n">u32temp</span> <span class="o">|</span> <span class="mh">0xd</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Did not see port soft reset done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* serdes 0 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">u32temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_STATUS0</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Serdes 0 not ready, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* serdes 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(((</span><span class="n">u32temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_STATUS1</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Serdes 1 not ready, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">port_count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_serdes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_init_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hw_rev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_count</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span><span class="p">,</span> <span class="n">u8</span>  <span class="n">OneG_Mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* init serdes 0 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_CX4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wide_ppm_offset</span><span class="p">)</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span><span class="p">,</span> <span class="mh">0x000FFFAA</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span><span class="p">,</span> <span class="mh">0x000000FF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_KR</span>:
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span><span class="p">,</span> <span class="mh">0x000000FF</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_EMP0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span>:
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span><span class="p">,</span> <span class="mh">0x000000FF</span><span class="p">);</span>
			<span class="n">sds</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL0</span><span class="p">);</span>
			<span class="n">sds</span> <span class="o">|=</span> <span class="mh">0x00000100</span><span class="p">;</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL0</span><span class="p">,</span> <span class="n">sds</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span><span class="p">,</span> <span class="mh">0x000000FF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OneG_Mode</span><span class="p">)</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_HIGHZ_LANE_MODE0</span><span class="p">,</span> <span class="mh">0x11110000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* init serdes 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">OneG_Mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">)))</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL1</span><span class="p">,</span> <span class="mh">0x000000FF</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_ARGUS</span>:
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_SFP_D</span>:
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_EMP0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_EMP1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_CX4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wide_ppm_offset</span><span class="p">)</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL1</span><span class="p">,</span> <span class="mh">0x000FFFAA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_KR</span>:
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_EMP1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span>:
			<span class="n">sds</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">);</span>
			<span class="n">sds</span> <span class="o">|=</span> <span class="mh">0x000000100</span><span class="p">;</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="n">sds</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_HIGHZ_LANE_MODE1</span><span class="p">,</span> <span class="mh">0x11110000</span><span class="p">);</span>
			<span class="n">sds</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">);</span>
			<span class="n">sds</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFBF</span><span class="p">;</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="n">sds</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* init serdes 0 */</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL0</span><span class="p">,</span> <span class="mh">0x00000008</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(((</span><span class="n">u32temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_STATUS0</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;Init: serdes 0 not ready, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_EMP0</span><span class="p">,</span> <span class="mh">0x000bdef7</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_DRIVE0</span><span class="p">,</span> <span class="mh">0x9ce73000</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_MODE0</span><span class="p">,</span> <span class="mh">0x0ff00000</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_SIGDET0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_BYPASS0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_LOOPBACK_CONTROL0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">OneG_Mode</span><span class="p">)</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_EQ_CONTROL0</span><span class="p">,</span> <span class="mh">0xf0182222</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_EQ_CONTROL0</span><span class="p">,</span> <span class="mh">0xf0042222</span><span class="p">);</span>

		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span><span class="p">,</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* init serdes 1 */</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="mh">0x00000048</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(((</span><span class="n">u32temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_STATUS1</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x0000000f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">))</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Init: serdes 1 not ready, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
				<span class="cm">/* return 1; */</span>
			<span class="p">}</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_EMP1</span><span class="p">,</span> <span class="mh">0x000bdef7</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_TX_DRIVE1</span><span class="p">,</span> <span class="mh">0x9ce73000</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_MODE1</span><span class="p">,</span> <span class="mh">0x0ff00000</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_SIGDET1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_BYPASS1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_LOOPBACK_CONTROL1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_RX_EQ_CONTROL1</span><span class="p">,</span> <span class="mh">0xf0002222</span><span class="p">);</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL1</span><span class="p">,</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_csr_ne020</span>
<span class="cm"> * Initialize registers for ne020 hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_init_csr_ne020</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hw_rev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;port_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_count</span><span class="p">);</span>

	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000001E4</span><span class="p">,</span> <span class="mh">0x00000007</span><span class="p">);</span>
	<span class="cm">/* nes_write_indexed(nesdev, 0x000001E8, 0x000208C4); */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000001E8</span><span class="p">,</span> <span class="mh">0x00020874</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000001D8</span><span class="p">,</span> <span class="mh">0x00048002</span><span class="p">);</span>
	<span class="cm">/* nes_write_indexed(nesdev, 0x000001D8, 0x0004B002); */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000001FC</span><span class="p">,</span> <span class="mh">0x00050005</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00000600</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00000604</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>

	<span class="cm">/* TODO: move these MAC register settings to NIC bringup */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002000</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002004</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002008</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000200C</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002010</span><span class="p">,</span> <span class="mh">0x000003c1</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000201C</span><span class="p">,</span> <span class="mh">0x75345678</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002200</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002204</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002208</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000220C</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002210</span><span class="p">,</span> <span class="mh">0x000003c1</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000221C</span><span class="p">,</span> <span class="mh">0x75345678</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00000908</span><span class="p">,</span> <span class="mh">0x20000001</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002400</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002404</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002408</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000240C</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002410</span><span class="p">,</span> <span class="mh">0x000003c1</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000241C</span><span class="p">,</span> <span class="mh">0x75345678</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00000910</span><span class="p">,</span> <span class="mh">0x20000001</span><span class="p">);</span>

		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002600</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002604</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002608</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000260C</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00002610</span><span class="p">,</span> <span class="mh">0x000003c1</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x0000261C</span><span class="p">,</span> <span class="mh">0x75345678</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00000918</span><span class="p">,</span> <span class="mh">0x20000001</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00005000</span><span class="p">,</span> <span class="mh">0x00018000</span><span class="p">);</span>
	<span class="cm">/* nes_write_indexed(nesdev, 0x00005000, 0x00010000); */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_WQM_CONFIG1</span><span class="p">,</span> <span class="p">(</span><span class="n">wqm_quanta</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
							 <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00005008</span><span class="p">,</span> <span class="mh">0x1F1F1F1F</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00005010</span><span class="p">,</span> <span class="mh">0x1F1F1F1F</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00005018</span><span class="p">,</span> <span class="mh">0x1F1F1F1F</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00005020</span><span class="p">,</span> <span class="mh">0x1F1F1F1F</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00006090</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* TODO: move this to code, get from EEPROM */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x00000900</span><span class="p">,</span> <span class="mh">0x20000001</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000060C0</span><span class="p">,</span> <span class="mh">0x0000028e</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000060C8</span><span class="p">,</span> <span class="mh">0x00000020</span><span class="p">);</span>

	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000001EC</span><span class="p">,</span> <span class="mh">0x7b2625a0</span><span class="p">);</span>
	<span class="cm">/* nes_write_indexed(nesdev, 0x000001EC, 0x5f2625a0); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000008e8</span><span class="p">);</span>
		<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000008e8</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000021f8</span><span class="p">);</span>
		<span class="n">u32temp</span> <span class="o">&amp;=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
		<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x7fff0010</span><span class="p">;</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000021f8</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000023f8</span><span class="p">);</span>
			<span class="n">u32temp</span> <span class="o">&amp;=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
			<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x7fff0010</span><span class="p">;</span>
			<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x000023f8</span><span class="p">,</span> <span class="n">u32temp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_destroy_adapter - destroy the adapter structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_destroy_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">tmp_adapter</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nes_adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;Nes Adapter list entry = 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tmp_adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="n">NE020_REV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mh_timer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">lc_timer</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_cqp</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_init_cqp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_qp_context</span> <span class="o">*</span><span class="n">cqp_qp_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_ceq</span> <span class="o">*</span><span class="n">ceq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_ceq</span> <span class="o">*</span><span class="n">nic_ceq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_aeq</span> <span class="o">*</span><span class="n">aeq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vmem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="cm">/* allocate CQP memory */</span>
	<span class="cm">/* Need to add max_cq to the aeq size once cq overflow checking is added back */</span>
	<span class="cm">/* SQ is 512 byte aligned, others are 256 byte aligned */</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">+</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">NES_CQP_SQ_SIZE</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">NES_CCQ_SIZE</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">max</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_ceqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">NES_CCEQ_SIZE</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">256</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">max</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_ceqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">NES_NIC_CEQ_SIZE</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">256</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_aeqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqp_qp_context</span><span class="p">);</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for host descriptor rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">);</span>

	<span class="cm">/* Allocate a twice the number of CQP requests as the SQ size */</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nes_cqp_requests</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_cqp_request</span><span class="p">)</span> <span class="o">*</span>
			<span class="mi">2</span> <span class="o">*</span> <span class="n">NES_CQP_SQ_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nes_cqp_requests</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory CQP request entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">,</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_pbase</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Allocated CQP structures at %p (phys = %016lX), size = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pbase</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>

	<span class="cm">/* Setup Various Structures */</span>
	<span class="n">vmem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">pmem</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pbase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span> <span class="o">=</span> <span class="n">NES_CQP_SQ_SIZE</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">);</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">);</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">=</span> <span class="n">NES_CCQ_SIZE</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">ce_handler</span> <span class="o">=</span> <span class="n">nes_cqp_ce_handler</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_size</span><span class="p">);</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_size</span><span class="p">);</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">ceq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ceq</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span><span class="p">];</span>
	<span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span> <span class="o">=</span> <span class="n">NES_CCEQ_SIZE</span><span class="p">;</span>
	<span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vmem</span> <span class="o">+=</span> <span class="n">max</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_ceqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">256</span><span class="p">);</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="n">max</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_ceqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">256</span><span class="p">);</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">nic_ceq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ceq</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span><span class="p">];</span>
	<span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span> <span class="o">=</span> <span class="n">NES_NIC_CEQ_SIZE</span><span class="p">;</span>
	<span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vmem</span> <span class="o">+=</span> <span class="n">max</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_ceqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">256</span><span class="p">);</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="n">max</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_ceqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">256</span><span class="p">);</span>

	<span class="n">aeq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">aeq</span><span class="p">[</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)];</span>
	<span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_size</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">;</span>
	<span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup QP Context */</span>
	<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_aeqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_size</span><span class="p">);</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_aeqe</span><span class="p">)</span> <span class="o">*</span> <span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_size</span><span class="p">);</span>

	<span class="n">cqp_qp_context</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">cqp_qp_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">cqp_qp_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqp_qp_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_pbase</span><span class="p">);</span>
	<span class="n">cqp_qp_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_pbase</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>


	<span class="cm">/* Write the address to Create CQP */</span>
	<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_CREATE_CQP_HIGH</span> <span class="o">+</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
				<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pmem</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="n">NES_IDX_CREATE_CQP_HIGH</span> <span class="o">+</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_CREATE_CQP_LOW</span> <span class="o">+</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pmem</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_avail_reqs</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pending_reqs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">NES_CQP_SQ_SIZE</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nes_cqp_requests</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">waitq</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nes_cqp_requests</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_avail_reqs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Write Create CCQ WQE */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
			<span class="p">(</span><span class="n">NES_CQP_CREATE_CQ</span> <span class="o">|</span> <span class="n">NES_CQP_CQ_CEQ_VALID</span> <span class="o">|</span>
			<span class="n">NES_CQP_CQ_CHK_OVERFLOW</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">|</span>
			     <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_pbase</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CQ_WQE_PBL_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">;</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_LOW_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64temp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">33</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_DOORBELL_INDEX_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Write Create CEQ WQE */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">NES_CQP_CREATE_CEQ</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CEQ_WQE_ELEMENT_COUNT_IDX</span><span class="p">,</span> <span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">);</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_pbase</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CQ_WQE_PBL_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

	<span class="cm">/* Write Create AEQ WQE */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
			<span class="p">(</span><span class="n">NES_CQP_CREATE_AEQ</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_AEQ_WQE_ELEMENT_COUNT_IDX</span><span class="p">,</span> <span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_size</span><span class="p">);</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_pbase</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CQ_WQE_PBL_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

	<span class="cm">/* Write Create NIC CEQ WQE */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
			<span class="p">(</span><span class="n">NES_CQP_CREATE_CEQ</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CEQ_WQE_ELEMENT_COUNT_IDX</span><span class="p">,</span> <span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">);</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nic_ceq</span><span class="o">-&gt;</span><span class="n">ceq_pbase</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CQ_WQE_PBL_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

	<span class="cm">/* Poll until CCQP done */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Error creating CQP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">,</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pbase</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_QP_CONTROL</span> <span class="o">+</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;CQP Status = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_QP_CONTROL</span><span class="o">+</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>

	<span class="n">u32temp</span> <span class="o">=</span> <span class="mh">0x04800000</span><span class="p">;</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="n">u32temp</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="cm">/* wait for the CCQ, CEQ, and AEQ to get created */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Error creating CCQ, CEQ, and AEQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">,</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_vbase</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pbase</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_QP_CONTROL</span><span class="o">+</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">15</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">15</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)));</span>

	<span class="cm">/* dump the QP status value */</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;QP Status = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_QP_CONTROL</span><span class="o">+</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_destroy_cqp</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_destroy_cqp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">==</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">));</span>

	<span class="cm">/* Reset CCQ */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">NES_CQE_ALLOC_RESET</span> <span class="o">|</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_number</span><span class="p">);</span>

	<span class="cm">/* Disable device interrupts */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Destroy the AEQ */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_DESTROY_AEQ</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_COMP_CTX_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Destroy the NIC CEQ */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_DESTROY_CEQ</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Destroy the CEQ */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_DESTROY_CEQ</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Destroy the CCQ */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_DESTROY_CQ</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ccq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* Destroy CQP */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_DESTROY_QP</span> <span class="o">|</span>
			<span class="n">NES_CQP_QP_TYPE_CQP</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">barrier</span><span class="p">();</span>
	<span class="cm">/* Ring doorbell (5 WQEs) */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="mh">0x05800000</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* wait for the CCQ, CEQ, and AEQ to get destroyed */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Function%d: Error destroying CCQ, CEQ, and AEQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_QP_CONTROL</span> <span class="o">+</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* dump the QP status value */</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;Function%d: QP Status = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_QP_CONTROL</span><span class="o">+</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nes_cqp_requests</span><span class="p">);</span>

	<span class="cm">/* Free the control structures */</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_mem_size</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">,</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_pbase</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_1g_phy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_init_1g_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0xb000</span><span class="p">);</span>

	<span class="cm">/* Reset the PHY */</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="cm">/* Setting no phy loopback */</span>
	<span class="n">phy_data</span> <span class="o">&amp;=</span> <span class="mh">0xbfff</span><span class="p">;</span>
	<span class="n">phy_data</span> <span class="o">|=</span> <span class="mh">0x1140</span><span class="p">;</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span>  <span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>

	<span class="cm">/* Setting the interrupt mask */</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0xffee</span><span class="p">);</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>

	<span class="cm">/* turning on flow control */</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03E0</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0xc00</span><span class="p">);</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>

	<span class="cm">/* Clear Half duplex */</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">phy_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">));</span>
	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>

	<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">nes_write_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">phy_data</span> <span class="o">|</span> <span class="mh">0x0300</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_2025_phy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_init_2025_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp_phy_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_phy_data2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sds</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_attempt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check firmware heartbeat */</span>
	<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xd7ee</span><span class="p">);</span>
	<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xd7ee</span><span class="p">);</span>
	<span class="n">temp_phy_data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_phy_data</span> <span class="o">!=</span> <span class="n">temp_phy_data2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xd7fd</span><span class="p">);</span>
		<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp_phy_data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;Reinitialize external PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* no heartbeat, configure the PHY */</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc300</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc316</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc318</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_PHY_TYPE_ARGUS</span>:
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc316</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc318</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc302</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc319</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc31a</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0E00</span><span class="p">);</span>

		<span class="cm">/* setup LEDs */</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd006</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd007</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd008</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NES_PHY_TYPE_SFP_D</span>:
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc316</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc318</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc302</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc319</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc31a</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0E00</span><span class="p">);</span>

		<span class="cm">/* setup LEDs */</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd006</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd007</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd008</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NES_PHY_TYPE_KR</span>:
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc316</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc318</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc302</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc319</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc31a</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0E00</span><span class="p">);</span>

		<span class="cm">/* setup LEDs */</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd006</span><span class="p">,</span> <span class="mh">0x000B</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd007</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd008</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>

		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x406D</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0xA528</span><span class="p">);</span>

	<span class="cm">/* Bring PHY out of reset */</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc300</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>

	<span class="cm">/* Check for heartbeat */</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">690</span><span class="p">);</span>
	<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xd7ee</span><span class="p">);</span>
	<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;No PHY heartbeat</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xd7ee</span><span class="p">);</span>
		<span class="n">temp_phy_data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">temp_phy_data2</span> <span class="o">==</span> <span class="n">temp_phy_data</span><span class="p">));</span>

	<span class="cm">/* wait for tracking */</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xd7fd</span><span class="p">);</span>
		<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">temp_phy_data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">first_attempt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">first_attempt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* reset AMCC PHY and try again */</span>
				<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xe854</span><span class="p">,</span> <span class="mh">0x00c0</span><span class="p">);</span>
				<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xe854</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">temp_phy_data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="cm">/* setup signal integrity */</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xd003</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xF00D</span><span class="p">,</span> <span class="mh">0x00FE</span><span class="p">);</span>
	<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xF00E</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_KR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xF00F</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xF00F</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
		<span class="n">nes_write_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc314</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset serdes */</span>
	<span class="n">sds</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL0</span> <span class="o">+</span> <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="n">sds</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL0</span> <span class="o">+</span> <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">sds</span><span class="p">);</span>
	<span class="n">sds</span> <span class="o">&amp;=</span> <span class="mh">0xfffffffe</span><span class="p">;</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL0</span> <span class="o">+</span> <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">sds</span><span class="p">);</span>

	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000040</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_phy</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">phy_type</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">phy_index</span> <span class="o">=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx_config</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_TX_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_1G</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* setup 1G MDIO operation */</span>
		<span class="n">tx_config</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFE3</span><span class="p">;</span>
		<span class="n">tx_config</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* setup 10G MDIO operation */</span>
		<span class="n">tx_config</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFE3</span><span class="p">;</span>
		<span class="n">tx_config</span> <span class="o">|=</span> <span class="mh">0x1D</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_TX_CONFIG</span><span class="p">,</span> <span class="n">tx_config</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_PHY_TYPE_1G</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nes_init_1g_phy</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_PHY_TYPE_ARGUS</span>:
	<span class="k">case</span> <span class="n">NES_PHY_TYPE_SFP_D</span>:
	<span class="k">case</span> <span class="n">NES_PHY_TYPE_KR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nes_init_2025_phy</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_replenish_nic_rq</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_replenish_nic_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span> <span class="o">*</span><span class="n">nic_rqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic</span> <span class="o">*</span><span class="n">nesnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_wqes_posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nesnic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">replenishing_rq</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 1/2 second */</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">replenishing_rq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

			<span class="n">bus_address</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">bus_address</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>

			<span class="n">nic_rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_vbase</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_head</span><span class="p">];</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_1_0_IDX</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_3_2_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_LOW_IDX</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">bus_address</span><span class="p">);</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">bus_address</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
			<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_head</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_head</span> <span class="o">&amp;=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">);</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rx_wqes_posted</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">rx_wqes_posted</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">qp_id</span><span class="p">);</span>
				<span class="n">rx_wqes_posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 1/2 second */</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">));</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_wqes_posted</span><span class="p">)</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">rx_wqes_posted</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">replenishing_rq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_rq_wqes_timeout</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_rq_wqes_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="p">)</span><span class="n">parm</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Timer fired.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span>
		<span class="n">nes_replenish_nic_rq</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_lro_get_skb_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">iphdr</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">**</span><span class="n">tcph</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">hdr_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ip_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ip_len</span> <span class="o">=</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ip_len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="o">*</span><span class="n">hdr_flags</span> <span class="o">=</span> <span class="n">LRO_IPV4</span> <span class="o">|</span> <span class="n">LRO_TCP</span><span class="p">;</span>
	<span class="o">*</span><span class="n">iphdr</span> <span class="o">=</span> <span class="n">iph</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_init_nic_qp</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_init_nic_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span> <span class="o">*</span><span class="n">nic_sqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_qp_context</span> <span class="o">*</span><span class="n">nic_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span> <span class="o">*</span><span class="n">nic_rqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vmem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">counter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wqe_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">jumbomode</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate fragment, SQ, RQ, and CQ; Reuse CEQ based on the PCI function */</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_mem_size</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_first_frag</span><span class="p">))</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span><span class="p">))</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span><span class="p">))</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_cqe</span><span class="p">))</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_qp_context</span><span class="p">);</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_mem_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_pbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for NIC host descriptor rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_mem_size</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Allocated NIC QP structures at %p (phys = %016lX), size = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_pbase</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_mem_size</span><span class="p">);</span>

	<span class="n">vmem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">pmem</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_pbase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Setup the first Fragment buffers */</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">first_frag_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">NES_NIC_WQ_SIZE</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">frag_paddr</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
		<span class="n">pmem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_first_frag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup the SQ */</span>
	<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_first_frag</span><span class="p">));</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_vbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vmem</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_size</span> <span class="o">=</span> <span class="n">NES_NIC_WQ_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">NES_NIC_WQ_SIZE</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic_sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">counter</span><span class="p">];</span>
		<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_NIC_SQ_WQE_DISABLE_CHKSUM</span> <span class="o">|</span>
				<span class="n">NES_NIC_SQ_WQE_COMPLETION</span><span class="p">);</span>
		<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_LENGTH_0_TAG_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">NES_FIRST_FRAG_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">frag_paddr</span><span class="p">[</span><span class="n">counter</span><span class="p">]);</span>
		<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">frag_paddr</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">get_cqp_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">post_cqp_request</span> <span class="o">=</span> <span class="n">nes_post_cqp_request</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mcrq_mcast_filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_lock</span><span class="p">);</span>

	<span class="cm">/* setup the RQ */</span>
	<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span><span class="p">));</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span><span class="p">));</span>


	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">=</span> <span class="n">NES_NIC_WQ_SIZE</span><span class="p">;</span>

	<span class="cm">/* setup the CQ */</span>
	<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span><span class="p">));</span>
	<span class="n">pmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">netdev_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mcrq_qp_id</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_index</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mcrq_qp_id</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">=</span> <span class="n">NES_NIC_WQ_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">ce_handler</span> <span class="o">=</span> <span class="n">nes_nic_napi_ce_handler</span><span class="p">;</span>

	<span class="cm">/* Send CreateCQ request to CQP */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">;</span>

	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">NES_CQP_CREATE_CQ</span> <span class="o">|</span> <span class="n">NES_CQP_CQ_CEQ_VALID</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_pbase</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CQ_WQE_PBL_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">;</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_LOW_IDX</span><span class="p">]</span> <span class="o">=</span>  <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64temp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">33</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_DOORBELL_INDEX_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
		<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

	<span class="cm">/* Send CreateQP request to CQP */</span>
	<span class="n">nic_context</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_size</span><span class="p">]);</span>
	<span class="n">nic_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_MISC_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">NES_NIC_CTX_SIZE</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;RX_WINDOW_BUFFER_PAGE_TABLE_SIZE = 0x%08X, RX_WINDOW_BUFFER_SIZE = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_RX_WINDOW_BUFFER_PAGE_TABLE_SIZE</span><span class="p">),</span>
			<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_RX_WINDOW_BUFFER_SIZE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_RX_WINDOW_BUFFER_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_MISC_IDX</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_NIC_BACK_STORE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_pbase</span><span class="p">;</span>
	<span class="n">nic_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_SQ_LOW_IDX</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">u64temp</span><span class="p">);</span>
	<span class="n">nic_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_SQ_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_pbase</span><span class="p">;</span>
	<span class="n">nic_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_RQ_LOW_IDX</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">u64temp</span><span class="p">);</span>
	<span class="n">nic_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_RQ_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_CREATE_QP</span> <span class="o">|</span>
			<span class="n">NES_CQP_QP_TYPE_NIC</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_pbase</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_cqe</span><span class="p">));</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_QP_WQE_CONTEXT_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
		<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">=</span> <span class="n">cqp_head</span><span class="p">;</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* Ring doorbell (2 WQEs) */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="mh">0x02800000</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Waiting for create NIC QP%u to complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">==</span> <span class="n">cqp_head</span><span class="p">),</span>
			<span class="n">NES_EVENT_TIMEOUT</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Create NIC QP%u completed, wait_event_timeout ret = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;NIC QP%u create timeout expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_mem_size</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span><span class="p">,</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_pbase</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Populate the RQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">NES_NIC_WQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;%s: out of memory for receive skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">nes_destroy_nic_qp</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

		<span class="n">pmem</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>

		<span class="n">nic_rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_vbase</span><span class="p">[</span><span class="n">counter</span><span class="p">];</span>
		<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_1_0_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
		<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_3_2_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_LOW_IDX</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">pmem</span><span class="p">);</span>
		<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">pmem</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wqe_count</span> <span class="o">=</span> <span class="n">NES_NIC_WQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_head</span> <span class="o">=</span> <span class="n">wqe_count</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">wqe_count</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">255</span><span class="p">));</span>
		<span class="n">wqe_count</span> <span class="o">-=</span> <span class="n">counter</span><span class="p">;</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">wqe_count</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">);</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nes_rq_wqes_timeout</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;NAPI support Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">nes_nic_init_timer</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span>
			<span class="n">jumbomode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nes_nic_init_timer_defaults</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">jumbomode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allow_unaligned_fpdus</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">nes_init_mgt_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;%s: Out of memory for pau nic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">nes_destroy_nic_qp</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">max_aggr</span>       <span class="o">=</span> <span class="n">nes_lro_max_aggr</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">max_desc</span>       <span class="o">=</span> <span class="n">NES_MAX_LRO_DESCRIPTORS</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">lro_arr</span>        <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_desc</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">get_skb_header</span> <span class="o">=</span> <span class="n">nes_lro_get_skb_hdr</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">features</span>       <span class="o">=</span> <span class="n">LRO_F_NAPI</span> <span class="o">|</span> <span class="n">LRO_F_EXTRACT_VLAN_ID</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">dev</span>            <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">ip_summed</span>      <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">ip_summed_aggr</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_destroy_nic_qp</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_destroy_nic_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span> <span class="o">*</span><span class="n">nic_sqe</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">wqe_fragment_length</span><span class="p">;</span>
	<span class="n">u16</span>  <span class="n">wqe_fragment_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wqm_cfg0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allow_unaligned_fpdus</span><span class="p">)</span>
		<span class="n">nes_destroy_mgt</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>

	<span class="cm">/* clear wqe stall before destroying NIC QP */</span>
	<span class="n">wqm_cfg0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_WQM_CONFIG0</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_WQM_CONFIG0</span><span class="p">,</span> <span class="n">wqm_cfg0</span> <span class="o">&amp;</span> <span class="mh">0xFFFF7FFF</span><span class="p">);</span>

	<span class="cm">/* Free remaining NIC receive buffers */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_head</span> <span class="o">!=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_tail</span><span class="p">];</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span><span class="p">,</span>
			<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_tail</span><span class="o">++</span><span class="p">]);</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_tail</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free remaining NIC transmit buffers */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">!=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic_sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">];</span>
		<span class="n">wqe_fragment_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wqe_fragment_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_LENGTH_0_TAG_IDX</span><span class="p">];</span>
		<span class="cm">/* bump past the vlan tag */</span>
		<span class="n">wqe_fragment_length</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span>
				<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span><span class="o">+</span>
				<span class="n">wqe_fragment_index</span><span class="o">*</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span>
				<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_HIGH_IDX</span>
				<span class="o">+</span> <span class="n">wqe_fragment_index</span><span class="o">*</span><span class="mi">2</span><span class="p">]))</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">;</span>
			<span class="n">bus_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">u64temp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">,</span>
					<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">first_frag_overflow</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						<span class="n">bus_address</span><span class="p">,</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span>
							<span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">]),</span>
						<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">wqe_fragment_index</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">u64temp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
						<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span>
						<span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span><span class="o">+</span>
						<span class="n">wqe_fragment_index</span><span class="o">*</span><span class="mi">2</span><span class="p">]);</span>
					<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span>
						<span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span>
						<span class="n">NES_NIC_SQ_WQE_FRAG0_HIGH_IDX</span><span class="o">+</span>
						<span class="n">wqe_fragment_index</span><span class="o">*</span><span class="mi">2</span><span class="p">]))</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">;</span>
					<span class="n">bus_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">u64temp</span><span class="p">;</span>
					<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
							<span class="n">bus_address</span><span class="p">,</span>
							<span class="n">le16_to_cpu</span><span class="p">(</span>
							<span class="n">wqe_fragment_length</span><span class="p">[</span>
							<span class="n">wqe_fragment_index</span><span class="p">]),</span>
							<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">])</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">]);</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Destroy NIC QP */</span>
	<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
		<span class="p">(</span><span class="n">NES_CQP_DESTROY_QP</span> <span class="o">|</span> <span class="n">NES_CQP_QP_TYPE_NIC</span><span class="p">));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
		<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>

	<span class="cm">/* Destroy NIC CQ */</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
		<span class="p">(</span><span class="n">NES_CQP_DESTROY_CQ</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_cq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
		<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">=</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* Ring doorbell (2 WQEs) */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="mh">0x02800000</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;Waiting for CQP, cqp_head=%u, cqp.sq_head=%u,&quot;</span>
			<span class="s">&quot; cqp.sq_tail=%u, cqp.sq_size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cqp_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">,</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">==</span> <span class="n">cqp_head</span><span class="p">),</span>
			<span class="n">NES_EVENT_TIMEOUT</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;Destroy NIC QP returned, wait_event_timeout ret = %u, cqp_head=%u,&quot;</span>
			<span class="s">&quot; cqp.sq_head=%u, cqp.sq_tail=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">cqp_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;NIC QP%u destroy timeout expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_mem_size</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_vbase</span><span class="p">,</span>
			<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic_pbase</span><span class="p">);</span>

	<span class="cm">/* restore old wqm_cfg0 value */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_WQM_CONFIG0</span><span class="p">,</span> <span class="n">wqm_cfg0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_napi_isr</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_napi_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">napi_isr_ran</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* interrupt status has already been read in ISR */</span>
		<span class="n">int_stat</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_stat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">int_stat</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_INT_STAT</span><span class="p">);</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_stat</span> <span class="o">=</span> <span class="n">int_stat</span><span class="p">;</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">napi_isr_ran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">int_stat</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">;</span>
	<span class="cm">/* iff NIC, process here, else wait for DPC */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">int_stat</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">int_stat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">napi_isr_ran</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_INT_STAT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">NES_INT_INTF</span> <span class="o">|</span> <span class="n">NES_INT_TIMER</span> <span class="o">|</span> <span class="n">NES_INT_MAC0</span> <span class="o">|</span> <span class="n">NES_INT_MAC1</span> <span class="o">|</span> <span class="n">NES_INT_MAC2</span> <span class="o">|</span> <span class="n">NES_INT_MAC3</span><span class="p">)));</span>

		<span class="cm">/* Process the CEQs */</span>
		<span class="n">nes_process_ceq</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ceq</span><span class="p">[</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nic_ceq_index</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="o">!</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">))</span> <span class="o">||</span>
					<span class="p">((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					 <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">deepcq_count</span> <span class="o">&gt;</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_pkt_rate_low</span><span class="p">)))))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">&amp;</span> <span class="n">NES_INT_TIMER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Enable Periodic timer interrupts */</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">|=</span> <span class="n">NES_INT_TIMER</span><span class="p">;</span>
				<span class="cm">/* ack any pending periodic timer interrupts so we don&#39;t get an immediate interrupt */</span>
				<span class="cm">/* TODO: need to also ack other unused periodic timer values, get from nesadapter */</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_TIMER_STAT</span><span class="p">,</span>
						<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_int_req</span>  <span class="o">|</span> <span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">));</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_MASK</span><span class="p">,</span>
						<span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">intf_int_req</span> <span class="o">|</span> <span class="n">NES_INTF_PERIODIC_TIMER</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">nes_nic_init_timer</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Enable interrupts, except CEQs */</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Enable interrupts, make sure timer is off */</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_INT_TIMER</span><span class="p">;</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">intf_int_req</span><span class="p">));</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">deepcq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_critical_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">debug_error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nes_idx_debug_error_masks0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">error_module</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug_error</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_DEBUG_ERROR_CONTROL_STATUS</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Critical Error reported by device!!! 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">debug_error</span><span class="p">);</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_DEBUG_ERROR_CONTROL_STATUS</span><span class="p">,</span>
			<span class="mh">0x01010000</span> <span class="o">|</span> <span class="p">(</span><span class="n">debug_error</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crit_err_count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_DEBUG_ERROR_MASKS1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mh">0x17</span><span class="p">);</span>
	<span class="n">error_module</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">debug_error</span> <span class="o">&amp;</span> <span class="mh">0x1F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">crit_error_count</span><span class="p">[</span><span class="n">error_module</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span>
			<span class="n">nes_max_critical_error_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Masking off critical error for module &quot;</span>
			<span class="s">&quot;0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">error_module</span><span class="p">);</span>
		<span class="n">nes_idx_debug_error_masks0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
			<span class="n">NES_IDX_DEBUG_ERROR_MASKS0</span><span class="p">);</span>
		<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_DEBUG_ERROR_MASKS0</span><span class="p">,</span>
			<span class="n">nes_idx_debug_error_masks0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">error_module</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * nes_dpc</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_dpc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">counter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loop_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_status_bit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timer_stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_int_stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intf_int_stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">processed_intf_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">processed_timer_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">completion_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timer_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* nes_debug(NES_DBG_ISR, &quot;\n&quot;); */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">timer_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">napi_isr_ran</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">napi_isr_ran</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">int_stat</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_stat</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">int_stat</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">processed_intf_int</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">int_stat</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NES_INT_INTF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">int_stat</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">processed_timer_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">processed_timer_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">NES_INT_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">timer_stat</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_TIMER_STAT</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">timer_stat</span> <span class="o">&amp;</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">int_stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_INT_TIMER</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">int_stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_INT_TIMER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">NES_INT_INTF</span> <span class="o">|</span> <span class="n">NES_INT_TIMER</span> <span class="o">|</span> <span class="n">NES_INT_MAC0</span><span class="o">|</span>
					<span class="n">NES_INT_MAC1</span><span class="o">|</span><span class="n">NES_INT_MAC2</span> <span class="o">|</span> <span class="n">NES_INT_MAC3</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Ack the interrupts */</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_STAT</span><span class="p">,</span>
					<span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">NES_INT_INTF</span> <span class="o">|</span> <span class="n">NES_INT_TIMER</span> <span class="o">|</span> <span class="n">NES_INT_MAC0</span><span class="o">|</span>
					<span class="n">NES_INT_MAC1</span> <span class="o">|</span> <span class="n">NES_INT_MAC2</span> <span class="o">|</span> <span class="n">NES_INT_MAC3</span><span class="p">)));</span>
			<span class="p">}</span>

			<span class="n">temp_int_stat</span> <span class="o">=</span> <span class="n">int_stat</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">int_status_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">int_status_bit</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nes_process_ceq</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">ceq</span><span class="p">[</span><span class="n">counter</span><span class="p">]);</span>
					<span class="n">temp_int_stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">int_status_bit</span><span class="p">;</span>
					<span class="n">completion_ints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp_int_stat</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">int_status_bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Process the AEQ for this pci function */</span>
			<span class="n">int_status_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">int_status_bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_process_aeq</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">aeq</span><span class="p">[</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)]);</span>
			<span class="p">}</span>

			<span class="cm">/* Process the MAC interrupt for this pci function */</span>
			<span class="n">int_status_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">24</span> <span class="o">+</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">int_status_bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_process_mac_intr</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">NES_INT_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">timer_stat</span> <span class="o">&amp;</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_TIMER_STAT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">timer_stat</span> <span class="o">&amp;</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">)</span> <span class="o">|</span>
							<span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">));</span>
					<span class="n">timer_ints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">NES_INT_INTF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">processed_intf_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">intf_int_stat</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_STAT</span><span class="p">);</span>
				<span class="n">intf_int_stat</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">intf_int_req</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">NES_INTF_INT_CRITERR</span> <span class="o">&amp;</span> <span class="n">intf_int_stat</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">process_critical_error</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">NES_INTF_INT_PCIERR</span> <span class="o">&amp;</span> <span class="n">intf_int_stat</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;PCI Error reported by device!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">NES_INTF_INT_AEQ_OFLOW</span> <span class="o">&amp;</span> <span class="n">intf_int_stat</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;AEQ Overflow reported by device!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_STAT</span><span class="p">,</span> <span class="n">intf_int_stat</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">int_stat</span> <span class="o">&amp;</span> <span class="n">NES_INT_TSW</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Don&#39;t use the interface interrupt bit stay in loop */</span>
		<span class="n">int_stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_INT_INTF</span> <span class="o">|</span> <span class="n">NES_INT_TIMER</span> <span class="o">|</span> <span class="n">NES_INT_MAC0</span> <span class="o">|</span>
				<span class="n">NES_INT_MAC1</span> <span class="o">|</span> <span class="n">NES_INT_MAC2</span> <span class="o">|</span> <span class="n">NES_INT_MAC3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">int_stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loop_counter</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_DPC_ITERATIONS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_ints</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">completion_ints</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_only_int_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_only_int_count</span><span class="o">&gt;=</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_limit</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_only_int_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_INT_TIMER</span><span class="p">;</span>
					<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_INTF_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">intf_int_req</span><span class="p">));</span>
					<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">nes_nic_init_timer</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_only_int_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_only_int_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NES_INT_TIMER</span><span class="p">;</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">intf_int_req</span><span class="p">));</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_TIMER_STAT</span><span class="p">,</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_int_req</span> <span class="o">|</span> <span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">));</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">completion_ints</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_rx_coalesce_usecs_irq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="o">!</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">))</span> <span class="o">||</span>
			  <span class="p">((</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">deepcq_count</span> <span class="o">&gt;</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_pkt_rate_low</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">)</span> <span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nes_debug(NES_DBG_ISR, &quot;Enabling periodic timer interrupt.\n&quot; ); */</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_only_int_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span> <span class="o">|=</span> <span class="n">NES_INT_TIMER</span><span class="p">;</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_TIMER_STAT</span><span class="p">,</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">timer_int_req</span> <span class="o">|</span> <span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">timer_int_req</span><span class="p">));</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INTF_INT_MASK</span><span class="p">,</span>
					<span class="o">~</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">intf_int_req</span> <span class="o">|</span> <span class="n">NES_INTF_PERIODIC_TIMER</span><span class="p">));</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_INT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">int_req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">deepcq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_process_ceq</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_process_ceq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_ceq</span> <span class="o">*</span><span class="n">ceq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ceq_size</span><span class="p">;</span>

	<span class="cm">/* nes_debug(NES_DBG_CQ, &quot;\n&quot;); */</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_head</span><span class="p">;</span>
	<span class="n">ceq_size</span> <span class="o">=</span> <span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_size</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">ceqe_words</span><span class="p">[</span><span class="n">NES_CEQE_CQ_CTX_HIGH_IDX</span><span class="p">])</span> <span class="o">&amp;</span>
				<span class="n">NES_CEQE_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">ceqe_words</span><span class="p">[</span><span class="n">NES_CEQE_CQ_CTX_HIGH_IDX</span><span class="p">])))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">ceqe_words</span><span class="p">[</span><span class="n">NES_CEQE_CQ_CTX_LOW_IDX</span><span class="p">])));</span>
			<span class="n">u64temp</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cq</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">u64temp</span><span class="p">);</span>
			<span class="cm">/* nes_debug(NES_DBG_CQ, &quot;pCQ = %p\n&quot;, cq); */</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">ceqe_words</span><span class="p">[</span><span class="n">NES_CEQE_CQ_CTX_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* call the event handler */</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ce_handler</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">ceq_size</span><span class="p">)</span>
				<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ceq</span><span class="o">-&gt;</span><span class="n">ceq_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_process_aeq</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_process_aeq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_aeq</span> <span class="o">*</span><span class="n">aeq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* u64 u64temp; */</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeq_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeqe_misc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeqe_cq_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">aeqe</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_head</span><span class="p">;</span>
	<span class="n">aeq_size</span> <span class="o">=</span> <span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_size</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">aeqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">aeqe_misc</span>  <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]);</span>
		<span class="n">aeqe_cq_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aeqe_misc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NES_AEQE_QP</span><span class="o">|</span><span class="n">NES_AEQE_CQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aeqe_cq_id</span> <span class="o">&gt;=</span> <span class="n">NES_FIRST_QPN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* dealing with an accelerated QP related AE */</span>
				<span class="cm">/*</span>
<span class="cm">				 * u64temp = (((u64)(le32_to_cpu(aeqe-&gt;aeqe_words[NES_AEQE_COMP_CTXT_HIGH_IDX]))) &lt;&lt; 32) |</span>
<span class="cm">				 *	     ((u64)(le32_to_cpu(aeqe-&gt;aeqe_words[NES_AEQE_COMP_CTXT_LOW_IDX])));</span>
<span class="cm">				 */</span>
				<span class="n">nes_process_iwarp_aeqe</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="o">*</span><span class="p">)</span><span class="n">aeqe</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* TODO: dealing with a CQP related AE */</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_AEQ</span><span class="p">,</span> <span class="s">&quot;Processing CQP related AE, misc = 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">aeqe_misc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">aeq_size</span><span class="p">)</span>
			<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_AEQ_ALLOC</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">aeq</span><span class="o">-&gt;</span><span class="n">aeq_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_reset_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mac_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reset_value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">==</span> <span class="n">NE020_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mh_detected</span><span class="o">++</span><span class="p">;</span>

	<span class="n">reset_value</span> <span class="o">=</span> <span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)))</span>
		<span class="n">reset_value</span> <span class="o">|=</span> <span class="mh">0x0000001d</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reset_value</span> <span class="o">|=</span> <span class="mh">0x0000002d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">link_interrupt_count</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">NES_MAX_LINK_INTERRUPTS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">link_interrupt_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">link_interrupt_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mh">0x00000040</span> <span class="o">&amp;</span> <span class="n">u32temp</span><span class="p">)</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="mh">0x0000F088</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="mh">0x0000F0C8</span><span class="p">);</span>

			<span class="n">reset_value</span> <span class="o">|=</span> <span class="mh">0x0000003d</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">link_interrupt_count</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">,</span> <span class="n">reset_value</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="mh">0x0000003d</span> <span class="o">==</span> <span class="p">(</span><span class="n">reset_value</span> <span class="o">&amp;</span> <span class="mh">0x0000003d</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pcs_control_status0</span><span class="p">,</span> <span class="n">pcs_control_status1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcs_control_status0</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span><span class="p">);</span>
			<span class="n">pcs_control_status1</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(((</span><span class="mh">0x0F000000</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status0</span> <span class="o">&amp;</span> <span class="mh">0x0F000000</span><span class="p">))</span>
			     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pcs_control_status0</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">))</span>
			    <span class="o">||</span> <span class="p">((</span><span class="mh">0x0F000000</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status1</span> <span class="o">&amp;</span> <span class="mh">0x0F000000</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pcs_control_status1</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">10</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32temp</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mh">0x00000040</span> <span class="o">&amp;</span> <span class="n">u32temp</span><span class="p">)</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="mh">0x0000F088</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_CONTROL1</span><span class="p">,</span> <span class="mh">0x0000F0C8</span><span class="p">);</span>

			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_SOFTWARE_RESET</span><span class="p">,</span> <span class="n">reset_value</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(((</span><span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_SOFTWARE_RESET</span><span class="p">)</span>
				 <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_process_mac_intr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_process_mac_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mac_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcs_control_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32temp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_phy_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcs_val</span>  <span class="o">=</span> <span class="mh">0x0f0f0000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcs_mask</span> <span class="o">=</span> <span class="mh">0x0f1f0000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cdr_ctrl</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_sw_state</span><span class="p">[</span><span class="n">mac_number</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NES_MAC_SW_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_sw_state</span><span class="p">[</span><span class="n">mac_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">NES_MAC_SW_INTERRUPT</span><span class="p">;</span>

	<span class="cm">/* ack the MAC interrupt */</span>
	<span class="n">mac_status</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_STATUS</span> <span class="o">+</span> <span class="p">(</span><span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">));</span>
	<span class="cm">/* Clear the interrupt */</span>
	<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_INT_STATUS</span> <span class="o">+</span> <span class="p">(</span><span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">),</span> <span class="n">mac_status</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;MAC%u interrupt status = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac_number</span><span class="p">,</span> <span class="n">mac_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NES_MAC_INT_LINK_STAT_CHG</span> <span class="o">|</span> <span class="n">NES_MAC_INT_XGMII_EXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_status_interrupts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="o">++</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">link_interrupt_count</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">%</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">NES_MAX_LINK_INTERRUPTS</span><span class="p">)))</span>
			<span class="n">nes_reset_link</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">mac_index</span><span class="p">);</span>

		<span class="cm">/* read the PHY interrupt status register */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span>
						<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;Phy%d data from register 0x1a = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">phy_data</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">phy_data</span><span class="o">&amp;</span><span class="mh">0x8000</span><span class="p">);</span>

			<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
						<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;Phy%d data from register 0x11 = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">phy_data</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">temp_phy_data</span> <span class="o">==</span> <span class="n">phy_data</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="n">phy_data</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
					<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;Phy%d data from register 0x1e = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">phy_data</span><span class="p">);</span>

			<span class="n">nes_read_1G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;1G phy%u data from register 1 = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">phy_data</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp_phy_data</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;The Link is up according to the PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">phy_data</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;The Link is down according to the PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;Eth SERDES Common Status: 0=0x%08X, 1=0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_STATUS0</span><span class="p">),</span>
				<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_ETH_SERDES_COMMON_STATUS0</span><span class="o">+</span><span class="mh">0x200</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">pcs_control_status</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">pcs_control_status</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pcs_control_status</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="p">((</span><span class="n">mac_index</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">));</span>
			<span class="n">pcs_control_status</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
					<span class="n">NES_IDX_PHY_PCS_CONTROL_STATUS0</span> <span class="o">+</span> <span class="p">((</span><span class="n">mac_index</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;PCS PHY Control/Status%u: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mac_index</span><span class="p">,</span> <span class="n">pcs_control_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">OneG_Mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32temp</span> <span class="o">=</span> <span class="mh">0x01010000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32temp</span> <span class="o">|=</span> <span class="mh">0x02020000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pcs_control_status</span> <span class="o">&amp;</span> <span class="n">u32temp</span><span class="p">)</span><span class="o">!=</span> <span class="n">u32temp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phy_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;PCS says the link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NES_PHY_TYPE_ARGUS</span>:
			<span class="k">case</span> <span class="n">NES_PHY_TYPE_SFP_D</span>:
			<span class="k">case</span> <span class="n">NES_PHY_TYPE_KR</span>:
				<span class="cm">/* clear the alarms */</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xc001</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xc002</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xc005</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xc006</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x9003</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x9004</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">);</span>
				<span class="cm">/* check link status */</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x9003</span><span class="p">);</span>
				<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>

				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">);</span>
				<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
				<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">);</span>
				<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>

				<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_phy_data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>

				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;%s: Phy data = 0x%04X, link was %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_link_down</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;DOWN&quot;</span> <span class="o">:</span> <span class="s">&quot;UP&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">NES_PHY_TYPE_PUMA_1G</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">mac_index</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">pcs_val</span> <span class="o">=</span> <span class="n">pcs_mask</span> <span class="o">=</span> <span class="mh">0x01010000</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">pcs_val</span> <span class="o">=</span> <span class="n">pcs_mask</span> <span class="o">=</span> <span class="mh">0x02020000</span><span class="p">;</span>
				<span class="cm">/* fall through */</span>
			<span class="nl">default:</span>
				<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcs_val</span> <span class="o">==</span> <span class="p">(</span><span class="n">pcs_control_status</span> <span class="o">&amp;</span> <span class="n">pcs_mask</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wide_ppm_offset</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_CX4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cdr_ctrl</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
							    <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span> <span class="o">+</span>
							    <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						  <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span> <span class="o">+</span>
						  <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">,</span>
						  <span class="n">cdr_ctrl</span> <span class="o">|</span> <span class="mh">0x000F0000</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_link_down</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;The Link is UP!!.  linkup was %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;The Link is now up for port %s, netdev %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
						<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
					<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">nes_port_ibevent</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wide_ppm_offset</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_CX4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">!=</span> <span class="n">NE020_REV</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cdr_ctrl</span> <span class="o">=</span> <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
							    <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span> <span class="o">+</span>
							    <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
				<span class="n">nes_write_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span>
						  <span class="n">NES_IDX_ETH_SERDES_CDR_CONTROL0</span> <span class="o">+</span>
						  <span class="n">mac_index</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">,</span>
						  <span class="n">cdr_ctrl</span> <span class="o">&amp;</span> <span class="mh">0xFFF0FFFF</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_link_down</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;The Link is Down!!. linkup was %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;The Link is now down for port %s, netdev %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)))</span>
						<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
					<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">nes_port_ibevent</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">==</span> <span class="n">NES_PHY_TYPE_SFP_D</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_recheck</span><span class="p">)</span>
				<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_recheck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
					      <span class="n">NES_LINK_RECHECK_DELAY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_sw_state</span><span class="p">[</span><span class="n">mac_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">NES_MAC_SW_IDLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nes_recheck_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_device</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_index</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_phy_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* check link status */</span>
	<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x9003</span><span class="p">);</span>
	<span class="n">temp_phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>

	<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">);</span>
	<span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>
	<span class="n">nes_read_10G_phy_reg</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_index</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">);</span>
	<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_MAC_MDIO_CONTROL</span><span class="p">);</span>

	<span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_phy_data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PHY</span><span class="p">,</span> <span class="s">&quot;%s: Phy data = 0x%04X, link was %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">,</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_link_down</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;DOWN&quot;</span> <span class="o">:</span> <span class="s">&quot;UP&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_link_down</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;The Link is now up for port %s, netdev %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
					<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">nes_port_ibevent</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">mac_link_down</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">nesvnic_list</span><span class="p">[</span><span class="n">mac_index</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;The Link is now down for port %s, netdev %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)))</span>
					<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">of_device_registered</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">nes_port_ibevent</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">port_ibevent_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_recheck</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">NES_LINK_RECHECK_MAX</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">NES_LINK_RECHECK_DELAY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">link_recheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_nic_napi_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_nic_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span><span class="p">,</span> <span class="n">nic_cq</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* The MAX_RQES_TO_PROCESS defines how many max read requests to complete before</span>
<span class="cm">* getting out of nic_ce_handler</span>
<span class="cm">*/</span>
<span class="cp">#define	MAX_RQES_TO_PROCESS	384</span>

<span class="cm">/**</span>
<span class="cm"> * nes_nic_ce_handler</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_nic_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_nic_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic</span> <span class="o">*</span><span class="n">nesnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span><span class="p">,</span> <span class="n">nic_cq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span> <span class="o">*</span><span class="n">nic_rqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_sq_wqe</span> <span class="o">*</span><span class="n">nic_sqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">wqe_fragment_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_pkt_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_errv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_misc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqe_fragment_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* first fragment (0) is used by copy buffer */</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pkt_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rqes_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sq_cqes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nes_use_lro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_head</span><span class="p">;</span>
	<span class="n">cq_size</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_size</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqes_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span>
		<span class="n">nes_use_lro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_MISC_IDX</span><span class="p">])</span> <span class="o">&amp;</span>
				<span class="n">NES_NIC_CQE_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesnic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
			<span class="n">cqe_misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_MISC_IDX</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="n">NES_NIC_CQE_SQ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sq_cqes</span><span class="o">++</span><span class="p">;</span>
				<span class="n">wqe_fragment_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">nic_sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="p">];</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="p">];</span>
				<span class="n">wqe_fragment_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_LENGTH_0_TAG_IDX</span><span class="p">];</span>
				<span class="cm">/* bump past the vlan tag */</span>
				<span class="n">wqe_fragment_length</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span> <span class="o">+</span>
							<span class="n">wqe_fragment_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]);</span>
					<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_HIGH_IDX</span> <span class="o">+</span>
							<span class="n">wqe_fragment_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
					<span class="n">bus_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">u64temp</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="p">,</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">first_frag_overflow</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
								<span class="n">bus_address</span><span class="p">,</span>
								<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">]),</span>
								<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">for</span> <span class="p">(;</span> <span class="n">wqe_fragment_index</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">wqe_fragment_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">u64temp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span> <span class="o">+</span>
										<span class="n">wqe_fragment_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]);</span>
							<span class="n">u64temp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_sqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_SQ_WQE_FRAG0_HIGH_IDX</span>
										<span class="o">+</span> <span class="n">wqe_fragment_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">;</span>
							<span class="n">bus_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">u64temp</span><span class="p">;</span>
							<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
									<span class="n">bus_address</span><span class="p">,</span>
									<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wqe_fragment_length</span><span class="p">[</span><span class="n">wqe_fragment_index</span><span class="p">]),</span>
									<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span><span class="o">++</span><span class="p">;</span>
				<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_tail</span> <span class="o">&amp;=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sq_cqes</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">barrier</span><span class="p">();</span>
					<span class="cm">/* restart the queue if it had been stopped */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
						<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
					<span class="n">sq_cqes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rqes_processed</span> <span class="o">++</span><span class="p">;</span>

				<span class="n">cq</span><span class="o">-&gt;</span><span class="n">rx_cqes_completed</span><span class="o">++</span><span class="p">;</span>
				<span class="n">cq</span><span class="o">-&gt;</span><span class="n">rx_pkts_indicated</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rx_pkt_size</span> <span class="o">=</span> <span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
				<span class="n">nic_rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_vbase</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_tail</span><span class="p">];</span>
				<span class="cm">/* Get the skb */</span>
				<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_tail</span><span class="p">];</span>
				<span class="n">nic_rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_vbase</span><span class="p">[</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_tail</span><span class="p">];</span>
				<span class="n">bus_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_LOW_IDX</span><span class="p">]);</span>
				<span class="n">bus_address</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">bus_address</span><span class="p">,</span>
						<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* rx_skb-&gt;tail = rx_skb-&gt;data + rx_pkt_size; */</span>
				<span class="cm">/* rx_skb-&gt;len = rx_pkt_size; */</span>
				<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* TODO: see if this is necessary */</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">rx_pkt_size</span><span class="p">);</span>
				<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_tail</span><span class="o">++</span><span class="p">;</span>
				<span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_tail</span> <span class="o">&amp;=</span> <span class="n">nesnic</span><span class="o">-&gt;</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">.</span><span class="n">rq_size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span>
							<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
					<span class="cm">/* nesadapter-&gt;tune_timer.cq_count += cqe_count; */</span>
					<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">+=</span> <span class="n">cqe_count</span><span class="p">;</span>
					<span class="n">cqe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">nes_replenish_nic_rq</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">pkt_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_TAG_PKT_TYPE_IDX</span><span class="p">]));</span>
				<span class="n">cqe_errv</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="n">NES_NIC_CQE_ERRV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_NIC_CQE_ERRV_SHIFT</span><span class="p">;</span>
				<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">NES_PKT_TYPE_TCPV4_BITS</span> <span class="o">==</span> <span class="p">(</span><span class="n">pkt_type</span> <span class="o">&amp;</span> <span class="n">NES_PKT_TYPE_TCPV4_MASK</span><span class="p">))</span> <span class="o">||</span>
						<span class="p">(</span><span class="n">NES_PKT_TYPE_UDPV4_BITS</span> <span class="o">==</span> <span class="p">(</span><span class="n">pkt_type</span> <span class="o">&amp;</span> <span class="n">NES_PKT_TYPE_UDPV4_MASK</span><span class="p">)))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">cqe_errv</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="n">NES_NIC_ERRV_BITS_IPV4_CSUM_ERR</span> <span class="o">|</span> <span class="n">NES_NIC_ERRV_BITS_TCPUDP_CSUM_ERR</span> <span class="o">|</span>
							<span class="n">NES_NIC_ERRV_BITS_IPH_ERR</span> <span class="o">|</span> <span class="n">NES_NIC_ERRV_BITS_WQE_OVERRUN</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
							<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CQ</span><span class="p">,</span> <span class="s">&quot;%s: unsuccessfully checksummed TCP or UDP packet.&quot;</span>
								<span class="s">&quot; errv = 0x%X, pkt_type = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cqe_errv</span><span class="p">,</span> <span class="n">pkt_type</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pkt_type</span> <span class="o">&amp;</span> <span class="n">NES_PKT_TYPE_IPV4_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NES_PKT_TYPE_IPV4_BITS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">cqe_errv</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="n">NES_NIC_ERRV_BITS_IPV4_CSUM_ERR</span> <span class="o">|</span> <span class="n">NES_NIC_ERRV_BITS_IPH_ERR</span> <span class="o">|</span>
							<span class="n">NES_NIC_ERRV_BITS_WQE_OVERRUN</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
							<span class="cm">/* nes_debug(NES_DBG_CQ, &quot;%s: Reporting successfully checksummed IPv4 packet.\n&quot;,</span>
<span class="cm">								  nesvnic-&gt;netdev-&gt;name); */</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CQ</span><span class="p">,</span> <span class="s">&quot;%s: unsuccessfully checksummed TCP or UDP packet.&quot;</span>
								<span class="s">&quot; errv = 0x%X, pkt_type = 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cqe_errv</span><span class="p">,</span> <span class="n">pkt_type</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="cm">/* nes_debug(NES_DBG_CQ, &quot;pkt_type=%x, APBVT_MASK=%x\n&quot;,</span>
<span class="cm">							pkt_type, (pkt_type &amp; NES_PKT_TYPE_APBVT_MASK)); */</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">pkt_type</span> <span class="o">&amp;</span> <span class="n">NES_PKT_TYPE_APBVT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NES_PKT_TYPE_APBVT_BITS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nes_cm_recv</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
						<span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">skip_rx_indicate0</span><span class="p">;</span>


				<span class="k">if</span> <span class="p">(</span><span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="n">NES_NIC_CQE_TAG_VALID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vlan_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span>
							<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_TAG_PKT_TYPE_IDX</span><span class="p">])</span>
							<span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CQ</span><span class="p">,</span> <span class="s">&quot;%s: Reporting stripped VLAN packet. Tag = 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>

					<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nes_use_lro</span><span class="p">)</span>
					<span class="n">lro_receive_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">,</span> <span class="n">rx_skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">);</span>

<span class="nl">skip_rx_indicate0:</span>
				<span class="p">;</span>
				<span class="cm">/* nesvnic-&gt;netstats.rx_packets++; */</span>
				<span class="cm">/* nesvnic-&gt;netstats.rx_bytes += rx_pkt_size; */</span>
			<span class="p">}</span>

			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Accounting... */</span>
			<span class="n">cqe_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">cq_size</span><span class="p">)</span>
				<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Replenish Nic CQ */</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span>
						<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
				<span class="cm">/* nesdev-&gt;nesadapter-&gt;tune_timer.cq_count += cqe_count; */</span>
				<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">+=</span> <span class="n">cqe_count</span><span class="p">;</span>
				<span class="n">cqe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rx_cqes_completed</span> <span class="o">&gt;=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqes_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nes_use_lro</span><span class="p">)</span>
		<span class="n">lro_flush_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sq_cqes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="cm">/* restart the queue if it had been stopped */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="cm">/* nes_debug(NES_DBG_CQ, &quot;CQ%u Processed = %u cqes, new head = %u.\n&quot;,</span>
<span class="cm">			cq-&gt;cq_number, cqe_count, cq-&gt;cq_head); */</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqe_allocs_pending</span> <span class="o">=</span> <span class="n">cqe_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">et_use_adaptive_rx_coalesce</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/* nesdev-&gt;nesadapter-&gt;tune_timer.cq_count += cqe_count; */</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">+=</span> <span class="n">cqe_count</span><span class="p">;</span>
		<span class="n">nes_nic_tune_timer</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span>
		<span class="n">nes_replenish_nic_rq</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * nes_cqp_ce_handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_cqp_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp</span> <span class="o">*</span><span class="n">cqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctx_index</span><span class="p">;</span>
	<span class="cm">/* u32 counter; */</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_head</span><span class="p">;</span>
	<span class="n">cq_size</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_size</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* process the CQE */</span>
		<span class="cm">/* nes_debug(NES_DBG_CQP, &quot;head=%u cqe_words=%08X\n&quot;, head,</span>
<span class="cm">			  le32_to_cpu(cq-&gt;cq_vbase[head].cqe_words[NES_CQE_OPCODE_IDX])); */</span>

		<span class="n">opcode</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_CQE_OPCODE_IDX</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">NES_CQE_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">;</span>

			<span class="n">error_code</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_CQE_ERROR_CODE_IDX</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CQP</span><span class="p">,</span> <span class="s">&quot;Bad Completion code for opcode 0x%02X from CQP,&quot;</span>
						<span class="s">&quot; Major/Minor codes = 0x%04X:%04X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_CQE_OPCODE_IDX</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">error_code</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
						<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">error_code</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span>
					<span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_CQE_COMP_COMP_CTX_HIGH_IDX</span><span class="p">])))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span>
					<span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_CQE_COMP_COMP_CTX_LOW_IDX</span><span class="p">])));</span>

			<span class="n">cqp_request</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">u64temp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* nes_debug(NES_DBG_CQP, &quot;%s: Waking up requestor\n&quot;); */</span>
					<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">major_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">error_code</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">minor_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">error_code</span><span class="p">;</span>
					<span class="n">barrier</span><span class="p">();</span>
					<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">request_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
					<span class="n">nes_put_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span>
						<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
					<span class="n">nes_free_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_CQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp</span><span class="o">-&gt;</span><span class="n">sq_tail</span> <span class="o">&gt;=</span> <span class="n">cqp</span><span class="o">-&gt;</span><span class="n">sq_size</span><span class="p">)</span>
				<span class="n">cqp</span><span class="o">-&gt;</span><span class="n">sq_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Accounting... */</span>
			<span class="n">cqe_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">cq_size</span><span class="p">)</span>
				<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pending_reqs</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">((((</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="o">+</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span><span class="o">-</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cqp_request</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp_pending_reqs</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nes_cqp_request</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">&amp;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqp_wqe</span><span class="p">));</span>
		<span class="n">barrier</span><span class="p">();</span>

		<span class="n">opcode</span> <span class="o">=</span> <span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">NES_CQP_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">NES_CQP_DOWNLOAD_SEGMENT</span><span class="p">)</span>
			<span class="n">ctx_index</span> <span class="o">=</span> <span class="n">NES_CQP_WQE_DL_COMP_CTX_LOW_IDX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctx_index</span> <span class="o">=</span> <span class="n">NES_CQP_WQE_COMP_CTX_LOW_IDX</span><span class="p">;</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">ctx_index</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cqp_request</span><span class="p">));</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">ctx_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cqp_request</span><span class="p">)));</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_CQP</span><span class="p">,</span> <span class="s">&quot;CQP request %p (opcode 0x%02X) put on CQPs SQ wqe%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cqp_request</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
		<span class="cm">/* Ring doorbell (1 WQEs) */</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="mh">0x01800000</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Arm the CCQ */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">NES_CQE_ALLOC_NOTIFY_NEXT</span> <span class="o">|</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
	<span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQE_ALLOC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">locate_mpa</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">aeq_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_Q2_DATA_ETHERNET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip over ethernet header */</span>
		<span class="n">pkt</span> <span class="o">+=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

		<span class="cm">/* Skip over IP and TCP headers */</span>
		<span class="n">pkt</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">pkt</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Determine if incoming error pkt is rdma layer */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">iwarp_opcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">aeq_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_Q2_DATA_WRITTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">q2_vbase</span> <span class="o">+</span> <span class="n">BAD_FRAME_OFFSET</span><span class="p">;</span>
		<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">locate_mpa</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">mpa</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">opcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Build iWARP terminate header */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_bld_terminate_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">async_event_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">aeq_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">q2_vbase</span> <span class="o">+</span> <span class="n">BAD_FRAME_OFFSET</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ddp_seg_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copy_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_tagged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flush_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_terminate_hdr</span> <span class="o">*</span><span class="n">termhdr</span><span class="p">;</span>

	<span class="n">termhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_terminate_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">q2_vbase</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">termhdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_Q2_DATA_WRITTEN</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Use data from offending packet to fill in ddp &amp; rdma hdrs */</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">locate_mpa</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">);</span>
		<span class="n">ddp_seg_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ddp_seg_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">copy_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">hdrct</span> <span class="o">=</span> <span class="n">DDP_LEN_FLAG</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">is_tagged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ddp_seg_len</span> <span class="o">&gt;=</span> <span class="n">TERM_DDP_LEN_TAGGED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">copy_len</span> <span class="o">+=</span> <span class="n">TERM_DDP_LEN_TAGGED</span><span class="p">;</span>
					<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">hdrct</span> <span class="o">|=</span> <span class="n">DDP_HDR_FLAG</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ddp_seg_len</span> <span class="o">&gt;=</span> <span class="n">TERM_DDP_LEN_UNTAGGED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">copy_len</span> <span class="o">+=</span> <span class="n">TERM_DDP_LEN_UNTAGGED</span><span class="p">;</span>
					<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">hdrct</span> <span class="o">|=</span> <span class="n">DDP_HDR_FLAG</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ddp_seg_len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">TERM_DDP_LEN_UNTAGGED</span> <span class="o">+</span> <span class="n">TERM_RDMA_LEN</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RDMA_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">RDMA_READ_REQ_OPCODE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">copy_len</span> <span class="o">+=</span> <span class="n">TERM_RDMA_LEN</span><span class="p">;</span>
						<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">hdrct</span> <span class="o">|=</span> <span class="n">RDMA_HDR_FLAG</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">async_event_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_UNALLOCATED_STAG</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">iwarp_opcode</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IWARP_OPCODE_WRITE</span>:
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_PROT_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_TAGGED_BUFFER</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_TAGGED_INV_STAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_INV_STAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_INVALID_STAG</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_INV_STAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_QP</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_QP_OP_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_QN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_STAG_KEY</span>:
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_STAG_INDEX</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">iwarp_opcode</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IWARP_OPCODE_SEND_INV</span>:
		<span class="k">case</span> <span class="n">IWARP_OPCODE_SEND_SE_INV</span>:
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_OP_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_INV_STAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BOUNDS_VIOLATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NES_AEQE_Q2_DATA_ETHERNET</span> <span class="o">|</span> <span class="n">NES_AEQE_Q2_DATA_MPA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_PROT_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_TAGGED_BUFFER</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_TAGGED_BOUNDS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_INV_BOUNDS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_RIGHTS_VIOLATION</span>:
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_INVALIDATE_NO_REMOTE_ACCESS_RIGHTS</span>:
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_PRIV_OPERATION_DENIED</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_ACCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_TO_WRAP</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_TO_WRAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_PD</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">iwarp_opcode</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IWARP_OPCODE_WRITE</span>:
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_PROT_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_TAGGED_BUFFER</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_TAGGED_UNASSOC_STAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IWARP_OPCODE_SEND_INV</span>:
		<span class="k">case</span> <span class="n">IWARP_OPCODE_SEND_SE_INV</span>:
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_UNASSOC_STAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_RECEIVED_MARKER_AND_LENGTH_FIELDS_DONT_MATCH</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_LEN_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_MPA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">MPA_MARKER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_RECEIVED_MPA_CRC_ERROR</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_MPA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">MPA_CRC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_SEGMENT_TOO_LARGE</span>:
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_SEGMENT_TOO_SMALL</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_LEN_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_CATASTROPHIC</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_CATASTROPHIC_LOCAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_LCE_LOCAL_CATASTROPHIC</span>:
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_NO_L_BIT</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_FATAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_CATASTROPHIC</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_CATASTROPHIC_LOCAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_INVALID_MSN_GAP_IN_MSN</span>:
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_INVALID_MSN_RANGE_IS_NOT_VALID</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_MSN_RANGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_DDP_MESSAGE_TOO_LONG_FOR_AVAILABLE_BUFFER</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_LEN_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_TOO_LONG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_DDP_VERSION</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_tagged</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_TAGGED_BUFFER</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_TAGGED_INV_DDP_VER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
			<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_DDP_VER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_MO</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_MO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_MSN_NO_BUFFER_AVAILABLE</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_REM_OP_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_MSN_NO_BUF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_QN</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_DDP</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDP_UNTAGGED_BUFFER</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DDP_UNTAGGED_INV_QN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_INVALID_RDMAP_VERSION</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_INV_RDMAP_VER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_UNEXPECTED_OPCODE</span>:
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_LOC_QP_OP_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_UNEXPECTED_OP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">flush_code</span> <span class="o">=</span> <span class="n">IB_WC_FATAL_ERR</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAYER_RDMA</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="n">termhdr</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">RDMAP_UNSPECIFIED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">termhdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flush_code</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">NES_AEQE_INBOUND_RDMA</span> <span class="o">&amp;</span> <span class="n">aeq_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_SQ</span><span class="p">)</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_sq_flush_code</span> <span class="o">=</span> <span class="n">flush_code</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_rq_flush_code</span> <span class="o">=</span> <span class="n">flush_code</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_terminate_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">copy_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_terminate_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="o">*</span><span class="n">aeqe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_event_type</span> <span class="n">eventtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeq_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">async_event_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcp_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iwarp_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">termlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mod_qp_flags</span> <span class="o">=</span> <span class="n">NES_CQP_QP_IWARP_STATE_TERMINATE</span> <span class="o">|</span>
			   <span class="n">NES_CQP_QP_TERM_DONT_SEND_FIN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span> <span class="o">&amp;</span> <span class="n">NES_TERM_SENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Sanity check */</span>

	<span class="n">aeq_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]);</span>
	<span class="n">tcp_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_TCP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_AEQE_TCP_STATE_SHIFT</span><span class="p">;</span>
	<span class="n">iwarp_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_IWARP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_AEQE_IWARP_STATE_SHIFT</span><span class="p">;</span>
	<span class="n">async_event_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">aeq_info</span><span class="p">;</span>

	<span class="n">context</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span>
		<span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">])</span> <span class="o">-</span> <span class="n">NES_FIRST_QPN</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nesqp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">iwarp_state</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">async_event_id</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_eventtype</span> <span class="o">=</span> <span class="n">eventtype</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">send_term_ok</span><span class="p">)</span>
		<span class="n">termlen</span> <span class="o">=</span> <span class="n">nes_bld_terminate_hdr</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">async_event_id</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mod_qp_flags</span> <span class="o">|=</span> <span class="n">NES_CQP_QP_TERM_DONT_SEND_TERM_MSG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">iw_status</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span> <span class="o">=</span> <span class="n">NES_TERM_DONE</span><span class="p">;</span>
		<span class="n">nes_hw_modify_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">NES_CQP_QP_IWARP_STATE_ERROR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nes_terminate_start_timer</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span> <span class="o">|=</span> <span class="n">NES_TERM_SENT</span><span class="p">;</span>
		<span class="n">nes_hw_modify_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">mod_qp_flags</span><span class="p">,</span> <span class="n">termlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_terminate_send_fin</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="o">*</span><span class="n">aeqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aeq_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">async_event_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcp_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iwarp_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">aeq_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]);</span>
	<span class="n">tcp_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_TCP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_AEQE_TCP_STATE_SHIFT</span><span class="p">;</span>
	<span class="n">iwarp_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_IWARP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_AEQE_IWARP_STATE_SHIFT</span><span class="p">;</span>
	<span class="n">async_event_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">aeq_info</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">iwarp_state</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">async_event_id</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Send the fin only */</span>
	<span class="n">nes_hw_modify_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">NES_CQP_QP_IWARP_STATE_TERMINATE</span> <span class="o">|</span>
		<span class="n">NES_CQP_QP_TERM_DONT_SEND_TERM_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Cleanup after a terminate sent or received */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_terminate_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_occurred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">next_iwarp_state</span> <span class="o">=</span> <span class="n">NES_CQP_QP_IWARP_STATE_ERROR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">to_nesvnic</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">first_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_added</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">next_iwarp_state</span> <span class="o">|=</span> <span class="n">NES_CQP_QP_DEL_HTE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span> <span class="o">&amp;</span> <span class="n">NES_TERM_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span> <span class="o">|=</span> <span class="n">NES_TERM_DONE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Make sure we go through this only once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout_occurred</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">next_iwarp_state</span> <span class="o">|=</span> <span class="n">NES_CQP_QP_RESET</span><span class="p">;</span>

		<span class="n">nes_hw_modify_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">next_iwarp_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_terminate_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="o">*</span><span class="n">aeqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aeq_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ddp_ctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rdma_ctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aeq_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aeq_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_Q2_DATA_WRITTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Terminate is not a performance path so the silicon */</span>
		<span class="cm">/* did not validate the frame - do it now */</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">q2_vbase</span> <span class="o">+</span> <span class="n">BAD_FRAME_OFFSET</span><span class="p">;</span>
		<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">locate_mpa</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">);</span>
		<span class="n">ddp_ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">mpa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rdma_ctl</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">mpa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ddp_ctl</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">aeq_id</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_DDP_LCE_LOCAL_CATASTROPHIC</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ddp_ctl</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">aeq_id</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_DDP_VERSION</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">mpa</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">aeq_id</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_QN</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">mpa</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">aeq_id</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_DDP_INVALID_MSN_GAP_IN_MSN</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">mpa</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">aeq_id</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_MO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rdma_ctl</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">aeq_id</span> <span class="o">=</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_INVALID_RDMAP_VERSION</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aeq_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Bad terminate recvd - send back a terminate */</span>
			<span class="n">aeq_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="n">aeq_id</span><span class="p">;</span>
			<span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">aeq_info</span><span class="p">);</span>
			<span class="n">nes_terminate_connection</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">aeqe</span><span class="p">,</span> <span class="n">IB_EVENT_QP_FATAL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span> <span class="o">|=</span> <span class="n">NES_TERM_RCVD</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_eventtype</span> <span class="o">=</span> <span class="n">IB_EVENT_QP_FATAL</span><span class="p">;</span>
	<span class="n">nes_terminate_start_timer</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
	<span class="n">nes_terminate_send_fin</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">aeqe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Timeout routine in case terminate fails to complete */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_terminate_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>

	<span class="n">nes_terminate_done</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set a timer in case hw cannot complete the terminate sequence */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_terminate_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">);</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nes_terminate_timeout</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">terminate_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_process_iwarp_aeqe</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_process_iwarp_aeqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nes_hw_aeqe</span> <span class="o">*</span><span class="n">aeqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">*</span><span class="n">hw_cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cq</span> <span class="o">*</span><span class="n">nescq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resource_allocated</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeq_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">next_iwarp_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeqe_cq_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">async_event_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcp_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iwarp_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">ibevent</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_AEQ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">aeq_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">NES_AEQE_INBOUND_RDMA</span> <span class="o">&amp;</span> <span class="n">aeq_info</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">NES_AEQE_QP</span> <span class="o">&amp;</span> <span class="n">aeq_info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">context</span>  <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_CTXT_LOW_IDX</span><span class="p">]);</span>
		<span class="n">context</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_CTXT_HIGH_IDX</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">context</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span>
						<span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">])</span> <span class="o">-</span> <span class="n">NES_FIRST_QPN</span><span class="p">];</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* context is nesqp unless async_event_id == CQ ERROR */</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="n">async_event_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">aeq_info</span><span class="p">;</span>
	<span class="n">tcp_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_TCP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_AEQE_TCP_STATE_SHIFT</span><span class="p">;</span>
	<span class="n">iwarp_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_IWARP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NES_AEQE_IWARP_STATE_SHIFT</span><span class="p">;</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_AEQ</span><span class="p">,</span> <span class="s">&quot;aeid = 0x%04X, qp-cq id = %d, aeqe = %p,&quot;</span>
			<span class="s">&quot; Tcp state = %s, iWARP state = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">async_event_id</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">]),</span> <span class="n">aeqe</span><span class="p">,</span>
			<span class="n">nes_tcp_state_str</span><span class="p">[</span><span class="n">tcp_state</span><span class="p">],</span> <span class="n">nes_iwarp_state_str</span><span class="p">[</span><span class="n">iwarp_state</span><span class="p">]);</span>

	<span class="n">aeqe_cq_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aeq_info</span> <span class="o">&amp;</span> <span class="n">NES_AEQE_QP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nes_is_resource_allocated</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">,</span>
				<span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_qps</span><span class="p">,</span>
				<span class="n">aeqe_cq_id</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">async_event_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_FIN_RECEIVED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_flags</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span> <span class="cm">/* Ignore it, wait for close complete */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">close_timer_started</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tcp_state</span> <span class="o">==</span> <span class="n">NES_AEQE_TCP_STATE_CLOSE_WAIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">ibqp_state</span> <span class="o">==</span> <span class="n">IB_QPS_RTS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">iwarp_state</span><span class="p">;</span>
					<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">;</span>
					<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">async_event_id</span><span class="p">;</span>
					<span class="n">next_iwarp_state</span> <span class="o">=</span> <span class="n">NES_CQP_QP_IWARP_STATE_CLOSING</span><span class="p">;</span>
					<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">NES_AEQE_IWARP_STATE_CLOSING</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">nes_hw_modify_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">next_iwarp_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
				<span class="n">schedule_nes_timer</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">nesqp</span><span class="p">,</span>
						<span class="n">NES_TIMER_TYPE_CLOSE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_AEQ</span><span class="p">,</span> <span class="s">&quot;QP%u Not decrementing QP refcount (%d),&quot;</span>
						<span class="s">&quot; need ae to finish up, original_last_aeq = 0x%04X.&quot;</span>
						<span class="s">&quot; last_aeq = 0x%04X, scheduling timer. TCP state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">),</span>
						<span class="n">async_event_id</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span><span class="p">,</span> <span class="n">tcp_state</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_CLOSE_COMPLETE</span>:
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">iwarp_state</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">async_event_id</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_RESET_SENT</span>:
			<span class="n">tcp_state</span> <span class="o">=</span> <span class="n">NES_AEQE_TCP_STATE_CLOSED</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">iwarp_state</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">async_event_id</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">next_iwarp_state</span> <span class="o">=</span> <span class="n">NES_CQP_QP_IWARP_STATE_ERROR</span> <span class="o">|</span> <span class="n">NES_CQP_QP_DEL_HTE</span><span class="p">;</span>
			<span class="n">nes_hw_modify_qp</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">next_iwarp_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_CONNECTION_RESET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">close_timer_started</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_iwarp_state</span> <span class="o">=</span> <span class="n">iwarp_state</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hw_tcp_state</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">;</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">last_aeq</span> <span class="o">=</span> <span class="n">async_event_id</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">nes_cm_disconn</span><span class="p">(</span><span class="n">nesqp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_TERMINATE_SENT</span>:
			<span class="n">nes_terminate_send_fin</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">aeqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_TERMINATE_RECEIVED</span>:
			<span class="n">nes_terminate_received</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">aeqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_STAG_KEY</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_STAG_INDEX</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_UNALLOCATED_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_INVALID_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_RIGHTS_VIOLATION</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_INVALIDATE_NO_REMOTE_ACCESS_RIGHTS</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_PRIV_OPERATION_DENIED</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_DDP_MESSAGE_TOO_LONG_FOR_AVAILABLE_BUFFER</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BOUNDS_VIOLATION</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_TO_WRAP</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;QP[%u] async_event_id=0x%04X IB_EVENT_QP_ACCESS_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">async_event_id</span><span class="p">);</span>
			<span class="n">nes_terminate_connection</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">aeqe</span><span class="p">,</span> <span class="n">IB_EVENT_QP_ACCESS_ERR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_SEGMENT_TOO_LARGE</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_SEGMENT_TOO_SMALL</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_MO</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_QN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">iwarp_opcode</span><span class="p">(</span><span class="n">nesqp</span><span class="p">,</span> <span class="n">aeq_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IWARP_OPCODE_TERM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">aeq_info</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
				<span class="n">aeq_info</span> <span class="o">|=</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_UNEXPECTED_OPCODE</span><span class="p">;</span>
				<span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">aeq_info</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_BAD_LLP_CLOSE</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_TOO_MANY_RETRIES</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_MSN_NO_BUFFER_AVAILABLE</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_RECEIVED_MPA_CRC_ERROR</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_QP</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_LLP_RECEIVED_MARKER_AND_LENGTH_FIELDS_DONT_MATCH</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_LCE_LOCAL_CATASTROPHIC</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_NO_L_BIT</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_INVALID_MSN_GAP_IN_MSN</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_INVALID_MSN_RANGE_IS_NOT_VALID</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_DDP_UBE_INVALID_DDP_VERSION</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_INVALID_RDMAP_VERSION</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_RDMAP_ROE_UNEXPECTED_OPCODE</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_BAD_PD</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_FASTREG_SHARED</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_FASTREG_VALID_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_FASTREG_MW_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_FASTREG_INVALID_RIGHTS</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_FASTREG_PBL_TABLE_OVERFLOW</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_FASTREG_INVALID_LENGTH</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_INVALIDATE_SHARED</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_INVALIDATE_MR_WITH_BOUND_WINDOWS</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_VALID_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_OF_MR_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_TO_ZERO_BASED_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_TO_MW_STAG</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_INVALID_RIGHTS</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_INVALID_BOUNDS</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_TO_INVALID_PARENT</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_AMP_MWBIND_BIND_DISABLED</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_BAD_CLOSE</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_RDMA_READ_WHILE_ORD_ZERO</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_STAG_ZERO_INVALID</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_ROE_INVALID_RDMA_READ_REQUEST</span>:
		<span class="k">case</span> <span class="n">NES_AEQE_AEID_ROE_INVALID_RDMA_WRITE_OR_READ_RESP</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;QP[%u] async_event_id=0x%04X IB_EVENT_QP_FATAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">async_event_id</span><span class="p">);</span>
			<span class="n">print_ip</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">close_timer_started</span><span class="p">))</span>
				<span class="n">nes_terminate_connection</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">aeqe</span><span class="p">,</span> <span class="n">IB_EVENT_QP_FATAL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NES_AEQE_AEID_CQ_OPERATION_ERROR</span>:
			<span class="n">context</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_AEQ</span><span class="p">,</span> <span class="s">&quot;Processing an NES_AEQE_AEID_CQ_OPERATION_ERROR event on CQ%u, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">]),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">context</span><span class="p">);</span>
			<span class="n">resource_allocated</span> <span class="o">=</span> <span class="n">nes_is_resource_allocated</span><span class="p">(</span><span class="n">nesadapter</span><span class="p">,</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">allocated_cqs</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">]));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resource_allocated</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Processing an NES_AEQE_AEID_CQ_OPERATION_ERROR event on CQ%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">aeqe</span><span class="o">-&gt;</span><span class="n">aeqe_words</span><span class="p">[</span><span class="n">NES_AEQE_COMP_QP_CQ_ID_IDX</span><span class="p">]));</span>
				<span class="n">hw_cq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hw_cq</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nescq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">hw_cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cq</span><span class="p">,</span> <span class="n">hw_cq</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">event_handler</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ibevent</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
						<span class="n">ibevent</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_CQ_ERR</span><span class="p">;</span>
						<span class="n">ibevent</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>
						<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">event_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibevent</span><span class="p">,</span> <span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_AEQ</span><span class="p">,</span> <span class="s">&quot;Processing an iWARP related AE for QP, misc = 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">async_event_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_iwarp_ce_handler</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_iwarp_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_cq</span> <span class="o">*</span><span class="n">hw_cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cq</span> <span class="o">*</span><span class="n">nescq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">hw_cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cq</span><span class="p">,</span> <span class="n">hw_cq</span><span class="p">);</span>

	<span class="cm">/* nes_debug(NES_DBG_CQ, &quot;Processing completion event for iWARP CQ%u.\n&quot;,</span>
<span class="cm">			nescq-&gt;hw_cq.cq_number); */</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">NES_CQ_ACK</span><span class="p">,</span> <span class="n">nescq</span><span class="o">-&gt;</span><span class="n">hw_cq</span><span class="p">.</span><span class="n">cq_number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)</span>
		<span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">nescq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_manage_apbvt()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_manage_apbvt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">accel_local_port</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">nic_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">add_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">major_code</span><span class="p">;</span>

	<span class="cm">/* Send manage APBVT request to CQP */</span>
	<span class="n">cqp_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_QP</span><span class="p">,</span> <span class="s">&quot;Failed to get a cqp_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">;</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_QP</span><span class="p">,</span> <span class="s">&quot;%s APBV for local port=%u(0x%04x), nic_index=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">add_port</span> <span class="o">==</span> <span class="n">NES_MANAGE_APBVT_ADD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ADD&quot;</span> <span class="o">:</span> <span class="s">&quot;DEL&quot;</span><span class="p">,</span>
			<span class="n">accel_local_port</span><span class="p">,</span> <span class="n">accel_local_port</span><span class="p">,</span> <span class="n">nic_index</span><span class="p">);</span>

	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">NES_CQP_MANAGE_APBVT</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">add_port</span> <span class="o">==</span> <span class="n">NES_MANAGE_APBVT_ADD</span><span class="p">)</span> <span class="o">?</span> <span class="n">NES_CQP_APBVT_ADD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span>
			<span class="p">((</span><span class="n">nic_index</span> <span class="o">&lt;&lt;</span> <span class="n">NES_CQP_APBVT_NIC_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">accel_local_port</span><span class="p">));</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_QP</span><span class="p">,</span> <span class="s">&quot;Waiting for CQP completion for APBVT.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">nes_post_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_port</span> <span class="o">==</span> <span class="n">NES_MANAGE_APBVT_ADD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">,</span> <span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">request_done</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">NES_EVENT_TIMEOUT</span><span class="p">);</span>
	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_QP</span><span class="p">,</span> <span class="s">&quot;Completed, ret=%u,  CQP Major:Minor codes = 0x%04X:0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">major_code</span><span class="p">,</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">minor_code</span><span class="p">);</span>
	<span class="n">major_code</span> <span class="o">=</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">major_code</span><span class="p">;</span>

	<span class="n">nes_put_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">major_code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nes_manage_arp_cache</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_manage_arp_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arp_index</span><span class="p">;</span>

	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">arp_index</span> <span class="o">=</span> <span class="n">nes_arp_table</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arp_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update the ARP entry */</span>
	<span class="n">cqp_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NETDEV</span><span class="p">,</span> <span class="s">&quot;Failed to get a cqp_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">NES_CQP_MANAGE_ARP_CACHE</span> <span class="o">|</span> <span class="n">NES_CQP_ARP_PERM</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NES_CQP_ARP_AEQ_INDEX_SHIFT</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">arp_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">NES_ARP_ADD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_ARP_VALID</span><span class="p">);</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_ARP_WQE_MAC_ADDR_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
				<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_ARP_WQE_MAC_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
				<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_ARP_WQE_MAC_ADDR_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_ARP_WQE_MAC_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_NETDEV</span><span class="p">,</span> <span class="s">&quot;Not waiting for CQP, cqp.sq_head=%u, cqp.sq_tail=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nes_post_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * flush_wqes</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">flush_wqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">which_wq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wait_completion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">NES_IWARP_CQE_MAJOR_FLUSH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">NES_IWARP_CQE_MINOR_FLUSH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">NES_IWARP_CQE_MAJOR_FLUSH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">NES_IWARP_CQE_MINOR_FLUSH</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cqp_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_QP</span><span class="p">,</span> <span class="s">&quot;Failed to get a cqp_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_completion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

	<span class="cm">/* If wqe in error was identified, set code to be put into cqe */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_sq_flush_code</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">which_wq</span> <span class="o">&amp;</span> <span class="n">NES_CQP_FLUSH_SQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">which_wq</span> <span class="o">|=</span> <span class="n">NES_CQP_FLUSH_MAJ_MIN</span><span class="p">;</span>
		<span class="n">sq_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">CQE_MAJOR_DRV</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_sq_flush_code</span><span class="p">;</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_sq_flush_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_rq_flush_code</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">which_wq</span> <span class="o">&amp;</span> <span class="n">NES_CQP_FLUSH_RQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">which_wq</span> <span class="o">|=</span> <span class="n">NES_CQP_FLUSH_MAJ_MIN</span><span class="p">;</span>
		<span class="n">rq_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">CQE_MAJOR_DRV</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_rq_flush_code</span><span class="p">;</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">term_rq_flush_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">which_wq</span> <span class="o">&amp;</span> <span class="n">NES_CQP_FLUSH_MAJ_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_QP_WQE_FLUSH_SQ_CODE</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sq_code</span><span class="p">);</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_QP_WQE_FLUSH_RQ_CODE</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rq_code</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_FLUSH_WQES</span> <span class="o">|</span> <span class="n">which_wq</span><span class="p">);</span>
	<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

	<span class="n">nes_post_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_completion</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait for CQP */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">,</span> <span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">request_done</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">NES_EVENT_TIMEOUT</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_QP</span><span class="p">,</span> <span class="s">&quot;Flush SQ QP WQEs completed, ret=%u,&quot;</span>
				<span class="s">&quot; CQP Major:Minor codes = 0x%04X:0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">,</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">major_code</span><span class="p">,</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">minor_code</span><span class="p">);</span>
		<span class="n">nes_put_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
