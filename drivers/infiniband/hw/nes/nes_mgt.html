<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › nes › nes_mgt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nes_mgt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 - 2011 Intel-NE, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &quot;nes.h&quot;</span>
<span class="cp">#include &quot;nes_mgt.h&quot;</span>

<span class="n">atomic_t</span> <span class="n">pau_qps_created</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">pau_qps_destroyed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_replenish_mgt_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="n">mgtvnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span> <span class="o">*</span><span class="n">nic_rqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_mgt</span> <span class="o">*</span><span class="n">nesmgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_wqes_posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nesmgt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">;</span>
	<span class="n">nesdev</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">replenishing_rq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>      <span class="cm">/* 1/2 second */</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">replenishing_rq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

			<span class="n">bus_address</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">bus_address</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>

			<span class="n">nic_rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_vbase</span><span class="p">[</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_head</span><span class="p">];</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_1_0_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_3_2_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_LOW_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">bus_address</span><span class="p">);</span>
			<span class="n">nic_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">bus_address</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
			<span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_head</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_head</span> <span class="o">&amp;=</span> <span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">);</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rx_wqes_posted</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">rx_wqes_posted</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">qp_id</span><span class="p">);</span>
				<span class="n">rx_wqes_posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>      <span class="cm">/* 1/2 second */</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">rq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">));</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_wqes_posted</span><span class="p">)</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">rx_wqes_posted</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="n">nesmgt</span><span class="o">-&gt;</span><span class="n">replenishing_rq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_mgt_rq_wqes_timeout</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_mgt_rq_wqes_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="n">mgtvnic</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="p">)</span><span class="n">parm</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skb_timer_running</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">))</span>
		<span class="n">nes_replenish_mgt_rq</span><span class="p">(</span><span class="n">mgtvnic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_mgt_free_skb - unmap and free skb</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_mgt_free_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_download_callback - handle download completions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_download_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pau_fpdu_info</span> <span class="o">*</span><span class="n">fpdu_info</span> <span class="o">=</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback_pointer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frag_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmplt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_mgt_free_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">nes_rem_ref_cm_node</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">,</span>
				    <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span><span class="p">,</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_pbase</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fpdu_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_get_seq - Get the seq, ack_seq and window from the packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">nes_get_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ack</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">wnd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fin_rcvd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rst_rcvd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span>

	<span class="o">*</span><span class="n">ack</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
	<span class="o">*</span><span class="n">wnd</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fin_rcvd</span> <span class="o">=</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rst_rcvd</span> <span class="o">=</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_get_next_skb - Get the next skb based on where current skb is in the queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">nes_get_next_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nextseq</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ack</span><span class="p">,</span>
					<span class="n">u16</span> <span class="o">*</span><span class="n">wnd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fin_rcvd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rst_rcvd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">processacks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">old_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Continue processing fpdu */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">processacks</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Starting a new one */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
		<span class="n">processacks</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">nes_get_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">wnd</span><span class="p">,</span> <span class="n">fin_rcvd</span><span class="p">,</span> <span class="n">rst_rcvd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">==</span> <span class="n">nextseq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">||</span> <span class="n">processacks</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">after</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">nextseq</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">old_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">skb_unlink</span><span class="p">(</span><span class="n">old_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
		<span class="n">nes_mgt_free_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">old_skb</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">nes_rem_ref_cm_node</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_fpdu_info - Find the next complete fpdu and return its fragments.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_fpdu_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">pau_fpdu_info</span> <span class="o">**</span><span class="n">pau_fpdu_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pau_fpdu_info</span> <span class="o">*</span><span class="n">fpdu_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pau_fpdu_frag</span> <span class="n">frags</span><span class="p">[</span><span class="n">MAX_FPDU_FRAGS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fpdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tot_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frag_tot</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ack</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fin_rcvd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rst_rcvd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pau_fpdu_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">nes_get_next_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fin_rcvd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rst_rcvd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fpdu_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">MPA_FRAMING</span><span class="p">;</span>
		<span class="n">fpdu_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpdu_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">;</span>
		<span class="n">tmp_len</span> <span class="o">=</span> <span class="n">fpdu_len</span><span class="p">;</span>

		<span class="cm">/* See if we have all of the fpdu */</span>
		<span class="n">frag_tot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">frags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FPDU_FRAGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physaddr</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">physaddr</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tmp_len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmplt</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_len</span><span class="p">);</span>
			<span class="n">frag_tot</span> <span class="o">+=</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_len</span><span class="p">;</span>
			<span class="n">frag_cnt</span><span class="o">++</span><span class="p">;</span>

			<span class="n">tmp_len</span> <span class="o">-=</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">nes_get_next_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					       <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span> <span class="o">+</span> <span class="n">frag_tot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fin_rcvd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rst_rcvd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rst_rcvd</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* rst received in the middle of fpdu */</span>
				<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb_unlink</span><span class="p">(</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
					<span class="n">nes_mgt_free_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">physaddr</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
				<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">physaddr</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
				<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cmplt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">frag_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no data */</span>
		<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">physaddr</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
		<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">frag_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cmplt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">frag_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Found one */</span>
	<span class="n">fpdu_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fpdu_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Failed to alloc a fpdu_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">cqp_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">cqp_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Failed to get a cqp_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span>
	<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tcph</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="p">))</span> <span class="o">-</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
	<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">fpdu_len</span><span class="p">;</span>
	<span class="n">tot_len</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">+</span> <span class="n">fpdu_len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cmplt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_pbase</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
		<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
							    <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_pbase</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for pau first frag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy hdrs, adjusting len and seqnum */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">,</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_vbase</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">tot_len</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x7f000001</span><span class="p">);</span>

	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span><span class="p">);</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ack</span><span class="p">);</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">wnd</span><span class="p">);</span>

	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span> <span class="o">+=</span> <span class="n">fpdu_len</span> <span class="o">+</span> <span class="n">fin_rcvd</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">,</span> <span class="n">frags</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">));</span>
	<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frag_cnt</span> <span class="o">=</span> <span class="n">frag_cnt</span><span class="p">;</span>
	<span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pau_fpdu_info</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="p">;</span>

	<span class="cm">/* Update skb&#39;s for next pass */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frag_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frag_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Pull skb off the list - it will be freed in the callback */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">skb_unlink</span><span class="p">(</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Last skb still has data so update the seq */</span>
			<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
			<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span>
			<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">cqp_request</span><span class="p">)</span>
				<span class="n">nes_put_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">cqp_request</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fpdu_info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * forward_fpdu - send complete fpdus, one at a time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">forward_fpdus</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pau_fpdu_info</span> <span class="o">*</span><span class="n">fpdu_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">get_fpdu_info</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpdu_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fpdu_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">cqp_request</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">cqp_request</span><span class="p">;</span>
		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">;</span>
		<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_DL_OPCODE_IDX</span><span class="p">,</span>
				    <span class="n">NES_CQP_DOWNLOAD_SEGMENT</span> <span class="o">|</span>
				    <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">logical_port</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NES_CQP_OP_LOGICAL_PORT_SHIFT</span><span class="p">));</span>

		<span class="n">u32tmp</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">u32tmp</span> <span class="o">|=</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_DL_LENGTH_0_TOTAL_IDX</span><span class="p">,</span>
				    <span class="n">u32tmp</span><span class="p">);</span>

		<span class="n">u32tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">frag_len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">frag_len</span><span class="p">;</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_LENGTH_2_1_IDX</span><span class="p">,</span>
				    <span class="n">u32tmp</span><span class="p">);</span>

		<span class="n">u32tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">frag_len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">frag_len</span><span class="p">;</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_LENGTH_4_3_IDX</span><span class="p">,</span>
				    <span class="n">u32tmp</span><span class="p">);</span>

		<span class="n">u64tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">hdr_pbase</span><span class="p">;</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG0_LOW_IDX</span><span class="p">,</span>
				    <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">u64tmp</span><span class="p">));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG0_HIGH_IDX</span><span class="p">,</span>
				    <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">u64tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG1_LOW_IDX</span><span class="p">,</span>
				    <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG1_HIGH_IDX</span><span class="p">,</span>
				    <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>

		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG2_LOW_IDX</span><span class="p">,</span>
				    <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG2_HIGH_IDX</span><span class="p">,</span>
				    <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>

		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG3_LOW_IDX</span><span class="p">,</span>
				    <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG3_HIGH_IDX</span><span class="p">,</span>
				    <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>

		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG4_LOW_IDX</span><span class="p">,</span>
				    <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_NIC_SQ_WQE_FRAG4_HIGH_IDX</span><span class="p">,</span>
				    <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">fpdu_info</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">physaddr</span><span class="p">));</span>

		<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback_pointer</span> <span class="o">=</span> <span class="n">fpdu_info</span><span class="p">;</span>
		<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback</span> <span class="o">=</span> <span class="n">nes_download_callback</span><span class="p">;</span>

		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nes_post_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_fpdus</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">again</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Ignore rc - if it failed, tcp retries will cause it to try again */</span>
		<span class="n">forward_fpdus</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">again</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * queue_fpdus - Handle fpdu&#39;s that hw passed up to sw</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_fpdus</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmpskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tcph_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv_nxt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv_wnd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seqnum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">process_it</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Move data ptr to after tcp header */</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span>
	<span class="n">seqnum</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">tcph_end</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tcph</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcph_end</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Initialize tracking values */</span>
	<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">seqnum</span> <span class="o">=</span> <span class="n">seqnum</span><span class="p">;</span>

	<span class="cm">/* Make sure data is in the receive window */</span>
	<span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span><span class="p">;</span>
	<span class="n">rcv_wnd</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">between</span><span class="p">(</span><span class="n">seqnum</span><span class="p">,</span> <span class="n">rcv_nxt</span><span class="p">,</span> <span class="p">(</span><span class="n">rcv_nxt</span> <span class="o">+</span> <span class="n">rcv_wnd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">nes_mgt_free_skb</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">nes_rem_ref_cm_node</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_busy</span><span class="p">)</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Queue skb by sequence number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmpskb</span> <span class="o">=</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmpskb</span> <span class="o">!=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmpskb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">before</span><span class="p">(</span><span class="n">seqnum</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tmpskb</span> <span class="o">=</span> <span class="n">tmpskb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_insert</span><span class="p">(</span><span class="n">tmpskb</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_state</span> <span class="o">==</span> <span class="n">PAU_READY</span><span class="p">)</span>
		<span class="n">process_it</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">process_it</span><span class="p">)</span>
		<span class="n">process_fpdus</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mgt_thread - Handle mgt skbs in a safe context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgt_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_wait_queue</span><span class="p">,</span>
					 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">)</span> <span class="o">||</span> <span class="n">kthread_should_stop</span><span class="p">());</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">,</span>
						     <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">queue_fpdus</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Closing down so delete any entries on the queue */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">);</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">nes_rem_ref_cm_node</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_queue_skbs - Queue skb so it can be handled in a thread context</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nes_queue_mgt_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_wait_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nes_destroy_pau_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pau_qps_destroyed</span><span class="p">);</span>

	<span class="cm">/* Free packets that have not yet been forwarded */</span>
	<span class="cm">/* Lock is acquired by skb_dequeue when removing the skb */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
		<span class="n">nes_mgt_free_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">nes_rem_ref_cm_node</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_chg_qh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pau_qh_chg</span> <span class="o">*</span><span class="n">qh_chg</span> <span class="o">=</span> <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback_pointer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">new_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_v4_quad</span> <span class="n">nes_quad</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc_value</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>

	<span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">nesqp</span> <span class="o">=</span> <span class="n">qh_chg</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">;</span>

	<span class="cm">/* Should we handle the bad completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">major_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Invalid cqp_request major_code=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">major_code</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PAU_DEL_QH</span>:
		<span class="cm">/* Old hash code deleted, now set the new one */</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_state</span> <span class="o">=</span> <span class="n">PAU_ADD_LB_QH</span><span class="p">;</span>
		<span class="n">new_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Failed to get a new_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nes_quad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nes_quad</span><span class="p">));</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">DstIpAdrIndex</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">SrcIpadr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x7f000001</span><span class="p">);</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">TcpPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcpPorts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">nes_quad</span><span class="p">.</span><span class="n">TcpPorts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">tcpPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* Produce hash key */</span>
		<span class="n">crc_value</span> <span class="o">=</span> <span class="n">get_crc_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nes_quad</span><span class="p">);</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">crc_value</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;new HTE Index = 0x%08X, CRC = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">&amp;</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span><span class="p">);</span>

		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">&amp;=</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">hte_index_mask</span><span class="p">;</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">hte_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hte_index</span><span class="p">);</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">ip0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x7f000001</span><span class="p">);</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span><span class="p">);</span>

		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">new_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">;</span>
		<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span>
				    <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span> <span class="n">NES_CQP_MANAGE_QUAD_HASH</span> <span class="o">|</span>
				    <span class="n">NES_CQP_QP_TYPE_IWARP</span> <span class="o">|</span> <span class="n">NES_CQP_QP_CONTEXT_VALID</span> <span class="o">|</span> <span class="n">NES_CQP_QP_IWARP_STATE_RTS</span><span class="p">);</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context_pbase</span><span class="p">;</span>
		<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_QP_WQE_CONTEXT_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Waiting for CQP completion for adding the quad hash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">new_request</span><span class="o">-&gt;</span><span class="n">cqp_callback_pointer</span> <span class="o">=</span> <span class="n">qh_chg</span><span class="p">;</span>
		<span class="n">new_request</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">new_request</span><span class="o">-&gt;</span><span class="n">cqp_callback</span> <span class="o">=</span> <span class="n">nes_chg_qh_handler</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_request</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nes_post_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">new_request</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PAU_ADD_LB_QH</span>:
		<span class="cm">/* Start processing the queued fpdu&#39;s */</span>
		<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_state</span> <span class="o">=</span> <span class="n">PAU_READY</span><span class="p">;</span>
		<span class="n">process_fpdus</span><span class="p">(</span><span class="n">qh_chg</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">qh_chg</span><span class="o">-&gt;</span><span class="n">nesqp</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qh_chg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_change_quad_hash</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nes_change_quad_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_cqp_request</span> <span class="o">*</span><span class="n">cqp_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pau_qh_chg</span> <span class="o">*</span><span class="n">qh_chg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cqp_request</span> <span class="o">=</span> <span class="n">nes_get_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Failed to get a cqp_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">chg_qh_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qh_chg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">qh_chg</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qh_chg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Failed to get a cqp_request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">chg_qh_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qh_chg</span><span class="o">-&gt;</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesdev</span><span class="p">;</span>
	<span class="n">qh_chg</span><span class="o">-&gt;</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="p">;</span>
	<span class="n">qh_chg</span><span class="o">-&gt;</span><span class="n">nesqp</span> <span class="o">=</span> <span class="n">nesqp</span><span class="p">;</span>
	<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_state</span> <span class="o">=</span> <span class="n">PAU_DEL_QH</span><span class="p">;</span>

	<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span>
			    <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span> <span class="n">NES_CQP_MANAGE_QUAD_HASH</span> <span class="o">|</span> <span class="n">NES_CQP_QP_DEL_HTE</span> <span class="o">|</span>
			    <span class="n">NES_CQP_QP_TYPE_IWARP</span> <span class="o">|</span> <span class="n">NES_CQP_QP_CONTEXT_VALID</span> <span class="o">|</span> <span class="n">NES_CQP_QP_IWARP_STATE_RTS</span><span class="p">);</span>
	<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span> <span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">hwqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
	<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">nesqp_context_pbase</span><span class="p">;</span>
	<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_QP_WQE_CONTEXT_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

	<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_PAU</span><span class="p">,</span> <span class="s">&quot;Waiting for CQP completion for deleting the quad hash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback_pointer</span> <span class="o">=</span> <span class="n">qh_chg</span><span class="p">;</span>
	<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">cqp_callback</span> <span class="o">=</span> <span class="n">nes_chg_qh_handler</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqp_request</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nes_post_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">chg_qh_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qh_chg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqp_request</span><span class="p">)</span>
		<span class="n">nes_put_cqp_request</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">cqp_request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_mgt_ce_handler</span>
<span class="cm"> * This management code deals with any packed and unaligned (pau) fpdu&#39;s</span>
<span class="cm"> * that the hardware cannot handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nes_mgt_ce_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_hw_nic_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="n">mgtvnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic_mgt</span><span class="p">,</span> <span class="n">mgt_cq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nes_adapter</span> <span class="o">*</span><span class="n">nesadapter</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">nesadapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_misc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">skbs_needed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="n">nesqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_head</span><span class="p">;</span>
	<span class="n">cq_size</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqe_misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_MISC_IDX</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="n">NES_NIC_CQE_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nesqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="n">NES_NIC_CQE_ACCQP_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qp_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_ACCQP_ID_IDX</span><span class="p">]);</span>
			<span class="n">qp_id</span> <span class="o">&amp;=</span> <span class="mh">0x001fffff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qp_id</span> <span class="o">&lt;</span> <span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">context</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nesadapter</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">[</span><span class="n">qp_id</span> <span class="o">-</span> <span class="n">NES_FIRST_QPN</span><span class="p">];</span>
				<span class="n">nesqp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_qp</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_mode</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* First time for this qp */</span>
				<span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_rcv_nxt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
					<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_HASH_RCVNXT</span><span class="p">]);</span>
				<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_list</span><span class="p">);</span>
				<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">pau_lock</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pau_qps_created</span><span class="p">);</span>
				<span class="n">nes_change_quad_hash</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span><span class="p">];</span>
			<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">cqe_misc</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
			<span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span> <span class="o">&amp;=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">nes_add_ref_cm_node</span><span class="p">(</span><span class="n">nesqp</span><span class="o">-&gt;</span><span class="n">cm_node</span><span class="p">);</span>
			<span class="n">nes_queue_mgt_skbs</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span><span class="p">,</span> <span class="n">nesqp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Invalid QP %d for packed/unaligned handling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qp_id</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">cqe_words</span><span class="p">[</span><span class="n">NES_NIC_CQE_MISC_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cqe_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">cq_size</span><span class="p">)</span>
			<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Replenish mgt CQ */</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">+=</span> <span class="n">cqe_count</span><span class="p">;</span>
			<span class="n">cqe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skbs_needed</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rx_skbs_needed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skbs_needed</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">nes_replenish_mgt_rq</span><span class="p">(</span><span class="n">mgtvnic</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">NES_CQE_ALLOC_NOTIFY_NEXT</span> <span class="o">|</span>
		    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_CQE_ALLOC</span><span class="p">);</span>
	<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">currcq_count</span> <span class="o">+=</span> <span class="n">cqe_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nes_init_mgt_qp</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nes_init_mgt_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="n">mgtvnic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">counter</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vmem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_qp_context</span> <span class="o">*</span><span class="n">mgt_context</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">u64temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span> <span class="o">*</span><span class="n">mgt_rqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wqe_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mgt_mem_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mgt_vbase</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mgt_pbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Allocate space the all mgt QPs once */</span>
	<span class="n">mgtvnic</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">NES_MGT_QP_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic_mgt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgtvnic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for mgt structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate fragment, RQ, and CQ; Reuse CEQ based on the PCI function */</span>
	<span class="cm">/* We are not sending from this NIC so sq is not allocated */</span>
	<span class="n">mgt_mem_size</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">NES_MGT_WQ_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span><span class="p">))</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">NES_MGT_WQ_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_cqe</span><span class="p">))</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_qp_context</span><span class="p">);</span>
	<span class="n">mgt_mem_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mgt_mem_size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mgt_vbase</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">NES_MGT_QP_COUNT</span> <span class="o">*</span> <span class="n">mgt_mem_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgt_pbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgt_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mgtvnic</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for mgt host descriptor rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_mem_size</span> <span class="o">=</span> <span class="n">NES_MGT_QP_COUNT</span> <span class="o">*</span> <span class="n">mgt_mem_size</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_vbase</span> <span class="o">=</span> <span class="n">mgt_vbase</span><span class="p">;</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_pbase</span> <span class="o">=</span> <span class="n">mgt_pbase</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_skb_list</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_wait_queue</span><span class="p">);</span>
	<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">mgt_thread</span><span class="p">,</span> <span class="n">nesvnic</span><span class="p">,</span> <span class="s">&quot;nes_mgt_thread&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NES_MGT_QP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">nesvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">+</span> <span class="n">NES_MGT_QP_OFFSET</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mgt_vbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mgt_mem_size</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Allocated mgt QP structures at %p (phys = %016lX), size = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">mgt_vbase</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mgt_pbase</span><span class="p">,</span> <span class="n">mgt_mem_size</span><span class="p">);</span>

		<span class="n">vmem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mgt_vbase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">pmem</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mgt_pbase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_lock</span><span class="p">);</span>

		<span class="cm">/* setup the RQ */</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">=</span> <span class="n">NES_MGT_WQ_COUNT</span><span class="p">;</span>

		<span class="cm">/* setup the CQ */</span>
		<span class="n">vmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_MGT_WQ_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span><span class="p">));</span>
		<span class="n">pmem</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NES_MGT_WQ_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_rq_wqe</span><span class="p">));</span>

		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_vbase</span> <span class="o">=</span> <span class="n">vmem</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_pbase</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">=</span> <span class="n">NES_MGT_WQ_COUNT</span><span class="p">;</span>

		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">ce_handler</span> <span class="o">=</span> <span class="n">nes_mgt_ce_handler</span><span class="p">;</span>

		<span class="cm">/* Send CreateCQ request to CQP */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">;</span>

		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
		<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">NES_CQP_CREATE_CQ</span> <span class="o">|</span> <span class="n">NES_CQP_CQ_CEQ_VALID</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_pbase</span><span class="p">;</span>
		<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_CQ_WQE_PBL_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">;</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_CQ_CONTEXT_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64temp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">33</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_CQ_WQE_DOORBELL_INDEX_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
			<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
		<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

		<span class="cm">/* Send CreateQP request to CQP */</span>
		<span class="n">mgt_context</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_vbase</span><span class="p">[</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_size</span><span class="p">]);</span>
		<span class="n">mgt_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_MISC_IDX</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">NES_MGT_CTX_SIZE</span> <span class="o">|</span>
				    <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;RX_WINDOW_BUFFER_PAGE_TABLE_SIZE = 0x%08X, RX_WINDOW_BUFFER_SIZE = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_RX_WINDOW_BUFFER_PAGE_TABLE_SIZE</span><span class="p">),</span>
			  <span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_RX_WINDOW_BUFFER_SIZE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nes_read_indexed</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">NES_IDX_RX_WINDOW_BUFFER_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mgt_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_MISC_IDX</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_NIC_BACK_STORE</span><span class="p">);</span>

		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_pbase</span><span class="p">;</span>
		<span class="n">mgt_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_SQ_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">u64temp</span><span class="p">);</span>
		<span class="n">mgt_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_SQ_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_pbase</span><span class="p">;</span>
		<span class="n">mgt_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_RQ_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">u64temp</span><span class="p">);</span>
		<span class="n">mgt_context</span><span class="o">-&gt;</span><span class="n">context_words</span><span class="p">[</span><span class="n">NES_NIC_CTX_RQ_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">u64temp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NES_CQP_CREATE_QP</span> <span class="o">|</span>
									 <span class="n">NES_CQP_QP_TYPE_NIC</span><span class="p">);</span>
		<span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
		<span class="n">u64temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_pbase</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_hw_nic_cqe</span><span class="p">));</span>
		<span class="n">set_wqe_64bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_QP_WQE_CONTEXT_LOW_IDX</span><span class="p">,</span> <span class="n">u64temp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
			<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">=</span> <span class="n">cqp_head</span><span class="p">;</span>

		<span class="n">barrier</span><span class="p">();</span>

		<span class="cm">/* Ring doorbell (2 WQEs) */</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="mh">0x02800000</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Waiting for create MGT QP%u to complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">==</span> <span class="n">cqp_head</span><span class="p">),</span>
					 <span class="n">NES_EVENT_TIMEOUT</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Create MGT QP%u completed, wait_event_timeout ret = %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;MGT QP%u create timeout expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_mem_size</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_vbase</span><span class="p">,</span>
						    <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_pbase</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">mgtvnic</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nes_destroy_mgt</span><span class="p">(</span><span class="n">nesvnic</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Populate the RQ */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">NES_MGT_WQ_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;%s: out of memory for receive skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

			<span class="n">pmem</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nes_rskb_cb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">pmem</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">maplen</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>

			<span class="n">mgt_rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_vbase</span><span class="p">[</span><span class="n">counter</span><span class="p">];</span>
			<span class="n">mgt_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_1_0_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
			<span class="n">mgt_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_LENGTH_3_2_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mgt_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_LOW_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">pmem</span><span class="p">);</span>
			<span class="n">mgt_rqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">[</span><span class="n">NES_NIC_RQ_WQE_FRAG0_HIGH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">pmem</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">);</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nes_mgt_rq_wqes_timeout</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">rq_wqes_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mgtvnic</span><span class="p">;</span>

		<span class="n">wqe_count</span> <span class="o">=</span> <span class="n">NES_MGT_WQ_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_head</span> <span class="o">=</span> <span class="n">wqe_count</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">counter</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">wqe_count</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">255</span><span class="p">));</span>
			<span class="n">wqe_count</span> <span class="o">-=</span> <span class="n">counter</span><span class="p">;</span>
			<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">wqe_count</span><span class="p">);</span>

		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_CQE_ALLOC</span><span class="p">,</span> <span class="n">NES_CQE_ALLOC_NOTIFY_NEXT</span> <span class="o">|</span>
			    <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="n">nes_read32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_CQE_ALLOC</span><span class="p">);</span>

		<span class="n">mgt_vbase</span> <span class="o">+=</span> <span class="n">mgt_mem_size</span><span class="p">;</span>
		<span class="n">mgt_pbase</span> <span class="o">+=</span> <span class="n">mgt_mem_size</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgtvnic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">nes_destroy_mgt</span><span class="p">(</span><span class="k">struct</span> <span class="n">nes_vnic</span> <span class="o">*</span><span class="n">nesvnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nes_device</span> <span class="o">*</span><span class="n">nesdev</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">nesdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="n">mgtvnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_vnic_mgt</span> <span class="o">*</span><span class="n">first_mgtvnic</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nes_hw_cqp_wqe</span> <span class="o">*</span><span class="n">cqp_wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqp_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_thread</span><span class="p">);</span>

	<span class="cm">/* Free remaining NIC receive buffers */</span>
	<span class="n">first_mgtvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgtvnic</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NES_MGT_QP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgtvnic</span> <span class="o">=</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgtvnic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgtvnic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_head</span> <span class="o">!=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span><span class="p">];</span>
			<span class="n">nes_mgt_free_skb</span><span class="p">(</span><span class="n">nesdev</span><span class="p">,</span> <span class="n">rx_skb</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_tail</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Destroy NIC QP */</span>
		<span class="n">cqp_head</span> <span class="o">=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">;</span>
		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>
		<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>

		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">NES_CQP_DESTROY_QP</span> <span class="o">|</span> <span class="n">NES_CQP_QP_TYPE_NIC</span><span class="p">));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span>
				    <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
			<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cqp_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_vbase</span><span class="p">[</span><span class="n">cqp_head</span><span class="p">];</span>

		<span class="cm">/* Destroy NIC CQ */</span>
		<span class="n">nes_fill_init_cqp_wqe</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="p">,</span> <span class="n">nesdev</span><span class="p">);</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_OPCODE_IDX</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">NES_CQP_DESTROY_CQ</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
		<span class="n">set_wqe_32bit_value</span><span class="p">(</span><span class="n">cqp_wqe</span><span class="o">-&gt;</span><span class="n">wqe_words</span><span class="p">,</span> <span class="n">NES_CQP_WQE_ID_IDX</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt_cq</span><span class="p">.</span><span class="n">cq_number</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">ceq_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cqp_head</span> <span class="o">&gt;=</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">)</span>
			<span class="n">cqp_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span> <span class="o">=</span> <span class="n">cqp_head</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>

		<span class="cm">/* Ring doorbell (2 WQEs) */</span>
		<span class="n">nes_write32</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NES_WQE_ALLOC</span><span class="p">,</span> <span class="mh">0x02800000</span> <span class="o">|</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;Waiting for CQP, cqp_head=%u, cqp.sq_head=%u,&quot;</span>
			  <span class="s">&quot; cqp.sq_tail=%u, cqp.sq_size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cqp_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">,</span>
			  <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_size</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span> <span class="o">==</span> <span class="n">cqp_head</span><span class="p">),</span>
					 <span class="n">NES_EVENT_TIMEOUT</span><span class="p">);</span>

		<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;Destroy MGT QP returned, wait_event_timeout ret = %u, cqp_head=%u,&quot;</span>
			  <span class="s">&quot; cqp.sq_head=%u, cqp.sq_tail=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">,</span> <span class="n">cqp_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">cqp</span><span class="p">.</span><span class="n">sq_tail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">nes_debug</span><span class="p">(</span><span class="n">NES_DBG_SHUTDOWN</span><span class="p">,</span> <span class="s">&quot;MGT QP%u destroy timeout expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">mgtvnic</span><span class="o">-&gt;</span><span class="n">mgt</span><span class="p">.</span><span class="n">qp_id</span><span class="p">);</span>

		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgtvnic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nesdev</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_mem_size</span><span class="p">,</span> <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_vbase</span><span class="p">,</span>
				    <span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_pbase</span><span class="p">);</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_vbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nesvnic</span><span class="o">-&gt;</span><span class="n">mgt_pbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">first_mgtvnic</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
