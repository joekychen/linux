<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb3 › cxio_wr.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cxio_wr.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __CXIO_WR_H__</span>
<span class="cp">#define __CXIO_WR_H__</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &quot;firmware_exports.h&quot;</span>

<span class="cp">#define T3_MAX_SGE      4</span>
<span class="cp">#define T3_MAX_INLINE	64</span>
<span class="cp">#define T3_STAG0_PBL_SIZE (2 * T3_MAX_SGE &lt;&lt; 3)</span>
<span class="cp">#define T3_STAG0_MAX_PBE_LEN (128 * 1024 * 1024)</span>
<span class="cp">#define T3_STAG0_PAGE_SHIFT 15</span>

<span class="cp">#define Q_EMPTY(rptr,wptr) ((rptr)==(wptr))</span>
<span class="cp">#define Q_FULL(rptr,wptr,size_log2)  ( (((wptr)-(rptr))&gt;&gt;(size_log2)) &amp;&amp; \</span>
<span class="cp">				       ((rptr)!=(wptr)) )</span>
<span class="cp">#define Q_GENBIT(ptr,size_log2) (!(((ptr)&gt;&gt;size_log2)&amp;0x1))</span>
<span class="cp">#define Q_FREECNT(rptr,wptr,size_log2) ((1UL&lt;&lt;size_log2)-((wptr)-(rptr)))</span>
<span class="cp">#define Q_COUNT(rptr,wptr) ((wptr)-(rptr))</span>
<span class="cp">#define Q_PTR2IDX(ptr,size_log2) (ptr &amp; ((1UL&lt;&lt;size_log2)-1))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ring_doorbell</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="n">qpid</span><span class="p">),</span> <span class="n">doorbell</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SEQ32_GE(x,y) (!( (((u32) (x)) - ((u32) (y))) &amp; 0x80000000 ))</span>

<span class="k">enum</span> <span class="n">t3_wr_flags</span> <span class="p">{</span>
	<span class="n">T3_COMPLETION_FLAG</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">T3_NOTIFY_FLAG</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">T3_SOLICITED_EVENT_FLAG</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">T3_READ_FENCE_FLAG</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">T3_LOCAL_FENCE_FLAG</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">enum</span> <span class="n">t3_wr_opcode</span> <span class="p">{</span>
	<span class="n">T3_WR_BP</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_BYPASS</span><span class="p">,</span>
	<span class="n">T3_WR_SEND</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_SEND</span><span class="p">,</span>
	<span class="n">T3_WR_WRITE</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_RDMA_WRITE</span><span class="p">,</span>
	<span class="n">T3_WR_READ</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_RDMA_READ</span><span class="p">,</span>
	<span class="n">T3_WR_INV_STAG</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_LOCAL_INV</span><span class="p">,</span>
	<span class="n">T3_WR_BIND</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_BIND_MW</span><span class="p">,</span>
	<span class="n">T3_WR_RCV</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_RECEIVE</span><span class="p">,</span>
	<span class="n">T3_WR_INIT</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_RDMA_INIT</span><span class="p">,</span>
	<span class="n">T3_WR_QP_MOD</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_MODIFY_QP</span><span class="p">,</span>
	<span class="n">T3_WR_FASTREG</span> <span class="o">=</span> <span class="n">FW_WROPCODE_RI_FASTREGISTER_MR</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">enum</span> <span class="n">t3_rdma_opcode</span> <span class="p">{</span>
	<span class="n">T3_RDMA_WRITE</span><span class="p">,</span>		<span class="cm">/* IETF RDMAP v1.0 ... */</span>
	<span class="n">T3_READ_REQ</span><span class="p">,</span>
	<span class="n">T3_READ_RESP</span><span class="p">,</span>
	<span class="n">T3_SEND</span><span class="p">,</span>
	<span class="n">T3_SEND_WITH_INV</span><span class="p">,</span>
	<span class="n">T3_SEND_WITH_SE</span><span class="p">,</span>
	<span class="n">T3_SEND_WITH_SE_INV</span><span class="p">,</span>
	<span class="n">T3_TERMINATE</span><span class="p">,</span>
	<span class="n">T3_RDMA_INIT</span><span class="p">,</span>		<span class="cm">/* CHELSIO RI specific ... */</span>
	<span class="n">T3_BIND_MW</span><span class="p">,</span>
	<span class="n">T3_FAST_REGISTER</span><span class="p">,</span>
	<span class="n">T3_LOCAL_INV</span><span class="p">,</span>
	<span class="n">T3_QP_MOD</span><span class="p">,</span>
	<span class="n">T3_BYPASS</span><span class="p">,</span>
	<span class="n">T3_RDMA_READ_REQ_WITH_INV</span><span class="p">,</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">enum</span> <span class="n">t3_rdma_opcode</span> <span class="nf">wr2opcode</span><span class="p">(</span><span class="k">enum</span> <span class="n">t3_wr_opcode</span> <span class="n">wrop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wrop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">T3_WR_BP</span>: <span class="k">return</span> <span class="n">T3_BYPASS</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_SEND</span>: <span class="k">return</span> <span class="n">T3_SEND</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_WRITE</span>: <span class="k">return</span> <span class="n">T3_RDMA_WRITE</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_READ</span>: <span class="k">return</span> <span class="n">T3_READ_REQ</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_INV_STAG</span>: <span class="k">return</span> <span class="n">T3_LOCAL_INV</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_BIND</span>: <span class="k">return</span> <span class="n">T3_BIND_MW</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_INIT</span>: <span class="k">return</span> <span class="n">T3_RDMA_INIT</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_QP_MOD</span>: <span class="k">return</span> <span class="n">T3_QP_MOD</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T3_WR_FASTREG</span>: <span class="k">return</span> <span class="n">T3_FAST_REGISTER</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Work request id */</span>
<span class="k">union</span> <span class="n">t3_wrid</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hi</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">id0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">id1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define WRID(wrid)		(wrid.id1)</span>
<span class="cp">#define WRID_GEN(wrid)		(wrid.id0.wr_gen)</span>
<span class="cp">#define WRID_IDX(wrid)		(wrid.id0.wr_idx)</span>
<span class="cp">#define WRID_LO(wrid)		(wrid.id0.wr_lo)</span>

<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">op_seop_flags</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">gen_tid_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define S_FW_RIWR_OP		24</span>
<span class="cp">#define M_FW_RIWR_OP		0xff</span>
<span class="cp">#define V_FW_RIWR_OP(x)		((x) &lt;&lt; S_FW_RIWR_OP)</span>
<span class="cp">#define G_FW_RIWR_OP(x)	((((x) &gt;&gt; S_FW_RIWR_OP)) &amp; M_FW_RIWR_OP)</span>

<span class="cp">#define S_FW_RIWR_SOPEOP	22</span>
<span class="cp">#define M_FW_RIWR_SOPEOP	0x3</span>
<span class="cp">#define V_FW_RIWR_SOPEOP(x)	((x) &lt;&lt; S_FW_RIWR_SOPEOP)</span>

<span class="cp">#define S_FW_RIWR_FLAGS		8</span>
<span class="cp">#define M_FW_RIWR_FLAGS		0x3fffff</span>
<span class="cp">#define V_FW_RIWR_FLAGS(x)	((x) &lt;&lt; S_FW_RIWR_FLAGS)</span>
<span class="cp">#define G_FW_RIWR_FLAGS(x)	((((x) &gt;&gt; S_FW_RIWR_FLAGS)) &amp; M_FW_RIWR_FLAGS)</span>

<span class="cp">#define S_FW_RIWR_TID		8</span>
<span class="cp">#define V_FW_RIWR_TID(x)	((x) &lt;&lt; S_FW_RIWR_TID)</span>

<span class="cp">#define S_FW_RIWR_LEN		0</span>
<span class="cp">#define V_FW_RIWR_LEN(x)	((x) &lt;&lt; S_FW_RIWR_LEN)</span>

<span class="cp">#define S_FW_RIWR_GEN           31</span>
<span class="cp">#define V_FW_RIWR_GEN(x)        ((x)  &lt;&lt; S_FW_RIWR_GEN)</span>

<span class="k">struct</span> <span class="n">t3_sge</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">stag</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">to</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* If num_sgle is zero, flit 5+ contains immediate data.*/</span>
<span class="k">struct</span> <span class="n">t3_send_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>

	<span class="n">u8</span> <span class="n">rdmaop</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">rem_stag</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">plen</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">num_sgle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_sge</span> <span class="n">sgl</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>	<span class="cm">/* 4+ */</span>
<span class="p">};</span>

<span class="cp">#define T3_MAX_FASTREG_DEPTH 10</span>
<span class="cp">#define T3_MAX_FASTREG_FRAG 10</span>

<span class="k">struct</span> <span class="n">t3_fastreg_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">__be32</span> <span class="n">stag</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">__be32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">va_base_hi</span><span class="p">;</span>	<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">va_base_lo_fbo</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">page_type_perms</span><span class="p">;</span> <span class="cm">/* 4 */</span>
	<span class="n">__be32</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">pbl_addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* 5+ */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * If a fastreg wr spans multiple wqes, then the 2nd fragment look like this.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">t3_pbl_frag</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="n">__be64</span> <span class="n">pbl_addrs</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>	<span class="cm">/* 1..14 */</span>
<span class="p">};</span>

<span class="cp">#define S_FR_PAGE_COUNT		24</span>
<span class="cp">#define M_FR_PAGE_COUNT		0xff</span>
<span class="cp">#define V_FR_PAGE_COUNT(x)	((x) &lt;&lt; S_FR_PAGE_COUNT)</span>
<span class="cp">#define G_FR_PAGE_COUNT(x)	((((x) &gt;&gt; S_FR_PAGE_COUNT)) &amp; M_FR_PAGE_COUNT)</span>

<span class="cp">#define S_FR_PAGE_SIZE		16</span>
<span class="cp">#define M_FR_PAGE_SIZE		0x1f</span>
<span class="cp">#define V_FR_PAGE_SIZE(x)	((x) &lt;&lt; S_FR_PAGE_SIZE)</span>
<span class="cp">#define G_FR_PAGE_SIZE(x)	((((x) &gt;&gt; S_FR_PAGE_SIZE)) &amp; M_FR_PAGE_SIZE)</span>

<span class="cp">#define S_FR_TYPE		8</span>
<span class="cp">#define M_FR_TYPE		0x1</span>
<span class="cp">#define V_FR_TYPE(x)		((x) &lt;&lt; S_FR_TYPE)</span>
<span class="cp">#define G_FR_TYPE(x)		((((x) &gt;&gt; S_FR_TYPE)) &amp; M_FR_TYPE)</span>

<span class="cp">#define S_FR_PERMS		0</span>
<span class="cp">#define M_FR_PERMS		0xff</span>
<span class="cp">#define V_FR_PERMS(x)		((x) &lt;&lt; S_FR_PERMS)</span>
<span class="cp">#define G_FR_PERMS(x)		((((x) &gt;&gt; S_FR_PERMS)) &amp; M_FR_PERMS)</span>

<span class="k">struct</span> <span class="n">t3_local_inv_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">__be32</span> <span class="n">stag</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">__be32</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_rdma_write_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">u8</span> <span class="n">rdmaop</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">stag_sink</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">to_sink</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">plen</span><span class="p">;</span>		<span class="cm">/* 4 */</span>
	<span class="n">__be32</span> <span class="n">num_sgle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_sge</span> <span class="n">sgl</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>	<span class="cm">/* 5+ */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_rdma_read_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">u8</span> <span class="n">rdmaop</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">u8</span> <span class="n">local_inv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">rem_stag</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">rem_to</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">local_stag</span><span class="p">;</span>	<span class="cm">/* 4 */</span>
	<span class="n">__be32</span> <span class="n">local_len</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">local_to</span><span class="p">;</span>	<span class="cm">/* 5 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_bind_mw_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">u16</span> <span class="n">reserved</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">perms</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">mr_stag</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">mw_stag</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">mw_len</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">mw_va</span><span class="p">;</span>		<span class="cm">/* 4 */</span>
	<span class="n">__be32</span> <span class="n">mr_pbl_addr</span><span class="p">;</span>	<span class="cm">/* 5 */</span>
	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mr_pagesz</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_receive_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">u8</span> <span class="n">pagesz</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">num_sgle</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="k">struct</span> <span class="n">t3_sge</span> <span class="n">sgl</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>	<span class="cm">/* 3+ */</span>
	<span class="n">__be32</span> <span class="n">pbl_addr</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_bypass_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_modify_qp_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">__be32</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">__be32</span> <span class="n">quiesce</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">__be32</span> <span class="n">max_ird</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">max_ord</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be64</span> <span class="n">sge_cmd</span><span class="p">;</span>		<span class="cm">/* 4 */</span>
	<span class="n">__be64</span> <span class="n">ctx1</span><span class="p">;</span>		<span class="cm">/* 5 */</span>
	<span class="n">__be64</span> <span class="n">ctx0</span><span class="p">;</span>		<span class="cm">/* 6 */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">t3_modify_qp_flags</span> <span class="p">{</span>
	<span class="n">MODQP_QUIESCE</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">MODQP_MAX_IRD</span>  <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">MODQP_MAX_ORD</span>  <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">MODQP_WRITE_EC</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">MODQP_READ_EC</span>  <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">enum</span> <span class="n">t3_mpa_attrs</span> <span class="p">{</span>
	<span class="n">uP_RI_MPA_RX_MARKER_ENABLE</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">uP_RI_MPA_TX_MARKER_ENABLE</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">uP_RI_MPA_CRC_ENABLE</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">uP_RI_MPA_IETF_ENABLE</span> <span class="o">=</span> <span class="mh">0x8</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">enum</span> <span class="n">t3_qp_caps</span> <span class="p">{</span>
	<span class="n">uP_RI_QP_RDMA_READ_ENABLE</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">uP_RI_QP_RDMA_WRITE_ENABLE</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">uP_RI_QP_BIND_ENABLE</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">uP_RI_QP_FAST_REGISTER_ENABLE</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">uP_RI_QP_STAG0_ENABLE</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">enum</span> <span class="n">rdma_init_rtr_types</span> <span class="p">{</span>
	<span class="n">RTR_READ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">RTR_WRITE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">RTR_SEND</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define S_RTR_TYPE	2</span>
<span class="cp">#define M_RTR_TYPE	0x3</span>
<span class="cp">#define V_RTR_TYPE(x)	((x) &lt;&lt; S_RTR_TYPE)</span>
<span class="cp">#define G_RTR_TYPE(x)	((((x) &gt;&gt; S_RTR_TYPE)) &amp; M_RTR_TYPE)</span>

<span class="cp">#define S_CHAN		4</span>
<span class="cp">#define M_CHAN		0x3</span>
<span class="cp">#define V_CHAN(x)	((x) &lt;&lt; S_CHAN)</span>
<span class="cp">#define G_CHAN(x)	((((x) &gt;&gt; S_CHAN)) &amp; M_CHAN)</span>

<span class="k">struct</span> <span class="n">t3_rdma_init_attr</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qpid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scqid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcqid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_size</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">t3_mpa_attrs</span> <span class="n">mpaattrs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">t3_qp_caps</span> <span class="n">qpcaps</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tcp_emss</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ord</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ird</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">qp_dma_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qp_dma_size</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rdma_init_rtr_types</span> <span class="n">rtr_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rqe_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chan</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_rdma_init_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="n">wrh</span><span class="p">;</span>	<span class="cm">/* 0 */</span>
	<span class="k">union</span> <span class="n">t3_wrid</span> <span class="n">wrid</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
	<span class="n">__be32</span> <span class="n">qpid</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">__be32</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">scqid</span><span class="p">;</span>		<span class="cm">/* 3 */</span>
	<span class="n">__be32</span> <span class="n">rcqid</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">rq_addr</span><span class="p">;</span>		<span class="cm">/* 4 */</span>
	<span class="n">__be32</span> <span class="n">rq_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mpaattrs</span><span class="p">;</span>		<span class="cm">/* 5 */</span>
	<span class="n">u8</span> <span class="n">qpcaps</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">ulpdu_size</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">flags_rtr_type</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">rqe_count</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ord</span><span class="p">;</span>		<span class="cm">/* 6 */</span>
	<span class="n">__be32</span> <span class="n">ird</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">qp_dma_addr</span><span class="p">;</span>	<span class="cm">/* 7 */</span>
	<span class="n">__be32</span> <span class="n">qp_dma_size</span><span class="p">;</span>	<span class="cm">/* 8 */</span>
	<span class="n">__be32</span> <span class="n">irs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_genbit</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">flit</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">__be64</span> <span class="n">genbit</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_wq_in_err</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">flit</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">err</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rdma_init_wr_flags</span> <span class="p">{</span>
	<span class="n">MPA_INITIATOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">),</span>
	<span class="n">PRIV_QP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">t3_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_send_wr</span> <span class="n">send</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_rdma_write_wr</span> <span class="n">write</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_rdma_read_wr</span> <span class="n">read</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_receive_wr</span> <span class="n">recv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_fastreg_wr</span> <span class="n">fastreg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_pbl_frag</span> <span class="n">pbl_frag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_local_inv_wr</span> <span class="n">local_inv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_bind_mw_wr</span> <span class="n">bind</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_bypass_wr</span> <span class="n">bypass</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_rdma_init_wr</span> <span class="n">init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_modify_qp_wr</span> <span class="n">qp_mod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_genbit</span> <span class="n">genbit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_wq_in_err</span> <span class="n">wq_in_err</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">flit</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define T3_SQ_CQE_FLIT	  13</span>
<span class="cp">#define T3_SQ_COOKIE_FLIT 14</span>

<span class="cp">#define T3_RQ_COOKIE_FLIT 13</span>
<span class="cp">#define T3_RQ_CQE_FLIT	  14</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">enum</span> <span class="n">t3_wr_opcode</span> <span class="nf">fw_riwrh_opcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="o">*</span><span class="n">wqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">G_FW_RIWR_OP</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">op_seop_flags</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">t3_wr_hdr_bits</span> <span class="p">{</span>
	<span class="n">T3_EOP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">T3_SOP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">T3_SOPEOP</span> <span class="o">=</span> <span class="n">T3_EOP</span><span class="o">|</span><span class="n">T3_SOP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">build_fw_riwrh</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">t3_wr_opcode</span> <span class="n">op</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">t3_wr_flags</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">genbit</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tid</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sopeop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">op_seop_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_OP</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">V_FW_RIWR_SOPEOP</span><span class="p">(</span><span class="n">sopeop</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">V_FW_RIWR_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">gen_tid_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_GEN</span><span class="p">(</span><span class="n">genbit</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">V_FW_RIWR_TID</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">V_FW_RIWR_LEN</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
	<span class="cm">/* 2nd gen bit... */</span>
	<span class="p">((</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">wqe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">genbit</span><span class="p">.</span><span class="n">genbit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">genbit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * T3 ULP2_TX commands</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">t3_utx_mem_op</span> <span class="p">{</span>
	<span class="n">T3_UTX_MEM_READ</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">T3_UTX_MEM_WRITE</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cm">/* T3 MC7 RDMA TPT entry format */</span>

<span class="k">enum</span> <span class="n">tpt_mem_type</span> <span class="p">{</span>
	<span class="n">TPT_NON_SHARED_MR</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">TPT_SHARED_MR</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">TPT_MW</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">TPT_MW_RELAXED_PROTECTION</span> <span class="o">=</span> <span class="mh">0x3</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tpt_addr_type</span> <span class="p">{</span>
	<span class="n">TPT_ZBTO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPT_VATO</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tpt_mem_perm</span> <span class="p">{</span>
	<span class="n">TPT_MW_BIND</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">TPT_LOCAL_READ</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">TPT_LOCAL_WRITE</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">TPT_REMOTE_READ</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">TPT_REMOTE_WRITE</span> <span class="o">=</span> <span class="mh">0x1</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpt_entry</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">valid_stag_pdid</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">flags_pagesize_qpid</span><span class="p">;</span>

	<span class="n">__be32</span> <span class="n">rsvd_pbl_addr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">va_hi</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">va_low_or_fbo</span><span class="p">;</span>

	<span class="n">__be32</span> <span class="n">rsvd_bind_cnt_or_pstag</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">rsvd_pbl_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define S_TPT_VALID		31</span>
<span class="cp">#define V_TPT_VALID(x)		((x) &lt;&lt; S_TPT_VALID)</span>
<span class="cp">#define F_TPT_VALID		V_TPT_VALID(1U)</span>

<span class="cp">#define S_TPT_STAG_KEY		23</span>
<span class="cp">#define M_TPT_STAG_KEY		0xFF</span>
<span class="cp">#define V_TPT_STAG_KEY(x)	((x) &lt;&lt; S_TPT_STAG_KEY)</span>
<span class="cp">#define G_TPT_STAG_KEY(x)	(((x) &gt;&gt; S_TPT_STAG_KEY) &amp; M_TPT_STAG_KEY)</span>

<span class="cp">#define S_TPT_STAG_STATE	22</span>
<span class="cp">#define V_TPT_STAG_STATE(x)	((x) &lt;&lt; S_TPT_STAG_STATE)</span>
<span class="cp">#define F_TPT_STAG_STATE	V_TPT_STAG_STATE(1U)</span>

<span class="cp">#define S_TPT_STAG_TYPE		20</span>
<span class="cp">#define M_TPT_STAG_TYPE		0x3</span>
<span class="cp">#define V_TPT_STAG_TYPE(x)	((x) &lt;&lt; S_TPT_STAG_TYPE)</span>
<span class="cp">#define G_TPT_STAG_TYPE(x)	(((x) &gt;&gt; S_TPT_STAG_TYPE) &amp; M_TPT_STAG_TYPE)</span>

<span class="cp">#define S_TPT_PDID		0</span>
<span class="cp">#define M_TPT_PDID		0xFFFFF</span>
<span class="cp">#define V_TPT_PDID(x)		((x) &lt;&lt; S_TPT_PDID)</span>
<span class="cp">#define G_TPT_PDID(x)		(((x) &gt;&gt; S_TPT_PDID) &amp; M_TPT_PDID)</span>

<span class="cp">#define S_TPT_PERM		28</span>
<span class="cp">#define M_TPT_PERM		0xF</span>
<span class="cp">#define V_TPT_PERM(x)		((x) &lt;&lt; S_TPT_PERM)</span>
<span class="cp">#define G_TPT_PERM(x)		(((x) &gt;&gt; S_TPT_PERM) &amp; M_TPT_PERM)</span>

<span class="cp">#define S_TPT_REM_INV_DIS	27</span>
<span class="cp">#define V_TPT_REM_INV_DIS(x)	((x) &lt;&lt; S_TPT_REM_INV_DIS)</span>
<span class="cp">#define F_TPT_REM_INV_DIS	V_TPT_REM_INV_DIS(1U)</span>

<span class="cp">#define S_TPT_ADDR_TYPE		26</span>
<span class="cp">#define V_TPT_ADDR_TYPE(x)	((x) &lt;&lt; S_TPT_ADDR_TYPE)</span>
<span class="cp">#define F_TPT_ADDR_TYPE		V_TPT_ADDR_TYPE(1U)</span>

<span class="cp">#define S_TPT_MW_BIND_ENABLE	25</span>
<span class="cp">#define V_TPT_MW_BIND_ENABLE(x)	((x) &lt;&lt; S_TPT_MW_BIND_ENABLE)</span>
<span class="cp">#define F_TPT_MW_BIND_ENABLE    V_TPT_MW_BIND_ENABLE(1U)</span>

<span class="cp">#define S_TPT_PAGE_SIZE		20</span>
<span class="cp">#define M_TPT_PAGE_SIZE		0x1F</span>
<span class="cp">#define V_TPT_PAGE_SIZE(x)	((x) &lt;&lt; S_TPT_PAGE_SIZE)</span>
<span class="cp">#define G_TPT_PAGE_SIZE(x)	(((x) &gt;&gt; S_TPT_PAGE_SIZE) &amp; M_TPT_PAGE_SIZE)</span>

<span class="cp">#define S_TPT_PBL_ADDR		0</span>
<span class="cp">#define M_TPT_PBL_ADDR		0x1FFFFFFF</span>
<span class="cp">#define V_TPT_PBL_ADDR(x)	((x) &lt;&lt; S_TPT_PBL_ADDR)</span>
<span class="cp">#define G_TPT_PBL_ADDR(x)       (((x) &gt;&gt; S_TPT_PBL_ADDR) &amp; M_TPT_PBL_ADDR)</span>

<span class="cp">#define S_TPT_QPID		0</span>
<span class="cp">#define M_TPT_QPID		0xFFFFF</span>
<span class="cp">#define V_TPT_QPID(x)		((x) &lt;&lt; S_TPT_QPID)</span>
<span class="cp">#define G_TPT_QPID(x)		(((x) &gt;&gt; S_TPT_QPID) &amp; M_TPT_QPID)</span>

<span class="cp">#define S_TPT_PSTAG		0</span>
<span class="cp">#define M_TPT_PSTAG		0xFFFFFF</span>
<span class="cp">#define V_TPT_PSTAG(x)		((x) &lt;&lt; S_TPT_PSTAG)</span>
<span class="cp">#define G_TPT_PSTAG(x)		(((x) &gt;&gt; S_TPT_PSTAG) &amp; M_TPT_PSTAG)</span>

<span class="cp">#define S_TPT_PBL_SIZE		0</span>
<span class="cp">#define M_TPT_PBL_SIZE		0xFFFFF</span>
<span class="cp">#define V_TPT_PBL_SIZE(x)	((x) &lt;&lt; S_TPT_PBL_SIZE)</span>
<span class="cp">#define G_TPT_PBL_SIZE(x)	(((x) &gt;&gt; S_TPT_PBL_SIZE) &amp; M_TPT_PBL_SIZE)</span>

<span class="cm">/*</span>
<span class="cm"> * CQE defs</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">stag</span><span class="p">;</span>
			<span class="n">__be32</span> <span class="n">msn</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">rcqe</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">wrid_hi</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">wrid_low</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">scqe</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define S_CQE_OOO	  31</span>
<span class="cp">#define M_CQE_OOO	  0x1</span>
<span class="cp">#define G_CQE_OOO(x)	  ((((x) &gt;&gt; S_CQE_OOO)) &amp; M_CQE_OOO)</span>
<span class="cp">#define V_CEQ_OOO(x)	  ((x)&lt;&lt;S_CQE_OOO)</span>

<span class="cp">#define S_CQE_QPID        12</span>
<span class="cp">#define M_CQE_QPID        0x7FFFF</span>
<span class="cp">#define G_CQE_QPID(x)     ((((x) &gt;&gt; S_CQE_QPID)) &amp; M_CQE_QPID)</span>
<span class="cp">#define V_CQE_QPID(x)	  ((x)&lt;&lt;S_CQE_QPID)</span>

<span class="cp">#define S_CQE_SWCQE       11</span>
<span class="cp">#define M_CQE_SWCQE       0x1</span>
<span class="cp">#define G_CQE_SWCQE(x)    ((((x) &gt;&gt; S_CQE_SWCQE)) &amp; M_CQE_SWCQE)</span>
<span class="cp">#define V_CQE_SWCQE(x)	  ((x)&lt;&lt;S_CQE_SWCQE)</span>

<span class="cp">#define S_CQE_GENBIT      10</span>
<span class="cp">#define M_CQE_GENBIT      0x1</span>
<span class="cp">#define G_CQE_GENBIT(x)   (((x) &gt;&gt; S_CQE_GENBIT) &amp; M_CQE_GENBIT)</span>
<span class="cp">#define V_CQE_GENBIT(x)	  ((x)&lt;&lt;S_CQE_GENBIT)</span>

<span class="cp">#define S_CQE_STATUS      5</span>
<span class="cp">#define M_CQE_STATUS      0x1F</span>
<span class="cp">#define G_CQE_STATUS(x)   ((((x) &gt;&gt; S_CQE_STATUS)) &amp; M_CQE_STATUS)</span>
<span class="cp">#define V_CQE_STATUS(x)   ((x)&lt;&lt;S_CQE_STATUS)</span>

<span class="cp">#define S_CQE_TYPE        4</span>
<span class="cp">#define M_CQE_TYPE        0x1</span>
<span class="cp">#define G_CQE_TYPE(x)     ((((x) &gt;&gt; S_CQE_TYPE)) &amp; M_CQE_TYPE)</span>
<span class="cp">#define V_CQE_TYPE(x)     ((x)&lt;&lt;S_CQE_TYPE)</span>

<span class="cp">#define S_CQE_OPCODE      0</span>
<span class="cp">#define M_CQE_OPCODE      0xF</span>
<span class="cp">#define G_CQE_OPCODE(x)   ((((x) &gt;&gt; S_CQE_OPCODE)) &amp; M_CQE_OPCODE)</span>
<span class="cp">#define V_CQE_OPCODE(x)   ((x)&lt;&lt;S_CQE_OPCODE)</span>

<span class="cp">#define SW_CQE(x)         (G_CQE_SWCQE(be32_to_cpu((x).header)))</span>
<span class="cp">#define CQE_OOO(x)        (G_CQE_OOO(be32_to_cpu((x).header)))</span>
<span class="cp">#define CQE_QPID(x)       (G_CQE_QPID(be32_to_cpu((x).header)))</span>
<span class="cp">#define CQE_GENBIT(x)     (G_CQE_GENBIT(be32_to_cpu((x).header)))</span>
<span class="cp">#define CQE_TYPE(x)       (G_CQE_TYPE(be32_to_cpu((x).header)))</span>
<span class="cp">#define SQ_TYPE(x)	  (CQE_TYPE((x)))</span>
<span class="cp">#define RQ_TYPE(x)	  (!CQE_TYPE((x)))</span>
<span class="cp">#define CQE_STATUS(x)     (G_CQE_STATUS(be32_to_cpu((x).header)))</span>
<span class="cp">#define CQE_OPCODE(x)     (G_CQE_OPCODE(be32_to_cpu((x).header)))</span>

<span class="cp">#define CQE_SEND_OPCODE(x)( \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x).header)) == T3_SEND) || \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x).header)) == T3_SEND_WITH_SE) || \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x).header)) == T3_SEND_WITH_INV) || \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x).header)) == T3_SEND_WITH_SE_INV))</span>

<span class="cp">#define CQE_LEN(x)        (be32_to_cpu((x).len))</span>

<span class="cm">/* used for RQ completion processing */</span>
<span class="cp">#define CQE_WRID_STAG(x)  (be32_to_cpu((x).u.rcqe.stag))</span>
<span class="cp">#define CQE_WRID_MSN(x)   (be32_to_cpu((x).u.rcqe.msn))</span>

<span class="cm">/* used for SQ completion processing */</span>
<span class="cp">#define CQE_WRID_SQ_WPTR(x)	((x).u.scqe.wrid_hi)</span>
<span class="cp">#define CQE_WRID_WPTR(x)	((x).u.scqe.wrid_low)</span>

<span class="cm">/* generic accessor macros */</span>
<span class="cp">#define CQE_WRID_HI(x)		((x).u.scqe.wrid_hi)</span>
<span class="cp">#define CQE_WRID_LOW(x)		((x).u.scqe.wrid_low)</span>

<span class="cp">#define TPT_ERR_SUCCESS                     0x0</span>
<span class="cp">#define TPT_ERR_STAG                        0x1	 </span><span class="cm">/* STAG invalid: either the */</span><span class="cp"></span>
						 <span class="cm">/* STAG is offlimt, being 0, */</span>
						 <span class="cm">/* or STAG_key mismatch */</span>
<span class="cp">#define TPT_ERR_PDID                        0x2	 </span><span class="cm">/* PDID mismatch */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_QPID                        0x3	 </span><span class="cm">/* QPID mismatch */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_ACCESS                      0x4	 </span><span class="cm">/* Invalid access right */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_WRAP                        0x5	 </span><span class="cm">/* Wrap error */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_BOUND                       0x6	 </span><span class="cm">/* base and bounds voilation */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_INVALIDATE_SHARED_MR        0x7	 </span><span class="cm">/* attempt to invalidate a  */</span><span class="cp"></span>
						 <span class="cm">/* shared memory region */</span>
<span class="cp">#define TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND 0x8	 </span><span class="cm">/* attempt to invalidate a  */</span><span class="cp"></span>
						 <span class="cm">/* shared memory region */</span>
<span class="cp">#define TPT_ERR_ECC                         0x9	 </span><span class="cm">/* ECC error detected */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_ECC_PSTAG                   0xA	 </span><span class="cm">/* ECC error detected when  */</span><span class="cp"></span>
						 <span class="cm">/* reading PSTAG for a MW  */</span>
						 <span class="cm">/* Invalidate */</span>
<span class="cp">#define TPT_ERR_PBL_ADDR_BOUND              0xB	 </span><span class="cm">/* pbl addr out of bounds:  */</span><span class="cp"></span>
						 <span class="cm">/* software error */</span>
<span class="cp">#define TPT_ERR_SWFLUSH			    0xC	 </span><span class="cm">/* SW FLUSHED */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_CRC                         0x10 </span><span class="cm">/* CRC error */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_MARKER                      0x11 </span><span class="cm">/* Marker error */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_PDU_LEN_ERR                 0x12 </span><span class="cm">/* invalid PDU length */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_OUT_OF_RQE                  0x13 </span><span class="cm">/* out of RQE */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_DDP_VERSION                 0x14 </span><span class="cm">/* wrong DDP version */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_RDMA_VERSION                0x15 </span><span class="cm">/* wrong RDMA version */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_OPCODE                      0x16 </span><span class="cm">/* invalid rdma opcode */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_DDP_QUEUE_NUM               0x17 </span><span class="cm">/* invalid ddp queue number */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_MSN                         0x18 </span><span class="cm">/* MSN error */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_TBIT                        0x19 </span><span class="cm">/* tag bit not set correctly */</span><span class="cp"></span>
<span class="cp">#define TPT_ERR_MO                          0x1A </span><span class="cm">/* MO not 0 for TERMINATE  */</span><span class="cp"></span>
						 <span class="cm">/* or READ_REQ */</span>
<span class="cp">#define TPT_ERR_MSN_GAP                     0x1B</span>
<span class="cp">#define TPT_ERR_MSN_RANGE                   0x1C</span>
<span class="cp">#define TPT_ERR_IRD_OVERFLOW                0x1D</span>
<span class="cp">#define TPT_ERR_RQE_ADDR_BOUND              0x1E </span><span class="cm">/* RQE addr out of bounds:  */</span><span class="cp"></span>
						 <span class="cm">/* software error */</span>
<span class="cp">#define TPT_ERR_INTERNAL_ERR                0x1F </span><span class="cm">/* internal error (opcode  */</span><span class="cp"></span>
						 <span class="cm">/* mismatch) */</span>

<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="p">{</span>
	<span class="n">__u64</span>			<span class="n">wr_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span>		<span class="n">cqe</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">sq_wptr</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">read_len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">complete</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">signaled</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_swrq</span> <span class="p">{</span>
	<span class="n">__u64</span>			<span class="n">wr_id</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">pbl_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * A T3 WQ implements both the SQ and RQ.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">t3_wq</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>		<span class="cm">/* DMA accessible memory */</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>		<span class="cm">/* DMA address for HW */</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span> <span class="cm">/* unmap kruft */</span>
	<span class="n">u32</span> <span class="n">error</span><span class="p">;</span>			<span class="cm">/* 1 once we go to ERROR */</span>
	<span class="n">u32</span> <span class="n">qpid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wptr</span><span class="p">;</span>			<span class="cm">/* idx to next available WR slot */</span>
	<span class="n">u32</span> <span class="n">size_log2</span><span class="p">;</span>			<span class="cm">/* total wq size */</span>
	<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sq</span><span class="p">;</span>		<span class="cm">/* SW SQ */</span>
	<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">oldest_read</span><span class="p">;</span>	<span class="cm">/* tracks oldest pending read */</span>
	<span class="n">u32</span> <span class="n">sq_wptr</span><span class="p">;</span>			<span class="cm">/* sq_wptr - sq_rptr == count of */</span>
	<span class="n">u32</span> <span class="n">sq_rptr</span><span class="p">;</span>			<span class="cm">/* pending wrs */</span>
	<span class="n">u32</span> <span class="n">sq_size_log2</span><span class="p">;</span>		<span class="cm">/* sq size */</span>
	<span class="k">struct</span> <span class="n">t3_swrq</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>		<span class="cm">/* SW RQ (holds consumer wr_ids */</span>
	<span class="n">u32</span> <span class="n">rq_wptr</span><span class="p">;</span>			<span class="cm">/* rq_wptr - rq_rptr == count of */</span>
	<span class="n">u32</span> <span class="n">rq_rptr</span><span class="p">;</span>			<span class="cm">/* pending wrs */</span>
	<span class="k">struct</span> <span class="n">t3_swrq</span> <span class="o">*</span><span class="n">rq_oldest_wr</span><span class="p">;</span>	<span class="cm">/* oldest wr on the SW RQ */</span>
	<span class="n">u32</span> <span class="n">rq_size_log2</span><span class="p">;</span>		<span class="cm">/* rq size */</span>
	<span class="n">u32</span> <span class="n">rq_addr</span><span class="p">;</span>			<span class="cm">/* rq adapter address */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">doorbell</span><span class="p">;</span>		<span class="cm">/* kernel db */</span>
	<span class="n">u64</span> <span class="n">udb</span><span class="p">;</span>			<span class="cm">/* user db if any */</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t3_cq</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cqid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size_log2</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">sw_queue</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sw_rptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sw_wptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define CQ_VLD_ENTRY(ptr,size_log2,cqe) (Q_GENBIT(ptr,size_log2) == \</span>
<span class="cp">					 CQE_GENBIT(*cqe))</span>

<span class="k">struct</span> <span class="n">t3_cq_status_page</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cq_err</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cxio_cq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">t3_cq_status_page</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">cq_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cxio_set_cq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">t3_cq_status_page</span> <span class="o">*</span><span class="p">)</span>
	 <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">cq_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cxio_set_wq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">wq_in_err</span><span class="p">.</span><span class="n">err</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cxio_disable_wq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">wq_in_err</span><span class="p">.</span><span class="n">err</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cxio_enable_wq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">wq_in_err</span><span class="p">.</span><span class="n">err</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cxio_wq_db_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">wq_in_err</span><span class="p">.</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="nf">cxio_next_hw_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>

	<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CQ_VLD_ENTRY</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">,</span> <span class="n">cqe</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="nf">cxio_next_sw_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="nf">cxio_next_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CQ_VLD_ENTRY</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">,</span> <span class="n">cqe</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
