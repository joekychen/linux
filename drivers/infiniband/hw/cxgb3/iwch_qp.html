<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb3 › iwch_qp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iwch_qp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &quot;iwch_provider.h&quot;</span>
<span class="cp">#include &quot;iwch.h&quot;</span>
<span class="cp">#include &quot;iwch_cm.h&quot;</span>
<span class="cp">#include &quot;cxio_hal.h&quot;</span>
<span class="cp">#include &quot;cxio_resource.h&quot;</span>

<span class="cp">#define NO_SUPPORT -1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_send</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span> <span class="n">flit_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plen</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_WR_SEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SOLICITED</span><span class="p">)</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_SEND_WITH_SE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_SEND</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rem_stag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_WR_SEND_WITH_INV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SOLICITED</span><span class="p">)</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_SEND_WITH_SE_INV</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_SEND_WITH_INV</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rem_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">T3_MAX_SGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">plen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

		<span class="n">plen</span> <span class="o">+=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">num_sgle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">);</span>
	<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">((</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_write</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">flit_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">T3_MAX_SGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_RDMA_WRITE</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">stag_sink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">to_sink</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_RDMA_WRITE_WITH_IMM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">imm_data</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">num_sgle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">plen</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plen</span> <span class="o">+=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span>
			    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span><span class="p">);</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
			    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span>
			    <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">num_sgle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">);</span>
		<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">((</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_read</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">flit_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_READ_REQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_RDMA_READ_WITH_INV</span><span class="p">)</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_inv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">rem_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">rem_to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
	<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_rdma_read_wr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_fastreg</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">flit_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">wr_cnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span> <span class="o">&gt;</span> <span class="n">T3_MAX_FASTREG_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wr_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fastreg</span><span class="p">.</span><span class="n">stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fastreg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fastreg</span><span class="p">.</span><span class="n">va_base_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">iova_start</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fastreg</span><span class="p">.</span><span class="n">va_base_lo_fbo</span> <span class="o">=</span>
				<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">iova_start</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fastreg</span><span class="p">.</span><span class="n">page_type_perms</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">V_FR_PAGE_COUNT</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FR_PAGE_SIZE</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_shift</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FR_TYPE</span><span class="p">(</span><span class="n">TPT_VATO</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FR_PERMS</span><span class="p">(</span><span class="n">iwch_ib_to_tpt_access</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">access_flags</span><span class="p">)));</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fastreg</span><span class="p">.</span><span class="n">pbl_addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* If we need a 2nd WR, then set it up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">T3_MAX_FASTREG_FRAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">wr_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">+</span>
				<span class="n">Q_PTR2IDX</span><span class="p">((</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
			<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">wqe</span><span class="p">,</span> <span class="n">T3_WR_FASTREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">wptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">),</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span> <span class="o">-</span> <span class="n">T3_MAX_FASTREG_FRAG</span><span class="p">,</span>
			       <span class="n">T3_EOP</span><span class="p">);</span>

			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">pbl_frag</span><span class="p">.</span><span class="n">pbl_addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flit_cnt</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_inv_stag</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">flit_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">local_inv</span><span class="p">.</span><span class="n">stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">local_inv</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">flit_cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_local_inv_wr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwch_sgl2pbl_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">num_sgle</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">pbl_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">page_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_sgle</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mhp</span> <span class="o">=</span> <span class="n">get_mhp</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span> <span class="o">+</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">-</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span> <span class="o">&amp;</span>
			  <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pbl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span> <span class="o">-</span>
			        <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pbl_base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span><span class="p">));</span>
		<span class="n">page_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">page_size</span><span class="p">[</span><span class="n">T3_MAX_SGE</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iwch_sgl2pbl_map</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">,</span>
			       <span class="n">page_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pagesz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pagesz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pagesz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pagesz</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">num_sgle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>

		<span class="cm">/* to in the WQE == the offset into the page */</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="cm">/* pbl_addr is the adapters address in the PBL */</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pbl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">T3_MAX_SGE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">,</span>
			     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">,</span>
			     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">pbl_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_zero_stag_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_offset</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * The T3 HW requires the PBL in the HW recv descriptor to reference</span>
<span class="cm">	 * a PBL entry.  So we allocate the max needed PBL memory here and pass</span>
<span class="cm">	 * it to the uP in the recv WR.  The uP will build the PBL and setup</span>
<span class="cm">	 * the HW recv descriptor.</span>
<span class="cm">	 */</span>
	<span class="n">pbl_addr</span> <span class="o">=</span> <span class="n">cxio_hal_pblpool_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">T3_STAG0_PBL_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbl_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the 8B aligned offset.</span>
<span class="cm">	 */</span>
	<span class="n">pbl_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbl_addr</span> <span class="o">-</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pbl_base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">num_sgle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use a 128MB page size. This and an imposed 128MB</span>
<span class="cm">		 * sge length limit allows us to require only a 2-entry HW</span>
<span class="cm">		 * PBL for each SGE.  This restriction is acceptable since</span>
<span class="cm">		 * since it is not possible to allocate 128MB of contiguous</span>
<span class="cm">		 * DMA coherent memory!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">T3_STAG0_MAX_PBE_LEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pagesz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">T3_STAG0_PAGE_SHIFT</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * T3 restricts a recv to all zero-stag or all non-zero-stag.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pbl_offset</span><span class="p">);</span>
		<span class="n">pbl_offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">T3_MAX_SGE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pagesz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">,</span>
			     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">,</span>
			     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">pbl_addr</span> <span class="o">=</span> <span class="n">pbl_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">**</span><span class="n">bad_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">t3_wr_flit_cnt</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">t3_wr_opcode</span> <span class="n">t3_wr_opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">t3_wr_flags</span> <span class="n">t3_wr_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_wrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sqp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wr_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_iwch_qp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">IWCH_QP_STATE_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">num_wrs</span> <span class="o">=</span> <span class="n">Q_FREECNT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">,</span>
		  <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_size_log2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">);</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">queue</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">t3_wr_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SOLICITED</span><span class="p">)</span>
			<span class="n">t3_wr_flags</span> <span class="o">|=</span> <span class="n">T3_SOLICITED_EVENT_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">)</span>
			<span class="n">t3_wr_flags</span> <span class="o">|=</span> <span class="n">T3_COMPLETION_FLAG</span><span class="p">;</span>
		<span class="n">sqp</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span> <span class="o">+</span>
		      <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_size_log2</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_WR_SEND</span>:
		<span class="k">case</span> <span class="n">IB_WR_SEND_WITH_INV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_FENCE</span><span class="p">)</span>
				<span class="n">t3_wr_flags</span> <span class="o">|=</span> <span class="n">T3_READ_FENCE_FLAG</span><span class="p">;</span>
			<span class="n">t3_wr_opcode</span> <span class="o">=</span> <span class="n">T3_WR_SEND</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_send</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_wr_flit_cnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_RDMA_WRITE</span>:
		<span class="k">case</span> <span class="n">IB_WR_RDMA_WRITE_WITH_IMM</span>:
			<span class="n">t3_wr_opcode</span> <span class="o">=</span> <span class="n">T3_WR_WRITE</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_write</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_wr_flit_cnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_RDMA_READ</span>:
		<span class="k">case</span> <span class="n">IB_WR_RDMA_READ_WITH_INV</span>:
			<span class="n">t3_wr_opcode</span> <span class="o">=</span> <span class="n">T3_WR_READ</span><span class="p">;</span>
			<span class="n">t3_wr_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* T3 reads are always signaled */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_read</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_wr_flit_cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">read_len</span> <span class="o">=</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">oldest_read</span><span class="p">)</span>
				<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">oldest_read</span> <span class="o">=</span> <span class="n">sqp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_FAST_REG_MR</span>:
			<span class="n">t3_wr_opcode</span> <span class="o">=</span> <span class="n">T3_WR_FASTREG</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_fastreg</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_wr_flit_cnt</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">wr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_LOCAL_INV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_FENCE</span><span class="p">)</span>
				<span class="n">t3_wr_flags</span> <span class="o">|=</span> <span class="n">T3_LOCAL_FENCE_FLAG</span><span class="p">;</span>
			<span class="n">t3_wr_opcode</span> <span class="o">=</span> <span class="n">T3_WR_INV_STAG</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_inv_stag</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_wr_flit_cnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s post of type=%d TBD!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrid</span><span class="p">.</span><span class="n">id0</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">;</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">wr2opcode</span><span class="p">(</span><span class="n">t3_wr_opcode</span><span class="p">);</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">sq_wptr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">;</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">);</span>

		<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">t3_wr_opcode</span><span class="p">,</span> <span class="n">t3_wr_flags</span><span class="p">,</span>
			       <span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">),</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">t3_wr_flit_cnt</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">wr_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">T3_SOPEOP</span> <span class="o">:</span> <span class="n">T3_SOP</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cookie 0x%llx wq idx 0x%x swsq idx %ld opcode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		     <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_size_log2</span><span class="p">),</span>
		     <span class="n">sqp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="n">wr</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">num_wrs</span><span class="o">--</span><span class="p">;</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span> <span class="o">+=</span> <span class="n">wr_cnt</span><span class="p">;</span>
		<span class="o">++</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_wq_db_enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">ring_doorbell</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">qpid</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="n">wr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_post_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">**</span><span class="n">bad_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_wrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_iwch_qp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">IWCH_QP_STATE_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">num_wrs</span> <span class="o">=</span> <span class="n">Q_FREECNT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">,</span>
			    <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_size_log2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">T3_MAX_SGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">);</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">queue</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lkey</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_recv</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">build_zero_stag_recv</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">T3_WR_RCV</span><span class="p">,</span> <span class="n">T3_COMPLETION_FLAG</span><span class="p">,</span>
			       <span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">),</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_receive_wr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">T3_SOPEOP</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cookie 0x%llx idx 0x%x rq_wptr 0x%x rw_rptr 0x%x &quot;</span>
		     <span class="s">&quot;wqe %p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span>
		     <span class="n">idx</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wqe</span><span class="p">);</span>
		<span class="o">++</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">);</span>
		<span class="o">++</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">);</span>
		<span class="n">wr</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">num_wrs</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_wq_db_enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">ring_doorbell</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">qpid</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="n">wr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_bind_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_mw_bind</span> <span class="o">*</span><span class="n">mw_bind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_mw</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_wrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">t3_wr_flags</span> <span class="n">t3_wr_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sqp</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_iwch_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>
	<span class="n">mhp</span> <span class="o">=</span> <span class="n">to_iwch_mw</span><span class="p">(</span><span class="n">mw</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">IWCH_QP_STATE_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">num_wrs</span> <span class="o">=</span> <span class="n">Q_FREECNT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">,</span>
			    <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_size_log2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s: idx 0x%0x, mw 0x%p, mw_bind 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
	     <span class="n">mw</span><span class="p">,</span> <span class="n">mw_bind</span><span class="p">);</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">queue</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">t3_wr_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">)</span>
		<span class="n">t3_wr_flags</span> <span class="o">=</span> <span class="n">T3_COMPLETION_FLAG</span><span class="p">;</span>

	<span class="n">sgl</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">sgl</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="n">sgl</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">TPT_VATO</span><span class="p">;</span>

	<span class="cm">/* TBD: check perms */</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">perms</span> <span class="o">=</span> <span class="n">iwch_ib_to_tpt_bind_access</span><span class="p">(</span><span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">mw_access_flags</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">mr_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">mw_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mw</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">mw_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">mw_va</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">iwch_sgl2pbl_map</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbl_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrid</span><span class="p">.</span><span class="n">id0</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">;</span>
	<span class="n">sqp</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_size_log2</span><span class="p">);</span>
	<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
	<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">T3_BIND_MW</span><span class="p">;</span>
	<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">sq_wptr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">;</span>
	<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mw_bind</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">mr_pbl_addr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pbl_addr</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">.</span><span class="n">mr_pagesz</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">;</span>
	<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">wqe</span><span class="p">,</span> <span class="n">T3_WR_BIND</span><span class="p">,</span> <span class="n">t3_wr_flags</span><span class="p">,</span>
		       <span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_bind_mw_wr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">T3_SOPEOP</span><span class="p">);</span>
	<span class="o">++</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wptr</span><span class="p">);</span>
	<span class="o">++</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_wq_db_enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">ring_doorbell</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">qpid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">build_term_codes</span><span class="p">(</span><span class="k">struct</span> <span class="n">respQ_msg_t</span> <span class="o">*</span><span class="n">rsp_msg</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">layer_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ecode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">TPT_ERR_INTERNAL_ERR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tagged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rqtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>
		<span class="n">rqtype</span> <span class="o">=</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>
		<span class="n">send_inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_SEND_WITH_INV</span><span class="p">)</span> <span class="o">||</span>
		           <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_SEND_WITH_SE_INV</span><span class="p">);</span>
		<span class="n">tagged</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_RDMA_WRITE</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">rqtype</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_READ_RESP</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPT_ERR_STAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">send_inv</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_INV_STAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_PDID</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_SEND_WITH_INV</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_SEND_WITH_SE_INV</span><span class="p">))</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_STAG_NOT_ASSOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_QPID</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_STAG_NOT_ASSOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_ACCESS</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_ACC_VIOL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_WRAP</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_TO_WRAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_BOUND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tagged</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_TAGGED_ERR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPT_BASE_BOUNDS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_BASE_BOUNDS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_INVALIDATE_SHARED_MR</span>:
	<span class="k">case</span> <span class="n">TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_ECC</span>:
	<span class="k">case</span> <span class="n">TPT_ERR_ECC_PSTAG</span>:
	<span class="k">case</span> <span class="n">TPT_ERR_INTERNAL_ERR</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_OUT_OF_RQE</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_MSN_NOBUF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_PBL_ADDR_BOUND</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_TAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPT_BASE_BOUNDS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_CRC</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_MPA</span><span class="o">|</span><span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">MPA_CRC_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_MARKER</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_MPA</span><span class="o">|</span><span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">MPA_MARKER_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_PDU_LEN_ERR</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_MSG_TOOBIG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_DDP_VERSION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tagged</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_TAGGED_ERR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPT_INV_VERS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_VERS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_RDMA_VERSION</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_INV_VERS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_OPCODE</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_INV_OPCODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_DDP_QUEUE_NUM</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_QN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_MSN</span>:
	<span class="k">case</span> <span class="n">TPT_ERR_MSN_GAP</span>:
	<span class="k">case</span> <span class="n">TPT_ERR_MSN_RANGE</span>:
	<span class="k">case</span> <span class="n">TPT_ERR_IRD_OVERFLOW</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_MSN_RANGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_TBIT</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPT_ERR_MO</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_MO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">DDP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_post_zb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flit_cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_rdma_read_wr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s cannot send zb_read!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_rdma_read_wr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_rdma_read_wr</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_READ_REQ</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">rem_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">rem_to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">local_to</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrh</span><span class="p">.</span><span class="n">op_seop_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_OP</span><span class="p">(</span><span class="n">T3_WR_READ</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrh</span><span class="p">.</span><span class="n">gen_tid_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span><span class="o">|</span>
						<span class="n">V_FW_RIWR_LEN</span><span class="p">(</span><span class="n">flit_cnt</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This posts a TERMINATE with layer=RDMA, type=catastrophic.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwch_post_terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">respQ_msg_t</span> <span class="o">*</span><span class="n">rsp_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">terminate_message</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s cannot send TERMINATE!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">rdmaop</span> <span class="o">=</span> <span class="n">T3_TERMINATE</span><span class="p">;</span>

	<span class="cm">/* immediate data length */</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* immediate data starts here. */</span>
	<span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">terminate_message</span> <span class="o">*</span><span class="p">)</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sgl</span><span class="p">;</span>
	<span class="n">build_term_codes</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">layer_etype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">ecode</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrh</span><span class="p">.</span><span class="n">op_seop_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_OP</span><span class="p">(</span><span class="n">T3_WR_SEND</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">V_FW_RIWR_FLAGS</span><span class="p">(</span><span class="n">T3_COMPLETION_FLAG</span> <span class="o">|</span> <span class="n">T3_NOTIFY_FLAG</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrh</span><span class="p">.</span><span class="n">gen_tid_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_TID</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Assumes qhp lock is held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__flush_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwch_cq</span> <span class="o">*</span><span class="n">rchp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwch_cq</span> <span class="o">*</span><span class="n">schp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flushed</span><span class="p">;</span>


	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p rchp %p schp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">rchp</span><span class="p">,</span> <span class="n">schp</span><span class="p">);</span>
	<span class="cm">/* take a ref on the qhp since we must release the lock */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* locking hierarchy: cq lock first, then qp lock. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxio_flush_hw_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
	<span class="n">cxio_count_rcqes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">flushed</span> <span class="o">=</span> <span class="n">cxio_flush_rq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flushed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* locking hierarchy: cq lock first, then qp lock. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxio_flush_hw_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
	<span class="n">cxio_count_scqes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">flushed</span> <span class="o">=</span> <span class="n">cxio_flush_sq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flushed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* deref */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
	        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_cq</span> <span class="o">*</span><span class="n">rchp</span><span class="p">,</span> <span class="o">*</span><span class="n">schp</span><span class="p">;</span>

	<span class="n">rchp</span> <span class="o">=</span> <span class="n">get_chp</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rcq</span><span class="p">);</span>
	<span class="n">schp</span> <span class="o">=</span> <span class="n">get_chp</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">scq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxio_set_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">cxio_set_cq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">schp</span> <span class="o">!=</span> <span class="n">rchp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cxio_set_cq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span>
						   <span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">rchp</span><span class="p">,</span> <span class="n">schp</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Return count of RECV WRs posted</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="nf">iwch_rqes_posted</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">t3_wr</span> <span class="o">*</span><span class="n">wqe</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fw_riwrh_opcode</span><span class="p">((</span><span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="o">*</span><span class="p">)</span><span class="n">wqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_WR_RCV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p count %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iwch_qp_attr_mask</span> <span class="n">mask</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_rdma_init_attr</span> <span class="n">init_attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_attr</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">qpid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">qpid</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">scqid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">scq</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">rcqid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rcq</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">rq_addr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_addr</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_size_log2</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">mpaattrs</span> <span class="o">=</span> <span class="n">uP_RI_MPA_IETF_ENABLE</span> <span class="o">|</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">init_attr</span><span class="p">.</span><span class="n">qpcaps</span> <span class="o">=</span> <span class="n">uP_RI_QP_RDMA_READ_ENABLE</span> <span class="o">|</span>
			   <span class="n">uP_RI_QP_RDMA_WRITE_ENABLE</span> <span class="o">|</span>
			   <span class="n">uP_RI_QP_BIND_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span>
		<span class="n">init_attr</span><span class="p">.</span><span class="n">qpcaps</span> <span class="o">|=</span> <span class="n">uP_RI_QP_STAG0_ENABLE</span> <span class="o">|</span>
				    <span class="n">uP_RI_QP_FAST_REGISTER_ENABLE</span><span class="p">;</span>

	<span class="n">init_attr</span><span class="p">.</span><span class="n">tcp_emss</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ord</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ird</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">qp_dma_addr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">qp_dma_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">size_log2</span><span class="p">);</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">rqe_count</span> <span class="o">=</span> <span class="n">iwch_rqes_posted</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">?</span> <span class="n">MPA_INITIATOR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_attr</span><span class="p">.</span><span class="n">rtr_type</span> <span class="o">=</span> <span class="n">RTR_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_attr</span><span class="p">.</span><span class="n">ord</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span><span class="p">)</span>
			<span class="n">init_attr</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_attr</span><span class="p">.</span><span class="n">ird</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span><span class="p">)</span>
			<span class="n">init_attr</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">init_attr</span><span class="p">.</span><span class="n">rtr_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="p">.</span><span class="n">irs</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s init_attr.rq_addr 0x%x init_attr.rq_size = %d &quot;</span>
	     <span class="s">&quot;flags 0x%x qpcaps 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">init_attr</span><span class="p">.</span><span class="n">rq_addr</span><span class="p">,</span> <span class="n">init_attr</span><span class="p">.</span><span class="n">rq_size</span><span class="p">,</span>
	     <span class="n">init_attr</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">init_attr</span><span class="p">.</span><span class="n">qpcaps</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxio_rdma_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_attr</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_modify_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iwch_qp_attr_mask</span> <span class="n">mask</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">newattr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">terminate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p qpid 0x%x ep %p state %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">qpid</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">)</span> <span class="o">?</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

	<span class="cm">/* Process attr changes if in IDLE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_VALID_MODIFY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IWCH_QP_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_ENABLE_RDMA_READ</span><span class="p">)</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">enable_rdma_read</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">enable_rdma_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_ENABLE_RDMA_WRITE</span><span class="p">)</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">enable_rdma_write</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">enable_rdma_write</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_ENABLE_RDMA_BIND</span><span class="p">)</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">enable_bind</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">enable_bind</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_MAX_ORD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ord</span> <span class="o">&gt;</span>
			    <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rdma_read_qp_depth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ord</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_MAX_IRD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ird</span> <span class="o">&gt;</span>
			    <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rdma_reads_per_qp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ird</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">newattr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWCH_QP_STATE_IDLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IWCH_QP_STATE_RTS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_LLP_STREAM_HANDLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IWCH_QP_ATTR_MPA_ATTR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">;</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">llp_stream_handle</span><span class="p">;</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span><span class="p">;</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_RTS</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Ref the endpoint here and deref when we</span>
<span class="cm">			 * disassociate the endpoint from the QP.  This</span>
<span class="cm">			 * happens in CLOSING-&gt;IDLE transition or *-&gt;ERROR</span>
<span class="cm">			 * transition.</span>
<span class="cm">			 */</span>
			<span class="n">get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdma_init</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IWCH_QP_STATE_ERROR</span>:
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_ERROR</span><span class="p">;</span>
			<span class="n">flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWCH_QP_STATE_RTS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IWCH_QP_STATE_CLOSING</span>:
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_CLOSING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">abort</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
				<span class="n">get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IWCH_QP_STATE_TERMINATE</span>:
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_TERMINATE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span>
				<span class="n">cxio_set_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span>
				<span class="n">terminate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IWCH_QP_STATE_ERROR</span>:
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_ERROR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">abort</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
				<span class="n">get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWCH_QP_STATE_CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IWCH_QP_STATE_IDLE</span>:
				<span class="n">flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
				<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_IDLE</span><span class="p">;</span>
				<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
				<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IWCH_QP_STATE_ERROR</span>:
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWCH_QP_STATE_ERROR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span> <span class="o">!=</span> <span class="n">IWCH_QP_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq_wptr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq_wptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWCH_QP_STATE_TERMINATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s in a bad state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s disassociating ep %p qpid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">qpid</span><span class="p">);</span>

	<span class="cm">/* disassociate the LLP connection */</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_ERROR</span><span class="p">;</span>
	<span class="n">free</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">terminate</span><span class="p">)</span>
		<span class="n">iwch_post_terminate</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If disconnect is 1, then we need to initiate a disconnect</span>
<span class="cm">	 * on the EP.  This can be a normal close (RTS-&gt;CLOSING) or</span>
<span class="cm">	 * an abnormal close (RTS/CLOSING-&gt;ERROR).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwch_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If free is 1, then we&#39;ve disassociated the EP from the QP</span>
<span class="cm">	 * and we need to dereference the EP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="p">)</span>
		<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s exit state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
