<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb3 › cxio_hal.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cxio_hal.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>

<span class="cp">#include &quot;cxio_resource.h&quot;</span>
<span class="cp">#include &quot;cxio_hal.h&quot;</span>
<span class="cp">#include &quot;cxgb3_offload.h&quot;</span>
<span class="cp">#include &quot;sge_defs.h&quot;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rdev_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">cxio_hal_ev_callback_func_t</span> <span class="n">cxio_ev_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="nf">cxio_hal_find_rdev_by_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="nf">cxio_hal_find_rdev_by_t3cdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span> <span class="o">==</span> <span class="n">tdev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_hal_cq_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">t3_cq_opcode</span> <span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">credit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rptr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rdma_cq_op</span> <span class="n">setup</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credits</span> <span class="o">=</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">CQ_CREDIT_UPDATE</span><span class="p">)</span> <span class="o">?</span> <span class="n">credit</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">RDMA_CQ_OP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">CQ_CREDIT_UPDATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the rearm returned an index other than our current index,</span>
<span class="cm">	 * then there might be CQE&#39;s in flight (being DMA&#39;d).  We must wait</span>
<span class="cm">	 * here for them to complete or the consumer can miss a notification.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">((</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">),</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

		<span class="n">rptr</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Keep the generation correct by bumping rptr until it</span>
<span class="cm">		 * matches the index returned by the rearm - 1.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">((</span><span class="n">rptr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">rptr</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now rptr is the index for the (last) cqe that was</span>
<span class="cm">		 * in-flight at the time the HW rearmed the CQ.  We</span>
<span class="cm">		 * spin until that CQE is valid.</span>
<span class="cm">		 */</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">CQ_VLD_ENTRY</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">,</span> <span class="n">cqe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: stalled rnic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_clear_cq_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdma_cq_setup</span> <span class="n">setup</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cqid</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* NULL address */</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* disaable the CQ */</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credit_thres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">ovfl_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">RDMA_CQ_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_clear_qp_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sge_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_modify_qp_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3_modify_qp_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="o">*</span><span class="p">)</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">T3_WR_QP_MOD</span><span class="p">,</span>
		       <span class="n">T3_COMPLETION_FLAG</span> <span class="o">|</span> <span class="n">T3_NOTIFY_FLAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qpid</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
		       <span class="n">T3_SOPEOP</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MODQP_WRITE_EC</span><span class="p">);</span>
	<span class="n">sge_cmd</span> <span class="o">=</span> <span class="n">qpid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">sge_cmd</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sge_cmd</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdma_cq_setup</span> <span class="n">setup</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">))</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cqe</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* one extra page for storing cq-in-err state */</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span> <span class="o">=</span> <span class="n">cxio_hal_get_cqid</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credit_thres</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">T3A</span><span class="p">)</span>
		<span class="n">setup</span><span class="p">.</span><span class="n">ovfl_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">setup</span><span class="p">.</span><span class="n">ovfl_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">RDMA_CQ_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef notyet</span>
<span class="kt">int</span> <span class="nf">cxio_resize_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdma_cq_setup</span> <span class="n">setup</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credits</span> <span class="o">=</span> <span class="n">setup</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credit_thres</span> <span class="o">=</span> <span class="n">setup</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>	<span class="cm">/* TBD: overflow recovery */</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">ovfl_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">RDMA_CQ_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_qpid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxio_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxio_qpid_list</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qpid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">qpids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">qpids</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxio_qpid_list</span><span class="p">,</span>
				   <span class="n">entry</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">qpid</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qpid</span> <span class="o">=</span> <span class="n">cxio_hal_get_qpid</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qpid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">qpid</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpmask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">qpid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">qpids</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qpid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qpid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qpid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_qpid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpid</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">cxio_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxio_qpid_list</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qpid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qpid</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">qpid</span> <span class="o">=</span> <span class="n">qpid</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">qpids</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_release_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxio_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">nxt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxio_qpid_list</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">nxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">qpids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxio_qpid_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">qpid</span> <span class="o">&amp;</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpmask</span><span class="p">))</span>
			<span class="n">cxio_hal_put_qpid</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_init_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxio_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">qpids</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uctx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_create_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">kernel_domain</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxio_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rqsize</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_size_log2</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span> <span class="o">=</span> <span class="n">get_qpid</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_swrq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_addr</span> <span class="o">=</span> <span class="n">cxio_hal_rqtpool_alloc</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">rqsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_swsq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					     <span class="n">depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span><span class="p">),</span>
					     <span class="o">&amp;</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span><span class="p">));</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">doorbell</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">kdb_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kernel_domain</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">udb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">udbell_physbase</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span> <span class="o">&lt;&lt;</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpshift</span><span class="p">);</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qpid 0x%x doorbell 0x%p udb 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">doorbell</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">udb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">cxio_hal_rqtpool_free</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">,</span> <span class="n">rqsize</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">put_qpid</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_clear_cq_ctx</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">))</span>
			  <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cqe</span><span class="p">),</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
	<span class="n">cxio_hal_put_cqid</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_destroy_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">cxio_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">))</span>
			  <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span><span class="p">),</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
	<span class="n">cxio_hal_rqtpool_free</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">,</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_size_log2</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
	<span class="n">put_qpid</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_recv_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="n">cqe</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wq %p cq %p sw_rptr 0x%x sw_wptr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cqe</span><span class="p">));</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_CQE_STATUS</span><span class="p">(</span><span class="n">TPT_ERR_SWFLUSH</span><span class="p">)</span> <span class="o">|</span>
			         <span class="n">V_CQE_OPCODE</span><span class="p">(</span><span class="n">T3_SEND</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_TYPE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_QPID</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_GENBIT</span><span class="p">(</span><span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span>
						       <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">)));</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">))</span> <span class="o">=</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_flush_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wq %p cq %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>

	<span class="cm">/* flush RQ */</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s rq_rptr %u rq_wptr %u skip count %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_wptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_wptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">insert_recv_cqe</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
		<span class="n">flushed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flushed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_sq_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
		          <span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="n">cqe</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wq %p cq %p sw_rptr 0x%x sw_wptr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cqe</span><span class="p">));</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_CQE_STATUS</span><span class="p">(</span><span class="n">TPT_ERR_SWFLUSH</span><span class="p">)</span> <span class="o">|</span>
			         <span class="n">V_CQE_OPCODE</span><span class="p">(</span><span class="n">sqp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="o">|</span>
			         <span class="n">V_CQE_TYPE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			         <span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			         <span class="n">V_CQE_QPID</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">)</span> <span class="o">|</span>
			         <span class="n">V_CQE_GENBIT</span><span class="p">(</span><span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span>
						       <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">)));</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">scqe</span><span class="p">.</span><span class="n">wrid_hi</span> <span class="o">=</span> <span class="n">sqp</span><span class="o">-&gt;</span><span class="n">sq_wptr</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">))</span> <span class="o">=</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_flush_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sqp</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">sqp</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_wptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">insert_sq_cqe</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">sqp</span><span class="p">);</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sqp</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>
		<span class="n">flushed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flushed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move all CQEs from the HWCQ into the SWCQ.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cxio_flush_hw_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="o">*</span><span class="n">swcqe</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p cqid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="n">cxio_next_hw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s flushing hwcq rptr 0x%x to swcq wptr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">);</span>
		<span class="n">swcqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">swcqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
		<span class="n">swcqe</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">cxio_next_hw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cqe_completes_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_TERMINATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_RDMA_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_SEND_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_wptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_count_scqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">))</span>
			<span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_count_rcqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s count zero %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">T3_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cqe_completes_wr</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="n">wq</span><span class="p">))</span>
			<span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_init_ctrl_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdma_cq_setup</span> <span class="n">setup</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* NULL address */</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* enable the CQ */</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* force SGE to redirect to RspQ and interrupt */</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">credit_thres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">ovfl_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">RDMA_CQ_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_init_ctrl_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sge_cmd</span><span class="p">,</span> <span class="n">ctx0</span><span class="p">,</span> <span class="n">ctx1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_modify_qp_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_init_ctrl_cq</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s err %d initializing ctrl_cq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">)</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s dma_alloc_coherent failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
			   <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">doorbell</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">kdb_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span><span class="p">));</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>

	<span class="cm">/* update HW Ctrl QP context */</span>
	<span class="n">base_addr</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ctx0</span> <span class="o">=</span> <span class="p">(</span><span class="n">V_EC_SIZE</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">V_EC_BASE_LO</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">ctx0</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ctx0</span> <span class="o">|=</span> <span class="n">V_EC_CREDITS</span><span class="p">(</span><span class="n">FW_WR_NUM</span><span class="p">);</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ctx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">base_addr</span><span class="p">;</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ctx1</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">V_EC_BASE_HI</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_EC_RESPQ</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_EC_TYPE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_EC_GEN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_EC_UP_TOKEN</span><span class="p">(</span><span class="n">T3_CTL_QP_TID</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_EC_VALID</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3_modify_qp_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="o">*</span><span class="p">)</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">T3_WR_QP_MOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">T3_CTL_QP_TID</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T3_SOPEOP</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MODQP_WRITE_EC</span><span class="p">);</span>
	<span class="n">sge_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_RI_SGEEC_START</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">sge_cmd</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sge_cmd</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">ctx1</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ctx1</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">ctx0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ctx0</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;CtrlQP dma_addr 0x%llx workq %p size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_destroy_ctrl_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">)</span>
			  <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">t3_wr</span><span class="p">),</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">cxio_hal_clear_qp_ctx</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">T3_CTRL_QP_ID</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write len bytes of data into addr (32B aligned address)</span>
<span class="cm"> * If data is NULL, clear len byte of memory to zero.</span>
<span class="cm"> * caller acquires the ctrl_qp lock before the call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_ctrl_qp_write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_wqe</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">copy_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wr_len</span><span class="p">,</span> <span class="n">utx_len</span><span class="p">;</span>	<span class="cm">/* length in 8 byte flit */</span>
	<span class="k">enum</span> <span class="n">t3_wr_flags</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">utx_cmd</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">&amp;=</span> <span class="mh">0x7FFFFFF</span><span class="p">;</span>
	<span class="n">nr_wqe</span> <span class="o">=</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">96</span> <span class="o">?</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">96</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">96</span><span class="p">;</span>	<span class="cm">/* 96B max per WQE */</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wptr 0x%x rptr 0x%x len %d, nr_wqe %d data %p addr 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
	     <span class="n">nr_wqe</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">utx_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* in 32B unit */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_wqe</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Q_FULL</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span>
		           <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ctrl_qp full wtpr 0x%0x rptr 0x%0x, &quot;</span>
			     <span class="s">&quot;wait for more space i %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span>
					     <span class="o">!</span><span class="n">Q_FULL</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span><span class="p">,</span>
						     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span>
						     <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ctrl_qp workq interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ctrl_qp wakeup, continue posting work request &quot;</span>
			     <span class="s">&quot;i %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span> <span class="o">+</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span> <span class="o">%</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">)));</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nr_wqe</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* last WQE */</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">T3_COMPLETION_FLAG</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">utx_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">utx_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Force a CQE to return the credit to the workq in case</span>
<span class="cm">		 * we posted more than half the max QP size of WRs</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">T3_COMPLETION_FLAG</span><span class="p">;</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s force completion at i %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* build the utx mem command */</span>
		<span class="n">wqe</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_bypass_wr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">utx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3_UTX_MEM_WRITE</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">utx_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">utx_cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">utx_len</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">utx_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">wqe</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">utx_cmd</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">++</span><span class="p">;</span>
		<span class="n">copy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">copy_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">96</span> <span class="o">?</span> <span class="mi">96</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* clear memory content if data is NULL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">copy_data</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_len</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">wqe</span><span class="p">)</span> <span class="o">+</span> <span class="n">copy_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="mi">32</span> <span class="o">-</span> <span class="p">(</span><span class="n">copy_len</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">wr_len</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_bypass_wr</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">utx_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">workq</span> <span class="o">+</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span> <span class="o">%</span>
			      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">)));</span>

		<span class="cm">/* wptr in the WRID[31:0] */</span>
		<span class="p">((</span><span class="k">union</span> <span class="n">t3_wrid</span> <span class="o">*</span><span class="p">)(</span><span class="n">wqe</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">id0</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This must be the last write with a memory barrier</span>
<span class="cm">		 * for the genbit</span>
<span class="cm">		 */</span>
		<span class="n">build_fw_riwrh</span><span class="p">((</span><span class="k">struct</span> <span class="n">fw_riwrh</span> <span class="o">*</span><span class="p">)</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">T3_WR_BP</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
			       <span class="n">Q_GENBIT</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">,</span>
					<span class="n">T3_CTRL_QP_SIZE_LOG2</span><span class="p">),</span> <span class="n">T3_CTRL_QP_ID</span><span class="p">,</span>
			       <span class="n">wr_len</span><span class="p">,</span> <span class="n">T3_SOPEOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">T3_COMPLETION_FLAG</span><span class="p">)</span>
			<span class="n">ring_doorbell</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">T3_CTRL_QP_ID</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* IN: stag key, pdid, perm, zbva, to, len, page_size, pbl_size and pbl_addr</span>
<span class="cm"> * OUT: stag index</span>
<span class="cm"> * TBD: shared memory region support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cxio_tpt_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reset_tpt_entry</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="o">*</span><span class="n">stag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stag_state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">tpt_mem_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">enum</span> <span class="n">tpt_mem_perm</span> <span class="n">perm</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">zbva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">to</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_size</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpt_entry</span> <span class="n">tpt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stag_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_fatal_error</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">stag_state</span> <span class="o">=</span> <span class="n">stag_state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stag_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">stag</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">reset_tpt_entry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">stag</span> <span class="o">!=</span> <span class="n">T3_STAG_UNSET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stag_idx</span> <span class="o">=</span> <span class="n">cxio_hal_get_stag</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stag_idx</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="p">(</span><span class="n">stag_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="n">stag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s stag_state 0x%0x type 0x%0x pdid 0x%0x, stag_idx 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">stag_state</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">stag_idx</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* write TPT entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_tpt_entry</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tpt</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">valid_stag_pdid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">F_TPT_VALID</span> <span class="o">|</span>
				<span class="n">V_TPT_STAG_KEY</span><span class="p">((</span><span class="o">*</span><span class="n">stag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M_TPT_STAG_KEY</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">V_TPT_STAG_STATE</span><span class="p">(</span><span class="n">stag_state</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">V_TPT_STAG_TYPE</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_TPT_PDID</span><span class="p">(</span><span class="n">pdid</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page_size</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">);</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">flags_pagesize_qpid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_TPT_PERM</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="n">TPT_MW_BIND</span><span class="p">)</span> <span class="o">?</span> <span class="n">F_TPT_MW_BIND_ENABLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_TPT_ADDR_TYPE</span><span class="p">((</span><span class="n">zbva</span> <span class="o">?</span> <span class="n">TPT_ZBTO</span> <span class="o">:</span> <span class="n">TPT_VATO</span><span class="p">))</span> <span class="o">|</span>
			<span class="n">V_TPT_PAGE_SIZE</span><span class="p">(</span><span class="n">page_size</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">rsvd_pbl_addr</span> <span class="o">=</span> <span class="n">reset_tpt_entry</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
				    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_TPT_PBL_ADDR</span><span class="p">(</span><span class="n">PBL_OFF</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">va_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">va_low_or_fbo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">to</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFULL</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">rsvd_bind_cnt_or_pstag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">rsvd_pbl_size</span> <span class="o">=</span> <span class="n">reset_tpt_entry</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
				  <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_TPT_PBL_SIZE</span><span class="p">(</span><span class="n">pbl_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_ctrl_qp_write_mem</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span>
				       <span class="n">stag_idx</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">tpt_base</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">tpt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tpt</span><span class="p">);</span>

	<span class="cm">/* release the stag index to free pool */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_tpt_entry</span><span class="p">)</span>
		<span class="n">cxio_hal_put_stag</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">,</span> <span class="n">stag_idx</span><span class="p">);</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span>
					     <span class="n">SEQ32_GE</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span><span class="p">,</span>
						      <span class="n">wptr</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_write_pbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">pbl</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">wptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s *pdb_addr 0x%x, pbl_base 0x%x, pbl_size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pbl_base</span><span class="p">,</span>
	     <span class="n">pbl_size</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_ctrl_qp_write_mem</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">pbl_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pbl_size</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
					 <span class="n">pbl</span><span class="p">);</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">wptr</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span>
				     <span class="n">SEQ32_GE</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span><span class="p">,</span>
					      <span class="n">wptr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_register_phys_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">tpt_mem_perm</span> <span class="n">perm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">zbva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">to</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="n">T3_STAG_UNSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__cxio_tpt_op</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">TPT_NON_SHARED_MR</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span>
			     <span class="n">zbva</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_reregister_phys_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">tpt_mem_perm</span> <span class="n">perm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">zbva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">to</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__cxio_tpt_op</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">TPT_NON_SHARED_MR</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span>
			     <span class="n">zbva</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_dereg_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__cxio_tpt_op</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">pbl_size</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_allocate_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="n">T3_STAG_UNSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__cxio_tpt_op</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">TPT_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_deallocate_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__cxio_tpt_op</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_allocate_stag</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="n">T3_STAG_UNSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__cxio_tpt_op</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">TPT_NON_SHARED_MR</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxio_rdma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_rdma_init_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_rdma_init_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s rdev_p %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="p">);</span>
	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3_rdma_init_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wrh</span><span class="p">.</span><span class="n">op_seop_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_OP</span><span class="p">(</span><span class="n">T3_WR_INIT</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wrh</span><span class="p">.</span><span class="n">gen_tid_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RIWR_TID</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">V_FW_RIWR_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wrid</span><span class="p">.</span><span class="n">id1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qpid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qpid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">scqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">scqid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rcqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">rcqid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rq_addr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">rq_addr</span> <span class="o">-</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">rqt_base</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rq_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">rq_size</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">mpaattrs</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mpaattrs</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qpcaps</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">qpcaps</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">ulpdu_size</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">tcp_emss</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rqe_count</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">rqe_count</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">flags_rtr_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|</span>
					  <span class="n">V_RTR_TYPE</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">rtr_type</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">V_CHAN</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qp_dma_addr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_dma_addr</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qp_dma_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_dma_size</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">irs</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">irs</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0=&gt;ToeQ; 1=&gt;CtrlQ */</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_register_ev_cb</span><span class="p">(</span><span class="n">cxio_hal_ev_callback_func_t</span> <span class="n">ev_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxio_ev_cb</span> <span class="o">=</span> <span class="n">ev_cb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_unregister_ev_cb</span><span class="p">(</span><span class="n">cxio_hal_ev_callback_func_t</span> <span class="n">ev_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxio_ev_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxio_hal_ev_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">respQ_msg_t</span> <span class="o">*</span><span class="n">rsp_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">respQ_msg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%d: %s cq_id 0x%x cq_ptr 0x%x genbit %0x overflow %0x an %0x&quot;</span>
	     <span class="s">&quot; se %0x notify %0x cqbranch %0x creditth %0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">cnt</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">RSPQ_CQID</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span> <span class="n">RSPQ_CQPTR</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span>
	     <span class="n">RSPQ_GENBIT</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span> <span class="n">RSPQ_OVERFLOW</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span> <span class="n">RSPQ_AN</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span>
	     <span class="n">RSPQ_SE</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span> <span class="n">RSPQ_NOTIFY</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span> <span class="n">RSPQ_CQBRANCH</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">),</span>
	     <span class="n">RSPQ_CREDIT_THRESH</span><span class="p">(</span><span class="n">rsp_msg</span><span class="p">));</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;CQE: QPID 0x%0x genbit %0x type 0x%0x status 0x%0x opcode %d &quot;</span>
	     <span class="s">&quot;len 0x%0x wrid_hi_stag 0x%x wrid_low_msn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">CQE_QPID</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_GENBIT</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span>
	     <span class="n">CQE_TYPE</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span>
	     <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_LEN</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span>
	     <span class="n">CQE_WRID_HI</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_WRID_LOW</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">));</span>
	<span class="n">rdev_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="p">)</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ulp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s called by t3cdev %p with null ulp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">t3cdev_p</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_CTRL_QP_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">rptr</span> <span class="o">=</span> <span class="n">CQE_WRID_LOW</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="n">rsp_msg</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xfff8</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cxio_ev_cb</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cxio_ev_cb</span><span class="p">)</span> <span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Caller takes care of locking if needed */</span>
<span class="kt">int</span> <span class="nf">cxio_rdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cxio_hal_find_rdev_by_name</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">netdev_p</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_p</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">netdev_p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cxio_hal_find_rdev_by_t3cdev</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">netdev_p</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">T3_MAX_DEV_NAME_LEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s t3cdev_p or dev_name must be set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev_list</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s opening rnic dev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">ctrl_qp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">)</span>
		<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span> <span class="o">=</span> <span class="n">dev2t3cdev</span><span class="p">(</span><span class="n">netdev_p</span><span class="p">);</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ulp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rdev_p</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">GET_EMBEDDED_INFO</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">fw_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s t3cdev_p(%p)-&gt;ctl returned error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_FW_VERSION_MAJOR</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">fw_info</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CXIO_FW_MAJ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;fatal firmware version mismatch: &quot;</span>
		       <span class="s">&quot;need version %u but adapter has version %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">CXIO_FW_MAJ</span><span class="p">,</span>
		       <span class="n">G_FW_VERSION_MAJOR</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">fw_info</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">RDMA_GET_PARAMS</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s t3cdev_p(%p)-&gt;ctl returned error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">GET_PORTS</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s t3cdev_p(%p)-&gt;ctl returned error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * qpshift is the number of bits to shift the qpid left in order</span>
<span class="cm">	 * to get the correct address of the doorbell for that qp.</span>
<span class="cm">	 */</span>
	<span class="n">cxio_init_ucontext</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">uctx</span><span class="p">);</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpshift</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span> <span class="o">-</span>
			  <span class="n">ilog2</span><span class="p">(</span><span class="mi">65536</span> <span class="o">&gt;&gt;</span>
			            <span class="n">ilog2</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">udbell_len</span> <span class="o">&gt;&gt;</span>
					      <span class="n">PAGE_SHIFT</span><span class="p">));</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpnr</span> <span class="o">=</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">udbell_len</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">&gt;&gt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpnr</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s rnic %s info: tpt_base 0x%0x tpt_top 0x%0x num stags %d &quot;</span>
	     <span class="s">&quot;pbl_base 0x%0x pbl_top 0x%0x rqt_base 0x%0x, rqt_top 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">tpt_base</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">tpt_top</span><span class="p">,</span> <span class="n">cxio_num_stags</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">),</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pbl_base</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">pbl_top</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">rqt_base</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">rqt_top</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;udbell_len 0x%0x udbell_physbase 0x%lx kdb_addr %p qpshift %lu &quot;</span>
	     <span class="s">&quot;qpnr %d qpmask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">udbell_len</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">udbell_physbase</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rnic_info</span><span class="p">.</span><span class="n">kdb_addr</span><span class="p">,</span>
	     <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpshift</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpnr</span><span class="p">,</span> <span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">qpmask</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_init_ctrl_qp</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s error %d initializing ctrl_qp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_init_resource</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">,</span> <span class="n">cxio_num_stags</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="n">T3_MAX_NUM_QP</span><span class="p">,</span> <span class="n">T3_MAX_NUM_CQ</span><span class="p">,</span>
				     <span class="n">T3_MAX_NUM_PD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s error %d initializing hal resources.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_pblpool_create</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s error %d initializing pbl mem pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxio_hal_rqtpool_create</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s error %d initializing rqt mem pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err4:</span>
	<span class="n">cxio_hal_pblpool_destroy</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">cxio_hal_destroy_resource</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">cxio_hal_destroy_ctrl_qp</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ulp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxio_rdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxio_hal_pblpool_destroy</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
		<span class="n">cxio_hal_rqtpool_destroy</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">cxio_hal_destroy_ctrl_qp</span><span class="p">(</span><span class="n">rdev_p</span><span class="p">);</span>
		<span class="n">cxio_hal_destroy_resource</span><span class="p">(</span><span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">rscp</span><span class="p">);</span>
		<span class="n">rdev_p</span><span class="o">-&gt;</span><span class="n">t3cdev_p</span><span class="o">-&gt;</span><span class="n">ulp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">cxio_hal_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_hal_init_rhdl_resource</span><span class="p">(</span><span class="n">T3_MAX_NUM_RI</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">t3_register_cpl_handler</span><span class="p">(</span><span class="n">CPL_ASYNC_NOTIF</span><span class="p">,</span> <span class="n">cxio_hal_ev_handler</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cxio_hal_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">t3_register_cpl_handler</span><span class="p">(</span><span class="n">CPL_ASYNC_NOTIF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="n">cxio_rdev_close</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">cxio_hal_destroy_rhdl_resource</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_completed_wrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sqp</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Q_COUNT</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_wptr</span><span class="p">);</span>

	<span class="n">sqp</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sqp</span><span class="o">-&gt;</span><span class="n">signaled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sqp</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span>  <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqp</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Insert this completed cqe into the swcq.</span>
<span class="cm">			 */</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s moving cqe into swcq sq idx %ld cq idx %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span>  <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">),</span>
			     <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">));</span>
			<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">.</span><span class="n">header</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span><span class="p">))</span>
				<span class="o">=</span> <span class="n">sqp</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">;</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_wptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_read_req_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">read_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scqe</span><span class="p">.</span><span class="n">wrid_hi</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span><span class="o">-&gt;</span><span class="n">sq_wptr</span><span class="p">;</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span><span class="o">-&gt;</span><span class="n">read_len</span><span class="p">;</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CQE_QPID</span><span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="o">|</span>
				 <span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="n">SW_CQE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="o">|</span>
				 <span class="n">V_CQE_OPCODE</span><span class="p">(</span><span class="n">T3_READ_REQ</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_TYPE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a ptr to the next read wr in the SWSQ or NULL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">advance_oldest_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span> <span class="o">-</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wptr</span> <span class="o">=</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_wptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">wptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span> <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">T3_READ_REQ</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">rptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cxio_poll_cq</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must:</span>
<span class="cm"> *     check the validity of the first CQE,</span>
<span class="cm"> *     supply the wq assicated with the qpid.</span>
<span class="cm"> *</span>
<span class="cm"> * credit: cq credit to return to sge.</span>
<span class="cm"> * cqe_flushed: 1 iff the CQE is flushed.</span>
<span class="cm"> * cqe: copy of the polled CQE.</span>
<span class="cm"> *</span>
<span class="cm"> * return value:</span>
<span class="cm"> *     0       CQE returned,</span>
<span class="cm"> *    -1       CQE skipped, try again.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxio_poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="o">*</span><span class="n">cqe_flushed</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">credit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_cqe</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">,</span> <span class="n">read_cqe</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cqe_flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">credit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw_cqe</span> <span class="o">=</span> <span class="n">cxio_next_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s CQE OOO %d qpid 0x%0x genbit %d type %d status 0x%0x&quot;</span>
	     <span class="s">&quot; opcode 0x%0x len 0x%0x wrid_hi_stag 0x%x wrid_low_msn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">CQE_OOO</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_QPID</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span>
	     <span class="n">CQE_GENBIT</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span>
	     <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_LEN</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_WRID_HI</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span>
	     <span class="n">CQE_WRID_LOW</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * skip cqe&#39;s not affiliated with a QP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Gotta tweak READ completions:</span>
<span class="cm">	 *	1) the cqe doesn&#39;t contain the sq_wptr from the wr.</span>
<span class="cm">	 *	2) opcode not reflected from the wr.</span>
<span class="cm">	 *	3) read_len not reflected from the wr.</span>
<span class="cm">	 *	4) cq_type is RQ_TYPE not SQ_TYPE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_READ_RESP</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this is an unsolicited read response, then the read</span>
<span class="cm">		 * was generated by the kernel driver as part of peer-2-peer</span>
<span class="cm">		 * connection setup.  So ignore the completion.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">oldest_read</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span>
				<span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t write to the HWCQ, so create a new read req CQE</span>
<span class="cm">		 * in local memory.</span>
<span class="cm">		 */</span>
		<span class="n">create_read_req_cqe</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">hw_cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_cqe</span><span class="p">);</span>
		<span class="n">hw_cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">read_cqe</span><span class="p">;</span>
		<span class="n">advance_oldest_read</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * T3A: Discard TERMINATE CQEs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_TERMINATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">||</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cqe_flushed</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * T3A inserts errors into the CQE.  We cannot return</span>
<span class="cm">		 * these as work completions.</span>
<span class="cm">		 */</span>
		<span class="cm">/* incoming write failures */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_RDMA_WRITE</span><span class="p">)</span>
		     <span class="o">&amp;&amp;</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* incoming read request failures */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">T3_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* incoming SEND with no receive posted failures */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CQE_SEND_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_wptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BUG_ON</span><span class="p">((</span><span class="o">*</span><span class="n">cqe_flushed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SW_CQE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">proc_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RECV completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * HW only validates 4 bits of MSN.  So we must validate that</span>
<span class="cm">		 * the MSN in the SEND is the next expected MSN.  If its not,</span>
<span class="cm">		 * then we complete this with TPT_ERR_MSN and mark the wq in</span>
<span class="cm">		 * error.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_wptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">CQE_WRID_MSN</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">wq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hw_cqe</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CQE_STATUS</span><span class="p">(</span><span class="n">TPT_ERR_MSN</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">proc_cqe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">proc_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get here its a send completion.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Handle out of order completion. These get stuffed</span>
<span class="cm">	 * in the SW SQ. Then the SW SQ is walked to move any</span>
<span class="cm">	 * now in-order completions into the SW CQ.  This handles</span>
<span class="cm">	 * 2 cases:</span>
<span class="cm">	 *	1) reaping unsignaled WRs when the first subsequent</span>
<span class="cm">	 *	   signaled WR is completed.</span>
<span class="cm">	 *	2) out of order read completions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SW_CQE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CQE_WRID_SQ_WPTR</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">t3_swsq</span> <span class="o">*</span><span class="n">sqp</span><span class="p">;</span>

		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s out of order completion going in swsq at idx %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">CQE_WRID_SQ_WPTR</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">));</span>
		<span class="n">sqp</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span> <span class="o">+</span>
		      <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">CQE_WRID_SQ_WPTR</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">);</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">cqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">;</span>
		<span class="n">sqp</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">flush_wq</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">proc_cqe:</span>
	<span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reap the associated WR(s) that are freed up with this</span>
<span class="cm">	 * completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SQ_TYPE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span> <span class="o">=</span> <span class="n">CQE_WRID_SQ_WPTR</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s completing sq idx %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_size_log2</span><span class="p">)].</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq_rptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s completing rq idx %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_size_log2</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">pbl_addr</span><span class="p">)</span>
			<span class="n">cxio_hal_pblpool_free</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">Q_PTR2IDX</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span>
				<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_size_log2</span><span class="p">)].</span><span class="n">pbl_addr</span><span class="p">,</span> <span class="n">T3_STAG0_PBL_SIZE</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">Q_EMPTY</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_wptr</span><span class="p">));</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq_rptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">flush_wq:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Flush any completed cqes that are now in-order.</span>
<span class="cm">	 */</span>
	<span class="n">flush_completed_wrs</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>

<span class="nl">skip_cqe:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SW_CQE</span><span class="p">(</span><span class="o">*</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p cqid 0x%x skip sw cqe sw_rptr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">);</span>
		<span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_rptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p cqid 0x%x skip hw cqe rptr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">);</span>
		<span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * T3A: compute credits.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">-</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size_log2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		    <span class="o">||</span> <span class="p">((</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">-</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">credit</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">-</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">;</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
