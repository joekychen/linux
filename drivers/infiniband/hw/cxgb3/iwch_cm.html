<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb3 › iwch_cm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iwch_cm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>

<span class="cp">#include &lt;net/neighbour.h&gt;</span>
<span class="cp">#include &lt;net/netevent.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>

<span class="cp">#include &quot;tcb.h&quot;</span>
<span class="cp">#include &quot;cxgb3_offload.h&quot;</span>
<span class="cp">#include &quot;iwch.h&quot;</span>
<span class="cp">#include &quot;iwch_provider.h&quot;</span>
<span class="cp">#include &quot;iwch_cm.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;listen&quot;</span><span class="p">,</span>
	<span class="s">&quot;connecting&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_wait_req&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_req_sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_req_rcvd&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_rep_sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;fpdu_mode&quot;</span><span class="p">,</span>
	<span class="s">&quot;aborting&quot;</span><span class="p">,</span>
	<span class="s">&quot;closing&quot;</span><span class="p">,</span>
	<span class="s">&quot;moribund&quot;</span><span class="p">,</span>
	<span class="s">&quot;dead&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">peer2peer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">peer2peer</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">peer2peer</span><span class="p">,</span> <span class="s">&quot;Support peer2peer ULPs (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ep_timeout_secs</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ep_timeout_secs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ep_timeout_secs</span><span class="p">,</span> <span class="s">&quot;CM Endpoint operation timeout &quot;</span>
				   <span class="s">&quot;in seconds (default=60)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpa_rev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpa_rev</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpa_rev</span><span class="p">,</span> <span class="s">&quot;MPA Revision, 0 supports amso1100, &quot;</span>
		 <span class="s">&quot;1 is spec compliant. (default=1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">markers_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">markers_enabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">markers_enabled</span><span class="p">,</span> <span class="s">&quot;Enable MPA MARKERS (default(0)=disabled)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">crc_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="s">&quot;Enable MPA CRC (default(1)=enabled)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rcv_win</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">,</span> <span class="s">&quot;TCP receive window in bytes (default=256)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_win</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">snd_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">snd_win</span><span class="p">,</span> <span class="s">&quot;TCP send window in bytes (default=32KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nocong</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nocong</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nocong</span><span class="p">,</span> <span class="s">&quot;Turn off congestion control (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cong_flavor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cong_flavor</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cong_flavor</span><span class="p">,</span> <span class="s">&quot;TCP Congestion control flavor (default=1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">workq</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">rxq</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">get_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ep_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">connect_reply_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_ep_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s stopped / restarted timer ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ep_timeout_secs</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ep_timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_ep_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s timer stopped when its not running!  ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwch_l2t_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="p">)</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">l2t_send</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">l2e</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="p">)</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hwtid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_tid_release</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_TID_RELEASE</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">;</span>
	<span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_quiesce_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_SET_TCB_FIELD</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">W_TCB_RX_QUIESCE</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">S_TCB_RX_QUIESCE</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S_TCB_RX_QUIESCE</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_resume_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_SET_TCB_FIELD</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">W_TCB_RX_QUIESCE</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">S_TCB_RX_QUIESCE</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_emss</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p opt %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">=</span> <span class="n">T3C_DATA</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">[</span><span class="n">G_TCPOPT_MSS</span><span class="p">(</span><span class="n">opt</span><span class="p">)]</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_TCPOPT_TSTAMP</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;emss=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">iwch_ep_state</span> <span class="nf">state_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iwch_ep_state</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">epc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iwch_ep_state</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">epc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iwch_ep_state</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - %s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="n">new</span><span class="p">]);</span>
	<span class="n">__state_set</span><span class="p">(</span><span class="n">epc</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_ep</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">;</span>

	<span class="n">epc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s alloc ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">epc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__free_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwch_ep_common</span><span class="p">,</span> <span class="n">kref</span><span class="p">),</span>
			  <span class="k">struct</span> <span class="n">iwch_ep</span><span class="p">,</span> <span class="n">com</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RELEASE_RESOURCES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgb3_remove_tid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_ep_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RELEASE_RESOURCES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status2errno</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_NONE</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_ARP_MISS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_TIMEDOUT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_TCAM_FULL</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_EXIST</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try and reuse skbs already allocated...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">get_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">find_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">local_ip</span><span class="p">,</span>
				 <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">local_port</span><span class="p">,</span>
				 <span class="n">__be16</span> <span class="n">peer_port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">local_ip</span><span class="p">,</span>
				   <span class="n">peer_port</span><span class="p">,</span> <span class="n">local_port</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
				   <span class="n">tos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">find_best_mtu</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">t3c_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">nmtus</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mtu</span><span class="p">)</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arp_failure_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s t3cdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle an ARP failure for an active open.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">act_open_req_arp_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;ARP failure duing connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle an ARP failure for a CPL_ABORT_REQ.  Change it into a no RST variant</span>
<span class="cm"> * and send it along.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_arp_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s t3cdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>
	<span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_halfclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_CLOSE_CON</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_CLOSE_CON_REQ</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">abort_arp_failure</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_HOST_ABORT_CON_REQ</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_REQ</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_SEND_RST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt0h</span><span class="p">,</span> <span class="n">opt0l</span><span class="p">,</span> <span class="n">opt2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wscale</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mtu_idx</span> <span class="o">=</span> <span class="n">find_best_mtu</span><span class="p">(</span><span class="n">T3C_DATA</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">),</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">));</span>
	<span class="n">wscale</span> <span class="o">=</span> <span class="n">compute_wscale</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">);</span>
	<span class="n">opt0h</span> <span class="o">=</span> <span class="n">V_NAGLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_NO_CONG</span><span class="p">(</span><span class="n">nocong</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_KEEP_ALIVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">F_TCAM_BYPASS</span> <span class="o">|</span>
	    <span class="n">V_WND_SCALE</span><span class="p">(</span><span class="n">wscale</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_MSS_IDX</span><span class="p">(</span><span class="n">mtu_idx</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_L2T_IDX</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_TX_CHANNEL</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">);</span>
	<span class="n">opt0l</span> <span class="o">=</span> <span class="n">V_TOS</span><span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M_TOS</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RCV_BUFSIZ</span><span class="p">(</span><span class="n">rcv_win</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">opt2</span> <span class="o">=</span> <span class="n">F_RX_COALESCE_VALID</span> <span class="o">|</span> <span class="n">V_RX_COALESCE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_FLAVORS_VALID</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">V_CONG_CONTROL_FLAVOR</span><span class="p">(</span><span class="n">cong_flavor</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">;</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">act_open_req_arp_failure</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ACT_OPEN_REQ</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0h</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">opt0h</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0l</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">opt0l</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt2</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">opt2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_mpa_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpalen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p pd_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="n">mpalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">=</span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mpalen</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc_enabled</span> <span class="o">?</span> <span class="n">MPA_CRC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">markers_enabled</span> <span class="o">?</span> <span class="n">MPA_MARKERS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">mpa_rev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reference the mpa skb.  This ensures the data area</span>
<span class="cm">	 * will remain in memory until the hw acks the tx.</span>
<span class="cm">	 * Function tx_ack() will deref it.</span>
<span class="cm">	 */</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_TX_DATA</span><span class="p">)</span><span class="o">|</span><span class="n">F_WR_COMPL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_PORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">V_TX_SNDBUF</span><span class="p">(</span><span class="n">snd_win</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">F_TX_INIT</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sndseq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REQ_SENT</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_mpa_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpalen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p plen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="n">mpalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mpalen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MPA_REJECT</span><span class="p">;</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">mpa_rev</span><span class="p">;</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reference the mpa skb again.  This ensures the data area</span>
<span class="cm">	 * will remain in memory until the hw acks the tx.</span>
<span class="cm">	 * Function tx_ack() will deref it.</span>
<span class="cm">	 */</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_TX_DATA</span><span class="p">)</span><span class="o">|</span><span class="n">F_WR_COMPL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mpalen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_PORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">V_TX_SNDBUF</span><span class="p">(</span><span class="n">snd_win</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">F_TX_INIT</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sndseq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_mpa_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpalen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p plen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="n">mpalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mpalen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">?</span> <span class="n">MPA_CRC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">markers_enabled</span> <span class="o">?</span> <span class="n">MPA_MARKERS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">mpa_rev</span><span class="p">;</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reference the mpa skb.  This ensures the data area</span>
<span class="cm">	 * will remain in memory until the hw acks the tx.</span>
<span class="cm">	 * Function tx_ack() will deref it.</span>
<span class="cm">	 */</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_TX_DATA</span><span class="p">)</span><span class="o">|</span><span class="n">F_WR_COMPL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_PORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">V_TX_SNDBUF</span><span class="p">(</span><span class="n">snd_win</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">F_TX_INIT</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sndseq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REP_SENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="cm">/* setup the hwtid for this connection */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">cxgb3_insert_tid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3c_client</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">set_emss</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">));</span>

	<span class="cm">/* dealloc the atid */</span>
	<span class="n">cxgb3_free_atid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>

	<span class="cm">/* start MPA negotiation */</span>
	<span class="n">send_mpa_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
	<span class="n">send_abort</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_complete_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CLOSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;close complete delivered ep %p cm_id %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">peer_close_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_DISCONNECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;peer close delivered ep %p cm_id %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">peer_abort_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CLOSE</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;abort delivered ep %p cm_id %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">connect_reply_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REPLY</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %d status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">connect_request_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REQUEST</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">);</span>
	<span class="n">event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Until ird/ord negotiation via MPAv2 support is added, send max</span>
<span class="cm">	 * supported values</span>
<span class="cm">	 */</span>
	<span class="n">event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">established_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_ESTABLISHED</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Until ird/ord negotiation via MPAv2 support is added, send max</span>
<span class="cm">	 * supported values</span>
<span class="cm">	 */</span>
	<span class="n">event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_rx_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u32</span> <span class="n">credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p credits %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;update_rx_credits - cannot alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_RX_DATA_ACK</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">credit_dack</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_RX_CREDITS</span><span class="p">(</span><span class="n">credits</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RX_FORCE_ACK</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_ACK</span><span class="p">;</span>
	<span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_mpa_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iwch_qp_attr_mask</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop mpa timer.  If it expired, then the state has</span>
<span class="cm">	 * changed and we bail since ep_timeout already aborted</span>
<span class="cm">	 * the connection.</span>
<span class="cm">	 */</span>
	<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_SENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get more than the supported amount of private data</span>
<span class="cm">	 * then we must fail this connection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * copy the new data into our accumulation buffer.</span>
<span class="cm">	 */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span><span class="p">]),</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we don&#39;t even have the mpa message, then bail.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">;</span>

	<span class="cm">/* Validate MPA header. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">mpa_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fail if there&#39;s too much private data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="n">MPA_MAX_PRIVATE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If plen does not account for pkt size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">plen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t have all the pdata yet, then bail.</span>
<span class="cm">	 * We&#39;ll continue process when more data arrives.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_REJECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get here we have accumulated the entire mpa</span>
<span class="cm">	 * start reply message including private data. And</span>
<span class="cm">	 * the MPA header is valid.</span>
<span class="cm">	 */</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">FPDU_MODE</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_CRC</span><span class="p">)</span> <span class="o">|</span> <span class="n">crc_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span> <span class="o">=</span> <span class="n">markers_enabled</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_MARKERS</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">mpa_rev</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - crc_enabled=%d, recv_marker_enabled=%d, &quot;</span>
	     <span class="s">&quot;xmit_marker_enabled=%d, version=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>

	<span class="n">attrs</span><span class="p">.</span><span class="n">mpa_attr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_RTS</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span> <span class="o">|</span>
	    <span class="n">IWCH_QP_ATTR_LLP_STREAM_HANDLE</span> <span class="o">|</span> <span class="n">IWCH_QP_ATTR_MPA_ATTR</span> <span class="o">|</span>
	    <span class="n">IWCH_QP_ATTR_MAX_IRD</span> <span class="o">|</span> <span class="n">IWCH_QP_ATTR_MAX_ORD</span><span class="p">;</span>

	<span class="cm">/* bind QP and TID with INIT_WR */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
			     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="n">iwch_rqes_posted</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwch_post_zb_read</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_mpa_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop mpa timer.  If it expired, then the state has</span>
<span class="cm">	 * changed and we bail since ep_timeout already aborted</span>
<span class="cm">	 * the connection.</span>
<span class="cm">	 */</span>
	<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_WAIT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get more than the supported amount of private data</span>
<span class="cm">	 * then we must fail this connection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s enter (%s line %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the new data into our accumulation buffer.</span>
<span class="cm">	 */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span><span class="p">]),</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t even have the mpa message, then bail.</span>
<span class="cm">	 * We&#39;ll continue process when more data arrives.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s enter (%s line %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate MPA Header.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">mpa_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fail if there&#39;s too much private data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="n">MPA_MAX_PRIVATE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If plen does not account for pkt size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">plen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t have all the pdata yet, then bail.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get here we have accumulated the entire mpa</span>
<span class="cm">	 * start reply message including private data.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_CRC</span><span class="p">)</span> <span class="o">|</span> <span class="n">crc_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span> <span class="o">=</span> <span class="n">markers_enabled</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_MARKERS</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">mpa_rev</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - crc_enabled=%d, recv_marker_enabled=%d, &quot;</span>
	     <span class="s">&quot;xmit_marker_enabled=%d, version=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REQ_RCVD</span><span class="p">);</span>

	<span class="cm">/* drive upcall */</span>
	<span class="n">connect_request_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p dlen %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">process_mpa_reply</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">process_mpa_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s Unexpected streaming data.&quot;</span>
		       <span class="s">&quot; ep %p state %d tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The ep will timeout and inform the ULP of the failure.</span>
<span class="cm">		 * See ep_timeout().</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update RX credits */</span>
	<span class="n">update_rx_credits</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Upcall from the adapter indicating data has been transmitted.</span>
<span class="cm"> * For us its just the single MPA request or reply.  We can now free</span>
<span class="cm"> * the skb holding the mpa message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_wr_ack</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">post_zb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p credits %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s 0 credit ack  ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">credits</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s rdma_init wr_ack ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s initiator ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">FPDU_MODE</span><span class="p">)</span>
				<span class="n">post_zb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s responder ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">MPA_REQ_RCVD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s lsm ack ep %p state %u freeing skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">post_zb</span><span class="p">)</span>
		<span class="n">iwch_post_zb_read</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abort_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We get 2 abort replies from the HW.  The first one must</span>
<span class="cm">	 * be ignored except for scribbling that we need one more.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">ABORT_REQ_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ep %p state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return whether a failed active open has allocated a TID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">act_open_has_tid</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_TCAM_FULL</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_CONN_EXIST</span> <span class="o">&amp;&amp;</span>
	       <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_ARP_MISS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_open_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p status %u errno %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
	     <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">T3A</span> <span class="o">&amp;&amp;</span> <span class="n">act_open_has_tid</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">release_tid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">cxgb3_free_atid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">listen_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_listen_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_open_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;t3c_listen_start failed to alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_pass_open_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_PASS_OPEN_REQ</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_netmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0h</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">F_DELACK</span> <span class="o">|</span> <span class="n">F_TCAM_BYPASS</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0l</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_RCV_BUFSIZ</span><span class="p">(</span><span class="n">rcv_win</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt1</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CONN_POLICY</span><span class="p">(</span><span class="n">CPL_CONN_POLICY_ASK</span><span class="p">));</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pass_open_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_listen_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_open_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p status %d error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
	     <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">listen_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_listen_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_listserv_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_listserv_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_CLOSE_LISTSRV_REQ</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">close_listsrv_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_listen_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_listserv_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">accept_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_pass_accept_rpl</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt0h</span><span class="p">,</span> <span class="n">opt0l</span><span class="p">,</span> <span class="n">opt2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wscale</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpl</span><span class="p">));</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mtu_idx</span> <span class="o">=</span> <span class="n">find_best_mtu</span><span class="p">(</span><span class="n">T3C_DATA</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">),</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">));</span>
	<span class="n">wscale</span> <span class="o">=</span> <span class="n">compute_wscale</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">);</span>
	<span class="n">opt0h</span> <span class="o">=</span> <span class="n">V_NAGLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_NO_CONG</span><span class="p">(</span><span class="n">nocong</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_KEEP_ALIVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">F_TCAM_BYPASS</span> <span class="o">|</span>
	    <span class="n">V_WND_SCALE</span><span class="p">(</span><span class="n">wscale</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_MSS_IDX</span><span class="p">(</span><span class="n">mtu_idx</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">V_L2T_IDX</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_TX_CHANNEL</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">);</span>
	<span class="n">opt0l</span> <span class="o">=</span> <span class="n">V_TOS</span><span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M_TOS</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RCV_BUFSIZ</span><span class="p">(</span><span class="n">rcv_win</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">opt2</span> <span class="o">=</span> <span class="n">F_RX_COALESCE_VALID</span> <span class="o">|</span> <span class="n">V_RX_COALESCE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_FLAVORS_VALID</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">V_CONG_CONTROL_FLAVOR</span><span class="p">(</span><span class="n">cong_flavor</span><span class="p">);</span>

	<span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_PASS_ACCEPT_RPL</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">peer_ip</span><span class="p">;</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt0h</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">opt0h</span><span class="p">);</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt0l_status</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">opt0l</span> <span class="o">|</span> <span class="n">CPL_PASS_OPEN_ACCEPT</span><span class="p">);</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt2</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">opt2</span><span class="p">);</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">rsvd</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt2</span><span class="p">;</span>	<span class="cm">/* workaround for HW bug */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">;</span>
	<span class="n">iwch_l2t_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reject_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s t3cdev %p tid %u peer_ip %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tdev</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">peer_ip</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span><span class="p">));</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">T3A</span><span class="p">)</span>
		<span class="n">release_tid</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpl_pass_accept_rpl</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>

		<span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">;</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
		<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_PASS_ACCEPT_RPL</span><span class="p">,</span>
						      <span class="n">hwtid</span><span class="p">));</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">peer_ip</span><span class="p">;</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt0h</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">F_TCAM_BYPASS</span><span class="p">);</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt0l_status</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">CPL_PASS_OPEN_REJECT</span><span class="p">);</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">rsvd</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt2</span><span class="p">;</span>
		<span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pass_accept_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">child_ep</span><span class="p">,</span> <span class="o">*</span><span class="n">parent_ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_accept_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwtid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iff_mac</span> <span class="n">tim</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s parent ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">parent_ep</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s - listening ep not in LISTEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the netdev for this connection request.</span>
<span class="cm">	 */</span>
	<span class="n">tim</span><span class="p">.</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">;</span>
	<span class="n">tim</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">GET_IFF_FROM_MAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tim</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">tim</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s bad dst mac %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst_mac</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find output route */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">find_route</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span><span class="p">,</span> <span class="n">G_PASS_OPEN_TOS</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_tid</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to find dst entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">l2t</span> <span class="o">=</span> <span class="n">t3_l2t_get</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to allocate l2t entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">child_ep</span> <span class="o">=</span> <span class="n">alloc_ep</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">child_ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to allocate ep entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">l2t_release</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">l2t</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CONNECTING</span><span class="p">);</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">tdev</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span><span class="p">;</span>
	<span class="n">get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span> <span class="o">=</span> <span class="n">parent_ep</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="n">G_PASS_OPEN_TOS</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_tid</span><span class="p">));</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">l2t</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">hwtid</span> <span class="o">=</span> <span class="n">hwtid</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">cxgb3_insert_tid</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3c_client</span><span class="p">,</span> <span class="n">child_ep</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">);</span>
	<span class="n">accept_cr</span><span class="p">(</span><span class="n">child_ep</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">reject:</span>
	<span class="n">reject_cr</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pass_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_establish</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">set_emss</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">));</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REQ_WAIT</span><span class="p">);</span>
	<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">peer_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_RCVD</span>:

		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re gonna mark this puppy DEAD, but keep</span>
<span class="cm">		 * the reference on it until the ULP accepts or</span>
<span class="cm">		 * rejects the CR. Also wake up anyone waiting</span>
<span class="cm">		 * in rdma connection migration (see iwch_accept_cr()).</span>
<span class="cm">		 */</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;waking up ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;waking up ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FPDU_MODE</span>:
		<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_CLOSING</span><span class="p">;</span>
		<span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
			       <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">peer_close_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MORIBUND</span><span class="p">);</span>
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_IDLE</span><span class="p">;</span>
			<span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
				       <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">iwch_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns whether an ABORT_REQ_RSS message is a negative advice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_neg_adv_abort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_RTX_NEG_ADVICE</span> <span class="o">||</span>
	       <span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_PERSIST_NEG_ADVICE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">peer_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req_rss</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rpl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_neg_adv_abort</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s neg_adv_abort ep %p tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">t3_l2t_send_event</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We get 2 peer aborts from the HW.  The first one must</span>
<span class="cm">	 * be ignored except for scribbling that we need one more.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">PEER_ABORT_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CONNECTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;waking up ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_RCVD</span>:

		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re gonna mark this puppy DEAD, but keep</span>
<span class="cm">		 * the reference on it until the ULP accepts or</span>
<span class="cm">		 * rejects the CR. Also wake up anyone waiting</span>
<span class="cm">		 * in rdma connection migration (see iwch_accept_cr()).</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;waking up ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="cm">/*FALLTHROUGH*/</span>
	<span class="k">case</span> <span class="n">FPDU_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_ERROR</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span>
				       <span class="s">&quot;%s - qp &lt;- error failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">peer_abort_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s PEER_ABORT IN DEAD STATE!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rpl_skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpl_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot allocate skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rpl_skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">rpl_skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpl</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_HOST_ABORT_CON_RPL</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_RPL</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>
	<span class="n">iwch_cxgb3_ofld_send</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">rpl_skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">close_con_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* The cm_id may be null if we failed to connect */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MORIBUND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_IDLE</span><span class="p">;</span>
			<span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
					     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
					     <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * T3A does 3 things when a TERM is received:</span>
<span class="cm"> * 1) send up a CPL_RDMA_TERMINATE message with the TERM packet</span>
<span class="cm"> * 2) generate an async event on the QP with the TERMINATE opcode</span>
<span class="cm"> * 3) post a TERMINATE opcde cqe into the associated CQ.</span>
<span class="cm"> *</span>
<span class="cm"> * For (1), we save the message in the qp for later consumer consumption.</span>
<span class="cm"> * For (2), we move the QP into TERMINATE, post a QP event and disconnect.</span>
<span class="cm"> * For (3), we toss the CQE in cxio_poll_cq().</span>
<span class="cm"> *</span>
<span class="cm"> * terminate() handles case (1)...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FPDU_MODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_rdma_terminate</span><span class="p">));</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s saving %d bytes of term msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">terminate_buffer</span><span class="p">,</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">terminate_msg_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">is_terminate_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ec_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_rdma_ec_status</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">rep</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s BAD CLOSE - Aborting tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_ERROR</span><span class="p">;</span>
		<span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
			       <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
		<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
	<span class="k">case</span> <span class="n">MORIBUND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_ERROR</span><span class="p">;</span>
			<span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s unexpected state ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_reject_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pdata_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">to_ep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">==</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_RCVD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_mpa_reject</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">pdata_len</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iwch_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_accept_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iwch_qp_attr_mask</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">to_ep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_iwch_dev</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwch_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">get_qhp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">==</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_RCVD</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rdma_read_qp_depth</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">&gt;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rdma_reads_per_qp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d ird %d ord %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>

	<span class="cm">/* bind QP to EP and move to RTS */</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">mpa_attr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">IWCH_QP_STATE_RTS</span><span class="p">;</span>

	<span class="cm">/* bind QP and TID with INIT_WR */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">IWCH_QP_ATTR_NEXT_STATE</span> <span class="o">|</span>
			     <span class="n">IWCH_QP_ATTR_LLP_STREAM_HANDLE</span> <span class="o">|</span>
			     <span class="n">IWCH_QP_ATTR_MPA_ATTR</span> <span class="o">|</span>
			     <span class="n">IWCH_QP_ATTR_MAX_IRD</span> <span class="o">|</span>
			     <span class="n">IWCH_QP_ATTR_MAX_ORD</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iwch_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
			     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="cm">/* if needed, wait for wr_ack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwch_rqes_posted</span><span class="p">(</span><span class="n">qp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">send_mpa_reply</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
			     <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>


	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">FPDU_MODE</span><span class="p">);</span>
	<span class="n">established_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err1:</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_loopback_dst</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ip_dev_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_iwch_dev</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_loopback_dst</span><span class="p">(</span><span class="n">cm_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">alloc_ep</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc ep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">),</span>
		       <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">;</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">get_qhp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qpn 0x%x qp %p cm_id %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate an active TID to initiate a TCP connection.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">=</span> <span class="n">cxgb3_alloc_atid</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3c_client</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc atid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find a route */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">find_route</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span> <span class="n">IPTOS_LOWDELAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot find route.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">t3_l2t_get</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc l2e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CONNECTING</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="n">IPTOS_LOWDELAY</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>

	<span class="cm">/* send connect request to rnic */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_connect</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">l2t_release</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="nl">fail4:</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
<span class="nl">fail3:</span>
	<span class="n">cxgb3_free_atid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_create_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_dev</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_iwch_dev</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwch_listen_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>


	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">alloc_ep</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc ep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">;</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a server TID.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span> <span class="o">=</span> <span class="n">cxgb3_alloc_stid</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">t3cdev_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3c_client</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc atid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">LISTEN</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">listen_start</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="cm">/* wait for pass_open_rpl */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fail3:</span>
	<span class="n">cxgb3_free_stid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="nl">fail1:</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_destroy_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwch_listen_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">to_listen_ep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">listen_stop</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">waitq</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_done</span><span class="p">);</span>
	<span class="n">cxgb3_free_stid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">rpl_err</span><span class="p">;</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abrupt</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p state %s, abrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
	     <span class="n">states</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">],</span> <span class="n">abrupt</span><span class="p">);</span>

	<span class="n">tdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">;</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxio_rdev</span> <span class="o">*</span><span class="p">)</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxio_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEAD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
	<span class="k">case</span> <span class="n">MPA_REQ_RCVD</span>:
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
	<span class="k">case</span> <span class="n">FPDU_MODE</span>:
		<span class="n">close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abrupt</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CLOSING</span><span class="p">;</span>
			<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CLOSE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CLOSE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abrupt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">MORIBUND</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
	<span class="k">case</span> <span class="n">ABORTING</span>:
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ignoring disconnect ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abrupt</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">send_abort</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">send_halfclose</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwch_ep_redirect</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p redirect to dst %p l2t %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span>
	     <span class="n">l2t</span><span class="p">);</span>
	<span class="n">dst_hold</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="n">l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">l2t</span><span class="p">;</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * All the CM events are handled on a work queue to have a safe context.</span>
<span class="cm"> * These are the real handlers that are called from the work queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">cxgb3_cpl_handler_func</span> <span class="n">work_handlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPL_ACT_ESTABLISH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">act_establish</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ACT_OPEN_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">act_open_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RX_DATA</span><span class="p">]</span>		<span class="o">=</span> <span class="n">rx_data</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_TX_DMA_ACK</span><span class="p">]</span>	<span class="o">=</span> <span class="n">tx_ack</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL_RSS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">abort_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL</span><span class="p">]</span>		<span class="o">=</span> <span class="n">abort_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_OPEN_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pass_open_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_LISTSRV_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">close_listsrv_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ACCEPT_REQ</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pass_accept_req</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ESTABLISH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pass_establish</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PEER_CLOSE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">peer_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_REQ_RSS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">peer_abort</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_CON_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">close_con_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RDMA_TERMINATE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">terminate</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RDMA_EC_STATUS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ec_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">tdev</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">**</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">work_handlers</span><span class="p">[</span><span class="n">G_OPCODE</span><span class="p">(</span><span class="n">ntohl</span><span class="p">((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">))](</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">)</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * ep was referenced in sched(), and is freed here.</span>
<span class="cm">		 */</span>
		<span class="n">put_ep</span><span class="p">((</span><span class="k">struct</span> <span class="n">iwch_ep_common</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">skb_work</span><span class="p">,</span> <span class="n">process_work</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sched</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwch_ep_common</span> <span class="o">*</span><span class="n">epc</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="n">get_ep</span><span class="p">(</span><span class="n">epc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save ctx and tdev in the skb-&gt;cb area.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">**</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)))</span> <span class="o">=</span> <span class="n">tdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Queue the skb and schedule the worker thread.</span>
<span class="cm">	 */</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_tcb_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;Unexpected SET_TCB_RPL status %u &quot;</span>
		       <span class="s">&quot;for tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">CPL_RET_BUF_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * All upcalls from the T3 Core go to sched() to schedule the</span>
<span class="cm"> * processing on a work queue.</span>
<span class="cm"> */</span>
<span class="n">cxgb3_cpl_handler_func</span> <span class="n">t3c_handlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPL_ACT_ESTABLISH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ACT_OPEN_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RX_DATA</span><span class="p">]</span>		<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_TX_DMA_ACK</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL_RSS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL</span><span class="p">]</span>		<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_OPEN_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_LISTSRV_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ACCEPT_REQ</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ESTABLISH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PEER_CLOSE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_CON_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_REQ_RSS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RDMA_TERMINATE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RDMA_EC_STATUS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_SET_TCB_RPL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">set_tcb_rpl</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">iwch_cm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="p">);</span>

	<span class="n">workq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;iw_cxgb3&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">workq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">iwch_cm_term</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">workq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">workq</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
