<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ocrdma › ocrdma_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ocrdma_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex RoCE Device Driver for          *</span>
<span class="cm"> * RoCE (RDMA over Converged Ethernet) CNA Adapters.              *</span>
<span class="cm"> * Copyright (C) 2008-2012 Emulex. All rights reserved.            *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_user_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_addr.h&gt;</span>

<span class="cp">#include &quot;ocrdma.h&quot;</span>
<span class="cp">#include &quot;ocrdma_hw.h&quot;</span>
<span class="cp">#include &quot;ocrdma_verbs.h&quot;</span>
<span class="cp">#include &quot;ocrdma_ah.h&quot;</span>

<span class="k">enum</span> <span class="n">mbx_status</span> <span class="p">{</span>
	<span class="n">OCRDMA_MBX_STATUS_FAILED</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_ILLEGAL_FIELD</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_OOR</span>			<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_PD</span>		<span class="o">=</span> <span class="mi">101</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_PD_INUSE</span>		<span class="o">=</span> <span class="mi">102</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_CQ</span>		<span class="o">=</span> <span class="mi">103</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_QP</span>		<span class="o">=</span> <span class="mi">104</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_LKEY</span>		<span class="o">=</span> <span class="mi">105</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_ORD_EXCEEDS</span>		<span class="o">=</span> <span class="mi">106</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_IRD_EXCEEDS</span>		<span class="o">=</span> <span class="mi">107</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SENDQ_WQE_EXCEEDS</span>	<span class="o">=</span> <span class="mi">108</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_RECVQ_RQE_EXCEEDS</span>	<span class="o">=</span> <span class="mi">109</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SGE_SEND_EXCEEDS</span>	<span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SGE_WRITE_EXCEEDS</span>	<span class="o">=</span> <span class="mi">111</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SGE_RECV_EXCEEDS</span>	<span class="o">=</span> <span class="mi">112</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_STATE_CHANGE</span>	<span class="o">=</span> <span class="mi">113</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_MW_BOUND</span>		<span class="o">=</span> <span class="mi">114</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_VA</span>		<span class="o">=</span> <span class="mi">115</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_LENGTH</span>	<span class="o">=</span> <span class="mi">116</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_FBO</span>		<span class="o">=</span> <span class="mi">117</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_ACC_RIGHTS</span>	<span class="o">=</span> <span class="mi">118</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_PBE_SIZE</span>	<span class="o">=</span> <span class="mi">119</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_PBL_ENTRY</span>	<span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_PBL_SHIFT</span>	<span class="o">=</span> <span class="mi">121</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_SRQ_ID</span>	<span class="o">=</span> <span class="mi">129</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SRQ_ERROR</span>		<span class="o">=</span> <span class="mi">133</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_RQE_EXCEEDS</span>		<span class="o">=</span> <span class="mi">134</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_MTU_EXCEEDS</span>		<span class="o">=</span> <span class="mi">135</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_MAX_QP_EXCEEDS</span>	<span class="o">=</span> <span class="mi">136</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SRQ_LIMIT_EXCEEDS</span>	<span class="o">=</span> <span class="mi">137</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_SRQ_SIZE_UNDERUNS</span>	<span class="o">=</span> <span class="mi">138</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_QP_BOUND</span>		<span class="o">=</span> <span class="mi">130</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_CHANGE</span>	<span class="o">=</span> <span class="mi">139</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_ATOMIC_OPS_UNSUP</span>	<span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_INVALID_RNR_NAK_TIMER</span>	<span class="o">=</span> <span class="mi">141</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_MW_STILL_BOUND</span>	<span class="o">=</span> <span class="mi">142</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_PKEY_INDEX_INVALID</span>	<span class="o">=</span> <span class="mi">143</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_STATUS_PKEY_INDEX_EXCEEDS</span>	<span class="o">=</span> <span class="mi">144</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">additional_status</span> <span class="p">{</span>
	<span class="n">OCRDMA_MBX_ADDI_STATUS_INSUFFICIENT_RESOURCES</span> <span class="o">=</span> <span class="mi">22</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">cqe_status</span> <span class="p">{</span>
	<span class="n">OCRDMA_MBX_CQE_STATUS_INSUFFICIENT_PRIVILEDGES</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_CQE_STATUS_INVALID_PARAMETER</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_CQE_STATUS_INSUFFICIENT_RESOURCES</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_CQE_STATUS_QUEUE_FLUSHING</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">OCRDMA_MBX_CQE_STATUS_DMA_FAILED</span>		<span class="o">=</span> <span class="mi">5</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ocrdma_get_eqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">tail</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_eqe</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ocrdma_eq_inc_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OCRDMA_EQ_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ocrdma_get_mcqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_mcqe</span> <span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mcqe</span> <span class="o">*</span><span class="p">)</span>
	    <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">tail</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mcqe</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">valid_ae_cmpl_cons</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MCQE_VALID_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqe</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ocrdma_mcq_inc_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OCRDMA_MQ_CQ_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="nf">ocrdma_get_mqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span>
				     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">head</span> <span class="o">*</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ocrdma_mq_inc_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OCRDMA_MQ_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ocrdma_get_mqe_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">tag</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="nf">get_ibqp_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">ocrdma_qp_state</span> <span class="n">qps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">qps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_RST</span>:
		<span class="k">return</span> <span class="n">IB_QPS_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_INIT</span>:
		<span class="k">return</span> <span class="n">IB_QPS_INIT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_RTR</span>:
		<span class="k">return</span> <span class="n">IB_QPS_RTR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_RTS</span>:
		<span class="k">return</span> <span class="n">IB_QPS_RTS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_SQD</span>:
	<span class="k">case</span> <span class="n">OCRDMA_QPS_SQ_DRAINING</span>:
		<span class="k">return</span> <span class="n">IB_QPS_SQD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_SQE</span>:
		<span class="k">return</span> <span class="n">IB_QPS_SQE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
		<span class="k">return</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ocrdma_qp_state</span> <span class="nf">get_ocrdma_qp_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">qps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">qps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_QPS_RESET</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_RST</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_INIT</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_INIT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_RTR</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_RTR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_RTS</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_RTS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_SQD</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_SQD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_SQE</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_SQE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_ERR</span>:
		<span class="k">return</span> <span class="n">OCRDMA_QPS_ERR</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">OCRDMA_QPS_ERR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_get_mbx_errno</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mbox_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MBX_RSP_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">OCRDMA_MBX_RSP_STATUS_SHIFT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">add_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MBX_RSP_ASTATUS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">OCRDMA_MBX_RSP_ASTATUS_SHIFT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_OOR</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_MAX_QP_EXCEEDS</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_PD</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_CQ</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_SRQ_ID</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_QP</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_CHANGE</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_MTU_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_RNR_NAK_TIMER</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_PKEY_INDEX_INVALID</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_PKEY_INDEX_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_ILLEGAL_FIELD</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_PBL_ENTRY</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_LKEY</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_VA</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_LENGTH</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_FBO</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_ACC_RIGHTS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_INVALID_PBE_SIZE</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_ATOMIC_OPS_UNSUP</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SRQ_ERROR</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SRQ_SIZE_UNDERUNS</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_PD_INUSE</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_QP_BOUND</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_MW_STILL_BOUND</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_MW_BOUND</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_RECVQ_RQE_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SGE_RECV_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_RQE_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SRQ_LIMIT_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_ORD_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_IRD_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SENDQ_WQE_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SGE_SEND_EXCEEDS</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_SGE_WRITE_EXCEEDS</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OCRDMA_MBX_STATUS_FAILED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">add_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_MBX_ADDI_STATUS_INSUFFICIENT_RESOURCES</span>:
			<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_get_mbx_cqe_errno</span><span class="p">(</span><span class="n">u16</span> <span class="n">cqe_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cqe_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OCRDMA_MBX_CQE_STATUS_INSUFFICIENT_PRIVILEDGES</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_MBX_CQE_STATUS_INVALID_PARAMETER</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_MBX_CQE_STATUS_INSUFFICIENT_RESOURCES</span>:
	<span class="k">case</span> <span class="n">OCRDMA_MBX_CQE_STATUS_QUEUE_FLUSHING</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_MBX_CQE_STATUS_DMA_FAILED</span>:
		<span class="n">err_num</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ocrdma_ring_cq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">armed</span><span class="p">,</span>
		       <span class="n">bool</span> <span class="n">solicited</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cqe_popped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_DB_CQ_RING_ID_MASK</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">cq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_DB_CQ_RING_ID_EXT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
	     <span class="n">OCRDMA_DB_CQ_RING_ID_EXT_MASK_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_DB_CQ_REARM_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">solicited</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_DB_CQ_SOLICIT_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cqe_popped</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_DB_CQ_NUM_POPPED_SHIFT</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">db</span> <span class="o">+</span> <span class="n">OCRDMA_DB_CQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_ring_mq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MQ_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_MQ_NUM_MQE_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">db</span> <span class="o">+</span> <span class="n">OCRDMA_DB_MQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_ring_eq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">eq_id</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clear_int</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_eqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">eq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_EQ_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">eq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_EQ_ID_EXT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_EQ_ID_EXT_MASK_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_REARM_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_int</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_EQ_CLR_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_EQ_TYPE_SHIFT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">num_eqe</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_NUM_EQE_SHIFT</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">db</span> <span class="o">+</span> <span class="n">OCRDMA_DB_EQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_init_mch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mbx_hdr</span> <span class="o">*</span><span class="n">cmd_hdr</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">subsys</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">subsys_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">|</span> <span class="p">(</span><span class="n">subsys</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_MCH_SUBSYS_SHIFT</span><span class="p">));</span>
	<span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="cm">/* seconds */</span>
	<span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmd_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mbx_hdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">u8</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">mqe</span><span class="p">;</span>

	<span class="n">mqe</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mqe</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mqe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">spcl_sge_cnt_emb</span> <span class="o">|=</span>
		<span class="p">(</span><span class="n">OCRDMA_MQE_EMBEDDED</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_MQE_HDR_EMB_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">OCRDMA_MQE_HDR_EMB_MASK</span><span class="p">;</span>
	<span class="n">mqe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pyld_len</span> <span class="o">=</span> <span class="n">cmd_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe_hdr</span><span class="p">);</span>

	<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">emb_req</span><span class="p">.</span><span class="n">mch</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">OCRDMA_SUBSYS_ROCE</span><span class="p">,</span>
			<span class="n">mqe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pyld_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mqe</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_free_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_alloc_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">entry_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">));</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_build_q_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_pa</span> <span class="o">*</span><span class="n">q_pa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span>
					<span class="n">dma_addr_t</span> <span class="n">host_pa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hw_page_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q_pa</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">host_pa</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">q_pa</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">host_pa</span><span class="p">);</span>
		<span class="n">host_pa</span> <span class="o">+=</span> <span class="n">hw_page_size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_assign_eq_vect_gen2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assign vector and update vector id for next EQ */</span>
	<span class="n">eq</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">start_vector</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">start_vector</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_free_eq_vect_gen2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this assumes that EQs are freed in exactly reverse order</span>
<span class="cm">	 * as its allocation.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">start_vector</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_delete_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">queue_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_delete_q_req</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QTYPE_MCCQ</span>:
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OCRDMA_CMD_DELETE_MQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_CQ</span>:
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OCRDMA_CMD_DELETE_CQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_EQ</span>:
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OCRDMA_CMD_DELETE_EQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_roce_mcc_cmd</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_create_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_eq_req</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_eq_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">OCRDMA_CMD_CREATE_EQ</span><span class="p">,</span> <span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsvd_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsvd_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_EQ_VALID</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_EQ_CNT_SHIFT</span><span class="p">;</span>

	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
			     <span class="n">PAGE_SIZE_4K</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_roce_mcc_cmd</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">vector_eqid</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span>
			<span class="n">ocrdma_assign_eq_vect_gen2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">eq</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">vector_eqid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">start_vector</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_create_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">q_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_alloc_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">OCRDMA_EQ_LEN</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_eqe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_create_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">eq</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ocrdma_ring_eq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">ocrdma_free_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_get_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">intr_mode</span> <span class="o">==</span> <span class="n">BE_INTERRUPT_MODE_INTX</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">vector_list</span><span class="p">[</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ocrdma_destroy_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">created</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_mbx_delete_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_EQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span>
			<span class="n">ocrdma_free_eq_vect_gen2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ocrdma_free_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_destroy_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* disarm EQ so that interrupts are not generated</span>
<span class="cm">	 * during freeing and EQ delete is in progress.</span>
<span class="cm">	 */</span>
	<span class="n">ocrdma_ring_eq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">ocrdma_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">eq</span><span class="p">);</span>
	<span class="n">_ocrdma_destroy_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_destroy_qp_eqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* deallocate the data path eqs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ocrdma_destroy_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_mq_cq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_cq_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_cq_cmd_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">OCRDMA_CMD_CREATE_CQ</span><span class="p">,</span>
			<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pgsz_pgcnt</span> <span class="o">=</span> <span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ev_cnt_flags</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_CQ_DEF_FLAGS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">eqn</span> <span class="o">=</span> <span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_CQ_EQID_SHIFT</span><span class="p">);</span>

	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pgsz_pgcnt</span><span class="p">,</span>
			     <span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">PAGE_SIZE_4K</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_roce_mcc_cmd</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_CQ_RSP_CQ_ID_MASK</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ocrdma_encoded_q_len</span><span class="p">(</span><span class="kt">int</span> <span class="n">q_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len_encoded</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">q_len</span><span class="p">);</span>	<span class="cm">/* log2(len) + 1 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len_encoded</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">len_encoded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len_encoded</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_create_mq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_pages</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_mq_req</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_mq_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pa</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">OCRDMA_CMD_CREATE_MQ</span><span class="p">,</span>
				<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">num_pages</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">async_cqid_valid</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_MQ_ASYNC_CQ_VALID</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">async_cqid_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">cqid_ringsize</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ocrdma_encoded_q_len</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					     <span class="n">OCRDMA_CREATE_MQ_RING_SIZE_SHIFT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">cqid_ringsize</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_MQ_V0_CQ_ID_SHIFT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_MQ_VALID</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v0</span><span class="p">.</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">OCRDMA_CMD_CREATE_MQ_EXT</span><span class="p">,</span>
				<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsvd_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">cqid_pages</span> <span class="o">=</span> <span class="n">num_pages</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">cqid_pages</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_MQ_CQ_ID_SHIFT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">async_cqid_valid</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_MQ_ASYNC_CQ_VALID</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">async_event_bitmap</span> <span class="o">=</span> <span class="n">Bit</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">async_cqid_ringsize</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">async_cqid_ringsize</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ocrdma_encoded_q_len</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					     <span class="n">OCRDMA_CREATE_MQ_RING_SIZE_SHIFT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_MQ_VALID</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">num_pages</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">PAGE_SIZE_4K</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_roce_mcc_cmd</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">mq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_create_mq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Alloc completion queue for Mailbox queue */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_alloc_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">,</span> <span class="n">OCRDMA_MQ_CQ_LEN</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mcqe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_mq_cq_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">.</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_cq_free</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">));</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_wait</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Alloc Mailbox queue */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_alloc_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">,</span> <span class="n">OCRDMA_MQ_LEN</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_cq_destroy</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_create_mq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_q_free</span><span class="p">;</span>
	<span class="n">ocrdma_ring_cq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">mbx_q_free:</span>
	<span class="n">ocrdma_free_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">);</span>
<span class="nl">mbx_cq_destroy:</span>
	<span class="n">ocrdma_mbx_delete_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
<span class="nl">mbx_cq_free:</span>
	<span class="n">ocrdma_free_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">);</span>
<span class="nl">alloc_err:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_destroy_mq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="o">*</span><span class="n">mbxq</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>

	<span class="cm">/* mqe_ctx lock synchronizes with any other pending cmds. */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mbxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbxq</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_mbx_delete_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mbxq</span><span class="p">,</span> <span class="n">QTYPE_MCCQ</span><span class="p">);</span>
		<span class="n">ocrdma_free_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mbxq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_mbx_delete_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
		<span class="n">ocrdma_free_q</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_process_qpcat_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">new_ib_qps</span> <span class="o">=</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">old_ib_qps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">ocrdma_qp_state_machine</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">new_ib_qps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_ib_qps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_dispatch_ibevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ocrdma_ae_mcqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">ib_evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cq_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qp_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srq_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">valid_ae_event</span> <span class="o">&amp;</span> <span class="n">OCRDMA_AE_MCQE_EVENT_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_AE_MCQE_EVENT_TYPE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">qpvalid_qpid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_AE_MCQE_QPVALID</span><span class="p">)</span>
		<span class="n">qp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_tbl</span><span class="p">[</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">qpvalid_qpid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_AE_MCQE_QPID_MASK</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">cqvalid_cqid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_AE_MCQE_CQVALID</span><span class="p">)</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq_tbl</span><span class="p">[</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">cqvalid_cqid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_AE_MCQE_CQID_MASK</span><span class="p">];</span>

	<span class="n">ib_evt</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OCRDMA_CQ_ERROR</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_CQ_ERR</span><span class="p">;</span>
		<span class="n">cq_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qp_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_CQ_OVERRUN_ERROR</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_CQ_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_CQ_QPCAT_ERROR</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_QP_FATAL</span><span class="p">;</span>
		<span class="n">ocrdma_process_qpcat_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QP_ACCESS_ERROR</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_QP_ACCESS_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QP_COMM_EST_EVENT</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_COMM_EST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_SQ_DRAINED_EVENT</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_SQ_DRAINED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_DEVICE_FATAL_EVENT</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_DEVICE_FATAL</span><span class="p">;</span>
		<span class="n">qp_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_SRQCAT_ERROR</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">srq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">ibsrq</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_SRQ_ERR</span><span class="p">;</span>
		<span class="n">srq_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qp_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_SRQ_LIMIT_EVENT</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">srq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">ibsrq</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_SRQ_LIMIT_REACHED</span><span class="p">;</span>
		<span class="n">srq_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qp_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QP_LAST_WQE_EVENT</span>:
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
		<span class="n">ib_evt</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_QP_LAST_WQE_REACHED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cq_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qp_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">srq_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() unknown type=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qp_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">event_handler</span><span class="p">)</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">event_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_evt</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">qp_context</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cq_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">event_handler</span><span class="p">)</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">event_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_evt</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srq_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">ibsrq</span><span class="p">.</span><span class="n">event_handler</span><span class="p">)</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">ibsrq</span><span class="p">.</span><span class="n">event_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_evt</span><span class="p">,</span>
						     <span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">ibsrq</span><span class="p">.</span>
						     <span class="n">srq_context</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_event</span><span class="p">)</span>
		<span class="n">ib_dispatch_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_evt</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_process_acqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ae_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* async CQE processing */</span>
	<span class="k">struct</span> <span class="n">ocrdma_ae_mcqe</span> <span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">ae_cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">evt_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">valid_ae_event</span> <span class="o">&amp;</span> <span class="n">OCRDMA_AE_MCQE_EVENT_CODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">OCRDMA_AE_MCQE_EVENT_CODE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evt_code</span> <span class="o">==</span> <span class="n">OCRDMA_ASYNC_EVE_CODE</span><span class="p">)</span>
		<span class="n">ocrdma_dispatch_ibevent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s(%d) invalid evt code=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">evt_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_process_mcqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_mcqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">tag_lo</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_done</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cqe_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span>
		     <span class="n">OCRDMA_MCQE_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_MCQE_STATUS_SHIFT</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">ext_status</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MCQE_ESTATUS_MASK</span><span class="p">)</span>
		    <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_MCQE_ESTATUS_SHIFT</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() cqe for invalid tag0x%x.expected=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">tag_lo</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mq_cq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cqe_popped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mcqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">ocrdma_get_mcqe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ocrdma_le32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">));</span>
		<span class="n">cqe_popped</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">valid_ae_cmpl_cons</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MCQE_AE_MASK</span><span class="p">)</span>
			<span class="n">ocrdma_process_acqe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">valid_ae_cmpl_cons</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MCQE_CMPL_MASK</span><span class="p">)</span>
			<span class="n">ocrdma_process_mcqe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() cqe-&gt;compl is not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mcqe</span><span class="p">));</span>
		<span class="n">ocrdma_mcq_inc_tail</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ocrdma_ring_cq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">cqe_popped</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_qp_buddy_cq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">buddy_cq_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* Go through list of QPs in error state which are using this CQ</span>
<span class="cm">	 * and invoke its callback handler to trigger CQE processing for</span>
<span class="cm">	 * error/flushed CQE. It is rare to find more than few entries in</span>
<span class="cm">	 * this list as most consumers stops after getting error CQE.</span>
<span class="cm">	 * List is traversed only once when a matching buddy cq found for a QP.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flush_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">sq_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* if wq and rq share the same cq, than comp_handler</span>
<span class="cm">		 * is already invoked.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_cq</span> <span class="o">==</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq_cq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* if completion came on sq, rq&#39;s cq is buddy cq.</span>
<span class="cm">		 * if completion came on rq, sq&#39;s cq is buddy cq.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_cq</span> <span class="o">==</span> <span class="n">cq</span><span class="p">)</span>
			<span class="n">cq</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq_cq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cq</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_cq</span><span class="p">;</span>
		<span class="n">buddy_cq_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flush_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buddy_cq_found</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_qp_cq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq_idx</span> <span class="o">&gt;=</span> <span class="n">OCRDMA_MAX_CQ</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">cq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq_tbl</span><span class="p">[</span><span class="n">cq_idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s%d invalid id=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cq_idx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">armed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">solicited</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ocrdma_ring_cq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ocrdma_qp_buddy_cq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_cq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* process the MQ-CQE. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq_id</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
		<span class="n">ocrdma_mq_cq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq_id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ocrdma_qp_cq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ocrdma_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">eq</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_eqe</span> <span class="n">eqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_eqe</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eqe_popped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cq_id</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ocrdma_get_eqe</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
		<span class="n">eqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">ocrdma_le32_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eqe</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">eqe</span><span class="p">.</span><span class="n">id_valid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_EQE_VALID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">eqe_popped</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">id_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* check whether its CQE or not. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">eqe</span><span class="p">.</span><span class="n">id_valid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_EQE_FOR_CQE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cq_id</span> <span class="o">=</span> <span class="n">eqe</span><span class="p">.</span><span class="n">id_valid</span> <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_EQE_RESOURCE_ID_SHIFT</span><span class="p">;</span>
			<span class="n">ocrdma_cq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ocrdma_eq_inc_tail</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ocrdma_ring_eq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">eqe_popped</span><span class="p">);</span>
	<span class="cm">/* Ring EQ doorbell with num_popped to 0 to enable interrupts again. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">intr_mode</span> <span class="o">==</span> <span class="n">BE_INTERRUPT_MODE_INTX</span><span class="p">)</span>
		<span class="n">ocrdma_ring_eq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_post_mqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">mqe</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mqe</span> <span class="o">=</span> <span class="n">ocrdma_get_mqe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tag_lo</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">ocrdma_copy_cpu_to_le32</span><span class="p">(</span><span class="n">mqe</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mqe</span><span class="p">));</span>
	<span class="cm">/* make sure descriptor is written before ringing doorbell */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ocrdma_mq_inc_head</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ocrdma_ring_mq_db</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_wait_mqe_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* 30 sec timeout */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_wait</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cmd_done</span> <span class="o">!=</span> <span class="nb">false</span><span class="p">),</span>
				    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">30000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* issue a mailbox command on the MQ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">mqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cqe_status</span><span class="p">,</span> <span class="n">ext_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ocrdma_post_mqe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mqe</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_wait_mqe_cmpl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">cqe_status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">cqe_status</span><span class="p">;</span>
	<span class="n">ext_status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">ext_status</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">ocrdma_get_mqe_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ocrdma_copy_le32_to_cpu</span><span class="p">(</span><span class="n">mqe</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mqe</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe_status</span> <span class="o">||</span> <span class="n">ext_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span>
		    <span class="p">(</span><span class="s">&quot;%s() opcode=0x%x, cqe_status=0x%x, ext_status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">subsys_op</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MBX_RSP_OPCODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		     <span class="n">OCRDMA_MBX_RSP_OPCODE_SHIFT</span><span class="p">,</span> <span class="n">cqe_status</span><span class="p">,</span> <span class="n">ext_status</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_get_mbx_cqe_errno</span><span class="p">(</span><span class="n">cqe_status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MBX_RSP_STATUS_MASK</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_get_mbx_errno</span><span class="p">(</span><span class="n">mqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
<span class="nl">mbx_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mqe_ctx</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ocrdma_dev_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ocrdma_mbx_query_config</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_pd</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_pd_ca_ack_delay</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_PD_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_PD_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_qp</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">qp_srq_cq_ird_ord</span> <span class="o">&amp;</span> <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_QP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_QP_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_send_sge</span> <span class="o">=</span> <span class="p">((</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_write_send_sge</span> <span class="o">&amp;</span>
			       <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_SEND_SGE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			      <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_SEND_SGE_SHIFT</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_recv_sge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_write_send_sge</span> <span class="o">&amp;</span>
			      <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_SEND_SGE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_SEND_SGE_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_srq_sge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_srq_rqe_sge</span> <span class="o">&amp;</span>
			      <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_SRQ_SGE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_SRQ_SGE_OFFSET</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_ord_per_qp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_ird_ord_per_qp</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_ORD_PER_QP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_ORD_PER_QP_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_ird_per_qp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_ird_ord_per_qp</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_IRD_PER_QP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_IRD_PER_QP_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">cq_overflow_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">qp_srq_cq_ird_ord</span> <span class="o">&amp;</span>
				    <span class="n">OCRDMA_MBX_QUERY_CFG_CQ_OVERFLOW_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_CQ_OVERFLOW_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">srq_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">qp_srq_cq_ird_ord</span> <span class="o">&amp;</span>
			       <span class="n">OCRDMA_MBX_QUERY_CFG_SRQ_SUPPORTED_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_SRQ_SUPPORTED_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_pd_ca_ack_delay</span> <span class="o">&amp;</span>
				    <span class="n">OCRDMA_MBX_QUERY_CFG_CA_ACK_DELAY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">OCRDMA_MBX_QUERY_CFG_CA_ACK_DELAY_SHIFT</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_mr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_mr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_mr_size</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ull</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_fmr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_pages_per_frmr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_pages_per_frmr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_num_mr_pbl</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_num_mr_pbl</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_cqe</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_cq_cqes_per_cq</span> <span class="o">&amp;</span>
			<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_CQES_PER_CQ_MASK</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">wqe_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">wqe_rqe_stride_max_dpp_cqs</span> <span class="o">&amp;</span>
		<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_WQE_SIZE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_WQE_SIZE_OFFSET</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">OCRDMA_WQE_STRIDE</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">rqe_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">wqe_rqe_stride_max_dpp_cqs</span> <span class="o">&amp;</span>
		<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_RQE_SIZE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_RQE_SIZE_OFFSET</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">OCRDMA_WQE_STRIDE</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">max_inline_data</span> <span class="o">=</span>
	    <span class="n">attr</span><span class="o">-&gt;</span><span class="n">wqe_size</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_hdr_wqe</span><span class="p">)</span> <span class="o">+</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_sge</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">ird_page_size</span> <span class="o">=</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_ird_pages</span> <span class="o">=</span> <span class="n">MAX_OCRDMA_IRD_PAGES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_wqe</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_wqes_rqes_per_q</span> <span class="o">&gt;&gt;</span>
		 <span class="n">OCRDMA_MBX_QUERY_CFG_MAX_WQES_PER_WQ_OFFSET</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rqe</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_wqes_rqes_per_q</span> <span class="o">&amp;</span>
		<span class="n">OCRDMA_MBX_QUERY_CFG_MAX_RQES_PER_RQ_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_check_fw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ocrdma_fw_conf_rsp</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fn_mode</span><span class="p">;</span>

	<span class="n">fn_mode</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">fn_mode</span> <span class="o">&amp;</span> <span class="n">OCRDMA_FN_MODE_RDMA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fn_mode</span> <span class="o">!=</span> <span class="n">OCRDMA_FN_MODE_RDMA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_eqid</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">base_eqid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_eq</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_eq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_cq</span> <span class="o">=</span> <span class="n">OCRDMA_MAX_CQ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* can be issued only during init time. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_query_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_fw_ver_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_GET_FW_VER</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ocrdma_init_mch</span><span class="p">((</span><span class="k">struct</span> <span class="n">ocrdma_mbx_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">OCRDMA_CMD_GET_FW_VER</span><span class="p">,</span>
			<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_fw_ver_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">running_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">running_ver</span><span class="p">));</span>
	<span class="n">ocrdma_le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">running_ver</span><span class="p">));</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* can be issued only during init time. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_query_fw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_fw_conf_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_GET_FW_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ocrdma_init_mch</span><span class="p">((</span><span class="k">struct</span> <span class="n">ocrdma_mbx_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">OCRDMA_CMD_GET_FW_CONFIG</span><span class="p">,</span>
			<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_fw_conf_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_check_fw_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_query_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mbx_query_config</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_QUERY_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mbx_query_config</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">ocrdma_get_attr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_alloc_pd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_alloc_pd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_alloc_pd_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_ALLOC_PD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enable_dpp_rsvd</span> <span class="o">|=</span> <span class="n">OCRDMA_ALLOC_PD_ENABLE_DPP</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_alloc_pd_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dpp_page_pdid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_ALLOC_PD_RSP_PDID_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dpp_page_pdid</span> <span class="o">&amp;</span> <span class="n">OCRDMA_ALLOC_PD_RSP_DPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dpp_page</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dpp_page_pdid</span> <span class="o">&gt;&gt;</span>
				<span class="n">OCRDMA_ALLOC_PD_RSP_DPP_PAGE_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">num_dpp_qp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_dealloc_pd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dealloc_pd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_DEALLOC_PD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_build_q_conf</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">num_entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry_size</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">num_pages</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">page_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem_size</span><span class="p">;</span>

	<span class="o">*</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="o">*</span><span class="n">num_entries</span><span class="p">);</span>
	<span class="n">mem_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">num_entries</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="cm">/* find the possible lowest possible multiplier */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OCRDMA_MAX_Q_PAGE_SIZE_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">OCRDMA_Q_PAGE_BASE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">OCRDMA_MAX_Q_PAGE_SIZE_CNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">mem_size</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">OCRDMA_Q_PAGE_BASE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">OCRDMA_MAX_Q_PAGES</span><span class="p">));</span>
	<span class="o">*</span><span class="n">num_pages</span> <span class="o">=</span>
	    <span class="n">mem_size</span> <span class="o">/</span> <span class="p">((</span><span class="n">OCRDMA_Q_PAGE_BASE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">OCRDMA_MAX_Q_PAGES</span><span class="p">);</span>
	<span class="o">*</span><span class="n">page_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">OCRDMA_Q_PAGE_BASE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">OCRDMA_MAX_Q_PAGES</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">mem_size</span> <span class="o">/</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_create_ah_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_ah_tbl</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_ah_tbl_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pbe</span> <span class="o">*</span><span class="n">pbes</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_CREATE_AH_TBL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">max_ah</span> <span class="o">=</span> <span class="n">OCRDMA_MAX_AH</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_av</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_ah</span><span class="p">;</span>

	<span class="cm">/* number of PBEs in PBL */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ah_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">OCRDMA_AH_TBL_PAGES</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_CREATE_AH_NUM_PAGES_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_AH_NUM_PAGES_MASK</span><span class="p">;</span>

	<span class="cm">/* page size */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OCRDMA_MAX_Q_PAGE_SIZE_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="p">(</span><span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ah_conf</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_AH_PAGE_SIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_AH_PAGE_SIZE_MASK</span><span class="p">;</span>

	<span class="cm">/* ah_entry size */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ah_conf</span> <span class="o">|=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_av</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_CREATE_AH_ENTRY_SIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_AH_ENTRY_SIZE_MASK</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mem_err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mem_err_ah</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">num_ah</span> <span class="o">=</span> <span class="n">max_ah</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">pbes</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_pbe</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">pbes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
		<span class="n">pa</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tbl_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tbl_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_ah_tbl_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">ahid</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ahid</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">mbx_err:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">mem_err_ah:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">mem_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_mbx_delete_ah_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_delete_ah_tbl</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_DELETE_AH_TBL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ahid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">ahid</span><span class="p">;</span>

	<span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Multiple CQs uses the EQ. This routine returns least used</span>
<span class="cm"> * EQ to associate with CQ. This will distributes the interrupt</span>
<span class="cm"> * processing and CPU load to associated EQ, vector and so to that CPU.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">ocrdma_bind_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">selected_eq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cq_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eq_id</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="n">cq_cnt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cq_cnt</span><span class="p">;</span>
	<span class="n">eq_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="cm">/* find the EQ which is has the least number of</span>
<span class="cm">	 * CQs associated with it.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cq_cnt</span> <span class="o">&lt;</span> <span class="n">cq_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cq_cnt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cq_cnt</span><span class="p">;</span>
			<span class="n">eq_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="n">selected_eq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">selected_eq</span><span class="p">].</span><span class="n">cq_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">eq_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_unbind_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">eq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">eq_id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cq_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dpp_cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span> <span class="kt">int</span> <span class="n">max_hw_cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_cq</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_cq_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">cqe_size</span><span class="p">,</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">cqe_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpp_cq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s(%d) max_cqe=0x%x, requester_cqe=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_cqe</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpp_cq</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">!=</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpp_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">max_hw_cqe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">max_hw_cqe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cqe_size</span> <span class="o">=</span> <span class="n">OCRDMA_DPP_CQE_SIZE</span><span class="p">;</span>
		<span class="n">hw_pages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">max_hw_cqe</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_cqe</span><span class="p">;</span>
		<span class="n">max_hw_cqe</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_cqe</span><span class="p">;</span>
		<span class="n">cqe_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_cqe</span><span class="p">);</span>
		<span class="n">hw_pages</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_CQ_MAX_PAGES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">max_hw_cqe</span> <span class="o">*</span> <span class="n">cqe_size</span><span class="p">,</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_CREATE_CQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">OCRDMA_CMD_CREATE_CQ</span><span class="p">,</span>
			<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">page_size</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="n">hw_pages</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pgsz_pgcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">OCRDMA_CREATE_CQ_PAGE_SIZE_SHIFT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pgsz_pgcnt</span> <span class="o">|=</span> <span class="n">hw_pages</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ev_cnt_flags</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_CQ_DEF_FLAGS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eq_err</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">eqn</span> <span class="o">=</span> <span class="n">ocrdma_bind_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">rsvd_version</span> <span class="o">=</span> <span class="n">OCRDMA_CREATE_CQ_VER2</span><span class="p">;</span>
	<span class="n">cqe_count</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="n">cqe_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="cm">/* Set cnt to 3 to indicate more than 1024 cq entries */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ev_cnt_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_CQ_CNT_SHIFT</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cqe_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">256</span>:
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">512</span>:
			<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1024</span>:
			<span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ev_cnt_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_CQ_CNT_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* shared eq between all the consumer cqs. */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">eqn</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">eqn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpp_cq</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pgsz_pgcnt</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_CQ_DPP</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_CREATE_CQ_TYPE_SHIFT</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">phase_change</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cqe_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="n">cqe_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cqe_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="n">cqe_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ev_cnt_flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_CQ_FLAGS_AUTO_VALID</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">phase_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">,</span> <span class="n">page_size</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_cq_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">cq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_CQ_RSP_CQ_ID_MASK</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">ocrdma_unbind_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">eqn</span><span class="p">);</span>
<span class="nl">eq_err:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">);</span>
<span class="nl">mem_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_destroy_cq</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_DELETE_CQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">ocrdma_init_mch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">OCRDMA_CMD_DELETE_CQ</span><span class="p">,</span>
			<span class="n">OCRDMA_SUBSYS_COMMON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bypass_flush_qid</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_DESTROY_CQ_QID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">OCRDMA_DESTROY_CQ_QID_MASK</span><span class="p">;</span>

	<span class="n">ocrdma_unbind_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">eqn</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">);</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_alloc_lkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_hw_mr</span> <span class="o">*</span><span class="n">hwmr</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_alloc_lkey</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_alloc_lkey_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_ALLOC_LKEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span> <span class="n">addr_check</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">fr_mr</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_ALLOC_LKEY_FMR_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">remote_wr</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_ALLOC_LKEY_REMOTE_WR_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">remote_rd</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_ALLOC_LKEY_REMOTE_RD_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">local_wr</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_ALLOC_LKEY_LOCAL_WR_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">remote_atomic</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_ALLOC_LKEY_REMOTE_ATOMIC_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl_sz_flags</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">num_pbls</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_ALLOC_LKEY_PBL_SIZE_SHIFT</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_alloc_lkey_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">lrkey</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_dealloc_lkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fr_mr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dealloc_lkey</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_DEALLOC_LKEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">lkey</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsvd_frmr</span> <span class="o">=</span> <span class="n">fr_mr</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_reg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_hw_mr</span> <span class="o">*</span><span class="n">hwmr</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_cnt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbe_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_reg_nsmr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_reg_nsmr_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_REGISTER_NSMR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_pbl_pdid</span> <span class="o">=</span>
	    <span class="n">pdid</span> <span class="o">|</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">num_pbls</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_REG_NSMR_NUM_PBL_SHIFT</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">remote_wr</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_REG_NSMR_REMOTE_WR_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">remote_rd</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_REG_NSMR_REMOTE_RD_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">local_wr</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_REG_NSMR_LOCAL_WR_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">remote_atomic</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_REG_NSMR_REMOTE_ATOMIC_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">mw_bind</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_REG_NSMR_BIND_MEMWIN_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">last</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_REG_NSMR_LAST_SHIFT</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbe_size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_HPAGE_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags_hpage_pbe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbl_size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_HPAGE_SIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">OCRDMA_REG_NSMR_HPAGE_SIZE_SHIFT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">totlen_low</span> <span class="o">=</span> <span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">totlen_high</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fbo_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">fbo</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fbo_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">fbo</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va_loaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va_hiaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pbl_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbl_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbl_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_reg_nsmr_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">lrkey</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_mbx_reg_mr_cont</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ocrdma_hw_mr</span> <span class="o">*</span><span class="n">hwmr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_cnt</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">pbl_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_reg_nsmr_cont</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_REGISTER_NSMR_CONT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lrkey</span> <span class="o">=</span> <span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_pbl_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbl_cnt</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_REG_NSMR_CONT_NUM_PBL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">pbl_offset</span> <span class="o">&amp;</span> <span class="n">OCRDMA_REG_NSMR_CONT_PBL_SHIFT_MASK</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">last</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_REG_NSMR_CONT_LAST_SHIFT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pbl_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbl_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">pbl_offset</span><span class="p">].</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span>
		    <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbl_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">pbl_offset</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_reg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ocrdma_hw_mr</span> <span class="o">*</span><span class="n">hwmr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_pbl_cnt</span><span class="p">,</span> <span class="n">pbl_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pending_pbl_cnt</span> <span class="o">=</span> <span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">num_pbls</span><span class="p">;</span>

	<span class="n">pbl_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cur_pbl_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pending_pbl_cnt</span><span class="p">,</span> <span class="n">MAX_OCRDMA_NSMR_PBL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_pbl_cnt</span> <span class="o">==</span> <span class="n">pending_pbl_cnt</span><span class="p">)</span>
		<span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_reg_mr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwmr</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span>
				   <span class="n">cur_pbl_cnt</span><span class="p">,</span> <span class="n">hwmr</span><span class="o">-&gt;</span><span class="n">pbe_size</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if there is no more pbls to register then exit. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbl_offset</span> <span class="o">+=</span> <span class="n">cur_pbl_cnt</span><span class="p">;</span>
		<span class="n">pending_pbl_cnt</span> <span class="o">-=</span> <span class="n">cur_pbl_cnt</span><span class="p">;</span>
		<span class="n">cur_pbl_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pending_pbl_cnt</span><span class="p">,</span> <span class="n">MAX_OCRDMA_NSMR_PBL</span><span class="p">);</span>
		<span class="cm">/* if we reach the end of the pbls, then need to set the last</span>
<span class="cm">		 * bit, indicating no more pbls to register for this memory key.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_pbl_cnt</span> <span class="o">==</span> <span class="n">pending_pbl_cnt</span><span class="p">)</span>
			<span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_reg_mr_cont</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwmr</span><span class="p">,</span> <span class="n">cur_pbl_cnt</span><span class="p">,</span>
						<span class="n">pbl_offset</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() err. status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ocrdma_is_qp_in_sq_flushlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">,</span> <span class="n">sq_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ocrdma_is_qp_in_rq_flushlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">rq_head</span><span class="p">,</span> <span class="n">rq_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ocrdma_flush_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">found</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flush_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">found</span> <span class="o">=</span> <span class="n">ocrdma_is_qp_in_sq_flushlist</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_cq</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_cq</span><span class="o">-&gt;</span><span class="n">sq_head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">ocrdma_is_qp_in_rq_flushlist</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq_cq</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq_cq</span><span class="o">-&gt;</span><span class="n">rq_head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flush_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_qp_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">new_ib_state</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="o">*</span><span class="n">old_ib_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ocrdma_qp_state</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="n">new_state</span> <span class="o">=</span> <span class="n">get_ocrdma_qp_state</span><span class="p">(</span><span class="n">new_ib_state</span><span class="p">);</span>

	<span class="cm">/* sync with wqe and rqe posting */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_ib_state</span><span class="p">)</span>
		<span class="o">*</span><span class="n">old_ib_state</span> <span class="o">=</span> <span class="n">get_ibqp_state</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_RST</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_RST</span>:
		<span class="k">case</span> <span class="n">OCRDMA_QPS_INIT</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_INIT</span>:
		<span class="cm">/* qps: INIT-&gt;XXX */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_INIT</span>:
		<span class="k">case</span> <span class="n">OCRDMA_QPS_RTR</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
			<span class="n">ocrdma_flush_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_RTR</span>:
		<span class="cm">/* qps: RTS-&gt;XXX */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_RTS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
			<span class="n">ocrdma_flush_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_RTS</span>:
		<span class="cm">/* qps: RTS-&gt;XXX */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_SQD</span>:
		<span class="k">case</span> <span class="n">OCRDMA_QPS_SQE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
			<span class="n">ocrdma_flush_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_SQD</span>:
		<span class="cm">/* qps: SQD-&gt;XXX */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_RTS</span>:
		<span class="k">case</span> <span class="n">OCRDMA_QPS_SQE</span>:
		<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_SQE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_RTS</span>:
		<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OCRDMA_QPS_ERR</span>:
		<span class="cm">/* qps: ERR-&gt;XXX */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OCRDMA_QPS_RST</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ocrdma_set_create_qp_mbx_access_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cap_flags</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_INB_RD</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_INB_RDEN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cap_flags</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_INB_WR</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_INB_WREN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cap_flags</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_MW_BIND</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_BIND_MEMWIN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cap_flags</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_LKEY0</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_ZERO_LKEYEN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cap_flags</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_FAST_REG</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_FMR_EN_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_set_create_qp_sq_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_qp_req</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">hw_page_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_wqe_allocated</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_sges</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span><span class="p">;</span>

	<span class="n">max_wqe_allocated</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span><span class="p">;</span>
	<span class="cm">/* need to allocate one extra to for GEN1 family */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">!=</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span>
		<span class="n">max_wqe_allocated</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_build_q_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max_wqe_allocated</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">wqe_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_page_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() req. max_send_wr=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">max_wqe_allocated</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">max_cnt</span> <span class="o">=</span> <span class="n">max_wqe_allocated</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw_pages</span> <span class="o">*</span> <span class="n">hw_page_size</span><span class="p">);</span>

	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">wqe_size</span><span class="p">;</span>
	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wq_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">hw_page_size</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type_pgsz_pdn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">hw_page_size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">)</span>
				<span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_QP_REQ_SQ_PAGE_SIZE_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_wq_rq_pages</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hw_pages</span> <span class="o">&lt;&lt;</span>
				 <span class="n">OCRDMA_CREATE_QP_REQ_NUM_WQ_PAGES_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">OCRDMA_CREATE_QP_REQ_NUM_WQ_PAGES_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_send_write</span> <span class="o">|=</span> <span class="p">(</span><span class="n">max_sges</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_CREATE_QP_REQ_MAX_SGE_SEND_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">OCRDMA_CREATE_QP_REQ_MAX_SGE_SEND_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_send_write</span> <span class="o">|=</span> <span class="p">(</span><span class="n">max_sges</span> <span class="o">&lt;&lt;</span>
				    <span class="n">OCRDMA_CREATE_QP_REQ_MAX_SGE_WRITE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">OCRDMA_CREATE_QP_REQ_MAX_SGE_WRITE_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_wqe_rqe</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">max_cnt</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			     <span class="n">OCRDMA_CREATE_QP_REQ_MAX_WQE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_WQE_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wqe_rqe_size</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">wqe_size</span> <span class="o">&lt;&lt;</span>
			      <span class="n">OCRDMA_CREATE_QP_REQ_WQE_SIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_WQE_SIZE_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_set_create_qp_rq_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_qp_req</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">hw_page_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_rqe_allocated</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_build_q_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max_rqe_allocated</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rqe_size</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">hw_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_page_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() req. max_recv_wr=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_cnt</span> <span class="o">=</span> <span class="n">max_rqe_allocated</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw_pages</span> <span class="o">*</span> <span class="n">hw_page_size</span><span class="p">);</span>

	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rqe_size</span><span class="p">;</span>

	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">hw_page_size</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type_pgsz_pdn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">hw_page_size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">OCRDMA_CREATE_QP_REQ_RQ_PAGE_SIZE_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_wq_rq_pages</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">hw_pages</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_QP_REQ_NUM_RQ_PAGES_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">OCRDMA_CREATE_QP_REQ_NUM_RQ_PAGES_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_SGE_RECV_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_SGE_RECV_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_wqe_rqe</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_cnt</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_RQE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_RQE_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wqe_rqe_size</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rqe_size</span> <span class="o">&lt;&lt;</span>
			<span class="n">OCRDMA_CREATE_QP_REQ_RQE_SIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">OCRDMA_CREATE_QP_REQ_RQE_SIZE_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_set_create_qp_dpp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_qp_req</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">enable_dpp_cq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dpp_cq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">num_dpp_qp</span><span class="o">--</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_ENABLE_DPP_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_dpp_cq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_ENABLE_DPP_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dpp_credits_cqid</span> <span class="o">=</span> <span class="n">dpp_cq_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dpp_credits_cqid</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_DPP_CREDIT_LIMIT</span> <span class="o">&lt;&lt;</span>
					<span class="n">OCRDMA_CREATE_QP_REQ_DPP_CREDIT_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_set_create_qp_ird_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_qp_req</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ird_page_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ird_page_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ird_q_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_ird_pages</span> <span class="o">*</span> <span class="n">ird_page_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ird</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">ird_q_va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ird_q_len</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ird_q_va</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ird_q_va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ird_q_len</span><span class="p">);</span>
	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ird_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_ird_pages</span><span class="p">,</span>
			     <span class="n">pa</span><span class="p">,</span> <span class="n">ird_page_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_get_create_qp_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_qp_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="o">*</span><span class="n">dpp_offset</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dpp_credit_lmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_wqe_allocated</span><span class="p">,</span> <span class="n">max_rqe_allocated</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">qp_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_QP_RSP_QP_ID_MASK</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">dbid</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">sq_rq_id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_QP_RSP_RQ_ID_MASK</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">dbid</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">sq_rq_id</span> <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_CREATE_QP_RSP_SQ_ID_SHIFT</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_ord_ird</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_QP_RSP_MAX_IRD_MASK</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">max_ord</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_ord_ird</span> <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_CREATE_QP_RSP_MAX_ORD_SHIFT</span><span class="p">);</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dpp_response</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_QP_RSP_DPP_ENABLED_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dpp_credit_lmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dpp_response</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_RSP_DPP_CREDITS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">OCRDMA_CREATE_QP_RSP_DPP_CREDITS_SHIFT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dpp_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dpp_response</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_RSP_DPP_PAGE_OFFSET_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">OCRDMA_CREATE_QP_RSP_DPP_PAGE_OFFSET_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max_wqe_allocated</span> <span class="o">=</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_wqe_rqe</span> <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_CREATE_QP_RSP_MAX_WQE_SHIFT</span><span class="p">;</span>
	<span class="n">max_wqe_allocated</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_wqe_allocated</span><span class="p">;</span>
	<span class="n">max_rqe_allocated</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_wqe_rqe</span><span class="p">);</span>

	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">max_cnt</span> <span class="o">=</span> <span class="n">max_wqe_allocated</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">max_wqe_idx</span> <span class="o">=</span> <span class="n">max_wqe_allocated</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">srq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_cnt</span> <span class="o">=</span> <span class="n">max_rqe_allocated</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_wqe_idx</span> <span class="o">=</span> <span class="n">max_rqe_allocated</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_create_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">enable_dpp_cq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dpp_cq_id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dpp_offset</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="o">*</span><span class="n">dpp_credit_lmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_qp_req</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_qp_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qptype</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">qp_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_QPT_GSI</span>:
		<span class="n">qptype</span> <span class="o">=</span> <span class="n">OCRDMA_QPT_GSI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPT_RC</span>:
		<span class="n">qptype</span> <span class="o">=</span> <span class="n">OCRDMA_QPT_RC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPT_UD</span>:
		<span class="n">qptype</span> <span class="o">=</span> <span class="n">OCRDMA_QPT_UD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_CREATE_QP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type_pgsz_pdn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">qptype</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_QP_REQ_QPT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">OCRDMA_CREATE_QP_REQ_QPT_MASK</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_set_create_qp_sq_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sq_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">srq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="n">srq</span> <span class="o">=</span> <span class="n">get_ocrdma_srq</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">srq</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span> <span class="n">OCRDMA_CREATE_QP_REQ_USE_SRQ_MASK</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span> <span class="o">=</span> <span class="n">srq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_set_create_qp_rq_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rq_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_set_create_qp_ird_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type_pgsz_pdn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_QP_REQ_PD_ID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_PD_ID_MASK</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">ocrdma_set_create_qp_mbx_access_flags</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_ord_ird</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ord_per_qp</span> <span class="o">&lt;&lt;</span>
			     <span class="n">OCRDMA_CREATE_QP_REQ_MAX_ORD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_ORD_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_ord_ird</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ird_per_qp</span> <span class="o">&lt;&lt;</span>
			     <span class="n">OCRDMA_CREATE_QP_REQ_MAX_IRD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_MAX_IRD_MASK</span><span class="p">;</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="n">get_ocrdma_cq</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wq_rq_cqid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_QP_REQ_WQ_CQID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_WQ_CQID_MASK</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_cq</span> <span class="o">=</span> <span class="n">cq</span><span class="p">;</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="n">get_ocrdma_cq</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wq_rq_cqid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_QP_REQ_RQ_CQID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_CREATE_QP_REQ_RQ_CQID_MASK</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq_cq</span> <span class="o">=</span> <span class="n">cq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_inline_data</span> <span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">num_dpp_qp</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_inline_data</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_inline_data</span><span class="p">))</span>
		<span class="n">ocrdma_set_create_qp_dpp_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">enable_dpp_cq</span><span class="p">,</span>
					     <span class="n">dpp_cq_id</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_qp_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">ocrdma_get_create_qp_rsp</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">dpp_offset</span><span class="p">,</span> <span class="n">dpp_credit_lmt</span><span class="p">);</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OCRDMA_QPS_RST</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
<span class="nl">rq_err:</span>
	<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s(%d) rq_err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
<span class="nl">sq_err:</span>
	<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s(%d) sq_err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_query_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ocrdma_qp_params</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_query_qp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_query_qp_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_QUERY_QP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">qp_id</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_query_qp_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp_params</span><span class="p">));</span>
<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_resolve_dgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">dgid</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">in6</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">,</span> <span class="n">dgid</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">in6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdma_is_multicast_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">))</span>
		<span class="n">rdma_get_mcast_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdma_link_local_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">))</span>
		<span class="n">rdma_get_ll_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() fail to resolve mac_addr.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_set_av_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ocrdma_modify_qp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_ah_attr</span> <span class="o">*</span><span class="n">ah_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">ah_attr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ib_gid</span> <span class="n">sgid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlan_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">&amp;</span> <span class="n">IB_AH_GRH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tclass_sq_psn</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_QP_PARAMS_TCLASS_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rnt_rc_sl_fl</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">flow_label</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_PARAMS_FLOW_LABEL_MASK</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hop_lmt_rq_psn</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">hop_limit</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_QP_PARAMS_HOP_LMT_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_FLOW_LBL_VALID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dgid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">dgid</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dgid</span><span class="p">));</span>
	<span class="n">ocrdma_query_gid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">sgid_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgid</span><span class="p">);</span>
	<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sgid_idx</span> <span class="o">=</span> <span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">sgid_index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sgid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sgid</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sgid</span><span class="p">));</span>
	<span class="n">ocrdma_resolve_dgid</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah_attr</span><span class="o">-&gt;</span><span class="n">grh</span><span class="p">.</span><span class="n">dgid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dmac_b0_to_b3</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="cm">/* convert them to LE format. */</span>
	<span class="n">ocrdma_cpu_to_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dgid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dgid</span><span class="p">));</span>
	<span class="n">ocrdma_cpu_to_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sgid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sgid</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vlan_dmac_b4_to_b5</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">vlan_id</span> <span class="o">=</span> <span class="n">rdma_get_vlan_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vlan_dmac_b4_to_b5</span> <span class="o">|=</span>
		    <span class="n">vlan_id</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_QP_PARAMS_VLAN_SHIFT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_VLAN_EN_VALID</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_set_qp_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ocrdma_modify_qp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attr_mask</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">old_qps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eth_mtu</span> <span class="o">=</span> <span class="n">iboe_get_mtu</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_PKEY_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">path_mtu_pkey_indx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">pkey_index</span> <span class="o">&amp;</span>
					    <span class="n">OCRDMA_QP_PARAMS_PKEY_INDEX_MASK</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_PKEY_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_QKEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">qkey</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">qkey</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">qkey</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">qkey</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_QKEY_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_AV</span><span class="p">)</span>
		<span class="n">ocrdma_set_av_params</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span> <span class="o">==</span> <span class="n">IB_QPT_GSI</span> <span class="o">||</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span> <span class="o">==</span> <span class="n">IB_QPT_UD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set the default mac address for UD, GSI QPs */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dmac_b0_to_b3</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vlan_dmac_b4_to_b5</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_EN_SQD_ASYNC_NOTIFY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">en_sqd_async_notify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span>
			<span class="n">OCRDMA_QP_PARAMS_FLAGS_SQD_ASYNC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_DST_QPN_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_DEST_QPN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ack_to_rnr_rtc_dest_qpn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">dest_qp_num</span> <span class="o">&amp;</span>
				<span class="n">OCRDMA_QP_PARAMS_DEST_QPN_MASK</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_DST_QPN_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_PATH_MTU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">eth_mtu</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">path_mtu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pmtu_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">path_mtu_pkey_indx</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">path_mtu</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">OCRDMA_QP_PARAMS_PATH_MTU_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">OCRDMA_QP_PARAMS_PATH_MTU_MASK</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_PMTU_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ack_to_rnr_rtc_dest_qpn</span> <span class="o">|=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;&lt;</span>
		    <span class="n">OCRDMA_QP_PARAMS_ACK_TIMEOUT_SHIFT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_ACK_TO_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_RETRY_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rnt_rc_sl_fl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">&lt;&lt;</span>
				      <span class="n">OCRDMA_QP_PARAMS_RETRY_CNT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">OCRDMA_QP_PARAMS_RETRY_CNT_MASK</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_RETRY_CNT_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_MIN_RNR_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rnt_rc_sl_fl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">min_rnr_timer</span> <span class="o">&lt;&lt;</span>
				      <span class="n">OCRDMA_QP_PARAMS_RNR_NAK_TIMER_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">OCRDMA_QP_PARAMS_RNR_NAK_TIMER_MASK</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_RNT_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_RNR_RETRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ack_to_rnr_rtc_dest_qpn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">rnr_retry</span> <span class="o">&lt;&lt;</span>
			<span class="n">OCRDMA_QP_PARAMS_RNR_RETRY_CNT_SHIFT</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">OCRDMA_QP_PARAMS_RNR_RETRY_CNT_MASK</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_RRC_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_SQ_PSN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tclass_sq_psn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">sq_psn</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_SQPSN_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_RQ_PSN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hop_lmt_rq_psn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">rq_psn</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_RQPSN_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_MAX_QP_RD_ATOMIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_rd_atomic</span> <span class="o">&gt;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ord_per_qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pmtu_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_rd_atomic</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_MAX_ORD_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_MAX_DEST_RD_ATOMIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_dest_rd_atomic</span> <span class="o">&gt;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ird_per_qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pmtu_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_dest_rd_atomic</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_MAX_IRD_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">max_ord_ird</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">max_ord</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_QP_PARAMS_MAX_ORD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">max_ird</span> <span class="o">&amp;</span> <span class="n">OCRDMA_QP_PARAMS_MAX_IRD_MASK</span><span class="p">);</span>
<span class="nl">pmtu_err:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_modify_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attr_mask</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">old_qps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_modify_qp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_MODIFY_QP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">get_ocrdma_qp_state</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">qp_state</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">OCRDMA_QP_PARAMS_STATE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">OCRDMA_QP_PARAMS_STATE_MASK</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OCRDMA_QP_PARA_QPS_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">max_sge_recv_flags</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_QP_PARAMS_STATE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">OCRDMA_QP_PARAMS_STATE_MASK</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_set_qp_params</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">attr_mask</span><span class="p">,</span> <span class="n">old_qps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>

<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_destroy_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_destroy_qp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_DELETE_QP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">qp_id</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>

<span class="nl">mbx_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">srq</span> <span class="o">&amp;&amp;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">dpp_enabled</span><span class="p">)</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">num_dpp_qp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_create_srq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ib_srq_init_attr</span> <span class="o">*</span><span class="n">srq_attr</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">hw_page_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_srq_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_create_srq</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_rqe_allocated</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_CREATE_SRQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pgsz_pdid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_SRQ_PD_ID_MASK</span><span class="p">;</span>
	<span class="n">max_rqe_allocated</span> <span class="o">=</span> <span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_wr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_build_q_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max_rqe_allocated</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rqe_size</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hw_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_page_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() req. max_wr=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_wr</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">hw_pages</span> <span class="o">*</span> <span class="n">hw_page_size</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ocrdma_build_q_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hw_pages</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">hw_page_size</span><span class="p">);</span>

	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rqe_size</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_cnt</span> <span class="o">=</span> <span class="n">max_rqe_allocated</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_rqe</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">max_rqe_allocated</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_sge_rqe</span> <span class="o">|=</span> <span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_sge</span> <span class="o">&lt;&lt;</span>
				<span class="n">OCRDMA_CREATE_SRQ_MAX_SGE_RECV_SHIFT</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pgsz_pdid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">hw_page_size</span> <span class="o">/</span> <span class="n">OCRDMA_MIN_Q_PAGE_SIZE</span><span class="p">)</span>
		<span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_SRQ_PG_SZ_SHIFT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pages_rqe_sz</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rqe_size</span>
		<span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_SRQ_RQE_SIZE_SHIFT</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">OCRDMA_CREATE_SRQ_RQE_SIZE_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pages_rqe_sz</span> <span class="o">|=</span> <span class="n">hw_pages</span> <span class="o">&lt;&lt;</span> <span class="n">OCRDMA_CREATE_SRQ_NUM_RQ_PAGES_SHIFT</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mbx_err</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_create_srq_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">dbid</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">max_rqe_allocated</span> <span class="o">=</span> <span class="p">((</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_sge_rqe_allocated</span> <span class="o">&amp;</span>
		<span class="n">OCRDMA_CREATE_SRQ_RSP_MAX_RQE_ALLOCATED_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">OCRDMA_CREATE_SRQ_RSP_MAX_RQE_ALLOCATED_SHIFT</span><span class="p">);</span>
	<span class="n">max_rqe_allocated</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_rqe_allocated</span><span class="p">);</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_cnt</span> <span class="o">=</span> <span class="n">max_rqe_allocated</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_wqe_idx</span> <span class="o">=</span> <span class="n">max_rqe_allocated</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">max_sges</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_sge_rqe_allocated</span> <span class="o">&amp;</span>
		<span class="n">OCRDMA_CREATE_SRQ_RSP_MAX_SGE_RECV_ALLOCATED_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">OCRDMA_CREATE_SRQ_RSP_MAX_SGE_RECV_ALLOCATED_SHIFT</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">mbx_err:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
<span class="nl">ret:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_modify_srq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_srq_attr</span> <span class="o">*</span><span class="n">srq_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_modify_srq</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_CREATE_SRQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">limit_max_rqe</span> <span class="o">|=</span> <span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">srq_limit</span> <span class="o">&lt;&lt;</span>
	    <span class="n">OCRDMA_MODIFY_SRQ_LIMIT_SHIFT</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_query_srq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_srq_attr</span> <span class="o">*</span><span class="n">srq_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_query_srq</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_CREATE_SRQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">dbid</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ocrdma_query_srq_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_query_srq_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">max_sge</span> <span class="o">=</span>
		    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">srq_lmt_max_sge</span> <span class="o">&amp;</span>
		    <span class="n">OCRDMA_QUERY_SRQ_RSP_MAX_SGE_RECV_MASK</span><span class="p">;</span>
		<span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">max_wr</span> <span class="o">=</span>
		    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_rqe_pdid</span> <span class="o">&gt;&gt;</span> <span class="n">OCRDMA_QUERY_SRQ_RSP_MAX_RQE_SHIFT</span><span class="p">;</span>
		<span class="n">srq_attr</span><span class="o">-&gt;</span><span class="n">srq_limit</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">srq_lmt_max_sge</span> <span class="o">&gt;&gt;</span>
		    <span class="n">OCRDMA_QUERY_SRQ_RSP_SRQ_LIMIT_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_mbx_destroy_srq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_destroy_srq</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ocrdma_init_emb_mqe</span><span class="p">(</span><span class="n">OCRDMA_CMD_DELETE_SRQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_cmd</span><span class="p">(</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
				  <span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_alloc_av</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_ah</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_av</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">av</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">num_ah</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">OCRDMA_AV_VALID</span><span class="p">;</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">av</span> <span class="o">=</span> <span class="n">av</span><span class="p">;</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">av</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">num_ah</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_free_av</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_ah</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_create_mq_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_eq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">intr_mode</span> <span class="o">==</span> <span class="n">BE_INTERRUPT_MODE_INTX</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">num_eq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">num_vectors</span> <span class="o">-</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">start_vector</span><span class="p">;</span>
		<span class="cm">/* minimum two vectors/eq are required for rdma to work.</span>
<span class="cm">		 * one for control path and one for data path.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_eq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_create_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">,</span> <span class="n">OCRDMA_EQ_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">.</span><span class="n">irq_name</span><span class="p">,</span> <span class="s">&quot;ocrdma_mq%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">ocrdma_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">ocrdma_irq_handler</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">.</span><span class="n">irq_name</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">_ocrdma_destroy_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_create_qp_eqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_eq</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">num_eq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">num_vectors</span> <span class="o">-</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">msix</span><span class="p">.</span><span class="n">start_vector</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">intr_mode</span> <span class="o">==</span> <span class="n">BE_INTERRUPT_MODE_INTX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_eq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">num_eq</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">num_eq</span><span class="p">,</span> <span class="n">num_online_cpus</span><span class="p">());</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_eq</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_eq</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_eq</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_create_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="n">OCRDMA_EQ_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span> <span class="s">&quot;ocrdma_qp%d-%d&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">ocrdma_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">ocrdma_irq_handler</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_ocrdma_destroy_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_eq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* one eq is sufficient for data path to work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_cnt</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ocrdma_destroy_qp_eqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ocrdma_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* set up control path eq */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_create_mq_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* set up data path eq */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_create_qp_eqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">qpeq_err</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_create_mq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mq_err</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_query_fw_config</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">conf_err</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_query_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">conf_err</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_query_fw_ver</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">conf_err</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_mbx_create_ah_tbl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">conf_err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">conf_err:</span>
	<span class="n">ocrdma_destroy_mq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">mq_err:</span>
	<span class="n">ocrdma_destroy_qp_eqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">qpeq_err:</span>
	<span class="n">ocrdma_destroy_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">);</span>
	<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ocrdma_cleanup_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ocrdma_mbx_delete_ah_tbl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* cleanup the data path eqs */</span>
	<span class="n">ocrdma_destroy_qp_eqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* cleanup the control path */</span>
	<span class="n">ocrdma_destroy_mq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ocrdma_destroy_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meq</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
