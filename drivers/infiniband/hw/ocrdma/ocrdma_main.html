<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ocrdma › ocrdma_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ocrdma_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex RoCE Device Driver for          *</span>
<span class="cm"> * RoCE (RDMA over Converged Ethernet) adapters.                   *</span>
<span class="cm"> * Copyright (C) 2008-2012 Emulex. All rights reserved.            *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_user_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_addr.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;net/addrconf.h&gt;</span>

<span class="cp">#include &quot;ocrdma.h&quot;</span>
<span class="cp">#include &quot;ocrdma_verbs.h&quot;</span>
<span class="cp">#include &quot;ocrdma_ah.h&quot;</span>
<span class="cp">#include &quot;be_roce.h&quot;</span>
<span class="cp">#include &quot;ocrdma_hw.h&quot;</span>

<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">OCRDMA_ROCE_DEV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Emulex RoCE HCA Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Emulex Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ocrdma_dev_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ocrdma_devlist_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_IDR</span><span class="p">(</span><span class="n">ocrdma_dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">union</span> <span class="n">ib_gid</span> <span class="n">ocrdma_zero_sgid</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_get_instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">instance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Assign an unused number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_dev_id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idr_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_dev_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ocrdma_get_guid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">guid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">guid</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_build_sgid_mac</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">sgid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">global</span><span class="p">.</span><span class="n">subnet_prefix</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mh">0xfe80000000000000LL</span><span class="p">);</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">vlan_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">vlan_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ocrdma_add_sgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ib_gid</span> <span class="n">new_sgid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_zero_sgid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">));</span>

	<span class="n">ocrdma_build_sgid_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_sgid</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OCRDMA_MAX_SGID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ocrdma_zero_sgid</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* found free entry */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">new_sgid</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">new_sgid</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* entry already present, no addition is required. */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ocrdma_del_sgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ib_gid</span> <span class="n">sgid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ocrdma_build_sgid_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgid</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* first is default sgid, which cannot be deleted. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OCRDMA_MAX_SGID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sgid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* found matching entry */</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">));</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_add_default_sgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* GID Index 0 - Invariant manufacturer-assigned EUI-64 */</span>
	<span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">sgid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">sgid</span><span class="o">-&gt;</span><span class="n">global</span><span class="p">.</span><span class="n">subnet_prefix</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mh">0xfe80000000000000LL</span><span class="p">);</span>
	<span class="n">ocrdma_get_guid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_add_vlan_sgids</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_id</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_vlan</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">tmp</span> <span class="o">||</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_oper_up</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_dev_vlan_id</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
				<span class="n">is_vlan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">is_vlan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">vlan_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ocrdma_add_sgid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_add_vlan_sgids</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* VLAN */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_build_sgid_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ocrdma_add_default_sgid</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ocrdma_add_vlan_sgids</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_IPV6) || defined(CONFIG_IPV6_MODULE) || \</span>
<span class="cp">defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_inet6addr_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">event_netdev</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">gid_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_vlan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">event_netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">!=</span> <span class="n">event_netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_vlan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">vlan_dev_vlan_id</span><span class="p">(</span><span class="n">event_netdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ocrdma_dev_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdma_link_local_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="n">updated</span> <span class="o">=</span> <span class="n">ocrdma_add_sgid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">updated</span> <span class="o">=</span> <span class="n">ocrdma_del_sgid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">is_vlan</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* GID table updated, notify the consumers about it */</span>
		<span class="n">gid_event</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">;</span>
		<span class="n">gid_event</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gid_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_GID_CHANGE</span><span class="p">;</span>
		<span class="n">ib_dispatch_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gid_event</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ocrdma_inet6addr_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">ocrdma_inet6addr_event</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* IPV6 and VLAN */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">rdma_link_layer</span> <span class="nf">ocrdma_link_layer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="n">port_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IB_LINK_LAYER_ETHERNET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ocrdma%d&quot;</span><span class="p">,</span> <span class="n">IB_DEVICE_NAME_MAX</span><span class="p">);</span>
	<span class="n">ocrdma_get_guid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_guid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_desc</span><span class="p">,</span> <span class="n">OCRDMA_NODE_DESC</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">OCRDMA_NODE_DESC</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">uverbs_cmd_mask</span> <span class="o">=</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">GET_CONTEXT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">QUERY_DEVICE</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">QUERY_PORT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">ALLOC_PD</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">DEALLOC_PD</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">REG_MR</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">DEREG_MR</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">CREATE_COMP_CHANNEL</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">CREATE_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">RESIZE_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">DESTROY_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">REQ_NOTIFY_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">CREATE_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">MODIFY_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">QUERY_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">DESTROY_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">POLL_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">POST_SEND</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">POST_RECV</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">uverbs_cmd_mask</span> <span class="o">|=</span>
	    <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">CREATE_AH</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">MODIFY_AH</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">QUERY_AH</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">DESTROY_AH</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_type</span> <span class="o">=</span> <span class="n">RDMA_NODE_IB_CA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">phys_port_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">num_comp_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* mandatory verbs. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_device</span> <span class="o">=</span> <span class="n">ocrdma_query_device</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_port</span> <span class="o">=</span> <span class="n">ocrdma_query_port</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">modify_port</span> <span class="o">=</span> <span class="n">ocrdma_modify_port</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_gid</span> <span class="o">=</span> <span class="n">ocrdma_query_gid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">get_link_layer</span> <span class="o">=</span> <span class="n">ocrdma_link_layer</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_pd</span> <span class="o">=</span> <span class="n">ocrdma_alloc_pd</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dealloc_pd</span> <span class="o">=</span> <span class="n">ocrdma_dealloc_pd</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_cq</span> <span class="o">=</span> <span class="n">ocrdma_create_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_cq</span> <span class="o">=</span> <span class="n">ocrdma_destroy_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">resize_cq</span> <span class="o">=</span> <span class="n">ocrdma_resize_cq</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_qp</span> <span class="o">=</span> <span class="n">ocrdma_create_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">modify_qp</span> <span class="o">=</span> <span class="n">ocrdma_modify_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_qp</span> <span class="o">=</span> <span class="n">ocrdma_query_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_qp</span> <span class="o">=</span> <span class="n">ocrdma_destroy_qp</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_pkey</span> <span class="o">=</span> <span class="n">ocrdma_query_pkey</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_ah</span> <span class="o">=</span> <span class="n">ocrdma_create_ah</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_ah</span> <span class="o">=</span> <span class="n">ocrdma_destroy_ah</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_ah</span> <span class="o">=</span> <span class="n">ocrdma_query_ah</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">modify_ah</span> <span class="o">=</span> <span class="n">ocrdma_modify_ah</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">poll_cq</span> <span class="o">=</span> <span class="n">ocrdma_poll_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">post_send</span> <span class="o">=</span> <span class="n">ocrdma_post_send</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">post_recv</span> <span class="o">=</span> <span class="n">ocrdma_post_recv</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">req_notify_cq</span> <span class="o">=</span> <span class="n">ocrdma_arm_cq</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">get_dma_mr</span> <span class="o">=</span> <span class="n">ocrdma_get_dma_mr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dereg_mr</span> <span class="o">=</span> <span class="n">ocrdma_dereg_mr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">reg_user_mr</span> <span class="o">=</span> <span class="n">ocrdma_reg_user_mr</span><span class="p">;</span>

	<span class="cm">/* mandatory to support user space verbs consumer. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_ucontext</span> <span class="o">=</span> <span class="n">ocrdma_alloc_ucontext</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dealloc_ucontext</span> <span class="o">=</span> <span class="n">ocrdma_dealloc_ucontext</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">ocrdma_mmap</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dma_device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">process_mad</span> <span class="o">=</span> <span class="n">ocrdma_process_mad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">.</span><span class="n">dev_family</span> <span class="o">==</span> <span class="n">OCRDMA_GEN2_FAMILY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">uverbs_cmd_mask</span> <span class="o">|=</span>
		     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">CREATE_SRQ</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">MODIFY_SRQ</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">QUERY_SRQ</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">DESTROY_SRQ</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">OCRDMA_UVERBS</span><span class="p">(</span><span class="n">POST_SRQ_RECV</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_srq</span> <span class="o">=</span> <span class="n">ocrdma_create_srq</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">modify_srq</span> <span class="o">=</span> <span class="n">ocrdma_modify_srq</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_srq</span> <span class="o">=</span> <span class="n">ocrdma_query_srq</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_srq</span> <span class="o">=</span> <span class="n">ocrdma_destroy_srq</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">post_srq_recv</span> <span class="o">=</span> <span class="n">ocrdma_post_srq_recv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ib_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_alloc_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ib_gid</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">OCRDMA_MAX_SGID</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_lock</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq_tbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
			      <span class="n">OCRDMA_MAX_CQ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq_tbl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_qp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_tbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
				      <span class="n">OCRDMA_MAX_QP</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_tbl</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">av_tbl</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flush_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">alloc_err:</span>
	<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s(%d) error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_tbl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq_tbl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sgid_tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="nf">ocrdma_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dev_info</span> <span class="o">*</span><span class="n">dev_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">ib_alloc_device</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate ib device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_mqe_emb_cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">idr_err</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nic_info</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev_info</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ocrdma_get_instance</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">idr_err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_alloc_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_build_sgid_tbl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ocrdma_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_devlist_lock</span><span class="p">);</span>
	<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ocrdma_dev_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_devlist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">alloc_err:</span>
	<span class="n">ocrdma_free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ocrdma_cleanup_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">init_err:</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_dev_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="nl">idr_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">);</span>
	<span class="n">ib_dealloc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">);</span>
	<span class="n">ocrdma_err</span><span class="p">(</span><span class="s">&quot;%s() leaving. ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_remove_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rcu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_dev</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="n">ocrdma_free_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ocrdma_cleanup_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_dev_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mbx_cmd</span><span class="p">);</span>
	<span class="n">ib_dealloc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* first unregister with stack to stop all the active traffic</span>
<span class="cm">	 * of the registered clients.</span>
<span class="cm">	 */</span>
	<span class="n">ib_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_devlist_lock</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_devlist_lock</span><span class="p">);</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">ocrdma_remove_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">port_event</span><span class="p">;</span>

	<span class="n">port_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_PORT_ACTIVE</span><span class="p">;</span>
	<span class="n">port_event</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port_event</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">;</span>
	<span class="n">ib_dispatch_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ocrdma_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span> <span class="o">**</span><span class="n">cur_qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">err_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attr_mask</span> <span class="o">=</span> <span class="n">IB_QP_STATE</span><span class="p">;</span>

	<span class="n">attrs</span><span class="p">.</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_qp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qp_tbl</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OCRDMA_MAX_QP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qp</span> <span class="o">=</span> <span class="n">cur_qp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* change the QP state to ERROR */</span>
				<span class="n">_ocrdma_modify_qp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="n">attr_mask</span><span class="p">);</span>

				<span class="n">err_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_QP_FATAL</span><span class="p">;</span>
				<span class="n">err_event</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
				<span class="n">err_event</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">;</span>
				<span class="n">ib_dispatch_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err_event</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_lock</span><span class="p">);</span>

	<span class="n">err_event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IB_EVENT_PORT_ERR</span><span class="p">;</span>
	<span class="n">err_event</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">err_event</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">;</span>
	<span class="n">ib_dispatch_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err_event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* event handling via NIC driver ensures that all the NIC specific</span>
<span class="cm"> * initialization done before RoCE driver notifies</span>
<span class="cm"> * event to stack.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BE_DEV_UP</span>:
		<span class="n">ocrdma_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_DEV_DOWN</span>:
		<span class="n">ocrdma_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ocrdma_driver</span> <span class="n">ocrdma_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;ocrdma_driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span>			<span class="o">=</span> <span class="n">ocrdma_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">ocrdma_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_change_handler</span>	<span class="o">=</span> <span class="n">ocrdma_event_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocrdma_unregister_inet6addr_notifier</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_IPV6) || defined(CONFIG_IPV6_MODULE)</span>
	<span class="n">unregister_inet6addr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_inet6addr_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ocrdma_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_IPV6) || defined(CONFIG_IPV6_MODULE)</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">register_inet6addr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_inet6addr_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_roce_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ocrdma_unregister_inet6addr_notifier</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ocrdma_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">be_roce_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ocrdma_drv</span><span class="p">);</span>
	<span class="n">ocrdma_unregister_inet6addr_notifier</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ocrdma_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ocrdma_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
