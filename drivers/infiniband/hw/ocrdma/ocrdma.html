<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ocrdma › ocrdma.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ocrdma.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex RoCE Device Driver for          *</span>
<span class="cm"> * RoCE (RDMA over Converged Ethernet) adapters.                   *</span>
<span class="cm"> * Copyright (C) 2008-2012 Emulex. All rights reserved.            *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#ifndef __OCRDMA_H__</span>
<span class="cp">#define __OCRDMA_H__</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_user_verbs.h&gt;</span>

<span class="cp">#include &lt;be_roce.h&gt;</span>
<span class="cp">#include &quot;ocrdma_sli.h&quot;</span>

<span class="cp">#define OCRDMA_ROCE_DEV_VERSION &quot;1.0.0&quot;</span>
<span class="cp">#define OCRDMA_NODE_DESC &quot;Emulex OneConnect RoCE HCA&quot;</span>

<span class="cp">#define ocrdma_err(format, arg...) printk(KERN_ERR format, ##arg)</span>

<span class="cp">#define OCRDMA_MAX_AH 512</span>

<span class="cp">#define OCRDMA_UVERBS(CMD_NAME) (1ull &lt;&lt; IB_USER_VERBS_CMD_##CMD_NAME)</span>

<span class="k">struct</span> <span class="n">ocrdma_dev_attr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">fw_ver</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_pd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_cq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_cqe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_qp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_wqe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_rqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_inline_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_send_sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_recv_sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_srq_sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_mr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max_mr_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_num_mr_pbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_fmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_map_per_fmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_pages_per_frmr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_ord_per_qp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_ird_per_qp</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">device_cap_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cq_overflow_detect</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">srq_supported</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">wqe_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rqe_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ird_page_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">local_ca_ack_delay</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ird</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_ird_pages</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_pbl</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">entry_size</span><span class="p">;</span>		<span class="cm">/* Size of an element in the queue */</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>			<span class="cm">/* qid, where to ring the doorbell. */</span>
	<span class="n">u16</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">created</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">used</span><span class="p">;</span>		<span class="cm">/* Number of valid elements in the queue */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cq_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">irq_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_mq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="n">sq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_queue_info</span> <span class="n">cq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rearm_cq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mqe_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span> <span class="cm">/* for serializing mailbox commands on MQ */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">cmd_wait</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cqe_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ext_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cmd_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="n">ibdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev_attr</span> <span class="n">attr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">dev_lock</span><span class="p">;</span> <span class="cm">/* provides syncronise access to device data */</span>
	<span class="n">spinlock_t</span> <span class="n">flush_q_lock</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">**</span><span class="n">cq_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">**</span><span class="n">qp_tbl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="n">meq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_eq</span> <span class="o">*</span><span class="n">qp_eq_tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eq_cnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">base_eqid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_eq</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">sgid_tbl</span><span class="p">;</span>
	<span class="cm">/* provided synchronization to sgid table for</span>
<span class="cm">	 * updating gid entries triggered by notifier.</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span> <span class="n">sgid_lock</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">gsi_qp_created</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">gsi_sqcq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">gsi_rqcq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ocrdma_av</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">num_ah</span><span class="p">;</span>
		<span class="cm">/* provide synchronization for av</span>
<span class="cm">		 * entry allocations.</span>
<span class="cm">		 */</span>
		<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">ahid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ocrdma_pbl</span> <span class="n">pbl</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">av_tbl</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">mbx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_mq</span> <span class="n">mq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mqe_ctx</span> <span class="n">mqe_ctx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">be_dev_info</span> <span class="n">nic_info</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_cq</span> <span class="n">ibcq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cqe</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phase</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">getp</span><span class="p">;</span>	<span class="cm">/* pointer to pending wrs to</span>
<span class="cm">			 * return to stack, wrap arounds</span>
<span class="cm">			 * at max_hw_cqe</span>
<span class="cm">			 */</span>
	<span class="n">u32</span> <span class="n">max_hw_cqe</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">phase_change</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">armed</span><span class="p">,</span> <span class="n">solicited</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">arm_needed</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">cq_lock</span> <span class="n">____cacheline_aligned</span><span class="p">;</span> <span class="cm">/* provide synchronization</span>
<span class="cm">						   * to cq polling</span>
<span class="cm">						   */</span>
	<span class="cm">/* syncronizes cq completion handler invoked from multiple context */</span>
	<span class="n">spinlock_t</span> <span class="n">comp_handler_lock</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eqn</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ocrdma_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">use_cnt</span><span class="p">;</span>

	<span class="cm">/* head of all qp&#39;s sq and rq for which cqes need to be flushed</span>
<span class="cm">	 * by the software.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">sq_head</span><span class="p">,</span> <span class="n">rq_head</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_pd</span> <span class="n">ibpd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">use_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_dpp_qp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpp_page</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dpp_enabled</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_ah</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_ah</span> <span class="n">ibah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_av</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sgid_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_qp_hwq_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>			<span class="cm">/* virtual address */</span>
	<span class="n">u32</span> <span class="n">max_sges</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_wqe_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dbid</span><span class="p">;</span>		<span class="cm">/* qid, where to ring the doorbell. */</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_srq</span> <span class="n">ibsrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
	<span class="cm">/* provide synchronization to multiple context(s) posting rqe */</span>
	<span class="n">spinlock_t</span> <span class="n">q_lock</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ocrdma_qp_hwq_info</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">use_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">rqe_wr_id_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">idx_bit_fields</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bit_fields_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp</span> <span class="n">ibqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sq_db</span><span class="p">;</span>
	<span class="cm">/* provide synchronization to multiple context(s) posting wqe, rqe */</span>
	<span class="n">spinlock_t</span> <span class="n">q_lock</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp_hwq_info</span> <span class="n">sq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">wrid</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">dpp_wqe_idx</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">dpp_wqe</span><span class="p">;</span>
		<span class="kt">uint8_t</span>  <span class="n">signaled</span><span class="p">;</span>
		<span class="kt">uint8_t</span>  <span class="n">rsvd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">wqe_wr_id_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_inline_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">sq_cq</span><span class="p">;</span>
	<span class="cm">/* list maintained per CQ to flush SQ errors */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">sq_entry</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rq_db</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_qp_hwq_info</span> <span class="n">rq</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">rqe_wr_id_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="n">rq_cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">;</span>
	<span class="cm">/* list maintained per CQ to flush RQ errors */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">rq_entry</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">ocrdma_qp_state</span> <span class="n">state</span><span class="p">;</span>	<span class="cm">/*  QP state */</span>
	<span class="kt">int</span> <span class="n">cap_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_ord</span><span class="p">,</span> <span class="n">max_ird</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">ib_qp_type</span> <span class="n">qp_type</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">sgid_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qkey</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dpp_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ird_q_va</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define OCRDMA_GET_NUM_POSTED_SHIFT_VAL(qp) \</span>
<span class="cp">	(((qp-&gt;dev-&gt;nic_info.dev_family == OCRDMA_GEN2_FAMILY) &amp;&amp; \</span>
<span class="cp">		(qp-&gt;id &lt; 64)) ? 24 : 16)</span>

<span class="k">struct</span> <span class="n">ocrdma_hw_mr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lkey</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fr_mr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">remote_atomic</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">remote_rd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">remote_wr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">local_rd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">local_wr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mw_bind</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsvd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pbl</span> <span class="o">*</span><span class="n">pbl_table</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_pbls</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_pbes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbe_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fbo</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">va</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_mr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="n">ibmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem</span> <span class="o">*</span><span class="n">umem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_hw_mr</span> <span class="n">hwmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_ucontext</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="n">ibucontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">mm_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mm_list_lock</span><span class="p">;</span> <span class="cm">/* protects list entries of mm type */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ah_tbl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ocrdma_mm</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">phy_addr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="nf">get_ocrdma_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_dev</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_ucontext</span> <span class="o">*</span><span class="nf">get_ocrdma_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_ucontext</span>
							  <span class="o">*</span><span class="n">ibucontext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibucontext</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_ucontext</span><span class="p">,</span> <span class="n">ibucontext</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_pd</span> <span class="o">*</span><span class="nf">get_ocrdma_pd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">ibpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_pd</span><span class="p">,</span> <span class="n">ibpd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_cq</span> <span class="o">*</span><span class="nf">get_ocrdma_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibcq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_cq</span><span class="p">,</span> <span class="n">ibcq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span> <span class="o">*</span><span class="nf">get_ocrdma_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_qp</span><span class="p">,</span> <span class="n">ibqp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_mr</span> <span class="o">*</span><span class="nf">get_ocrdma_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ibmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibmr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_mr</span><span class="p">,</span> <span class="n">ibmr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_ah</span> <span class="o">*</span><span class="nf">get_ocrdma_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_ah</span> <span class="o">*</span><span class="n">ibah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_ah</span><span class="p">,</span> <span class="n">ibah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ocrdma_srq</span> <span class="o">*</span><span class="nf">get_ocrdma_srq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_srq</span> <span class="o">*</span><span class="n">ibsrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibsrq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ocrdma_srq</span><span class="p">,</span> <span class="n">ibsrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
