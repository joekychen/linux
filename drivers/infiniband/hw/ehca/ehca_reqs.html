<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ehca › ehca_reqs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ehca_reqs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  IBM eServer eHCA Infiniband device driver for Linux on POWER</span>
<span class="cm"> *</span>
<span class="cm"> *  post_send/recv, poll_cq, req_notify</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors: Hoang-Nam Nguyen &lt;hnguyen@de.ibm.com&gt;</span>
<span class="cm"> *           Waleri Fomin &lt;fomin@de.ibm.com&gt;</span>
<span class="cm"> *           Joachim Fenkes &lt;fenkes@de.ibm.com&gt;</span>
<span class="cm"> *           Reinhard Ernst &lt;rernst@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2005 IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  This source code is distributed under a dual license of GPL v2.0 and OpenIB</span>
<span class="cm"> *  BSD.</span>
<span class="cm"> *</span>
<span class="cm"> * OpenIB BSD License</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistributions of source code must retain the above copyright notice, this</span>
<span class="cm"> * list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="cm"> * this list of conditions and the following disclaimer in the documentation</span>
<span class="cm"> * and/or other materials</span>
<span class="cm"> * provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="cm"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER</span>
<span class="cm"> * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;ehca_classes.h&quot;</span>
<span class="cp">#include &quot;ehca_tools.h&quot;</span>
<span class="cp">#include &quot;ehca_qes.h&quot;</span>
<span class="cp">#include &quot;ehca_iverbs.h&quot;</span>
<span class="cp">#include &quot;hcp_if.h&quot;</span>
<span class="cp">#include &quot;hipz_fns.h&quot;</span>

<span class="cm">/* in RC traffic, insert an empty RDMA READ every this many packets */</span>
<span class="cp">#define ACK_CIRC_THRESHOLD 2000000</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">replace_wr_id</span><span class="p">(</span><span class="n">u64</span> <span class="n">wr_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wr_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QMAP_IDX_MASK</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="n">QMAP_IDX_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_app_wr_id</span><span class="p">(</span><span class="n">u64</span> <span class="n">wr_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wr_id</span> <span class="o">&amp;</span> <span class="n">QMAP_IDX_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_write_rwqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipz_queue</span> <span class="o">*</span><span class="n">ipz_rqueue</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ehca_wqe</span> <span class="o">*</span><span class="n">wqe_p</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">recv_wr</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">rq_map_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cnt_ds</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">ipz_rqueue</span><span class="o">-&gt;</span><span class="n">act_nr_of_sg</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;Invalid number of WQE SGE. &quot;</span>
			 <span class="s">&quot;num_sqe=%x max_nr_of_sg=%x&quot;</span><span class="p">,</span>
			 <span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="n">ipz_rqueue</span><span class="o">-&gt;</span><span class="n">act_nr_of_sg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* invalid SG list length */</span>
	<span class="p">}</span>

	<span class="cm">/* clear wqe header until sglist */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_wqe</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">sg_list</span><span class="p">));</span>

	<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">work_request_id</span> <span class="o">=</span> <span class="n">replace_wr_id</span><span class="p">(</span><span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span> <span class="n">rq_map_idx</span><span class="p">);</span>
	<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">nr_of_data_seg</span> <span class="o">=</span> <span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt_ds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt_ds</span> <span class="o">&lt;</span> <span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">cnt_ds</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">all_rcv</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">cnt_ds</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span>
			<span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">cnt_ds</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">all_rcv</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">cnt_ds</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span>
			<span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">cnt_ds</span><span class="p">].</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">all_rcv</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">cnt_ds</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
			<span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">cnt_ds</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;RECEIVE WQE written into ipz_rqueue=%p&quot;</span><span class="p">,</span>
			     <span class="n">ipz_rqueue</span><span class="p">);</span>
		<span class="n">ehca_dmp</span><span class="p">(</span><span class="n">wqe_p</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">nr_of_data_seg</span><span class="p">),</span> <span class="s">&quot;recv wqe&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(DEBUG_GSI_SEND_WR)</span>

<span class="cm">/* need ib_mad struct */</span>
<span class="cp">#include &lt;rdma/ib_mad.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_send_wr_ud</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">send_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">send_wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ib_mad_hdr</span> <span class="o">*</span><span class="n">mad_hdr</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">mad_hdr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">sge</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">;</span>
		<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;send_wr#%x wr_id=%lx num_sge=%x &quot;</span>
			     <span class="s">&quot;send_flags=%x opcode=%x&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span>
			     <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">send_flags</span><span class="p">,</span>
			     <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mad_hdr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;send_wr#%x mad_hdr base_version=%x &quot;</span>
				     <span class="s">&quot;mgmt_class=%x class_version=%x method=%x &quot;</span>
				     <span class="s">&quot;status=%x class_specific=%x tid=%lx &quot;</span>
				     <span class="s">&quot;attr_id=%x resv=%x attr_mod=%x&quot;</span><span class="p">,</span>
				     <span class="n">idx</span><span class="p">,</span> <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">base_version</span><span class="p">,</span>
				     <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">mgmt_class</span><span class="p">,</span>
				     <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">class_version</span><span class="p">,</span> <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">,</span>
				     <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">class_specific</span><span class="p">,</span>
				     <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">,</span>
				     <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">resv</span><span class="p">,</span>
				     <span class="n">mad_hdr</span><span class="o">-&gt;</span><span class="n">attr_mod</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">abs_to_virt</span><span class="p">(</span><span class="n">sge</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;send_wr#%x sge#%x addr=%p length=%x &quot;</span>
				     <span class="s">&quot;lkey=%x&quot;</span><span class="p">,</span>
				     <span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sge</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">sge</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
			<span class="cm">/* assume length is n*16 */</span>
			<span class="n">ehca_dmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sge</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;send_wr#%x sge#%x&quot;</span><span class="p">,</span>
				 <span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">sge</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* eof for j */</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">send_wr</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* eof while send_wr */</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* DEBUG_GSI_SEND_WR */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_write_swqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ehca_wqe</span> <span class="o">*</span><span class="n">wqe_p</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">send_wr</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">sq_map_idx</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">hidden</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_av</span> <span class="o">*</span><span class="n">my_av</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">remote_qkey</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">remote_qkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_qmap_entry</span> <span class="o">*</span><span class="n">qmap_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">sq_map_idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">.</span><span class="n">act_nr_of_sg</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;Invalid number of WQE SGE. &quot;</span>
			 <span class="s">&quot;num_sqe=%x max_nr_of_sg=%x&quot;</span><span class="p">,</span>
			 <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">.</span><span class="n">act_nr_of_sg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* invalid SG list length */</span>
	<span class="p">}</span>

	<span class="cm">/* clear wqe header until sglist */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_wqe</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">sg_list</span><span class="p">));</span>

	<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">work_request_id</span> <span class="o">=</span> <span class="n">replace_wr_id</span><span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span> <span class="n">sq_map_idx</span><span class="p">);</span>

	<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">app_wr_id</span> <span class="o">=</span> <span class="n">get_app_wr_id</span><span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
	<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">cqe_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_WR_SEND</span>:
	<span class="k">case</span> <span class="n">IB_WR_SEND_WITH_IMM</span>:
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">optype</span> <span class="o">=</span> <span class="n">WQE_OPTYPE_SEND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_WR_RDMA_WRITE</span>:
	<span class="k">case</span> <span class="n">IB_WR_RDMA_WRITE_WITH_IMM</span>:
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">optype</span> <span class="o">=</span> <span class="n">WQE_OPTYPE_RDMAWRITE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_WR_RDMA_READ</span>:
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">optype</span> <span class="o">=</span> <span class="n">WQE_OPTYPE_RDMAREAD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;Invalid opcode=%x&quot;</span><span class="p">,</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* invalid opcode */</span>
	<span class="p">}</span>

	<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">wqef</span> <span class="o">=</span> <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WQEF_HIGH_NIBBLE</span><span class="p">;</span>

	<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">wr_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span> <span class="o">||</span>
	    <span class="n">qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">.</span><span class="n">sq_sig_type</span> <span class="o">==</span> <span class="n">IB_SIGNAL_ALL_WR</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hidden</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">wr_flag</span> <span class="o">|=</span> <span class="n">WQE_WRFLAG_REQ_SIGNAL_COM</span><span class="p">;</span>
		<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">cqe_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_SEND_WITH_IMM</span> <span class="o">||</span>
	    <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_RDMA_WRITE_WITH_IMM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this might not work as long as HW does not support it */</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">immediate_data</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">imm_data</span><span class="p">);</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">wr_flag</span> <span class="o">|=</span> <span class="n">WQE_WRFLAG_IMM_DATA_PRESENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">nr_of_data_seg</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_QPT_SMI</span>:
	<span class="k">case</span> <span class="n">IB_QPT_GSI</span>:
		<span class="cm">/* no break is intential here */</span>
	<span class="k">case</span> <span class="n">IB_QPT_UD</span>:
		<span class="cm">/* IB 1.2 spec C10-15 compliance */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">remote_qkey</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
			<span class="n">remote_qkey</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qkey</span><span class="p">;</span>

		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">destination_qp_number</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">remote_qpn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">local_ee_context_qkey</span> <span class="o">=</span> <span class="n">remote_qkey</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;wr.ud.ah is NULL. qp=%p&quot;</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">remote_qpn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;dest QP# is 0. qp=%x&quot;</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">my_av</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_av</span><span class="p">,</span> <span class="n">ib_ah</span><span class="p">);</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">ud_av</span> <span class="o">=</span> <span class="n">my_av</span><span class="o">-&gt;</span><span class="n">av</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * omitted check of IB_SEND_INLINE</span>
<span class="cm">		 * since HW does not support it</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span>
				<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span>
				<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">lkey</span><span class="p">;</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
				<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* eof for idx */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span> <span class="o">==</span> <span class="n">IB_QPT_SMI</span> <span class="o">||</span>
		    <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span> <span class="o">==</span> <span class="n">IB_QPT_GSI</span><span class="p">)</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">ud_av</span><span class="p">.</span><span class="n">pmtu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span> <span class="o">==</span> <span class="n">IB_QPT_GSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">pkeyi</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">ud</span><span class="p">.</span><span class="n">pkey_index</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_GSI_SEND_WR</span>
			<span class="n">trace_send_wr_ud</span><span class="p">(</span><span class="n">send_wr</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_GSI_SEND_WR */</span><span class="cp"></span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IB_QPT_UC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_FENCE</span><span class="p">)</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">wr_flag</span> <span class="o">|=</span> <span class="n">WQE_WRFLAG_FENCE</span><span class="p">;</span>
		<span class="cm">/* no break is intentional here */</span>
	<span class="k">case</span> <span class="n">IB_QPT_RC</span>:
		<span class="cm">/* TODO: atomic not implemented */</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nud</span><span class="p">.</span><span class="n">remote_virtual_address</span> <span class="o">=</span>
			<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">;</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nud</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * omitted checking of IB_SEND_INLINE</span>
<span class="cm">		 * since HW does not support it</span>
<span class="cm">		 */</span>
		<span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nud</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span>
				<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nud</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span>
				<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">lkey</span><span class="p">;</span>
			<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nud</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
				<span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
			<span class="n">dma_length</span> <span class="o">+=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* eof idx */</span>
		<span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nud</span><span class="p">.</span><span class="n">atomic_1st_op_dma_len</span> <span class="o">=</span> <span class="n">dma_length</span><span class="p">;</span>

		<span class="cm">/* unsolicited ack circumvention */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_RDMA_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* on RDMA read, switch on and reset counters */</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">message_count</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">packet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">unsol_ack_circ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* else estimate #packets */</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">packet_count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dma_length</span> <span class="o">&gt;&gt;</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">mtu_shift</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;Invalid qptype=%x&quot;</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;SEND WQE written into queue qp=%p &quot;</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
		<span class="n">ehca_dmp</span><span class="p">(</span> <span class="n">wqe_p</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">wqe_p</span><span class="o">-&gt;</span><span class="n">nr_of_data_seg</span><span class="p">),</span> <span class="s">&quot;send wqe&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* map_ib_wc_status converts raw cqe_status to ib_wc_status */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">map_ib_wc_status</span><span class="p">(</span><span class="n">u32</span> <span class="n">cqe_status</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">ib_wc_status</span> <span class="o">*</span><span class="n">wc_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cqe_status</span> <span class="o">&amp;</span> <span class="n">WC_STATUS_ERROR_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cqe_status</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="k">case</span> <span class="mh">0x21</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_LEN_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="k">case</span> <span class="mh">0x22</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_QP_OP_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="k">case</span> <span class="mh">0x23</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_EEC_OP_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="k">case</span> <span class="mh">0x24</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_PROT_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="k">case</span> <span class="mh">0x25</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_MW_BIND_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>: <span class="cm">/* remote error - look into bits 20:24 */</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">cqe_status</span>
				 <span class="o">&amp;</span> <span class="n">WC_STATUS_REMOTE_ERROR_FLAGS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x0</span>:
				<span class="cm">/*</span>
<span class="cm">				 * PSN Sequence Error!</span>
<span class="cm">				 * couldn&#39;t find a matching status!</span>
<span class="cm">				 */</span>
				<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1</span>:
				<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_REM_INV_REQ_ERR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2</span>:
				<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x3</span>:
				<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_REM_OP_ERR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x4</span>:
				<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_REM_INV_RD_REQ_ERR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_RETRY_EXC_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_RNR_RETRY_EXC_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
		<span class="k">case</span> <span class="mh">0x2D</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_REM_ABORT_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0B</span>:
		<span class="k">case</span> <span class="mh">0x2E</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_INV_EECN_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0C</span>:
		<span class="k">case</span> <span class="mh">0x2F</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_INV_EEC_STATE_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0D</span>:
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_BAD_RESP_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="cm">/* WQE purged */</span>
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_FATAL_ERR</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">wc_status</span> <span class="o">=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">post_one_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">my_qp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">cur_send_wr</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">hidden</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_wqe</span> <span class="o">*</span><span class="n">wqe_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_map_idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start_offset</span> <span class="o">=</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">.</span><span class="n">current_q_offset</span><span class="p">;</span>

	<span class="cm">/* get pointer next to free WQE */</span>
	<span class="n">wqe_p</span> <span class="o">=</span> <span class="n">ipz_qeit_get_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">wqe_p</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* too many posted work requests: queue overflow */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ib_qp</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Too many posted WQEs &quot;</span>
			 <span class="s">&quot;qp_num=%x&quot;</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ib_qp</span><span class="p">.</span><span class="n">qp_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the index of the WQE in the send queue. The same index is used</span>
<span class="cm">	 * for writing into the sq_map.</span>
<span class="cm">	 */</span>
	<span class="n">sq_map_idx</span> <span class="o">=</span> <span class="n">start_offset</span> <span class="o">/</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">.</span><span class="n">qe_size</span><span class="p">;</span>

	<span class="cm">/* write a SEND WQE into the QUEUE */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_write_swqe</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="n">wqe_p</span><span class="p">,</span> <span class="n">cur_send_wr</span><span class="p">,</span> <span class="n">sq_map_idx</span><span class="p">,</span> <span class="n">hidden</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * if something failed,</span>
<span class="cm">	 * reset the free entry pointer to the start value</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">.</span><span class="n">current_q_offset</span> <span class="o">=</span> <span class="n">start_offset</span><span class="p">;</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ib_qp</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Could not write WQE &quot;</span>
			 <span class="s">&quot;qp_num=%x&quot;</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ib_qp</span><span class="p">.</span><span class="n">qp_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">send_wr</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">**</span><span class="n">bad_send_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">my_qp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_qp</span><span class="p">,</span> <span class="n">ib_qp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">wqe_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Reject WR if QP is in RESET, INIT or RTR state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">IB_QPS_RTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Invalid QP state  qp_state=%d qpn=%x&quot;</span><span class="p">,</span>
			 <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* LOCK the QUEUE */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">spinlock_s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Send an empty extra RDMA read if:</span>
<span class="cm">	 *  1) there has been an RDMA read on this connection before</span>
<span class="cm">	 *  2) no RDMA read occurred for ACK_CIRC_THRESHOLD link packets</span>
<span class="cm">	 *  3) we can be sure that any previous extra RDMA read has been</span>
<span class="cm">	 *     processed so we don&#39;t overflow the SQ</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">unsol_ack_circ</span> <span class="o">&amp;&amp;</span>
		     <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">packet_count</span> <span class="o">&gt;</span> <span class="n">ACK_CIRC_THRESHOLD</span> <span class="o">&amp;&amp;</span>
		     <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">message_count</span> <span class="o">&gt;</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* insert an empty RDMA READ to fix up the remote QP state */</span>
		<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">circ_wr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circ_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">circ_wr</span><span class="p">));</span>
		<span class="n">circ_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_RDMA_READ</span><span class="p">;</span>
		<span class="n">post_one_send</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">circ_wr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* ignore retcode */</span>
		<span class="n">wqe_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ehca_dbg</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;posted circ wr  qp_num=%x&quot;</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>
		<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">message_count</span> <span class="o">=</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">packet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loop processes list of send reqs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">send_wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">post_one_send</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="n">send_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">post_send_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wqe_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">send_wr</span> <span class="o">=</span> <span class="n">send_wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">post_send_exit0:</span>
	<span class="n">iosync</span><span class="p">();</span> <span class="cm">/* serialize GAL register access */</span>
	<span class="n">hipz_update_sqa</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="n">wqe_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">ehca_dbg</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ehca_qp=%p qp_num=%x wqe_cnt=%d ret=%i&quot;</span><span class="p">,</span>
			 <span class="n">my_qp</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">,</span> <span class="n">wqe_cnt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">message_count</span> <span class="o">+=</span> <span class="n">wqe_cnt</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">spinlock_s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bad_send_wr</span> <span class="o">=</span> <span class="n">send_wr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">internal_post_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">my_qp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">recv_wr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">**</span><span class="n">bad_recv_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_wqe</span> <span class="o">*</span><span class="n">wqe_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wqe_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_map_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_qmap_entry</span> <span class="o">*</span><span class="n">qmap_entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">HAS_RQ</span><span class="p">(</span><span class="n">my_qp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QP has no RQ  ehca_qp=%p qp_num=%x ext_type=%d&quot;</span><span class="p">,</span>
			 <span class="n">my_qp</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ext_type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* LOCK the QUEUE */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">spinlock_r</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* loop processes list of recv reqs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">recv_wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">start_offset</span> <span class="o">=</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_rqueue</span><span class="p">.</span><span class="n">current_q_offset</span><span class="p">;</span>
		<span class="cm">/* get pointer next to free WQE */</span>
		<span class="n">wqe_p</span> <span class="o">=</span> <span class="n">ipz_qeit_get_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_rqueue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">wqe_p</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* too many posted work requests: queue overflow */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Too many posted WQEs &quot;</span>
				<span class="s">&quot;qp_num=%x&quot;</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">post_recv_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Get the index of the WQE in the recv queue. The same index</span>
<span class="cm">		 * is used for writing into the rq_map.</span>
<span class="cm">		 */</span>
		<span class="n">rq_map_idx</span> <span class="o">=</span> <span class="n">start_offset</span> <span class="o">/</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_rqueue</span><span class="p">.</span><span class="n">qe_size</span><span class="p">;</span>

		<span class="cm">/* write a RECV WQE into the QUEUE */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_write_rwqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_rqueue</span><span class="p">,</span> <span class="n">wqe_p</span><span class="p">,</span> <span class="n">recv_wr</span><span class="p">,</span>
				<span class="n">rq_map_idx</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * if something failed,</span>
<span class="cm">		 * reset the free entry pointer to the start value</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ipz_rqueue</span><span class="p">.</span><span class="n">current_q_offset</span> <span class="o">=</span> <span class="n">start_offset</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not write WQE &quot;</span>
				<span class="s">&quot;qp_num=%x&quot;</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">post_recv_exit0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qmap_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">rq_map_idx</span><span class="p">];</span>
		<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">app_wr_id</span> <span class="o">=</span> <span class="n">get_app_wr_id</span><span class="p">(</span><span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
		<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">cqe_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">wqe_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">recv_wr</span> <span class="o">=</span> <span class="n">recv_wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* eof for recv_wr */</span>

<span class="nl">post_recv_exit0:</span>
	<span class="n">iosync</span><span class="p">();</span> <span class="cm">/* serialize GAL register access */</span>
	<span class="n">hipz_update_rqa</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="n">wqe_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
	    <span class="n">ehca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ehca_qp=%p qp_num=%x wqe_cnt=%d ret=%i&quot;</span><span class="p">,</span>
		     <span class="n">my_qp</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">,</span> <span class="n">wqe_cnt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">spinlock_r</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bad_recv_wr</span> <span class="o">=</span> <span class="n">recv_wr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_post_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">recv_wr</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">**</span><span class="n">bad_recv_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">my_qp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_qp</span><span class="p">,</span> <span class="n">ib_qp</span><span class="p">);</span>

	<span class="cm">/* Reject WR if QP is in RESET state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IB_QPS_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Invalid QP state  qp_state=%d qpn=%x&quot;</span><span class="p">,</span>
			 <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bad_recv_wr</span> <span class="o">=</span> <span class="n">recv_wr</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal_post_recv</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">recv_wr</span><span class="p">,</span> <span class="n">bad_recv_wr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_post_srq_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">recv_wr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">**</span><span class="n">bad_recv_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">internal_post_recv</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">srq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_qp</span><span class="p">,</span> <span class="n">ib_srq</span><span class="p">),</span>
				  <span class="n">srq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">recv_wr</span><span class="p">,</span> <span class="n">bad_recv_wr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ib_wc_opcode table converts ehca wc opcode to ib</span>
<span class="cm"> * Since we use zero to indicate invalid opcode, the actual ib opcode must</span>
<span class="cm"> * be decremented!!!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ib_wc_opcode</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_RECV_RDMA_WITH_IMM</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_BIND_MW</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_FETCH_ADD</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_COMP_SWAP</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_RDMA_WRITE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_RDMA_READ</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x80</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_WC_SEND</span><span class="o">+</span><span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/* internal function to poll one entry of cq */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_poll_cq_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qmap_tail_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_cq</span> <span class="o">*</span><span class="n">my_cq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_cq</span><span class="p">,</span> <span class="n">ib_cq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">my_qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_qmap_entry</span> <span class="o">*</span><span class="n">qmap_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_queue_map</span> <span class="o">*</span><span class="n">qmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cqe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_error</span><span class="p">;</span>

<span class="nl">repoll:</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehca_cqe</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">ipz_qeit_get_inc_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">ipz_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">ehca_dbg</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Completion queue is empty  &quot;</span>
				 <span class="s">&quot;my_cq=%p cq_num=%x&quot;</span><span class="p">,</span> <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">poll_cq_one_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prevents loads being reordered across this point */</span>
	<span class="n">rmb</span><span class="p">();</span>

	<span class="n">cqe_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">WC_STATUS_PURGE_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">purgeflag</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">qp</span> <span class="o">=</span> <span class="n">ehca_cq_get_qp</span><span class="p">(</span><span class="n">my_cq</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">local_qp_number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;cq_num=%x qp_num=%x &quot;</span>
				 <span class="s">&quot;could not find qp -&gt; ignore cqe&quot;</span><span class="p">,</span>
				 <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">local_qp_number</span><span class="p">);</span>
			<span class="n">ehca_dmp</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;cq_num=%x qp_num=%x&quot;</span><span class="p">,</span>
				 <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">local_qp_number</span><span class="p">);</span>
			<span class="cm">/* ignore this purged cqe */</span>
			<span class="k">goto</span> <span class="n">repoll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">spinlock_s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">purgeflag</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">sqerr_purgeflag</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">spinlock_s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">purgeflag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_dbg</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				 <span class="s">&quot;Got CQE with purged bit qp_num=%x src_qp=%x&quot;</span><span class="p">,</span>
				 <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">local_qp_number</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">remote_qp_number</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">ehca_dmp</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;qp_num=%x src_qp=%x&quot;</span><span class="p">,</span>
					 <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">local_qp_number</span><span class="p">,</span>
					 <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">remote_qp_number</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * ignore this to avoid double cqes of bad wqe</span>
<span class="cm">			 * that caused sqe and turn off purge flag</span>
<span class="cm">			 */</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">sqerr_purgeflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">repoll</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">is_error</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">WC_STATUS_ERROR_BIT</span><span class="p">;</span>

	<span class="cm">/* trace error CQEs if debug_level &gt;= 1, trace all CQEs if &gt;= 3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">||</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&amp;&amp;</span> <span class="n">is_error</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ehca_dbg</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			 <span class="s">&quot;Received %sCOMPLETION ehca_cq=%p cq_num=%x -----&quot;</span><span class="p">,</span>
			 <span class="n">is_error</span> <span class="o">?</span> <span class="s">&quot;ERROR &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="n">ehca_dmp</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;ehca_cq=%p cq_num=%x&quot;</span><span class="p">,</span>
			 <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="n">ehca_dbg</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			 <span class="s">&quot;ehca_cq=%p cq_num=%x -------------------------&quot;</span><span class="p">,</span>
			 <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehca_qp_idr_lock</span><span class="p">);</span>
	<span class="n">my_qp</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehca_qp_idr</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">qp_token</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehca_qp_idr_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_qp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">repoll</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ib_qp</span><span class="p">;</span>

	<span class="n">qmap_tail_idx</span> <span class="o">=</span> <span class="n">get_app_wr_id</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">work_request_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">w_completion_flags</span> <span class="o">&amp;</span> <span class="n">WC_SEND_RECEIVE_BIT</span><span class="p">))</span>
		<span class="cm">/* We got a send completion. */</span>
		<span class="n">qmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* We got a receive completion. */</span>
		<span class="n">qmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">;</span>

	<span class="cm">/* advance the tail pointer */</span>
	<span class="n">qmap</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">qmap_tail_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * set left_to_poll to 0 because in error state, we will not</span>
<span class="cm">		 * get any additional CQEs</span>
<span class="cm">		 */</span>
		<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">.</span><span class="n">next_wqe_idx</span> <span class="o">=</span> <span class="n">next_index</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
							<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
		<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">.</span><span class="n">left_to_poll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ehca_add_to_err_list</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">.</span><span class="n">next_wqe_idx</span> <span class="o">=</span> <span class="n">next_index</span><span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
							<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
		<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">.</span><span class="n">left_to_poll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_RQ</span><span class="p">(</span><span class="n">my_qp</span><span class="p">))</span>
			<span class="n">ehca_add_to_err_list</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qmap_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">qmap_tail_idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">reported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_warn</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Double cqe on qp_num=%#x&quot;</span><span class="p">,</span>
				<span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">);</span>
		<span class="cm">/* found a double cqe, discard it and read next one */</span>
		<span class="k">goto</span> <span class="n">repoll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">replace_wr_id</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">work_request_id</span><span class="p">,</span> <span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">app_wr_id</span><span class="p">);</span>
	<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">reported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if left_to_poll is decremented to 0, add the QP to the error list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">left_to_poll</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qmap</span><span class="o">-&gt;</span><span class="n">left_to_poll</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">.</span><span class="n">left_to_poll</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">.</span><span class="n">left_to_poll</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_add_to_err_list</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HAS_RQ</span><span class="p">(</span><span class="n">my_qp</span><span class="p">))</span>
				<span class="n">ehca_add_to_err_list</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* eval ib_wc_opcode */</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">ib_wc_opcode</span><span class="p">[</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">optype</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Invalid cqe-&gt;OPType=%x cqe-&gt;status=%x &quot;</span>
			 <span class="s">&quot;ehca_cq=%p cq_num=%x&quot;</span><span class="p">,</span>
			 <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">optype</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="cm">/* dump cqe for other infos */</span>
		<span class="n">ehca_dmp</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;ehca_cq=%p cq_num=%x&quot;</span><span class="p">,</span>
			 <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="cm">/* update also queue adder to throw away this entry!!! */</span>
		<span class="k">goto</span> <span class="n">repoll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* eval ib_wc_status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_error</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* complete with errors */</span>
		<span class="n">map_ib_wc_status</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">vendor_err</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">;</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">nr_bytes_transferred</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">pkey_index</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">pkey_index</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">slid</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">rlid</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">dlid_path_bits</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">dlid</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">src_qp</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">remote_qp_number</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * HW has &quot;Immed data present&quot; and &quot;GRH present&quot; in bits 6 and 5.</span>
<span class="cm">	 * SW defines those in bits 1 and 0, so we can just shift and mask.</span>
<span class="cm">	 */</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">w_completion_flags</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">imm_data</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immediate_data</span><span class="p">);</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">sl</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">service_level</span><span class="p">;</span>

<span class="nl">poll_cq_one_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hipz_update_feca</span><span class="p">(</span><span class="n">my_cq</span><span class="p">,</span> <span class="n">cqe_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generate_flush_cqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">my_qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ipz_queue</span> <span class="o">*</span><span class="n">ipz_queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on_sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_wqe</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_queue_map</span> <span class="o">*</span><span class="n">qmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_qmap_entry</span> <span class="o">*</span><span class="n">qmap_entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on_sq</span><span class="p">)</span>
		<span class="n">qmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">sq_map</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">rq_map</span><span class="p">;</span>

	<span class="n">qmap_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">next_wqe_idx</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">reported</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* generate flush CQE */</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wc</span><span class="p">));</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">qmap</span><span class="o">-&gt;</span><span class="n">next_wqe_idx</span> <span class="o">*</span> <span class="n">ipz_queue</span><span class="o">-&gt;</span><span class="n">qe_size</span><span class="p">;</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehca_wqe</span> <span class="o">*</span><span class="p">)</span><span class="n">ipz_qeit_calc</span><span class="p">(</span><span class="n">ipz_queue</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wqe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Invalid wqe offset=%#llx on &quot;</span>
				 <span class="s">&quot;qp_num=%#x&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">real_qp_num</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">replace_wr_id</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">work_request_id</span><span class="p">,</span>
					  <span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">app_wr_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">on_sq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">optype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WQE_OPTYPE_SEND</span>:
				<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_SEND</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WQE_OPTYPE_RDMAWRITE</span>:
				<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_RDMA_WRITE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WQE_OPTYPE_RDMAREAD</span>:
				<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_RDMA_READ</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ehca_err</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Invalid optype=%x&quot;</span><span class="p">,</span>
						<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">optype</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">wr_flag</span> <span class="o">&amp;</span> <span class="n">WQE_WRFLAG_IMM_DATA_PRESENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">imm_data</span> <span class="o">=</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">immediate_data</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">|=</span> <span class="n">IB_WC_WITH_IMM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>

		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">ib_qp</span><span class="p">;</span>

		<span class="cm">/* mark as reported and advance next_wqe pointer */</span>
		<span class="n">qmap_entry</span><span class="o">-&gt;</span><span class="n">reported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qmap</span><span class="o">-&gt;</span><span class="n">next_wqe_idx</span> <span class="o">=</span> <span class="n">next_index</span><span class="p">(</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">next_wqe_idx</span><span class="p">,</span>
						<span class="n">qmap</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
		<span class="n">qmap_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">qmap</span><span class="o">-&gt;</span><span class="n">next_wqe_idx</span><span class="p">];</span>

		<span class="n">wc</span><span class="o">++</span><span class="p">;</span> <span class="n">nr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_cq</span> <span class="o">*</span><span class="n">my_cq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_cq</span><span class="p">,</span> <span class="n">ib_cq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_qp</span> <span class="o">*</span><span class="n">err_qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">current_wc</span> <span class="o">=</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries_left</span> <span class="o">=</span> <span class="n">num_entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Invalid num_entries=%d ehca_cq=%p &quot;</span>
			 <span class="s">&quot;cq_num=%x&quot;</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">,</span> <span class="n">my_cq</span><span class="p">,</span> <span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">cq_number</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">poll_cq_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* generate flush cqes for send queues */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">err_qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">sqp_err_list</span><span class="p">,</span> <span class="n">sq_err_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">generate_flush_cqes</span><span class="p">(</span><span class="n">err_qp</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">current_wc</span><span class="p">,</span> <span class="n">entries_left</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">err_qp</span><span class="o">-&gt;</span><span class="n">ipz_squeue</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">entries_left</span> <span class="o">-=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">current_wc</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entries_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* generate flush cqes for receive queues */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">err_qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">rqp_err_list</span><span class="p">,</span> <span class="n">rq_err_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">generate_flush_cqes</span><span class="p">(</span><span class="n">err_qp</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">current_wc</span><span class="p">,</span> <span class="n">entries_left</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">err_qp</span><span class="o">-&gt;</span><span class="n">ipz_rqueue</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">entries_left</span> <span class="o">-=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">current_wc</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entries_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="n">entries_left</span><span class="p">;</span> <span class="n">nr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_poll_cq_one</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">current_wc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">current_wc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* eof for nr */</span>
	<span class="n">entries_left</span> <span class="o">-=</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span>  <span class="o">||</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">num_entries</span> <span class="o">-</span> <span class="n">entries_left</span><span class="p">;</span>

<span class="nl">poll_cq_exit0:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_req_notify_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_cq_notify_flags</span> <span class="n">notify_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_cq</span> <span class="o">*</span><span class="n">my_cq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_cq</span><span class="p">,</span> <span class="n">ib_cq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">notify_flags</span> <span class="o">&amp;</span> <span class="n">IB_CQ_SOLICITED_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_CQ_SOLICITED</span>:
		<span class="n">hipz_set_cqx_n0</span><span class="p">(</span><span class="n">my_cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_CQ_NEXT_COMP</span>:
		<span class="n">hipz_set_cqx_n1</span><span class="p">(</span><span class="n">my_cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_flags</span> <span class="o">&amp;</span> <span class="n">IB_CQ_REPORT_MISSED_EVENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spl_flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">spl_flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipz_qeit_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">ipz_queue</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">spl_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
