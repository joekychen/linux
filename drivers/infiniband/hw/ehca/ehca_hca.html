<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ehca › ehca_hca.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ehca_hca.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  IBM eServer eHCA Infiniband device driver for Linux on POWER</span>
<span class="cm"> *</span>
<span class="cm"> *  HCA query functions</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors: Heiko J Schick &lt;schickhj@de.ibm.com&gt;</span>
<span class="cm"> *           Christoph Raisch &lt;raisch@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2005 IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  This source code is distributed under a dual license of GPL v2.0 and OpenIB</span>
<span class="cm"> *  BSD.</span>
<span class="cm"> *</span>
<span class="cm"> * OpenIB BSD License</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistributions of source code must retain the above copyright notice, this</span>
<span class="cm"> * list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="cm"> * this list of conditions and the following disclaimer in the documentation</span>
<span class="cm"> * and/or other materials</span>
<span class="cm"> * provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="cm"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER</span>
<span class="cm"> * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &quot;ehca_tools.h&quot;</span>
<span class="cp">#include &quot;ehca_iverbs.h&quot;</span>
<span class="cp">#include &quot;hcp_if.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">limit_uint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_query_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="o">*</span><span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span>
					      <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hipz_query_hca</span> <span class="o">*</span><span class="n">rblock</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cap_mapping</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">IB_DEVICE_RESIZE_MAX_WR</span><span class="p">,</span>      <span class="n">HCA_CAP_WQE_RESIZE</span><span class="p">,</span>
		<span class="n">IB_DEVICE_BAD_PKEY_CNTR</span><span class="p">,</span>      <span class="n">HCA_CAP_BAD_P_KEY_CTR</span><span class="p">,</span>
		<span class="n">IB_DEVICE_BAD_QKEY_CNTR</span><span class="p">,</span>      <span class="n">HCA_CAP_Q_KEY_VIOL_CTR</span><span class="p">,</span>
		<span class="n">IB_DEVICE_RAW_MULTI</span><span class="p">,</span>          <span class="n">HCA_CAP_RAW_PACKET_MCAST</span><span class="p">,</span>
		<span class="n">IB_DEVICE_AUTO_PATH_MIG</span><span class="p">,</span>      <span class="n">HCA_CAP_AUTO_PATH_MIG</span><span class="p">,</span>
		<span class="n">IB_DEVICE_CHANGE_PHY_PORT</span><span class="p">,</span>    <span class="n">HCA_CAP_SQD_RTS_PORT_CHANGE</span><span class="p">,</span>
		<span class="n">IB_DEVICE_UD_AV_PORT_ENFORCE</span><span class="p">,</span> <span class="n">HCA_CAP_AH_PORT_NR_CHECK</span><span class="p">,</span>
		<span class="n">IB_DEVICE_CURR_QP_STATE_MOD</span><span class="p">,</span>  <span class="n">HCA_CAP_CUR_QP_STATE_MOD</span><span class="p">,</span>
		<span class="n">IB_DEVICE_SHUTDOWN_PORT</span><span class="p">,</span>      <span class="n">HCA_CAP_SHUTDOWN_PORT</span><span class="p">,</span>
		<span class="n">IB_DEVICE_INIT_TYPE</span><span class="p">,</span>          <span class="n">HCA_CAP_INIT_TYPE</span><span class="p">,</span>
		<span class="n">IB_DEVICE_PORT_ACTIVE_EVENT</span><span class="p">,</span>  <span class="n">HCA_CAP_PORT_ACTIVE_EVENT</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate rblock memory.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hipz_h_query_hca</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">rblock</span><span class="p">)</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t query device properties&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">query_device1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device_attr</span><span class="p">));</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">page_size_cap</span>   <span class="o">=</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">hca_cap_mr_pgsize</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">fw_ver</span>          <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">hw_ver</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mr_size</span>     <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mr_size</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">vendor_id</span>       <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">vendor_part_id</span>  <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">vendor_part_id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">hw_ver</span>          <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">hw_ver</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_wr</span>       <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_wqes_wq</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_sge</span>         <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_sge</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_sge_rd</span>      <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_sge_rd</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_cq</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_cq</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_cqe</span>         <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_cqe</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mr</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mr</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mw</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mw</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_pd</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_pd</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_ah</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_ah</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_ee</span>          <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_rd_ee_context</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_rdd</span>         <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_rd_domain</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_fmr</span>         <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mr</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_rd_atom</span>  <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_rr_qp</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_ee_rd_atom</span>  <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_rr_ee_context</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_res_rd_atom</span> <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_rr_hca</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_init_rd_atom</span> <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_act_wqs_qp</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_ee_init_rd_atom</span> <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_act_wqs_ee_context</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EHCA_BMASK_GET</span><span class="p">(</span><span class="n">HCA_CAP_SRQ</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">hca_cap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_srq</span>         <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp</span><span class="p">);</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_srq_wr</span>      <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_wr</span><span class="p">);</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_srq_sge</span>     <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_pkeys</span>           <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* Some FW versions say 0 here; insert sensible value in that case */</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span>  <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span> <span class="o">?</span>
		<span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_raw_ipv6_qp</span>     <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_raw_ipv6_qp</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_raw_ethy_qp</span>     <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_raw_ethy_qp</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mcast_grp</span>       <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mcast_grp</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mcast_qp_attach</span> <span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mcast_qp_attach</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_total_mcast_qp_attach</span>
		<span class="o">=</span> <span class="n">limit_uint</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_total_mcast_qp_attach</span><span class="p">);</span>

	<span class="cm">/* translate device capabilities */</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">=</span> <span class="n">IB_DEVICE_SYS_IMAGE_GUID</span> <span class="o">|</span>
		<span class="n">IB_DEVICE_RC_RNR_NAK_GEN</span> <span class="o">|</span> <span class="n">IB_DEVICE_N_NOTIFY_CQ</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cap_mapping</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">hca_cap_indicators</span> <span class="o">&amp;</span> <span class="n">cap_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
			<span class="n">props</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">cap_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="nl">query_device1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">rblock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ib_mtu</span> <span class="nf">map_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fw_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fw_mtu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">return</span> <span class="n">IB_MTU_256</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">return</span> <span class="n">IB_MTU_512</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="k">return</span> <span class="n">IB_MTU_1024</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="k">return</span> <span class="n">IB_MTU_2048</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="k">return</span> <span class="n">IB_MTU_4096</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Unknown MTU size: %x.&quot;</span><span class="p">,</span>
			 <span class="n">fw_mtu</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">map_number_of_vls</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vl_cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vl_cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="k">return</span> <span class="mi">15</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;invalid Vl Capability: %x.&quot;</span><span class="p">,</span>
			 <span class="n">vl_cap</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_query_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="o">*</span><span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span>
					      <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hipz_query_port</span> <span class="o">*</span><span class="n">rblock</span><span class="p">;</span>

	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate rblock memory.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_query_port</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t query port properties&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">query_port1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port_attr</span><span class="p">));</span>

	<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_mtu</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="n">map_mtu</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">port_cap_flags</span>  <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">capability_mask</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">gid_tbl_len</span>     <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">gid_tbl_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span>      <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span>      <span class="o">=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">bad_pkey_cntr</span>   <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">bad_pkey_cntr</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">qkey_viol_cntr</span>  <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">qkey_viol_cntr</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">pkey_tbl_len</span>    <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">pkey_tbl_len</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">lid</span>             <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">sm_lid</span>          <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">sm_lid</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">lmc</span>             <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">lmc</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">sm_sl</span>           <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">sm_sl</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">subnet_timeout</span>  <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">subnet_timeout</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">init_type_reply</span> <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">init_type_reply</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_vl_num</span>      <span class="o">=</span> <span class="n">map_number_of_vls</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">vl_cap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">phys_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">phys_state</span>      <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">phys_pstate</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">state</span>           <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">phys_state</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_width</span>    <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">phys_width</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_speed</span>    <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">phys_speed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* old firmware releases don&#39;t report physical</span>
<span class="cm">		 * port info, so use default values</span>
<span class="cm">		 */</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">phys_state</span>      <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">state</span>           <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_width</span>    <span class="o">=</span> <span class="n">IB_WIDTH_12X</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_speed</span>    <span class="o">=</span> <span class="n">IB_SPEED_SDR</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">query_port1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">rblock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_query_sma_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_sma_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hipz_query_port</span> <span class="o">*</span><span class="n">rblock</span><span class="p">;</span>

	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate rblock memory.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_query_port</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t query port properties&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">query_sma_attr1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_sma_attr</span><span class="p">));</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">lid</span>    <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">lmc</span>    <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">lmc</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sm_sl</span>  <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">sm_sl</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sm_lid</span> <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">sm_lid</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pkey_tbl_len</span> <span class="o">=</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">pkey_tbl_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">,</span> <span class="n">rblock</span><span class="o">-&gt;</span><span class="n">pkey_entries</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">));</span>

<span class="nl">query_sma_attr1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">rblock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_query_pkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hipz_query_port</span> <span class="o">*</span><span class="n">rblock</span><span class="p">;</span>

	<span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Invalid index: %x.&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span>  <span class="s">&quot;Can&#39;t allocate rblock memory.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_query_port</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t query port properties&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">query_pkey1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">pkey_entries</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

<span class="nl">query_pkey1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">rblock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_query_gid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span>
					      <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hipz_query_port</span> <span class="o">*</span><span class="n">rblock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Invalid index: %x.&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate rblock memory.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_query_port</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t query port properties&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">query_gid1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">gid_prefix</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">guid_entries</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

<span class="nl">query_gid1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">rblock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">allowed_port_caps</span> <span class="o">=</span> <span class="p">(</span>
	<span class="n">IB_PORT_SM</span> <span class="o">|</span> <span class="n">IB_PORT_LED_INFO_SUP</span> <span class="o">|</span> <span class="n">IB_PORT_CM_SUP</span> <span class="o">|</span>
	<span class="n">IB_PORT_SNMP_TUNNEL_SUP</span> <span class="o">|</span> <span class="n">IB_PORT_DEVICE_MGMT_SUP</span> <span class="o">|</span>
	<span class="n">IB_PORT_VENDOR_CLASS_SUP</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ehca_modify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_modify_mask</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ib_port_modify</span> <span class="o">*</span><span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hipz_query_port</span> <span class="o">*</span><span class="n">rblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">set_port_cap_mask</span> <span class="o">|</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">clr_port_cap_mask</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="o">~</span><span class="n">allowed_port_caps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Non-changeable bits set in masks  &quot;</span>
			 <span class="s">&quot;set=%x  clr=%x  allowed=%x&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">set_port_cap_mask</span><span class="p">,</span>
			 <span class="n">props</span><span class="o">-&gt;</span><span class="n">clr_port_cap_mask</span><span class="p">,</span> <span class="n">allowed_port_caps</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">modify_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span>  <span class="s">&quot;Can&#39;t allocate rblock memory.&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">modify_port1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">hipz_h_query_port</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Can&#39;t query port properties&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">modify_port2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">capability_mask</span> <span class="o">|</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">set_port_cap_mask</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">clr_port_cap_mask</span><span class="p">;</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">hipz_h_modify_port</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				  <span class="n">cap</span><span class="p">,</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">init_type</span><span class="p">,</span> <span class="n">port_modify_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Modify port failed  h_ret=%lli&quot;</span><span class="p">,</span>
			 <span class="n">hret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">modify_port2:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">rblock</span><span class="p">);</span>

<span class="nl">modify_port1:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">modify_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
