<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ehca › ehca_mrmw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ehca_mrmw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  IBM eServer eHCA Infiniband device driver for Linux on POWER</span>
<span class="cm"> *</span>
<span class="cm"> *  MR/MW functions</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors: Dietmar Decker &lt;ddecker@de.ibm.com&gt;</span>
<span class="cm"> *           Christoph Raisch &lt;raisch@de.ibm.com&gt;</span>
<span class="cm"> *           Hoang-Nam Nguyen &lt;hnguyen@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2005 IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  This source code is distributed under a dual license of GPL v2.0 and OpenIB</span>
<span class="cm"> *  BSD.</span>
<span class="cm"> *</span>
<span class="cm"> * OpenIB BSD License</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistributions of source code must retain the above copyright notice, this</span>
<span class="cm"> * list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="cm"> * this list of conditions and the following disclaimer in the documentation</span>
<span class="cm"> * and/or other materials</span>
<span class="cm"> * provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="cm"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER</span>
<span class="cm"> * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_umem.h&gt;</span>

<span class="cp">#include &quot;ehca_iverbs.h&quot;</span>
<span class="cp">#include &quot;ehca_mrmw.h&quot;</span>
<span class="cp">#include &quot;hcp_if.h&quot;</span>
<span class="cp">#include &quot;hipz_hw.h&quot;</span>

<span class="cp">#define NUM_CHUNKS(length, chunk_size) \</span>
<span class="cp">	(((length) + (chunk_size - 1)) / (chunk_size))</span>

<span class="cm">/* max number of rpages (per hcall register_rpages) */</span>
<span class="cp">#define MAX_RPAGES 512</span>

<span class="cm">/* DMEM toleration management */</span>
<span class="cp">#define EHCA_SECTSHIFT        SECTION_SIZE_BITS</span>
<span class="cp">#define EHCA_SECTSIZE          (1UL &lt;&lt; EHCA_SECTSHIFT)</span>
<span class="cp">#define EHCA_HUGEPAGESHIFT     34</span>
<span class="cp">#define EHCA_HUGEPAGE_SIZE     (1UL &lt;&lt; EHCA_HUGEPAGESHIFT)</span>
<span class="cp">#define EHCA_HUGEPAGE_PFN_MASK ((EHCA_HUGEPAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT)</span>
<span class="cp">#define EHCA_INVAL_ADDR        0xFFFFFFFFFFFFFFFFULL</span>
<span class="cp">#define EHCA_DIR_INDEX_SHIFT 13                   </span><span class="cm">/* 8k Entries in 64k block */</span><span class="cp"></span>
<span class="cp">#define EHCA_TOP_INDEX_SHIFT (EHCA_DIR_INDEX_SHIFT * 2)</span>
<span class="cp">#define EHCA_MAP_ENTRIES (1 &lt;&lt; EHCA_DIR_INDEX_SHIFT)</span>
<span class="cp">#define EHCA_TOP_MAP_SIZE (0x10000)               </span><span class="cm">/* currently fixed map size */</span><span class="cp"></span>
<span class="cp">#define EHCA_DIR_MAP_SIZE (0x10000)</span>
<span class="cp">#define EHCA_ENT_MAP_SIZE (0x10000)</span>
<span class="cp">#define EHCA_INDEX_MASK (EHCA_MAP_ENTRIES - 1)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ehca_mr_len</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Memory map data structures</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehca_dir_bmap</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">ent</span><span class="p">[</span><span class="n">EHCA_MAP_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">ehca_top_bmap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_dir_bmap</span> <span class="o">*</span><span class="n">dir</span><span class="p">[</span><span class="n">EHCA_MAP_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">ehca_bmap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_top_bmap</span> <span class="o">*</span><span class="n">top</span><span class="p">[</span><span class="n">EHCA_MAP_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ehca_bmap</span> <span class="o">*</span><span class="n">ehca_bmap</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">mr_cache</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">mw_cache</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">ehca_mr_pgsize</span> <span class="p">{</span>
	<span class="n">EHCA_MR_PGSIZE4K</span>  <span class="o">=</span> <span class="mh">0x1000L</span><span class="p">,</span>
	<span class="n">EHCA_MR_PGSIZE64K</span> <span class="o">=</span> <span class="mh">0x10000L</span><span class="p">,</span>
	<span class="n">EHCA_MR_PGSIZE1M</span>  <span class="o">=</span> <span class="mh">0x100000L</span><span class="p">,</span>
	<span class="n">EHCA_MR_PGSIZE16M</span> <span class="o">=</span> <span class="mh">0x1000000L</span>
<span class="p">};</span>

<span class="cp">#define EHCA_MR_PGSHIFT4K  12</span>
<span class="cp">#define EHCA_MR_PGSHIFT64K 16</span>
<span class="cp">#define EHCA_MR_PGSHIFT1M  20</span>
<span class="cp">#define EHCA_MR_PGSHIFT16M 24</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">ehca_map_vaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">caddr</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ehca_encode_hwpage_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">pgsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">log</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">pgsize</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">log</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">log</span> <span class="o">&gt;</span> <span class="mi">24</span> <span class="o">||</span> <span class="n">log</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">log</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_get_max_hwpage_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">hca_cap_mr_pgsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="nf">ehca_mr_new</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">me</span><span class="p">;</span>

	<span class="n">me</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">mr_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mrlock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;alloc failed&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">me</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_mr_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">mr_cache</span><span class="p">,</span> <span class="n">me</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ehca_mw</span> <span class="o">*</span><span class="nf">ehca_mw_new</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehca_mw</span> <span class="o">*</span><span class="n">me</span><span class="p">;</span>

	<span class="n">me</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">mw_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mwlock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;alloc failed&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">me</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_mw_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mw</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">mw_cache</span><span class="p">,</span> <span class="n">me</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">ehca_get_dma_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mr_access_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ib_mr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_maxmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_maxmr</span> <span class="o">=</span> <span class="n">ehca_mr_new</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e_maxmr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;out of memory&quot;</span><span class="p">);</span>
			<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">get_dma_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_maxmr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_maxmr</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ehca_map_vaddr</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">KERNELBASE</span> <span class="o">+</span> <span class="n">PHYSICAL_START</span><span class="p">)),</span>
				     <span class="n">mr_access_flags</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">e_maxmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">e_maxmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_maxmr</span><span class="p">);</span>
			<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">get_dma_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e_maxmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;no internal max-MR exist!&quot;</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_dma_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">get_dma_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">))</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;h_ret=%li pd=%p mr_access_flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">),</span> <span class="n">pd</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ib_mr</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_get_dma_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">ehca_reg_phys_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">phys_buf_array</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">mr_access_flags</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ib_mr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>

	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">num_phys_buf</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">phys_buf_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: num_phys_buf=%x &quot;</span>
			 <span class="s">&quot;phys_buf_array=%p&quot;</span><span class="p">,</span> <span class="n">num_phys_buf</span><span class="p">,</span> <span class="n">phys_buf_array</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_ATOMIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remote Write Access requires Local Write Access</span>
<span class="cm">		 * Remote Atomic Access requires Local Write Access</span>
<span class="cm">		 */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: mr_access_flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">mr_access_flags</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check physical buffer list and calculate size */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_mr_chk_buf_and_calc_size</span><span class="p">(</span><span class="n">phys_buf_array</span><span class="p">,</span> <span class="n">num_phys_buf</span><span class="p">,</span>
					    <span class="n">iova_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: size=%llx iova_start=%p&quot;</span><span class="p">,</span>
			 <span class="n">size</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_mr</span> <span class="o">=</span> <span class="n">ehca_mr_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e_mr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;out of memory&quot;</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register MR on HCA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehca_mr_is_maxmr</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EHCA_MR_FLAG_MAXMR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_maxmr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">,</span>
				     <span class="n">e_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">reg_phys_mr_exit1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">num_kpages</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">num_hwpages</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">hw_pgsize</span><span class="p">;</span>

		<span class="n">num_kpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="cm">/* for kernel space we try most possible pgsize */</span>
		<span class="n">hw_pgsize</span> <span class="o">=</span> <span class="n">ehca_get_max_hwpage_size</span><span class="p">(</span><span class="n">shca</span><span class="p">);</span>
		<span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">%</span> <span class="n">hw_pgsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span>
					 <span class="n">hw_pgsize</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">EHCA_MR_PGI_PHYS</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">num_kpages</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">hw_pgsize</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">num_hwpages</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">num_phys_buf</span> <span class="o">=</span> <span class="n">num_phys_buf</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">phys_buf_array</span> <span class="o">=</span> <span class="n">phys_buf_array</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">next_hwpage</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">/</span> <span class="n">hw_pgsize</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">,</span>
				  <span class="n">e_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">rkey</span><span class="p">,</span> <span class="n">EHCA_REG_MR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">reg_phys_mr_exit1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* successful registration of all pages */</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">;</span>

<span class="nl">reg_phys_mr_exit1:</span>
	<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_mr</span><span class="p">);</span>
<span class="nl">reg_phys_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">))</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;h_ret=%li pd=%p phys_buf_array=%p &quot;</span>
			 <span class="s">&quot;num_phys_buf=%x mr_access_flags=%x iova_start=%p&quot;</span><span class="p">,</span>
			 <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">),</span> <span class="n">pd</span><span class="p">,</span> <span class="n">phys_buf_array</span><span class="p">,</span>
			 <span class="n">num_phys_buf</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ib_mr</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_phys_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">ehca_reg_user_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">length</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">virt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mr_access_flags</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ib_mr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">page_shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hwpage_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad pd=%p&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_ATOMIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remote Write Access requires Local Write Access</span>
<span class="cm">		 * Remote Atomic Access requires Local Write Access</span>
<span class="cm">		 */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: mr_access_flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">mr_access_flags</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">virt</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: length=%llx &quot;</span>
			 <span class="s">&quot;virt_base=%llx&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">virt</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_mr</span> <span class="o">=</span> <span class="n">ehca_mr_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e_mr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;out of memory&quot;</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span> <span class="o">=</span> <span class="n">ib_umem_get</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
				 <span class="n">mr_access_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_exit1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">!=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;page size not supported, &quot;</span>
			 <span class="s">&quot;e_mr-&gt;umem-&gt;page_size=%x&quot;</span><span class="p">,</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_exit2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine number of MR pages */</span>
	<span class="n">num_kpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">((</span><span class="n">virt</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="cm">/* select proper hw_pgsize */</span>
	<span class="n">page_shift</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">hugetlb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* determine page_shift, clamp between 4K and 16M */</span>
		<span class="n">page_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">fls64</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">page_shift</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">page_shift</span><span class="p">,</span> <span class="n">EHCA_MR_PGSHIFT4K</span><span class="p">),</span>
				 <span class="n">EHCA_MR_PGSHIFT16M</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hwpage_size</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">page_shift</span><span class="p">;</span>

	<span class="cm">/* now that we have the desired page size, shift until it&#39;s</span>
<span class="cm">	 * supported, too. 4K is always supported, so this terminates.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwpage_size</span> <span class="o">&amp;</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">hca_cap_mr_pgsize</span><span class="p">))</span>
		<span class="n">hwpage_size</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>

<span class="nl">reg_user_mr_fallback:</span>
	<span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">((</span><span class="n">virt</span> <span class="o">%</span> <span class="n">hwpage_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">,</span> <span class="n">hwpage_size</span><span class="p">);</span>
	<span class="cm">/* register MR on HCA */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">EHCA_MR_PGI_USER</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">next_hwpage</span> <span class="o">=</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">/</span> <span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span> <span class="o">=</span> <span class="n">list_prepare_entry</span><span class="p">(</span><span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span><span class="p">,</span>
						     <span class="p">(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">),</span>
						     <span class="n">list</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">virt</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">,</span>
			  <span class="n">e_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">rkey</span><span class="p">,</span> <span class="n">EHCA_REG_MR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">&amp;&amp;</span> <span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_warn</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;failed to register mr &quot;</span>
			  <span class="s">&quot;with hwpage_size=%llx&quot;</span><span class="p">,</span> <span class="n">hwpage_size</span><span class="p">);</span>
		<span class="n">ehca_info</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;try to register mr with &quot;</span>
			  <span class="s">&quot;kpage_size=%lx&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * this means kpages are not contiguous for a hw page</span>
<span class="cm">		 * try kernel page size as fallback solution</span>
<span class="cm">		 */</span>
		<span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_fallback</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_mr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reg_user_mr_exit2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* successful registration of all pages */</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">;</span>

<span class="nl">reg_user_mr_exit2:</span>
	<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
<span class="nl">reg_user_mr_exit1:</span>
	<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_mr</span><span class="p">);</span>
<span class="nl">reg_user_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">))</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;rc=%li pd=%p mr_access_flags=%x udata=%p&quot;</span><span class="p">,</span>
			 <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">),</span> <span class="n">pd</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">,</span> <span class="n">udata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ib_mr</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_user_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_rereg_phys_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">mr_rereg_mask</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">phys_buf_array</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">mr_access_flags</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">new_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">new_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">new_pd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_lkey</span><span class="p">,</span> <span class="n">tmp_rkey</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sl_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_kpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_hwpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_TRANS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TODO not supported, because PHYP rereg hCall needs pages */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;rereg without IB_MR_REREG_TRANS not &quot;</span>
			 <span class="s">&quot;supported yet, mr_rereg_mask=%x&quot;</span><span class="p">,</span> <span class="n">mr_rereg_mask</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_PD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;rereg with bad pd, pd=%p &quot;</span>
				 <span class="s">&quot;mr_rereg_mask=%x&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">mr_rereg_mask</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span>
	     <span class="o">~</span><span class="p">(</span><span class="n">IB_MR_REREG_TRANS</span> <span class="o">|</span> <span class="n">IB_MR_REREG_PD</span> <span class="o">|</span> <span class="n">IB_MR_REREG_ACCESS</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check other parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span> <span class="o">==</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should be impossible, however reject to be sure */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;rereg internal max-MR impossible, mr=%p &quot;</span>
			 <span class="s">&quot;shca-&gt;maxmr=%p mr-&gt;lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">mr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">,</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_TRANS</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* transl., i.e. addr/size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;not supported for FMR, mr=%p &quot;</span>
				 <span class="s">&quot;flags=%x&quot;</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_buf_array</span> <span class="o">||</span> <span class="n">num_phys_buf</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values mr_rereg_mask=%x&quot;</span>
				 <span class="s">&quot; phys_buf_array=%p num_phys_buf=%x&quot;</span><span class="p">,</span>
				 <span class="n">mr_rereg_mask</span><span class="p">,</span> <span class="n">phys_buf_array</span><span class="p">,</span> <span class="n">num_phys_buf</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_ACCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* change ACL */</span>
	    <span class="p">(((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_ATOMIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remote Write Access requires Local Write Access</span>
<span class="cm">		 * Remote Atomic Access requires Local Write Access</span>
<span class="cm">		 */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: mr_rereg_mask=%x &quot;</span>
			 <span class="s">&quot;mr_access_flags=%x&quot;</span><span class="p">,</span> <span class="n">mr_rereg_mask</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rereg_phys_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set requested values dependent on rereg request */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">mrlock</span><span class="p">,</span> <span class="n">sl_flags</span><span class="p">);</span>
	<span class="n">new_start</span> <span class="o">=</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">new_size</span> <span class="o">=</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">new_acl</span> <span class="o">=</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">;</span>
	<span class="n">new_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_TRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">hw_pgsize</span> <span class="o">=</span> <span class="n">ehca_get_max_hwpage_size</span><span class="p">(</span><span class="n">shca</span><span class="p">);</span>

		<span class="n">new_start</span> <span class="o">=</span> <span class="n">iova_start</span><span class="p">;</span>	<span class="cm">/* change address */</span>
		<span class="cm">/* check physical buffer list and calculate size */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_mr_chk_buf_and_calc_size</span><span class="p">(</span><span class="n">phys_buf_array</span><span class="p">,</span>
						    <span class="n">num_phys_buf</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">new_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rereg_phys_mr_exit1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">+</span> <span class="n">new_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: new_size=%llx &quot;</span>
				 <span class="s">&quot;iova_start=%p&quot;</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rereg_phys_mr_exit1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num_kpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">new_start</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">new_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">new_start</span> <span class="o">%</span> <span class="n">hw_pgsize</span><span class="p">)</span> <span class="o">+</span>
					 <span class="n">new_size</span><span class="p">,</span> <span class="n">hw_pgsize</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">EHCA_MR_PGI_PHYS</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">num_kpages</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">hw_pgsize</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">num_hwpages</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">num_phys_buf</span> <span class="o">=</span> <span class="n">num_phys_buf</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">phys_buf_array</span> <span class="o">=</span> <span class="n">phys_buf_array</span><span class="p">;</span>
		<span class="n">pginfo</span><span class="p">.</span><span class="n">next_hwpage</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">/</span> <span class="n">hw_pgsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_ACCESS</span><span class="p">)</span>
		<span class="n">new_acl</span> <span class="o">=</span> <span class="n">mr_access_flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_PD</span><span class="p">)</span>
		<span class="n">new_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_rereg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">new_start</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">new_acl</span><span class="p">,</span>
			    <span class="n">new_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_lkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rkey</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rereg_phys_mr_exit1</span><span class="p">;</span>

	<span class="cm">/* successful reregistration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_PD</span><span class="p">)</span>
		<span class="n">mr</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">tmp_lkey</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">tmp_rkey</span><span class="p">;</span>

<span class="nl">rereg_phys_mr_exit1:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">mrlock</span><span class="p">,</span> <span class="n">sl_flags</span><span class="p">);</span>
<span class="nl">rereg_phys_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ret=%i mr=%p mr_rereg_mask=%x pd=%p &quot;</span>
			 <span class="s">&quot;phys_buf_array=%p num_phys_buf=%x mr_access_flags=%x &quot;</span>
			 <span class="s">&quot;iova_start=%p&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">mr_rereg_mask</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">phys_buf_array</span><span class="p">,</span>
			 <span class="n">num_phys_buf</span><span class="p">,</span> <span class="n">mr_access_flags</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_rereg_phys_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_query_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_mr_attr</span> <span class="o">*</span><span class="n">mr_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sl_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;not supported for FMR, mr=%p e_mr=%p &quot;</span>
			 <span class="s">&quot;e_mr-&gt;flags=%x&quot;</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">query_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mr_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr_attr</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">mrlock</span><span class="p">,</span> <span class="n">sl_flags</span><span class="p">);</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_query_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;hipz_mr_query failed, h_ret=%lli mr=%p &quot;</span>
			 <span class="s">&quot;hca_hndl=%llx mr_hndl=%llx lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">query_mr_exit1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mr_attr</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">mr_attr</span><span class="o">-&gt;</span><span class="n">device_virt_addr</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="n">mr_attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">mr_attr</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
	<span class="n">mr_attr</span><span class="o">-&gt;</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="n">ehca_mrmw_reverse_map_acl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hipzout</span><span class="p">.</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mr_attr</span><span class="o">-&gt;</span><span class="n">mr_access_flags</span><span class="p">);</span>

<span class="nl">query_mr_exit1:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">mrlock</span><span class="p">,</span> <span class="n">sl_flags</span><span class="p">);</span>
<span class="nl">query_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ret=%i mr=%p mr_attr=%p&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">mr_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_query_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_dereg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;not supported for FMR, mr=%p e_mr=%p &quot;</span>
			 <span class="s">&quot;e_mr-&gt;flags=%x&quot;</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">dereg_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span> <span class="o">==</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should be impossible, however reject to be sure */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;dereg internal max-MR impossible, mr=%p &quot;</span>
			 <span class="s">&quot;shca-&gt;maxmr=%p mr-&gt;lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">mr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">,</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">dereg_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: BUSY: MR still has bound window(s) */</span>
	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_free_resource_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;hipz_free_mr failed, h_ret=%lli shca=%p &quot;</span>
			 <span class="s">&quot;e_mr=%p hca_hndl=%llx mr_hndl=%llx mr-&gt;lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dereg_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">)</span>
		<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>

	<span class="cm">/* successful deregistration */</span>
	<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_mr</span><span class="p">);</span>

<span class="nl">dereg_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ret=%i mr=%p&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">mr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_dereg_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="nf">ehca_alloc_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">ib_mw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mw</span> <span class="o">*</span><span class="n">e_mw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mw_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>

	<span class="n">e_mw</span> <span class="o">=</span> <span class="n">ehca_mw_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e_mw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_mw</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_mw_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_alloc_resource_mw</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mw</span><span class="p">,</span>
					 <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">fw_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;hipz_mw_allocate failed, h_ret=%lli &quot;</span>
			 <span class="s">&quot;shca=%p hca_hndl=%llx mw=%p&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">e_mw</span><span class="p">);</span>
		<span class="n">ib_mw</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">alloc_mw_exit1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* successful MW allocation */</span>
	<span class="n">e_mw</span><span class="o">-&gt;</span><span class="n">ipz_mw_handle</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">e_mw</span><span class="o">-&gt;</span><span class="n">ib_mw</span><span class="p">.</span><span class="n">rkey</span>    <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">e_mw</span><span class="o">-&gt;</span><span class="n">ib_mw</span><span class="p">;</span>

<span class="nl">alloc_mw_exit1:</span>
	<span class="n">ehca_mw_delete</span><span class="p">(</span><span class="n">e_mw</span><span class="p">);</span>
<span class="nl">alloc_mw_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ib_mw</span><span class="p">))</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;h_ret=%li pd=%p&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ib_mw</span><span class="p">),</span> <span class="n">pd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ib_mw</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_alloc_mw() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_bind_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ib_mw_bind</span> <span class="o">*</span><span class="n">mw_bind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: not supported up to now */</span>
	<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bind MW currently not supported by HCAD&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_bind_mw() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_dealloc_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">mw</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mw</span> <span class="o">*</span><span class="n">e_mw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mw</span><span class="p">,</span> <span class="n">ib_mw</span><span class="p">);</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_free_resource_mw</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">mw</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;hipz_free_mw failed, h_ret=%lli shca=%p &quot;</span>
			 <span class="s">&quot;mw=%p rkey=%x hca_hndl=%llx mw_hndl=%llx&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">mw</span><span class="p">,</span> <span class="n">mw</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_mw</span><span class="o">-&gt;</span><span class="n">ipz_mw_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* successful deallocation */</span>
	<span class="n">ehca_mw_delete</span><span class="p">(</span><span class="n">e_mw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_dealloc_mw() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">struct</span> <span class="n">ib_fmr</span> <span class="o">*</span><span class="nf">ehca_alloc_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">mr_access_flags</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ib_fmr_attr</span> <span class="o">*</span><span class="n">fmr_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_fmr</span> <span class="o">*</span><span class="n">ib_fmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_fmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_lkey</span><span class="p">,</span> <span class="n">tmp_rkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hw_pgsize</span><span class="p">;</span>

	<span class="cm">/* check other parameters */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_ATOMIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remote Write Access requires Local Write Access</span>
<span class="cm">		 * Remote Atomic Access requires Local Write Access</span>
<span class="cm">		 */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: mr_access_flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">mr_access_flags</span><span class="p">);</span>
		<span class="n">ib_fmr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_MW_BIND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: mr_access_flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">mr_access_flags</span><span class="p">);</span>
		<span class="n">ib_fmr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_pages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_maps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad input values: fmr_attr-&gt;max_pages=%x &quot;</span>
			 <span class="s">&quot;fmr_attr-&gt;max_maps=%x fmr_attr-&gt;page_shift=%x&quot;</span><span class="p">,</span>
			 <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_pages</span><span class="p">,</span> <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_maps</span><span class="p">,</span>
			 <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
		<span class="n">ib_fmr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw_pgsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw_pgsize</span> <span class="o">&amp;</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">hca_cap_mr_pgsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unsupported fmr_attr-&gt;page_shift=%x&quot;</span><span class="p">,</span>
			 <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
		<span class="n">ib_fmr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_fmr</span> <span class="o">=</span> <span class="n">ehca_mr_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e_fmr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_fmr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">;</span>

	<span class="cm">/* register MR on HCA */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">hw_pgsize</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * pginfo.num_hwpages==0, ie register_rpages() will not be called</span>
<span class="cm">	 * but deferred to map_phys_fmr()</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_pages</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">),</span>
			  <span class="n">mr_access_flags</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">tmp_lkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rkey</span><span class="p">,</span> <span class="n">EHCA_REG_MR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_fmr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fmr_exit1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* successful */</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">hw_pgsize</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span> <span class="o">=</span> <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_pages</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_maps</span> <span class="o">=</span> <span class="n">fmr_attr</span><span class="o">-&gt;</span><span class="n">max_maps</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">;</span>

<span class="nl">alloc_fmr_exit1:</span>
	<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_fmr</span><span class="p">);</span>
<span class="nl">alloc_fmr_exit0:</span>
	<span class="k">return</span> <span class="n">ib_fmr</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_alloc_fmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_map_phys_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_fmr</span> <span class="o">*</span><span class="n">fmr</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="o">*</span><span class="n">page_list</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">list_len</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="n">iova</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_fmr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fmr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_lkey</span><span class="p">,</span> <span class="n">tmp_rkey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;not a FMR, e_fmr=%p e_fmr-&gt;flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">map_phys_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_fmr_check_page_list</span><span class="p">(</span><span class="n">e_fmr</span><span class="p">,</span> <span class="n">page_list</span><span class="p">,</span> <span class="n">list_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">map_phys_fmr_exit0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iova</span> <span class="o">%</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only whole-numbered pages */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;bad iova, iova=%llx fmr_page_size=%x&quot;</span><span class="p">,</span>
			 <span class="n">iova</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">map_phys_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span> <span class="o">&gt;=</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_maps</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HCAD does not limit the maps, however trace this anyway */</span>
		<span class="n">ehca_info</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;map limit exceeded, fmr=%p &quot;</span>
			  <span class="s">&quot;e_fmr-&gt;fmr_map_cnt=%x e_fmr-&gt;fmr_max_maps=%x&quot;</span><span class="p">,</span>
			  <span class="n">fmr</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_maps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">EHCA_MR_PGI_FMR</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">list_len</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">num_hwpages</span> <span class="o">=</span>
		<span class="n">list_len</span> <span class="o">*</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">/</span> <span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">page_list</span> <span class="o">=</span> <span class="n">page_list</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">next_hwpage</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">iova</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">fmr_pgsize</span> <span class="o">=</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_rereg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">iova</span><span class="p">,</span>
			    <span class="n">list_len</span> <span class="o">*</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">,</span>
			    <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_lkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rkey</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">map_phys_fmr_exit0</span><span class="p">;</span>

	<span class="cm">/* successful reregistration */</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">tmp_lkey</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">tmp_rkey</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">map_phys_fmr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ret=%i fmr=%p page_list=%p list_len=%x &quot;</span>
			 <span class="s">&quot;iova=%llx&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fmr</span><span class="p">,</span> <span class="n">page_list</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">iova</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_map_phys_fmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_unmap_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fmr_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_fmr</span> <span class="o">*</span><span class="n">ib_fmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">prev_shca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_fmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_fmr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unmap_fmr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check all FMR belong to same SHCA, and check internal flag */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ib_fmr</span><span class="p">,</span> <span class="n">fmr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev_shca</span> <span class="o">=</span> <span class="n">shca</span><span class="p">;</span>
		<span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ib_fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span>
				    <span class="n">ib_device</span><span class="p">);</span>
		<span class="n">e_fmr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ib_fmr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">shca</span> <span class="o">!=</span> <span class="n">prev_shca</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">prev_shca</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;SHCA mismatch, shca=%p &quot;</span>
				 <span class="s">&quot;prev_shca=%p e_fmr=%p&quot;</span><span class="p">,</span>
				 <span class="n">shca</span><span class="p">,</span> <span class="n">prev_shca</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap_fmr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;not a FMR, e_fmr=%p &quot;</span>
				 <span class="s">&quot;e_fmr-&gt;flags=%x&quot;</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap_fmr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num_fmr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loop over all FMRs to unmap */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ib_fmr</span><span class="p">,</span> <span class="n">fmr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unmap_fmr_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">e_fmr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ib_fmr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">);</span>
		<span class="n">shca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ib_fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span>
				    <span class="n">ib_device</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_unmap_one_fmr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* unmap failed, stop unmapping of rest of FMRs */</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;unmap of one FMR failed, &quot;</span>
				 <span class="s">&quot;stop rest, e_fmr=%p num_fmr=%x &quot;</span>
				 <span class="s">&quot;unmap_fmr_cnt=%x lkey=%x&quot;</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="n">num_fmr</span><span class="p">,</span>
				 <span class="n">unmap_fmr_cnt</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unmap_fmr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">unmap_fmr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;ret=%i fmr_list=%p num_fmr=%x unmap_fmr_cnt=%x&quot;</span><span class="p">,</span>
			     <span class="n">ret</span><span class="p">,</span> <span class="n">fmr_list</span><span class="p">,</span> <span class="n">num_fmr</span><span class="p">,</span> <span class="n">unmap_fmr_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_unmap_fmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_dealloc_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_fmr</span> <span class="o">*</span><span class="n">fmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span><span class="p">,</span> <span class="n">ib_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_fmr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fmr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">,</span> <span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_FMR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;not a FMR, e_fmr=%p e_fmr-&gt;flags=%x&quot;</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_free_resource_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;hipz_free_mr failed, h_ret=%lli e_fmr=%p &quot;</span>
			 <span class="s">&quot;hca_hndl=%llx fmr_hndl=%llx fmr-&gt;lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">fmr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* successful deregistration */</span>
	<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_fmr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_fmr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i fmr=%p&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fmr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_dealloc_fmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ehca_reg_bmap_mr_rpages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ehca_reg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">,</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">size</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">acl</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span> <span class="cm">/*OUT*/</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">rkey</span><span class="p">,</span> <span class="cm">/*OUT*/</span>
		<span class="k">enum</span> <span class="n">ehca_reg_type</span> <span class="n">reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hipz_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>

	<span class="n">ehca_mrmw_map_acl</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>
	<span class="n">ehca_mrmw_set_pgsize_hipz_acl</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehca_use_hp_mr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">hipz_acl</span> <span class="o">|=</span> <span class="mh">0x00000001</span><span class="p">;</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_alloc_resource_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">hipz_acl</span><span class="p">,</span>
					 <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">fw_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_alloc_mr failed, h_ret=%lli &quot;</span>
			 <span class="s">&quot;hca_hndl=%llx&quot;</span><span class="p">,</span> <span class="n">h_ret</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ehca_reg_mr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">EHCA_REG_BUSMAP_MR</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_bmap_mr_rpages</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="n">EHCA_REG_MR</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr_rpages</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ehca_reg_mr_exit1</span><span class="p">;</span>

	<span class="cm">/* successful registration */</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">iova_start</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">acl</span> <span class="o">=</span> <span class="n">acl</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ehca_reg_mr_exit1:</span>
	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_free_resource_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;h_ret=%lli shca=%p e_mr=%p &quot;</span>
			 <span class="s">&quot;iova_start=%p size=%llx acl=%x e_pd=%p lkey=%x &quot;</span>
			 <span class="s">&quot;pginfo=%p num_kpages=%llx num_hwpages=%llx ret=%i&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span>
			 <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span>
			 <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;internal error in ehca_reg_mr, &quot;</span>
			 <span class="s">&quot;not recoverable&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">ehca_reg_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i shca=%p e_mr=%p &quot;</span>
			 <span class="s">&quot;iova_start=%p size=%llx acl=%x e_pd=%p pginfo=%p &quot;</span>
			 <span class="s">&quot;num_kpages=%llx num_hwpages=%llx&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span>
			 <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_reg_mr_rpages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rnum</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rpage</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">)</span> <span class="cm">/* in case of fmr */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kpage</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;kpage alloc failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_reg_mr_rpages_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* max MAX_RPAGES ehca mr pages per register call */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CHUNKS</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">MAX_RPAGES</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_CHUNKS</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">MAX_RPAGES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rnum</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">%</span> <span class="n">MAX_RPAGES</span><span class="p">;</span> <span class="cm">/* last shot */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rnum</span> <span class="o">=</span> <span class="n">MAX_RPAGES</span><span class="p">;</span>      <span class="cm">/* last shot is full */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rnum</span> <span class="o">=</span> <span class="n">MAX_RPAGES</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_set_pagebuf</span><span class="p">(</span><span class="n">pginfo</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ehca_set_pagebuf &quot;</span>
				 <span class="s">&quot;bad rc, ret=%i rnum=%x kpage=%p&quot;</span><span class="p">,</span>
				 <span class="n">ret</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ehca_reg_mr_rpages_exit1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpage</span> <span class="o">=</span> <span class="n">virt_to_abs</span><span class="p">(</span><span class="n">kpage</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpage</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;kpage=%p i=%x&quot;</span><span class="p">,</span>
					 <span class="n">kpage</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">ehca_reg_mr_rpages_exit1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rpage</span> <span class="o">=</span> <span class="o">*</span><span class="n">kpage</span><span class="p">;</span>

		<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_register_rpage_mr</span><span class="p">(</span>
			<span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span>
			<span class="n">ehca_encode_hwpage_size</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">rpage</span><span class="p">,</span> <span class="n">rnum</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_CHUNKS</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">MAX_RPAGES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * check for &#39;registration complete&#39;==H_SUCCESS</span>
<span class="cm">			 * and for &#39;page registered&#39;==H_PAGE_REGISTERED</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;last &quot;</span>
					 <span class="s">&quot;hipz_reg_rpage_mr failed, h_ret=%lli &quot;</span>
					 <span class="s">&quot;e_mr=%p i=%x hca_hndl=%llx mr_hndl=%llx&quot;</span>
					 <span class="s">&quot; lkey=%x&quot;</span><span class="p">,</span> <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					 <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
					 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
					 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_PAGE_REGISTERED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_reg_rpage_mr failed, &quot;</span>
				 <span class="s">&quot;h_ret=%lli e_mr=%p i=%x lkey=%x hca_hndl=%llx &quot;</span>
				 <span class="s">&quot;mr_hndl=%llx&quot;</span><span class="p">,</span> <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
				 <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
				 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* end for(i) */</span>


<span class="nl">ehca_reg_mr_rpages_exit1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">kpage</span><span class="p">);</span>
<span class="nl">ehca_reg_mr_rpages_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i shca=%p e_mr=%p pginfo=%p &quot;</span>
			 <span class="s">&quot;num_kpages=%llx num_hwpages=%llx&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span>
			 <span class="n">pginfo</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_mr_rpages() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_rereg_mr_rereg1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">,</span>
				<span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">acl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span> <span class="cm">/*OUT*/</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">rkey</span><span class="p">)</span> <span class="cm">/*OUT*/</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hipz_acl</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rpage</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo_save</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>

	<span class="n">ehca_mrmw_map_acl</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>
	<span class="n">ehca_mrmw_set_pgsize_hipz_acl</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>

	<span class="n">kpage</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;kpage alloc failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_rereg_mr_rereg1_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pginfo_save</span> <span class="o">=</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_set_pagebuf</span><span class="p">(</span><span class="n">pginfo</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;set pagebuf failed, e_mr=%p &quot;</span>
			 <span class="s">&quot;pginfo=%p type=%x num_kpages=%llx num_hwpages=%llx &quot;</span>
			 <span class="s">&quot;kpage=%p&quot;</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			 <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ehca_rereg_mr_rereg1_exit1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rpage</span> <span class="o">=</span> <span class="n">virt_to_abs</span><span class="p">(</span><span class="n">kpage</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;kpage=%p&quot;</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_rereg_mr_rereg1_exit1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_reregister_pmr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">hipz_acl</span><span class="p">,</span>
				      <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">fw_pd</span><span class="p">,</span> <span class="n">rpage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * reregistration unsuccessful, try it again with the 3 hCalls,</span>
<span class="cm">		 * e.g. this is required in case H_MR_CONDITION</span>
<span class="cm">		 * (MW bound or MR is shared)</span>
<span class="cm">		 */</span>
		<span class="n">ehca_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_h_reregister_pmr failed &quot;</span>
			  <span class="s">&quot;(Rereg1), h_ret=%lli e_mr=%p&quot;</span><span class="p">,</span> <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pginfo</span> <span class="o">=</span> <span class="n">pginfo_save</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">hipzout</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">!=</span> <span class="n">iova_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;PHYP changed iova_start in &quot;</span>
			 <span class="s">&quot;rereg_pmr, iova_start=%p iova_start_out=%llx e_mr=%p &quot;</span>
			 <span class="s">&quot;mr_handle=%llx lkey=%x lkey_out=%x&quot;</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span>
			 <span class="n">hipzout</span><span class="p">.</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * successful reregistration</span>
<span class="cm">		 * note: start and start_out are identical for eServer HCAs</span>
<span class="cm">		 */</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">iova_start</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">acl</span> <span class="o">=</span> <span class="n">acl</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">ehca_rereg_mr_rereg1_exit1:</span>
	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">kpage</span><span class="p">);</span>
<span class="nl">ehca_rereg_mr_rereg1_exit0:</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i lkey=%x rkey=%x &quot;</span>
			 <span class="s">&quot;pginfo=%p num_kpages=%llx num_hwpages=%llx&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span> <span class="o">*</span><span class="n">rkey</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span>
			 <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_rereg_mr_rereg1() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_rereg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">,</span>
		  <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
		  <span class="n">u64</span> <span class="n">size</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">acl</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
		  <span class="n">u32</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span>
		  <span class="n">u32</span> <span class="o">*</span><span class="n">rkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rereg_1_hcall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 1: use hipz_h_reregister_pmr directly */</span>
	<span class="kt">int</span> <span class="n">rereg_3_hcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 1: use 3 hipz calls for reregistration */</span>

	<span class="cm">/* first determine reregistration hCall(s) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">&gt;</span> <span class="n">MAX_RPAGES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">&gt;</span> <span class="n">MAX_RPAGES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">&gt;</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Rereg3 case, &quot;</span>
			 <span class="s">&quot;pginfo-&gt;num_hwpages=%llx e_mr-&gt;num_hwpages=%x&quot;</span><span class="p">,</span>
			 <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">);</span>
		<span class="n">rereg_1_hcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rereg_3_hcall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EHCA_MR_FLAG_MAXMR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* check for max-MR */</span>
		<span class="n">rereg_1_hcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rereg_3_hcall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EHCA_MR_FLAG_MAXMR</span><span class="p">;</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;Rereg MR for max-MR! e_mr=%p&quot;</span><span class="p">,</span>
			 <span class="n">e_mr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rereg_1_hcall</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_rereg_mr_rereg1</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					   <span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span> <span class="n">lkey</span><span class="p">,</span> <span class="n">rkey</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
				<span class="n">rereg_3_hcall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">ehca_rereg_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rereg_3_hcall</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="n">save_mr</span><span class="p">;</span>

		<span class="cm">/* first deregister old MR */</span>
		<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_free_resource_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_free_mr failed, &quot;</span>
				 <span class="s">&quot;h_ret=%lli e_mr=%p hca_hndl=%llx mr_hndl=%llx &quot;</span>
				 <span class="s">&quot;mr-&gt;lkey=%x&quot;</span><span class="p">,</span>
				 <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
				 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
				 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ehca_rereg_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* clean ehca_mr_t, without changing struct ib_mr and lock */</span>
		<span class="n">save_mr</span> <span class="o">=</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">;</span>
		<span class="n">ehca_mr_deletenew</span><span class="p">(</span><span class="n">e_mr</span><span class="p">);</span>

		<span class="cm">/* set some MR values */</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">save_mr</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">save_mr</span><span class="p">.</span><span class="n">hwpage_size</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">=</span> <span class="n">save_mr</span><span class="p">.</span><span class="n">fmr_page_size</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span> <span class="o">=</span> <span class="n">save_mr</span><span class="p">.</span><span class="n">fmr_max_pages</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">fmr_max_maps</span> <span class="o">=</span> <span class="n">save_mr</span><span class="p">.</span><span class="n">fmr_max_maps</span><span class="p">;</span>
		<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span> <span class="o">=</span> <span class="n">save_mr</span><span class="p">.</span><span class="n">fmr_map_cnt</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span>
				  <span class="n">e_pd</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span> <span class="n">lkey</span><span class="p">,</span> <span class="n">rkey</span><span class="p">,</span> <span class="n">EHCA_REG_MR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">e_mr</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">save_mr</span><span class="p">.</span><span class="n">flags</span><span class="p">),</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ehca_rereg_mr_exit0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">ehca_rereg_mr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i shca=%p e_mr=%p &quot;</span>
			 <span class="s">&quot;iova_start=%p size=%llx acl=%x e_pd=%p pginfo=%p &quot;</span>
			 <span class="s">&quot;num_kpages=%llx lkey=%x rkey=%x rereg_1_hcall=%x &quot;</span>
			 <span class="s">&quot;rereg_3_hcall=%x&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			 <span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span> <span class="o">*</span><span class="n">rkey</span><span class="p">,</span>
			 <span class="n">rereg_1_hcall</span><span class="p">,</span> <span class="n">rereg_3_hcall</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_rereg_mr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_unmap_one_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_fmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_pd</span><span class="p">,</span> <span class="n">ib_pd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="n">save_fmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_lkey</span><span class="p">,</span> <span class="n">tmp_rkey</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="n">save_mr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span> <span class="o">&lt;=</span> <span class="n">MAX_RPAGES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * note: after using rereg hcall with len=0,</span>
<span class="cm">		 * rereg hcall must be used again for registering pages</span>
<span class="cm">		 */</span>
		<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_reregister_pmr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">fw_pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">==</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* successful reregistration */</span>
			<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp_lkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
			<span class="n">tmp_rkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * should not happen, because length checked above,</span>
<span class="cm">		 * FMRs are not shared and no MW bound to FMRs</span>
<span class="cm">		 */</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_reregister_pmr failed &quot;</span>
			 <span class="s">&quot;(Rereg1), h_ret=%lli e_fmr=%p hca_hndl=%llx &quot;</span>
			 <span class="s">&quot;mr_hndl=%llx lkey=%x lkey_out=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
		<span class="cm">/* try free and rereg */</span>
	<span class="p">}</span>

	<span class="cm">/* first free old FMR */</span>
	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_free_resource_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_free_mr failed, &quot;</span>
			 <span class="s">&quot;h_ret=%lli e_fmr=%p hca_hndl=%llx mr_hndl=%llx &quot;</span>
			 <span class="s">&quot;lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_fmr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ehca_unmap_one_fmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* clean ehca_mr_t, without changing lock */</span>
	<span class="n">save_fmr</span> <span class="o">=</span> <span class="o">*</span><span class="n">e_fmr</span><span class="p">;</span>
	<span class="n">ehca_mr_deletenew</span><span class="p">(</span><span class="n">e_fmr</span><span class="p">);</span>

	<span class="cm">/* set some MR values */</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">fmr_page_size</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">fmr_max_pages</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_maps</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">fmr_max_maps</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">fmr_map_cnt</span><span class="p">;</span>
	<span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">acl</span> <span class="o">=</span> <span class="n">save_fmr</span><span class="p">.</span><span class="n">acl</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">EHCA_MR_PGI_FMR</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span> <span class="o">*</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">),</span>
			  <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_lkey</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">tmp_rkey</span><span class="p">,</span> <span class="n">EHCA_REG_MR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">e_fmr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">save_mr</span><span class="p">.</span><span class="n">flags</span><span class="p">),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">ehca_unmap_one_fmr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i tmp_lkey=%x tmp_rkey=%x &quot;</span>
			 <span class="s">&quot;fmr_max_pages=%x&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">tmp_lkey</span><span class="p">,</span> <span class="n">tmp_rkey</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_unmap_one_fmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_reg_smr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_origmr</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_newmr</span><span class="p">,</span>
		 <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">acl</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span><span class="p">,</span>
		 <span class="n">u32</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span> <span class="cm">/*OUT*/</span>
		 <span class="n">u32</span> <span class="o">*</span><span class="n">rkey</span><span class="p">)</span> <span class="cm">/*OUT*/</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hipz_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>

	<span class="n">ehca_mrmw_map_acl</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>
	<span class="n">ehca_mrmw_set_pgsize_hipz_acl</span><span class="p">(</span><span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_register_smr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_newmr</span><span class="p">,</span> <span class="n">e_origmr</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span><span class="p">,</span> <span class="n">hipz_acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">fw_pd</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_reg_smr failed, h_ret=%lli &quot;</span>
			 <span class="s">&quot;shca=%p e_origmr=%p e_newmr=%p iova_start=%p acl=%x &quot;</span>
			 <span class="s">&quot;e_pd=%p hca_hndl=%llx mr_hndl=%llx lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_origmr</span><span class="p">,</span> <span class="n">e_newmr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span>
			 <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ehca_reg_smr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* successful registration */</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span>   <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">iova_start</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">acl</span> <span class="o">=</span> <span class="n">acl</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ehca_reg_smr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i shca=%p e_origmr=%p &quot;</span>
			 <span class="s">&quot;e_newmr=%p iova_start=%p acl=%x e_pd=%p&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_origmr</span><span class="p">,</span> <span class="n">e_newmr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_smr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ehca_calc_sectbase</span><span class="p">(</span><span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dir</span> <span class="o">&lt;&lt;</span> <span class="n">EHCA_DIR_INDEX_SHIFT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">top</span> <span class="o">&lt;&lt;</span> <span class="n">EHCA_TOP_INDEX_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">abs_to_virt</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="n">SECTION_SIZE_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ehca_bmap_valid(entry) \</span>
<span class="cp">	((u64)entry != (u64)EHCA_INVAL_ADDR)</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_reg_mr_section</span><span class="p">(</span><span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">h_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rpage</span> <span class="o">=</span> <span class="n">virt_to_abs</span><span class="p">(</span><span class="n">kpage</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">page_count</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">sectbase</span> <span class="o">=</span> <span class="n">ehca_calc_sectbase</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sectbase</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;reg_mr_section will probably fail:&quot;</span>
					   <span class="s">&quot;hwpage_size does not fit to &quot;</span>
					   <span class="s">&quot;section start address&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">page_count</span> <span class="o">=</span> <span class="n">EHCA_SECTSIZE</span> <span class="o">/</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">page</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">rnum</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">rnum</span> <span class="o">&lt;</span> <span class="n">MAX_RPAGES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">page</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">);</span>
		     <span class="n">rnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span> <span class="n">sectbase</span> <span class="o">+</span> <span class="p">((</span><span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="o">*</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">);</span>
			<span class="n">kpage</span><span class="p">[</span><span class="n">rnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_to_abs</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_register_rpage_mr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span>
			<span class="n">ehca_encode_hwpage_size</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">rpage</span><span class="p">,</span> <span class="n">rnum</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_PAGE_REGISTERED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;register_rpage_mr failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">h_ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">h_ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_reg_mr_sections</span><span class="p">(</span><span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hret</span> <span class="o">=</span> <span class="n">H_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">EHCA_MAP_ENTRIES</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehca_reg_mr_section</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">kpage</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span>
					   <span class="n">pginfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_PAGE_REGISTERED</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">hret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_reg_mr_dir_sections</span><span class="p">(</span><span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hret</span> <span class="o">=</span> <span class="n">H_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dir</span> <span class="o">&lt;</span> <span class="n">EHCA_MAP_ENTRIES</span><span class="p">;</span> <span class="n">dir</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehca_reg_mr_sections</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">kpage</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_PAGE_REGISTERED</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">hret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* register internal max-MR to internal SHCA */</span>
<span class="kt">int</span> <span class="nf">ehca_reg_internal_maxmr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">**</span><span class="n">e_maxmr</span><span class="p">)</span>  <span class="cm">/*OUT*/</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size_maxmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="n">pginfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="n">ib_pbuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hw_pgsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_reg_internal_maxmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_mr</span> <span class="o">=</span> <span class="n">ehca_mr_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e_mr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;out of memory&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_reg_internal_maxmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EHCA_MR_FLAG_MAXMR</span><span class="p">;</span>

	<span class="cm">/* register internal max-MR on HCA */</span>
	<span class="n">size_maxmr</span> <span class="o">=</span> <span class="n">ehca_mr_len</span><span class="p">;</span>
	<span class="n">iova_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">ehca_map_vaddr</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">KERNELBASE</span> <span class="o">+</span> <span class="n">PHYSICAL_START</span><span class="p">));</span>
	<span class="n">ib_pbuf</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ib_pbuf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size_maxmr</span><span class="p">;</span>
	<span class="n">num_kpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_maxmr</span><span class="p">,</span>
				<span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">hw_pgsize</span> <span class="o">=</span> <span class="n">ehca_get_max_hwpage_size</span><span class="p">(</span><span class="n">shca</span><span class="p">);</span>
	<span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">%</span> <span class="n">hw_pgsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_maxmr</span><span class="p">,</span>
				 <span class="n">hw_pgsize</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pginfo</span><span class="p">));</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">EHCA_MR_PGI_PHYS</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">hw_pgsize</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">num_phys_buf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pginfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">phys_buf_array</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib_pbuf</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_reg_mr</span><span class="p">(</span><span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size_maxmr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">pginfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">rkey</span><span class="p">,</span> <span class="n">EHCA_REG_BUSMAP_MR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;reg of internal max MR failed, &quot;</span>
			 <span class="s">&quot;e_mr=%p iova_start=%p size_maxmr=%llx num_kpages=%x &quot;</span>
			 <span class="s">&quot;num_hwpages=%x&quot;</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span> <span class="n">size_maxmr</span><span class="p">,</span>
			 <span class="n">num_kpages</span><span class="p">,</span> <span class="n">num_hwpages</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ehca_reg_internal_maxmr_exit1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* successful registration of all pages */</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">ib_pd</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">ib_pd</span><span class="p">;</span>
	<span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">uobject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">ib_pd</span><span class="p">.</span><span class="n">usecnt</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">usecnt</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">e_maxmr</span> <span class="o">=</span> <span class="n">e_mr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ehca_reg_internal_maxmr_exit1:</span>
	<span class="n">ehca_mr_delete</span><span class="p">(</span><span class="n">e_mr</span><span class="p">);</span>
<span class="nl">ehca_reg_internal_maxmr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i shca=%p e_pd=%p e_maxmr=%p&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_pd</span><span class="p">,</span> <span class="n">e_maxmr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_internal_maxmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_reg_maxmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_newmr</span><span class="p">,</span>
		   <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">acl</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ehca_pd</span> <span class="o">*</span><span class="n">e_pd</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span><span class="n">lkey</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span><span class="n">rkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">h_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_origmr</span> <span class="o">=</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hipz_acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr_hipzout_parms</span> <span class="n">hipzout</span><span class="p">;</span>

	<span class="n">ehca_mrmw_map_acl</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>
	<span class="n">ehca_mrmw_set_pgsize_hipz_acl</span><span class="p">(</span><span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hipz_acl</span><span class="p">);</span>

	<span class="n">h_ret</span> <span class="o">=</span> <span class="n">hipz_h_register_smr</span><span class="p">(</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">,</span> <span class="n">e_newmr</span><span class="p">,</span> <span class="n">e_origmr</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span><span class="p">,</span> <span class="n">hipz_acl</span><span class="p">,</span> <span class="n">e_pd</span><span class="o">-&gt;</span><span class="n">fw_pd</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">hipzout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_ret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;hipz_reg_smr failed, h_ret=%lli &quot;</span>
			 <span class="s">&quot;e_origmr=%p hca_hndl=%llx mr_hndl=%llx lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">h_ret</span><span class="p">,</span> <span class="n">e_origmr</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
			 <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">h_ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* successful registration */</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">iova_start</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">e_origmr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">acl</span> <span class="o">=</span> <span class="n">acl</span><span class="p">;</span>
	<span class="n">e_newmr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">hipzout</span><span class="p">.</span><span class="n">rkey</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_reg_maxmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="kt">int</span> <span class="nf">ehca_dereg_internal_maxmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_maxmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">ib_pd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;bad call, shca=%p&quot;</span><span class="p">,</span> <span class="n">shca</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_dereg_internal_maxmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e_maxmr</span> <span class="o">=</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">;</span>
	<span class="n">ib_pd</span> <span class="o">=</span> <span class="n">e_maxmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* remove internal max-MR indication from SHCA */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_dereg_mr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e_maxmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;dereg internal max-MR failed, &quot;</span>
			 <span class="s">&quot;ret=%i e_maxmr=%p shca=%p lkey=%x&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">e_maxmr</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_maxmr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span> <span class="o">=</span> <span class="n">e_maxmr</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ehca_dereg_internal_maxmr_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_pd</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">);</span>

<span class="nl">ehca_dereg_internal_maxmr_exit0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ret=%i shca=%p shca-&gt;maxmr=%p&quot;</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">shca</span><span class="o">-&gt;</span><span class="n">maxmr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_dereg_internal_maxmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * check physical buffer array of MR verbs for validness and</span>
<span class="cm"> * calculates MR size</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ehca_mr_chk_buf_and_calc_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">phys_buf_array</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">phys_buf_array</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_phys_buf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad phys buf array len, num_phys_buf=0&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check first buffer */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">iova_start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;iova_start/addr mismatch, iova_start=%p &quot;</span>
			     <span class="s">&quot;pbuf-&gt;addr=%llx pbuf-&gt;size=%llx&quot;</span><span class="p">,</span>
			     <span class="n">iova_start</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">num_phys_buf</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;addr/size mismatch in 1st buf, pbuf-&gt;addr=%llx &quot;</span>
			     <span class="s">&quot;pbuf-&gt;size=%llx&quot;</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phys_buf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad address, i=%x pbuf-&gt;addr=%llx &quot;</span>
				     <span class="s">&quot;pbuf-&gt;size=%llx&quot;</span><span class="p">,</span>
				     <span class="n">i</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* not 1st */</span>
		     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num_phys_buf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* not last */</span>
		     <span class="p">(</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad size, i=%x pbuf-&gt;size=%llx&quot;</span><span class="p">,</span>
				     <span class="n">i</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size_count</span> <span class="o">+=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">pbuf</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">size_count</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_mr_chk_buf_and_calc_size() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* check page list of map FMR verb for validness */</span>
<span class="kt">int</span> <span class="nf">ehca_fmr_check_page_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_fmr</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="o">*</span><span class="n">page_list</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">list_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">list_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">&gt;</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad list_len, list_len=%x &quot;</span>
			     <span class="s">&quot;e_fmr-&gt;fmr_max_pages=%x fmr=%p&quot;</span><span class="p">,</span>
			     <span class="n">list_len</span><span class="p">,</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* each page must be aligned */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">page_list</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">page</span> <span class="o">%</span> <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad page, i=%x *page=%llx page=%p fmr=%p &quot;</span>
				     <span class="s">&quot;fmr_page_size=%x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">e_fmr</span><span class="p">,</span>
				     <span class="n">e_fmr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">page</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_fmr_check_page_list() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* PAGE_SIZE &gt;= pginfo-&gt;hwpage_size */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_set_pagebuf_user1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">number</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem_chunk</span> <span class="o">*</span><span class="n">prev_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pgaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hwpages_per_kpage</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>

	<span class="cm">/* loop over desired chunk entries */</span>
	<span class="n">chunk</span>      <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span><span class="p">;</span>
	<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span><span class="p">;</span>
	<span class="n">list_for_each_entry_continue</span><span class="p">(</span>
		<span class="n">chunk</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">)),</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">pgaddr</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span> <span class="p">;</span>
			<span class="o">*</span><span class="n">kpage</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">(</span><span class="n">pgaddr</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">*</span>
					      <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">kpage</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;pgaddr=%llx &quot;</span>
					     <span class="s">&quot;chunk-&gt;page_list[i]=%llx &quot;</span>
					     <span class="s">&quot;i=%x next_hwpage=%llx&quot;</span><span class="p">,</span>
					     <span class="n">pgaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span>
						     <span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					     <span class="n">i</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kpage</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">%</span> <span class="n">hwpages_per_kpage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">&gt;=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">&gt;=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span> <span class="o">=</span>
		<span class="n">list_prepare_entry</span><span class="p">(</span><span class="n">prev_chunk</span><span class="p">,</span>
				   <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">)),</span>
				   <span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check given pages for contiguous layout</span>
<span class="cm"> * last page addr is returned in prev_pgaddr for further check</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_check_kpages_per_ate</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">page_list</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">start_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_idx</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="o">*</span><span class="n">prev_pgaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">start_idx</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">end_idx</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">pgaddr</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page_list</span><span class="p">[</span><span class="n">t</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;chunk_page=%llx value=%016llx&quot;</span><span class="p">,</span> <span class="n">pgaddr</span><span class="p">,</span>
				     <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">abs_to_virt</span><span class="p">(</span><span class="n">phys_to_abs</span><span class="p">(</span><span class="n">pgaddr</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgaddr</span> <span class="o">-</span> <span class="n">PAGE_SIZE</span> <span class="o">!=</span> <span class="o">*</span><span class="n">prev_pgaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;uncontiguous page found pgaddr=%llx &quot;</span>
				     <span class="s">&quot;prev_pgaddr=%llx page_list_i=%x&quot;</span><span class="p">,</span>
				     <span class="n">pgaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_pgaddr</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">prev_pgaddr</span> <span class="o">=</span> <span class="n">pgaddr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PAGE_SIZE &lt; pginfo-&gt;hwpage_size */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_set_pagebuf_user2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">number</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem_chunk</span> <span class="o">*</span><span class="n">prev_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pgaddr</span><span class="p">,</span> <span class="n">prev_pgaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kpages_per_hwpage</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_kpages</span> <span class="o">=</span> <span class="n">kpages_per_hwpage</span><span class="p">;</span>

	<span class="cm">/* loop over desired chunk entries */</span>
	<span class="n">chunk</span>      <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span><span class="p">;</span>
	<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span><span class="p">;</span>
	<span class="n">list_for_each_entry_continue</span><span class="p">(</span>
		<span class="n">chunk</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">)),</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr_kpages</span> <span class="o">==</span> <span class="n">kpages_per_hwpage</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pgaddr</span> <span class="o">=</span> <span class="p">(</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
					   <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span> <span class="p">);</span>
				<span class="o">*</span><span class="n">kpage</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">(</span><span class="n">pgaddr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">kpage</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;pgaddr=%llx i=%x&quot;</span><span class="p">,</span>
						     <span class="n">pgaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * The first page in a hwpage must be aligned;</span>
<span class="cm">				 * the first MR page is exempt from this rule.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pgaddr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ehca_gen_err</span><span class="p">(</span>
							<span class="s">&quot;invalid alignment &quot;</span>
							<span class="s">&quot;pgaddr=%llx i=%x &quot;</span>
							<span class="s">&quot;mr_pgsize=%llx&quot;</span><span class="p">,</span>
							<span class="n">pgaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
							<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">);</span>
						<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
						<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* first MR page */</span>
					<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">pgaddr</span> <span class="o">&amp;</span>
						 <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
						<span class="n">PAGE_SHIFT</span><span class="p">;</span>
					<span class="n">nr_kpages</span> <span class="o">-=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span><span class="p">;</span>
					<span class="o">*</span><span class="n">kpage</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">(</span>
						<span class="n">pgaddr</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ehca_debug_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">abs_to_virt</span><span class="p">(</span>
						<span class="n">phys_to_abs</span><span class="p">(</span><span class="n">pgaddr</span><span class="p">));</span>
					<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;kpage=%llx chunk_page=%llx &quot;</span>
						     <span class="s">&quot;value=%016llx&quot;</span><span class="p">,</span>
						     <span class="o">*</span><span class="n">kpage</span><span class="p">,</span> <span class="n">pgaddr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">prev_pgaddr</span> <span class="o">=</span> <span class="n">pgaddr</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span><span class="o">++</span><span class="p">;</span>
				<span class="n">nr_kpages</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_kpages</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">next_kpage</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">nr_kpages</span> <span class="o">&gt;</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_check_kpages_per_ate</span><span class="p">(</span>
					<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev_pgaddr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span> <span class="o">+=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">+=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">nr_kpages</span> <span class="o">-=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_check_kpages_per_ate</span><span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
							<span class="n">i</span> <span class="o">+</span> <span class="n">nr_kpages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">prev_pgaddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">nr_kpages</span><span class="p">;</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span> <span class="o">+=</span> <span class="n">nr_kpages</span><span class="p">;</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">+=</span> <span class="n">nr_kpages</span><span class="p">;</span>
<span class="nl">next_kpage:</span>
			<span class="n">nr_kpages</span> <span class="o">=</span> <span class="n">kpages_per_hwpage</span><span class="p">;</span>
			<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kpage</span><span class="o">++</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">&gt;=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">&gt;=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_nmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">next_chunk</span> <span class="o">=</span>
		<span class="n">list_prepare_entry</span><span class="p">(</span><span class="n">prev_chunk</span><span class="p">,</span>
				   <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">usr</span><span class="p">.</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">)),</span>
				   <span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_set_pagebuf_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">number</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">num_hw</span><span class="p">,</span> <span class="n">offs_hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* loop over desired phys_buf_array entries */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbuf</span>   <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">phys_buf_array</span> <span class="o">+</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">next_buf</span><span class="p">;</span>
		<span class="n">num_hw</span>  <span class="o">=</span> <span class="n">NUM_CHUNKS</span><span class="p">((</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">%</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">);</span>
		<span class="n">offs_hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">&lt;</span> <span class="n">offs_hw</span> <span class="o">+</span> <span class="n">num_hw</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* sanity check */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span> <span class="o">&gt;=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span> <span class="o">&gt;=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;kpage_cnt &gt;= num_kpages, &quot;</span>
					     <span class="s">&quot;kpage_cnt=%llx num_kpages=%llx &quot;</span>
					     <span class="s">&quot;hwpage_cnt=%llx &quot;</span>
					     <span class="s">&quot;num_hwpages=%llx i=%x&quot;</span><span class="p">,</span>
					     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span><span class="p">,</span>
					     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_kpages</span><span class="p">,</span>
					     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span><span class="p">,</span>
					     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">num_hwpages</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">kpage</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">(</span>
				<span class="p">(</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">*</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">kpage</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;pbuf-&gt;addr=%llx pbuf-&gt;size=%llx &quot;</span>
					     <span class="s">&quot;next_hwpage=%llx&quot;</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
					     <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&gt;=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">%</span>
				    <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span> <span class="o">+=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">/</span>
					<span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">kpage</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">&gt;=</span> <span class="n">offs_hw</span> <span class="o">+</span> <span class="n">num_hw</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">next_buf</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_set_pagebuf_fmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">number</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fmrlist</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* loop over desired page_list entries */</span>
	<span class="n">fmrlist</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">page_list</span> <span class="o">+</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">next_listelem</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">kpage</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">((</span><span class="o">*</span><span class="n">fmrlist</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
				     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">*</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">kpage</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;*fmrlist=%llx fmrlist=%p &quot;</span>
				     <span class="s">&quot;next_listelem=%llx next_hwpage=%llx&quot;</span><span class="p">,</span>
				     <span class="o">*</span><span class="n">fmrlist</span><span class="p">,</span> <span class="n">fmrlist</span><span class="p">,</span>
				     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">next_listelem</span><span class="p">,</span>
				     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">fmr_pgsize</span> <span class="o">&gt;=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">%</span>
			    <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">fmr_pgsize</span> <span class="o">/</span>
			     <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">next_listelem</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="n">fmrlist</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">next_hwpage</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt_per_hwpage</span> <span class="o">=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">/</span>
				<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">fmr_pgsize</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">prev</span> <span class="o">=</span> <span class="o">*</span><span class="n">kpage</span><span class="p">;</span>
			<span class="cm">/* check if adrs are contiguous */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cnt_per_hwpage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u64</span> <span class="n">p</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">(</span><span class="n">fmrlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span>
						    <span class="o">~</span><span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">+</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">fmr_pgsize</span> <span class="o">!=</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;uncontiguous fmr pages &quot;</span>
						     <span class="s">&quot;found prev=%llx p=%llx &quot;</span>
						     <span class="s">&quot;idx=%x&quot;</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">kpage_cnt</span> <span class="o">+=</span> <span class="n">cnt_per_hwpage</span><span class="p">;</span>
			<span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fmr</span><span class="p">.</span><span class="n">next_listelem</span> <span class="o">+=</span> <span class="n">cnt_per_hwpage</span><span class="p">;</span>
			<span class="n">fmrlist</span> <span class="o">+=</span> <span class="n">cnt_per_hwpage</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kpage</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup page buffer from page info */</span>
<span class="kt">int</span> <span class="nf">ehca_set_pagebuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">number</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="o">*</span><span class="n">kpage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EHCA_MR_PGI_PHYS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_set_pagebuf_phys</span><span class="p">(</span><span class="n">pginfo</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHCA_MR_PGI_USER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;=</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">hwpage_size</span> <span class="o">?</span>
			<span class="n">ehca_set_pagebuf_user1</span><span class="p">(</span><span class="n">pginfo</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">kpage</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">ehca_set_pagebuf_user2</span><span class="p">(</span><span class="n">pginfo</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHCA_MR_PGI_FMR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_set_pagebuf_fmr</span><span class="p">(</span><span class="n">pginfo</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">kpage</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ehca_gen_err</span><span class="p">(</span><span class="s">&quot;bad pginfo-&gt;type=%x&quot;</span><span class="p">,</span> <span class="n">pginfo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_set_pagebuf() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * check MR if it is a max-MR, i.e. uses whole memory</span>
<span class="cm"> * in case it&#39;s a max-MR 1 is returned, else 0</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ehca_mr_is_maxmr</span><span class="p">(</span><span class="n">u64</span> <span class="n">size</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* a MR is treated as max-MR only if it fits following: */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">==</span> <span class="n">ehca_mr_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">iova_start</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ehca_map_vaddr</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">KERNELBASE</span> <span class="o">+</span> <span class="n">PHYSICAL_START</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">ehca_gen_dbg</span><span class="p">(</span><span class="s">&quot;this is a max-MR&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_mr_is_maxmr() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* map access control for MR/MW. This routine is used for MR and MW. */</span>
<span class="kt">void</span> <span class="nf">ehca_mrmw_map_acl</span><span class="p">(</span><span class="kt">int</span> <span class="n">ib_acl</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="o">*</span><span class="n">hipz_acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_acl</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">|=</span> <span class="n">HIPZ_ACCESSCTRL_R_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_acl</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">|=</span> <span class="n">HIPZ_ACCESSCTRL_R_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_acl</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_ATOMIC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">|=</span> <span class="n">HIPZ_ACCESSCTRL_R_ATOMIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_acl</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">|=</span> <span class="n">HIPZ_ACCESSCTRL_L_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_acl</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_MW_BIND</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">|=</span> <span class="n">HIPZ_ACCESSCTRL_MW_BIND</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_mrmw_map_acl() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* sets page size in hipz access control for MR/MW. */</span>
<span class="kt">void</span> <span class="nf">ehca_mrmw_set_pgsize_hipz_acl</span><span class="p">(</span><span class="n">u32</span> <span class="n">pgsize</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hipz_acl</span><span class="p">)</span> <span class="cm">/*INOUT*/</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">hipz_acl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ehca_encode_hwpage_size</span><span class="p">(</span><span class="n">pgsize</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end ehca_mrmw_set_pgsize_hipz_acl() */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * reverse map access control for MR/MW.</span>
<span class="cm"> * This routine is used for MR and MW.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ehca_mrmw_reverse_map_acl</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hipz_acl</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">ib_acl</span><span class="p">)</span> <span class="cm">/*OUT*/</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ib_acl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hipz_acl</span> <span class="o">&amp;</span> <span class="n">HIPZ_ACCESSCTRL_R_READ</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ib_acl</span> <span class="o">|=</span> <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hipz_acl</span> <span class="o">&amp;</span> <span class="n">HIPZ_ACCESSCTRL_R_WRITE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ib_acl</span> <span class="o">|=</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hipz_acl</span> <span class="o">&amp;</span> <span class="n">HIPZ_ACCESSCTRL_R_ATOMIC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ib_acl</span> <span class="o">|=</span> <span class="n">IB_ACCESS_REMOTE_ATOMIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hipz_acl</span> <span class="o">&amp;</span> <span class="n">HIPZ_ACCESSCTRL_L_WRITE</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ib_acl</span> <span class="o">|=</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hipz_acl</span> <span class="o">&amp;</span> <span class="n">HIPZ_ACCESSCTRL_MW_BIND</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ib_acl</span> <span class="o">|=</span> <span class="n">IB_ACCESS_MW_BIND</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ehca_mrmw_reverse_map_acl() */</span>


<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * MR destructor and constructor</span>
<span class="cm"> * used in Reregister MR verb, sets all fields in ehca_mr_t to 0,</span>
<span class="cm"> * except struct ib_mr and spinlock</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ehca_mr_deletenew</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">num_kpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">num_hwpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">acl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">fmr_page_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">fmr_max_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">fmr_max_maps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mr</span><span class="o">-&gt;</span><span class="n">fmr_map_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">galpas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">galpas</span><span class="p">));</span>
<span class="p">}</span> <span class="cm">/* end ehca_mr_deletenew() */</span>

<span class="kt">int</span> <span class="nf">ehca_init_mrmw_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mr_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;ehca_cache_mr&quot;</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mr</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mw_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;ehca_cache_mw&quot;</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_mw</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mw_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">mr_cache</span><span class="p">);</span>
		<span class="n">mr_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ehca_cleanup_mrmw_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">mr_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mw_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">mw_cache</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_init_top_bmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_top_bmap</span> <span class="o">*</span><span class="n">ehca_top_bmap</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_top_bmap</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">ehca_top_bmap</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_dir_bmap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_top_bmap</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="cm">/* Set map block to 0xFF according to EHCA_INVAL_ADDR */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ehca_top_bmap</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">],</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">EHCA_ENT_MAP_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_init_bmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_bmap</span> <span class="o">*</span><span class="n">ehca_bmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_top_bmap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="cm">/* Set map block to 0xFF according to EHCA_INVAL_ADDR */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">],</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">EHCA_DIR_MAP_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ehca_init_top_bmap</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">],</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehca_calc_index</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EHCA_INDEX_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ehca_destroy_busmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">top</span> <span class="o">&lt;</span> <span class="n">EHCA_MAP_ENTRIES</span><span class="p">;</span> <span class="n">top</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dir</span> <span class="o">&lt;</span> <span class="n">EHCA_MAP_ENTRIES</span><span class="p">;</span> <span class="n">dir</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="p">);</span>
	<span class="n">ehca_bmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_update_busmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">start_section</span><span class="p">,</span> <span class="n">end_section</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_bmap</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_bmap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="cm">/* Set map block to 0xFF according to EHCA_INVAL_ADDR */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">EHCA_TOP_MAP_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">start_section</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">(</span><span class="n">pfn</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">EHCA_SECTSIZE</span><span class="p">;</span>
	<span class="n">end_section</span> <span class="o">=</span> <span class="n">phys_to_abs</span><span class="p">((</span><span class="n">pfn</span> <span class="o">+</span> <span class="n">nr_pages</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">EHCA_SECTSIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_section</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_section</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">top</span> <span class="o">=</span> <span class="n">ehca_calc_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">EHCA_TOP_INDEX_SHIFT</span><span class="p">);</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">ehca_calc_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">EHCA_DIR_INDEX_SHIFT</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">EHCA_INDEX_MASK</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_init_bmap</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehca_destroy_busmap</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ehca_mr_len</span><span class="p">;</span>
		<span class="n">ehca_mr_len</span> <span class="o">+=</span> <span class="n">EHCA_SECTSIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_is_hugepage</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page_order</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&amp;</span> <span class="n">EHCA_HUGEPAGE_PFN_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">page_order</span> <span class="o">=</span> <span class="n">compound_order</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_order</span> <span class="o">+</span> <span class="n">PAGE_SHIFT</span> <span class="o">!=</span> <span class="n">EHCA_HUGEPAGESHIFT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_create_busmap_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">initial_pfn</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_nr_pages</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">start_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">total_nr_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EHCA_HUGEPAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ehca_update_busmap</span><span class="p">(</span><span class="n">initial_pfn</span><span class="p">,</span> <span class="n">total_nr_pages</span><span class="p">);</span>

	<span class="cm">/* Given chunk is &gt;= 16GB -&gt; check for hugepages */</span>
	<span class="n">start_pfn</span> <span class="o">=</span> <span class="n">initial_pfn</span><span class="p">;</span>
	<span class="n">end_pfn</span> <span class="o">=</span> <span class="n">initial_pfn</span> <span class="o">+</span> <span class="n">total_nr_pages</span><span class="p">;</span>
	<span class="n">pfn</span> <span class="o">=</span> <span class="n">start_pfn</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;</span> <span class="n">end_pfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehca_is_hugepage</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Add mem found in front of the hugepage */</span>
			<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">-</span> <span class="n">start_pfn</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ehca_update_busmap</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="cm">/* Skip the hugepage */</span>
			<span class="n">pfn</span> <span class="o">+=</span> <span class="p">(</span><span class="n">EHCA_HUGEPAGE_SIZE</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="n">start_pfn</span> <span class="o">=</span> <span class="n">pfn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pfn</span> <span class="o">+=</span> <span class="p">(</span><span class="n">EHCA_SECTSIZE</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add mem found behind the hugepage(s)  */</span>
	<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">-</span> <span class="n">start_pfn</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ehca_update_busmap</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehca_create_busmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ehca_mr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">walk_system_ram_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_PHYSMEM_BITS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="n">ehca_create_busmap_callback</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_reg_bmap_mr_rpages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehca_shca</span> <span class="o">*</span><span class="n">shca</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ehca_mr</span> <span class="o">*</span><span class="n">e_mr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ehca_mr_pginfo</span> <span class="o">*</span><span class="n">pginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">,</span> <span class="o">*</span><span class="n">kpage</span><span class="p">;</span>

	<span class="n">kpage</span> <span class="o">=</span> <span class="n">ehca_alloc_fw_ctrlblock</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;kpage alloc failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">top</span> <span class="o">&lt;</span> <span class="n">EHCA_MAP_ENTRIES</span><span class="p">;</span> <span class="n">top</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehca_reg_mr_dir_sections</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">kpage</span><span class="p">,</span> <span class="n">shca</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">pginfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_PAGE_REGISTERED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ehca_free_fw_ctrlblock</span><span class="p">(</span><span class="n">kpage</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Everything is fine */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ehca_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shca</span><span class="o">-&gt;</span><span class="n">ib_device</span><span class="p">,</span> <span class="s">&quot;ehca_reg_bmap_mr_rpages failed, &quot;</span>
				 <span class="s">&quot;h_ret=%lli e_mr=%p top=%x lkey=%x &quot;</span>
				 <span class="s">&quot;hca_hndl=%llx mr_hndl=%llx&quot;</span><span class="p">,</span> <span class="n">hret</span><span class="p">,</span> <span class="n">e_mr</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span>
				 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ib_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">,</span>
				 <span class="n">shca</span><span class="o">-&gt;</span><span class="n">ipz_hca_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
				 <span class="n">e_mr</span><span class="o">-&gt;</span><span class="n">ipz_mr_handle</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ehca2ib_return_code</span><span class="p">(</span><span class="n">hret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_map_vaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">caddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">abs_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>

	<span class="n">abs_addr</span> <span class="o">=</span> <span class="n">virt_to_abs</span><span class="p">(</span><span class="n">caddr</span><span class="p">);</span>
	<span class="n">top</span> <span class="o">=</span> <span class="n">ehca_calc_index</span><span class="p">(</span><span class="n">abs_addr</span><span class="p">,</span> <span class="n">EHCA_TOP_INDEX_SHIFT</span> <span class="o">+</span> <span class="n">EHCA_SECTSHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">ehca_calc_index</span><span class="p">(</span><span class="n">abs_addr</span><span class="p">,</span> <span class="n">EHCA_DIR_INDEX_SHIFT</span> <span class="o">+</span> <span class="n">EHCA_SECTSHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ehca_calc_index</span><span class="p">(</span><span class="n">abs_addr</span><span class="p">,</span> <span class="n">EHCA_SECTSHIFT</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">ehca_bmap</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">[</span><span class="n">top</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehca_bmap_valid</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">caddr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EHCA_SECTSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">entry</span> <span class="o">|</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_dma_mapping_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_addr</span> <span class="o">==</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_dma_map_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ehca_map_vaddr</span><span class="p">(</span><span class="n">cpu_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_dma_unmap_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is only a stub; nothing to be done here */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_dma_map_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EHCA_INVAL_ADDR</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ehca_map_vaddr</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehca_dma_mapping_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_dma_unmap_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is only a stub; nothing to be done here */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehca_dma_map_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">nents</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nents</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ehca_map_vaddr</span><span class="p">(</span><span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehca_dma_mapping_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nents</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_dma_unmap_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">nents</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is only a stub; nothing to be done here */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehca_dma_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ehca_dma_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_dma_sync_single_for_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
					 <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_dma_sync_single_for_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
					    <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
					    <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ehca_dma_alloc_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="o">*</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ehca_map_vaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehca_dma_mapping_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span>	<span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_handle</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehca_dma_free_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">ib_dma_mapping_ops</span> <span class="n">ehca_dma_mapping_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mapping_error</span>          <span class="o">=</span> <span class="n">ehca_dma_mapping_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_single</span>             <span class="o">=</span> <span class="n">ehca_dma_map_single</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_single</span>           <span class="o">=</span> <span class="n">ehca_dma_unmap_single</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_page</span>               <span class="o">=</span> <span class="n">ehca_dma_map_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_page</span>             <span class="o">=</span> <span class="n">ehca_dma_unmap_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_sg</span>                 <span class="o">=</span> <span class="n">ehca_dma_map_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_sg</span>               <span class="o">=</span> <span class="n">ehca_dma_unmap_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_address</span>            <span class="o">=</span> <span class="n">ehca_dma_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_len</span>                <span class="o">=</span> <span class="n">ehca_dma_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_single_for_cpu</span>    <span class="o">=</span> <span class="n">ehca_dma_sync_single_for_cpu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_single_for_device</span> <span class="o">=</span> <span class="n">ehca_dma_sync_single_for_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_coherent</span>         <span class="o">=</span> <span class="n">ehca_dma_alloc_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_coherent</span>          <span class="o">=</span> <span class="n">ehca_dma_free_coherent</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
