<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › mthca › mthca_cmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mthca_cmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005, 2006 Cisco Systems.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_mad.h&gt;</span>

<span class="cp">#include &quot;mthca_dev.h&quot;</span>
<span class="cp">#include &quot;mthca_config_reg.h&quot;</span>
<span class="cp">#include &quot;mthca_cmd.h&quot;</span>
<span class="cp">#include &quot;mthca_memfree.h&quot;</span>

<span class="cp">#define CMD_POLL_TOKEN 0xffff</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HCR_IN_PARAM_OFFSET</span>    <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">HCR_IN_MODIFIER_OFFSET</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">HCR_OUT_PARAM_OFFSET</span>   <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="n">HCR_TOKEN_OFFSET</span>       <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">HCR_STATUS_OFFSET</span>      <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>

	<span class="n">HCR_OPMOD_SHIFT</span>        <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">HCA_E_BIT</span>              <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
	<span class="n">HCR_GO_BIT</span>             <span class="o">=</span> <span class="mi">23</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* initialization and general commands */</span>
	<span class="n">CMD_SYS_EN</span>          <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">CMD_SYS_DIS</span>         <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">CMD_MAP_FA</span>          <span class="o">=</span> <span class="mh">0xfff</span><span class="p">,</span>
	<span class="n">CMD_UNMAP_FA</span>        <span class="o">=</span> <span class="mh">0xffe</span><span class="p">,</span>
	<span class="n">CMD_RUN_FW</span>          <span class="o">=</span> <span class="mh">0xff6</span><span class="p">,</span>
	<span class="n">CMD_MOD_STAT_CFG</span>    <span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="n">CMD_QUERY_DEV_LIM</span>   <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="n">CMD_QUERY_FW</span>        <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">CMD_ENABLE_LAM</span>      <span class="o">=</span> <span class="mh">0xff8</span><span class="p">,</span>
	<span class="n">CMD_DISABLE_LAM</span>     <span class="o">=</span> <span class="mh">0xff7</span><span class="p">,</span>
	<span class="n">CMD_QUERY_DDR</span>       <span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span>
	<span class="n">CMD_QUERY_ADAPTER</span>   <span class="o">=</span> <span class="mh">0x6</span><span class="p">,</span>
	<span class="n">CMD_INIT_HCA</span>        <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="n">CMD_CLOSE_HCA</span>       <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">CMD_INIT_IB</span>         <span class="o">=</span> <span class="mh">0x9</span><span class="p">,</span>
	<span class="n">CMD_CLOSE_IB</span>        <span class="o">=</span> <span class="mh">0xa</span><span class="p">,</span>
	<span class="n">CMD_QUERY_HCA</span>       <span class="o">=</span> <span class="mh">0xb</span><span class="p">,</span>
	<span class="n">CMD_SET_IB</span>          <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="n">CMD_ACCESS_DDR</span>      <span class="o">=</span> <span class="mh">0x2e</span><span class="p">,</span>
	<span class="n">CMD_MAP_ICM</span>         <span class="o">=</span> <span class="mh">0xffa</span><span class="p">,</span>
	<span class="n">CMD_UNMAP_ICM</span>       <span class="o">=</span> <span class="mh">0xff9</span><span class="p">,</span>
	<span class="n">CMD_MAP_ICM_AUX</span>     <span class="o">=</span> <span class="mh">0xffc</span><span class="p">,</span>
	<span class="n">CMD_UNMAP_ICM_AUX</span>   <span class="o">=</span> <span class="mh">0xffb</span><span class="p">,</span>
	<span class="n">CMD_SET_ICM_SIZE</span>    <span class="o">=</span> <span class="mh">0xffd</span><span class="p">,</span>

	<span class="cm">/* TPT commands */</span>
	<span class="n">CMD_SW2HW_MPT</span> 	    <span class="o">=</span> <span class="mh">0xd</span><span class="p">,</span>
	<span class="n">CMD_QUERY_MPT</span> 	    <span class="o">=</span> <span class="mh">0xe</span><span class="p">,</span>
	<span class="n">CMD_HW2SW_MPT</span> 	    <span class="o">=</span> <span class="mh">0xf</span><span class="p">,</span>
	<span class="n">CMD_READ_MTT</span>        <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CMD_WRITE_MTT</span>       <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="n">CMD_SYNC_TPT</span>        <span class="o">=</span> <span class="mh">0x2f</span><span class="p">,</span>

	<span class="cm">/* EQ commands */</span>
	<span class="n">CMD_MAP_EQ</span>          <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="n">CMD_SW2HW_EQ</span> 	    <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="n">CMD_HW2SW_EQ</span> 	    <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">CMD_QUERY_EQ</span>        <span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span>

	<span class="cm">/* CQ commands */</span>
	<span class="n">CMD_SW2HW_CQ</span> 	    <span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>
	<span class="n">CMD_HW2SW_CQ</span> 	    <span class="o">=</span> <span class="mh">0x17</span><span class="p">,</span>
	<span class="n">CMD_QUERY_CQ</span> 	    <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
	<span class="n">CMD_RESIZE_CQ</span>       <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>

	<span class="cm">/* SRQ commands */</span>
	<span class="n">CMD_SW2HW_SRQ</span> 	    <span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>
	<span class="n">CMD_HW2SW_SRQ</span> 	    <span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>
	<span class="n">CMD_QUERY_SRQ</span>       <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
	<span class="n">CMD_ARM_SRQ</span>         <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>

	<span class="cm">/* QP/EE commands */</span>
	<span class="n">CMD_RST2INIT_QPEE</span>   <span class="o">=</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="n">CMD_INIT2RTR_QPEE</span>   <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>
	<span class="n">CMD_RTR2RTS_QPEE</span>    <span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>
	<span class="n">CMD_RTS2RTS_QPEE</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="n">CMD_SQERR2RTS_QPEE</span>  <span class="o">=</span> <span class="mh">0x1d</span><span class="p">,</span>
	<span class="n">CMD_2ERR_QPEE</span>       <span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="n">CMD_RTS2SQD_QPEE</span>    <span class="o">=</span> <span class="mh">0x1f</span><span class="p">,</span>
	<span class="n">CMD_SQD2SQD_QPEE</span>    <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="n">CMD_SQD2RTS_QPEE</span>    <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">CMD_ERR2RST_QPEE</span>    <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
	<span class="n">CMD_QUERY_QPEE</span>      <span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>
	<span class="n">CMD_INIT2INIT_QPEE</span>  <span class="o">=</span> <span class="mh">0x2d</span><span class="p">,</span>
	<span class="n">CMD_SUSPEND_QPEE</span>    <span class="o">=</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="n">CMD_UNSUSPEND_QPEE</span>  <span class="o">=</span> <span class="mh">0x33</span><span class="p">,</span>
	<span class="cm">/* special QPs and management commands */</span>
	<span class="n">CMD_CONF_SPECIAL_QP</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>
	<span class="n">CMD_MAD_IFC</span>         <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>

	<span class="cm">/* multicast commands */</span>
	<span class="n">CMD_READ_MGM</span>        <span class="o">=</span> <span class="mh">0x25</span><span class="p">,</span>
	<span class="n">CMD_WRITE_MGM</span>       <span class="o">=</span> <span class="mh">0x26</span><span class="p">,</span>
	<span class="n">CMD_MGID_HASH</span>       <span class="o">=</span> <span class="mh">0x27</span><span class="p">,</span>

	<span class="cm">/* miscellaneous commands */</span>
	<span class="n">CMD_DIAG_RPRT</span>       <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">CMD_NOP</span>             <span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>

	<span class="cm">/* debug commands */</span>
	<span class="n">CMD_QUERY_DEBUG_MSG</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
	<span class="n">CMD_SET_DEBUG_MSG</span>   <span class="o">=</span> <span class="mh">0x2b</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * According to Mellanox code, FW may be starved and never complete</span>
<span class="cm"> * commands.  So we can&#39;t use strict timeouts described in PRM -- we</span>
<span class="cm"> * just arbitrarily select 60 seconds for now.</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> * Round up and add 1 to make sure we get the full wait time (since we</span>
<span class="c"> * will be starting in the middle of a jiffy)</span>
<span class="c"> */</span>
<span class="c">enum {</span>
<span class="c">	CMD_TIME_CLASS_A = (HZ + 999) / 1000 + 1,</span>
<span class="c">	CMD_TIME_CLASS_B = (HZ +  99) /  100 + 1,</span>
<span class="c">	CMD_TIME_CLASS_C = (HZ +   9) /   10 + 1,</span>
<span class="c">	CMD_TIME_CLASS_D = 60 * HZ</span>
<span class="c">};</span>
<span class="cp">#else</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CMD_TIME_CLASS_A</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="n">CMD_TIME_CLASS_B</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="n">CMD_TIME_CLASS_C</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="n">CMD_TIME_CLASS_D</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">GO_BIT_TIMEOUT</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">10</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mthca_cmd_context</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">next</span><span class="p">;</span>
	<span class="n">u64</span>               <span class="n">out_param</span><span class="p">;</span>
	<span class="n">u16</span>               <span class="n">token</span><span class="p">;</span>
	<span class="n">u8</span>                <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fw_cmd_doorbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fw_cmd_doorbell</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fw_cmd_doorbell</span><span class="p">,</span> <span class="s">&quot;post FW commands through doorbell page if nonzero &quot;</span>
		 <span class="s">&quot;(and supported by FW)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">go_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="n">HCR_STATUS_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">swab32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HCR_GO_BIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mthca_cmd_post_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
				 <span class="n">u64</span> <span class="n">out_param</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_map</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">offs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_offsets</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">in_param</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>           <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">in_param</span> <span class="o">&amp;</span> <span class="mh">0xfffffffful</span><span class="p">),</span>  <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">in_modifier</span><span class="p">),</span>              <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">out_param</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>          <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">out_param</span> <span class="o">&amp;</span> <span class="mh">0xfffffffful</span><span class="p">),</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">token</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>              <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HCR_GO_BIT</span><span class="p">)</span>                <span class="o">|</span>
					       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HCA_E_BIT</span><span class="p">)</span>                 <span class="o">|</span>
					       <span class="p">(</span><span class="n">op_modifier</span> <span class="o">&lt;&lt;</span> <span class="n">HCR_OPMOD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">op</span><span class="p">),</span>			  <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="mi">0</span><span class="p">,</span>                                     <span class="n">ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd_post_hcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">out_param</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">token</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">GO_BIT_TIMEOUT</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">go_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We use writel (instead of something like memcpy_toio)</span>
<span class="cm">	 * because writes of less than 32 bits to the HCR don&#39;t work</span>
<span class="cm">	 * (and some architectures such as ia64 implement memcpy_toio</span>
<span class="cm">	 * in terms of writeb).</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">in_param</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">in_param</span> <span class="o">&amp;</span> <span class="mh">0xfffffffful</span><span class="p">),</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">in_modifier</span><span class="p">),</span>              <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">out_param</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>          <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">out_param</span> <span class="o">&amp;</span> <span class="mh">0xfffffffful</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">token</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>              <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* __raw_writel may not order writes. */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HCR_GO_BIT</span><span class="p">)</span>                <span class="o">|</span>
					       <span class="p">(</span><span class="n">event</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HCA_E_BIT</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="o">|</span>
					       <span class="p">(</span><span class="n">op_modifier</span> <span class="o">&lt;&lt;</span> <span class="n">HCR_OPMOD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
					       <span class="n">op</span><span class="p">),</span>                       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">out_param</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">token</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hcr_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_CMD_POST_DOORBELLS</span> <span class="o">&amp;&amp;</span> <span class="n">fw_cmd_doorbell</span><span class="p">)</span>
		<span class="n">mthca_cmd_post_dbell</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="n">out_param</span><span class="p">,</span> <span class="n">in_modifier</span><span class="p">,</span>
					   <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_post_hcr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="n">out_param</span><span class="p">,</span> <span class="n">in_modifier</span><span class="p">,</span>
					 <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that our HCR writes don&#39;t get mixed in with</span>
<span class="cm">	 * writes from another CPU starting a FW command.</span>
<span class="cm">	 */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hcr_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_status_to_errno</span><span class="p">(</span><span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">trans_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_INTERNAL_ERR</span><span class="p">]</span>   <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_OP</span><span class="p">]</span>         <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_PARAM</span><span class="p">]</span>      <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_SYS_STATE</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_RESOURCE</span><span class="p">]</span>   <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_RESOURCE_BUSY</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_DDR_MEM_ERR</span><span class="p">]</span>    <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_EXCEED_LIM</span><span class="p">]</span>     <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_RES_STATE</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_INDEX</span><span class="p">]</span>      <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_NVMEM</span><span class="p">]</span>      <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_QPEE_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_SEG_PARAM</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_REG_BOUND</span><span class="p">]</span>      <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_LAM_NOT_PRE</span><span class="p">]</span>    <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_PKT</span><span class="p">]</span>        <span class="o">=</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">,</span>
		<span class="p">[</span><span class="n">MTHCA_CMD_STAT_BAD_SIZE</span><span class="p">]</span>       <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">trans_table</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MTHCA_CMD_STAT_OK</span>
			 <span class="o">&amp;&amp;</span> <span class="n">trans_table</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">trans_table</span><span class="p">[</span><span class="n">status</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="o">*</span><span class="n">out_param</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">out_is_imm</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">poll_sem</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_post</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span>
			     <span class="n">out_param</span> <span class="o">?</span> <span class="o">*</span><span class="n">out_param</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span>
			     <span class="n">op</span><span class="p">,</span> <span class="n">CMD_POLL_TOKEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">go_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_is_imm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">out_param</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">be32_to_cpu</span><span class="p">((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span>
					  <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="n">HCR_OUT_PARAM_OFFSET</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">be32_to_cpu</span><span class="p">((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span>
					  <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="n">HCR_OUT_PARAM_OFFSET</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">+</span> <span class="n">HCR_STATUS_OFFSET</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command %02x completed with status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">op</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_status_to_errno</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">poll_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mthca_cmd_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">token</span><span class="p">,</span>
		     <span class="n">u8</span>  <span class="n">status</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="n">out_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_cmd_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">[</span><span class="n">token</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">token_mask</span><span class="p">];</span>

	<span class="cm">/* previously timed out command completing at long last */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">result</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">status</span>    <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">out_param</span> <span class="o">=</span> <span class="n">out_param</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="o">*</span><span class="n">out_param</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">out_is_imm</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_cmd_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">event_sem</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context_lock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">free_head</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">free_head</span><span class="p">];</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">token_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">free_head</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context_lock</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_post</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span>
			     <span class="n">out_param</span> <span class="o">?</span> <span class="o">*</span><span class="n">out_param</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span>
			     <span class="n">op</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command %02x completed with status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">op</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_status_to_errno</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_is_imm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">out_param</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">out_param</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context_lock</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">free_head</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">free_head</span> <span class="o">=</span> <span class="n">context</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context_lock</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">event_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Invoke a command with an output mailbox */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd_box</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">out_param</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_CMD_USE_EVENTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mthca_cmd_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				      <span class="n">timeout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">mthca_cmd_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				      <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Invoke a command with no output parameter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">in_modifier</span><span class="p">,</span>
			     <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Invoke a command with an immediate output parameter (and copy the</span>
<span class="cm"> * output into the caller&#39;s out_param pointer after the command</span>
<span class="cm"> * executes).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_cmd_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">in_param</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="o">*</span><span class="n">out_param</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">in_modifier</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">op_modifier</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">op</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_CMD_USE_EVENTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mthca_cmd_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="n">out_param</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				      <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				      <span class="n">timeout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">mthca_cmd_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_param</span><span class="p">,</span> <span class="n">out_param</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				      <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				      <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_cmd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hcr_mutex</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">poll_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">MTHCA_HCR_BASE</span><span class="p">,</span>
			   <span class="n">MTHCA_HCR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map command register.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;mthca_cmd&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">MTHCA_MAILBOX_SIZE</span><span class="p">,</span>
					<span class="n">MTHCA_MAILBOX_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mthca_cmd_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pool</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_CMD_POST_DOORBELLS</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch to using events to issue FW commands (should be called after</span>
<span class="cm"> * event queue to command events has been initialized).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mthca_cmd_use_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span> <span class="o">*</span>
				   <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mthca_cmd_context</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">free_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">event_sem</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">token_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">token_mask</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span><span class="p">;</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">token_mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* nothing */</span>
	<span class="o">--</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">token_mask</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MTHCA_CMD_USE_EVENTS</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">poll_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch back to polling (used when shutting down the device)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mthca_cmd_use_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MTHCA_CMD_USE_EVENTS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">event_sem</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">context</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">poll_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="nf">mthca_alloc_mailbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mailbox</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mailbox</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mthca_free_mailbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mailbox</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SYS_EN</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mthca_cmd_imm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SYS_EN</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_D</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="n">mthca_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SYS_EN DDR error: syn=%x, sock=%d, &quot;</span>
			   <span class="s">&quot;sladdr=%d, SPD source=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">out</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;NVMEM&quot;</span> <span class="o">:</span> <span class="s">&quot;DIMM&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SYS_DIS</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SYS_DIS</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_map_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_icm</span> <span class="o">*</span><span class="n">icm</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">virt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_icm_iter</span> <span class="n">iter</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MTHCA_MAILBOX_SIZE</span><span class="p">);</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mthca_icm_first</span><span class="p">(</span><span class="n">icm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span>
	     <span class="o">!</span><span class="n">mthca_icm_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span>
	     <span class="n">mthca_icm_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We have to pass pages that are aligned to their</span>
<span class="cm">		 * size, so find the least significant 1 in the</span>
<span class="cm">		 * address or size and use that as our log2 size.</span>
<span class="cm">		 */</span>
		<span class="n">lg</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mthca_icm_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">)</span> <span class="o">|</span> <span class="n">mthca_icm_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lg</span> <span class="o">&lt;</span> <span class="n">MTHCA_ICM_PAGE_SHIFT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mthca_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Got FW area not aligned to %d (%llx/%lx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">MTHCA_ICM_PAGE_SIZE</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mthca_icm_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">),</span>
				   <span class="n">mthca_icm_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mthca_icm_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">lg</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">virt</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pages</span><span class="p">[</span><span class="n">nent</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">virt</span><span class="p">);</span>
				<span class="n">virt</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lg</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pages</span><span class="p">[</span><span class="n">nent</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_be64</span><span class="p">((</span><span class="n">mthca_icm_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">lg</span><span class="p">))</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">lg</span> <span class="o">-</span> <span class="n">MTHCA_ICM_PAGE_SHIFT</span><span class="p">));</span>
			<span class="n">ts</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">lg</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
			<span class="o">++</span><span class="n">tc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">nent</span> <span class="o">==</span> <span class="n">MTHCA_MAILBOX_SIZE</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
						<span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">nent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nent</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				<span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CMD_MAP_FA</span>:
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped %d chunks/%d KB for FW.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_MAP_ICM_AUX</span>:
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped %d chunks/%d KB for ICM aux.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_MAP_ICM</span>:
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped %d chunks/%d KB at %llx for ICM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tc</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">virt</span> <span class="o">-</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MAP_FA</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_icm</span> <span class="o">*</span><span class="n">icm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_map_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD_MAP_FA</span><span class="p">,</span> <span class="n">icm</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_UNMAP_FA</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_UNMAP_FA</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_RUN_FW</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_RUN_FW</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mthca_setup_cmd_doorbells</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phys_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">max_off</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">max_off</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">base</span> <span class="o">+</span> <span class="n">max_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware doorbell region at 0x%016llx, &quot;</span>
			   <span class="s">&quot;length 0x%x crosses a page boundary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">base</span><span class="p">,</span> <span class="n">max_off</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_map</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">max_off</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_map</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MTHCA_CMD_POST_DOORBELLS</span><span class="p">;</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped doorbell page for posting FW commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_QUERY_FW</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">outbox</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define QUERY_FW_OUT_SIZE             0x100</span>
<span class="cp">#define QUERY_FW_VER_OFFSET            0x00</span>
<span class="cp">#define QUERY_FW_MAX_CMD_OFFSET        0x0f</span>
<span class="cp">#define QUERY_FW_ERR_START_OFFSET      0x30</span>
<span class="cp">#define QUERY_FW_ERR_SIZE_OFFSET       0x38</span>

<span class="cp">#define QUERY_FW_CMD_DB_EN_OFFSET      0x10</span>
<span class="cp">#define QUERY_FW_CMD_DB_OFFSET         0x50</span>
<span class="cp">#define QUERY_FW_CMD_DB_BASE           0x60</span>

<span class="cp">#define QUERY_FW_START_OFFSET          0x20</span>
<span class="cp">#define QUERY_FW_END_OFFSET            0x28</span>

<span class="cp">#define QUERY_FW_SIZE_OFFSET           0x00</span>
<span class="cp">#define QUERY_FW_CLR_INT_BASE_OFFSET   0x20</span>
<span class="cp">#define QUERY_FW_EQ_ARM_BASE_OFFSET    0x40</span>
<span class="cp">#define QUERY_FW_EQ_SET_CI_BASE_OFFSET 0x48</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">outbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_QUERY_FW</span><span class="p">,</span>
			    <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span>   <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_VER_OFFSET</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * FW subminor version is at more significant bits than minor</span>
<span class="cm">	 * version, so swap here.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&amp;</span> <span class="mh">0xffff00000000ull</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&amp;</span> <span class="mh">0xffff0000ull</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&amp;</span> <span class="mh">0x0000ffffull</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">lg</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_MAX_CMD_OFFSET</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lg</span><span class="p">;</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW version %012llx, max commands %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">max_cmds</span><span class="p">);</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">catas_err</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_ERR_START_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">catas_err</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_ERR_SIZE_OFFSET</span><span class="p">);</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Catastrophic error buffer at 0x%llx, size 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">catas_err</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">catas_err</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_CMD_DB_EN_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW supports commands through doorbells</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_CMD_DB_BASE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MTHCA_CMD_NUM_DBELL_DWORDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dbell_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">outbox</span><span class="p">,</span>
				  <span class="n">QUERY_FW_CMD_DB_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">mthca_setup_cmd_doorbells</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_pages</span><span class="p">,</span>       <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_SIZE_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">clr_int_base</span><span class="p">,</span>   <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_CLR_INT_BASE_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">eq_arm_base</span><span class="p">,</span>    <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_EQ_ARM_BASE_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">eq_set_ci_base</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_EQ_SET_CI_BASE_OFFSET</span><span class="p">);</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW size %d KB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_pages</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Round up number of system pages needed in case</span>
<span class="cm">		 * MTHCA_ICM_PAGE_SIZE &lt; PAGE_SIZE.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_pages</span> <span class="o">=</span>
			<span class="n">ALIGN</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_pages</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">MTHCA_ICM_PAGE_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="n">MTHCA_ICM_PAGE_SHIFT</span><span class="p">);</span>

		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Clear int @ %llx, EQ arm @ %llx, EQ set CI @ %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">clr_int_base</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">eq_arm_base</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">eq_set_ci_base</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">fw_start</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_START_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">fw_end</span><span class="p">,</span>   <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_FW_END_OFFSET</span><span class="p">);</span>

		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW size %d KB (start %llx, end %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">fw_end</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">fw_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">),</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">fw_start</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">fw_end</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_ENABLE_LAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">outbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define ENABLE_LAM_OUT_SIZE         0x100</span>
<span class="cp">#define ENABLE_LAM_START_OFFSET     0x00</span>
<span class="cp">#define ENABLE_LAM_END_OFFSET       0x08</span>
<span class="cp">#define ENABLE_LAM_INFO_OFFSET      0x13</span>

<span class="cp">#define ENABLE_LAM_INFO_HIDDEN_FLAG (1 &lt;&lt; 4)</span>
<span class="cp">#define ENABLE_LAM_INFO_ECC_MASK    0x3</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">outbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_ENABLE_LAM</span><span class="p">,</span>
			    <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_start</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">ENABLE_LAM_START_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_end</span><span class="p">,</span>   <span class="n">outbox</span><span class="p">,</span> <span class="n">ENABLE_LAM_END_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>           <span class="n">outbox</span><span class="p">,</span> <span class="n">ENABLE_LAM_INFO_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">ENABLE_LAM_INFO_HIDDEN_FLAG</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_DDR_HIDDEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW reports that HCA-attached memory &quot;</span>
			   <span class="s">&quot;is %s hidden; does not match PCI config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">ENABLE_LAM_INFO_HIDDEN_FLAG</span><span class="p">)</span> <span class="o">?</span>
			   <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">ENABLE_LAM_INFO_HIDDEN_FLAG</span><span class="p">)</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA-attached memory is hidden.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA memory size %d KB (start %llx, end %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_end</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">),</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_start</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_end</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_DISABLE_LAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SYS_DIS</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_QUERY_DDR</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">outbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define QUERY_DDR_OUT_SIZE         0x100</span>
<span class="cp">#define QUERY_DDR_START_OFFSET     0x00</span>
<span class="cp">#define QUERY_DDR_END_OFFSET       0x08</span>
<span class="cp">#define QUERY_DDR_INFO_OFFSET      0x13</span>

<span class="cp">#define QUERY_DDR_INFO_HIDDEN_FLAG (1 &lt;&lt; 4)</span>
<span class="cp">#define QUERY_DDR_INFO_ECC_MASK    0x3</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">outbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_QUERY_DDR</span><span class="p">,</span>
			    <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_start</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DDR_START_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_end</span><span class="p">,</span>   <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DDR_END_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>           <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DDR_INFO_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">QUERY_DDR_INFO_HIDDEN_FLAG</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_DDR_HIDDEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW reports that HCA-attached memory &quot;</span>
			   <span class="s">&quot;is %s hidden; does not match PCI config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">QUERY_DDR_INFO_HIDDEN_FLAG</span><span class="p">)</span> <span class="o">?</span>
			   <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">QUERY_DDR_INFO_HIDDEN_FLAG</span><span class="p">)</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA-attached memory is hidden.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HCA memory size %d KB (start %llx, end %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_end</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">),</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_start</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ddr_end</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_QUERY_DEV_LIM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mthca_dev_lim</span> <span class="o">*</span><span class="n">dev_lim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">outbox</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">stat_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#define QUERY_DEV_LIM_OUT_SIZE             0x100</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_SRQ_SZ_OFFSET     0x10</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_QP_SZ_OFFSET      0x11</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_QP_OFFSET        0x12</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_QP_OFFSET         0x13</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_SRQ_OFFSET       0x14</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_SRQ_OFFSET        0x15</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_EEC_OFFSET       0x16</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_EEC_OFFSET        0x17</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_CQ_SZ_OFFSET      0x19</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_CQ_OFFSET        0x1a</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_CQ_OFFSET         0x1b</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_MPT_OFFSET        0x1d</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_EQ_OFFSET        0x1e</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_EQ_OFFSET         0x1f</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_MTT_OFFSET       0x20</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_MRW_SZ_OFFSET     0x21</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_MRW_OFFSET       0x22</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_MTT_SEG_OFFSET    0x23</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_AV_OFFSET         0x27</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_REQ_QP_OFFSET     0x29</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_RES_QP_OFFSET     0x2b</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_RDMA_OFFSET       0x2f</span>
<span class="cp">#define QUERY_DEV_LIM_RSZ_SRQ_OFFSET        0x33</span>
<span class="cp">#define QUERY_DEV_LIM_ACK_DELAY_OFFSET      0x35</span>
<span class="cp">#define QUERY_DEV_LIM_MTU_WIDTH_OFFSET      0x36</span>
<span class="cp">#define QUERY_DEV_LIM_VL_PORT_OFFSET        0x37</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_GID_OFFSET        0x3b</span>
<span class="cp">#define QUERY_DEV_LIM_RATE_SUPPORT_OFFSET   0x3c</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_PKEY_OFFSET       0x3f</span>
<span class="cp">#define QUERY_DEV_LIM_FLAGS_OFFSET          0x44</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_UAR_OFFSET       0x48</span>
<span class="cp">#define QUERY_DEV_LIM_UAR_SZ_OFFSET         0x49</span>
<span class="cp">#define QUERY_DEV_LIM_PAGE_SZ_OFFSET        0x4b</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_SG_OFFSET         0x51</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_DESC_SZ_OFFSET    0x52</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_SG_RQ_OFFSET      0x55</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_DESC_SZ_RQ_OFFSET 0x56</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_QP_MCG_OFFSET     0x61</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_MCG_OFFSET       0x62</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_MCG_OFFSET        0x63</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_PD_OFFSET        0x64</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_PD_OFFSET         0x65</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_RDD_OFFSET       0x66</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_RDD_OFFSET        0x67</span>
<span class="cp">#define QUERY_DEV_LIM_EEC_ENTRY_SZ_OFFSET   0x80</span>
<span class="cp">#define QUERY_DEV_LIM_QPC_ENTRY_SZ_OFFSET   0x82</span>
<span class="cp">#define QUERY_DEV_LIM_EEEC_ENTRY_SZ_OFFSET  0x84</span>
<span class="cp">#define QUERY_DEV_LIM_EQPC_ENTRY_SZ_OFFSET  0x86</span>
<span class="cp">#define QUERY_DEV_LIM_EQC_ENTRY_SZ_OFFSET   0x88</span>
<span class="cp">#define QUERY_DEV_LIM_CQC_ENTRY_SZ_OFFSET   0x8a</span>
<span class="cp">#define QUERY_DEV_LIM_SRQ_ENTRY_SZ_OFFSET   0x8c</span>
<span class="cp">#define QUERY_DEV_LIM_UAR_ENTRY_SZ_OFFSET   0x8e</span>
<span class="cp">#define QUERY_DEV_LIM_MTT_ENTRY_SZ_OFFSET   0x90</span>
<span class="cp">#define QUERY_DEV_LIM_MPT_ENTRY_SZ_OFFSET   0x92</span>
<span class="cp">#define QUERY_DEV_LIM_PBL_SZ_OFFSET         0x96</span>
<span class="cp">#define QUERY_DEV_LIM_BMME_FLAGS_OFFSET     0x97</span>
<span class="cp">#define QUERY_DEV_LIM_RSVD_LKEY_OFFSET      0x98</span>
<span class="cp">#define QUERY_DEV_LIM_LAMR_OFFSET           0x9f</span>
<span class="cp">#define QUERY_DEV_LIM_MAX_ICM_SZ_OFFSET     0xa0</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">outbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_QUERY_DEV_LIM</span><span class="p">,</span>
			    <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_QP_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_qps</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_QP_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qps</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_SRQ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_srqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_SRQ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_srqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_EEC_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_eecs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_EEC_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_eecs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_CQ_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_cq_sz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_CQ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_cqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_CQ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_cqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_MPT_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_mpts</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_EQ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_eqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_EQ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_eqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_MTT_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mtts</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtt_seg_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtt_seg_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mtts</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_MRW_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_mrw_sz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_MRW_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mrws</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_MTT_SEG_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_mtt_seg</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_REQ_QP_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_requester_per_qp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_RES_QP_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_responder_per_qp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_RDMA_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_rdma_global</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_ACK_DELAY_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MTU_WIDTH_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_mtu</span>        <span class="o">=</span> <span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_port_width</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_VL_PORT_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_vl</span>    <span class="o">=</span> <span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_GID_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_gids</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">stat_rate</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RATE_SUPPORT_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">stat_rate_support</span> <span class="o">=</span> <span class="n">stat_rate</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_PKEY_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_pkeys</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_FLAGS_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_UAR_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_uars</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_UAR_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">uar_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_PAGE_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">min_page_sz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_SG_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_sg</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_DESC_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_desc_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_QP_MCG_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qp_per_mcg</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_MCG_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mgms</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_MCG_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_mcgs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_PD_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_pds</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_PD_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_pds</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSVD_RDD_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_rdds</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_RDD_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_rdds</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_EEC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">eec_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_QPC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">qpc_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_EEEC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">eeec_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_EQPC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">eqpc_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_EQC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">eqc_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_CQC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">cqc_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_SRQ_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">srq_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_UAR_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">uar_scratch_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_SRQ_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_srq_sz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_QP_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qp_sz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_RSZ_SRQ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">resize_srq</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_SG_RQ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_sg</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_sg</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_DESC_SZ_RQ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_desc_sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_desc_sz</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MPT_ENTRY_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">mpt_entry_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_PBL_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">max_pbl_sz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">bmme_flags</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>
			  <span class="n">QUERY_DEV_LIM_BMME_FLAGS_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">reserved_lkey</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>
			  <span class="n">QUERY_DEV_LIM_RSVD_LKEY_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_LAMR_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">lam_required</span> <span class="o">=</span> <span class="n">field</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">max_icm_sz</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>
			  <span class="n">QUERY_DEV_LIM_MAX_ICM_SZ_OFFSET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">bmme_flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Base MM extensions: yes &quot;</span>
				  <span class="s">&quot;(flags %d, max PBL %d, rsvd L_Key %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">bmme_flags</span><span class="p">,</span>
				  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">max_pbl_sz</span><span class="p">,</span>
				  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">reserved_lkey</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Base MM extensions: no</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max ICM size %lld MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">max_icm_sz</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_SRQ_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_srq_sz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_QP_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qp_sz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">QUERY_DEV_LIM_MAX_AV_OFFSET</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">hca</span><span class="p">.</span><span class="n">tavor</span><span class="p">.</span><span class="n">max_avs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">mpt_entry_sz</span> <span class="o">=</span> <span class="n">MTHCA_MPT_ENTRY_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max QPs: %d, reserved QPs: %d, entry size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qps</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_qps</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">qpc_entry_sz</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max SRQs: %d, reserved SRQs: %d, entry size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_srqs</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_srqs</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">srq_entry_sz</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max CQs: %d, reserved CQs: %d, entry size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_cqs</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_cqs</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">cqc_entry_sz</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max EQs: %d, reserved EQs: %d, entry size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_eqs</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_eqs</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">eqc_entry_sz</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reserved MPTs: %d, reserved MTTs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mrws</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mtts</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max PDs: %d, reserved PDs: %d, reserved UARs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_pds</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_pds</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_uars</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max QP/MCG: %d, reserved MGMs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_pds</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mgms</span><span class="p">);</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Max CQEs: %d, max WQEs: %d, max SRQ WQEs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_cq_sz</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qp_sz</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_srq_sz</span><span class="p">);</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Flags: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_board_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vsd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">board_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define VSD_OFFSET_SIG1		0x00</span>
<span class="cp">#define VSD_OFFSET_SIG2		0xde</span>
<span class="cp">#define VSD_OFFSET_MLX_BOARD_ID	0xd0</span>
<span class="cp">#define VSD_OFFSET_TS_BOARD_ID	0x20</span>

<span class="cp">#define VSD_SIGNATURE_TOPSPIN	0x5ad</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">board_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MTHCA_BOARD_ID_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpup</span><span class="p">(</span><span class="n">vsd</span> <span class="o">+</span> <span class="n">VSD_OFFSET_SIG1</span><span class="p">)</span> <span class="o">==</span> <span class="n">VSD_SIGNATURE_TOPSPIN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">be16_to_cpup</span><span class="p">(</span><span class="n">vsd</span> <span class="o">+</span> <span class="n">VSD_OFFSET_SIG2</span><span class="p">)</span> <span class="o">==</span> <span class="n">VSD_SIGNATURE_TOPSPIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">board_id</span><span class="p">,</span> <span class="n">vsd</span> <span class="o">+</span> <span class="n">VSD_OFFSET_TS_BOARD_ID</span><span class="p">,</span> <span class="n">MTHCA_BOARD_ID_LEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The board ID is a string but the firmware byte</span>
<span class="cm">		 * swaps each 4-byte word before passing it back to</span>
<span class="cm">		 * us.  Therefore we need to swab it before printing.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">board_id</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">swab32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">vsd</span> <span class="o">+</span> <span class="n">VSD_OFFSET_MLX_BOARD_ID</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_QUERY_ADAPTER</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mthca_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">outbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#define QUERY_ADAPTER_OUT_SIZE             0x100</span>
<span class="cp">#define QUERY_ADAPTER_VENDOR_ID_OFFSET     0x00</span>
<span class="cp">#define QUERY_ADAPTER_DEVICE_ID_OFFSET     0x04</span>
<span class="cp">#define QUERY_ADAPTER_REVISION_ID_OFFSET   0x08</span>
<span class="cp">#define QUERY_ADAPTER_INTA_PIN_OFFSET      0x10</span>
<span class="cp">#define QUERY_ADAPTER_VSD_OFFSET           0x20</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">outbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_QUERY_ADAPTER</span><span class="p">,</span>
			    <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>
			  <span class="n">QUERY_ADAPTER_VENDOR_ID_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>
			  <span class="n">QUERY_ADAPTER_DEVICE_ID_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">revision_id</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>
			  <span class="n">QUERY_ADAPTER_REVISION_ID_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">MTHCA_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">inta_pin</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span>    <span class="n">QUERY_ADAPTER_INTA_PIN_OFFSET</span><span class="p">);</span>

	<span class="n">get_board_id</span><span class="p">(</span><span class="n">outbox</span> <span class="o">+</span> <span class="n">QUERY_ADAPTER_VSD_OFFSET</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
		     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_INIT_HCA</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">mthca_init_hca_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">inbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#define INIT_HCA_IN_SIZE             	 0x200</span>
<span class="cp">#define INIT_HCA_FLAGS1_OFFSET           0x00c</span>
<span class="cp">#define INIT_HCA_FLAGS2_OFFSET           0x014</span>
<span class="cp">#define INIT_HCA_QPC_OFFSET          	 0x020</span>
<span class="cp">#define  INIT_HCA_QPC_BASE_OFFSET    	 (INIT_HCA_QPC_OFFSET + 0x10)</span>
<span class="cp">#define  INIT_HCA_LOG_QP_OFFSET      	 (INIT_HCA_QPC_OFFSET + 0x17)</span>
<span class="cp">#define  INIT_HCA_EEC_BASE_OFFSET    	 (INIT_HCA_QPC_OFFSET + 0x20)</span>
<span class="cp">#define  INIT_HCA_LOG_EEC_OFFSET     	 (INIT_HCA_QPC_OFFSET + 0x27)</span>
<span class="cp">#define  INIT_HCA_SRQC_BASE_OFFSET   	 (INIT_HCA_QPC_OFFSET + 0x28)</span>
<span class="cp">#define  INIT_HCA_LOG_SRQ_OFFSET     	 (INIT_HCA_QPC_OFFSET + 0x2f)</span>
<span class="cp">#define  INIT_HCA_CQC_BASE_OFFSET    	 (INIT_HCA_QPC_OFFSET + 0x30)</span>
<span class="cp">#define  INIT_HCA_LOG_CQ_OFFSET      	 (INIT_HCA_QPC_OFFSET + 0x37)</span>
<span class="cp">#define  INIT_HCA_EQPC_BASE_OFFSET   	 (INIT_HCA_QPC_OFFSET + 0x40)</span>
<span class="cp">#define  INIT_HCA_EEEC_BASE_OFFSET   	 (INIT_HCA_QPC_OFFSET + 0x50)</span>
<span class="cp">#define  INIT_HCA_EQC_BASE_OFFSET    	 (INIT_HCA_QPC_OFFSET + 0x60)</span>
<span class="cp">#define  INIT_HCA_LOG_EQ_OFFSET      	 (INIT_HCA_QPC_OFFSET + 0x67)</span>
<span class="cp">#define  INIT_HCA_RDB_BASE_OFFSET    	 (INIT_HCA_QPC_OFFSET + 0x70)</span>
<span class="cp">#define INIT_HCA_UDAV_OFFSET         	 0x0b0</span>
<span class="cp">#define  INIT_HCA_UDAV_LKEY_OFFSET   	 (INIT_HCA_UDAV_OFFSET + 0x0)</span>
<span class="cp">#define  INIT_HCA_UDAV_PD_OFFSET     	 (INIT_HCA_UDAV_OFFSET + 0x4)</span>
<span class="cp">#define INIT_HCA_MCAST_OFFSET        	 0x0c0</span>
<span class="cp">#define  INIT_HCA_MC_BASE_OFFSET         (INIT_HCA_MCAST_OFFSET + 0x00)</span>
<span class="cp">#define  INIT_HCA_LOG_MC_ENTRY_SZ_OFFSET (INIT_HCA_MCAST_OFFSET + 0x12)</span>
<span class="cp">#define  INIT_HCA_MC_HASH_SZ_OFFSET      (INIT_HCA_MCAST_OFFSET + 0x16)</span>
<span class="cp">#define  INIT_HCA_LOG_MC_TABLE_SZ_OFFSET (INIT_HCA_MCAST_OFFSET + 0x1b)</span>
<span class="cp">#define INIT_HCA_TPT_OFFSET              0x0f0</span>
<span class="cp">#define  INIT_HCA_MPT_BASE_OFFSET        (INIT_HCA_TPT_OFFSET + 0x00)</span>
<span class="cp">#define  INIT_HCA_MTT_SEG_SZ_OFFSET      (INIT_HCA_TPT_OFFSET + 0x09)</span>
<span class="cp">#define  INIT_HCA_LOG_MPT_SZ_OFFSET      (INIT_HCA_TPT_OFFSET + 0x0b)</span>
<span class="cp">#define  INIT_HCA_MTT_BASE_OFFSET        (INIT_HCA_TPT_OFFSET + 0x10)</span>
<span class="cp">#define INIT_HCA_UAR_OFFSET              0x120</span>
<span class="cp">#define  INIT_HCA_UAR_BASE_OFFSET        (INIT_HCA_UAR_OFFSET + 0x00)</span>
<span class="cp">#define  INIT_HCA_UARC_SZ_OFFSET         (INIT_HCA_UAR_OFFSET + 0x09)</span>
<span class="cp">#define  INIT_HCA_LOG_UAR_SZ_OFFSET      (INIT_HCA_UAR_OFFSET + 0x0a)</span>
<span class="cp">#define  INIT_HCA_UAR_PAGE_SZ_OFFSET     (INIT_HCA_UAR_OFFSET + 0x0b)</span>
<span class="cp">#define  INIT_HCA_UAR_SCATCH_BASE_OFFSET (INIT_HCA_UAR_OFFSET + 0x10)</span>
<span class="cp">#define  INIT_HCA_UAR_CTX_BASE_OFFSET    (INIT_HCA_UAR_OFFSET + 0x18)</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">inbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INIT_HCA_IN_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SINAI_OPT</span><span class="p">)</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">INIT_HCA_FLAGS1_OFFSET</span><span class="p">);</span>

<span class="cp">#if defined(__LITTLE_ENDIAN)</span>
	<span class="o">*</span><span class="p">(</span><span class="n">inbox</span> <span class="o">+</span> <span class="n">INIT_HCA_FLAGS2_OFFSET</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#elif defined(__BIG_ENDIAN)</span>
	<span class="o">*</span><span class="p">(</span><span class="n">inbox</span> <span class="o">+</span> <span class="n">INIT_HCA_FLAGS2_OFFSET</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#error Host endianness not defined</span>
<span class="cp">#endif</span>
	<span class="cm">/* Check port for UD address vector: */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">inbox</span> <span class="o">+</span> <span class="n">INIT_HCA_FLAGS2_OFFSET</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable IPoIB checksumming if we can: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">&amp;</span> <span class="n">IB_DEVICE_UD_IP_CSUM</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">inbox</span> <span class="o">+</span> <span class="n">INIT_HCA_FLAGS2_OFFSET</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* We leave wqe_quota, responder_exu, etc as 0 (default) */</span>

	<span class="cm">/* QPC/EEC/CQC/EQC/RDB attributes */</span>

	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">qpc_base</span><span class="p">,</span>     <span class="n">INIT_HCA_QPC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_num_qps</span><span class="p">,</span>  <span class="n">INIT_HCA_LOG_QP_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">eec_base</span><span class="p">,</span>     <span class="n">INIT_HCA_EEC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_num_eecs</span><span class="p">,</span> <span class="n">INIT_HCA_LOG_EEC_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">srqc_base</span><span class="p">,</span>    <span class="n">INIT_HCA_SRQC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_num_srqs</span><span class="p">,</span> <span class="n">INIT_HCA_LOG_SRQ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">cqc_base</span><span class="p">,</span>     <span class="n">INIT_HCA_CQC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_num_cqs</span><span class="p">,</span>  <span class="n">INIT_HCA_LOG_CQ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">eqpc_base</span><span class="p">,</span>    <span class="n">INIT_HCA_EQPC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">eeec_base</span><span class="p">,</span>    <span class="n">INIT_HCA_EEEC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">eqc_base</span><span class="p">,</span>     <span class="n">INIT_HCA_EQC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_num_eqs</span><span class="p">,</span>  <span class="n">INIT_HCA_LOG_EQ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">rdb_base</span><span class="p">,</span>     <span class="n">INIT_HCA_RDB_BASE_OFFSET</span><span class="p">);</span>

	<span class="cm">/* UD AV attributes */</span>

	<span class="cm">/* multicast attributes */</span>

	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">mc_base</span><span class="p">,</span>         <span class="n">INIT_HCA_MC_BASE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_mc_entry_sz</span><span class="p">,</span> <span class="n">INIT_HCA_LOG_MC_ENTRY_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">mc_hash_sz</span><span class="p">,</span>      <span class="n">INIT_HCA_MC_HASH_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_mc_table_sz</span><span class="p">,</span> <span class="n">INIT_HCA_LOG_MC_TABLE_SZ_OFFSET</span><span class="p">);</span>

	<span class="cm">/* TPT attributes */</span>

	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">mpt_base</span><span class="p">,</span>   <span class="n">INIT_HCA_MPT_BASE_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">mtt_seg_sz</span><span class="p">,</span> <span class="n">INIT_HCA_MTT_SEG_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_mpt_sz</span><span class="p">,</span> <span class="n">INIT_HCA_LOG_MPT_SZ_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">mtt_base</span><span class="p">,</span>   <span class="n">INIT_HCA_MTT_BASE_OFFSET</span><span class="p">);</span>

	<span class="cm">/* UAR attributes */</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">uar_page_sz</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">uar_page_sz</span><span class="p">,</span> <span class="n">INIT_HCA_UAR_PAGE_SZ_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">uar_scratch_base</span><span class="p">,</span> <span class="n">INIT_HCA_UAR_SCATCH_BASE_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_uarc_sz</span><span class="p">,</span> <span class="n">INIT_HCA_UARC_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">log_uar_sz</span><span class="p">,</span>  <span class="n">INIT_HCA_LOG_UAR_SZ_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">uarc_base</span><span class="p">,</span>   <span class="n">INIT_HCA_UAR_CTX_BASE_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">CMD_INIT_HCA</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_D</span><span class="p">);</span>

	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_INIT_IB</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">mthca_init_ib_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">inbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#define INIT_IB_IN_SIZE          56</span>
<span class="cp">#define INIT_IB_FLAGS_OFFSET     0x00</span>
<span class="cp">#define INIT_IB_FLAG_SIG         (1 &lt;&lt; 18)</span>
<span class="cp">#define INIT_IB_FLAG_NG          (1 &lt;&lt; 17)</span>
<span class="cp">#define INIT_IB_FLAG_G0          (1 &lt;&lt; 16)</span>
<span class="cp">#define INIT_IB_VL_SHIFT         4</span>
<span class="cp">#define INIT_IB_PORT_WIDTH_SHIFT 8</span>
<span class="cp">#define INIT_IB_MTU_SHIFT        12</span>
<span class="cp">#define INIT_IB_MAX_GID_OFFSET   0x06</span>
<span class="cp">#define INIT_IB_MAX_PKEY_OFFSET  0x0a</span>
<span class="cp">#define INIT_IB_GUID0_OFFSET     0x10</span>
<span class="cp">#define INIT_IB_NODE_GUID_OFFSET 0x18</span>
<span class="cp">#define INIT_IB_SI_GUID_OFFSET   0x20</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">inbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INIT_IB_IN_SIZE</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">set_guid0</span>     <span class="o">?</span> <span class="n">INIT_IB_FLAG_G0</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">set_node_guid</span> <span class="o">?</span> <span class="n">INIT_IB_FLAG_NG</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">set_si_guid</span>   <span class="o">?</span> <span class="n">INIT_IB_FLAG_SIG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">vl_cap</span> <span class="o">&lt;&lt;</span> <span class="n">INIT_IB_VL_SHIFT</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">port_width</span> <span class="o">&lt;&lt;</span> <span class="n">INIT_IB_PORT_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">mtu_cap</span> <span class="o">&lt;&lt;</span> <span class="n">INIT_IB_MTU_SHIFT</span><span class="p">;</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">INIT_IB_FLAGS_OFFSET</span><span class="p">);</span>

	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">gid_cap</span><span class="p">,</span>   <span class="n">INIT_IB_MAX_GID_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">pkey_cap</span><span class="p">,</span>  <span class="n">INIT_IB_MAX_PKEY_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">guid0</span><span class="p">,</span>     <span class="n">INIT_IB_GUID0_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">node_guid</span><span class="p">,</span> <span class="n">INIT_IB_NODE_GUID_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">si_guid</span><span class="p">,</span>   <span class="n">INIT_IB_SI_GUID_OFFSET</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_INIT_IB</span><span class="p">,</span>
			<span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_CLOSE_IB</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_CLOSE_IB</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_CLOSE_HCA</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">panic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">panic</span><span class="p">,</span> <span class="n">CMD_CLOSE_HCA</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SET_IB</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_set_ib_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">inbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define SET_IB_IN_SIZE         0x40</span>
<span class="cp">#define SET_IB_FLAGS_OFFSET    0x00</span>
<span class="cp">#define SET_IB_FLAG_SIG        (1 &lt;&lt; 18)</span>
<span class="cp">#define SET_IB_FLAG_RQK        (1 &lt;&lt;  0)</span>
<span class="cp">#define SET_IB_CAP_MASK_OFFSET 0x04</span>
<span class="cp">#define SET_IB_SI_GUID_OFFSET  0x08</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">inbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SET_IB_IN_SIZE</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">set_si_guid</span>     <span class="o">?</span> <span class="n">SET_IB_FLAG_SIG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reset_qkey_viol</span> <span class="o">?</span> <span class="n">SET_IB_FLAG_RQK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">SET_IB_FLAGS_OFFSET</span><span class="p">);</span>

	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">,</span> <span class="n">SET_IB_CAP_MASK_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">si_guid</span><span class="p">,</span>  <span class="n">SET_IB_SI_GUID_OFFSET</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SET_IB</span><span class="p">,</span>
			<span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>

	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MAP_ICM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_icm</span> <span class="o">*</span><span class="n">icm</span><span class="p">,</span> <span class="n">u64</span> <span class="n">virt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_map_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD_MAP_ICM</span><span class="p">,</span> <span class="n">icm</span><span class="p">,</span> <span class="n">virt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MAP_ICM_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">virt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">inbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">inbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">inbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">virt</span><span class="p">);</span>
	<span class="n">inbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_MAP_ICM</span><span class="p">,</span>
			<span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>

	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped page at %llx to %llx for ICM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">virt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_UNMAP_ICM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">virt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">page_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unmapping %d pages at %llx from ICM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">page_count</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">virt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">virt</span><span class="p">,</span> <span class="n">page_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">CMD_UNMAP_ICM</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MAP_ICM_AUX</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_icm</span> <span class="o">*</span><span class="n">icm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_map_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD_MAP_ICM_AUX</span><span class="p">,</span> <span class="n">icm</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_UNMAP_ICM_AUX</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_UNMAP_ICM_AUX</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SET_ICM_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">icm_size</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">aux_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">mthca_cmd_imm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">icm_size</span><span class="p">,</span> <span class="n">aux_pages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SET_ICM_SIZE</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Round up number of system pages needed in case</span>
<span class="cm">	 * MTHCA_ICM_PAGE_SIZE &lt; PAGE_SIZE.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">aux_pages</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">aux_pages</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">MTHCA_ICM_PAGE_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="n">MTHCA_ICM_PAGE_SHIFT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SW2HW_MPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">mpt_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">mpt_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SW2HW_MPT</span><span class="p">,</span>
			 <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_HW2SW_MPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">mpt_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span> <span class="o">?</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mpt_index</span><span class="p">,</span>
			     <span class="o">!</span><span class="n">mailbox</span><span class="p">,</span> <span class="n">CMD_HW2SW_MPT</span><span class="p">,</span>
			     <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_WRITE_MTT</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">num_mtt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">num_mtt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_WRITE_MTT</span><span class="p">,</span>
			 <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SYNC_TPT</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SYNC_TPT</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MAP_EQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">event_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unmap</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">eq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s mask %016llx for eqn %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">unmap</span> <span class="o">?</span> <span class="s">&quot;Clearing&quot;</span> <span class="o">:</span> <span class="s">&quot;Setting&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">event_mask</span><span class="p">,</span> <span class="n">eq_num</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">event_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">unmap</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="n">eq_num</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_MAP_EQ</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SW2HW_EQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">eq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">eq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SW2HW_EQ</span><span class="p">,</span>
			 <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_HW2SW_EQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">eq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">eq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">CMD_HW2SW_EQ</span><span class="p">,</span>
			     <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SW2HW_CQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">cq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">cq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SW2HW_CQ</span><span class="p">,</span>
			<span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_HW2SW_CQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">cq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">cq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">CMD_HW2SW_CQ</span><span class="p">,</span>
			     <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_RESIZE_CQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cq_num</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lkey</span><span class="p">,</span> <span class="n">u8</span> <span class="n">log_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">inbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#define RESIZE_CQ_IN_SIZE		0x40</span>
<span class="cp">#define RESIZE_CQ_LOG_SIZE_OFFSET	0x0c</span>
<span class="cp">#define RESIZE_CQ_LKEY_OFFSET		0x1c</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="n">inbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RESIZE_CQ_IN_SIZE</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Leave start address fields zeroed out -- mthca assumes that</span>
<span class="cm">	 * MRs for CQs always start at virtual address 0.</span>
<span class="cm">	 */</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">log_size</span><span class="p">,</span> <span class="n">RESIZE_CQ_LOG_SIZE_OFFSET</span><span class="p">);</span>
	<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">lkey</span><span class="p">,</span>     <span class="n">RESIZE_CQ_LKEY_OFFSET</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">cq_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CMD_RESIZE_CQ</span><span class="p">,</span>
			<span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>

	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_SW2HW_SRQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">srq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">srq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_SW2HW_SRQ</span><span class="p">,</span>
			<span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_HW2SW_SRQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">srq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">srq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">CMD_HW2SW_SRQ</span><span class="p">,</span>
			     <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_QUERY_SRQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">CMD_QUERY_SRQ</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_ARM_SRQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">srq_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">srq_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_ARM_SRQ</span><span class="p">,</span>
			 <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MODIFY_QP</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">cur</span><span class="p">,</span>
		    <span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">next</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_ee</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span> <span class="n">u32</span> <span class="n">optmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">op</span><span class="p">[</span><span class="n">IB_QPS_ERR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">IB_QPS_ERR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_INIT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_RST2INIT_QPEE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[</span><span class="n">IB_QPS_INIT</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_INIT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_INIT2INIT_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_RTR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_INIT2RTR_QPEE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[</span><span class="n">IB_QPS_RTR</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_RTS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_RTR2RTS_QPEE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[</span><span class="n">IB_QPS_RTS</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_RTS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_RTS2RTS_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_SQD</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_RTS2SQD_QPEE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[</span><span class="n">IB_QPS_SQD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_RTS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_SQD2RTS_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_SQD</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_SQD2SQD_QPEE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[</span><span class="n">IB_QPS_SQE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_RTS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_SQERR2RTS_QPEE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">IB_QPS_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">,</span>
			<span class="p">[</span><span class="n">IB_QPS_ERR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">CMD_2ERR_QPEE</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">u8</span> <span class="n">op_mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">my_mailbox</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="n">next</span><span class="p">]</span> <span class="o">==</span> <span class="n">CMD_ERR2RST_QPEE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op_mod</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* don&#39;t write outbox, any-&gt;reset */</span>

		<span class="cm">/* For debugging */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mailbox</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">my_mailbox</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">op_mod</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* write outbox, any-&gt;reset */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">mailbox</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span> <span class="o">?</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="o">!!</span><span class="n">is_ee</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">num</span><span class="p">,</span> <span class="n">op_mod</span><span class="p">,</span>
				    <span class="n">op</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="n">next</span><span class="p">],</span> <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mailbox</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dumping QP context:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[%02x] &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x&quot;</span><span class="p">,</span>
				       <span class="n">be32_to_cpu</span><span class="p">(((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">my_mailbox</span><span class="p">)</span>
			<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dumping QP context:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  opt param mask: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  [%02x] &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x&quot;</span><span class="p">,</span>
				       <span class="n">be32_to_cpu</span><span class="p">(((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">optmask</span> <span class="o">|</span> <span class="p">(</span><span class="o">!!</span><span class="n">is_ee</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">num</span><span class="p">,</span>
				<span class="n">op_mod</span><span class="p">,</span> <span class="n">op</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="n">next</span><span class="p">],</span> <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_QUERY_QP</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_ee</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="p">(</span><span class="o">!!</span><span class="n">is_ee</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">CMD_QUERY_QPEE</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_CONF_SPECIAL_QP</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">op_mod</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_QPT_SMI</span>:
		<span class="n">op_mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPT_GSI</span>:
		<span class="n">op_mod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPT_RAW_IPV6</span>:
		<span class="n">op_mod</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPT_RAW_ETHERTYPE</span>:
		<span class="n">op_mod</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qpn</span><span class="p">,</span> <span class="n">op_mod</span><span class="p">,</span> <span class="n">CMD_CONF_SPECIAL_QP</span><span class="p">,</span>
			 <span class="n">CMD_TIME_CLASS_B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MAD_IFC</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_mkey</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_bkey</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">in_wc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_grh</span> <span class="o">*</span><span class="n">in_grh</span><span class="p">,</span>
		  <span class="kt">void</span> <span class="o">*</span><span class="n">in_mad</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">response_mad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">inmailbox</span><span class="p">,</span> <span class="o">*</span><span class="n">outmailbox</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">inbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">in_modifier</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op_modifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define MAD_IFC_BOX_SIZE      0x400</span>
<span class="cp">#define MAD_IFC_MY_QPN_OFFSET 0x100</span>
<span class="cp">#define MAD_IFC_RQPN_OFFSET   0x108</span>
<span class="cp">#define MAD_IFC_SL_OFFSET     0x10c</span>
<span class="cp">#define MAD_IFC_G_PATH_OFFSET 0x10d</span>
<span class="cp">#define MAD_IFC_RLID_OFFSET   0x10e</span>
<span class="cp">#define MAD_IFC_PKEY_OFFSET   0x112</span>
<span class="cp">#define MAD_IFC_GRH_OFFSET    0x140</span>

	<span class="n">inmailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inmailbox</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">inmailbox</span><span class="p">);</span>
	<span class="n">inbox</span> <span class="o">=</span> <span class="n">inmailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">outmailbox</span> <span class="o">=</span> <span class="n">mthca_alloc_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">outmailbox</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">inmailbox</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">outmailbox</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">in_mad</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Key check traps can&#39;t be generated unless we have in_wc to</span>
<span class="cm">	 * tell us where to send the trap.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_mkey</span> <span class="o">||</span> <span class="o">!</span><span class="n">in_wc</span><span class="p">)</span>
		<span class="n">op_modifier</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_bkey</span> <span class="o">||</span> <span class="o">!</span><span class="n">in_wc</span><span class="p">)</span>
		<span class="n">op_modifier</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_wc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">inbox</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">qp_num</span><span class="p">,</span> <span class="n">MAD_IFC_MY_QPN_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">src_qp</span><span class="p">,</span>     <span class="n">MAD_IFC_RQPN_OFFSET</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">sl</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>               <span class="n">MAD_IFC_SL_OFFSET</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">dlid_path_bits</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">&amp;</span> <span class="n">IB_WC_GRH</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>               <span class="n">MAD_IFC_G_PATH_OFFSET</span><span class="p">);</span>

		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">slid</span><span class="p">,</span>       <span class="n">MAD_IFC_RLID_OFFSET</span><span class="p">);</span>
		<span class="n">MTHCA_PUT</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">pkey_index</span><span class="p">,</span> <span class="n">MAD_IFC_PKEY_OFFSET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_grh</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">inbox</span> <span class="o">+</span> <span class="n">MAD_IFC_GRH_OFFSET</span><span class="p">,</span> <span class="n">in_grh</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>

		<span class="n">op_modifier</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>

		<span class="n">in_modifier</span> <span class="o">|=</span> <span class="n">in_wc</span><span class="o">-&gt;</span><span class="n">slid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">inmailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">outmailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			    <span class="n">in_modifier</span><span class="p">,</span> <span class="n">op_modifier</span><span class="p">,</span>
			    <span class="n">CMD_MAD_IFC</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_C</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">response_mad</span><span class="p">,</span> <span class="n">outmailbox</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">inmailbox</span><span class="p">);</span>
	<span class="n">mthca_free_mailbox</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">outmailbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_READ_MGM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">CMD_READ_MGM</span><span class="p">,</span> <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_WRITE_MGM</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_WRITE_MGM</span><span class="p">,</span>
			 <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_MGID_HASH</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">,</span>
		    <span class="n">u16</span> <span class="o">*</span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">imm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_imm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_MGID_HASH</span><span class="p">,</span>
			    <span class="n">CMD_TIME_CLASS_A</span><span class="p">);</span>

	<span class="o">*</span><span class="n">hash</span> <span class="o">=</span> <span class="n">imm</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mthca_NOP</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mthca_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMD_NOP</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
