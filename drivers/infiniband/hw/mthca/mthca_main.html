<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › mthca › mthca_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mthca_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2005 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &quot;mthca_dev.h&quot;</span>
<span class="cp">#include &quot;mthca_config_reg.h&quot;</span>
<span class="cp">#include &quot;mthca_cmd.h&quot;</span>
<span class="cp">#include &quot;mthca_profile.h&quot;</span>
<span class="cp">#include &quot;mthca_memfree.h&quot;</span>
<span class="cp">#include &quot;mthca_wqe.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Roland Dreier&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Mellanox InfiniBand HCA low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INFINIBAND_MTHCA_DEBUG</span>

<span class="kt">int</span> <span class="n">mthca_debug_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">mthca_debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="s">&quot;Enable debug tracing if &gt; 0&quot;</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_INFINIBAND_MTHCA_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">msi_x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msi_x</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi_x</span><span class="p">,</span> <span class="s">&quot;attempt to use MSI-X if nonzero&quot;</span><span class="p">);</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="cp">#define msi_x (0)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tune_pci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tune_pci</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tune_pci</span><span class="p">,</span> <span class="s">&quot;increase PCI burst from the default set by BIOS if nonzero&quot;</span><span class="p">);</span>

<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mthca_device_mutex</span><span class="p">);</span>

<span class="cp">#define MTHCA_DEFAULT_NUM_QP            (1 &lt;&lt; 16)</span>
<span class="cp">#define MTHCA_DEFAULT_RDB_PER_QP        (1 &lt;&lt; 2)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_CQ            (1 &lt;&lt; 16)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_MCG           (1 &lt;&lt; 13)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_MPT           (1 &lt;&lt; 17)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_MTT           (1 &lt;&lt; 20)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_UDAV          (1 &lt;&lt; 15)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_RESERVED_MTTS (1 &lt;&lt; 18)</span>
<span class="cp">#define MTHCA_DEFAULT_NUM_UARC_SIZE     (1 &lt;&lt; 18)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mthca_profile</span> <span class="n">hca_profile</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_qp</span>             <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_QP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rdb_per_qp</span>         <span class="o">=</span> <span class="n">MTHCA_DEFAULT_RDB_PER_QP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_cq</span>             <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_CQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_mcg</span>            <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_MCG</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_mpt</span>            <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_MPT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_mtt</span>            <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_MTT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_udav</span>           <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_UDAV</span><span class="p">,</span>          <span class="cm">/* Tavor only */</span>
	<span class="p">.</span><span class="n">fmr_reserved_mtts</span>  <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_RESERVED_MTTS</span><span class="p">,</span> <span class="cm">/* Tavor only */</span>
	<span class="p">.</span><span class="n">uarc_size</span>          <span class="o">=</span> <span class="n">MTHCA_DEFAULT_NUM_UARC_SIZE</span><span class="p">,</span>     <span class="cm">/* Arbel only */</span>
<span class="p">};</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_qp</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_qp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_qp</span><span class="p">,</span> <span class="s">&quot;maximum number of QPs per HCA&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">rdb_per_qp</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">rdb_per_qp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rdb_per_qp</span><span class="p">,</span> <span class="s">&quot;number of RDB buffers per QP&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_cq</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_cq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_cq</span><span class="p">,</span> <span class="s">&quot;maximum number of CQs per HCA&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_mcg</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_mcg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_mcg</span><span class="p">,</span> <span class="s">&quot;maximum number of multicast groups per HCA&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_mpt</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_mpt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_mpt</span><span class="p">,</span>
		<span class="s">&quot;maximum number of memory protection table entries per HCA&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_mtt</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_mtt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_mtt</span><span class="p">,</span>
		 <span class="s">&quot;maximum number of memory translation table segments per HCA&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_udav</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_udav</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_udav</span><span class="p">,</span> <span class="s">&quot;maximum number of UD address vectors per HCA&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">fmr_reserved_mtts</span><span class="p">,</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">fmr_reserved_mtts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fmr_reserved_mtts</span><span class="p">,</span>
		 <span class="s">&quot;number of memory translation table segments reserved for FMR&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">log_mtts_per_seg</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">MTHCA_MTT_SEG_SIZE</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="s">&quot;Log2 number of MTT entries per segment (1-5)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">mthca_version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
	<span class="n">DRV_NAME</span> <span class="s">&quot;: Mellanox InfiniBand HCA driver v&quot;</span>
	<span class="n">DRV_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_tune_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tune_pci</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* First try to max out Read Byte Count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcix_set_mmrbc</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcix_get_max_mmrbc</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t set PCI-X max read count, &quot;</span>
				<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_PCIE</span><span class="p">))</span>
		<span class="n">mthca_info</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;No PCI-X capability, not setting RBC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcie_set_readrq</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t write PCI Express read request, &quot;</span>
				<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_PCIE</span><span class="p">)</span>
		<span class="n">mthca_info</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;No PCI Express capability, &quot;</span>
			   <span class="s">&quot;not setting Max Read Request Size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_dev_lim</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mthca_dev_lim</span> <span class="o">*</span><span class="n">dev_lim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtt_seg_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_mtts_per_seg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_QUERY_DEV_LIM</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">dev_lim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_DEV_LIM command returned %d&quot;</span>
				<span class="s">&quot;, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">min_page_sz</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;HCA minimum page size of %d bigger than &quot;</span>
			  <span class="s">&quot;kernel PAGE_SIZE of %ld, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">min_page_sz</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">&gt;</span> <span class="n">MTHCA_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;HCA has %d ports, but we only support %d, &quot;</span>
			  <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">,</span> <span class="n">MTHCA_MAX_PORTS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">uar_size</span> <span class="o">&gt;</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;HCA reported UAR size of 0x%x bigger than &quot;</span>
			  <span class="s">&quot;PCI resource 2 size of 0x%llx, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">uar_size</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_ports</span>      	<span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">vl_cap</span>             <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_vl</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtu_cap</span>            <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">gid_table_len</span>  	<span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_gids</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pkey_table_len</span> 	<span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_pkeys</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">local_ca_ack_delay</span> <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Need to allow for worst case send WQE overhead and check</span>
<span class="cm">	 * whether max_desc_sz imposes a lower limit than max_sg; UD</span>
<span class="cm">	 * send has the biggest overhead.</span>
<span class="cm">	 */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_sg</span>		<span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_sg</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_desc_sz</span> <span class="o">-</span>
					       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mthca_next_seg</span><span class="p">)</span> <span class="o">-</span>
					       <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">?</span>
						<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mthca_arbel_ud_seg</span><span class="p">)</span> <span class="o">:</span>
						<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mthca_tavor_ud_seg</span><span class="p">)))</span> <span class="o">/</span>
						<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mthca_data_seg</span><span class="p">));</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_wqes</span>           <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_qp_sz</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_qp_init_rdma</span>   <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_requester_per_qp</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_qps</span>       <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_qps</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_srq_wqes</span>       <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_srq_sz</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_srqs</span>      <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_srqs</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_eecs</span>      <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_eecs</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_desc_sz</span>        <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_desc_sz</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_srq_sge</span>	<span class="o">=</span> <span class="n">mthca_max_srq_sge</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Subtract 1 from the limit because we need to allocate a</span>
<span class="cm">	 * spare CQE so the HCA HW can tell the difference between an</span>
<span class="cm">	 * empty CQ and a full CQ.</span>
<span class="cm">	 */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">max_cqes</span>           <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_cq_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_cqs</span>       <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_cqs</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_eqs</span>       <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_eqs</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_mtts</span>      <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mtts</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_mrws</span>      <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_mrws</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_uars</span>      <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_uars</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_pds</span>       <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">reserved_pds</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">port_width_cap</span>     <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">max_port_width</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">page_size_cap</span>      <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">min_page_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">flags</span>              <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * For old FW that doesn&#39;t return static rate support, use a</span>
<span class="cm">	 * value of 0x3 (only static rate values of 0 or 1 are handled),</span>
<span class="cm">	 * except on Sinai, where even old FW can handle static rate</span>
<span class="cm">	 * values of 2 and 3.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">stat_rate_support</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">stat_rate_support</span> <span class="o">=</span> <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">stat_rate_support</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SINAI_OPT</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">stat_rate_support</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">stat_rate_support</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="cm">/* IB_DEVICE_RESIZE_MAX_WR not supported by driver.</span>
<span class="cm">	   May be doable since hardware supports it for SRQ.</span>

<span class="cm">	   IB_DEVICE_N_NOTIFY_CQ is supported by hardware but not by driver.</span>

<span class="cm">	   IB_DEVICE_SRQ_RESIZE is supported by hardware but SRQ is not</span>
<span class="cm">	   supported by driver. */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">=</span> <span class="n">IB_DEVICE_CHANGE_PHY_PORT</span> <span class="o">|</span>
		<span class="n">IB_DEVICE_PORT_ACTIVE_EVENT</span> <span class="o">|</span>
		<span class="n">IB_DEVICE_SYS_IMAGE_GUID</span> <span class="o">|</span>
		<span class="n">IB_DEVICE_RC_RNR_NAK_GEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_BAD_PKEY_CNTR</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_BAD_PKEY_CNTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_BAD_QKEY_CNTR</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_BAD_QKEY_CNTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_RAW_MULTI</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_RAW_MULTI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_AUTO_PATH_MIG</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_AUTO_PATH_MIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_UD_AV_PORT_ENFORCE</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_UD_AV_PORT_ENFORCE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_SRQ</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">|=</span> <span class="n">MTHCA_FLAG_SRQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_LIM_FLAG_IPOIB_CSUM</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_UD_IP_CSUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_init_tavor</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_dev_lim</span>        <span class="n">dev_lim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_profile</span>        <span class="n">profile</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_init_hca_param</span> <span class="n">init_hca</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_SYS_EN</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;SYS_EN command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_QUERY_FW</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_FW command returned %d,&quot;</span>
				<span class="s">&quot; aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_QUERY_DDR</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_DDR command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_dev_lim</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_lim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_DEV_LIM command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">profile</span> <span class="o">=</span> <span class="n">hca_profile</span><span class="p">;</span>
	<span class="n">profile</span><span class="p">.</span><span class="n">num_uar</span>   <span class="o">=</span> <span class="n">dev_lim</span><span class="p">.</span><span class="n">uar_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">profile</span><span class="p">.</span><span class="n">uarc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SRQ</span><span class="p">)</span>
		<span class="n">profile</span><span class="p">.</span><span class="n">num_srq</span> <span class="o">=</span> <span class="n">dev_lim</span><span class="p">.</span><span class="n">max_srqs</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">mthca_make_profile</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_lim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_INIT_HCA</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;INIT_HCA command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_disable:</span>
	<span class="n">mthca_SYS_DIS</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* FIXME: use HCA-attached memory for FW if present */</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_icm</span> <span class="o">=</span>
		<span class="n">mthca_alloc_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_pages</span><span class="p">,</span>
				<span class="n">GFP_HIGHUSER</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate FW area, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_MAP_FA</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;MAP_FA command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_RUN_FW</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;RUN_FW command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_fa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap_fa:</span>
	<span class="n">mthca_UNMAP_FA</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_free:</span>
	<span class="n">mthca_free_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_init_icm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mthca_dev_lim</span> <span class="o">*</span><span class="n">dev_lim</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mthca_init_hca_param</span> <span class="o">*</span><span class="n">init_hca</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">icm_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">aux_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_SET_ICM_SIZE</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">icm_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aux_pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;SET_ICM_SIZE command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;%lld KB of HCA context requires %lld KB aux memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">icm_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aux_pages</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">aux_icm</span> <span class="o">=</span> <span class="n">mthca_alloc_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">aux_pages</span><span class="p">,</span>
						 <span class="n">GFP_HIGHUSER</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate aux memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_MAP_ICM_AUX</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;MAP_ICM_AUX returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_aux</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_map_eq_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">eqc_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map EQ context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_aux</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CPU writes to non-reserved MTTs, while HCA might DMA to reserved mtts */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_mtts</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_mtts</span> <span class="o">*</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtt_seg_size</span><span class="p">,</span>
					   <span class="n">dma_get_cache_alignment</span><span class="p">())</span> <span class="o">/</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtt_seg_size</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">mtt_base</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">mtt_seg_size</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_mtt_segs</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_mtts</span><span class="p">,</span>
							 <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map MTT context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_eq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mpt_table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">mpt_base</span><span class="p">,</span>
							 <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">mpt_entry_sz</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_mpts</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_mrws</span><span class="p">,</span>
							 <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mpt_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map MPT context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_mtt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">qpc_base</span><span class="p">,</span>
							<span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">qpc_entry_sz</span><span class="p">,</span>
							<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
							<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_qps</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map QP context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_mpt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">eqp_table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">eqpc_base</span><span class="p">,</span>
							 <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">eqpc_entry_sz</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_qps</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_qps</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">eqp_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map EQP context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_qp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdb_table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">rdb_base</span><span class="p">,</span>
							 <span class="n">MTHCA_RDB_ENTRY_SIZE</span><span class="p">,</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_qps</span> <span class="o">&lt;&lt;</span>
							 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdb_shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdb_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map RDB context memory, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_eqp</span><span class="p">;</span>
	<span class="p">}</span>

       <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">cqc_base</span><span class="p">,</span>
						    <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">cqc_entry_sz</span><span class="p">,</span>
						    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">,</span>
						    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_cqs</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map CQ context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_rdb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span> <span class="o">=</span>
			<span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">srqc_base</span><span class="p">,</span>
					      <span class="n">dev_lim</span><span class="o">-&gt;</span><span class="n">srq_entry_sz</span><span class="p">,</span>
					      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_srqs</span><span class="p">,</span>
					      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">reserved_srqs</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map SRQ context memory, &quot;</span>
				  <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_unmap_cq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s not strictly required, but for simplicity just map the</span>
<span class="cm">	 * whole multicast group table now.  The table isn&#39;t very big</span>
<span class="cm">	 * and it&#39;s a lot easier than trying to track ref counts.</span>
<span class="cm">	 */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mcg_table</span><span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">mthca_alloc_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">init_hca</span><span class="o">-&gt;</span><span class="n">mc_base</span><span class="p">,</span>
						      <span class="n">MTHCA_MGM_ENTRY_SIZE</span><span class="p">,</span>
						      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_mgms</span> <span class="o">+</span>
						      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_amgms</span><span class="p">,</span>
						      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_mgms</span> <span class="o">+</span>
						      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_amgms</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mcg_table</span><span class="p">.</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to map MCG context memory, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_srq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap_srq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SRQ</span><span class="p">)</span>
		<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>

<span class="nl">err_unmap_cq:</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>

<span class="nl">err_unmap_rdb:</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdb_table</span><span class="p">);</span>

<span class="nl">err_unmap_eqp:</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">eqp_table</span><span class="p">);</span>

<span class="nl">err_unmap_qp:</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span><span class="p">);</span>

<span class="nl">err_unmap_mpt:</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mpt_table</span><span class="p">);</span>

<span class="nl">err_unmap_mtt:</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span><span class="p">);</span>

<span class="nl">err_unmap_eq:</span>
	<span class="n">mthca_unmap_eq_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_unmap_aux:</span>
	<span class="n">mthca_UNMAP_ICM_AUX</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_free_aux:</span>
	<span class="n">mthca_free_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mthca_free_icms</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mcg_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SRQ</span><span class="p">)</span>
		<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">srq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cq_table</span><span class="p">.</span><span class="n">table</span><span class="p">);</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">rdb_table</span><span class="p">);</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">eqp_table</span><span class="p">);</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">qp_table</span><span class="p">.</span><span class="n">qp_table</span><span class="p">);</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mpt_table</span><span class="p">);</span>
	<span class="n">mthca_free_icm_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mr_table</span><span class="p">.</span><span class="n">mtt_table</span><span class="p">);</span>
	<span class="n">mthca_unmap_eq_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">mthca_UNMAP_ICM_AUX</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_free_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">aux_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_init_arbel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_dev_lim</span>        <span class="n">dev_lim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_profile</span>        <span class="n">profile</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_init_hca_param</span> <span class="n">init_hca</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">icm_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_QUERY_FW</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_FW command failed %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_ENABLE_LAM</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;No HCA-attached memory (running in MemFree mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">|=</span> <span class="n">MTHCA_FLAG_NO_LAM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;ENABLE_LAM returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_load_fw</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Loading FW returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_dev_lim</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_lim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_DEV_LIM returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_stop_fw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">profile</span> <span class="o">=</span> <span class="n">hca_profile</span><span class="p">;</span>
	<span class="n">profile</span><span class="p">.</span><span class="n">num_uar</span>  <span class="o">=</span> <span class="n">dev_lim</span><span class="p">.</span><span class="n">uar_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">profile</span><span class="p">.</span><span class="n">num_udav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_SRQ</span><span class="p">)</span>
		<span class="n">profile</span><span class="p">.</span><span class="n">num_srq</span> <span class="o">=</span> <span class="n">dev_lim</span><span class="p">.</span><span class="n">max_srqs</span><span class="p">;</span>

	<span class="n">icm_size</span> <span class="o">=</span> <span class="n">mthca_make_profile</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_lim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icm_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">icm_size</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_stop_fw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_lim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">,</span> <span class="n">icm_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_stop_fw</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_INIT_HCA</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_hca</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;INIT_HCA command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_icm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_icm:</span>
	<span class="n">mthca_free_icms</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_stop_fw:</span>
	<span class="n">mthca_UNMAP_FA</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_free_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">err_disable:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_NO_LAM</span><span class="p">))</span>
		<span class="n">mthca_DISABLE_LAM</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mthca_close_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mthca_CLOSE_HCA</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_free_icms</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="n">mthca_UNMAP_FA</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_free_icm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">arbel</span><span class="p">.</span><span class="n">fw_icm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_NO_LAM</span><span class="p">))</span>
			<span class="n">mthca_DISABLE_LAM</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mthca_SYS_DIS</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_init_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_adapter</span> <span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_arbel</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_tavor</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_QUERY_ADAPTER</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;QUERY_ADAPTER command returned %d, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">inta_pin</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="n">inta_pin</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mthca_is_memfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rev_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="n">revision_id</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">,</span> <span class="n">adapter</span><span class="p">.</span><span class="n">board_id</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_close:</span>
	<span class="n">mthca_close_hca</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_setup_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">MTHCA_INIT_DOORBELL_LOCK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">doorbell_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_uar_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;user access region table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_uar_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate driver access region, &quot;</span>
			  <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_uar_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kar</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">.</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map kernel access region, &quot;</span>
			  <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_uar_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_pd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;protection domain table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_kar_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_mr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;memory region table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pd_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_pd_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create driver PD, &quot;</span>
			  <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mr_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;event queue table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pd_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_cmd_use_events</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to switch to event-driven &quot;</span>
			  <span class="s">&quot;firmware commands, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_eq_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_NOP</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_MSI_X</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mthca_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOP command failed to generate interrupt &quot;</span>
				   <span class="s">&quot;(IRQ %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">MTHCA_EQ_CMD</span><span class="p">].</span><span class="n">msi_x_vector</span><span class="p">);</span>
			<span class="n">mthca_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Trying again with MSI-X disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOP command failed to generate interrupt &quot;</span>
				  <span class="s">&quot;(IRQ %d), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BIOS or ACPI interrupt routing problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">err_cmd_poll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mthca_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOP command IRQ test passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_cq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;completion queue table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cmd_poll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_srq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;shared receive queue table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cq_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_qp_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;queue pair table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_srq_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_av_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;address vector table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_qp_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_mcg_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize &quot;</span>
			  <span class="s">&quot;multicast group table, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_av_table_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_av_table_free:</span>
	<span class="n">mthca_cleanup_av_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_qp_table_free:</span>
	<span class="n">mthca_cleanup_qp_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_srq_table_free:</span>
	<span class="n">mthca_cleanup_srq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_cq_table_free:</span>
	<span class="n">mthca_cleanup_cq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_cmd_poll:</span>
	<span class="n">mthca_cmd_use_polling</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_eq_table_free:</span>
	<span class="n">mthca_cleanup_eq_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_pd_free:</span>
	<span class="n">mthca_pd_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_pd</span><span class="p">);</span>

<span class="nl">err_mr_table_free:</span>
	<span class="n">mthca_cleanup_mr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_pd_table_free:</span>
	<span class="n">mthca_cleanup_pd_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_kar_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kar</span><span class="p">);</span>

<span class="nl">err_uar_free:</span>
	<span class="n">mthca_uar_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">);</span>

<span class="nl">err_uar_table_free:</span>
	<span class="n">mthca_cleanup_uar_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mthca_enable_msi_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">entries</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">entries</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">entries</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mthca_info</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Only %d MSI-X vectors available, &quot;</span>
				   <span class="s">&quot;not using MSI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">MTHCA_EQ_COMP</span> <span class="p">].</span><span class="n">msi_x_vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">MTHCA_EQ_ASYNC</span><span class="p">].</span><span class="n">msi_x_vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">.</span><span class="n">eq</span><span class="p">[</span><span class="n">MTHCA_EQ_CMD</span>  <span class="p">].</span><span class="n">msi_x_vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Types of supported HCA */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TAVOR</span><span class="p">,</span>			<span class="cm">/* MT23108                        */</span>
	<span class="n">ARBEL_COMPAT</span><span class="p">,</span>		<span class="cm">/* MT25208 in Tavor compat mode   */</span>
	<span class="n">ARBEL_NATIVE</span><span class="p">,</span>		<span class="cm">/* MT25208 with extended features */</span>
	<span class="n">SINAI</span>			<span class="cm">/* MT25204 */</span>
<span class="p">};</span>

<span class="cp">#define MTHCA_FW_VER(major, minor, subminor) \</span>
<span class="cp">	(((u64) (major) &lt;&lt; 32) | ((u64) (minor) &lt;&lt; 16) | (u64) (subminor))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">latest_fw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mthca_hca_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TAVOR</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">latest_fw</span> <span class="o">=</span> <span class="n">MTHCA_FW_VER</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="p">.</span><span class="n">flags</span>     <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">ARBEL_COMPAT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">latest_fw</span> <span class="o">=</span> <span class="n">MTHCA_FW_VER</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
			   <span class="p">.</span><span class="n">flags</span>     <span class="o">=</span> <span class="n">MTHCA_FLAG_PCIE</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">ARBEL_NATIVE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">latest_fw</span> <span class="o">=</span> <span class="n">MTHCA_FW_VER</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="p">.</span><span class="n">flags</span>     <span class="o">=</span> <span class="n">MTHCA_FLAG_MEMFREE</span> <span class="o">|</span>
					<span class="n">MTHCA_FLAG_PCIE</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SINAI</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">latest_fw</span> <span class="o">=</span> <span class="n">MTHCA_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="p">.</span><span class="n">flags</span>     <span class="o">=</span> <span class="n">MTHCA_FLAG_MEMFREE</span> <span class="o">|</span>
					<span class="n">MTHCA_FLAG_PCIE</span>    <span class="o">|</span>
					<span class="n">MTHCA_FLAG_SINAI_OPT</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__mthca_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hca_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ddr_hidden</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Initializing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device, &quot;</span>
			<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for BARs.  We expect 0: 1MB, 2: 8MB, 4: DDR (may not</span>
<span class="cm">	 * be present)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing DCS, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing UAR, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span>
		<span class="n">ddr_hidden</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot obtain PCI resources, &quot;</span>
			<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Warning: couldn&#39;t set 64-bit PCI DMA mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t set PCI DMA mask, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Warning: couldn&#39;t set 64-bit &quot;</span>
			 <span class="s">&quot;consistent PCI DMA mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t set consistent PCI DMA mask, &quot;</span>
				<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We can handle large RDMA requests, so allow larger segments. */</span>
	<span class="n">dma_set_max_seg_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">mdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ib_alloc_device</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device struct alloc failed, &quot;</span>
			<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">=</span> <span class="n">mthca_hca_table</span><span class="p">[</span><span class="n">hca_type</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddr_hidden</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">|=</span> <span class="n">MTHCA_FLAG_DDR_HIDDEN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now reset the HCA before we touch the PCI capabilities or</span>
<span class="cm">	 * attempt a firmware command, since a boot ROM may have left</span>
<span class="cm">	 * the HCA in an undefined state.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_reset</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to reset HCA, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mthca_cmd_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mthca_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;Failed to init command interface, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_tune_pci</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cmd</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_init_hca</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&lt;</span> <span class="n">mthca_hca_table</span><span class="p">[</span><span class="n">hca_type</span><span class="p">].</span><span class="n">latest_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_warn</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;HCA FW version %d.%d.%03d is old (%d.%d.%03d is current).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mthca_hca_table</span><span class="p">[</span><span class="n">hca_type</span><span class="p">].</span><span class="n">latest_fw</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mthca_hca_table</span><span class="p">[</span><span class="n">hca_type</span><span class="p">].</span><span class="n">latest_fw</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mthca_hca_table</span><span class="p">[</span><span class="n">hca_type</span><span class="p">].</span><span class="n">latest_fw</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="n">mthca_warn</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;If you have problems, try updating your HCA FW.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msi_x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mthca_enable_msi_x</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">|=</span> <span class="n">MTHCA_FLAG_MSI_X</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_setup_hca</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_MSI_X</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_MSI_X</span><span class="p">)</span>
			<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MTHCA_FLAG_MSI_X</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_setup_hca</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_register_device</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cleanup</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mthca_create_agents</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mdev</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">hca_type</span> <span class="o">=</span> <span class="n">hca_type</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unregister:</span>
	<span class="n">mthca_unregister_device</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_cleanup:</span>
	<span class="n">mthca_cleanup_mcg_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_av_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_qp_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_srq_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_cq_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cmd_use_polling</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_eq_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">mthca_pd_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">driver_pd</span><span class="p">);</span>

	<span class="n">mthca_cleanup_mr_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_pd_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mthca_cleanup_uar_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_close:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_MSI_X</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mthca_close_hca</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_cmd:</span>
	<span class="n">mthca_cmd_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="nl">err_free_dev:</span>
	<span class="n">ib_dealloc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ib_dev</span><span class="p">);</span>

<span class="nl">err_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__mthca_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_free_agents</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_unregister_device</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
			<span class="n">mthca_CLOSE_IB</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">mthca_cleanup_mcg_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cleanup_av_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cleanup_qp_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cleanup_srq_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cleanup_cq_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cmd_use_polling</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cleanup_eq_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="n">mthca_pd_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">driver_pd</span><span class="p">);</span>

		<span class="n">mthca_cleanup_mr_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cleanup_pd_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">kar</span><span class="p">);</span>
		<span class="n">mthca_uar_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">driver_uar</span><span class="p">);</span>
		<span class="n">mthca_cleanup_uar_table</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_close_hca</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mthca_cmd_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">mthca_flags</span> <span class="o">&amp;</span> <span class="n">MTHCA_FLAG_MSI_X</span><span class="p">)</span>
			<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="n">ib_dealloc_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ib_dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__mthca_restart_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mthca_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hca_type</span><span class="p">;</span>

	<span class="n">mdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">hca_type</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">hca_type</span><span class="p">;</span>
	<span class="n">__mthca_remove_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__mthca_init_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hca_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mthca_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_device_mutex</span><span class="p">);</span>

	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">mthca_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mthca_hca_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s has invalid driver data %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_device_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__mthca_init_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_device_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mthca_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_device_mutex</span><span class="p">);</span>
	<span class="n">__mthca_remove_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_device_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">mthca_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MELLANOX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_TAVOR</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">TAVOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOPSPIN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_TAVOR</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">TAVOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MELLANOX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_ARBEL_COMPAT</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ARBEL_COMPAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOPSPIN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_ARBEL_COMPAT</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ARBEL_COMPAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MELLANOX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_ARBEL</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ARBEL_NATIVE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOPSPIN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_ARBEL</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ARBEL_NATIVE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MELLANOX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_SINAI</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">SINAI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOPSPIN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_SINAI</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">SINAI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MELLANOX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_SINAI_OLD</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">SINAI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOPSPIN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MELLANOX_SINAI_OLD</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">SINAI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mthca_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mthca_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mthca_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mthca_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mthca_remove_one</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">__mthca_check_profile_val</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pval</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">pval_default</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* value must be positive and power of 2 */</span>
	<span class="kt">int</span> <span class="n">old_pval</span> <span class="o">=</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_pval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pval</span> <span class="o">=</span> <span class="n">pval_default</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pval</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">old_pval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_pval</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Invalid value %d for %s in module parameter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">old_pval</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Corrected %s to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">pval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define mthca_check_profile_val(name, default)				\</span>
<span class="cp">	__mthca_check_profile_val(#name, &amp;hca_profile.name, default)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mthca_validate_profile</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">num_qp</span><span class="p">,</span>            <span class="n">MTHCA_DEFAULT_NUM_QP</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">rdb_per_qp</span><span class="p">,</span>        <span class="n">MTHCA_DEFAULT_RDB_PER_QP</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">num_cq</span><span class="p">,</span>            <span class="n">MTHCA_DEFAULT_NUM_CQ</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">num_mcg</span><span class="p">,</span> 	   <span class="n">MTHCA_DEFAULT_NUM_MCG</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">num_mpt</span><span class="p">,</span> 	   <span class="n">MTHCA_DEFAULT_NUM_MPT</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">num_mtt</span><span class="p">,</span> 	   <span class="n">MTHCA_DEFAULT_NUM_MTT</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">num_udav</span><span class="p">,</span>          <span class="n">MTHCA_DEFAULT_NUM_UDAV</span><span class="p">);</span>
	<span class="n">mthca_check_profile_val</span><span class="p">(</span><span class="n">fmr_reserved_mtts</span><span class="p">,</span> <span class="n">MTHCA_DEFAULT_NUM_RESERVED_MTTS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hca_profile</span><span class="p">.</span><span class="n">fmr_reserved_mtts</span> <span class="o">&gt;=</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_mtt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Invalid fmr_reserved_mtts module parameter %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hca_profile</span><span class="p">.</span><span class="n">fmr_reserved_mtts</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;(Must be smaller than num_mtt %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_mtt</span><span class="p">);</span>
		<span class="n">hca_profile</span><span class="p">.</span><span class="n">fmr_reserved_mtts</span> <span class="o">=</span> <span class="n">hca_profile</span><span class="p">.</span><span class="n">num_mtt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Corrected fmr_reserved_mtts to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hca_profile</span><span class="p">.</span><span class="n">fmr_reserved_mtts</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">log_mtts_per_seg</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">log_mtts_per_seg</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;bad log_mtts_per_seg (%d). Using default - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">log_mtts_per_seg</span><span class="p">,</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">MTHCA_MTT_SEG_SIZE</span> <span class="o">/</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">log_mtts_per_seg</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">MTHCA_MTT_SEG_SIZE</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mthca_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mthca_validate_profile</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mthca_catas_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mthca_catas_cleanup</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mthca_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mthca_driver</span><span class="p">);</span>
	<span class="n">mthca_catas_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mthca_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mthca_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
