<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ipath › ipath_intr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ipath_intr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006, 2007, 2008 QLogic Corporation. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2003, 2004, 2005, 2006 PathScale, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &quot;ipath_kernel.h&quot;</span>
<span class="cp">#include &quot;ipath_verbs.h&quot;</span>
<span class="cp">#include &quot;ipath_common.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * Called when we might have an error that is specific to a particular</span>
<span class="cm"> * PIO buffer, and may need to cancel that buffer, so it can be re-used.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ipath_disarm_senderrbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">piobcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * it&#39;s possible that sendbuffererror could have bits set; might</span>
<span class="cm">	 * have already done this as a result of hardware error handling</span>
<span class="cm">	 */</span>
	<span class="n">piobcnt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_piobcnt4k</span><span class="p">;</span>
	<span class="cm">/* read these before writing errorclear */</span>
	<span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span>
		<span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_sendbuffererror</span><span class="p">);</span>
	<span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span>
		<span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">piobcnt</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span>
			<span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">piobcnt</span> <span class="o">&gt;</span> <span class="mi">192</span><span class="p">)</span>
		<span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span>
			<span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="n">piobcnt</span> <span class="o">&gt;</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__IPATH_PKTDBG</span><span class="o">|</span><span class="n">__IPATH_DBG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastcancel</span> <span class="o">&gt;</span> <span class="n">jiffies</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__IPATH_DBG_WHICH</span><span class="p">(</span><span class="n">__IPATH_PKTDBG</span><span class="o">|</span><span class="n">__IPATH_DBG</span><span class="p">,</span>
					  <span class="s">&quot;SendbufErrs %lx %lx&quot;</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					  <span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="n">__IPATH_PKTDBG</span> <span class="o">&amp;&amp;</span> <span class="n">piobcnt</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %lx %lx &quot;</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">piobcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">))</span>
				<span class="n">ipath_disarm_piobufs</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* ignore armlaunch errs for a bit */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastcancel</span> <span class="o">=</span> <span class="n">jiffies</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* These are all rcv-related errors which we want to count for stats */</span>
<span class="cp">#define E_SUM_PKTERRS \</span>
<span class="cp">	(INFINIPATH_E_RHDRLEN | INFINIPATH_E_RBADTID | \</span>
<span class="cp">	 INFINIPATH_E_RBADVERSION | INFINIPATH_E_RHDR | \</span>
<span class="cp">	 INFINIPATH_E_RLONGPKTLEN | INFINIPATH_E_RSHORTPKTLEN | \</span>
<span class="cp">	 INFINIPATH_E_RMAXPKTLEN | INFINIPATH_E_RMINPKTLEN | \</span>
<span class="cp">	 INFINIPATH_E_RFORMATERR | INFINIPATH_E_RUNSUPVL | \</span>
<span class="cp">	 INFINIPATH_E_RUNEXPCHAR | INFINIPATH_E_REBP)</span>

<span class="cm">/* These are all send-related errors which we want to count for stats */</span>
<span class="cp">#define E_SUM_ERRS \</span>
<span class="cp">	(INFINIPATH_E_SPIOARMLAUNCH | INFINIPATH_E_SUNEXPERRPKTNUM | \</span>
<span class="cp">	 INFINIPATH_E_SDROPPEDDATAPKT | INFINIPATH_E_SDROPPEDSMPPKT | \</span>
<span class="cp">	 INFINIPATH_E_SMAXPKTLEN | INFINIPATH_E_SUNSUPVL | \</span>
<span class="cp">	 INFINIPATH_E_SMINPKTLEN | INFINIPATH_E_SPKTLEN | \</span>
<span class="cp">	 INFINIPATH_E_INVALIDADDR)</span>

<span class="cm">/*</span>
<span class="cm"> * this is similar to E_SUM_ERRS, but can&#39;t ignore armlaunch, don&#39;t ignore</span>
<span class="cm"> * errors not related to freeze and cancelling buffers.  Can&#39;t ignore</span>
<span class="cm"> * armlaunch because could get more while still cleaning up, and need</span>
<span class="cm"> * to cancel those as they happen.</span>
<span class="cm"> */</span>
<span class="cp">#define E_SPKT_ERRS_IGNORE \</span>
<span class="cp">	 (INFINIPATH_E_SDROPPEDDATAPKT | INFINIPATH_E_SDROPPEDSMPPKT | \</span>
<span class="cp">	 INFINIPATH_E_SMAXPKTLEN | INFINIPATH_E_SMINPKTLEN | \</span>
<span class="cp">	 INFINIPATH_E_SPKTLEN)</span>

<span class="cm">/*</span>
<span class="cm"> * these are errors that can occur when the link changes state while</span>
<span class="cm"> * a packet is being sent or received.  This doesn&#39;t cover things</span>
<span class="cm"> * like EBP or VCRC that can be the result of a sending having the</span>
<span class="cm"> * link change state, so we receive a &quot;known bad&quot; packet.</span>
<span class="cm"> */</span>
<span class="cp">#define E_SUM_LINK_PKTERRS \</span>
<span class="cp">	(INFINIPATH_E_SDROPPEDDATAPKT | INFINIPATH_E_SDROPPEDSMPPKT | \</span>
<span class="cp">	 INFINIPATH_E_SMINPKTLEN | INFINIPATH_E_SPKTLEN | \</span>
<span class="cp">	 INFINIPATH_E_RSHORTPKTLEN | INFINIPATH_E_RMINPKTLEN | \</span>
<span class="cp">	 INFINIPATH_E_RUNEXPCHAR)</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">handle_e_sum_errs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">ipath_err_t</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ignore_this_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipath_disarm_senderrbufs</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can happen when SMA is trying to bring the link</span>
<span class="cm">		 * up, but the IB link changes state at the &quot;wrong&quot; time.</span>
<span class="cm">		 * The IB logic then complains that the packet isn&#39;t</span>
<span class="cm">		 * valid.  We don&#39;t want to confuse people, so we just</span>
<span class="cm">		 * don&#39;t print them, except at debug</span>
<span class="cm">		 */</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Ignoring packet errors %llx, because link not &quot;</span>
			  <span class="s">&quot;ACTIVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">errs</span><span class="p">);</span>
		<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ignore_this_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* generic hw error messages... */</span>
<span class="cp">#define INFINIPATH_HWE_TXEMEMPARITYERR_MSG(a) \</span>
<span class="cp">	{ \</span>
<span class="cp">		.mask = ( INFINIPATH_HWE_TXEMEMPARITYERR_##a &lt;&lt;    \</span>
<span class="cp">			  INFINIPATH_HWE_TXEMEMPARITYERR_SHIFT ),   \</span>
<span class="cp">		.msg = &quot;TXE &quot; #a &quot; Memory Parity&quot;	     \</span>
<span class="cp">	}</span>
<span class="cp">#define INFINIPATH_HWE_RXEMEMPARITYERR_MSG(a) \</span>
<span class="cp">	{ \</span>
<span class="cp">		.mask = ( INFINIPATH_HWE_RXEMEMPARITYERR_##a &lt;&lt;    \</span>
<span class="cp">			  INFINIPATH_HWE_RXEMEMPARITYERR_SHIFT ),   \</span>
<span class="cp">		.msg = &quot;RXE &quot; #a &quot; Memory Parity&quot;	     \</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipath_hwerror_msgs</span> <span class="n">ipath_generic_hwerror_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">IBCBUSFRSPCPARITYERR</span><span class="p">,</span> <span class="s">&quot;IPATH2IB Parity&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">IBCBUSTOSPCPARITYERR</span><span class="p">,</span> <span class="s">&quot;IB2IPATH Parity&quot;</span><span class="p">),</span>

	<span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">PIOBUF</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">PIOPBC</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">PIOLAUNCHFIFO</span><span class="p">),</span>

	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">RCVBUF</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">LOOKUPQ</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">EAGERTID</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">EXPTID</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">FLAGBUF</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">DATAINFO</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MSG</span><span class="p">(</span><span class="n">HDRINFO</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_format_hwmsg - format a single hwerror message</span>
<span class="cm"> * @msg message buffer</span>
<span class="cm"> * @msgl length of message buffer</span>
<span class="cm"> * @hwmsg message to add to message buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_format_hwmsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hwmsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">hwmsg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_format_hwerrors - format hardware error messages for display</span>
<span class="cm"> * @hwerrs hardware errors bit vector</span>
<span class="cm"> * @hwerrmsgs hardware error descriptions</span>
<span class="cm"> * @nhwerrmsgs number of hwerrmsgs</span>
<span class="cm"> * @msg message buffer</span>
<span class="cm"> * @msgl message buffer length</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ipath_format_hwerrors</span><span class="p">(</span><span class="n">u64</span> <span class="n">hwerrs</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">ipath_hwerror_msgs</span> <span class="o">*</span><span class="n">hwerrmsgs</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">nhwerrmsgs</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">glen</span> <span class="o">=</span>
	    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipath_generic_hwerror_msgs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">glen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">ipath_generic_hwerror_msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_format_hwmsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">,</span>
					   <span class="n">ipath_generic_hwerror_msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nhwerrmsgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">hwerrmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_format_hwmsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">,</span> <span class="n">hwerrmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* return the strings for the most common link states */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ib_linkstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ipath_ib_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_init</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;Init&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_arm</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;Arm&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_active</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;Active&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;Down&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">signal_ib_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_event_type</span> <span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">verbs_dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">ev</span><span class="p">;</span>
	<span class="n">ib_dispatch_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_e_ibstatuschanged</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				     <span class="n">ipath_err_t</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ltstate</span><span class="p">,</span> <span class="n">lstate</span><span class="p">,</span> <span class="n">ibstate</span><span class="p">,</span> <span class="n">lastlstate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">init</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_init</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arm</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_arm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">active</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_active</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="n">ibcs</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_ibcstatus</span><span class="p">);</span>

	<span class="n">lstate</span> <span class="o">=</span> <span class="n">ipath_ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span> <span class="cm">/* linkstate */</span>
	<span class="n">ibstate</span> <span class="o">=</span> <span class="n">ipath_ib_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>
	<span class="cm">/* linkstate at last interrupt */</span>
	<span class="n">lastlstate</span> <span class="o">=</span> <span class="n">ipath_ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastibcstat</span><span class="p">);</span>
	<span class="n">ltstate</span> <span class="o">=</span> <span class="n">ipath_ib_linktrstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span> <span class="cm">/* linktrainingtate */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since going into a recovery state causes the link state to go</span>
<span class="cm">	 * down and since recovery is transitory, it is better if we &quot;miss&quot;</span>
<span class="cm">	 * ever seeing the link training state go into recovery (i.e.,</span>
<span class="cm">	 * ignore this transition for link state special handling purposes)</span>
<span class="cm">	 * without even updating ipath_lastibcstat.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ltstate</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_RECOVERRETRAIN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ltstate</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_RECOVERWAITRMT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ltstate</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_RECOVERIDLE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if linkstate transitions into INIT from any of the various down</span>
<span class="cm">	 * states, or if it transitions from any of the up (INIT or better)</span>
<span class="cm">	 * states into any of the down states (except link recovery), then</span>
<span class="cm">	 * call the chip-specific code to take appropriate actions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">&gt;=</span> <span class="n">INFINIPATH_IBCS_L_STATE_INIT</span> <span class="o">&amp;&amp;</span>
		<span class="n">lastlstate</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_L_STATE_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* transitioned to UP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_ib_updown</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* link came up, so we must no longer be disabled */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_IB_LINK_DISABLED</span><span class="p">;</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">LINKVERB</span><span class="p">,</span> <span class="s">&quot;LinkUp handled, skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_ibchange</span><span class="p">;</span> <span class="cm">/* chip-code handled */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lastlstate</span> <span class="o">&gt;=</span> <span class="n">INFINIPATH_IBCS_L_STATE_INIT</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_IB_FORCE_NOTIFY</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">ltstate</span> <span class="o">&lt;=</span> <span class="n">INFINIPATH_IBCS_LT_STATE_CFGWAITRMT</span> <span class="o">&amp;&amp;</span>
		<span class="n">ltstate</span> <span class="o">!=</span> <span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">handled</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_ib_updown</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_IB_FORCE_NOTIFY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">LINKVERB</span><span class="p">,</span> <span class="s">&quot;LinkDown handled, skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_ibchange</span><span class="p">;</span> <span class="cm">/* chip-code handled */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Significant enough to always print and get into logs, if it was</span>
<span class="cm">	 * unexpected.  If it was a requested state change, we&#39;ll have</span>
<span class="cm">	 * already cleared the flags, so we won&#39;t print this warning</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ibstate</span> <span class="o">!=</span> <span class="n">arm</span> <span class="o">&amp;&amp;</span> <span class="n">ibstate</span> <span class="o">!=</span> <span class="n">active</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IPATH_LINKARMED</span> <span class="o">|</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link state changed from %s &quot;</span>
			 <span class="s">&quot;to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_LINKARMED</span><span class="p">)</span> <span class="o">?</span>
			 <span class="s">&quot;ARM&quot;</span> <span class="o">:</span> <span class="s">&quot;ACTIVE&quot;</span><span class="p">,</span> <span class="n">ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ltstate</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_POLLACTIVE</span> <span class="o">||</span>
	    <span class="n">ltstate</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_POLLQUIET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lastlts</span><span class="p">;</span>
		<span class="n">lastlts</span> <span class="o">=</span> <span class="n">ipath_ib_linktrstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastibcstat</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ignore cycling back and forth from Polling.Active to</span>
<span class="cm">		 * Polling.Quiet while waiting for the other end of the link</span>
<span class="cm">		 * to come up, except to try and decide if we are connected</span>
<span class="cm">		 * to a live IB device or not.  We will cycle back and</span>
<span class="cm">		 * forth between them if no cable is plugged in, the other</span>
<span class="cm">		 * device is powered off or disabled, etc.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lastlts</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_POLLACTIVE</span> <span class="o">||</span>
		    <span class="n">lastlts</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_POLLQUIET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="o">++</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ibpollcnt</span> <span class="o">==</span> <span class="mi">40</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_NOCABLE</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">|=</span>
					<span class="n">IPATH_STATUS_IB_NOCABLE</span><span class="p">;</span>
				<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">LINKVERB</span><span class="p">,</span> <span class="s">&quot;Set NOCABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">LINKVERB</span><span class="p">,</span> <span class="s">&quot;POLL change to %s (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ipath_ibcstatus_str</span><span class="p">[</span><span class="n">ltstate</span><span class="p">],</span> <span class="n">ibstate</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_ibchange</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ibpollcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not poll*, now */</span>
	<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_iblink</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibstate</span> <span class="o">!=</span> <span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastlinkrecov</span> <span class="o">&amp;&amp;</span> <span class="n">ipath_linkrecovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">linkrecov</span><span class="p">;</span>
		<span class="n">linkrecov</span> <span class="o">=</span> <span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_cregs</span><span class="o">-&gt;</span><span class="n">cr_iblinkerrrecovcnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linkrecov</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastlinkrecov</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;IB linkrecov up %Lx (%s %s) recov %Lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ibcs</span><span class="p">,</span>
				<span class="n">ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">),</span>
				<span class="n">ipath_ibcstatus_str</span><span class="p">[</span><span class="n">ltstate</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">linkrecov</span><span class="p">);</span>
			<span class="cm">/* and no more until active again */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastlinkrecov</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ipath_set_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_IB_LINKDOWN</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_ibchange</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibstate</span> <span class="o">==</span> <span class="n">init</span> <span class="o">||</span> <span class="n">ibstate</span> <span class="o">==</span> <span class="n">arm</span> <span class="o">||</span> <span class="n">ibstate</span> <span class="o">==</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_STATUS_IB_NOCABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibstate</span> <span class="o">==</span> <span class="n">init</span> <span class="o">||</span> <span class="n">ibstate</span> <span class="o">==</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_STATUS_IB_READY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">)</span>
				<span class="n">signal_ib_event</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IB_EVENT_PORT_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibstate</span> <span class="o">==</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_LINKARMED</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPATH_LINKUNK</span> <span class="o">|</span>
				<span class="n">IPATH_LINKINIT</span> <span class="o">|</span> <span class="n">IPATH_LINKDOWN</span> <span class="o">|</span>
				<span class="n">IPATH_LINKACTIVE</span> <span class="o">|</span> <span class="n">IPATH_NOCABLE</span><span class="p">);</span>
			<span class="n">ipath_hol_down</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ibstate</span> <span class="o">==</span> <span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * set INIT and DOWN.  Down is checked by</span>
<span class="cm">			 * most of the other code, but INIT is</span>
<span class="cm">			 * useful to know in a few places.</span>
<span class="cm">			 */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_LINKINIT</span> <span class="o">|</span>
				<span class="n">IPATH_LINKDOWN</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPATH_LINKUNK</span> <span class="o">|</span>
				<span class="n">IPATH_LINKARMED</span> <span class="o">|</span> <span class="n">IPATH_LINKACTIVE</span> <span class="o">|</span>
				<span class="n">IPATH_NOCABLE</span><span class="p">);</span>
			<span class="n">ipath_hol_down</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* active */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastlinkrecov</span> <span class="o">=</span> <span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_cregs</span><span class="o">-&gt;</span><span class="n">cr_iblinkerrrecovcnt</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">|=</span>
				<span class="n">IPATH_STATUS_IB_READY</span> <span class="o">|</span> <span class="n">IPATH_STATUS_IB_CONF</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPATH_LINKUNK</span> <span class="o">|</span> <span class="n">IPATH_LINKINIT</span>
				<span class="o">|</span> <span class="n">IPATH_LINKDOWN</span> <span class="o">|</span> <span class="n">IPATH_LINKARMED</span> <span class="o">|</span>
				<span class="n">IPATH_NOCABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_HAS_SEND_DMA</span><span class="p">)</span>
				<span class="n">ipath_restart_sdma</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="n">signal_ib_event</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IB_EVENT_PORT_ACTIVE</span><span class="p">);</span>
			<span class="cm">/* LED active not handled in chip _f_updown */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_setextled</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">lstate</span><span class="p">,</span> <span class="n">ltstate</span><span class="p">);</span>
			<span class="n">ipath_hol_up</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * print after we&#39;ve already done the work, so as not to</span>
<span class="cm">		 * delay the state changes and notifications, for debugging</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">lastlstate</span><span class="p">)</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">LINKVERB</span><span class="p">,</span> <span class="s">&quot;Unchanged from last: %s &quot;</span>
				<span class="s">&quot;(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">),</span> <span class="n">ibstate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Unit %u: link up to %s %s (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_unit</span><span class="p">,</span> <span class="n">ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">),</span>
				  <span class="n">ipath_ibcstatus_str</span><span class="p">[</span><span class="n">ltstate</span><span class="p">],</span>  <span class="n">ibstate</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* down */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">)</span>
			<span class="n">signal_ib_event</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IB_EVENT_PORT_ERR</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_LINKDOWN</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPATH_LINKUNK</span> <span class="o">|</span> <span class="n">IPATH_LINKINIT</span>
				     <span class="o">|</span> <span class="n">IPATH_LINKACTIVE</span> <span class="o">|</span>
				     <span class="n">IPATH_LINKARMED</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_STATUS_IB_READY</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lli_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lastlstate</span> <span class="o">!=</span> <span class="n">INFINIPATH_IBCS_L_STATE_DOWN</span><span class="p">)</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Unit %u link state down &quot;</span>
				   <span class="s">&quot;(state 0x%x), from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_unit</span><span class="p">,</span> <span class="n">lstate</span><span class="p">,</span>
				   <span class="n">ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastibcstat</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">LINKVERB</span><span class="p">,</span> <span class="s">&quot;Unit %u link state changed &quot;</span>
				   <span class="s">&quot;to %s (0x%x) from down (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_unit</span><span class="p">,</span>
				   <span class="n">ipath_ibcstatus_str</span><span class="p">[</span><span class="n">ltstate</span><span class="p">],</span>
				   <span class="n">ibstate</span><span class="p">,</span> <span class="n">lastlstate</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">skip_ibchange:</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastibcstat</span> <span class="o">=</span> <span class="n">ibcs</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_supp_msgs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">supp_msgs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msgsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Print the message unless it&#39;s ibc status change only, which</span>
<span class="cm">	 * happens so often we never want to count it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INFINIPATH_E_IBSTATUSCHANGED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">iserr</span><span class="p">;</span>
		<span class="n">ipath_err_t</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">iserr</span> <span class="o">=</span> <span class="n">ipath_decode_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span>
					 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span> <span class="o">&amp;</span>
					 <span class="o">~</span><span class="n">INFINIPATH_E_IBSTATUSCHANGED</span><span class="p">);</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="n">INFINIPATH_E_RRCVEGRFULL</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RRCVHDRFULL</span> <span class="o">|</span>
			<span class="n">INFINIPATH_E_PKTERRS</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SDMADISABLED</span><span class="p">;</span>

		<span class="cm">/* if we&#39;re in debug, then don&#39;t mask SDMADISABLED msgs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="n">__IPATH_DBG</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_E_SDMADISABLED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Suppressed %u messages for &quot;</span>
				      <span class="s">&quot;fast-repeating errors (%s) (%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">supp_msgs</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
				      <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rcvegrfull and rcvhdrqfull are &quot;normal&quot;, for some</span>
<span class="cm">			 * types of processes (mostly benchmarks) that send</span>
<span class="cm">			 * huge numbers of messages, while not processing</span>
<span class="cm">			 * them. So only complain about these at debug</span>
<span class="cm">			 * level.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iserr</span><span class="p">)</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Suppressed %u messages for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">supp_msgs</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">ERRPKT</span><span class="p">,</span>
					<span class="s">&quot;Suppressed %u messages for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">supp_msgs</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">handle_frequent_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				       <span class="n">ipath_err_t</span> <span class="n">errs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">noprint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nc</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nextmsg_time</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">nmsgs</span><span class="p">,</span> <span class="n">supp_msgs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Throttle back &quot;fast&quot; messages to no more than 10 per 5 seconds.</span>
<span class="cm">	 * This isn&#39;t perfect, but it&#39;s a reasonable heuristic. If we get</span>
<span class="cm">	 * more than 10, give a 6x longer delay.</span>
<span class="cm">	 */</span>
	<span class="n">nc</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nmsgs</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">nextmsg_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">noprint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">supp_msgs</span><span class="o">++</span><span class="p">)</span>
				<span class="n">nextmsg_time</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">supp_msgs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handle_supp_msgs</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">supp_msgs</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">);</span>
			<span class="n">supp_msgs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nmsgs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nmsgs</span><span class="o">++</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">nextmsg_time</span><span class="p">))</span>
		<span class="n">nextmsg_time</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">supp_msgs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_sdma_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">ipath_err_t</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">expected</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="n">__IPATH_DBG</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="n">ipath_decode_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">,</span> <span class="n">errs</span> <span class="o">&amp;</span>
			<span class="n">INFINIPATH_E_SDMAERRS</span><span class="p">);</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;errors %lx (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">errs</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="n">__IPATH_VERBDBG</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tl</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">lengen</span><span class="p">;</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_senddmatail</span><span class="p">);</span>
		<span class="n">hd</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_senddmahead</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span>
			<span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_senddmastatus</span><span class="p">);</span>
		<span class="n">lengen</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_senddmalengen</span><span class="p">);</span>
		<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;sdma tl 0x%lx hd 0x%lx status 0x%lx &quot;</span>
			<span class="s">&quot;lengen 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tl</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">lengen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">IPATH_SDMA_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_status</span><span class="p">);</span>
	<span class="n">expected</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">IPATH_SDMA_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_status</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expected</span><span class="p">)</span>
		<span class="n">ipath_cancel_sends</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_sdma_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">expected</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_I_SDMAINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPATH_SDMA_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_status</span><span class="p">))</span>
		<span class="n">ipath_sdma_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_I_SDMADISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">expected</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">IPATH_SDMA_ABORTING</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_status</span><span class="p">);</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;%s SDmaDisabled intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">expected</span> <span class="o">?</span> <span class="s">&quot;expected&quot;</span> <span class="o">:</span> <span class="s">&quot;unexpected&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">IPATH_SDMA_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_status</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expected</span><span class="p">)</span>
			<span class="n">ipath_cancel_sends</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPATH_SDMA_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_status</span><span class="p">))</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sdma_abort_task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_hdrq_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chkerrpkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hd</span><span class="p">,</span> <span class="n">tl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_hdrqfull</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_cfgports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipath_portdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_pd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For kernel receive queues, we just want to know</span>
<span class="cm">			 * if there are packets in the queue that we can</span>
<span class="cm">			 * process.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_head</span> <span class="o">!=</span> <span class="n">ipath_get_hdrqtail</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span>
				<span class="n">chkerrpkts</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Skip if user context is not open */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span> <span class="o">||</span> <span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_cnt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t report the same point multiple times. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_NODMA_RTAIL</span><span class="p">)</span>
			<span class="n">tl</span> <span class="o">=</span> <span class="n">ipath_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrtail</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tl</span> <span class="o">=</span> <span class="n">ipath_get_rcvhdrtail</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tl</span> <span class="o">==</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_lastrcvhdrqtail</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hd</span> <span class="o">=</span> <span class="n">ipath_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">==</span> <span class="p">(</span><span class="n">tl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">hd</span> <span class="o">&amp;&amp;</span> <span class="n">tl</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hdrqlast</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_lastrcvhdrqtail</span> <span class="o">=</span> <span class="n">tl</span><span class="p">;</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_hdrqfull</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* flush hdrqfull so that poll() sees it */</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">chkerrpkts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">ipath_err_t</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">ignore_this_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iserr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chkerrpkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">noprint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">supp_msgs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log_idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * don&#39;t report errors that are masked, either at init</span>
<span class="cm">	 * (not set in ipath_errormask), or temporarily (set in</span>
<span class="cm">	 * ipath_maskederrs)</span>
<span class="cm">	 */</span>
	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_errormask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_maskederrs</span><span class="p">;</span>

	<span class="n">supp_msgs</span> <span class="o">=</span> <span class="n">handle_frequent_errors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span> <span class="n">msg</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">noprint</span><span class="p">);</span>

	<span class="cm">/* do these first, they are most important */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_HARDWARE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reuse same msg buf */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_handle_hwerrors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">log_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">log_idx</span> <span class="o">&lt;</span> <span class="n">IPATH_EEP_LOG_CNT</span><span class="p">;</span> <span class="o">++</span><span class="n">log_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_eep_st_masks</span><span class="p">[</span><span class="n">log_idx</span><span class="p">].</span><span class="n">errs_to_log</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
				<span class="n">ipath_inc_eeprom_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">log_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_SDMAERRS</span><span class="p">)</span>
		<span class="n">handle_sdma_errors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noprint</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_e_bitsextant</span><span class="p">))</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;error interrupt with unknown errors &quot;</span>
			      <span class="s">&quot;%llx set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			      <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_e_bitsextant</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_ERRS</span><span class="p">)</span>
		<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">handle_e_sum_errs</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can happen when SMA is trying to bring the link</span>
<span class="cm">		 * up, but the IB link changes state at the &quot;wrong&quot; time.</span>
<span class="cm">		 * The IB logic then complains that the packet isn&#39;t</span>
<span class="cm">		 * valid.  We don&#39;t want to confuse people, so we just</span>
<span class="cm">		 * don&#39;t print them, except at debug</span>
<span class="cm">		 */</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Ignoring packet errors %llx, because link not &quot;</span>
			  <span class="s">&quot;ACTIVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">errs</span><span class="p">);</span>
		<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">supp_msgs</span> <span class="o">==</span> <span class="mi">250000</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s_iserr</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * It&#39;s not entirely reasonable assuming that the errors set</span>
<span class="cm">		 * in the last clear period are all responsible for the</span>
<span class="cm">		 * problem, but the alternative is to assume it&#39;s the only</span>
<span class="cm">		 * ones on this particular interrupt, which also isn&#39;t great</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_maskederrs</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span> <span class="o">|</span> <span class="n">errs</span><span class="p">;</span>

		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_errormask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_maskederrs</span><span class="p">;</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_errormask</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_errormask</span><span class="p">);</span>
		<span class="n">s_iserr</span> <span class="o">=</span> <span class="n">ipath_decode_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">,</span>
					   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_maskederrs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_maskederrs</span> <span class="o">&amp;</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_E_RRCVEGRFULL</span> <span class="o">|</span>
		      <span class="n">INFINIPATH_E_RRCVHDRFULL</span> <span class="o">|</span> <span class="n">INFINIPATH_E_PKTERRS</span><span class="p">))</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Temporarily disabling &quot;</span>
			    <span class="s">&quot;error(s) %llx reporting; too frequent (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_maskederrs</span><span class="p">,</span>
				<span class="n">msg</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rcvegrfull and rcvhdrqfull are &quot;normal&quot;,</span>
<span class="cm">			 * for some types of processes (mostly benchmarks)</span>
<span class="cm">			 * that send huge numbers of messages, while not</span>
<span class="cm">			 * processing them.  So only complain about</span>
<span class="cm">			 * these at debug level.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s_iserr</span><span class="p">)</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Temporarily disabling reporting &quot;</span>
				    <span class="s">&quot;too frequent queue full errors (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">msg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">ERRPKT</span><span class="p">,</span>
				    <span class="s">&quot;Temporarily disabling reporting too&quot;</span>
				    <span class="s">&quot; frequent packet errors (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">msg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Re-enable the masked errors after around 3 minutes.  in</span>
<span class="cm">		 * ipath_get_faststats().  If we have a series of fast</span>
<span class="cm">		 * repeating but different errors, the interval will keep</span>
<span class="cm">		 * stretching out, but that&#39;s OK, as that&#39;s pretty</span>
<span class="cm">		 * catastrophic.</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_unmasktime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">180</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_errorclear</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_this_time</span><span class="p">)</span>
		<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ignore_this_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span><span class="p">;</span>
		<span class="cm">/* never suppress duplicate hwerrors or ibstatuschange */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasterror</span> <span class="o">|=</span> <span class="n">errs</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_E_HARDWARE</span> <span class="o">|</span>
			  <span class="n">INFINIPATH_E_IBSTATUSCHANGED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_SENDSPECIALTRIGGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_spectriggerhit</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;%lu special trigger hits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_spectriggerhit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* likely due to cancel; so suppress message unless verbose */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INFINIPATH_E_SPKTLEN</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SPIOARMLAUNCH</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lastcancel</span> <span class="o">&gt;</span> <span class="n">jiffies</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* armlaunch takes precedence; it often causes both. */</span>
		<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span>
			<span class="s">&quot;Suppressed %s error (%llx) after sendbuf cancel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span>  <span class="n">INFINIPATH_E_SPIOARMLAUNCH</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;armlaunch&quot;</span> <span class="o">:</span> <span class="s">&quot;sendpktlen&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">errs</span><span class="p">);</span>
		<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_E_SPIOARMLAUNCH</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SPKTLEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noprint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_err_t</span> <span class="n">mask</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The ones we mask off are handled specially below</span>
<span class="cm">		 * or above.  Also mask SDMADISABLED by default as it</span>
<span class="cm">		 * is too chatty.</span>
<span class="cm">		 */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">INFINIPATH_E_IBSTATUSCHANGED</span> <span class="o">|</span>
			<span class="n">INFINIPATH_E_RRCVEGRFULL</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RRCVHDRFULL</span> <span class="o">|</span>
			<span class="n">INFINIPATH_E_HARDWARE</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SDMADISABLED</span><span class="p">;</span>

		<span class="cm">/* if we&#39;re in debug, then don&#39;t mask SDMADISABLED msgs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="n">__IPATH_DBG</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_E_SDMADISABLED</span><span class="p">;</span>

		<span class="n">ipath_decode_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">,</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* so we don&#39;t need if (!noprint) at strlcat&#39;s below */</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_PKTERRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_pkterrs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chkerrpkts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_ERRS</span><span class="p">)</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_errs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INFINIPATH_E_RICRC</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RVCRC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_crcerrs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chkerrpkts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iserr</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">E_SUM_PKTERRS</span> <span class="o">|</span> <span class="n">INFINIPATH_E_PKTERRS</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to print these two as they happen, or we can make</span>
<span class="cm">	 * the situation even worse, because it takes so long to print</span>
<span class="cm">	 * messages to serial consoles.  Kernel ports get printed from</span>
<span class="cm">	 * fast_stats, no more than every 5 seconds, user ports get printed</span>
<span class="cm">	 * on close</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_RRCVHDRFULL</span><span class="p">)</span>
		<span class="n">chkerrpkts</span> <span class="o">|=</span> <span class="n">handle_hdrq_full</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_RRCVEGRFULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipath_portdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_pd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * since this is of less importance and not likely to</span>
<span class="cm">		 * happen without also getting hdrfull, only count</span>
<span class="cm">		 * occurrences; don&#39;t check each port (or even the kernel</span>
<span class="cm">		 * vs user)</span>
<span class="cm">		 */</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_etidfull</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_head</span> <span class="o">!=</span> <span class="n">ipath_get_hdrqtail</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span>
			<span class="n">chkerrpkts</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * do this before IBSTATUSCHANGED, in case both bits set in a single</span>
<span class="cm">	 * interrupt; we want the STATUSCHANGE to &quot;win&quot;, so we do our</span>
<span class="cm">	 * internal copy of state machine correctly</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_RIBLOSTLINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * force through block below</span>
<span class="cm">		 */</span>
		<span class="n">errs</span> <span class="o">|=</span> <span class="n">INFINIPATH_E_IBSTATUSCHANGED</span><span class="p">;</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_iblink</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_LINKDOWN</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPATH_LINKUNK</span> <span class="o">|</span> <span class="n">IPATH_LINKINIT</span>
				     <span class="o">|</span> <span class="n">IPATH_LINKARMED</span> <span class="o">|</span> <span class="n">IPATH_LINKACTIVE</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_STATUS_IB_READY</span><span class="p">;</span>

		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Lost link, link now down (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ipath_ibcstatus_str</span><span class="p">[</span><span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_ibcstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_IBSTATUSCHANGED</span><span class="p">)</span>
		<span class="n">handle_e_ibstatuschanged</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_E_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noprint</span><span class="p">)</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Got reset, requires re-init &quot;</span>
				      <span class="s">&quot;(unload and reload driver)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_INITTED</span><span class="p">;</span>	<span class="cm">/* needs re-init */</span>
		<span class="cm">/* mark as having had error */</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">|=</span> <span class="n">IPATH_STATUS_HWERROR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_STATUS_IB_CONF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noprint</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iserr</span><span class="p">)</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;%s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_state_wanted</span> <span class="o">&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;driver wanted state %x, iflags now %x, &quot;</span>
			   <span class="s">&quot;waking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_state_wanted</span><span class="p">,</span>
			   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipath_state_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">chkerrpkts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * try to cleanup as much as possible for anything that might have gone</span>
<span class="cm"> * wrong while in freeze mode, such as pio buffers being written by user</span>
<span class="cm"> * processes (causing armlaunch), send errors due to going into freeze mode,</span>
<span class="cm"> * etc., and try to avoid causing extra interrupts while doing so.</span>
<span class="cm"> * Forcibly update the in-memory pioavail register copies after cleanup</span>
<span class="cm"> * because the chip won&#39;t do it while in freeze mode (the register values</span>
<span class="cm"> * themselves are kept correct).</span>
<span class="cm"> * Make sure that we don&#39;t lose any important interrupts by using the chip</span>
<span class="cm"> * feature that says that writing 0 to a bit in *clear that is set in</span>
<span class="cm"> * *status will cause an interrupt to be generated again (if allowed by</span>
<span class="cm"> * the *mask value).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ipath_clear_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable error interrupts, to avoid confusion */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_errormask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

	<span class="cm">/* also disable interrupts; errormask is sometimes overwriten */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

	<span class="n">ipath_cancel_sends</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* clear the freeze, and be sure chip saw it */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_control</span><span class="p">,</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_control</span><span class="p">);</span>
	<span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_scratch</span><span class="p">);</span>

	<span class="cm">/* force in-memory update now we are out of freeze */</span>
	<span class="n">ipath_force_pio_avail_update</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * force new interrupt if any hwerr, error or interrupt bits are</span>
<span class="cm">	 * still set, and clear &quot;safe&quot; send packet errors related to freeze</span>
<span class="cm">	 * and cancelling sends.  Re-enable error interrupts before possible</span>
<span class="cm">	 * force of re-interrupt on pending interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrclear</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_errorclear</span><span class="p">,</span>
		<span class="n">E_SPKT_ERRS_IGNORE</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_errormask</span><span class="p">,</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_errormask</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intmask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intclear</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* this is separate to allow for better optimization of ipath_intr() */</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">ipath_bad_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">unexpectp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * sometimes happen during driver init and unload, don&#39;t want</span>
<span class="cm">	 * to process any interrupts at that point</span>
<span class="cm">	 */</span>

	<span class="cm">/* this is just a bandaid, not a fix, if something goes badly</span>
<span class="cm">	 * wrong */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++*</span><span class="n">unexpectp</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++*</span><span class="n">unexpectp</span> <span class="o">&gt;</span> <span class="mi">105</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * ok, we must be taking somebody else&#39;s interrupts,</span>
<span class="cm">			 * due to a messed up mptable and/or PIRQ table, so</span>
<span class="cm">			 * unregister the interrupt.  We&#39;ve seen this during</span>
<span class="cm">			 * linuxbios development work, and it may happen in</span>
<span class="cm">			 * the future again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_irq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Now %u unexpected &quot;</span>
					      <span class="s">&quot;interrupts, unregistering &quot;</span>
					      <span class="s">&quot;interrupt handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="o">*</span><span class="n">unexpectp</span><span class="p">);</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;free_irq of irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_irq</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_free_irq</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipath_read_ireg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intmask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;%u unexpected interrupts, &quot;</span>
				      <span class="s">&quot;disabling interrupts completely</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="o">*</span><span class="n">unexpectp</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * disable all interrupts, something is very wrong</span>
<span class="cm">			 */</span>
			<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intmask</span><span class="p">,</span>
					 <span class="mi">0ULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">unexpectp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Interrupt when not ready, should not happen, &quot;</span>
			  <span class="s">&quot;ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">ipath_bad_regread</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">allbits</span><span class="p">;</span>

	<span class="cm">/* separate routine, for better optimization of ipath_intr() */</span>

	<span class="cm">/*</span>
<span class="cm">	 * We print the message and disable interrupts, in hope of</span>
<span class="cm">	 * having a better chance of debugging the problem.</span>
<span class="cm">	 */</span>
	<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
		      <span class="s">&quot;Read of interrupt status failed (all bits set)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">allbits</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable all interrupts, something is very wrong */</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">allbits</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Still bad interrupt status, &quot;</span>
				      <span class="s">&quot;unregistering interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_free_irq</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">allbits</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">allbits</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Disabling interrupts, &quot;</span>
				      <span class="s">&quot;multiple errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_layer_pioavail</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipath_ib_piobufavail</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">verbs_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">set:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl</span> <span class="o">|=</span> <span class="n">INFINIPATH_S_PIOINTBUFAVAIL</span><span class="p">;</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_sendctrl</span><span class="p">,</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl</span><span class="p">);</span>
	<span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle receive interrupts for user ports; this means a user</span>
<span class="cm"> * process was waiting for a packet to arrive, and didn&#39;t want</span>
<span class="cm"> * to poll</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_urcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">portr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcvdint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * test_and_clear_bit(IPATH_PORT_WAITING_RCV) and</span>
<span class="cm">	 * test_and_clear_bit(IPATH_PORT_WAITING_URG) below</span>
<span class="cm">	 * would both like timely updates of the bits so that</span>
<span class="cm">	 * we don&#39;t pass them by unnecessarily.  the rmb()</span>
<span class="cm">	 * here ensures that we see them promptly -- the</span>
<span class="cm">	 * corresponding wmb()&#39;s are in ipath_poll_urgent()</span>
<span class="cm">	 * and ipath_poll_next()...</span>
<span class="cm">	 */</span>
	<span class="n">rmb</span><span class="p">();</span>
	<span class="n">portr</span> <span class="o">=</span> <span class="p">((</span><span class="n">istat</span> <span class="o">&gt;&gt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_shift</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_mask</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">istat</span> <span class="o">&gt;&gt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_shift</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_mask</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_cfgports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipath_portdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_pd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">portr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pd</span> <span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IPATH_PORT_WAITING_RCV</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_flag</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_r_intravail_shift</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvctrl</span><span class="p">);</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_wait</span><span class="p">);</span>
				<span class="n">rcvdint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IPATH_PORT_WAITING_URG</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_flag</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_urgent</span><span class="o">++</span><span class="p">;</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_wait</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvdint</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only want to take one interrupt, so turn off the rcv</span>
<span class="cm">		 * interrupt for all the ports that we set the rcv_waiting</span>
<span class="cm">		 * (but never for kernel port)</span>
<span class="cm">		 */</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_rcvctrl</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvctrl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">ipath_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">istat</span><span class="p">,</span> <span class="n">chk0rcv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipath_err_t</span> <span class="n">estat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">unexpected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">kportrbits</span><span class="p">;</span>

	<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * this needs to be flags&amp;initted, not statusp, so we keep</span>
<span class="cm">	 * taking interrupts even after link goes down, etc.</span>
<span class="cm">	 * Also, we *must* clear the interrupt at some point, or we won&#39;t</span>
<span class="cm">	 * take it again, which can be real bad for errors, etc...</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_INITTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipath_bad_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unexpected</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">istat</span> <span class="o">=</span> <span class="n">ipath_read_ireg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">istat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_nullintr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span> <span class="cm">/* not our interrupt, or already handled */</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipath_bad_regread</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="cm">/* don&#39;t know if it was our interrupt or not */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unexpected</span><span class="p">)</span>
		<span class="n">unexpected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_bitsextant</span><span class="p">))</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			      <span class="s">&quot;interrupt with unknown interrupts %Lx set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			      <span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_bitsextant</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INFINIPATH_I_ERROR</span><span class="p">)</span> <span class="cm">/* errors do own printing */</span>
		<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;intr stat=0x%Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">istat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_I_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_errints</span><span class="o">++</span><span class="p">;</span>
		<span class="n">estat</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
					  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_errorstatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">estat</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error interrupt (%Lx), &quot;</span>
				 <span class="s">&quot;but no error bits set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">istat</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">estat</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * should we try clearing all, or hope next read</span>
<span class="cm">			 * works?</span>
<span class="cm">			 */</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Read of error status failed &quot;</span>
				      <span class="s">&quot;(all bits set); ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">chk0rcv</span> <span class="o">|=</span> <span class="n">handle_errors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">estat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_I_GPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * GPIO interrupts fall in two broad classes:</span>
<span class="cm">		 * GPIO_2 indicates (on some HT4xx boards) that a packet</span>
<span class="cm">		 *        has arrived for Port 0. Checking for this</span>
<span class="cm">		 *        is controlled by flag IPATH_GPIO_INTR.</span>
<span class="cm">		 * GPIO_3..5 on IBA6120 Rev2 and IBA6110 Rev4 chips indicate</span>
<span class="cm">		 *        errors that we need to count. Checking for this</span>
<span class="cm">		 *        is controlled by flag IPATH_GPIO_ERRINTRS.</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">gpiostatus</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">to_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">gpiostatus</span> <span class="o">=</span> <span class="n">ipath_read_kreg32</span><span class="p">(</span>
			<span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_gpio_status</span><span class="p">);</span>
		<span class="cm">/* First the error-counter case. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="n">IPATH_GPIO_ERRINTR_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_GPIO_ERRINTRS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* want to clear the bits we see asserted. */</span>
			<span class="n">to_clear</span> <span class="o">|=</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="n">IPATH_GPIO_ERRINTR_MASK</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Count appropriately, clear bits out of our copy,</span>
<span class="cm">			 * as they have been &quot;handled&quot;.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IPATH_GPIO_RXUVL_BIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;FlowCtl on UnsupVL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rxfc_unsupvl_errs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IPATH_GPIO_OVRUN_BIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Overrun Threshold exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_overrun_thresh_errs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IPATH_GPIO_LLI_BIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Local Link Integrity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lli_errs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gpiostatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_GPIO_ERRINTR_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Now the Port0 Receive case */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IPATH_GPIO_PORT0_BIT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_GPIO_INTR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * GPIO status bit 2 is set, and we expected it.</span>
<span class="cm">			 * clear it and indicate in p0bits.</span>
<span class="cm">			 * This probably only happens if a Port0 pkt</span>
<span class="cm">			 * arrives at _just_ the wrong time, and we</span>
<span class="cm">			 * handle that by seting chk0rcv;</span>
<span class="cm">			 */</span>
			<span class="n">to_clear</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IPATH_GPIO_PORT0_BIT</span><span class="p">);</span>
			<span class="n">gpiostatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IPATH_GPIO_PORT0_BIT</span><span class="p">);</span>
			<span class="n">chk0rcv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Some unexpected bits remain. If they could have</span>
<span class="cm">			 * caused the interrupt, complain and clear.</span>
<span class="cm">			 * To avoid repetition of this condition, also clear</span>
<span class="cm">			 * the mask. It is almost certainly due to error.</span>
<span class="cm">			 */</span>
			<span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_mask</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">gpiostatus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Unexpected GPIO IRQ bits %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
				<span class="n">to_clear</span> <span class="o">|=</span> <span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpiostatus</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
				<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
					<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_gpio_mask</span><span class="p">,</span>
					<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_mask</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to_clear</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_gpio_clear</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">to_clear</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt bits we found set, unless they are receive</span>
<span class="cm">	 * related, in which case we already cleared them above, and don&#39;t</span>
<span class="cm">	 * want to clear them again, because we might lose an interrupt.</span>
<span class="cm">	 * Clear it early, so we &quot;know&quot; know the chip will have seen this by</span>
<span class="cm">	 * the time we process the queue, and will re-interrupt if necessary.</span>
<span class="cm">	 * The processor itself won&#39;t take the interrupt again until we return.</span>
<span class="cm">	 */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_intclear</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle kernel receive queues before checking for pio buffers</span>
<span class="cm">	 * available since receives can overflow; piobuf waiters can afford</span>
<span class="cm">	 * a few extra cycles, since they were waiting anyway, and user&#39;s</span>
<span class="cm">	 * waiting for receive are at the bottom.</span>
<span class="cm">	 */</span>
	<span class="n">kportrbits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_shift</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chk0rcv</span> <span class="o">||</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">kportrbits</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">istat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">kportrbits</span><span class="p">;</span>
		<span class="n">ipath_kreceive</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_pd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_mask</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_shift</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_mask</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_shift</span><span class="p">)))</span>
		<span class="n">handle_urcv</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INFINIPATH_I_SDMAINT</span> <span class="o">|</span> <span class="n">INFINIPATH_I_SDMADISABLED</span><span class="p">))</span>
		<span class="n">handle_sdma_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_I_SPIOBUFAVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_S_PIOINTBUFAVAIL</span><span class="p">;</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_sendctrl</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl</span><span class="p">);</span>
		<span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* always process; sdma verbs uses PIO for acks and VL15  */</span>
		<span class="n">handle_layer_pioavail</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
