<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › ipath › ipath_iba6110.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ipath_iba6110.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006, 2007 QLogic Corporation. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2003, 2004, 2005, 2006 PathScale, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains all of the code that is specific to the InfiniPath</span>
<span class="cm"> * HT chip.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/htirq.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>

<span class="cp">#include &quot;ipath_kernel.h&quot;</span>
<span class="cp">#include &quot;ipath_registers.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ipath_setup_ht_setextled</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">u64</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * This lists the InfiniPath registers, in the actual chip layout.</span>
<span class="cm"> * This structure should never be directly accessed.</span>
<span class="cm"> *</span>
<span class="cm"> * The names are in InterCap form because they&#39;re taken straight from</span>
<span class="cm"> * the chip specification.  Since they&#39;re only used in this file, they</span>
<span class="cm"> * don&#39;t pollute the rest of the source.</span>
<span class="cm">*/</span>

<span class="k">struct</span> <span class="n">_infinipath_do_not_use_kernel_regs</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Revision</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">PageAlign</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">PortCnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">DebugPortSelect</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">DebugPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendRegBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">UserRegBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">CounterRegBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Scratch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedMisc1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">InterruptConfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">IntBlocked</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">IntMask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">IntStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">IntClear</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ErrorMask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ErrorStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ErrorClear</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">HwErrMask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">HwErrStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">HwErrClear</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">HwDiagCtrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">MDIO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">IBCStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">IBCCtrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ExtStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ExtCtrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">GPIOOut</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">GPIOMask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">GPIOStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">GPIOClear</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvCtrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvBTHQP</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrCnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrEntSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvTIDBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvTIDCnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvEgrBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvEgrCnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvBufBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvBufSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RxIntMemBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RxIntMemSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvPartitionKey</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedRcv</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendCtrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendPIOBufBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendPIOSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendPIOBufCnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendPIOAvailAddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">TxIntMemBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">TxIntMemSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedSend</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendBufferError</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendBufferErrorCONT1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendBufferErrorCONT2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SendBufferErrorCONT3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedSBE</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr6</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrAddr8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedRHA</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr6</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">RcvHdrTailAddr8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedRHTA</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Sync</span><span class="p">;</span>	<span class="cm">/* Software only */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Dump</span><span class="p">;</span>	<span class="cm">/* Software only */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SimVer</span><span class="p">;</span>	<span class="cm">/* Software only */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedSW</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SerdesConfig0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SerdesConfig1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">SerdesStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">XGXSConfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ReservedSW2</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">_infinipath_do_not_use_counters</span> <span class="p">{</span>
	<span class="n">__u64</span> <span class="n">LBIntCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">LBFlowStallCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">Reserved1</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxUnsupVLErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxDataPktCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxFlowPktCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxDwordCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxLenErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxMaxMinLenErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxUnderrunCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxFlowStallCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">TxDroppedPktCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxDroppedPktCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxDataPktCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxFlowPktCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxDwordCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxLenErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxMaxMinLenErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxICRCErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxVCRCErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxFlowCtrlErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxBadFormatCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxLinkProblemCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxEBPCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxLPCRCErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxBufOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxTIDFullErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxTIDValidErrCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxPKeyMismatchCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP0HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP1HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP2HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP3HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP4HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP5HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP6HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP7HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">RxP8HdrEgrOvflCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">Reserved6</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">Reserved7</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">IBStatusChangeCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">IBLinkErrRecoveryCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">IBLinkDownedCnt</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">IBSymbolErrCnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define IPATH_KREG_OFFSET(field) (offsetof( \</span>
<span class="cp">	struct _infinipath_do_not_use_kernel_regs, field) / sizeof(u64))</span>
<span class="cp">#define IPATH_CREG_OFFSET(field) (offsetof( \</span>
<span class="cp">	struct _infinipath_do_not_use_counters, field) / sizeof(u64))</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipath_kregs</span> <span class="n">ipath_ht_kregs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">kr_control</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">Control</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_counterregbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">CounterRegBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_debugport</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">DebugPort</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_debugportselect</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">DebugPortSelect</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_errorclear</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">ErrorClear</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_errormask</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">ErrorMask</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_errorstatus</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">ErrorStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_extctrl</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">ExtCtrl</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_extstatus</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">ExtStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_gpio_clear</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">GPIOClear</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_gpio_mask</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">GPIOMask</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_gpio_out</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">GPIOOut</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_gpio_status</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">GPIOStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_hwdiagctrl</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">HwDiagCtrl</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_hwerrclear</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">HwErrClear</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_hwerrmask</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">HwErrMask</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_hwerrstatus</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">HwErrStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_ibcctrl</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_ibcstatus</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">IBCStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_intblocked</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">IntBlocked</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_intclear</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">IntClear</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_interruptconfig</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">InterruptConfig</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_intmask</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">IntMask</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_intstatus</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">IntStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_mdio</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">MDIO</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_pagealign</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">PageAlign</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_partitionkey</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvPartitionKey</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_portcnt</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">PortCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvbthqp</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvBTHQP</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvbufbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvBufBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvbufsize</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvBufSize</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvctrl</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvegrbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvEgrBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvegrcnt</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvEgrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvhdrcnt</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvHdrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvhdrentsize</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvHdrEntSize</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvhdrsize</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvHdrSize</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvintmembase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RxIntMemBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvintmemsize</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RxIntMemSize</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvtidbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvTIDBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvtidcnt</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvTIDCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_revision</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">Revision</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_scratch</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">Scratch</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendbuffererror</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendBufferError</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendctrl</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendpioavailaddr</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendPIOAvailAddr</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendpiobufbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendPIOBufBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendpiobufcnt</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendPIOBufCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendpiosize</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendPIOSize</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_sendregbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SendRegBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_txintmembase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">TxIntMemBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_txintmemsize</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">TxIntMemSize</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_userregbase</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">UserRegBase</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_serdesconfig0</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SerdesConfig0</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_serdesconfig1</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SerdesConfig1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_serdesstatus</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">SerdesStatus</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_xgxsconfig</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">XGXSConfig</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * These should not be used directly via ipath_write_kreg64(),</span>
<span class="cm">	 * use them with ipath_write_kreg64_port(),</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">kr_rcvhdraddr</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvHdrAddr0</span><span class="p">),</span>
	<span class="p">.</span><span class="n">kr_rcvhdrtailaddr</span> <span class="o">=</span> <span class="n">IPATH_KREG_OFFSET</span><span class="p">(</span><span class="n">RcvHdrTailAddr0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipath_cregs</span> <span class="n">ipath_ht_cregs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cr_badformatcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxBadFormatCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_erricrccnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxICRCErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errlinkcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxLinkProblemCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errlpcrccnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxLPCRCErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errpkey</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxPKeyMismatchCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errrcvflowctrlcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxFlowCtrlErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_err_rlencnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxLenErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errslencnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxLenErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errtidfull</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxTIDFullErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errtidvalid</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxTIDValidErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_errvcrccnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxVCRCErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_ibstatuschange</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBStatusChangeCnt</span><span class="p">),</span>
	<span class="cm">/* calc from Reg_CounterRegBase + offset */</span>
	<span class="p">.</span><span class="n">cr_intcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">LBIntCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_invalidrlencnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxMaxMinLenErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_invalidslencnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxMaxMinLenErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_lbflowstallcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">LBFlowStallCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_pktrcvcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxDataPktCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_pktrcvflowctrlcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxFlowPktCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_pktsendcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxDataPktCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_pktsendflowcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxFlowPktCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_portovflcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP0HdrEgrOvflCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_rcvebpcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxEBPCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_rcvovflcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxBufOvflCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_senddropped</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxDroppedPktCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_sendstallcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxFlowStallCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_sendunderruncnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxUnderrunCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_wordrcvcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxDwordCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_wordsendcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxDwordCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_unsupvlcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxUnsupVLErrCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_rxdroppktcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxDroppedPktCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_iblinkerrrecovcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBLinkErrRecoveryCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_iblinkdowncnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBLinkDownedCnt</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cr_ibsymbolerrcnt</span> <span class="o">=</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBSymbolErrCnt</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/* kr_intstatus, kr_intclear, kr_intmask bits */</span>
<span class="cp">#define INFINIPATH_I_RCVURG_MASK ((1U&lt;&lt;9)-1)</span>
<span class="cp">#define INFINIPATH_I_RCVURG_SHIFT 0</span>
<span class="cp">#define INFINIPATH_I_RCVAVAIL_MASK ((1U&lt;&lt;9)-1)</span>
<span class="cp">#define INFINIPATH_I_RCVAVAIL_SHIFT 12</span>

<span class="cm">/* kr_hwerrclear, kr_hwerrmask, kr_hwerrstatus, bits */</span>
<span class="cp">#define INFINIPATH_HWE_HTCMEMPARITYERR_SHIFT 0</span>
<span class="cp">#define INFINIPATH_HWE_HTCMEMPARITYERR_MASK 0x3FFFFFULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCLNKABYTE0CRCERR   0x0000000000800000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCLNKABYTE1CRCERR   0x0000000001000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCLNKBBYTE0CRCERR   0x0000000002000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCLNKBBYTE1CRCERR   0x0000000004000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCMISCERR4          0x0000000008000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCMISCERR5          0x0000000010000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCMISCERR6          0x0000000020000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCMISCERR7          0x0000000040000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCBUSTREQPARITYERR  0x0000000080000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCBUSTRESPPARITYERR 0x0000000100000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTCBUSIREQPARITYERR  0x0000000200000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_COREPLL_FBSLIP       0x0080000000000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_COREPLL_RFSLIP       0x0100000000000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTBPLL_FBSLIP        0x0200000000000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTBPLL_RFSLIP        0x0400000000000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTAPLL_FBSLIP        0x0800000000000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_HTAPLL_RFSLIP        0x1000000000000000ULL</span>
<span class="cp">#define INFINIPATH_HWE_SERDESPLLFAILED      0x2000000000000000ULL</span>

<span class="cp">#define IBA6110_IBCS_LINKTRAININGSTATE_MASK 0xf</span>
<span class="cp">#define IBA6110_IBCS_LINKSTATE_SHIFT 4</span>

<span class="cm">/* kr_extstatus bits */</span>
<span class="cp">#define INFINIPATH_EXTS_FREQSEL 0x2</span>
<span class="cp">#define INFINIPATH_EXTS_SERDESSEL 0x4</span>
<span class="cp">#define INFINIPATH_EXTS_MEMBIST_ENDTEST     0x0000000000004000</span>
<span class="cp">#define INFINIPATH_EXTS_MEMBIST_CORRECT     0x0000000000008000</span>


<span class="cm">/* TID entries (memory), HT-only */</span>
<span class="cp">#define INFINIPATH_RT_ADDR_MASK 0xFFFFFFFFFFULL	</span><span class="cm">/* 40 bits valid */</span><span class="cp"></span>
<span class="cp">#define INFINIPATH_RT_VALID 0x8000000000000000ULL</span>
<span class="cp">#define INFINIPATH_RT_ADDR_SHIFT 0</span>
<span class="cp">#define INFINIPATH_RT_BUFSIZE_MASK 0x3FFFULL</span>
<span class="cp">#define INFINIPATH_RT_BUFSIZE_SHIFT 48</span>

<span class="cp">#define INFINIPATH_R_INTRAVAIL_SHIFT 16</span>
<span class="cp">#define INFINIPATH_R_TAILUPD_SHIFT 31</span>

<span class="cm">/* kr_xgxsconfig bits */</span>
<span class="cp">#define INFINIPATH_XGXS_RESET          0x7ULL</span>

<span class="cm">/*</span>
<span class="cm"> * masks and bits that are different in different chips, or present only</span>
<span class="cm"> * in one</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">ipath_err_t</span> <span class="n">infinipath_hwe_htcmemparityerr_mask</span> <span class="o">=</span>
    <span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_MASK</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">ipath_err_t</span> <span class="n">infinipath_hwe_htcmemparityerr_shift</span> <span class="o">=</span>
    <span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_SHIFT</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">ipath_err_t</span> <span class="n">infinipath_hwe_htclnkabyte0crcerr</span> <span class="o">=</span>
    <span class="n">INFINIPATH_HWE_HTCLNKABYTE0CRCERR</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">ipath_err_t</span> <span class="n">infinipath_hwe_htclnkabyte1crcerr</span> <span class="o">=</span>
    <span class="n">INFINIPATH_HWE_HTCLNKABYTE1CRCERR</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">ipath_err_t</span> <span class="n">infinipath_hwe_htclnkbbyte0crcerr</span> <span class="o">=</span>
    <span class="n">INFINIPATH_HWE_HTCLNKBBYTE0CRCERR</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">ipath_err_t</span> <span class="n">infinipath_hwe_htclnkbbyte1crcerr</span> <span class="o">=</span>
    <span class="n">INFINIPATH_HWE_HTCLNKBBYTE1CRCERR</span><span class="p">;</span>

<span class="cp">#define _IPATH_GPIO_SDA_NUM 1</span>
<span class="cp">#define _IPATH_GPIO_SCL_NUM 0</span>

<span class="cp">#define IPATH_GPIO_SDA \</span>
<span class="cp">	(1ULL &lt;&lt; (_IPATH_GPIO_SDA_NUM+INFINIPATH_EXTC_GPIOOE_SHIFT))</span>
<span class="cp">#define IPATH_GPIO_SCL \</span>
<span class="cp">	(1ULL &lt;&lt; (_IPATH_GPIO_SCL_NUM+INFINIPATH_EXTC_GPIOOE_SHIFT))</span>

<span class="cm">/* keep the code below somewhat more readable; not used elsewhere */</span>
<span class="cp">#define _IPATH_HTLINK0_CRCBITS (infinipath_hwe_htclnkabyte0crcerr |	\</span>
<span class="cp">				infinipath_hwe_htclnkabyte1crcerr)</span>
<span class="cp">#define _IPATH_HTLINK1_CRCBITS (infinipath_hwe_htclnkbbyte0crcerr |	\</span>
<span class="cp">				infinipath_hwe_htclnkbbyte1crcerr)</span>
<span class="cp">#define _IPATH_HTLANE0_CRCBITS (infinipath_hwe_htclnkabyte0crcerr |	\</span>
<span class="cp">				infinipath_hwe_htclnkbbyte0crcerr)</span>
<span class="cp">#define _IPATH_HTLANE1_CRCBITS (infinipath_hwe_htclnkabyte1crcerr |	\</span>
<span class="cp">				infinipath_hwe_htclnkbbyte1crcerr)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwerr_crcbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">ipath_err_t</span> <span class="n">hwerrs</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">bitsmsg</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">ipath_err_t</span> <span class="n">crcbits</span> <span class="o">=</span> <span class="n">hwerrs</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">_IPATH_HTLINK0_CRCBITS</span> <span class="o">|</span> <span class="n">_IPATH_HTLINK1_CRCBITS</span><span class="p">);</span>
	<span class="cm">/* don&#39;t check if 8bit HT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_8BIT_IN_HT0</span><span class="p">)</span>
		<span class="n">crcbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">infinipath_hwe_htclnkabyte1crcerr</span><span class="p">;</span>
	<span class="cm">/* don&#39;t check if 8bit HT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_8BIT_IN_HT1</span><span class="p">)</span>
		<span class="n">crcbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">infinipath_hwe_htclnkbbyte1crcerr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * we&#39;ll want to ignore link errors on link that is</span>
<span class="cm">	 * not in use, if any.  For now, complain about both</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crcbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl0</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">bitsmsg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">bitsmsg</span><span class="p">,</span>
			 <span class="s">&quot;[HT%s lane %s CRC (%llx); powercycle to completely clear]&quot;</span><span class="p">,</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">crcbits</span> <span class="o">&amp;</span> <span class="n">_IPATH_HTLINK1_CRCBITS</span><span class="p">)</span> <span class="o">?</span>
			 <span class="s">&quot;0 (A)&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crcbits</span> <span class="o">&amp;</span> <span class="n">_IPATH_HTLINK0_CRCBITS</span><span class="p">)</span>
				    <span class="o">?</span> <span class="s">&quot;1 (B)&quot;</span> <span class="o">:</span> <span class="s">&quot;0+1 (A+B)&quot;</span><span class="p">),</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">crcbits</span> <span class="o">&amp;</span> <span class="n">_IPATH_HTLANE1_CRCBITS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;0&quot;</span>
			 <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crcbits</span> <span class="o">&amp;</span> <span class="n">_IPATH_HTLANE0_CRCBITS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span>
			    <span class="s">&quot;0+1&quot;</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">crcbits</span><span class="p">);</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bitsmsg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * print extra info for debugging.  slave/primary</span>
<span class="cm">		 * config word 4, 8 (link control 0, 1)</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ht_slave_off</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ctrl0</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read &quot;</span>
				 <span class="s">&quot;linkctrl0 of slave/primary &quot;</span>
				 <span class="s">&quot;config block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl0</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
			<span class="cm">/* not if EOC bit set */</span>
			<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;HT linkctrl0 0x%x%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl0</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">ctrl0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CRC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">ctrl0</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;linkfail&quot;</span> <span class="o">:</span>
				  <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ht_slave_off</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ctrl1</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read &quot;</span>
				 <span class="s">&quot;linkctrl1 of slave/primary &quot;</span>
				 <span class="s">&quot;config block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
			<span class="cm">/* not if EOC bit set */</span>
			<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;HT linkctrl1 0x%x%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">ctrl1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CRC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">ctrl1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;linkfail&quot;</span> <span class="o">:</span>
				  <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="cm">/* disable until driver reloaded */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">crcbits</span><span class="p">;</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrmask</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span><span class="p">);</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;HT crc errs: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;ignoring HT crc errors 0x%llx, &quot;</span>
			  <span class="s">&quot;not in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			  <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IPATH_HTLINK0_CRCBITS</span> <span class="o">|</span>
				     <span class="n">_IPATH_HTLINK1_CRCBITS</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/* 6110 specific hardware errors... */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipath_hwerror_msgs</span> <span class="n">ipath_6110_hwerror_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">HTCBUSIREQPARITYERR</span><span class="p">,</span> <span class="s">&quot;HTC Ireq Parity&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">HTCBUSTREQPARITYERR</span><span class="p">,</span> <span class="s">&quot;HTC Treq Parity&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">HTCBUSTRESPPARITYERR</span><span class="p">,</span> <span class="s">&quot;HTC Tresp Parity&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">HTCMISCERR5</span><span class="p">,</span> <span class="s">&quot;HT core Misc5&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">HTCMISCERR6</span><span class="p">,</span> <span class="s">&quot;HT core Misc6&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">HTCMISCERR7</span><span class="p">,</span> <span class="s">&quot;HT core Misc7&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">RXDSYNCMEMPARITYERR</span><span class="p">,</span> <span class="s">&quot;Rx Dsync&quot;</span><span class="p">),</span>
	<span class="n">INFINIPATH_HWE_MSG</span><span class="p">(</span><span class="n">SERDESPLLFAILED</span><span class="p">,</span> <span class="s">&quot;SerDes PLL&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define TXE_PIO_PARITY ((INFINIPATH_HWE_TXEMEMPARITYERR_PIOBUF | \</span>
<span class="cp">		        INFINIPATH_HWE_TXEMEMPARITYERR_PIOPBC) \</span>
<span class="cp">		        &lt;&lt; INFINIPATH_HWE_TXEMEMPARITYERR_SHIFT)</span>
<span class="cp">#define RXE_EAGER_PARITY (INFINIPATH_HWE_RXEMEMPARITYERR_EAGERTID \</span>
<span class="cp">			  &lt;&lt; INFINIPATH_HWE_RXEMEMPARITYERR_SHIFT)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_txe_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++</span><span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_txeparity</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Recovering from TXE PIO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ipath_ht_handle_hwerrors - display hardware errors.</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @msg: the output buffer</span>
<span class="cm"> * @msgl: the size of the output buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Use same msg buffer as regular errors to avoid excessive stack</span>
<span class="cm"> * use.  Most hardware errors are catastrophic, but for right now,</span>
<span class="cm"> * we&#39;ll print them and continue.  We reuse the same message buffer as</span>
<span class="cm"> * ipath_handle_errors() to avoid excessive stack usage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_handle_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">msgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipath_err_t</span> <span class="n">hwerrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isfatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bitsmsg</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">log_idx</span><span class="p">;</span>

	<span class="n">hwerrs</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwerrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Called but no hardware errors set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * better than printing cofusing messages</span>
<span class="cm">		 * This seems to be related to clearing the crc error, or</span>
<span class="cm">		 * the pll error during init.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Read of hardware error status failed &quot;</span>
			      <span class="s">&quot;(all bits set); ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipath_stats</span><span class="p">.</span><span class="n">sps_hwerrs</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Always clear the error status register, except MEMBISTFAIL,</span>
<span class="cm">	 * regardless of whether we continue or stop using the chip.</span>
<span class="cm">	 * We want that set so we know it failed, even across driver reload.</span>
<span class="cm">	 * We&#39;ll still ignore it in the hwerrmask.  We do this partly for</span>
<span class="cm">	 * diagnostics, but also for support */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrclear</span><span class="p">,</span>
			 <span class="n">hwerrs</span><span class="o">&amp;~</span><span class="n">INFINIPATH_HWE_MEMBISTFAILED</span><span class="p">);</span>

	<span class="n">hwerrs</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span><span class="p">;</span>

	<span class="cm">/* We log some errors to EEPROM, check if we have any of those. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">log_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">log_idx</span> <span class="o">&lt;</span> <span class="n">IPATH_EEP_LOG_CNT</span><span class="p">;</span> <span class="o">++</span><span class="n">log_idx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_eep_st_masks</span><span class="p">[</span><span class="n">log_idx</span><span class="p">].</span><span class="n">hwerrs_to_log</span><span class="p">)</span>
			<span class="n">ipath_inc_eeprom_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">log_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * make sure we get this much out, unless told to be quiet,</span>
<span class="cm">	 * it&#39;s a parity error we may recover from,</span>
<span class="cm">	 * or it&#39;s occurred within the last 5 seconds</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasthwerror</span> <span class="o">|</span> <span class="n">TXE_PIO_PARITY</span> <span class="o">|</span>
		<span class="n">RXE_EAGER_PARITY</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ipath_debug</span> <span class="o">&amp;</span> <span class="n">__IPATH_VERBDBG</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Hardware error: hwerr=0x%llx &quot;</span>
			 <span class="s">&quot;(cleared)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hwerrs</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lasthwerror</span> <span class="o">|=</span> <span class="n">hwerrs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwe_bitsextant</span><span class="p">)</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;hwerror interrupt with unknown errors &quot;</span>
			      <span class="s">&quot;%llx set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			      <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwe_bitsextant</span><span class="p">));</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ipath_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_C_FREEZEMODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipath_diag_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * parity errors in send memory are recoverable,</span>
<span class="cm">		 * just cancel the send (if indicated in * sendbuffererror),</span>
<span class="cm">		 * count the occurrence, unfreeze (if no other handled</span>
<span class="cm">		 * hardware error bits are set), and continue. They can</span>
<span class="cm">		 * occur if a processor speculative read is done to the PIO</span>
<span class="cm">		 * buffer while we are sending a packet, for example.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">TXE_PIO_PARITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_ht_txe_recover</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="n">hwerrs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXE_PIO_PARITY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwerrs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Clearing freezemode on ignored or &quot;</span>
				  <span class="s">&quot;recovered hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ipath_clear_freeze</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * may someday want to decode into which bits are which</span>
<span class="cm">	 * functional area for parity errors, etc.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">infinipath_hwe_htcmemparityerr_mask</span>
		      <span class="o">&lt;&lt;</span> <span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">hwerrs</span> <span class="o">&gt;&gt;</span>
			       <span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_MASK</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">bitsmsg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">bitsmsg</span><span class="p">,</span> <span class="s">&quot;[HTC Parity Errs %x] &quot;</span><span class="p">,</span>
			 <span class="n">bits</span><span class="p">);</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bitsmsg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipath_format_hwerrors</span><span class="p">(</span><span class="n">hwerrs</span><span class="p">,</span>
			      <span class="n">ipath_6110_hwerror_msgs</span><span class="p">,</span>
			      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipath_6110_hwerror_msgs</span><span class="p">),</span>
			      <span class="n">msg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IPATH_HTLINK0_CRCBITS</span> <span class="o">|</span> <span class="n">_IPATH_HTLINK1_CRCBITS</span><span class="p">))</span>
		<span class="n">hwerr_crcbits</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">hwerrs</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_HWE_MEMBISTFAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;[Memory BIST test failed, InfiniPath hardware unusable]&quot;</span><span class="p">,</span>
			<span class="n">msgl</span><span class="p">);</span>
		<span class="cm">/* ignore from now on, so disable until driver reloaded */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_HWE_MEMBISTFAILED</span><span class="p">;</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrmask</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#define _IPATH_PLL_FAIL (INFINIPATH_HWE_COREPLL_FBSLIP |	\</span>
<span class="cp">			 INFINIPATH_HWE_COREPLL_RFSLIP |	\</span>
<span class="cp">			 INFINIPATH_HWE_HTBPLL_FBSLIP |		\</span>
<span class="cp">			 INFINIPATH_HWE_HTBPLL_RFSLIP |		\</span>
<span class="cp">			 INFINIPATH_HWE_HTAPLL_FBSLIP |		\</span>
<span class="cp">			 INFINIPATH_HWE_HTAPLL_RFSLIP)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">_IPATH_PLL_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">bitsmsg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">bitsmsg</span><span class="p">,</span>
			 <span class="s">&quot;[PLL failed (%llx), InfiniPath hardware unusable]&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">_IPATH_PLL_FAIL</span><span class="p">));</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bitsmsg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
		<span class="cm">/* ignore from now on, so disable until driver reloaded */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">_IPATH_PLL_FAIL</span><span class="p">);</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrmask</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it occurs, it is left masked since the eternal</span>
<span class="cm">		 * interface is unused</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span><span class="p">;</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrmask</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if any set that we aren&#39;t ignoring; only</span>
<span class="cm">		 * make the complaint once, in case it&#39;s stuck</span>
<span class="cm">		 * or recurring, and we get here multiple</span>
<span class="cm">		 * times.</span>
<span class="cm">		 * force link down, so switch knows, and</span>
<span class="cm">		 * LEDs are turned off</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_INITTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_set_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_IB_LINKDOWN</span><span class="p">);</span>
			<span class="n">ipath_setup_ht_setextled</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
				<span class="n">INFINIPATH_IBCS_L_STATE_DOWN</span><span class="p">,</span>
				<span class="n">INFINIPATH_IBCS_LT_STATE_DISABLED</span><span class="p">);</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Fatal Hardware Error (freeze &quot;</span>
					  <span class="s">&quot;mode), no longer usable, SN %.16s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_serial</span><span class="p">);</span>
			<span class="n">isfatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_STATUS_IB_READY</span><span class="p">;</span>
		<span class="cm">/* mark as having had error */</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_statusp</span> <span class="o">|=</span> <span class="n">IPATH_STATUS_HWERROR</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * mark as not usable, at a minimum until driver</span>
<span class="cm">		 * is reloaded, probably until reboot, since no</span>
<span class="cm">		 * other reset is possible.</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPATH_INITTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* recovered from all of them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">)</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;%s hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isfatal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipath_diag_inuse</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_freezemsg</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * for status file; if no trailing brace is copied,</span>
<span class="cm">		 * we&#39;ll know it was truncated.</span>
<span class="cm">		 */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_freezemsg</span><span class="p">,</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_freezelen</span><span class="p">,</span> <span class="s">&quot;{%s}&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

<span class="nl">bail:</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_ht_boardname - fill in the board name</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @name: the output buffer</span>
<span class="cm"> * @namelen: the size of the output buffer</span>
<span class="cm"> *</span>
<span class="cm"> * fill in the board name, based on the board revision register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_boardname</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">namelen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">boardrev</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_boardrev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">boardrev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/*</span>
<span class="cm">		 * original production board; two production levels, with</span>
<span class="cm">		 * different serial number ranges.   See ipath_ht_early_init() for</span>
<span class="cm">		 * case where we enable IPATH_GPIO_INTR for later serial # range.</span>
<span class="cm">		 * Original 112* serial number is no longer supported.</span>
<span class="cm">		 */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QHT7040&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="cm">/* small form factor production board */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QHT7140&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* don&#39;t know, just print the number */</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Don&#39;t yet know about board &quot;</span>
			      <span class="s">&quot;with ID %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardrev</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;Unknown_InfiniPath_QHT7xxx_%u&quot;</span><span class="p">,</span>
			 <span class="n">boardrev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Unsupported InfiniPath board %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_majrev</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">||</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_minrev</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_minrev</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This version of the driver only supports Rev 3.2 - 3.4</span>
<span class="cm">		 */</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			      <span class="s">&quot;Unsupported InfiniPath hardware revision %u.%u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_majrev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_minrev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * pkt/word counters are 32 bit, and therefore wrap fast enough</span>
<span class="cm">	 * that we snapshot them from a timer, and maintain 64 bit shadow</span>
<span class="cm">	 * copies</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_32BITCOUNTERS</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_GPIO_INTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_speed</span> <span class="o">!=</span> <span class="mi">800</span><span class="p">)</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			      <span class="s">&quot;Incorrectly configured for HT @ %uMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_speed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set here, not in ipath_init_*_funcs because we have to do</span>
<span class="cm">	 * it after we can read chip registers.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ureg_align</span> <span class="o">=</span>
		<span class="n">ipath_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_pagealign</span><span class="p">);</span>

<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_check_htlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">linkerr</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_off</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ht_slave_off</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkerr</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read &quot;</span>
				 <span class="s">&quot;linkerror%d of HT slave/primary block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkerr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;HT linkerr%d bits 0x%x set, &quot;</span>
				   <span class="s">&quot;clearing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">linkerr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * writing the linkerr bits that are set should</span>
<span class="cm">			 * clear them</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span>
						  <span class="n">linkerr</span><span class="p">))</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Failed write to clear HT &quot;</span>
					  <span class="s">&quot;linkerror%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">linkerr</span><span class="p">))</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Couldn&#39;t reread linkerror%d of &quot;</span>
					 <span class="s">&quot;HT slave/primary block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkerr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;HT linkerror%d bits 0x%x &quot;</span>
					 <span class="s">&quot;couldn&#39;t be cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">i</span><span class="p">,</span> <span class="n">linkerr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_setup_ht_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;No reset possible for this InfiniPath hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HT_INTR_DISC_CONFIG  0x80	</span><span class="cm">/* HT interrupt and discovery cap */</span><span class="cp"></span>
<span class="cp">#define HT_INTR_REG_INDEX    2	</span><span class="cm">/* intconfig requires indirect accesses */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Bits 13-15 of command==0 is slave/primary block.  Clear any HT CRC</span>
<span class="cm"> * errors.  We only bother to do this at load time, because it&#39;s OK if</span>
<span class="cm"> * it happened before we were loaded (first time after boot/reset),</span>
<span class="cm"> * but any time after that, it&#39;s fatal anyway.  Also need to not check</span>
<span class="cm"> * for upper byte errors if we are in 8 bit mode, so figure out</span>
<span class="cm"> * our width.  For now, at least, also complain if it&#39;s 8 bit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">slave_or_pri_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cap_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">linkwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">linkerr</span><span class="p">,</span> <span class="n">link_a_b_off</span><span class="p">,</span> <span class="n">link_off</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">linkctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ht_slave_off</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="cm">/* command word, master_host bit */</span>
	<span class="cm">/* master host || slave */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cap_type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_a_b_off</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">link_a_b_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;HT%u (Link %c) connected to processor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">link_a_b_off</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">link_a_b_off</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>

	<span class="n">link_a_b_off</span> <span class="o">+=</span> <span class="n">pos</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check both link control registers; clear both HT CRC sets if</span>
<span class="cm">	 * necessary.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_off</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkctrl</span><span class="p">))</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read HT link control%d &quot;</span>
				      <span class="s">&quot;register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Clear linkctrl%d CRC Error &quot;</span>
				   <span class="s">&quot;bits %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">linkctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="cm">/*</span>
<span class="cm">			 * now write them back to clear the error.</span>
<span class="cm">			 */</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span>
					      <span class="n">linkctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * As with HT CRC bits, same for protocol errors that might occur</span>
<span class="cm">	 * during boot.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_off</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkerr</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read linkerror%d &quot;</span>
				 <span class="s">&quot;of HT slave/primary block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkerr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;HT linkerr%d bits 0x%x set, &quot;</span>
				   <span class="s">&quot;clearing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">linkerr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * writing the linkerr bits that are set will clear</span>
<span class="cm">			 * them</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span>
			    <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span> <span class="n">linkerr</span><span class="p">))</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Failed write to clear HT &quot;</span>
					  <span class="s">&quot;linkerror%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkerr</span><span class="p">))</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t reread &quot;</span>
					 <span class="s">&quot;linkerror%d of HT slave/primary &quot;</span>
					 <span class="s">&quot;block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkerr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HT linkerror%d bits &quot;</span>
					 <span class="s">&quot;0x%x couldn&#39;t be cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">i</span><span class="p">,</span> <span class="n">linkerr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * this is just for our link to the host, not devices connected</span>
<span class="cm">	 * through tunnel.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_a_b_off</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkwidth</span><span class="p">))</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read HT link width &quot;</span>
			      <span class="s">&quot;config register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">width</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">linkwidth</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">width</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="nl">default:</span>	<span class="cm">/* if wrong, assume 8 bit */</span>
			<span class="n">width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">linkwidth</span> <span class="o">!=</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Not configured for 16 bit HT &quot;</span>
				      <span class="s">&quot;(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">linkwidth</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">linkwidth</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Will ignore HT lane1 errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_8BIT_IN_HT0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * this is just for our link to the host, not devices connected</span>
<span class="cm">	 * through tunnel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">link_a_b_off</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkwidth</span><span class="p">))</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read HT link frequency &quot;</span>
			      <span class="s">&quot;config register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">linkwidth</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * assume reserved and vendor-specific are 200...</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_info</span><span class="p">),</span>
		<span class="s">&quot;HyperTransport,%uMHz,x%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_speed</span><span class="p">,</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lbus_width</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_intconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_intconfig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_interruptconfig</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_intconfig</span><span class="p">);</span>	<span class="cm">/* interrupt address */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;No interrupts enabled, couldn&#39;t setup &quot;</span>
			      <span class="s">&quot;interrupt address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_irq_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ht_irq_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">prev_intconfig</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_intconfig</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_intconfig</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_intconfig</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the previous value of dd-&gt;ipath_intconfig is zero, we&#39;re</span>
<span class="cm">	 * getting configured for the first time, and must not program the</span>
<span class="cm">	 * intconfig register here (it will be programmed later, when the</span>
<span class="cm">	 * hardware is ready).  Otherwise, we should.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_intconfig</span><span class="p">)</span>
		<span class="n">ipath_ht_intconfig</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_setup_ht_config - setup the interruptconfig register</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @pdev: the PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * setup the interruptconfig register from the HT config info.</span>
<span class="cm"> * Also clear CRC errors in HT linkcontrol, if necessary.</span>
<span class="cm"> * This is done only for the real hardware.  It is done before</span>
<span class="cm"> * chip address space is initted, so can&#39;t touch infinipath registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_setup_ht_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__ht_create_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ipath_ht_irq_update</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t create interrupt handler: &quot;</span>
			      <span class="s">&quot;err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_irq</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle clearing CRC errors in linkctrl register if necessary.  We</span>
<span class="cm">	 * do this early, before we ever enable errors or hardware errors,</span>
<span class="cm">	 * mostly to avoid causing the chip to enter freeze mode.</span>
<span class="cm">	 */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_HT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find HyperTransport &quot;</span>
			      <span class="s">&quot;capability; no interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cap_type</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The HT capability type byte is 3 bytes after the</span>
<span class="cm">		 * capability byte.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t read config &quot;</span>
				 <span class="s">&quot;command @ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cap_type</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">))</span>
			<span class="n">slave_or_pri_blk</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">cap_type</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_next_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
						 <span class="n">PCI_CAP_ID_HT</span><span class="p">)));</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_SWAP_PIOBUFS</span><span class="p">;</span>

<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_setup_ht_cleanup - clean up any per-chip chip-specific stuff</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> *</span>
<span class="cm"> * Called during driver unload.</span>
<span class="cm"> * This is currently a nop for the HT chip, not for all chips</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_setup_ht_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_setup_ht_setextled - set the state of the two external LEDs</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @lst: the L state</span>
<span class="cm"> * @ltst: the LT state</span>
<span class="cm"> *</span>
<span class="cm"> * Set the state of the two external LEDs, to indicate physical and</span>
<span class="cm"> * logical state of IB link.   For this chip (at least with recommended</span>
<span class="cm"> * board pinouts), LED1 is Green (physical state), and LED2 is Yellow</span>
<span class="cm"> * (logical state)</span>
<span class="cm"> *</span>
<span class="cm"> * Note:  We try to match the Mellanox HCA LED behavior as best</span>
<span class="cm"> * we can.  Green indicates physical link state is OK (something is</span>
<span class="cm"> * plugged in, and we can train).</span>
<span class="cm"> * Amber indicates the link is logically up (ACTIVE).</span>
<span class="cm"> * Mellanox further blinks the amber LED to indicate data packet</span>
<span class="cm"> * activity, but we have no hardware support for that, so it would</span>
<span class="cm"> * require waking up every 10-20 msecs and checking the counters</span>
<span class="cm"> * on the chip, and then turning the LED off if appropriate.  That&#39;s</span>
<span class="cm"> * visible overhead, so not something we will do.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_setup_ht_setextled</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">lst</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ltst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">extctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* the diags use the LED to indicate diag info, so we leave</span>
<span class="cm">	 * the external LED alone when the diags are running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipath_diag_inuse</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Allow override of LED display for, e.g. Locating system in rack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_led_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ltst</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_led_override</span> <span class="o">&amp;</span> <span class="n">IPATH_LED_PHYS</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span>
			<span class="o">:</span> <span class="n">INFINIPATH_IBCS_LT_STATE_DISABLED</span><span class="p">;</span>
		<span class="n">lst</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_led_override</span> <span class="o">&amp;</span> <span class="n">IPATH_LED_LOG</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">INFINIPATH_IBCS_L_STATE_ACTIVE</span>
			<span class="o">:</span> <span class="n">INFINIPATH_IBCS_L_STATE_DOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * start by setting both LED control bits to off, then turn</span>
<span class="cm">	 * on the appropriate bit(s).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_boardrev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* LS/X-1 uses different pins */</span>
		<span class="cm">/*</span>
<span class="cm">		 * major difference is that INFINIPATH_EXTC_LEDGBLERR_OFF</span>
<span class="cm">		 * is inverted,  because it is normally used to indicate</span>
<span class="cm">		 * a hardware fault at reset, if there were errors</span>
<span class="cm">		 */</span>
		<span class="n">extctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_extctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INFINIPATH_EXTC_LEDGBLOK_ON</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">INFINIPATH_EXTC_LEDGBLERR_OFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ltst</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span><span class="p">)</span>
			<span class="n">extctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_EXTC_LEDGBLERR_OFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lst</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_L_STATE_ACTIVE</span><span class="p">)</span>
			<span class="n">extctl</span> <span class="o">|=</span> <span class="n">INFINIPATH_EXTC_LEDGBLOK_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">extctl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_extctrl</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_EXTC_LED1PRIPORT_ON</span> <span class="o">|</span>
			  <span class="n">INFINIPATH_EXTC_LED2PRIPORT_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ltst</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span><span class="p">)</span>
			<span class="n">extctl</span> <span class="o">|=</span> <span class="n">INFINIPATH_EXTC_LED1PRIPORT_ON</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lst</span> <span class="o">==</span> <span class="n">INFINIPATH_IBCS_L_STATE_ACTIVE</span><span class="p">)</span>
			<span class="n">extctl</span> <span class="o">|=</span> <span class="n">INFINIPATH_EXTC_LED2PRIPORT_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_extctrl</span> <span class="o">=</span> <span class="n">extctl</span><span class="p">;</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_extctrl</span><span class="p">,</span> <span class="n">extctl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_init_ht_variables</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * setup the register offsets, since they are different for each</span>
<span class="cm">	 * chip</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipath_ht_kregs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_cregs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipath_ht_cregs</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_sda_num</span> <span class="o">=</span> <span class="n">_IPATH_GPIO_SDA_NUM</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_scl_num</span> <span class="o">=</span> <span class="n">_IPATH_GPIO_SCL_NUM</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_sda</span> <span class="o">=</span> <span class="n">IPATH_GPIO_SDA</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_scl</span> <span class="o">=</span> <span class="n">IPATH_GPIO_SCL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in data for field-values that change in newer chips.</span>
<span class="cm">	 * We dynamically specify only the mask for LINKTRAININGSTATE</span>
<span class="cm">	 * and only the shift for LINKSTATE, as they are the only ones</span>
<span class="cm">	 * that change.  Also precalculate the 3 link states of interest</span>
<span class="cm">	 * and the combined mask.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_ls_shift</span> <span class="o">=</span> <span class="n">IBA6110_IBCS_LINKSTATE_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_lts_mask</span> <span class="o">=</span> <span class="n">IBA6110_IBCS_LINKTRAININGSTATE_MASK</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">INFINIPATH_IBCS_LINKSTATE_MASK</span> <span class="o">&lt;&lt;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_ls_shift</span><span class="p">)</span> <span class="o">|</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_lts_mask</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span> <span class="o">&lt;&lt;</span>
		<span class="n">INFINIPATH_IBCS_LINKTRAININGSTATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">INFINIPATH_IBCS_L_STATE_INIT</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_ls_shift</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_arm</span> <span class="o">=</span> <span class="p">(</span><span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span> <span class="o">&lt;&lt;</span>
		<span class="n">INFINIPATH_IBCS_LINKTRAININGSTATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">INFINIPATH_IBCS_L_STATE_ARM</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_ls_shift</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ib_active</span> <span class="o">=</span> <span class="p">(</span><span class="n">INFINIPATH_IBCS_LT_STATE_LINKUP</span> <span class="o">&lt;&lt;</span>
		<span class="n">INFINIPATH_IBCS_LINKTRAININGSTATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">INFINIPATH_IBCS_L_STATE_ACTIVE</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcs_ls_shift</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in data for ibcc field-values that change in newer chips.</span>
<span class="cm">	 * We dynamically specify only the mask for LINKINITCMD</span>
<span class="cm">	 * and only the shift for LINKCMD and MAXPKTLEN, as they are</span>
<span class="cm">	 * the only ones that change.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcc_lic_mask</span> <span class="o">=</span> <span class="n">INFINIPATH_IBCC_LINKINITCMD_MASK</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcc_lc_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_IBCC_LINKCMD_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ibcc_mpl_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_IBCC_MAXPKTLEN_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Fill in shifts for RcvCtrl. */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_r_portenable_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_R_PORTENABLE_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_r_intravail_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_R_INTRAVAIL_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_r_tailupd_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_R_TAILUPD_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_r_portcfg_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Not on IBA6110 */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_bitsextant</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">INFINIPATH_I_RCVURG_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">INFINIPATH_I_RCVURG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">INFINIPATH_I_RCVAVAIL_MASK</span> <span class="o">&lt;&lt;</span>
		 <span class="n">INFINIPATH_I_RCVAVAIL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">INFINIPATH_I_ERROR</span> <span class="o">|</span> <span class="n">INFINIPATH_I_SPIOSENT</span> <span class="o">|</span>
		<span class="n">INFINIPATH_I_SPIOBUFAVAIL</span> <span class="o">|</span> <span class="n">INFINIPATH_I_GPIO</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_e_bitsextant</span> <span class="o">=</span>
		<span class="n">INFINIPATH_E_RFORMATERR</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RVCRC</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RICRC</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RMINPKTLEN</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RMAXPKTLEN</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RLONGPKTLEN</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RSHORTPKTLEN</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RUNEXPCHAR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RUNSUPVL</span> <span class="o">|</span> <span class="n">INFINIPATH_E_REBP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RIBFLOW</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RBADVERSION</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RRCVEGRFULL</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RRCVHDRFULL</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RBADTID</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RHDRLEN</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_RHDR</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RIBLOSTLINK</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_SMINPKTLEN</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SMAXPKTLEN</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_SUNDERRUN</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SPKTLEN</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_SDROPPEDSMPPKT</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SDROPPEDDATAPKT</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_SPIOARMLAUNCH</span> <span class="o">|</span> <span class="n">INFINIPATH_E_SUNEXPERRPKTNUM</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_SUNSUPVL</span> <span class="o">|</span> <span class="n">INFINIPATH_E_IBSTATUSCHANGED</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_INVALIDADDR</span> <span class="o">|</span> <span class="n">INFINIPATH_E_RESET</span> <span class="o">|</span>
		<span class="n">INFINIPATH_E_HARDWARE</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwe_bitsextant</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_MASK</span> <span class="o">&lt;&lt;</span>
		 <span class="n">INFINIPATH_HWE_HTCMEMPARITYERR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_MASK</span> <span class="o">&lt;&lt;</span>
		 <span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MASK</span> <span class="o">&lt;&lt;</span>
		 <span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCLNKABYTE0CRCERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCLNKABYTE1CRCERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCLNKBBYTE0CRCERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCLNKBBYTE1CRCERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCMISCERR4</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCMISCERR5</span> <span class="o">|</span> <span class="n">INFINIPATH_HWE_HTCMISCERR6</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCMISCERR7</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCBUSTREQPARITYERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCBUSTRESPPARITYERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTCBUSIREQPARITYERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_RXDSYNCMEMPARITYERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_MEMBISTFAILED</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_COREPLL_FBSLIP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_COREPLL_RFSLIP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTBPLL_FBSLIP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTBPLL_RFSLIP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTAPLL_FBSLIP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_HTAPLL_RFSLIP</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_IBCBUSTOSPCPARITYERR</span> <span class="o">|</span>
		<span class="n">INFINIPATH_HWE_IBCBUSFRSPCPARITYERR</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_mask</span> <span class="o">=</span> <span class="n">INFINIPATH_I_RCVAVAIL_MASK</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_mask</span> <span class="o">=</span> <span class="n">INFINIPATH_I_RCVURG_MASK</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvavail_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_I_RCVAVAIL_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_i_rcvurg_shift</span> <span class="o">=</span> <span class="n">INFINIPATH_I_RCVURG_SHIFT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * EEPROM error log 0 is TXE Parity errors. 1 is RXE Parity.</span>
<span class="cm">	 * 2 is Some Misc, 3 is reserved for future.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_eep_st_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hwerrs_to_log</span> <span class="o">=</span>
		<span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_MASK</span> <span class="o">&lt;&lt;</span>
		<span class="n">INFINIPATH_HWE_TXEMEMPARITYERR_SHIFT</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_eep_st_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">hwerrs_to_log</span> <span class="o">=</span>
		<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_MASK</span> <span class="o">&lt;&lt;</span>
		<span class="n">INFINIPATH_HWE_RXEMEMPARITYERR_SHIFT</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_eep_st_masks</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">errs_to_log</span> <span class="o">=</span> <span class="n">INFINIPATH_E_RESET</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">delay_mult</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* SDR, 4X, can&#39;t change */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_supported</span> <span class="o">=</span> <span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_supported</span> <span class="o">=</span> <span class="n">IPATH_IB_SDR</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_enabled</span> <span class="o">=</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_enabled</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_supported</span><span class="p">;</span>
	<span class="cm">/* these can&#39;t change for this chip, so set once */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_active</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_enabled</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_active</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_ht_init_hwerrors - enable hardware errors</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> *</span>
<span class="cm"> * now that we have finished initializing everything that might reasonably</span>
<span class="cm"> * cause a hardware error, and cleared those errors bits as they occur,</span>
<span class="cm"> * we can enable hardware errors in the mask (potentially enabling</span>
<span class="cm"> * freeze mode), and enable hardware errors as errors (along with</span>
<span class="cm"> * everything else) in errormask</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_init_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipath_err_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extsval</span><span class="p">;</span>

	<span class="n">extsval</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_extstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extsval</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_EXTS_MEMBIST_ENDTEST</span><span class="p">))</span>
		<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;MemBIST did not complete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extsval</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_EXTS_MEMBIST_CORRECT</span><span class="p">)</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;MemBIST corrected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ipath_check_htlink</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/* barring bugs, all hwerrors become interrupts, which can */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="cm">/* don&#39;t look at crc lane1 if 8 bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_8BIT_IN_HT0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">infinipath_hwe_htclnkabyte1crcerr</span><span class="p">;</span>
	<span class="cm">/* don&#39;t look at crc lane1 if 8 bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_8BIT_IN_HT1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">infinipath_hwe_htclnkbbyte1crcerr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable RXDSYNCMEMPARITY because external serdes is unused,</span>
<span class="cm">	 * and therefore the logic will never be used or initialized,</span>
<span class="cm">	 * and uninitialized state will normally result in this error</span>
<span class="cm">	 * being asserted.  Similarly for the external serdess pll</span>
<span class="cm">	 * lock signal.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span> <span class="o">|</span>
		 <span class="n">INFINIPATH_HWE_RXDSYNCMEMPARITYERR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable MISCERR4 because of an inversion in the HT core</span>
<span class="cm">	 * logic checking for errors that cause this bit to be set.</span>
<span class="cm">	 * The errata can also cause the protocol error bit to be set</span>
<span class="cm">	 * in the HT config space linkerror register(s).</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_HWE_HTCMISCERR4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * PLL ignored because unused MDIO interface has a logic problem</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_boardrev</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_boardrev</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_hwerrmask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/**</span>
<span class="cm"> * ipath_ht_bringup_serdes - bring up the serdes</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_bringup_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">config1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Trying to bringup serdes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrstatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;At start, serdes PLL failed bit set in &quot;</span>
			  <span class="s">&quot;hwerrstatus, clearing and continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_hwerrclear</span><span class="p">,</span>
				 <span class="n">INFINIPATH_HWE_SERDESPLLFAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">);</span>
	<span class="n">config1</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig1</span><span class="p">);</span>

	<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Initial serdes status is config0=%llx &quot;</span>
		   <span class="s">&quot;config1=%llx, sstatus=%llx xgxs %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">config1</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		   <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesstatus</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		   <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">));</span>

	<span class="cm">/* force reset on */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">INFINIPATH_SERDC0_RESET_PLL</span>
		<span class="cm">/* | INFINIPATH_SERDC0_RESET_MASK */</span>
		<span class="p">;</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>		<span class="cm">/* need pll reset set at least for a bit */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_SERDC0_RESET_PLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_SERDC0_RESET_PLL</span><span class="p">;</span>
		<span class="cm">/* set lane resets, and tx idle, during pll reset */</span>
		<span class="n">val2</span> <span class="o">|=</span> <span class="n">INFINIPATH_SERDC0_RESET_MASK</span> <span class="o">|</span>
			<span class="n">INFINIPATH_SERDC0_TXIDLE</span><span class="p">;</span>
		<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Clearing serdes PLL reset (writing &quot;</span>
			   <span class="s">&quot;%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">val2</span><span class="p">);</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">,</span>
				 <span class="n">val2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * be sure chip saw it</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_scratch</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * need pll reset clear at least 11 usec before lane</span>
<span class="cm">		 * resets cleared; give it a few more</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val2</span><span class="p">;</span>	<span class="cm">/* for check below */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INFINIPATH_SERDC0_RESET_PLL</span> <span class="o">|</span>
		   <span class="n">INFINIPATH_SERDC0_RESET_MASK</span> <span class="o">|</span>
		   <span class="n">INFINIPATH_SERDC0_TXIDLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_SERDC0_RESET_PLL</span> <span class="o">|</span>
			 <span class="n">INFINIPATH_SERDC0_RESET_MASK</span> <span class="o">|</span>
			 <span class="n">INFINIPATH_SERDC0_TXIDLE</span><span class="p">);</span>
		<span class="cm">/* clear them */</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">,</span>
				 <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_XGXS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* normally true after boot */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_XGXS_RESET</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">INFINIPATH_XGXS_RX_POL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">INFINIPATH_XGXS_RX_POL_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rx_pol_inv</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to compensate for Tx inversion in partner */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INFINIPATH_XGXS_RX_POL_MASK</span> <span class="o">&lt;&lt;</span>
		         <span class="n">INFINIPATH_XGXS_RX_POL_SHIFT</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rx_pol_inv</span> <span class="o">&lt;&lt;</span>
			<span class="n">INFINIPATH_XGXS_RX_POL_SHIFT</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">);</span>

	<span class="cm">/* clear current and de-emphasis bits */</span>
	<span class="n">config1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0ffffffff00ULL</span><span class="p">;</span>
	<span class="cm">/* set current to 20ma */</span>
	<span class="n">config1</span> <span class="o">|=</span> <span class="mh">0x00000000000ULL</span><span class="p">;</span>
	<span class="cm">/* set de-emphasis to -5.68dB */</span>
	<span class="n">config1</span> <span class="o">|=</span> <span class="mh">0x0cccc000000ULL</span><span class="p">;</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig1</span><span class="p">,</span> <span class="n">config1</span><span class="p">);</span>

	<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;After setup: serdes status is config0=%llx &quot;</span>
		   <span class="s">&quot;config1=%llx, sstatus=%llx xgxs %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">config1</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		   <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesstatus</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		   <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>		<span class="cm">/* for now, say we always succeeded */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_ht_quiet_serdes - set serdes to txidle</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * driver is being unloaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_quiet_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">INFINIPATH_SERDC0_TXIDLE</span><span class="p">;</span>
	<span class="n">ipath_dbg</span><span class="p">(</span><span class="s">&quot;Setting TxIdleEn on serdes (config0 = %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_serdesconfig0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_pe_put_tid - write a TID in chip</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @tidptr: pointer to the expected TID (in chip) to update</span>
<span class="cm"> * @tidtype: RCVHQ_RCV_TYPE_EAGER (1) for eager, RCVHQ_RCV_TYPE_EXPECTED (0) for expected</span>
<span class="cm"> * @pa: physical address of in memory buffer; ipath_tidinvalid if freeing</span>
<span class="cm"> *</span>
<span class="cm"> * This exists as a separate routine to allow for special locking etc.</span>
<span class="cm"> * It&#39;s used for both the full cleanup on exit, as well as the normal</span>
<span class="cm"> * setup and teardown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_put_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tidptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregbase</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidinvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INFINIPATH_RT_ADDR_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;physaddr %lx has more than &quot;</span>
				 <span class="s">&quot;40 bits, using only 40!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
			<span class="n">pa</span> <span class="o">&amp;=</span> <span class="n">INFINIPATH_RT_ADDR_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RCVHQ_RCV_TYPE_EAGER</span><span class="p">)</span>
			<span class="n">pa</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidtemplate</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* in words (fixed, full page).  */</span>
			<span class="n">u64</span> <span class="n">lenvalid</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">lenvalid</span> <span class="o">&lt;&lt;=</span> <span class="n">INFINIPATH_RT_BUFSIZE_SHIFT</span><span class="p">;</span>
			<span class="n">pa</span> <span class="o">|=</span> <span class="n">lenvalid</span> <span class="o">|</span> <span class="n">INFINIPATH_RT_VALID</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tidptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ipath_ht_clear_tid - clear all TID entries for a port, expected and eager</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @port: the port</span>
<span class="cm"> *</span>
<span class="cm"> * Used from ipath_close(), and at chip initialization.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_clear_tids</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tidbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregbase</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ipath_cdbg</span><span class="p">(</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="s">&quot;Invalidate TIDs for port %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * need to invalidate all of the expected TID entries for this</span>
<span class="cm">	 * port, so we don&#39;t have valid entries that might somehow get</span>
<span class="cm">	 * used (early in next use of this port, or through some bug)</span>
<span class="cm">	 */</span>
	<span class="n">tidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregbase</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvtidbase</span> <span class="o">+</span>
				   <span class="n">port</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvtidcnt</span> <span class="o">*</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tidbase</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvtidcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipath_ht_put_tid</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tidbase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RCVHQ_RCV_TYPE_EXPECTED</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidinvalid</span><span class="p">);</span>

	<span class="n">tidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregbase</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvegrbase</span> <span class="o">+</span>
				   <span class="n">port</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvegrcnt</span> <span class="o">*</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tidbase</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvegrcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipath_ht_put_tid</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tidbase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RCVHQ_RCV_TYPE_EAGER</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidinvalid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipath_ht_tidtemplate - setup constants for TID updates</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> *</span>
<span class="cm"> * We setup stuff that we use a lot, to avoid calculating each time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_tidtemplate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidtemplate</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ibmaxlen</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidtemplate</span> <span class="o">&lt;&lt;=</span> <span class="n">INFINIPATH_RT_BUFSIZE_SHIFT</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidtemplate</span> <span class="o">|=</span> <span class="n">INFINIPATH_RT_VALID</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * work around chip errata bug 7358, by marking invalid tids</span>
<span class="cm">	 * as having max length</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_tidinvalid</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span> <span class="o">&amp;</span> <span class="n">INFINIPATH_RT_BUFSIZE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">INFINIPATH_RT_BUFSIZE_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pioincr</span><span class="p">,</span> <span class="n">val32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * one cache line; long IB headers will spill over into received</span>
<span class="cm">	 * buffer</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvhdrentsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvhdrsize</span> <span class="o">=</span> <span class="n">IPATH_DFLT_RCVHDRSIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For HT, we allocate a somewhat overly large eager buffer,</span>
<span class="cm">	 * such that we can guarantee that we can receive the largest</span>
<span class="cm">	 * packet that we can send out.  To truly support a 4KB MTU,</span>
<span class="cm">	 * we need to bump this to a large value.  To date, other than</span>
<span class="cm">	 * testing, we have never encountered an HCA that can really</span>
<span class="cm">	 * send 4KB MTU packets, so we do not handle that (we&#39;ll get</span>
<span class="cm">	 * errors interrupts if we ever see one).</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvegrbufsize</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_piosize2k</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * the min() check here is currently a nop, but it may not</span>
<span class="cm">	 * always be, depending on just how we do ipath_rcvegrbufsize</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ibmaxlen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_piosize2k</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_rcvegrbufsize</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_init_ibmaxlen</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_ibmaxlen</span><span class="p">;</span>
	<span class="n">ipath_ht_tidtemplate</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * zero all the TID entries at startup.  We do this for sanity,</span>
<span class="cm">	 * in case of a previous driver crash of some kind, and also</span>
<span class="cm">	 * because the chip powers up with these memories in an unknown</span>
<span class="cm">	 * state.  Use portcnt, not cfgports, since this is for the</span>
<span class="cm">	 * full chip, not for current (possibly different) configuration</span>
<span class="cm">	 * value.</span>
<span class="cm">	 * Chip Errata bug 6447</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">val32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">val32</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_portcnt</span><span class="p">;</span> <span class="n">val32</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipath_ht_clear_tids</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">val32</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * write the pbc of each buffer, to be sure it&#39;s initialized, then</span>
<span class="cm">	 * cancel all the buffers, and also abort any packets that might</span>
<span class="cm">	 * have been in flight for some reason (the latter is for driver</span>
<span class="cm">	 * unload/reload, but isn&#39;t a bad idea at first init).	PIO send</span>
<span class="cm">	 * isn&#39;t enabled at this point, so there is no danger of sending</span>
<span class="cm">	 * these out on the wire.</span>
<span class="cm">	 * Chip Errata bug 6610</span>
<span class="cm">	 */</span>
	<span class="n">piobuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregbase</span><span class="p">))</span> <span class="o">+</span>
				  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_piobufbase</span><span class="p">);</span>
	<span class="n">pioincr</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_palign</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">piobuf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_piobcnt2k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * reasonable word count, just to init pbc</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="n">piobuf</span> <span class="o">+=</span> <span class="n">pioincr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipath_get_eeprom_info</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_boardrev</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Later production QHT7040 has same changes as QHT7140, so</span>
<span class="cm">		 * can use GPIO interrupts.  They have serial #&#39;s starting</span>
<span class="cm">		 * with 128, rather than 112.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_serial</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_serial</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;8&#39;</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_GPIO_INTR</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ipath_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Unsupported InfiniPath board &quot;</span>
				<span class="s">&quot;(serial number %.16s)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_serial</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_minrev</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Rev4+ reports extra errors via internal GPIO pins */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">|=</span> <span class="n">IPATH_GPIO_ERRINTRS</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_mask</span> <span class="o">|=</span> <span class="n">IPATH_GPIO_ERRINTR_MASK</span><span class="p">;</span>
		<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_gpio_mask</span><span class="p">,</span>
				 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_gpio_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ipath_init_ht_get_base_info - set chip-specific flags for user code</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> * @kbase: ipath_base_info pointer</span>
<span class="cm"> *</span>
<span class="cm"> * We set the PCIE flag because the lower bandwidth on PCIe vs</span>
<span class="cm"> * HyperTransport can affect some user packet algorithms.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_get_base_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_portdata</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipath_base_info</span> <span class="o">*</span><span class="n">kinfo</span> <span class="o">=</span> <span class="n">kbase</span><span class="p">;</span>

	<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">IPATH_RUNTIME_HT</span> <span class="o">|</span>
		<span class="n">IPATH_RUNTIME_PIO_REGSWAPPED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_dd</span><span class="o">-&gt;</span><span class="n">ipath_minrev</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">IPATH_RUNTIME_RCVHDR_COPY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_irq</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
	<span class="n">ht_destroy_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_irq</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_intconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipath_message_header</span> <span class="o">*</span>
<span class="nf">ipath_ht_get_msgheader</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">rhf_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipath_message_header</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">rhf_addr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_config_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">ushort</span> <span class="n">cfgports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_portcnt</span> <span class="o">=</span>
		<span class="n">ipath_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_portcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_p0_rcvegrcnt</span> <span class="o">=</span>
		<span class="n">ipath_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_rcvegrcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_read_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">infinipath_counters</span> <span class="o">*</span><span class="n">cntrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">LBIntCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">LBIntCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">LBFlowStallCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">LBFlowStallCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxSDmaDescCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxUnsupVLErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxUnsupVLErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxDataPktCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxDataPktCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxFlowPktCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxFlowPktCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxDwordCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxDwordCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxLenErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxLenErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxMaxMinLenErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxMaxMinLenErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxUnderrunCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxUnderrunCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxFlowStallCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxFlowStallCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">TxDroppedPktCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">TxDroppedPktCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxDroppedPktCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxDroppedPktCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxDataPktCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxDataPktCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxFlowPktCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxFlowPktCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxDwordCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxDwordCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxLenErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxLenErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxMaxMinLenErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxMaxMinLenErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxICRCErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxICRCErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxVCRCErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxVCRCErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxFlowCtrlErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxFlowCtrlErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxBadFormatCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxBadFormatCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxLinkProblemCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxLinkProblemCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxEBPCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxEBPCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxLPCRCErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxLPCRCErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxBufOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxBufOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxTIDFullErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxTIDFullErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxTIDValidErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxTIDValidErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxPKeyMismatchCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxPKeyMismatchCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP0HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP0HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP1HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP1HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP2HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP2HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP3HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP3HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP4HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP4HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP5HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP5HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP6HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP6HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP7HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP7HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP8HdrEgrOvflCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">RxP8HdrEgrOvflCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP9HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP10HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP11HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP12HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP13HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP14HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP15HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxP16HdrEgrOvflCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">IBStatusChangeCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBStatusChangeCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">IBLinkErrRecoveryCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBLinkErrRecoveryCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">IBLinkDownedCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBLinkDownedCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">IBSymbolErrCnt</span> <span class="o">=</span>
		<span class="n">ipath_snap_cntr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">IPATH_CREG_OFFSET</span><span class="p">(</span><span class="n">IBSymbolErrCnt</span><span class="p">));</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxVL15DroppedPktCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxOtherLocalPhyErrCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">PcieRetryBufDiagQwordCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">ExcessBufferOvflCnt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_overrun_thresh_errs</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">LocalLinkIntegrityErrCnt</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_flags</span> <span class="o">&amp;</span> <span class="n">IPATH_GPIO_ERRINTRS</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lli_errs</span> <span class="o">:</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_lli_errors</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxVlErrCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntrs</span><span class="o">-&gt;</span><span class="n">RxDlidFltrCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* no interrupt fallback for these chips */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_nointr_fallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * reset the XGXS (between serdes and IBC).  Slightly less intrusive</span>
<span class="cm"> * than resetting the IBC or external link state, and useful in some</span>
<span class="cm"> * cases to cause some retraining.  To do this right, we reset IBC</span>
<span class="cm"> * as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_xgxs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">;</span>

	<span class="n">prev_val</span> <span class="o">=</span> <span class="n">ipath_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">prev_val</span> <span class="o">|</span> <span class="n">INFINIPATH_XGXS_RESET</span><span class="p">;</span>
	<span class="n">prev_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INFINIPATH_XGXS_RESET</span><span class="p">;</span> <span class="cm">/* be sure */</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_control</span><span class="p">,</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INFINIPATH_C_LINKENABLE</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ipath_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_xgxsconfig</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">);</span>
	<span class="n">ipath_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_kregs</span><span class="o">-&gt;</span><span class="n">kr_control</span><span class="p">,</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_control</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_get_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPATH_IB_CFG_LWID</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_active</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPATH_IB_CFG_SPD</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_active</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPATH_IB_CFG_LWID_ENB</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPATH_IB_CFG_SPD_ENB</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* we assume range checking is already done, if needed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_set_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">IPATH_IB_CFG_LWID_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_width_enabled</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">IPATH_IB_CFG_SPD_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_link_speed_enabled</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipath_ht_config_jint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">a</span><span class="p">,</span> <span class="n">u16</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipath_ht_ib_updown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ibup</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipath_setup_ht_setextled</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ipath_ib_linkstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">),</span>
		<span class="n">ipath_ib_linktrstate</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ipath_init_iba6110_funcs - set up the chip-specific function pointers</span>
<span class="cm"> * @dd: the infinipath device</span>
<span class="cm"> *</span>
<span class="cm"> * This is global, and is called directly at init to set up the</span>
<span class="cm"> * chip-specific function pointers for later use.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ipath_init_iba6110_funcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipath_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_intrsetup</span> <span class="o">=</span> <span class="n">ipath_ht_intconfig</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_bus</span> <span class="o">=</span> <span class="n">ipath_setup_ht_config</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_reset</span> <span class="o">=</span> <span class="n">ipath_setup_ht_reset</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_get_boardname</span> <span class="o">=</span> <span class="n">ipath_ht_boardname</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_init_hwerrors</span> <span class="o">=</span> <span class="n">ipath_ht_init_hwerrors</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_early_init</span> <span class="o">=</span> <span class="n">ipath_ht_early_init</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_handle_hwerrors</span> <span class="o">=</span> <span class="n">ipath_ht_handle_hwerrors</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_quiet_serdes</span> <span class="o">=</span> <span class="n">ipath_ht_quiet_serdes</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_bringup_serdes</span> <span class="o">=</span> <span class="n">ipath_ht_bringup_serdes</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_clear_tids</span> <span class="o">=</span> <span class="n">ipath_ht_clear_tids</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_put_tid</span> <span class="o">=</span> <span class="n">ipath_ht_put_tid</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_cleanup</span> <span class="o">=</span> <span class="n">ipath_setup_ht_cleanup</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_setextled</span> <span class="o">=</span> <span class="n">ipath_setup_ht_setextled</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_get_base_info</span> <span class="o">=</span> <span class="n">ipath_ht_get_base_info</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_free_irq</span> <span class="o">=</span> <span class="n">ipath_ht_free_irq</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_tidtemplate</span> <span class="o">=</span> <span class="n">ipath_ht_tidtemplate</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_intr_fallback</span> <span class="o">=</span> <span class="n">ipath_ht_nointr_fallback</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_get_msgheader</span> <span class="o">=</span> <span class="n">ipath_ht_get_msgheader</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_config_ports</span> <span class="o">=</span> <span class="n">ipath_ht_config_ports</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_read_counters</span> <span class="o">=</span> <span class="n">ipath_ht_read_counters</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_xgxs_reset</span> <span class="o">=</span> <span class="n">ipath_ht_xgxs_reset</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_get_ib_cfg</span> <span class="o">=</span> <span class="n">ipath_ht_get_ib_cfg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_set_ib_cfg</span> <span class="o">=</span> <span class="n">ipath_ht_set_ib_cfg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_config_jint</span> <span class="o">=</span> <span class="n">ipath_ht_config_jint</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ipath_f_ib_updown</span> <span class="o">=</span> <span class="n">ipath_ht_ib_updown</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize chip-specific variables</span>
<span class="cm">	 */</span>
	<span class="n">ipath_init_ht_variables</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
