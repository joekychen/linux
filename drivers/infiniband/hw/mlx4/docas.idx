f | mlx4_ib.h | s | 10K | 318 | Sagi Grimberg | sagig@mellanox.co.il | 1339002483 |  | IB/mlx4: Fix max_wqe capacity reported from query device  1. Limit the max number of WQEs per QP reported when querying the    device, so that ib_create_qp() will not fail for a QP size that the    device claimed to support due to additional headroom WQEs being    allocated.  2. Limit qp resources accepted for ib_create_qp() to the limits    reported in ib_query_device().  In kernel space, make sure that the    limits returned to the caller following qp creation also lie within    the reported device limits. For userspace, report as before, and do    adjustment in libmlx4 (so as not to break ABI).  Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il> Signed-off-by: Sagi Grimberg <sagig@mellanox.co.il> Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com> Signed-off-by: Roland Dreier <roland@purestorage.com>
f | qp.c | s | 60K | 1857 | Sagi Grimberg | sagig@mellanox.co.il | 1339002483 |  | IB/mlx4: Fix max_wqe capacity reported from query device  1. Limit the max number of WQEs per QP reported when querying the    device, so that ib_create_qp() will not fail for a QP size that the    device claimed to support due to additional headroom WQEs being    allocated.  2. Limit qp resources accepted for ib_create_qp() to the limits    reported in ib_query_device().  In kernel space, make sure that the    limits returned to the caller following qp creation also lie within    the reported device limits. For userspace, report as before, and do    adjustment in libmlx4 (so as not to break ABI).  Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il> Signed-off-by: Sagi Grimberg <sagig@mellanox.co.il> Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com> Signed-off-by: Roland Dreier <roland@purestorage.com>
f | srq.c | s | 9.0K | 299 | Shlomo Pongratz | shlomop@mellanox.com | 1336503576 |  | IB/mlx4: Replace printk(KERN_yyy...) with pr_yyy(...)  Signed-off-by: Shlomo Pongratz <shlomop@mellanox.com>  [ Replace one more printk_once() with pr_info_once().  - Roland ]  Signed-off-by: Roland Dreier <roland@purestorage.com>
f | Makefile | g | 107B |  | Roland Dreier | rolandd@cisco.com | 1178672438 |  | IB/mlx4: Add a driver Mellanox ConnectX InfiniBand adapters  Add an InfiniBand driver for Mellanox ConnectX adapters.  Because these adapters can also be used as ethernet NICs and Fibre Channel HBAs, the driver is split into two modules:    mlx4_core: Handles low-level things like device initialization and     processing firmware commands.  Also controls resource allocation     so that the InfiniBand, ethernet and FC functions can share a     device without stepping on each other.    mlx4_ib: Handles InfiniBand-specific things; plugs into the     InfiniBand midlayer.  Signed-off-by: Roland Dreier <rolandd@cisco.com>
f | cq.c | s | 20K | 694 | Shlomo Pongratz | shlomop@mellanox.com | 1337385840 |  | IB/mlx4: Increase the number of vectors (EQs) available for ULPs  Enable IB ULPs to use a larger portion of the device EQs (which map to IRQs).  The mlx4_ib driver follows the mlx4_core framework of the EQs to be divided among the device ports.  In this scheme, for each IB port, the number of allocated EQs follows the number of cores, subject to other system constraints, such as number available MSI-X vectors.  Signed-off-by: Shlomo Pongratz <shlomop@mellanox.com> Signed-off-by: Roland Dreier <roland@purestorage.com>
f | ah.c | s | 6.1K | 171 | Or Gerlitz | ogerlitz@mellanox.com | 1325653202 |  | IB/mlx4: Fix SL to 802.1Q priority-bits mapping for IBoE  For IBoE, SLs 0-7 are mapped to Ethernet 802.1Q user priority bits (pbits) which are part of the VLAN tag, SLs 8-15 are reserved.  Under Ethernet, the ConnectX firmware treats (decode/encode) the four bit SL field in various constructs such as QPC / UD WQE / CQE as PPP0 and not as 0PPP. This correlates well to the fact that within the vlan tag the pbits are located in bits 15-13 and not 12-14.  The current code wasn't consistent around that area - the encoding was correct for the IBoE QPC.path.schedule_queue field, but was wrong for IBoE CQEs and when MLX header was built.  These inconsistencies resulted in wrong SL <--> wire 802.1Q pbits mapping, which is fixed by using SL <--> PPP0 all around the place.  Signed-off-by: Oren Duer <oren@mellanox.co.il> Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com> Signed-off-by: Roland Dreier <roland@purestorage.com>
f | doorbell.c | s | 2.8K | 83 | Arthur Kepner | akepner@sgi.com | 1209481572 |  | IB: expand ib_umem_get() prototype  Add a new parameter, dmasync, to the ib_umem_get() prototype.  Use dmasync = 1 when mapping user-allocated CQs with ib_umem_get().  Signed-off-by: Arthur Kepner <akepner@sgi.com> Cc: Tony Luck <tony.luck@intel.com> Cc: Jesse Barnes <jbarnes@virtuousgeek.org> Cc: Jes Sorensen <jes@sgi.com> Cc: Randy Dunlap <randy.dunlap@oracle.com> Cc: Roland Dreier <rdreier@cisco.com> Cc: James Bottomley <James.Bottomley@HansenPartnership.com> Cc: David Miller <davem@davemloft.net> Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org> Cc: Grant Grundler <grundler@parisc-linux.org> Cc: Michael Ellerman <michael@ellerman.id.au> Signed-off-by: Andrew Morton <akpm@linux-foundation.org> Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
f | user.h | s | 2.6K | 84 | Jack Morgenstein | jackm@dev.mellanox.co.il | 1217007172 |  | mlx4: Update/add Mellanox Technologies copyright lines to mlx4 driver files  Update existing Mellanox copyright lines to 2008, and add such lines to files where they are missing.  Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il> Signed-off-by: Roland Dreier <rolandd@cisco.com>
f | main.c | s | 38K | 1195 | Sagi Grimberg | sagig@mellanox.co.il | 1339002483 |  | IB/mlx4: Fix max_wqe capacity reported from query device  1. Limit the max number of WQEs per QP reported when querying the    device, so that ib_create_qp() will not fail for a QP size that the    device claimed to support due to additional headroom WQEs being    allocated.  2. Limit qp resources accepted for ib_create_qp() to the limits    reported in ib_query_device().  In kernel space, make sure that the    limits returned to the caller following qp creation also lie within    the reported device limits. For userspace, report as before, and do    adjustment in libmlx4 (so as not to break ABI).  Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il> Signed-off-by: Sagi Grimberg <sagig@mellanox.co.il> Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com> Signed-off-by: Roland Dreier <roland@purestorage.com>
f | mad.c | s | 12K | 366 | Jack Morgenstein | jackm@mellanox.com | 1327968917 |  | IB/mlx4: pass SMP vendor-specific attribute MADs to firmware  In the current code, vendor-specific MADs (e.g with the FDR-10 attribute) are silently dropped by the driver, resulting in timeouts at the sending side and inability to query/configure the relevant feature.  However, the ConnectX firmware is able to handle such MADs. For unsupported attributes, the firmware returns a GET_RESPONSE MAD containing an error status.  For example, for a FDR-10 node with LID 11:      # ibstat mlx4_0 1      CA: 'mlx4_0'     Port 1:     State: Active     Physical state: LinkUp     Rate: 40 (FDR10)     Base lid: 11     LMC: 0     SM lid: 24     Capability mask: 0x02514868     Port GUID: 0x0002c903002e65d1     Link layer: InfiniBand  Extended Port Query (EPI) vendor mad timeouts before the patch:      # smpquery MEPI 11 -d      ibwarn: [4196] smp_query_via: attr 0xff90 mod 0x0 route Lid 11     ibwarn: [4196] _do_madrpc: retry 1 (timeout 1000 ms)     ibwarn: [4196] _do_madrpc: retry 2 (timeout 1000 ms)     ibwarn: [4196] _do_madrpc: timeout after 3 retries, 3000 ms     ibwarn: [4196] mad_rpc: _do_madrpc failed; dport (Lid 11)     smpquery: iberror: [pid 4196] main: failed: operation EPI: ext port info query failed  EPI query works OK with the patch:      # smpquery MEPI 11 -d      ibwarn: [6548] smp_query_via: attr 0xff90 mod 0x0 route Lid 11     ibwarn: [6548] mad_rpc: data offs 64 sz 64     mad data     0000 0000 0000 0001 0000 0001 0000 0001     0000 0000 0000 0000 0000 0000 0000 0000     0000 0000 0000 0000 0000 0000 0000 0000     0000 0000 0000 0000 0000 0000 0000 0000     # Ext Port info: Lid 11 port 0     StateChangeEnable:...............0x00     LinkSpeedSupported:..............0x01     LinkSpeedEnabled:................0x01     LinkSpeedActive:.................0x01  Signed-off-by: Jack Morgenstein <jackm@mellanox.com> Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com> Acked-by: Ira Weiny <weiny2@llnl.gov> Cc: <stable@vger.kernel.org> Signed-off-by: Roland Dreier <roland@purestorage.com>
f | mr.c | s | 8.4K | 284 | Shlomo Pongratz | shlomop@mellanox.com | 1336503576 |  | IB/mlx4: Replace printk(KERN_yyy...) with pr_yyy(...)  Signed-off-by: Shlomo Pongratz <shlomop@mellanox.com>  [ Replace one more printk_once() with pr_info_once().  - Roland ]  Signed-off-by: Roland Dreier <roland@purestorage.com>
f | Kconfig | g | 382B |  | David S. Miller | davem@davemloft.net | 1313129105 |  | mlx4: Fix infiniband Kconfig dependencies.  Reported-by: Stephen Rothwell <sfr@canb.auug.org.au> Signed-off-by: David S. Miller <davem@davemloft.net>
