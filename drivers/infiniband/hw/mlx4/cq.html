<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › mlx4 › cq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2007 Cisco Systems, Inc. All rights reserved.</span>
<span class="cm"> * Copyright (c) 2007, 2008 Mellanox Technologies. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mlx4/cq.h&gt;</span>
<span class="cp">#include &lt;linux/mlx4/qp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;mlx4_ib.h&quot;</span>
<span class="cp">#include &quot;user.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_ib_cq_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_mibcq</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>
	<span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">comp_handler</span><span class="p">(</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">cq_context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_ib_cq_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">enum</span> <span class="n">mlx4_event</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MLX4_EVENT_TYPE_CQ_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unexpected event type %d &quot;</span>
		       <span class="s">&quot;on CQ %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibcq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_mibcq</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="p">.</span><span class="n">device</span>     <span class="o">=</span> <span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">event</span>      <span class="o">=</span> <span class="n">IB_EVENT_CQ_ERR</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">element</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="n">ibcq</span><span class="p">;</span>
		<span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">cq_context</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">get_cqe_from_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mlx4_buf_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cqe</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">get_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_cqe_from_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">get_sw_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_cqe</span> <span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OWNER_MASK</span><span class="p">)</span> <span class="o">^</span>
		<span class="o">!!</span><span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">cqe</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mlx4_cqe</span> <span class="o">*</span><span class="nf">next_cqe_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_sw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_ib_modify_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_count</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">mcq</span> <span class="o">=</span> <span class="n">to_mcq</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_mdev</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mlx4_cq_modify</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">,</span> <span class="n">cq_count</span><span class="p">,</span> <span class="n">cq_period</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_ib_alloc_cq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_ib_cq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_buf_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nent</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cqe</span><span class="p">),</span>
			     <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_mtt_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">npages</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">page_shift</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_buf_write_mtt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mtt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mtt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mtt:</span>
	<span class="n">mlx4_mtt_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mtt</span><span class="p">);</span>

<span class="nl">err_buf:</span>
	<span class="n">mlx4_buf_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nent</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cqe</span><span class="p">),</span>
			      <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_ib_free_cq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_ib_cq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlx4_buf_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">cqe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cqe</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_ib_get_cq_umem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mlx4_ib_cq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_umem</span> <span class="o">**</span><span class="n">umem</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">buf_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">umem</span> <span class="o">=</span> <span class="n">ib_umem_get</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span> <span class="n">cqe</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cqe</span><span class="p">),</span>
			    <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">umem</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">umem</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_mtt_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ib_umem_page_count</span><span class="p">(</span><span class="o">*</span><span class="n">umem</span><span class="p">),</span>
			    <span class="n">ilog2</span><span class="p">((</span><span class="o">*</span><span class="n">umem</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_umem_write_mtt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mtt</span><span class="p">,</span> <span class="o">*</span><span class="n">umem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mtt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mtt:</span>
	<span class="n">mlx4_mtt_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mtt</span><span class="p">);</span>

<span class="nl">err_buf:</span>
	<span class="n">ib_umem_release</span><span class="p">(</span><span class="o">*</span><span class="n">umem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="nf">mlx4_ib_create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vector</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_mdev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_uar</span> <span class="o">*</span><span class="n">uar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">entries</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_cqes</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">cq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">entries</span>      <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mlx4_ib_create_cq</span> <span class="n">ucmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ib_copy_from_udata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucmd</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ucmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_cq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_get_cq_umem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">,</span>
					  <span class="n">ucmd</span><span class="p">.</span><span class="n">buf_addr</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_cq</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_db_map_user</span><span class="p">(</span><span class="n">to_mucontext</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">ucmd</span><span class="p">.</span><span class="n">db_addr</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_mtt</span><span class="p">;</span>

		<span class="n">uar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_mucontext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">uar</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_db_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_cq</span><span class="p">;</span>

		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">set_ci_db</span>  <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">.</span><span class="n">db</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">arm_db</span>     <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">.</span><span class="n">db</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">set_ci_db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">arm_db</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_alloc_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_db</span><span class="p">;</span>

		<span class="n">uar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_uar</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">)</span>
		<span class="n">vector</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">eq_table</span><span class="p">[</span><span class="n">vector</span> <span class="o">%</span> <span class="n">ibdev</span><span class="o">-&gt;</span><span class="n">num_comp_vectors</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_cq_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">mtt</span><span class="p">,</span> <span class="n">uar</span><span class="p">,</span>
			    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dbmap</span><span class="p">;</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">comp</span>  <span class="o">=</span> <span class="n">mlx4_ib_cq_comp</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">mlx4_ib_cq_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_copy_to_udata</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cqn</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_dbmap</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>

<span class="nl">err_dbmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span>
		<span class="n">mlx4_ib_db_unmap_user</span><span class="p">(</span><span class="n">to_mucontext</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>

<span class="nl">err_mtt:</span>
	<span class="n">mlx4_mtt_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">mtt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span>
		<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mlx4_ib_free_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>

<span class="nl">err_db:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="n">mlx4_db_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>

<span class="nl">err_cq:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_alloc_resize_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_alloc_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_alloc_resize_umem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_resize_cq</span> <span class="n">ucmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_copy_from_udata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucmd</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ucmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_get_cq_umem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span><span class="p">,</span> <span class="n">ucmd</span><span class="p">.</span><span class="n">buf_addr</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_ib_get_outstanding_cqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">get_sw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">))</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_ib_cq_resize_copy_cqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="o">*</span><span class="n">new_cqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MLX4_CQE_OPCODE_RESIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_cqe</span> <span class="o">=</span> <span class="n">get_cqe_from_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">new_cqe</span><span class="p">,</span> <span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_cqe</span><span class="p">));</span>
		<span class="n">new_cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MLX4_CQE_OWNER_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="n">MLX4_CQE_OWNER_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="o">++</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_ib_resize_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_mdev</span><span class="p">(</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span> <span class="o">=</span> <span class="n">to_mcq</span><span class="p">(</span><span class="n">ibcq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_mtt</span> <span class="n">mtt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">outst_cqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">entries</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_cqes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">==</span> <span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">cqe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_alloc_resize_umem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">udata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Can&#39;t be smaller than the number of outstanding CQEs */</span>
		<span class="n">outst_cqe</span> <span class="o">=</span> <span class="n">mlx4_ib_get_outstanding_cqes</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="n">outst_cqe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_alloc_resize_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtt</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">mtt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_cq_resize</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">mtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_buf</span><span class="p">;</span>

	<span class="n">mlx4_mtt_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span>      <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">;</span>
		<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">umem</span>     <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mlx4_ib_cq_buf</span> <span class="n">tmp_buf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmp_cqe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlx4_ib_cq_resize_copy_cqes</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
			<span class="n">tmp_buf</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">tmp_cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">;</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span>      <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">;</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">);</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_cqe</span><span class="p">)</span>
			<span class="n">mlx4_ib_free_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_buf</span><span class="p">,</span> <span class="n">tmp_cqe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">err_buf:</span>
	<span class="n">mlx4_mtt_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">mtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="p">)</span>
		<span class="n">mlx4_ib_free_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
				    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">);</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_umem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_ib_destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_mdev</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">mcq</span> <span class="o">=</span> <span class="n">to_mcq</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>

	<span class="n">mlx4_cq_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">);</span>
	<span class="n">mlx4_mtt_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">mtt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlx4_ib_db_unmap_user</span><span class="p">(</span><span class="n">to_mucontext</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
		<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mlx4_ib_free_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>
		<span class="n">mlx4_db_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mcq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_cqe</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cqe</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CQE contents %08x %08x %08x %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
	       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
	       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mlx4_ib_handle_error_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_err_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">syndrome</span> <span class="o">==</span> <span class="n">MLX4_CQE_SYNDROME_LOCAL_QP_OP_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;local QP operation err &quot;</span>
		       <span class="s">&quot;(QPN %06x, WQE index %x, vendor syndrome %02x, &quot;</span>
		       <span class="s">&quot;opcode = %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">my_qpn</span><span class="p">),</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wqe_index</span><span class="p">),</span>
		       <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vendor_err_syndrome</span><span class="p">,</span>
		       <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MLX4_CQE_OWNER_MASK</span><span class="p">);</span>
		<span class="n">dump_cqe</span><span class="p">(</span><span class="n">cqe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">syndrome</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_LOCAL_LENGTH_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_LEN_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_LOCAL_QP_OP_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_QP_OP_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_LOCAL_PROT_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_PROT_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_WR_FLUSH_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_MW_BIND_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_MW_BIND_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_BAD_RESP_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_BAD_RESP_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_LOCAL_ACCESS_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_ACCESS_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_REMOTE_INVAL_REQ_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_REM_INV_REQ_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_REMOTE_ACCESS_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_REM_ACCESS_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_REMOTE_OP_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_REM_OP_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_TRANSPORT_RETRY_EXC_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_RETRY_EXC_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_RNR_RETRY_EXC_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_RNR_RETRY_EXC_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLX4_CQE_SYNDROME_REMOTE_ABORTED_ERR</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_REM_ABORT_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">vendor_err</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vendor_err_syndrome</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_ib_ipoib_csum_ok</span><span class="p">(</span><span class="n">__be16</span> <span class="n">status</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">checksum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">MLX4_CQE_STATUS_IPV4</span>      <span class="o">|</span>
				      <span class="n">MLX4_CQE_STATUS_IPV4F</span>     <span class="o">|</span>
				      <span class="n">MLX4_CQE_STATUS_IPV4OPT</span>   <span class="o">|</span>
				      <span class="n">MLX4_CQE_STATUS_IPV6</span>      <span class="o">|</span>
				      <span class="n">MLX4_CQE_STATUS_IPOK</span><span class="p">))</span> <span class="o">==</span>
		<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">MLX4_CQE_STATUS_IPV4</span>        <span class="o">|</span>
			    <span class="n">MLX4_CQE_STATUS_IPOK</span><span class="p">))</span>              <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">MLX4_CQE_STATUS_UDP</span>       <span class="o">|</span>
				      <span class="n">MLX4_CQE_STATUS_TCP</span><span class="p">))</span>     <span class="o">&amp;&amp;</span>
		<span class="n">checksum</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mlx4_ib_poll_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mlx4_ib_qp</span> <span class="o">**</span><span class="n">cur_qp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_qp</span> <span class="o">*</span><span class="n">mqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_send</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">g_mlpath_rqpn</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqe_ctr</span><span class="p">;</span>

<span class="nl">repoll:</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="n">next_cqe_sw</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure we read CQ entry contents after we&#39;ve checked the</span>
<span class="cm">	 * ownership bit.</span>
<span class="cm">	 */</span>
	<span class="n">rmb</span><span class="p">();</span>

	<span class="n">is_send</span>  <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_IS_SEND_MASK</span><span class="p">;</span>
	<span class="n">is_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">MLX4_CQE_OPCODE_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MLX4_OPCODE_NOP</span> <span class="o">&amp;&amp;</span>
		     <span class="n">is_send</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Completion for NOP opcode detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Resize CQ in progress */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MLX4_CQE_OPCODE_RESIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mlx4_ib_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_mdev</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>

			<span class="n">mlx4_ib_free_cq_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">buf</span>      <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">;</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span><span class="p">);</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">resize_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">repoll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">cur_qp</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_my_qpn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_QPN_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mqp</span><span class="p">.</span><span class="n">qpn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We do not have to take the QP table lock here,</span>
<span class="cm">		 * because CQs will be locked while QPs are removed</span>
<span class="cm">		 * from the table.</span>
<span class="cm">		 */</span>
		<span class="n">mqp</span> <span class="o">=</span> <span class="n">__mlx4_qp_lookup</span><span class="p">(</span><span class="n">to_mdev</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_my_qpn</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mqp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;CQ %06x with entry for unknown QPN %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cqn</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_my_qpn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_QPN_MASK</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">cur_qp</span> <span class="o">=</span> <span class="n">to_mibqp</span><span class="p">(</span><span class="n">mqp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_send</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sq_signal_bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wqe_ctr</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wqe_index</span><span class="p">);</span>
			<span class="n">wq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">wqe_ctr</span> <span class="o">-</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">wrid</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">wqe_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
		<span class="o">++</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">srq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srq</span> <span class="o">=</span> <span class="n">to_msrq</span><span class="p">((</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">srq</span><span class="p">);</span>
		<span class="n">wqe_ctr</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wqe_index</span><span class="p">);</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">wrid</span><span class="p">[</span><span class="n">wqe_ctr</span><span class="p">];</span>
		<span class="n">mlx4_ib_free_srq_wqe</span><span class="p">(</span><span class="n">srq</span><span class="p">,</span> <span class="n">wqe_ctr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wq</span>	  <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">wrid</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">wqe_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
		<span class="o">++</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlx4_ib_handle_error_cqe</span><span class="p">((</span><span class="k">struct</span> <span class="n">mlx4_err_cqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">,</span> <span class="n">wc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_send</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_RDMA_WRITE_IMM</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">|=</span> <span class="n">IB_WC_WITH_IMM</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_RDMA_WRITE</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_RDMA_WRITE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_SEND_IMM</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">|=</span> <span class="n">IB_WC_WITH_IMM</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_SEND</span>:
		<span class="k">case</span> <span class="n">MLX4_OPCODE_SEND_INVAL</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_SEND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_RDMA_READ</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_RDMA_READ</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_ATOMIC_CS</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_COMP_SWAP</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_ATOMIC_FA</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_FETCH_ADD</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_MASKED_ATOMIC_CS</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_MASKED_COMP_SWAP</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_MASKED_ATOMIC_FA</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_MASKED_FETCH_ADD</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_BIND_MW</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_BIND_MW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_LSO</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_LSO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_FMR</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_FAST_REG_MR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_OPCODE_LOCAL_INVAL</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>    <span class="o">=</span> <span class="n">IB_WC_LOCAL_INV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OPCODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MLX4_RECV_OPCODE_RDMA_WRITE_IMM</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>	<span class="o">=</span> <span class="n">IB_WC_RECV_RDMA_WITH_IMM</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span>	<span class="o">=</span> <span class="n">IB_WC_WITH_IMM</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">imm_data</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immed_rss_invalid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_RECV_OPCODE_SEND_INVAL</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>	<span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span>	<span class="o">=</span> <span class="n">IB_WC_WITH_INVALIDATE</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immed_rss_invalid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_RECV_OPCODE_SEND</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>   <span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MLX4_RECV_OPCODE_SEND_IMM</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span>	<span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span>	<span class="o">=</span> <span class="n">IB_WC_WITH_IMM</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">imm_data</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immed_rss_invalid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">slid</span>	   <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">rlid</span><span class="p">);</span>
		<span class="n">g_mlpath_rqpn</span>	   <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">g_mlpath_rqpn</span><span class="p">);</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">src_qp</span>	   <span class="o">=</span> <span class="n">g_mlpath_rqpn</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">dlid_path_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_mlpath_rqpn</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span>	  <span class="o">|=</span> <span class="n">g_mlpath_rqpn</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span> <span class="o">?</span> <span class="n">IB_WC_GRH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">pkey_index</span>     <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">immed_rss_invalid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span>	  <span class="o">|=</span> <span class="n">mlx4_ib_ipoib_csum_ok</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
					<span class="n">cqe</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">)</span> <span class="o">?</span> <span class="n">IB_WC_IP_CSUM_OK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdma_port_get_link_layer</span><span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="p">(</span><span class="o">*</span><span class="n">cur_qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">IB_LINK_LAYER_ETHERNET</span><span class="p">)</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">sl</span>  <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">sl_vid</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">sl</span>  <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">sl_vid</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_ib_poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span> <span class="o">=</span> <span class="n">to_mcq</span><span class="p">(</span><span class="n">ibcq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlx4_ib_qp</span> <span class="o">*</span><span class="n">cur_qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">npolled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">npolled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">npolled</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="o">++</span><span class="n">npolled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mlx4_ib_poll_one</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_qp</span><span class="p">,</span> <span class="n">wc</span> <span class="o">+</span> <span class="n">npolled</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlx4_cq_set_ci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">npolled</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mlx4_ib_arm_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_cq_notify_flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlx4_cq_arm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_mcq</span><span class="p">(</span><span class="n">ibcq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IB_CQ_SOLICITED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IB_CQ_SOLICITED</span> <span class="o">?</span>
		    <span class="n">MLX4_CQ_DB_REQ_NOT_SOL</span> <span class="o">:</span> <span class="n">MLX4_CQ_DB_REQ_NOT</span><span class="p">,</span>
		    <span class="n">to_mdev</span><span class="p">(</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">uar_map</span><span class="p">,</span>
		    <span class="n">MLX4_GET_DOORBELL_LOCK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_mdev</span><span class="p">(</span><span class="n">ibcq</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">uar_lock</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__mlx4_ib_cq_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_ib_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">prod_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nfreed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlx4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">owner_bit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First we need to find the current producer index, so we</span>
<span class="cm">	 * know where to start cleaning from.  It doesn&#39;t matter if HW</span>
<span class="cm">	 * adds new entries after this loop -- the QP we&#39;re worried</span>
<span class="cm">	 * about is already in RESET, so the new entries won&#39;t come</span>
<span class="cm">	 * from our QP and therefore don&#39;t need to be checked.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">prod_index</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span><span class="p">;</span> <span class="n">get_sw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">prod_index</span><span class="p">);</span> <span class="o">++</span><span class="n">prod_index</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prod_index</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span> <span class="o">+</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now sweep backwards through the CQ, removing CQ entries</span>
<span class="cm">	 * that match our QP by copying older entries on top of them.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="o">--</span><span class="n">prod_index</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">prod_index</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_my_qpn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_QPN_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">qpn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srq</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_IS_SEND_MASK</span><span class="p">))</span>
				<span class="n">mlx4_ib_free_srq_wqe</span><span class="p">(</span><span class="n">srq</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wqe_index</span><span class="p">));</span>
			<span class="o">++</span><span class="n">nfreed</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nfreed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="p">(</span><span class="n">prod_index</span> <span class="o">+</span> <span class="n">nfreed</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
			<span class="n">owner_bit</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="n">MLX4_CQE_OWNER_MASK</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">cqe</span><span class="p">);</span>
			<span class="n">dest</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">=</span> <span class="n">owner_bit</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">owner_sr_opcode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MLX4_CQE_OWNER_MASK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfreed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cons_index</span> <span class="o">+=</span> <span class="n">nfreed</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure update of buffer contents is done before</span>
<span class="cm">		 * updating consumer index.</span>
<span class="cm">		 */</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">mlx4_cq_set_ci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mlx4_ib_cq_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">mlx4_ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mlx4_ib_srq</span> <span class="o">*</span><span class="n">srq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__mlx4_ib_cq_clean</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">qpn</span><span class="p">,</span> <span class="n">srq</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
