<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › provider.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>provider.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;rdma/iw_cm.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_smi.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_umem.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_user_verbs.h&gt;</span>

<span class="cp">#include &quot;iw_cxgb4.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fastreg_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fastreg_support</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fastreg_support</span><span class="p">,</span> <span class="s">&quot;Advertise fastreg support (default=1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ib_ah</span> <span class="o">*</span><span class="nf">c4iw_ah_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ib_ah_attr</span> <span class="o">*</span><span class="n">ah_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_ah_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_ah</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_multicast_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">gid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_multicast_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">gid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_process_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mad_flags</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">in_wc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ib_grh</span> <span class="o">*</span><span class="n">in_grh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_mad</span> <span class="o">*</span><span class="n">in_mad</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ib_mad</span> <span class="o">*</span><span class="n">out_mad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_dealloc_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span> <span class="o">=</span> <span class="n">to_c4iw_ucontext</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s context %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmaps</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="n">c4iw_release_dev_ucontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ucontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="nf">c4iw_alloc_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>
	<span class="n">context</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">c4iw_init_dev_ucontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">uctx</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">mmaps</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">ibucontext</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s pgoff 0x%lx key 0x%x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">,</span>
	     <span class="n">key</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">ucontext</span> <span class="o">=</span> <span class="n">to_c4iw_ucontext</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

	<span class="n">mm</span> <span class="o">=</span> <span class="n">remove_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * MA_SYNC register...</span>
<span class="cm">		 */</span>
		<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">pgprot_noncached</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">io_remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
					 <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
					 <span class="n">len</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Map user DB or OCQP memory...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">oc_mw_pa</span><span class="p">)</span>
			<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">t4_pgprot_wc</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">pgprot_noncached</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">io_remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
					 <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
					 <span class="n">len</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Map WQ or CQ contig dma memory...</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
				      <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
				      <span class="n">len</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_deallocate_pd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>

	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibpd %p pdid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">);</span>
	<span class="n">c4iw_put_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">pdid_table</span><span class="p">,</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">pd</span><span class="p">.</span><span class="n">cur</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">php</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="nf">c4iw_allocate_pd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ibdev</span><span class="p">;</span>
	<span class="n">pdid</span> <span class="o">=</span>  <span class="n">c4iw_get_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">pdid_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">php</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">php</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">php</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c4iw_put_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">pdid_table</span><span class="p">,</span> <span class="n">pdid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_copy_to_udata</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">c4iw_deallocate_pd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">php</span><span class="o">-&gt;</span><span class="n">ibpd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">pd</span><span class="p">.</span><span class="n">cur</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">pd</span><span class="p">.</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">pd</span><span class="p">.</span><span class="n">max</span><span class="p">)</span>
		<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">pd</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">pd</span><span class="p">.</span><span class="n">cur</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s pdid 0x%0x ptr 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">php</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">php</span><span class="o">-&gt;</span><span class="n">ibpd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_query_pkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="o">*</span><span class="n">pkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_query_gid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">ib_gid</span> <span class="o">*</span><span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibdev %p, port %d, index %d, gid %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_query_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="o">*</span><span class="n">props</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">props</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">sys_image_guid</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">hw_ver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">adapter_type</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">page_size_cap</span> <span class="o">=</span> <span class="n">T4_PAGESIZE_MASK</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">vendor_part_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mr_size</span> <span class="o">=</span> <span class="n">T4_MAX_MR_SIZE</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp</span> <span class="o">=</span> <span class="n">T4_MAX_NUM_QP</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_wr</span> <span class="o">=</span> <span class="n">T4_MAX_QP_DEPTH</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_sge</span> <span class="o">=</span> <span class="n">T4_MAX_RECV_SGE</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_sge_rd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_rd_atom</span> <span class="o">=</span> <span class="n">c4iw_max_read_depth</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_qp_init_rd_atom</span> <span class="o">=</span> <span class="n">c4iw_max_read_depth</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_cq</span> <span class="o">=</span> <span class="n">T4_MAX_NUM_CQ</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_cqe</span> <span class="o">=</span> <span class="n">T4_MAX_CQ_DEPTH</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mr</span> <span class="o">=</span> <span class="n">c4iw_num_stags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_pd</span> <span class="o">=</span> <span class="n">T4_MAX_NUM_PD</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">local_ca_ack_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_fast_reg_page_list_len</span> <span class="o">=</span> <span class="n">T4_MAX_FR_DEPTH</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_query_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_port_attr</span> <span class="o">*</span><span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">inetdev</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ibdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_port_attr</span><span class="p">));</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_4096</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_4096</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_2048</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_1024</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_512</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_256</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_DOWN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">inetdev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inetdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inetdev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">)</span>
				<span class="n">props</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_ACTIVE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">props</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_INIT</span><span class="p">;</span>
			<span class="n">in_dev_put</span><span class="p">(</span><span class="n">inetdev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">props</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_INIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">props</span><span class="o">-&gt;</span><span class="n">port_cap_flags</span> <span class="o">=</span>
	    <span class="n">IB_PORT_CM_SUP</span> <span class="o">|</span>
	    <span class="n">IB_PORT_SNMP_TUNNEL_SUP</span> <span class="o">|</span>
	    <span class="n">IB_PORT_REINIT_SUP</span> <span class="o">|</span>
	    <span class="n">IB_PORT_DEVICE_MGMT_SUP</span> <span class="o">|</span>
	    <span class="n">IB_PORT_VENDOR_CLASS_SUP</span> <span class="o">|</span> <span class="n">IB_PORT_BOOT_MGMT_SUP</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">gid_tbl_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">pkey_tbl_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">IB_SPEED_DDR</span><span class="p">;</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">c4iw_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev</span><span class="p">,</span>
						 <span class="n">ibdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s dev 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">adapter_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">c4iw_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev</span><span class="p">,</span>
						 <span class="n">ibdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s dev 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FW_HDR_FW_VER_MAJOR_GET</span><span class="p">(</span><span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MINOR_GET</span><span class="p">(</span><span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MICRO_GET</span><span class="p">(</span><span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_BUILD_GET</span><span class="p">(</span><span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_hca</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">c4iw_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev</span><span class="p">,</span>
						 <span class="n">ibdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">lldev</span> <span class="o">=</span> <span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s dev 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">lldev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span><span class="o">-&gt;</span><span class="n">get_drvinfo</span><span class="p">(</span><span class="n">lldev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">c4iw_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev</span><span class="p">,</span>
						 <span class="n">ibdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s dev 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_get_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">rdma_protocol_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tp_tcp_stats</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">c4iw_dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>

	<span class="n">cxgb4_get_tcp_stats</span><span class="p">(</span><span class="n">c4iw_dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">iw</span><span class="p">.</span><span class="n">tcpInSegs</span> <span class="o">=</span> <span class="n">v4</span><span class="p">.</span><span class="n">tcpInSegs</span> <span class="o">+</span> <span class="n">v6</span><span class="p">.</span><span class="n">tcpInSegs</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">iw</span><span class="p">.</span><span class="n">tcpOutSegs</span> <span class="o">=</span> <span class="n">v4</span><span class="p">.</span><span class="n">tcpOutSegs</span> <span class="o">+</span> <span class="n">v6</span><span class="p">.</span><span class="n">tcpOutSegs</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">iw</span><span class="p">.</span><span class="n">tcpRetransSegs</span> <span class="o">=</span> <span class="n">v4</span><span class="p">.</span><span class="n">tcpRetransSegs</span> <span class="o">+</span> <span class="n">v6</span><span class="p">.</span><span class="n">tcpRetransSegs</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">iw</span><span class="p">.</span><span class="n">tcpOutRsts</span> <span class="o">=</span> <span class="n">v4</span><span class="p">.</span><span class="n">tcpOutRsts</span> <span class="o">+</span> <span class="n">v6</span><span class="p">.</span><span class="n">tcpOutSegs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hw_rev</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_rev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fw_ver</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fw_ver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hca_type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_hca</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_board</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">c4iw_class_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hw_rev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fw_ver</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hca_type</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">c4iw_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s c4iw_dev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cxgb4_%d&quot;</span><span class="p">,</span> <span class="n">IB_DEVICE_NAME_MAX</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_guid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_guid</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_guid</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">=</span> <span class="n">IB_DEVICE_LOCAL_DMA_LKEY</span> <span class="o">|</span> <span class="n">IB_DEVICE_MEM_WINDOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fastreg_support</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_cap_flags</span> <span class="o">|=</span> <span class="n">IB_DEVICE_MEM_MGT_EXTENSIONS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">local_dma_lkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">uverbs_cmd_mask</span> <span class="o">=</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_GET_CONTEXT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_QUERY_DEVICE</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_QUERY_PORT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_ALLOC_PD</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_DEALLOC_PD</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_REG_MR</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_DEREG_MR</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_CREATE_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_DESTROY_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_REQ_NOTIFY_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_CREATE_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_MODIFY_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_QUERY_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_POLL_CQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_DESTROY_QP</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_POST_SEND</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">IB_USER_VERBS_CMD_POST_RECV</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_type</span> <span class="o">=</span> <span class="n">RDMA_NODE_RNIC</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">node_desc</span><span class="p">,</span> <span class="n">C4IW_NODE_DESC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">C4IW_NODE_DESC</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">phys_port_cnt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">num_comp_vectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dma_device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_device</span> <span class="o">=</span> <span class="n">c4iw_query_device</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_port</span> <span class="o">=</span> <span class="n">c4iw_query_port</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_pkey</span> <span class="o">=</span> <span class="n">c4iw_query_pkey</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_gid</span> <span class="o">=</span> <span class="n">c4iw_query_gid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_ucontext</span> <span class="o">=</span> <span class="n">c4iw_alloc_ucontext</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dealloc_ucontext</span> <span class="o">=</span> <span class="n">c4iw_dealloc_ucontext</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">c4iw_mmap</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_pd</span> <span class="o">=</span> <span class="n">c4iw_allocate_pd</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dealloc_pd</span> <span class="o">=</span> <span class="n">c4iw_deallocate_pd</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_ah</span> <span class="o">=</span> <span class="n">c4iw_ah_create</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_ah</span> <span class="o">=</span> <span class="n">c4iw_ah_destroy</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_qp</span> <span class="o">=</span> <span class="n">c4iw_create_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">modify_qp</span> <span class="o">=</span> <span class="n">c4iw_ib_modify_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">query_qp</span> <span class="o">=</span> <span class="n">c4iw_ib_query_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_qp</span> <span class="o">=</span> <span class="n">c4iw_destroy_qp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">create_cq</span> <span class="o">=</span> <span class="n">c4iw_create_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">destroy_cq</span> <span class="o">=</span> <span class="n">c4iw_destroy_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">resize_cq</span> <span class="o">=</span> <span class="n">c4iw_resize_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">poll_cq</span> <span class="o">=</span> <span class="n">c4iw_poll_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">get_dma_mr</span> <span class="o">=</span> <span class="n">c4iw_get_dma_mr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">reg_phys_mr</span> <span class="o">=</span> <span class="n">c4iw_register_phys_mem</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">rereg_phys_mr</span> <span class="o">=</span> <span class="n">c4iw_reregister_phys_mem</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">reg_user_mr</span> <span class="o">=</span> <span class="n">c4iw_reg_user_mr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dereg_mr</span> <span class="o">=</span> <span class="n">c4iw_dereg_mr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_mw</span> <span class="o">=</span> <span class="n">c4iw_alloc_mw</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">bind_mw</span> <span class="o">=</span> <span class="n">c4iw_bind_mw</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dealloc_mw</span> <span class="o">=</span> <span class="n">c4iw_dealloc_mw</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_fast_reg_mr</span> <span class="o">=</span> <span class="n">c4iw_alloc_fast_reg_mr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">alloc_fast_reg_page_list</span> <span class="o">=</span> <span class="n">c4iw_alloc_fastreg_pbl</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">free_fast_reg_page_list</span> <span class="o">=</span> <span class="n">c4iw_free_fastreg_pbl</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">attach_mcast</span> <span class="o">=</span> <span class="n">c4iw_multicast_attach</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">detach_mcast</span> <span class="o">=</span> <span class="n">c4iw_multicast_detach</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">process_mad</span> <span class="o">=</span> <span class="n">c4iw_process_mad</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">req_notify_cq</span> <span class="o">=</span> <span class="n">c4iw_arm_cq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">post_send</span> <span class="o">=</span> <span class="n">c4iw_post_send</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">post_recv</span> <span class="o">=</span> <span class="n">c4iw_post_receive</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">get_protocol_stats</span> <span class="o">=</span> <span class="n">c4iw_get_mib</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">uverbs_abi_ver</span> <span class="o">=</span> <span class="n">C4IW_UVERBS_ABI_VERSION</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_verbs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="n">c4iw_connect</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">accept</span> <span class="o">=</span> <span class="n">c4iw_accept_cr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">reject</span> <span class="o">=</span> <span class="n">c4iw_reject_cr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">create_listen</span> <span class="o">=</span> <span class="n">c4iw_create_listen</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">destroy_listen</span> <span class="o">=</span> <span class="n">c4iw_destroy_listen</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">add_ref</span> <span class="o">=</span> <span class="n">c4iw_qp_add_ref</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">rem_ref</span> <span class="o">=</span> <span class="n">c4iw_qp_rem_ref</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="o">-&gt;</span><span class="n">get_qp</span> <span class="o">=</span> <span class="n">c4iw_get_qp</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">c4iw_class_attributes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">c4iw_class_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bail2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bail2:</span>
	<span class="n">ib_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">);</span>
<span class="nl">bail1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">c4iw_unregister_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s c4iw_dev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">c4iw_class_attributes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">c4iw_class_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">ib_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ibdev</span><span class="p">.</span><span class="n">iwcm</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
