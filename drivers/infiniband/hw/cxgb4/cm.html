<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › cm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer in the documentation and/or other materials</span>
<span class="cm"> *	  provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>

<span class="cp">#include &lt;net/neighbour.h&gt;</span>
<span class="cp">#include &lt;net/netevent.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>

<span class="cp">#include &quot;iw_cxgb4.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;listen&quot;</span><span class="p">,</span>
	<span class="s">&quot;connecting&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_wait_req&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_req_sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_req_rcvd&quot;</span><span class="p">,</span>
	<span class="s">&quot;mpa_rep_sent&quot;</span><span class="p">,</span>
	<span class="s">&quot;fpdu_mode&quot;</span><span class="p">,</span>
	<span class="s">&quot;aborting&quot;</span><span class="p">,</span>
	<span class="s">&quot;closing&quot;</span><span class="p">,</span>
	<span class="s">&quot;moribund&quot;</span><span class="p">,</span>
	<span class="s">&quot;dead&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dack_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dack_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dack_mode</span><span class="p">,</span> <span class="s">&quot;Delayed ack mode (default=1)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">c4iw_max_read_depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">c4iw_max_read_depth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">c4iw_max_read_depth</span><span class="p">,</span> <span class="s">&quot;Per-connection max ORD/IRD (default=8)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_tcp_timestamps</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_tcp_timestamps</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_tcp_timestamps</span><span class="p">,</span> <span class="s">&quot;Enable tcp timestamps (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_tcp_sack</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_tcp_sack</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_tcp_sack</span><span class="p">,</span> <span class="s">&quot;Enable tcp SACK (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_tcp_window_scaling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_tcp_window_scaling</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_tcp_window_scaling</span><span class="p">,</span>
		 <span class="s">&quot;Enable tcp window scaling (default=1)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">c4iw_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">c4iw_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">c4iw_debug</span><span class="p">,</span> <span class="s">&quot;Enable debug logging (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">peer2peer</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">peer2peer</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">peer2peer</span><span class="p">,</span> <span class="s">&quot;Support peer2peer ULPs (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">p2p_type</span> <span class="o">=</span> <span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">p2p_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">p2p_type</span><span class="p">,</span> <span class="s">&quot;RDMAP opcode to use for the RTR message: &quot;</span>
			   <span class="s">&quot;1=RDMA_READ 0=RDMA_WRITE (default 1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ep_timeout_secs</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ep_timeout_secs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ep_timeout_secs</span><span class="p">,</span> <span class="s">&quot;CM Endpoint operation timeout &quot;</span>
				   <span class="s">&quot;in seconds (default=60)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpa_rev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpa_rev</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpa_rev</span><span class="p">,</span> <span class="s">&quot;MPA Revision, 0 supports amso1100, &quot;</span>
		<span class="s">&quot;1 is RFC0544 spec compliant, 2 is IETF MPA Peer Connect Draft&quot;</span>
		<span class="s">&quot; compliant (default=1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">markers_enabled</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">markers_enabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">markers_enabled</span><span class="p">,</span> <span class="s">&quot;Enable MPA MARKERS (default(0)=disabled)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">crc_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="s">&quot;Enable MPA CRC (default(1)=enabled)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rcv_win</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">,</span> <span class="s">&quot;TCP receive window in bytes (default=256KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_win</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">snd_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">snd_win</span><span class="p">,</span> <span class="s">&quot;TCP send window in bytes (default=128KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">workq</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">rxq</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">get_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ep_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">connect_reply_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">timeout_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">timeout_lock</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_ep_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s stopped / restarted timer ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ep_timeout_secs</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ep_timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_ep_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s timer stopped when its not running! &quot;</span>
		       <span class="s">&quot;ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_l2t_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c4iw_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - device in error state - dropping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cxgb4_l2t_send</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="p">,</span> <span class="n">l2e</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">error</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_ofld_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c4iw_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - device in error state - dropping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">error</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hwtid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_tid_release</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_TID_RELEASE</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">));</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_emss</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">mtus</span><span class="p">[</span><span class="n">GET_TCPOPT_MSS</span><span class="p">(</span><span class="n">opt</span><span class="p">)]</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_TCPOPT_TSTAMP</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s mss_idx %u mss %u emss=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">GET_TCPOPT_MSS</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">c4iw_ep_state</span> <span class="nf">state_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">c4iw_ep_state</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">epc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">c4iw_ep_state</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">epc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">c4iw_ep_state</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - %s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="n">new</span><span class="p">]);</span>
	<span class="n">__state_set</span><span class="p">(</span><span class="n">epc</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_ep</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="o">*</span><span class="n">epc</span><span class="p">;</span>

	<span class="n">epc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epc</span><span class="o">-&gt;</span><span class="n">wr_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s alloc ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">epc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_c4iw_free_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_ep</span><span class="p">,</span> <span class="n">com</span><span class="p">.</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RELEASE_RESOURCES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgb4_remove_tid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">cxgb4_l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_ep_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RELEASE_RESOURCES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status2errno</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_NONE</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_ARP_MISS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_TIMEDOUT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_TCAM_FULL</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_EXIST</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try and reuse skbs already allocated...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">get_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">find_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">local_ip</span><span class="p">,</span>
				 <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">local_port</span><span class="p">,</span>
				 <span class="n">__be16</span> <span class="n">peer_port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">local_ip</span><span class="p">,</span>
				   <span class="n">peer_port</span><span class="p">,</span> <span class="n">local_port</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
				   <span class="n">tos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arp_failure_discard</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s c4iw_dev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle an ARP failure for an active open.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">act_open_req_arp_failure</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;ARP failure duing connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle an ARP failure for a CPL_ABORT_REQ.  Change it into a no RST variant</span>
<span class="cm"> * and send it along.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_arp_failure</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s rdev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>
	<span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_flowc</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flowclen</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_flowc_wr</span> <span class="o">*</span><span class="n">flowc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">flowclen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">flowc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_flowc_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">flowclen</span><span class="p">);</span>

	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">op_to_nparams</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_FLOWC_WR</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">FW_FLOWC_WR_NPARAMS</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">flowclen</span><span class="p">,</span>
					  <span class="mi">16</span><span class="p">))</span> <span class="o">|</span> <span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>

	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_PFNVFN</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_CH</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_PORT</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_IQID</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_SNDNXT</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_RCVNXT</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_SNDBUF</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">snd_win</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_MSS</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">emss</span><span class="p">);</span>
	<span class="cm">/* Pad WR to 16 byte boundary */</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>
	<span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_halfclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_CLOSE_CON_REQ</span><span class="p">,</span>
						    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">abort_arp_failure</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_REQ</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_SEND_RST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">opt0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wscale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p atid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ctrlq_idx</span><span class="p">);</span>

	<span class="n">cxgb4_best_mtu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">mtus</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtu_idx</span><span class="p">);</span>
	<span class="n">wscale</span> <span class="o">=</span> <span class="n">compute_wscale</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">);</span>
	<span class="n">opt0</span> <span class="o">=</span> <span class="n">KEEP_ALIVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DELACK</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">WND_SCALE</span><span class="p">(</span><span class="n">wscale</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">MSS_IDX</span><span class="p">(</span><span class="n">mtu_idx</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">L2T_IDX</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">TX_CHAN</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">SMAC_SEL</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DSCP</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">ULP_MODE</span><span class="p">(</span><span class="n">ULP_MODE_TCPDDP</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">RCV_BUFSIZ</span><span class="p">(</span><span class="n">rcv_win</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">opt2</span> <span class="o">=</span> <span class="n">RX_CHANNEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">RSS_QUEUE_VALID</span> <span class="o">|</span> <span class="n">RSS_QUEUE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_tcp_timestamps</span><span class="p">)</span>
		<span class="n">opt2</span> <span class="o">|=</span> <span class="n">TSTAMPS_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_tcp_sack</span><span class="p">)</span>
		<span class="n">opt2</span> <span class="o">|=</span> <span class="n">SACK_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wscale</span> <span class="o">&amp;&amp;</span> <span class="n">enable_tcp_window_scaling</span><span class="p">)</span>
		<span class="n">opt2</span> <span class="o">|=</span> <span class="n">WND_SCALE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">act_open_req_arp_failure</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ACT_OPEN_REQ</span><span class="p">,</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">)</span><span class="o">|</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">)));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">opt0</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt2</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">opt2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_mpa_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">mpa_rev_to_use</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpalen</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="n">mpa_v2_params</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u pd_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="n">mpalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_rev_to_use</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mpalen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
	<span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">op_to_immdlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_OFLD_TX_DATA_WR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_IMMDLEN</span><span class="p">(</span><span class="n">mpalen</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">wrlen</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mpalen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tunnel_to_proxy</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_OFLD_TX_DATA_WR_FLUSH</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_OFLD_TX_DATA_WR_SHOVE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc_enabled</span> <span class="o">?</span> <span class="n">MPA_CRC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">markers_enabled</span> <span class="o">?</span> <span class="n">MPA_MARKERS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">mpa_rev_to_use</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">MPA_ENHANCED_RDMA_CONN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">mpa_rev_to_use</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_rev_to_use</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tried_with_mpa_v1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">retry_with_mpa_v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_rev_to_use</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">+=</span>
			<span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">));</span>
		<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">);</span>
		<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ird</span> <span class="o">|=</span> <span class="n">htons</span><span class="p">(</span><span class="n">MPA_V2_PEER2PEER_MODEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p2p_type</span> <span class="o">==</span> <span class="n">FW_RI_INIT_P2PTYPE_RDMA_WRITE</span><span class="p">)</span>
				<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">|=</span>
					<span class="n">htons</span><span class="p">(</span><span class="n">MPA_V2_RDMA_WRITE_RTR</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p2p_type</span> <span class="o">==</span> <span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span><span class="p">)</span>
				<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">|=</span>
					<span class="n">htons</span><span class="p">(</span><span class="n">MPA_V2_RDMA_READ_RTR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpa_v2_params</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">),</span>
			       <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reference the mpa skb.  This ensures the data area</span>
<span class="cm">	 * will remain in memory until the hw acks the tx.</span>
<span class="cm">	 * Function fw4_ack() will deref it.</span>
<span class="cm">	 */</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REQ_SENT</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_mpa_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpalen</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="n">mpa_v2_params</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u pd_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>

	<span class="n">mpalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span>
		<span class="n">mpalen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
	<span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">op_to_immdlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_OFLD_TX_DATA_WR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_IMMDLEN</span><span class="p">(</span><span class="n">mpalen</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">wrlen</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mpalen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tunnel_to_proxy</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_OFLD_TX_DATA_WR_FLUSH</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_OFLD_TX_DATA_WR_SHOVE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MPA_REJECT</span><span class="p">;</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">mpa_rev</span><span class="p">;</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MPA_ENHANCED_RDMA_CONN</span><span class="p">;</span>
		<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">+=</span>
			<span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">));</span>
		<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(((</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">peer2peer</span> <span class="o">?</span> <span class="n">MPA_V2_PEER2PEER_MODEL</span> <span class="o">:</span>
					   <span class="mi">0</span><span class="p">));</span>
		<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(((</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">?</span>
					  <span class="p">(</span><span class="n">p2p_type</span> <span class="o">==</span>
					   <span class="n">FW_RI_INIT_P2PTYPE_RDMA_WRITE</span> <span class="o">?</span>
					   <span class="n">MPA_V2_RDMA_WRITE_RTR</span> <span class="o">:</span> <span class="n">p2p_type</span> <span class="o">==</span>
					   <span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span> <span class="o">?</span>
					   <span class="n">MPA_V2_RDMA_READ_RTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpa_v2_params</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">),</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reference the mpa skb again.  This ensures the data area</span>
<span class="cm">	 * will remain in memory until the hw acks the tx.</span>
<span class="cm">	 * Function fw4_ack() will deref it.</span>
<span class="cm">	 */</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_mpa_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpalen</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="n">mpa_v2_params</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u pd_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>

	<span class="n">mpalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span>
		<span class="n">mpalen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
	<span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">mpalen</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">op_to_immdlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_OFLD_TX_DATA_WR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_IMMDLEN</span><span class="p">(</span><span class="n">mpalen</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">wrlen</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mpalen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tunnel_to_proxy</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_OFLD_TX_DATA_WR_FLUSH</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_OFLD_TX_DATA_WR_SHOVE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">?</span> <span class="n">MPA_CRC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">markers_enabled</span> <span class="o">?</span> <span class="n">MPA_MARKERS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
	<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MPA_ENHANCED_RDMA_CONN</span><span class="p">;</span>
		<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span> <span class="o">+=</span>
			<span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">));</span>
		<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">);</span>
		<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">!=</span>
					<span class="n">FW_RI_INIT_P2PTYPE_DISABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ird</span> <span class="o">|=</span> <span class="n">htons</span><span class="p">(</span><span class="n">MPA_V2_PEER2PEER_MODEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">p2p_type</span> <span class="o">==</span> <span class="n">FW_RI_INIT_P2PTYPE_RDMA_WRITE</span><span class="p">)</span>
				<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">|=</span>
					<span class="n">htons</span><span class="p">(</span><span class="n">MPA_V2_RDMA_WRITE_RTR</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p2p_type</span> <span class="o">==</span> <span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span><span class="p">)</span>
				<span class="n">mpa_v2_params</span><span class="p">.</span><span class="n">ord</span> <span class="o">|=</span>
					<span class="n">htons</span><span class="p">(</span><span class="n">MPA_V2_RDMA_READ_RTR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpa_v2_params</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">),</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reference the mpa skb.  This ensures the data area</span>
<span class="cm">	 * will remain in memory until the hw acks the tx.</span>
<span class="cm">	 * Function fw4_ack() will deref it.</span>
<span class="cm">	 */</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">arp_failure_discard</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REP_SENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span> <span class="o">=</span> <span class="n">GET_TID_TID</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_atid</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_atid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atid</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u snd_isn %u rcv_isn %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
	     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">));</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="cm">/* setup the hwtid for this connection */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">cxgb4_insert_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">set_emss</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">));</span>

	<span class="cm">/* dealloc the atid */</span>
	<span class="n">cxgb4_free_atid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atid</span><span class="p">);</span>

	<span class="cm">/* start MPA negotiation */</span>
	<span class="n">send_flowc</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">retry_with_mpa_v1</span><span class="p">)</span>
		<span class="n">send_mpa_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">send_mpa_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">mpa_rev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_complete_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CLOSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;close complete delivered ep %p cm_id %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abort_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">send_abort</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">peer_close_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_DISCONNECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;peer close delivered ep %p cm_id %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">peer_abort_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CLOSE</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;abort delivered ep %p cm_id %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">connect_reply_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REPLY</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tried_with_mpa_v1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this means MPA_v2 is used */</span>
			<span class="n">event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
			<span class="n">event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* this means MPA_v1 is used */</span>
			<span class="n">event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">connect_request_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_CONNECT_REQUEST</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tried_with_mpa_v1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this means MPA_v2 is used */</span>
		<span class="n">event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
		<span class="n">event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* this means MPA_v1 is used. Send max supported */</span>
		<span class="n">event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">c4iw_max_read_depth</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">c4iw_max_read_depth</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">established_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">IW_CM_EVENT_ESTABLISHED</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">ird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_rx_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u32</span> <span class="n">credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u credits %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;update_rx_credits - cannot alloc skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wrlen</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_RX_DATA_ACK</span><span class="p">,</span>
						    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">credit_dack</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">credits</span> <span class="o">|</span> <span class="n">RX_FORCE_ACK</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">F_RX_DACK_CHANGE</span> <span class="o">|</span>
				       <span class="n">V_RX_DACK_MODE</span><span class="p">(</span><span class="n">dack_mode</span><span class="p">));</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_ACK</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ctrlq_idx</span><span class="p">);</span>
	<span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_mpa_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="o">*</span><span class="n">mpa_v2_params</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">resp_ird</span><span class="p">,</span> <span class="n">resp_ord</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rtr_mismatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">insuff_ird</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">c4iw_qp_attr_mask</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop mpa timer.  If it expired, then the state has</span>
<span class="cm">	 * changed and we bail since ep_timeout already aborted</span>
<span class="cm">	 * the connection.</span>
<span class="cm">	 */</span>
	<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_SENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get more than the supported amount of private data</span>
<span class="cm">	 * then we must fail this connection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * copy the new data into our accumulation buffer.</span>
<span class="cm">	 */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span><span class="p">]),</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we don&#39;t even have the mpa message, then bail.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">;</span>

	<span class="cm">/* Validate MPA header. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="n">mpa_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s MPA version mismatch. Local = %d,&quot;</span>
		       <span class="s">&quot; Received = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpa_rev</span><span class="p">,</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fail if there&#39;s too much private data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="n">MPA_MAX_PRIVATE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If plen does not account for pkt size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">plen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t have all the pdata yet, then bail.</span>
<span class="cm">	 * We&#39;ll continue process when more data arrives.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_REJECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get here we have accumulated the entire mpa</span>
<span class="cm">	 * start reply message including private data. And</span>
<span class="cm">	 * the MPA header is valid.</span>
<span class="cm">	 */</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">FPDU_MODE</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_CRC</span><span class="p">)</span> <span class="o">|</span> <span class="n">crc_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span> <span class="o">=</span> <span class="n">markers_enabled</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_MARKERS</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span> <span class="n">FW_RI_INIT_P2PTYPE_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span> <span class="o">=</span>
			<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_ENHANCED_RDMA_CONN</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpa_v2_params</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
			<span class="n">resp_ird</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">MPA_V2_IRD_ORD_MASK</span><span class="p">;</span>
			<span class="n">resp_ord</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">MPA_V2_IRD_ORD_MASK</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * This is a double-check. Ideally, below checks are</span>
<span class="cm">			 * not required since ird/ord stuff has been taken</span>
<span class="cm">			 * care of in c4iw_accept_cr</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">&lt;</span> <span class="n">resp_ord</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">resp_ird</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">resp_ord</span><span class="p">;</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">resp_ird</span><span class="p">;</span>
				<span class="n">insuff_ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">MPA_V2_PEER2PEER_MODEL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">MPA_V2_RDMA_WRITE_RTR</span><span class="p">)</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span>
						<span class="n">FW_RI_INIT_P2PTYPE_RDMA_WRITE</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">MPA_V2_RDMA_READ_RTR</span><span class="p">)</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span>
						<span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span> <span class="n">p2p_type</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - crc_enabled=%d, recv_marker_enabled=%d, &quot;</span>
	     <span class="s">&quot;xmit_marker_enabled=%d, version=%d p2p_type=%d local-p2p_type = &quot;</span>
	     <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span><span class="p">,</span> <span class="n">p2p_type</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If responder&#39;s RTR does not match with that of initiator, assign</span>
<span class="cm">	 * FW_RI_INIT_P2PTYPE_DISABLED in mpa attributes so that RTR is not</span>
<span class="cm">	 * generated when moving QP to RTS state.</span>
<span class="cm">	 * A TERM message will be sent after QP has moved to RTS state</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">peer2peer</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">!=</span> <span class="n">p2p_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span> <span class="n">FW_RI_INIT_P2PTYPE_DISABLED</span><span class="p">;</span>
		<span class="n">rtr_mismatch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attrs</span><span class="p">.</span><span class="n">mpa_attr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_RTS</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span> <span class="o">|</span>
	    <span class="n">C4IW_QP_ATTR_LLP_STREAM_HANDLE</span> <span class="o">|</span> <span class="n">C4IW_QP_ATTR_MPA_ATTR</span> <span class="o">|</span>
	    <span class="n">C4IW_QP_ATTR_MAX_IRD</span> <span class="o">|</span> <span class="n">C4IW_QP_ATTR_MAX_ORD</span><span class="p">;</span>

	<span class="cm">/* bind QP and TID with INIT_WR */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
			     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If responder&#39;s RTR requirement did not match with what initiator</span>
<span class="cm">	 * supports, generate TERM message</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtr_mismatch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: RTR mismatch, sending TERM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="n">LAYER_MPA</span> <span class="o">|</span> <span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">MPA_NOMATCH_RTR</span><span class="p">;</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
				<span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Generate TERM if initiator IRD is not sufficient for responder</span>
<span class="cm">	 * provided ORD. Currently, we do the same behaviour even when</span>
<span class="cm">	 * responder provided IRD is also not sufficient as regards to</span>
<span class="cm">	 * initiator ORD.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insuff_ird</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Insufficient IRD, sending TERM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="n">LAYER_MPA</span> <span class="o">|</span> <span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">MPA_INSUFF_IRD</span><span class="p">;</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
				<span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
	<span class="n">send_abort</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_mpa_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="n">mpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="o">*</span><span class="n">mpa_v2_params</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_WAIT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get more than the supported amount of private data</span>
<span class="cm">	 * then we must fail this connection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s enter (%s line %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the new data into our accumulation buffer.</span>
<span class="cm">	 */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span><span class="p">]),</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t even have the mpa message, then bail.</span>
<span class="cm">	 * We&#39;ll continue process when more data arrives.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s enter (%s line %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">mpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate MPA Header.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="n">mpa_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s MPA version mismatch. Local = %d,&quot;</span>
		       <span class="s">&quot; Received = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpa_rev</span><span class="p">,</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">MPA_KEY_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">private_data_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fail if there&#39;s too much private data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="n">MPA_MAX_PRIVATE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If plen does not account for pkt size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">plen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t have all the pdata yet, then bail.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">)</span> <span class="o">+</span> <span class="n">plen</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get here we have accumulated the entire mpa</span>
<span class="cm">	 * start reply message including private data.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_CRC</span><span class="p">)</span> <span class="o">|</span> <span class="n">crc_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span> <span class="o">=</span> <span class="n">markers_enabled</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_MARKERS</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tried_with_mpa_v1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span> <span class="n">FW_RI_INIT_P2PTYPE_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span> <span class="o">=</span>
			<span class="n">mpa</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPA_ENHANCED_RDMA_CONN</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpa_v2_params</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpa</span><span class="p">));</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">MPA_V2_IRD_ORD_MASK</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">MPA_V2_IRD_ORD_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPA_V2_PEER2PEER_MODEL</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">MPA_V2_RDMA_WRITE_RTR</span><span class="p">)</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span>
						<span class="n">FW_RI_INIT_P2PTYPE_RDMA_WRITE</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mpa_v2_params</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">MPA_V2_RDMA_READ_RTR</span><span class="p">)</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span>
						<span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpa</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span> <span class="o">=</span> <span class="n">p2p_type</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s - crc_enabled=%d, recv_marker_enabled=%d, &quot;</span>
	     <span class="s">&quot;xmit_marker_enabled=%d, version=%d p2p_type=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span><span class="p">);</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REQ_RCVD</span><span class="p">);</span>

	<span class="cm">/* drive upcall */</span>
	<span class="n">connect_request_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u dlen %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">));</span>

	<span class="cm">/* update RX credits */</span>
	<span class="n">update_rx_credits</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">process_mpa_reply</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">process_mpa_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s Unexpected streaming data.&quot;</span>
		       <span class="s">&quot; ep %p state %d tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The ep will timeout and inform the ULP of the failure.</span>
<span class="cm">		 * See ep_timeout().</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abort_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl_rss</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MOD</span> <span class="s">&quot;Abort rpl to freed endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ep %p state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return whether a failed active open has allocated a TID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">act_open_has_tid</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_TCAM_FULL</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_CONN_EXIST</span> <span class="o">&amp;&amp;</span>
	       <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_ARP_MISS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_open_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span> <span class="o">=</span> <span class="n">GET_TID_TID</span><span class="p">(</span><span class="n">GET_AOPEN_ATID</span><span class="p">(</span>
					<span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">atid_status</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GET_AOPEN_STATUS</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">atid_status</span><span class="p">));</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_atid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atid</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p atid %u status %u errno %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span>
	     <span class="n">status</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_RTX_NEG_ADVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MOD</span> <span class="s">&quot;Connection problems for atid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">atid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Log interesting failures.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_TIMEDOUT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MOD</span> <span class="s">&quot;Active open failure - &quot;</span>
		       <span class="s">&quot;atid %u status %u errno %d %pI4:%u-&gt;%pI4:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">atid</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
		       <span class="n">ntohs</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
		       <span class="n">ntohs</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">act_open_has_tid</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">cxgb4_remove_tid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">));</span>

	<span class="n">cxgb4_free_atid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atid</span><span class="p">);</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">cxgb4_l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pass_open_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_pass_open_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_stid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">stid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;stid %d lookup failure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p status %d error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
	     <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">listen_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_listsvr_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to alloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_listsvr_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_CLOSE_LISTSRV_REQ</span><span class="p">,</span>
						    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span>
			  <span class="n">QUEUENO</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">rxq_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">close_listsrv_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_close_listsvr_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_stid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">stid</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="n">status2errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">accept_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">cpl_pass_accept_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_pass_accept_rpl</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu_idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">opt0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wscale</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpl</span><span class="p">));</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">cxgb4_best_mtu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">mtus</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtu_idx</span><span class="p">);</span>
	<span class="n">wscale</span> <span class="o">=</span> <span class="n">compute_wscale</span><span class="p">(</span><span class="n">rcv_win</span><span class="p">);</span>
	<span class="n">opt0</span> <span class="o">=</span> <span class="n">KEEP_ALIVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DELACK</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">WND_SCALE</span><span class="p">(</span><span class="n">wscale</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">MSS_IDX</span><span class="p">(</span><span class="n">mtu_idx</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">L2T_IDX</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">TX_CHAN</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">SMAC_SEL</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DSCP</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">ULP_MODE</span><span class="p">(</span><span class="n">ULP_MODE_TCPDDP</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">RCV_BUFSIZ</span><span class="p">(</span><span class="n">rcv_win</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">opt2</span> <span class="o">=</span> <span class="n">RX_CHANNEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">RSS_QUEUE_VALID</span> <span class="o">|</span> <span class="n">RSS_QUEUE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_tcp_timestamps</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tcpopt</span><span class="p">.</span><span class="n">tstamp</span><span class="p">)</span>
		<span class="n">opt2</span> <span class="o">|=</span> <span class="n">TSTAMPS_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_tcp_sack</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tcpopt</span><span class="p">.</span><span class="n">sack</span><span class="p">)</span>
		<span class="n">opt2</span> <span class="o">|=</span> <span class="n">SACK_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wscale</span> <span class="o">&amp;&amp;</span> <span class="n">enable_tcp_window_scaling</span><span class="p">)</span>
		<span class="n">opt2</span> <span class="o">|=</span> <span class="n">WND_SCALE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">rpl</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_PASS_ACCEPT_RPL</span><span class="p">,</span>
				      <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">opt0</span><span class="p">);</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">opt2</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">opt2</span><span class="p">);</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ctrlq_idx</span><span class="p">);</span>
	<span class="n">c4iw_l2t_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reject_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s c4iw_dev %p tid %u peer_ip %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">peer_ip</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span><span class="p">));</span>
	<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">release_tid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_4tuple</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_pass_accept_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		       <span class="n">__be32</span> <span class="o">*</span><span class="n">local_ip</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">peer_ip</span><span class="p">,</span>
		       <span class="n">__be16</span> <span class="o">*</span><span class="n">local_port</span><span class="p">,</span> <span class="n">__be16</span> <span class="o">*</span><span class="n">peer_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eth_len</span> <span class="o">=</span> <span class="n">G_ETH_HDR_LEN</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ip_len</span> <span class="o">=</span> <span class="n">G_IP_HDR_LEN</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">eth_len</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span>
			     <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">eth_len</span> <span class="o">+</span> <span class="n">ip_len</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s saddr 0x%x daddr 0x%x sport %u dport %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">ntohl</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">),</span>
	     <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">));</span>

	<span class="o">*</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">peer_port</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
	<span class="o">*</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">import_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clear_mpa_v1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">step</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">dst_neigh_lookup</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer_ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

		<span class="n">pdev</span> <span class="o">=</span> <span class="n">ip_dev_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">cxgb4_l2t_get</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">l2t</span><span class="p">,</span>
					<span class="n">n</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="n">cxgb4_port_chan</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cxgb4_port_viid</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ntxq</span> <span class="o">/</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span> <span class="o">=</span> <span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nrxq</span> <span class="o">/</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ctrlq_idx</span> <span class="o">=</span> <span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">rxq_ids</span><span class="p">[</span>
			<span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">];</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">cxgb4_l2t_get</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">l2t</span><span class="p">,</span>
					<span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="n">cxgb4_port_chan</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cxgb4_port_viid</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ntxq</span> <span class="o">/</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span> <span class="o">=</span> <span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ctrlq_idx</span> <span class="o">=</span> <span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nrxq</span> <span class="o">/</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">nchan</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">rxq_ids</span><span class="p">[</span>
			<span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clear_mpa_v1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">retry_with_mpa_v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tried_with_mpa_v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">neigh_release</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pass_accept_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">child_ep</span><span class="p">,</span> <span class="o">*</span><span class="n">parent_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_accept_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span> <span class="o">=</span> <span class="n">GET_POPEN_TID</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_stid</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwtid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">local_ip</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">local_port</span><span class="p">,</span> <span class="n">peer_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">parent_ep</span> <span class="o">=</span> <span class="n">lookup_stid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">stid</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s parent ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">parent_ep</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">);</span>

	<span class="n">get_4tuple</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s - listening ep not in LISTEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find output route */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">find_route</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">local_ip</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">local_port</span><span class="p">,</span> <span class="n">peer_port</span><span class="p">,</span>
			<span class="n">GET_POPEN_TOS</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_stid</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to find dst entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">child_ep</span> <span class="o">=</span> <span class="n">alloc_ep</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">child_ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to allocate ep entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">import_ep</span><span class="p">(</span><span class="n">child_ep</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - failed to allocate l2t entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">child_ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CONNECTING</span><span class="p">);</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">local_port</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">local_ip</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">peer_port</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">peer_ip</span><span class="p">;</span>
	<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">parent_ep</span> <span class="o">=</span> <span class="n">parent_ep</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="n">GET_POPEN_TOS</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_stid</span><span class="p">));</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">hwtid</span> <span class="o">=</span> <span class="n">hwtid</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s tx_chan %u smac_idx %u rss_qid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">,</span> <span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">cxgb4_insert_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">child_ep</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">);</span>
	<span class="n">accept_cr</span><span class="p">(</span><span class="n">child_ep</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">reject:</span>
	<span class="n">reject_cr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">peer_ip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pass_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_establish</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">set_emss</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">));</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MPA_REQ_WAIT</span><span class="p">);</span>
	<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">send_flowc</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">peer_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_peer_close</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_RCVD</span>:

		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re gonna mark this puppy DEAD, but keep</span>
<span class="cm">		 * the reference on it until the ULP accepts or</span>
<span class="cm">		 * rejects the CR. Also wake up anyone waiting</span>
<span class="cm">		 * in rdma connection migration (see c4iw_accept_cr()).</span>
<span class="cm">		 */</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;waking up ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;waking up ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FPDU_MODE</span>:
		<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CLOSING</span><span class="p">);</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_CLOSING</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
				       <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peer_close_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MORIBUND</span><span class="p">);</span>
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">;</span>
			<span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
				       <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">c4iw_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns whether an ABORT_REQ_RSS message is a negative advice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_neg_adv_abort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_RTX_NEG_ADVICE</span> <span class="o">||</span>
	       <span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_PERSIST_NEG_ADVICE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qp %p cm_id %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate an active TID to initiate a TCP connection.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">=</span> <span class="n">cxgb4_alloc_atid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc atid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find a route */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">find_route</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot find route.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">import_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc l2e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s txq_idx %u tx_chan %u smac_idx %u rss_qid %u l2t_idx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CONNECTING</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send connect request to rnic */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_connect</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cxgb4_l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="nl">fail4:</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
<span class="nl">fail3:</span>
	<span class="n">cxgb4_free_atid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="cm">/*</span>
<span class="cm">	 * remember to send notification to upper layer.</span>
<span class="cm">	 * We are in here so the upper layer is not aware that this is</span>
<span class="cm">	 * re-connect attempt and so, upper layer is still waiting for</span>
<span class="cm">	 * response of 1st connect request.</span>
<span class="cm">	 */</span>
	<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">peer_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req_rss</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rpl_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_neg_adv_abort</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s neg_adv_abort ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up any threads in rdma_init() or rdma_fini().</span>
<span class="cm">	 * However, this is not needed if com state is just</span>
<span class="cm">	 * MPA_REQ_SENT</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MPA_REQ_SENT</span><span class="p">)</span>
		<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CONNECTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpa_rev</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tried_with_mpa_v1</span><span class="p">)</span>
			<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * we just don&#39;t send notification upwards because we</span>
<span class="cm">			 * want to retry with mpa_v1 without upper layers even</span>
<span class="cm">			 * knowing it.</span>
<span class="cm">			 *</span>
<span class="cm">			 * do some housekeeping so as to re-initiate the</span>
<span class="cm">			 * connection</span>
<span class="cm">			 */</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s: mpa_rev=%d. Retrying with mpav1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">mpa_rev</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">retry_with_mpa_v1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_RCVD</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="cm">/*FALLTHROUGH*/</span>
	<span class="k">case</span> <span class="n">FPDU_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span>
				       <span class="s">&quot;%s - qp &lt;- error failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">peer_abort_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s PEER_ABORT IN DEAD STATE!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="cm">/* we don&#39;t release if we want to retry with mpa_v1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">retry_with_mpa_v1</span><span class="p">)</span>
			<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">rpl_skb</span> <span class="o">=</span> <span class="n">get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpl_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot allocate skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>
	<span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">rpl_skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpl</span><span class="p">));</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">rpl</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_RPL</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>
	<span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rpl_skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* retry with mpa-v1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">retry_with_mpa_v1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxgb4_remove_tid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">cxgb4_l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
		<span class="n">c4iw_reconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">close_con_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* The cm_id may be null if we failed to connect */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">MORIBUND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
		<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">;</span>
			<span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
					     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
					     <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABORTING</span>:
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_rdma_terminate</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MOD</span> <span class="s">&quot;TERM received tid %u qpid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
		       <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
		<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">;</span>
		<span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span>
			       <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MOD</span> <span class="s">&quot;TERM received tid %u no ep/qp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Upcall from the adapter indicating data has been transmitted.</span>
<span class="cm"> * For us its just the single MPA request or reply.  We can now free</span>
<span class="cm"> * the skb holding the mpa message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fw4_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_fw4_ack</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">credits</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>


	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u credits %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s 0 credit ack ep %p tid %u state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s last streaming msg ack ep %p tid %u state %u &quot;</span>
		     <span class="s">&quot;initiator %u freeing skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
		     <span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_reject_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pdata_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">to_ep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">==</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_RCVD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpa_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_mpa_reject</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">pdata_len</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_accept_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">c4iw_qp_attr_mask</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">to_ep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">get_qhp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">==</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">state_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPA_REQ_RCVD</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">c4iw_max_read_depth</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">&gt;</span> <span class="n">c4iw_max_read_depth</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">enhanced_rdma_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
			<span class="n">send_mpa_reject</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					<span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">);</span>
			<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">)</span>
				<span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s %d ird %d ord %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">);</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span><span class="p">;</span>

	<span class="cm">/* bind QP to EP and move to RTS */</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">mpa_attr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_RTS</span><span class="p">;</span>

	<span class="cm">/* bind QP and TID with INIT_WR */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span> <span class="o">|</span>
			     <span class="n">C4IW_QP_ATTR_LLP_STREAM_HANDLE</span> <span class="o">|</span>
			     <span class="n">C4IW_QP_ATTR_MPA_ATTR</span> <span class="o">|</span>
			     <span class="n">C4IW_QP_ATTR_MAX_IRD</span> <span class="o">|</span>
			     <span class="n">C4IW_QP_ATTR_MAX_ORD</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
			     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_mpa_reply</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
			     <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">FPDU_MODE</span><span class="p">);</span>
	<span class="n">established_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err1:</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">c4iw_max_read_depth</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">&gt;</span> <span class="n">c4iw_max_read_depth</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">alloc_ep</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc ep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">mpa_pkt</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">),</span>
		       <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ird</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ird</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">ord</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer2peer</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ord</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">get_qhp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qpn 0x%x qp %p cm_id %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">conn_param</span><span class="o">-&gt;</span><span class="n">qpn</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">cm_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate an active TID to initiate a TCP connection.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">=</span> <span class="n">cxgb4_alloc_atid</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc atid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s saddr 0x%x sport 0x%x raddr 0x%x rport 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
	     <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
	     <span class="n">ntohl</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
	     <span class="n">ntohs</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="cm">/* find a route */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">find_route</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span>
			<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot find route.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">import_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc l2e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s txq_idx %u tx_chan %u smac_idx %u rss_qid %u l2t_idx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">CONNECTING</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">remote_addr</span><span class="p">;</span>

	<span class="cm">/* send connect request to rnic */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_connect</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cxgb4_l2t_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="nl">fail4:</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
<span class="nl">fail3:</span>
	<span class="n">cxgb4_free_atid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_create_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>


	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">alloc_ep</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc ep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">add_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">cm_id</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a server TID.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span> <span class="o">=</span> <span class="n">cxgb4_alloc_stid</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - cannot alloc stid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">LISTEN</span><span class="p">);</span>
	<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgb4_create_server</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">local_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">rxq_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="cm">/* wait for pass_open_rpl */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fail3:</span>
	<span class="n">cxgb4_free_stid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="nl">fail1:</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_destroy_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">to_listen_ep</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">DEAD</span><span class="p">);</span>
	<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">listen_stop</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
	<span class="n">cxgb4_free_stid</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stid</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">rem_ref</span><span class="p">(</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abrupt</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p state %s, abrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
	     <span class="n">states</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">],</span> <span class="n">abrupt</span><span class="p">);</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c4iw_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEAD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
	<span class="k">case</span> <span class="n">MPA_REQ_RCVD</span>:
	<span class="k">case</span> <span class="n">MPA_REP_SENT</span>:
	<span class="k">case</span> <span class="n">FPDU_MODE</span>:
		<span class="n">close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abrupt</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CLOSING</span><span class="p">;</span>
			<span class="n">start_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CLOSE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CLOSE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abrupt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_ep_timer</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">MORIBUND</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MORIBUND</span>:
	<span class="k">case</span> <span class="n">ABORTING</span>:
	<span class="k">case</span> <span class="n">DEAD</span>:
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ignoring disconnect ep %p state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abrupt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">close_complete_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">send_abort</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">send_halfclose</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span>
		<span class="n">release_ep_resources</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">async_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_fw6_msg</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">c4iw_ev_dispatch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These are the real handlers that are called from a</span>
<span class="cm"> * work queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">c4iw_handler_func</span> <span class="n">work_handlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPL_ACT_ESTABLISH</span><span class="p">]</span> <span class="o">=</span> <span class="n">act_establish</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ACT_OPEN_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">act_open_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RX_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_data</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">abort_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">abort_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_OPEN_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_open_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_LISTSRV_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">close_listsrv_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ACCEPT_REQ</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_accept_req</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ESTABLISH</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_establish</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PEER_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_REQ_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_abort</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_CON_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">close_con_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RDMA_TERMINATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">terminate</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_FW4_ACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw4_ack</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_FW6_MSG</span><span class="p">]</span> <span class="o">=</span> <span class="n">async_event</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPA_REQ_SENT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
		<span class="n">connect_reply_upcall</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPA_REQ_WAIT</span>:
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSING</span>:
	<span class="k">case</span> <span class="n">MORIBUND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">;</span>
			<span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">__state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">,</span> <span class="n">ABORTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s unexpected state ep %p tid %u state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span>
		<span class="n">abort_connection</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_timedout_eps</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">timeout_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_ep</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">process_timeout</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">**</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)));</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">ot</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">work_handlers</span><span class="p">[</span><span class="n">opcode</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">work_handlers</span><span class="p">[</span><span class="n">opcode</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">process_timedout_eps</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">skb_work</span><span class="p">,</span> <span class="n">process_work</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * All the CM events are handled on a work queue to have a safe context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sched</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save dev in the skb-&gt;cb area.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">**</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)))</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Queue the skb and schedule the worker thread.</span>
<span class="cm">	 */</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_tcb_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;Unexpected SET_TCB_RPL status %u &quot;</span>
		       <span class="s">&quot;for tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fw6_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_fw6_msg</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="o">*</span><span class="n">wr_waitp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">wr_waitp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="o">*</span><span class="p">)(</span><span class="n">__force</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wr_waitp %p ret %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wr_waitp</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr_waitp</span><span class="p">)</span>
			<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="n">wr_waitp</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">sched</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s unexpected fw6 msg type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">peer_abort_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req_rss</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MOD</span>
		       <span class="s">&quot;Abort on non-existent endpoint, tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_neg_adv_abort</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s neg_adv_abort ep %p tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ep %p tid %u state %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up any threads in rdma_init() or rdma_fini().</span>
<span class="cm">	 */</span>
	<span class="n">c4iw_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">sched</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Most upcalls from the T4 Core go to sched() to</span>
<span class="cm"> * schedule the processing on a work queue.</span>
<span class="cm"> */</span>
<span class="n">c4iw_handler_func</span> <span class="n">c4iw_handlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPL_ACT_ESTABLISH</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ACT_OPEN_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RX_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_OPEN_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_LISTSRV_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ACCEPT_REQ</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PASS_ESTABLISH</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PEER_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_CON_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_REQ_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_abort_intr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RDMA_TERMINATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_FW4_ACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_SET_TCB_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_tcb_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_FW6_MSG</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw6_msg</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">c4iw_cm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="p">);</span>

	<span class="n">workq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;iw_cxgb4&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">workq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">c4iw_cm_term</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_list</span><span class="p">));</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">workq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">workq</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
