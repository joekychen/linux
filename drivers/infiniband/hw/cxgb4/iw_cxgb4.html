<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › iw_cxgb4.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iw_cxgb4.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer.</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer in the documentation and/or other materials</span>
<span class="cm"> *	  provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __IW_CXGB4_H__</span>
<span class="cp">#define __IW_CXGB4_H__</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>

<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/iw_cm.h&gt;</span>

<span class="cp">#include &quot;cxgb4.h&quot;</span>
<span class="cp">#include &quot;cxgb4_uld.h&quot;</span>
<span class="cp">#include &quot;l2t.h&quot;</span>
<span class="cp">#include &quot;user.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;iw_cxgb4&quot;</span>
<span class="cp">#define MOD DRV_NAME &quot;:&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">c4iw_debug</span><span class="p">;</span>
<span class="cp">#define PDBG(fmt, args...) \</span>
<span class="cp">do { \</span>
<span class="cp">	if (c4iw_debug) \</span>
<span class="cp">		printk(MOD fmt, ## args); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#include &quot;t4.h&quot;</span>

<span class="cp">#define PBL_OFF(rdev_p, a) ((a) - (rdev_p)-&gt;lldi.vr-&gt;pbl.start)</span>
<span class="cp">#define RQT_OFF(rdev_p, a) ((a) - (rdev_p)-&gt;lldi.vr-&gt;rq.start)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">cplhdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define C4IW_ID_TABLE_F_RANDOM 1       </span><span class="cm">/* Pseudo-randomize the id&#39;s returned */</span><span class="cp"></span>
<span class="cp">#define C4IW_ID_TABLE_F_EMPTY  2       </span><span class="cm">/* Table is initially empty */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">;</span>              <span class="cm">/* logical minimal id */</span>
	<span class="n">u32</span> <span class="n">last</span><span class="p">;</span>               <span class="cm">/* hint for find */</span>
	<span class="n">u32</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="n">tpt_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="n">qid_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="n">pdid_table</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_qid_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">qpids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">cqids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">c4iw_rdev_flags</span> <span class="p">{</span>
	<span class="n">T4_FATAL_ERROR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cur</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fail</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_stats</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="n">qid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="n">stag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="n">pbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="n">rqt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stat</span> <span class="n">ocqp</span><span class="p">;</span>
	<span class="n">u64</span>  <span class="n">db_full</span><span class="p">;</span>
	<span class="n">u64</span>  <span class="n">db_empty</span><span class="p">;</span>
	<span class="n">u64</span>  <span class="n">db_drop</span><span class="p">;</span>
	<span class="n">u64</span>  <span class="n">db_state_transitions</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">qpshift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qpmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cqshift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="n">uctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gen_pool</span> <span class="o">*</span><span class="n">pbl_pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gen_pool</span> <span class="o">*</span><span class="n">rqt_pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gen_pool</span> <span class="o">*</span><span class="n">ocqp_pool</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="n">lldi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oc_mw_pa</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">oc_mw_kva</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_stats</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">c4iw_fatal_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">T4_FATAL_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">c4iw_num_stags</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">T4_MAX_NUM_STAG</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">stag</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define C4IW_WR_TO (10*HZ)</span>

<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">completion</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">c4iw_init_wr_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="o">*</span><span class="n">wr_waitp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">c4iw_wake_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="o">*</span><span class="n">wr_waitp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">c4iw_wait_for_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="o">*</span><span class="n">wr_waitp</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpid</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">to</span> <span class="o">=</span> <span class="n">C4IW_WR_TO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;%s - Device %s not responding - &quot;</span>
			       <span class="s">&quot;tid %u qpid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">),</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">qpid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c4iw_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">to</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s: FW reply %d tid %u qpid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">pci_name</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">),</span> <span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">,</span> <span class="n">hwtid</span><span class="p">,</span> <span class="n">qpid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wr_waitp</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">db_state</span> <span class="p">{</span>
	<span class="n">NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">FLOW_CONTROL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">RECOVERY</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span> <span class="n">ibdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_cap_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="n">cqidr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="n">qpidr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="n">mmidr</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">db_mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_root</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">db_state</span> <span class="n">db_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qpcnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="nf">to_c4iw_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="nf">rdev_to_c4iw_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="nf">get_chp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">cqidr</span><span class="p">,</span> <span class="n">cqid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="nf">get_qhp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpidr</span><span class="p">,</span> <span class="n">qpid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="nf">get_mhp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mmid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">mmidr</span><span class="p">,</span> <span class="n">mmid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_insert_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idr</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newid</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="n">idr</span><span class="p">,</span> <span class="n">lock</span> <span class="o">?</span> <span class="n">GFP_KERNEL</span> <span class="o">:</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="n">idr</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newid</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">newid</span> <span class="o">!=</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">insert_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idr</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_insert_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">idr</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">insert_handle_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idr</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_insert_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">idr</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_remove_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idr</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="n">idr</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_remove_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">idr</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_handle_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">idr</span> <span class="o">*</span><span class="n">idr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_remove_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">idr</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_pd</span> <span class="n">ibpd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="nf">to_c4iw_pd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">ibpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_pd</span><span class="p">,</span> <span class="n">ibpd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tpt_attributes</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">va_fbo</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fw_ri_mem_perms</span> <span class="n">perms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pdid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qpid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbl_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">type</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rsvd</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">remote_invaliate_disable</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">zbva</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mw_bind_enable</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">page_size</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="n">ibmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem</span> <span class="o">*</span><span class="n">umem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">kva</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpt_attributes</span> <span class="n">attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="nf">to_c4iw_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ibmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibmr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_mr</span><span class="p">,</span> <span class="n">ibmr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_mw</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mw</span> <span class="n">ibmw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">kva</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpt_attributes</span> <span class="n">attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_mw</span> <span class="o">*</span><span class="nf">to_c4iw_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">ibmw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibmw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_mw</span><span class="p">,</span> <span class="n">ibmw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_fr_page_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_fast_reg_page_list</span> <span class="n">ibpl</span><span class="p">;</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_fr_page_list</span> <span class="o">*</span><span class="nf">to_c4iw_fr_page_list</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">ib_fast_reg_page_list</span> <span class="o">*</span><span class="n">ibpl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibpl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_fr_page_list</span><span class="p">,</span> <span class="n">ibpl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_cq</span> <span class="n">ibcq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_cq</span> <span class="n">cq</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">comp_handler_lock</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">refcnt</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="nf">to_c4iw_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibcq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_cq</span><span class="p">,</span> <span class="n">ibcq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_mpa_attributes</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">initiator</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">recv_marker_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">xmit_marker_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">crc_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enhanced_rdma_conn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">p2p_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">scq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_num_entries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_num_entries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_max_sges</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_max_sges_rdma_write</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_max_sges</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_rdma_read</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_rdma_write</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_bind</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_mmid0_fastreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_ord</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_ird</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">next_state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">terminate_buffer</span><span class="p">[</span><span class="mi">52</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">terminate_msg_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_terminate_local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mpa_attributes</span> <span class="n">mpa_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">llp_stream_handle</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">layer_etype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ecode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sq_db_inc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rq_db_inc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_qp</span> <span class="n">ibqp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_wq</span> <span class="n">wq</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">refcnt</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="nf">to_c4iw_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_qp</span><span class="p">,</span> <span class="n">ibqp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="n">ibucontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="n">uctx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mmap_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">mmaps</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="nf">to_c4iw_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_ucontext</span><span class="p">,</span> <span class="n">ibucontext</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="nf">remove_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">nxt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">nxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmaps</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_mm_entry</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s key 0x%x addr 0x%llx len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">mm</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">insert_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s key 0x%x addr 0x%llx len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">mm</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmaps</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">c4iw_qp_attr_mask</span> <span class="p">{</span>
	<span class="n">C4IW_QP_ATTR_NEXT_STATE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_SQ_DB</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_RQ_DB</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_ENABLE_RDMA_READ</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_ENABLE_RDMA_WRITE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_ENABLE_RDMA_BIND</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_MAX_ORD</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_MAX_IRD</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_LLP_STREAM_HANDLE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_STREAM_MSG_BUFFER</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_MPA_ATTR</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_QP_CONTEXT_ACTIVATE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">,</span>
	<span class="n">C4IW_QP_ATTR_VALID_MODIFY</span> <span class="o">=</span> <span class="p">(</span><span class="n">C4IW_QP_ATTR_ENABLE_RDMA_READ</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_ENABLE_RDMA_WRITE</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_MAX_ORD</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_MAX_IRD</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_LLP_STREAM_HANDLE</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_STREAM_MSG_BUFFER</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_MPA_ATTR</span> <span class="o">|</span>
				     <span class="n">C4IW_QP_ATTR_QP_CONTEXT_ACTIVATE</span><span class="p">)</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">c4iw_qp_attr_mask</span> <span class="n">mask</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">internal</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">c4iw_qp_state</span> <span class="p">{</span>
	<span class="n">C4IW_QP_STATE_IDLE</span><span class="p">,</span>
	<span class="n">C4IW_QP_STATE_RTS</span><span class="p">,</span>
	<span class="n">C4IW_QP_STATE_ERROR</span><span class="p">,</span>
	<span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">,</span>
	<span class="n">C4IW_QP_STATE_CLOSING</span><span class="p">,</span>
	<span class="n">C4IW_QP_STATE_TOT</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">c4iw_convert_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">ib_qp_state</span> <span class="n">ib_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ib_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_QPS_RESET</span>:
	<span class="k">case</span> <span class="n">IB_QPS_INIT</span>:
		<span class="k">return</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_RTS</span>:
		<span class="k">return</span> <span class="n">C4IW_QP_STATE_RTS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_SQD</span>:
		<span class="k">return</span> <span class="n">C4IW_QP_STATE_CLOSING</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_SQE</span>:
		<span class="k">return</span> <span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_QPS_ERR</span>:
		<span class="k">return</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">to_ib_qp_state</span><span class="p">(</span><span class="kt">int</span> <span class="n">c4iw_qp_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c4iw_qp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_IDLE</span>:
		<span class="k">return</span> <span class="n">IB_QPS_INIT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_RTS</span>:
		<span class="k">return</span> <span class="n">IB_QPS_RTS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_CLOSING</span>:
		<span class="k">return</span> <span class="n">IB_QPS_SQD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_TERMINATE</span>:
		<span class="k">return</span> <span class="n">IB_QPS_SQE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_ERROR</span>:
		<span class="k">return</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IB_QPS_ERR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">?</span> <span class="n">FW_RI_MEM_ACCESS_REM_WRITE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_READ</span> <span class="o">?</span> <span class="n">FW_RI_MEM_ACCESS_REM_READ</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span> <span class="o">?</span> <span class="n">FW_RI_MEM_ACCESS_LOCAL_WRITE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">FW_RI_MEM_ACCESS_LOCAL_READ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">c4iw_ib_to_tpt_bind_access</span><span class="p">(</span><span class="kt">int</span> <span class="n">acc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">acc</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">?</span> <span class="n">FW_RI_MEM_ACCESS_REM_WRITE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">acc</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_REMOTE_READ</span> <span class="o">?</span> <span class="n">FW_RI_MEM_ACCESS_REM_READ</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">c4iw_mmid_state</span> <span class="p">{</span>
	<span class="n">C4IW_STAG_STATE_VALID</span><span class="p">,</span>
	<span class="n">C4IW_STAG_STATE_INVALID</span>
<span class="p">};</span>

<span class="cp">#define C4IW_NODE_DESC &quot;cxgb4 Chelsio Communications&quot;</span>

<span class="cp">#define MPA_KEY_REQ &quot;MPA ID Req Frame&quot;</span>
<span class="cp">#define MPA_KEY_REP &quot;MPA ID Rep Frame&quot;</span>

<span class="cp">#define MPA_MAX_PRIVATE_DATA	256</span>
<span class="cp">#define MPA_ENHANCED_RDMA_CONN	0x10</span>
<span class="cp">#define MPA_REJECT		0x20</span>
<span class="cp">#define MPA_CRC			0x40</span>
<span class="cp">#define MPA_MARKERS		0x80</span>
<span class="cp">#define MPA_FLAGS_MASK		0xE0</span>

<span class="cp">#define MPA_V2_PEER2PEER_MODEL          0x8000</span>
<span class="cp">#define MPA_V2_ZERO_LEN_FPDU_RTR        0x4000</span>
<span class="cp">#define MPA_V2_RDMA_WRITE_RTR           0x8000</span>
<span class="cp">#define MPA_V2_RDMA_READ_RTR            0x4000</span>
<span class="cp">#define MPA_V2_IRD_ORD_MASK             0x3FFF</span>

<span class="cp">#define c4iw_put_ep(ep) { \</span>
<span class="cp">	PDBG(&quot;put_ep (via %s:%u) ep %p refcnt %d\n&quot;, __func__, __LINE__,  \</span>
<span class="cp">	     ep, atomic_read(&amp;((ep)-&gt;kref.refcount))); \</span>
<span class="cp">	WARN_ON(atomic_read(&amp;((ep)-&gt;kref.refcount)) &lt; 1); \</span>
<span class="cp">	kref_put(&amp;((ep)-&gt;kref), _c4iw_free_ep); \</span>
<span class="cp">}</span>

<span class="cp">#define c4iw_get_ep(ep) { \</span>
<span class="cp">	PDBG(&quot;get_ep (via %s:%u) ep %p, refcnt %d\n&quot;, __func__, __LINE__, \</span>
<span class="cp">	     ep, atomic_read(&amp;((ep)-&gt;kref.refcount))); \</span>
<span class="cp">	kref_get(&amp;((ep)-&gt;kref));  \</span>
<span class="cp">}</span>
<span class="kt">void</span> <span class="n">_c4iw_free_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mpa_message</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">revision</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">private_data_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">private_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpa_v2_conn_params</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">ird</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">ord</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">terminate_message</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">layer_etype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ecode</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">hdrct_rsvd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len_hdrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define TERM_MAX_LENGTH (sizeof(struct terminate_message) + 2 + 18 + 28)</span>

<span class="k">enum</span> <span class="n">c4iw_layers_types</span> <span class="p">{</span>
	<span class="n">LAYER_RDMAP</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">LAYER_DDP</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">LAYER_MPA</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">RDMAP_LOCAL_CATA</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">RDMAP_REMOTE_PROT</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">RDMAP_REMOTE_OP</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">DDP_LOCAL_CATA</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">DDP_TAGGED_ERR</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">DDP_UNTAGGED_ERR</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">DDP_LLP</span>			<span class="o">=</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">c4iw_rdma_ecodes</span> <span class="p">{</span>
	<span class="n">RDMAP_INV_STAG</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">RDMAP_BASE_BOUNDS</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">RDMAP_ACC_VIOL</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">RDMAP_STAG_NOT_ASSOC</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">RDMAP_TO_WRAP</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">RDMAP_INV_VERS</span>		<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">RDMAP_INV_OPCODE</span>	<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">RDMAP_STREAM_CATA</span>	<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="n">RDMAP_GLOBAL_CATA</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">RDMAP_CANT_INV_STAG</span>	<span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="n">RDMAP_UNSPECIFIED</span>	<span class="o">=</span> <span class="mh">0xff</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">c4iw_ddp_ecodes</span> <span class="p">{</span>
	<span class="n">DDPT_INV_STAG</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">DDPT_BASE_BOUNDS</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">DDPT_STAG_NOT_ASSOC</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">DDPT_TO_WRAP</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">DDPT_INV_VERS</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">DDPU_INV_QN</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">DDPU_INV_MSN_NOBUF</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">DDPU_INV_MSN_RANGE</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">DDPU_INV_MO</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">DDPU_MSG_TOOBIG</span>		<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">DDPU_INV_VERS</span>		<span class="o">=</span> <span class="mh">0x06</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">c4iw_mpa_ecodes</span> <span class="p">{</span>
	<span class="n">MPA_CRC_ERR</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">MPA_MARKER_ERR</span>          <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">MPA_LOCAL_CATA</span>          <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">MPA_INSUFF_IRD</span>          <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">MPA_NOMATCH_RTR</span>         <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">c4iw_ep_state</span> <span class="p">{</span>
	<span class="n">IDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">LISTEN</span><span class="p">,</span>
	<span class="n">CONNECTING</span><span class="p">,</span>
	<span class="n">MPA_REQ_WAIT</span><span class="p">,</span>
	<span class="n">MPA_REQ_SENT</span><span class="p">,</span>
	<span class="n">MPA_REQ_RCVD</span><span class="p">,</span>
	<span class="n">MPA_REP_SENT</span><span class="p">,</span>
	<span class="n">FPDU_MODE</span><span class="p">,</span>
	<span class="n">ABORTING</span><span class="p">,</span>
	<span class="n">CLOSING</span><span class="p">,</span>
	<span class="n">MORIBUND</span><span class="p">,</span>
	<span class="n">DEAD</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">c4iw_ep_flags</span> <span class="p">{</span>
	<span class="n">PEER_ABORT_IN_PROGRESS</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ABORT_REQ_IN_PROGRESS</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">RELEASE_RESOURCES</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CLOSE_SENT</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">c4iw_ep_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">local_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">remote_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="n">wr_wait</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="n">com</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">backlog</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_ep_common</span> <span class="n">com</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">parent_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hwtid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">snd_seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv_seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">mpa_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mpa_attributes</span> <span class="n">mpa_attr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mpa_pkt</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpa_message</span><span class="p">)</span> <span class="o">+</span> <span class="n">MPA_MAX_PRIVATE_DATA</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpa_pkt_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ird</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ord</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">smac_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mss</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emss</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rss_qid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txq_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrlq_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry_with_mpa_v1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tried_with_mpa_v1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="nf">to_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">c4iw_listen_ep</span> <span class="o">*</span><span class="nf">to_listen_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">provider_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">compute_wscale</span><span class="p">(</span><span class="kt">int</span> <span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">wscale</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">65535</span><span class="o">&lt;&lt;</span><span class="n">wscale</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">win</span><span class="p">)</span>
		<span class="n">wscale</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wscale</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="n">c4iw_id_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="o">*</span><span class="n">alloc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_id_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="o">*</span><span class="n">alloc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">obj</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_id_table_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="o">*</span><span class="n">alloc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">reserved</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_id_table_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="o">*</span><span class="n">alloc</span><span class="p">);</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">c4iw_handler_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">c4iw_ep_redirect</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2t</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_put_qpid</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qpid</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="n">u32</span> <span class="n">c4iw_get_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="o">*</span><span class="n">id_table</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_put_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_id_table</span> <span class="o">*</span><span class="n">id_table</span><span class="p">,</span> <span class="n">u32</span> <span class="n">entry</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_init_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nr_tpt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nr_pdid</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_init_ctrl_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_pblpool_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_rqtpool_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_ocqp_pool_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_pblpool_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_rqtpool_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_ocqp_pool_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_destroy_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_resource</span> <span class="o">*</span><span class="n">rscp</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_destroy_ctrl_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_unregister_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="n">c4iw_cm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="n">c4iw_cm_term</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_release_dev_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_init_dev_ucontext</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">**</span><span class="n">bad_wr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_post_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">**</span><span class="n">bad_wr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_bind_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ib_mw_bind</span> <span class="o">*</span><span class="n">mw_bind</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_create_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_destroy_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_accept_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_cm_conn_param</span> <span class="o">*</span><span class="n">conn_param</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_reject_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pdata_len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_qp_add_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_qp_rem_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_free_fastreg_pbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_fast_reg_page_list</span> <span class="o">*</span><span class="n">page_list</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_fast_reg_page_list</span> <span class="o">*</span><span class="n">c4iw_alloc_fastreg_pbl</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">page_list_len</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">c4iw_alloc_fast_reg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pbl_depth</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_dealloc_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">c4iw_alloc_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">c4iw_reg_user_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span>
					   <span class="n">u64</span> <span class="n">length</span><span class="p">,</span> <span class="n">u64</span> <span class="n">virt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">c4iw_get_dma_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">c4iw_register_phys_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">buffer_list</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">acc</span><span class="p">,</span>
					<span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_reregister_phys_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">mr_rereg_mask</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">buffer_list</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">acc</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_dereg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ib_mr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ib_cq</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">c4iw_create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">vector</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">ib_context</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_resize_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_arm_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_cq_notify_flags</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_destroy_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ib_qp</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">c4iw_create_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_ib_modify_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">attr_mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_ib_query_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">attr_mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">c4iw_get_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qpn</span><span class="p">);</span>
<span class="n">u32</span> <span class="n">c4iw_rqtpool_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_rqtpool_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="n">u32</span> <span class="n">c4iw_pblpool_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_pblpool_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="n">u32</span> <span class="n">c4iw_ocqp_pool_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_ocqp_pool_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_flush_hw_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_count_rcqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_count_scqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abrupt</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_flush_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_flush_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_ev_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rnicp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qid</span><span class="p">);</span>
<span class="n">u16</span> <span class="n">c4iw_rqes_posted</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">c4iw_post_terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">err_cqe</span><span class="p">);</span>
<span class="n">u32</span> <span class="n">c4iw_get_cqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_put_cqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="n">u32</span> <span class="n">c4iw_get_qpid</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_put_qpid</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">c4iw_ev_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">err_cqe</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">cxgb4_client</span> <span class="n">t4c_client</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">c4iw_handler_func</span> <span class="n">c4iw_handlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">c4iw_max_read_depth</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">db_fc_threshold</span><span class="p">;</span>


<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
