<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › mem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;rdma/ib_umem.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &quot;iw_cxgb4.h&quot;</span>

<span class="cp">#define T4_ULPTX_MIN_IO 32</span>
<span class="cp">#define C4IW_MAX_INLINE_SIZE 96</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_adapter_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulptx_idata</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wr_len</span><span class="p">,</span> <span class="o">*</span><span class="n">to_dp</span><span class="p">,</span> <span class="o">*</span><span class="n">from_dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copy_len</span><span class="p">,</span> <span class="n">num_wqe</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="n">wr_wait</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">&amp;=</span> <span class="mh">0x7FFFFFF</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s addr 0x%x len %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">num_wqe</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">C4IW_MAX_INLINE_SIZE</span><span class="p">);</span>
	<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_wqe</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">copy_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">C4IW_MAX_INLINE_SIZE</span> <span class="o">?</span> <span class="n">C4IW_MAX_INLINE_SIZE</span> <span class="o">:</span>
			   <span class="n">len</span><span class="p">;</span>
		<span class="n">wr_len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">sc</span> <span class="o">+</span>
				 <span class="n">roundup</span><span class="p">(</span><span class="n">copy_len</span><span class="p">,</span> <span class="n">T4_ULPTX_MIN_IO</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
		<span class="n">INIT_ULPTX_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_wqe</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_ULPTX_WR</span><span class="p">)</span> <span class="o">|</span>
						    <span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_ULPTX_WR</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_mid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
				       <span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">)));</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ULPTX_CMD</span><span class="p">(</span><span class="n">ULP_TX_MEM_WRITE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ULP_MEMIO_DATA_LEN</span><span class="p">(</span>
				<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">copy_len</span><span class="p">,</span> <span class="n">T4_ULPTX_MIN_IO</span><span class="p">)));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wr_len</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">),</span>
						      <span class="mi">16</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">lock_addr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ULP_MEMIO_ADDR</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>

		<span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulptx_idata</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmd_more</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ULPTX_CMD</span><span class="p">(</span><span class="n">ULP_TX_SC_IMM</span><span class="p">));</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">roundup</span><span class="p">(</span><span class="n">copy_len</span><span class="p">,</span> <span class="n">T4_ULPTX_MIN_IO</span><span class="p">));</span>

		<span class="n">to_dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">from_dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C4IW_MAX_INLINE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">to_dp</span><span class="p">,</span> <span class="n">from_dp</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">to_dp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_len</span> <span class="o">%</span> <span class="n">T4_ULPTX_MIN_IO</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">to_dp</span> <span class="o">+</span> <span class="n">copy_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T4_ULPTX_MIN_IO</span> <span class="o">-</span>
			       <span class="p">(</span><span class="n">copy_len</span> <span class="o">%</span> <span class="n">T4_ULPTX_MIN_IO</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">C4IW_MAX_INLINE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build and write a TPT entry.</span>
<span class="cm"> * IN: stag key, pdid, perm, bind_enabled, zbva, to, len, page_size,</span>
<span class="cm"> *     pbl_size and pbl_addr</span>
<span class="cm"> * OUT: stag index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_tpt_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reset_tpt_entry</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="o">*</span><span class="n">stag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stag_state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">fw_ri_stag_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fw_ri_mem_perms</span> <span class="n">perm</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">bind_enabled</span><span class="p">,</span> <span class="n">u32</span> <span class="n">zbva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">to</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_tpte</span> <span class="n">tpt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stag_idx</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c4iw_fatal_error</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">stag_state</span> <span class="o">=</span> <span class="n">stag_state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stag_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">stag</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">reset_tpt_entry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">stag</span> <span class="o">==</span> <span class="n">T4_STAG_UNSET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stag_idx</span> <span class="o">=</span> <span class="n">c4iw_get_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">tpt_table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stag_idx</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">cur</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">max</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">cur</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="p">(</span><span class="n">stag_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s stag_state 0x%0x type 0x%0x pdid 0x%0x, stag_idx 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">stag_state</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">stag_idx</span><span class="p">);</span>

	<span class="cm">/* write TPT entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_tpt_entry</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tpt</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">valid_to_pdid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">F_FW_RI_TPTE_VALID</span> <span class="o">|</span>
			<span class="n">V_FW_RI_TPTE_STAGKEY</span><span class="p">((</span><span class="o">*</span><span class="n">stag</span> <span class="o">&amp;</span> <span class="n">M_FW_RI_TPTE_STAGKEY</span><span class="p">))</span> <span class="o">|</span>
			<span class="n">V_FW_RI_TPTE_STAGSTATE</span><span class="p">(</span><span class="n">stag_state</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_TPTE_STAGTYPE</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_FW_RI_TPTE_PDID</span><span class="p">(</span><span class="n">pdid</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">locread_to_qpid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_FW_RI_TPTE_PERM</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">bind_enabled</span> <span class="o">?</span> <span class="n">F_FW_RI_TPTE_MWBINDEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_TPTE_ADDRTYPE</span><span class="p">((</span><span class="n">zbva</span> <span class="o">?</span> <span class="n">FW_RI_ZERO_BASED_TO</span> <span class="o">:</span>
						      <span class="n">FW_RI_VA_BASED_TO</span><span class="p">))</span><span class="o">|</span>
			<span class="n">V_FW_RI_TPTE_PS</span><span class="p">(</span><span class="n">page_size</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">nosnoop_pbladdr</span> <span class="o">=</span> <span class="o">!</span><span class="n">pbl_size</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
			<span class="n">V_FW_RI_TPTE_PBLADDR</span><span class="p">(</span><span class="n">PBL_OFF</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">len_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xffffffffUL</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">va_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">va_lo_fbo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">to</span> <span class="o">&amp;</span> <span class="mh">0xffffffffUL</span><span class="p">));</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">dca_mwbcnt_pstag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">tpt</span><span class="p">.</span><span class="n">len_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_adapter_mem</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">stag_idx</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">stag</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">tpt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tpt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_tpt_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c4iw_put_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">tpt_table</span><span class="p">,</span> <span class="n">stag_idx</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">cur</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_pbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">pbl</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s *pdb_addr 0x%x, pbl_base 0x%x, pbl_size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">pbl</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
	     <span class="n">pbl_size</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">write_adapter_mem</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">pbl_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pbl_size</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pbl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dereg_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">pbl_size</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">allocate_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="n">T4_STAG_UNSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">FW_RI_STAG_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="mi">0UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">deallocate_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">allocate_stag</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">stag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pdid</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pbl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">stag</span> <span class="o">=</span> <span class="n">T4_STAG_UNSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdid</span><span class="p">,</span> <span class="n">FW_RI_STAG_NSMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="mi">0UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pbl_size</span><span class="p">,</span> <span class="n">pbl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">finish_mem_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mmid</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span> <span class="o">=</span> <span class="n">stag</span><span class="p">;</span>
	<span class="n">mmid</span> <span class="o">=</span> <span class="n">stag</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">stag</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s mmid 0x%x mhp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">mhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">insert_handle</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">mmidr</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">mmid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">register_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stag</span> <span class="o">=</span> <span class="n">T4_STAG_UNSET</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span><span class="p">,</span>
			      <span class="n">FW_RI_STAG_NSMR</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mw_bind_enable</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">12</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">finish_mem_reg</span><span class="p">(</span><span class="n">mhp</span><span class="p">,</span> <span class="n">stag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dereg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span>
		       <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reregister_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npages</span> <span class="o">&gt;</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">stag</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span><span class="p">,</span>
			      <span class="n">FW_RI_STAG_NSMR</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mw_bind_enable</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">12</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">finish_mem_reg</span><span class="p">(</span><span class="n">mhp</span><span class="p">,</span> <span class="n">stag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dereg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span>
		       <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_pbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span> <span class="o">=</span> <span class="n">c4iw_pblpool_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span>
						    <span class="n">npages</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">=</span> <span class="n">npages</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_phys_page_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">buffer_list</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
				<span class="n">u64</span> <span class="o">*</span><span class="n">total_size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">npages</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">shift</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">**</span><span class="n">page_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phys_buf</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">num_phys_buf</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">total_size</span> <span class="o">+=</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">num_phys_buf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span>
				<span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_size</span> <span class="o">&gt;</span> <span class="mh">0xFFFFFFFFULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Find largest page shift we can use to cover buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">*</span><span class="n">shift</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span> <span class="o">*</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">;</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">shift</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">buffer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="n">buffer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buffer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">0ull</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">;</span>

	<span class="o">*</span><span class="n">npages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phys_buf</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="o">*</span><span class="n">npages</span> <span class="o">+=</span> <span class="p">(</span><span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span>
			<span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">npages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">page_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="o">*</span><span class="n">npages</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">page_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phys_buf</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">;</span>
		     <span class="o">++</span><span class="n">j</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">page_list</span><span class="p">)[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">buffer_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span>
			    <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">shift</span><span class="p">));</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s va 0x%llx mask 0x%llx shift %d len %lld pbl_size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">iova_start</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mask</span><span class="p">,</span> <span class="o">*</span><span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">total_size</span><span class="p">,</span>
	     <span class="o">*</span><span class="n">npages</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_reregister_phys_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mr_rereg_mask</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">buffer_list</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="n">mh</span><span class="p">,</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">page_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_mr %p ib_pd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="cm">/* There can be no memory windows */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mhp</span> <span class="o">=</span> <span class="n">to_c4iw_mr</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>

	<span class="cm">/* make sure we are on the same adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rhp</span> <span class="o">!=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mh</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">mhp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_PD</span><span class="p">)</span>
		<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_ACCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mh</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span> <span class="o">=</span> <span class="n">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
		<span class="n">mh</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mw_bind_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_MW_BIND</span><span class="p">)</span> <span class="o">==</span>
					 <span class="n">IB_ACCESS_MW_BIND</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_TRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">build_phys_page_list</span><span class="p">(</span><span class="n">buffer_list</span><span class="p">,</span> <span class="n">num_phys_buf</span><span class="p">,</span>
						<span class="n">iova_start</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npages</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">reregister_mem</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mh</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">page_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_PD</span><span class="p">)</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_ACCESS</span><span class="p">)</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span> <span class="o">=</span> <span class="n">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mr_rereg_mask</span> <span class="o">&amp;</span> <span class="n">IB_MR_REREG_TRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span> <span class="o">=</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">;</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">total_size</span><span class="p">;</span>
		<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">=</span> <span class="n">npages</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">c4iw_register_phys_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="o">*</span><span class="n">buffer_list</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">num_phys_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">page_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_pd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>

	<span class="n">mhp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mhp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>

	<span class="cm">/* First check that we have enough alignment */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">iova_start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">buffer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_phys_buf</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">buffer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">buffer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">build_phys_page_list</span><span class="p">(</span><span class="n">buffer_list</span><span class="p">,</span> <span class="n">num_phys_buf</span><span class="p">,</span> <span class="n">iova_start</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shift</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">page_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_pbl</span><span class="p">(</span><span class="n">mhp</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">page_list</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pbl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_pbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">page_list</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">,</span>
			     <span class="n">npages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">page_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pbl</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span> <span class="o">=</span> <span class="n">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span> <span class="o">=</span> <span class="o">*</span><span class="n">iova_start</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">=</span> <span class="n">npages</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_mem</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pbl</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">;</span>

<span class="nl">err_pbl:</span>
	<span class="n">c4iw_pblpool_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">c4iw_get_dma_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stag</span> <span class="o">=</span> <span class="n">T4_STAG_UNSET</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_pd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>

	<span class="n">mhp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mhp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span> <span class="o">=</span> <span class="n">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mw_bind_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc</span><span class="o">&amp;</span><span class="n">IB_ACCESS_MW_BIND</span><span class="p">)</span> <span class="o">==</span> <span class="n">IB_ACCESS_MW_BIND</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_tpt_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">,</span>
			      <span class="n">FW_RI_STAG_NSMR</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mw_bind_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">finish_mem_reg</span><span class="p">(</span><span class="n">mhp</span><span class="p">,</span> <span class="n">stag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">;</span>
<span class="nl">err2:</span>
	<span class="n">dereg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span>
		  <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">c4iw_reg_user_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">length</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">virt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_umem_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_pd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">mhp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mhp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span> <span class="o">=</span> <span class="n">ib_umem_get</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">alloc_pbl</span><span class="p">(</span><span class="n">mhp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pbl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">nmap</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span>
					<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">*</span> <span class="n">k</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">write_pbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span>
					      <span class="n">pages</span><span class="p">,</span>
					      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">pbl_done</span><span class="p">;</span>
					<span class="n">n</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">write_pbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span>
				     <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

<span class="nl">pbl_done:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pbl</span><span class="p">;</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">zbva</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">perms</span> <span class="o">=</span> <span class="n">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">va_fbo</span> <span class="o">=</span> <span class="n">virt</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_mem</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pbl</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">;</span>

<span class="nl">err_pbl:</span>
	<span class="n">c4iw_pblpool_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="nf">c4iw_alloc_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mw</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mmid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">mhp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mhp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">allocate_window</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FW_RI_STAG_MW</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span> <span class="o">=</span> <span class="n">stag</span><span class="p">;</span>
	<span class="n">mmid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stag</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmw</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">stag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insert_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">mmidr</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">mmid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deallocate_window</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s mmid 0x%x mhp %p stag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">stag</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_dealloc_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mw</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mmid</span><span class="p">;</span>

	<span class="n">mhp</span> <span class="o">=</span> <span class="n">to_c4iw_mw</span><span class="p">(</span><span class="n">mw</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">mmid</span> <span class="o">=</span> <span class="p">(</span><span class="n">mw</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">remove_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">mmidr</span><span class="p">,</span> <span class="n">mmid</span><span class="p">);</span>
	<span class="n">deallocate_window</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_mw %p mmid 0x%x ptr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mw</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">mhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="nf">c4iw_alloc_fast_reg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pbl_depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mmid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">mhp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mhp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mhp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_pbl</span><span class="p">(</span><span class="n">mhp</span><span class="p">,</span> <span class="n">pbl_depth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">=</span> <span class="n">pbl_depth</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">allocate_stag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stag</span><span class="p">,</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">,</span>
				 <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FW_RI_STAG_NSMR</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span> <span class="o">=</span> <span class="n">stag</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mmid</span> <span class="o">=</span> <span class="p">(</span><span class="n">stag</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">stag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insert_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">mmidr</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">mmid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s mmid 0x%x mhp %p stag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">mhp</span><span class="p">,</span> <span class="n">stag</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">ibmr</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">dereg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">stag</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span>
		       <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">c4iw_pblpool_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">,</span>
			      <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_fast_reg_page_list</span> <span class="o">*</span><span class="nf">c4iw_alloc_fastreg_pbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
						     <span class="kt">int</span> <span class="n">page_list_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_fr_page_list</span> <span class="o">*</span><span class="n">c4pl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">c4pl</span> <span class="o">+</span> <span class="n">page_list_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="n">c4pl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c4pl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">c4pl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">ibpl</span><span class="p">.</span><span class="n">page_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)(</span><span class="n">c4pl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">ibpl</span><span class="p">.</span><span class="n">max_page_list_len</span> <span class="o">=</span> <span class="n">page_list_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">ibpl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">c4iw_free_fastreg_pbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_fast_reg_page_list</span> <span class="o">*</span><span class="n">ibpl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_fr_page_list</span> <span class="o">*</span><span class="n">c4pl</span> <span class="o">=</span> <span class="n">to_c4iw_fr_page_list</span><span class="p">(</span><span class="n">ibpl</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">c4pl</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">c4pl</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">c4pl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_dereg_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">ib_mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mr</span> <span class="o">*</span><span class="n">mhp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mmid</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_mr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ib_mr</span><span class="p">);</span>
	<span class="cm">/* There can be no memory windows */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_mr</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mhp</span> <span class="o">=</span> <span class="n">to_c4iw_mr</span><span class="p">(</span><span class="n">ib_mr</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">mmid</span> <span class="o">=</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">remove_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">mmidr</span><span class="p">,</span> <span class="n">mmid</span><span class="p">);</span>
	<span class="n">dereg_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">stag</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">,</span>
		       <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span><span class="p">)</span>
		<span class="n">c4iw_pblpool_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_addr</span><span class="p">,</span>
				  <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pbl_size</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">kva</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mhp</span><span class="o">-&gt;</span><span class="n">kva</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">)</span>
		<span class="n">ib_umem_release</span><span class="p">(</span><span class="n">mhp</span><span class="o">-&gt;</span><span class="n">umem</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s mmid 0x%x ptr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">mhp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
