<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › cq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *	  copyright notice, this list of conditions and the following</span>
<span class="cm"> *	  disclaimer in the documentation and/or other materials</span>
<span class="cm"> *	  provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;iw_cxgb4.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="o">*</span><span class="n">res_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_res</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="n">wr_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wr_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">res_wr</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">res_wr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">res_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">op_nres</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
			<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_RI_RES_WR</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_NRES</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">len16_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">FW_RI_RES_TYPE_CQ</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_RES_OP_RESET</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">iqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>

	<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="n">cq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
	<span class="n">c4iw_put_cqid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="o">*</span><span class="n">res_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_res</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="n">uctx</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">uctx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="n">wr_wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span> <span class="o">=</span> <span class="n">c4iw_get_cqid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">);</span>

	<span class="cm">/* build fw_ri_res_wr */</span>
	<span class="n">wr_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">res_wr</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">res_wr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">res_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">op_nres</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
			<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_RI_RES_WR</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_NRES</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">len16_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">FW_RI_RES_TYPE_CQ</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_RES_OP_WRITE</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">iqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">iqandst_to_iqandstindex</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
			<span class="n">V_FW_RI_RES_WR_IQANUS</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_IQANUD</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">F_FW_RI_RES_WR_IQANDST</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_IQANDSTINDEX</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">rxq_ids</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">iqdroprss_to_iqesize</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span>
			<span class="n">F_FW_RI_RES_WR_IQDROPRSS</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_IQPCIECH</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_IQINTCNTTHRESH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">F_FW_RI_RES_WR_IQO</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_IQESIZE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">iqsize</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">iqaddr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wait_event wr_wait %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">gts</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">gts_reg</span><span class="p">;</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ugts</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span> <span class="o">&lt;&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">cqshift</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">ugts</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err4:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
<span class="nl">err3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">c4iw_put_cqid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_recv_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="n">cqe</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wq %p cq %p sw_cidx %u sw_pidx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cqe</span><span class="p">));</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_CQE_STATUS</span><span class="p">(</span><span class="n">T4_ERR_SWFLUSH</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_OPCODE</span><span class="p">(</span><span class="n">FW_RI_SEND</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_TYPE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_QPID</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">));</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">bits_type_ts</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">V_CQE_GENBIT</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">));</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">t4_swcq_produce</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_flush_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_use</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_use</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wq %p cq %p rq.in_use %u skip count %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">in_use</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">insert_recv_cqe</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
		<span class="n">flushed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flushed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_sq_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">swcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="n">cqe</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s wq %p cq %p sw_cidx %u sw_pidx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cqe</span><span class="p">));</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_CQE_STATUS</span><span class="p">(</span><span class="n">T4_ERR_SWFLUSH</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_OPCODE</span><span class="p">(</span><span class="n">swcqe</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_TYPE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_QPID</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">));</span>
	<span class="n">CQE_WRID_SQ_IDX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">=</span> <span class="n">swcqe</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">cqe</span><span class="p">.</span><span class="n">bits_type_ts</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">V_CQE_GENBIT</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">));</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">t4_swcq_produce</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_flush_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">swsqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span> <span class="o">+</span> <span class="n">count</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">in_use</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_use</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">in_use</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">insert_sq_cqe</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">swsqe</span><span class="p">);</span>
		<span class="n">swsqe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">swsqe</span> <span class="o">==</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span> <span class="o">+</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">))</span>
			<span class="n">swsqe</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">;</span>
		<span class="n">flushed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flushed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move all CQEs from the HWCQ into the SWCQ.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">c4iw_flush_hw_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">swcqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p cqid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_next_hw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s flushing hwcq cidx 0x%x swcq pidx 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">);</span>
		<span class="n">swcqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">swcqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
		<span class="n">swcqe</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">t4_swcq_produce</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
		<span class="n">t4_hwcq_consume</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_next_hw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cqe_completes_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_TERMINATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_RDMA_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">cqe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SQ_TYPE</span><span class="p">(</span><span class="n">cqe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_SEND_OPCODE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">t4_rq_empty</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">c4iw_count_scqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">ptr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SQ_TYPE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				      <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">))</span>
			<span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">c4iw_count_rcqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s count zero %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">ptr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FW_RI_READ_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cqe_completes_wr</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="n">wq</span><span class="p">))</span>
			<span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_completed_wrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">swsqe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unsignaled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">swsqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">ptr</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">signaled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">swsqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">ptr</span><span class="p">];</span>
			<span class="n">unsignaled</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Insert this completed cqe into the swcq.</span>
<span class="cm">			 */</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s moving cqe into swcq sq idx %u cq idx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">);</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">.</span><span class="n">header</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">;</span>
			<span class="n">t4_swcq_produce</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">-=</span> <span class="n">unsignaled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_read_req_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">read_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scqe</span><span class="p">.</span><span class="n">cidx</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span><span class="o">-&gt;</span><span class="n">read_len</span><span class="p">);</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CQE_QPID</span><span class="p">(</span><span class="n">CQE_QPID</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="o">|</span>
				 <span class="n">V_CQE_SWCQE</span><span class="p">(</span><span class="n">SW_CQE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="o">|</span>
				 <span class="n">V_CQE_OPCODE</span><span class="p">(</span><span class="n">FW_RI_READ_REQ</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">V_CQE_TYPE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">read_cqe</span><span class="o">-&gt;</span><span class="n">bits_type_ts</span> <span class="o">=</span> <span class="n">hw_cqe</span><span class="o">-&gt;</span><span class="n">bits_type_ts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a ptr to the next read wr in the SWSQ or NULL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">advance_oldest_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span> <span class="o">-</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rptr</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">rptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rptr</span> <span class="o">!=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">rptr</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_READ_REQ</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rptr</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="n">rptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * poll_cq</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must:</span>
<span class="cm"> *     check the validity of the first CQE,</span>
<span class="cm"> *     supply the wq assicated with the qpid.</span>
<span class="cm"> *</span>
<span class="cm"> * credit: cq credit to return to sge.</span>
<span class="cm"> * cqe_flushed: 1 iff the CQE is flushed.</span>
<span class="cm"> * cqe: copy of the polled CQE.</span>
<span class="cm"> *</span>
<span class="cm"> * return value:</span>
<span class="cm"> *    0		    CQE returned ok.</span>
<span class="cm"> *    -EAGAIN       CQE skipped, try again.</span>
<span class="cm"> *    -EOVERFLOW    CQ overflow detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="o">*</span><span class="n">cqe_flushed</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">credit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">,</span> <span class="n">read_cqe</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cqe_flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">credit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_next_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_cqe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s CQE OVF %u qpid 0x%0x genbit %u type %u status 0x%0x&quot;</span>
	     <span class="s">&quot; opcode 0x%0x len 0x%0x wrid_hi_stag 0x%x wrid_low_msn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">CQE_OVFBIT</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_QPID</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span>
	     <span class="n">CQE_GENBIT</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_TYPE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span>
	     <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_LEN</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span> <span class="n">CQE_WRID_HI</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">),</span>
	     <span class="n">CQE_WRID_LOW</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * skip cqe&#39;s not affiliated with a QP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Gotta tweak READ completions:</span>
<span class="cm">	 *	1) the cqe doesn&#39;t contain the sq_wptr from the wr.</span>
<span class="cm">	 *	2) opcode not reflected from the wr.</span>
<span class="cm">	 *	3) read_len not reflected from the wr.</span>
<span class="cm">	 *	4) cq_type is RQ_TYPE not SQ_TYPE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_READ_RESP</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this is an unsolicited read response, then the read</span>
<span class="cm">		 * was generated by the kernel driver as part of peer-2-peer</span>
<span class="cm">		 * connection setup.  So ignore the completion.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CQE_STATUS</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">))</span>
				<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t write to the HWCQ, so create a new read req CQE</span>
<span class="cm">		 * in local memory.</span>
<span class="cm">		 */</span>
		<span class="n">create_read_req_cqe</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">hw_cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_cqe</span><span class="p">);</span>
		<span class="n">hw_cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">read_cqe</span><span class="p">;</span>
		<span class="n">advance_oldest_read</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_STATUS</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">||</span> <span class="n">t4_wq_in_error</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cqe_flushed</span> <span class="o">=</span> <span class="n">t4_wq_in_error</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">proc_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_TERMINATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RECV completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * HW only validates 4 bits of MSN.  So we must validate that</span>
<span class="cm">		 * the MSN in the SEND is the next expected MSN.  If its not,</span>
<span class="cm">		 * then we complete this with T4_ERR_MSN and mark the wq in</span>
<span class="cm">		 * error.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t4_rq_empty</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_cqe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">CQE_WRID_MSN</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">msn</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">hw_cqe</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_CQE_STATUS</span><span class="p">(</span><span class="n">T4_ERR_MSN</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">proc_cqe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">proc_cqe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get here its a send completion.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Handle out of order completion. These get stuffed</span>
<span class="cm">	 * in the SW SQ. Then the SW SQ is walked to move any</span>
<span class="cm">	 * now in-order completions into the SW CQ.  This handles</span>
<span class="cm">	 * 2 cases:</span>
<span class="cm">	 *	1) reaping unsignaled WRs when the first subsequent</span>
<span class="cm">	 *	   signaled WR is completed.</span>
<span class="cm">	 *	2) out of order read completions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SW_CQE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CQE_WRID_SQ_IDX</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">swsqe</span><span class="p">;</span>

		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s out of order completion going in sw_sq at idx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">CQE_WRID_SQ_IDX</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">));</span>
		<span class="n">swsqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">CQE_WRID_SQ_IDX</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">)];</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">cqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">;</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">flush_wq</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">proc_cqe:</span>
	<span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_cqe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reap the associated WR(s) that are freed up with this</span>
<span class="cm">	 * completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SQ_TYPE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span> <span class="o">=</span> <span class="n">CQE_WRID_SQ_IDX</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">);</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s completing sq idx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span><span class="p">].</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">t4_sq_consume</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s completing rq idx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">cidx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">cidx</span><span class="p">].</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">t4_rq_empty</span><span class="p">(</span><span class="n">wq</span><span class="p">));</span>
		<span class="n">t4_rq_consume</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">flush_wq:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Flush any completed cqes that are now in-order.</span>
<span class="cm">	 */</span>
	<span class="n">flush_completed_wrs</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>

<span class="nl">skip_cqe:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SW_CQE</span><span class="p">(</span><span class="n">hw_cqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p cqid 0x%x skip sw cqe cidx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">);</span>
		<span class="n">t4_swcq_consume</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cq %p cqid 0x%x skip hw cqe cidx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span><span class="p">);</span>
		<span class="n">t4_hwcq_consume</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get one cq entry from c4iw and map it to openib.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0			cqe returned</span>
<span class="cm"> *	-ENODATA		EMPTY;</span>
<span class="cm"> *	-EAGAIN			caller must try again</span>
<span class="cm"> *	any other -errno	fatal error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">c4iw_poll_cq_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">chp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="n">cqe</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="o">*</span><span class="n">rd_cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">credit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cqe_flushed</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_next_cqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rd_cqe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">get_qhp</span><span class="p">(</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">CQE_QPID</span><span class="p">(</span><span class="n">rd_cqe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qhp</span><span class="p">)</span>
		<span class="n">wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">poll_cq</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe_flushed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">credit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">vendor_err</span> <span class="o">=</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qpid 0x%x type %d opcode %d status 0x%x len %u wrid hi 0x%x &quot;</span>
	     <span class="s">&quot;lo 0x%x cookie 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">CQE_QPID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span>
	     <span class="n">CQE_TYPE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_LEN</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span>
	     <span class="n">CQE_WRID_HI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_WRID_LOW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">cookie</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CQE_TYPE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">))</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span> <span class="o">=</span> <span class="n">CQE_LEN</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_SEND_WITH_INV</span> <span class="o">||</span>
		    <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_RI_SEND_WITH_SE_INV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span> <span class="o">=</span> <span class="n">CQE_WRID_STAG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">|=</span> <span class="n">IB_WC_WITH_INVALIDATE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FW_RI_RDMA_WRITE</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_RDMA_WRITE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_RI_READ_REQ</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_RDMA_READ</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span> <span class="o">=</span> <span class="n">CQE_LEN</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_RI_SEND_WITH_INV</span>:
		<span class="k">case</span> <span class="n">FW_RI_SEND_WITH_SE_INV</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_SEND</span><span class="p">;</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">wc_flags</span> <span class="o">|=</span> <span class="n">IB_WC_WITH_INVALIDATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_RI_SEND</span>:
		<span class="k">case</span> <span class="n">FW_RI_SEND_WITH_SE</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_SEND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_RI_BIND_MW</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_BIND_MW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FW_RI_LOCAL_INV</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_LOCAL_INV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_RI_FAST_REGISTER</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WC_FAST_REG_MR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;Unexpected opcode %d &quot;</span>
			       <span class="s">&quot;in the CQE received for QPID=0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_QPID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqe_flushed</span><span class="p">)</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">T4_ERR_SUCCESS</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_STAG</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_ACCESS_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_PDID</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_PROT_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_QPID</span>:
		<span class="k">case</span> <span class="n">T4_ERR_ACCESS</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_ACCESS_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_WRAP</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_GENERAL_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_BOUND</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_LOC_LEN_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_INVALIDATE_SHARED_MR</span>:
		<span class="k">case</span> <span class="n">T4_ERR_INVALIDATE_MR_WITH_MW_BOUND</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_MW_BIND_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_CRC</span>:
		<span class="k">case</span> <span class="n">T4_ERR_MARKER</span>:
		<span class="k">case</span> <span class="n">T4_ERR_PDU_LEN_ERR</span>:
		<span class="k">case</span> <span class="n">T4_ERR_OUT_OF_RQE</span>:
		<span class="k">case</span> <span class="n">T4_ERR_DDP_VERSION</span>:
		<span class="k">case</span> <span class="n">T4_ERR_RDMA_VERSION</span>:
		<span class="k">case</span> <span class="n">T4_ERR_DDP_QUEUE_NUM</span>:
		<span class="k">case</span> <span class="n">T4_ERR_MSN</span>:
		<span class="k">case</span> <span class="n">T4_ERR_TBIT</span>:
		<span class="k">case</span> <span class="n">T4_ERR_MO</span>:
		<span class="k">case</span> <span class="n">T4_ERR_MSN_RANGE</span>:
		<span class="k">case</span> <span class="n">T4_ERR_IRD_OVERFLOW</span>:
		<span class="k">case</span> <span class="n">T4_ERR_OPCODE</span>:
		<span class="k">case</span> <span class="n">T4_ERR_INTERNAL_ERR</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_FATAL_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">T4_ERR_SWFLUSH</span>:
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IB_WC_WR_FLUSH_ERR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span>
			       <span class="s">&quot;Unexpected cqe_status 0x%x for QPID=0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">CQE_STATUS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">),</span> <span class="n">CQE_QPID</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqe</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">chp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">npolled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chp</span> <span class="o">=</span> <span class="n">to_c4iw_cq</span><span class="p">(</span><span class="n">ibcq</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">npolled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">npolled</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="o">++</span><span class="n">npolled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">c4iw_poll_cq_one</span><span class="p">(</span><span class="n">chp</span><span class="p">,</span> <span class="n">wc</span> <span class="o">+</span> <span class="n">npolled</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">err</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODATA</span> <span class="o">?</span> <span class="n">npolled</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ib_cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">chp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_cq %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ib_cq</span><span class="p">);</span>
	<span class="n">chp</span> <span class="o">=</span> <span class="n">to_c4iw_cq</span><span class="p">(</span><span class="n">ib_cq</span><span class="p">);</span>

	<span class="n">remove_handle</span><span class="p">(</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">cqidr</span><span class="p">,</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">));</span>

	<span class="n">ucontext</span> <span class="o">=</span> <span class="n">ib_cq</span><span class="o">-&gt;</span><span class="n">uobject</span> <span class="o">?</span> <span class="n">to_c4iw_ucontext</span><span class="p">(</span><span class="n">ib_cq</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span>
				  <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">destroy_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span>
		   <span class="n">ucontext</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">uctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="nf">c4iw_create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">ibdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_ucontext</span> <span class="o">*</span><span class="n">ib_context</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">chp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_create_cq_resp</span> <span class="n">uresp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">memsize</span><span class="p">,</span> <span class="n">hwentries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="o">*</span><span class="n">mm2</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_dev %p entries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>

	<span class="n">rhp</span> <span class="o">=</span> <span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">ibdev</span><span class="p">);</span>

	<span class="n">chp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_context</span><span class="p">)</span>
		<span class="n">ucontext</span> <span class="o">=</span> <span class="n">to_c4iw_ucontext</span><span class="p">(</span><span class="n">ib_context</span><span class="p">);</span>

	<span class="cm">/* account for the status page. */</span>
	<span class="n">entries</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* IQ needs one extra entry to differentiate full vs empty. */</span>
	<span class="n">entries</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * entries must be multiple of 16 for HW.</span>
<span class="cm">	 */</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make actual HW queue 2x to avoid cdix_inc overflows.</span>
<span class="cm">	 */</span>
	<span class="n">hwentries</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make HW queue at least 64 entries so GTS updates aren&#39;t too</span>
<span class="cm">	 * frequent.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwentries</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">hwentries</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">memsize</span> <span class="o">=</span> <span class="n">hwentries</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * memsize must be a multiple of the page size if its a user cq.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">memsize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">hwentries</span> <span class="o">=</span> <span class="n">memsize</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">hwentries</span> <span class="o">&gt;</span> <span class="n">T4_MAX_IQ_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memsize</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">hwentries</span> <span class="o">=</span> <span class="n">memsize</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">hwentries</span><span class="p">;</span>
	<span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">memsize</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">create_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span>
			<span class="n">ucontext</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">uctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">chp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>
	<span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>				<span class="cm">/* status page */</span>
	<span class="n">chp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">insert_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">cqidr</span><span class="p">,</span> <span class="n">chp</span><span class="p">,</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
		<span class="n">mm2</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

		<span class="n">uresp</span><span class="p">.</span><span class="n">qid_mask</span> <span class="o">=</span> <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">cqmask</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">cqid</span> <span class="o">=</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">memsize</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">gts_key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_copy_to_udata</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uresp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">uresp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>

		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">key</span><span class="p">;</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">memsize</span><span class="p">;</span>
		<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>

		<span class="n">mm2</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">gts_key</span><span class="p">;</span>
		<span class="n">mm2</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">ugts</span><span class="p">;</span>
		<span class="n">mm2</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cqid 0x%0x chp %p size %u memsize %zu, dma_addr 0x%0llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">,</span> <span class="n">chp</span><span class="p">,</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
	     <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">;</span>
<span class="nl">err5:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm2</span><span class="p">);</span>
<span class="nl">err4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">remove_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">cqidr</span><span class="p">,</span> <span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">destroy_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span>
		   <span class="n">ucontext</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">uctx</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_resize_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_arm_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">ibcq</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_cq_notify_flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">chp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">chp</span> <span class="o">=</span> <span class="n">to_c4iw_cq</span><span class="p">(</span><span class="n">ibcq</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_arm_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span>
			<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IB_CQ_SOLICITED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IB_CQ_SOLICITED</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IB_CQ_REPORT_MISSED_EVENTS</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
