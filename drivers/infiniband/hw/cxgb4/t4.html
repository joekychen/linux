<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › t4.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>t4.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __T4_H__</span>
<span class="cp">#define __T4_H__</span>

<span class="cp">#include &quot;t4_hw.h&quot;</span>
<span class="cp">#include &quot;t4_regs.h&quot;</span>
<span class="cp">#include &quot;t4_msg.h&quot;</span>
<span class="cp">#include &quot;t4fw_ri_api.h&quot;</span>

<span class="cp">#define T4_MAX_NUM_QP (1&lt;&lt;16)</span>
<span class="cp">#define T4_MAX_NUM_CQ (1&lt;&lt;15)</span>
<span class="cp">#define T4_MAX_NUM_PD (1&lt;&lt;15)</span>
<span class="cp">#define T4_EQ_STATUS_ENTRIES (L1_CACHE_BYTES &gt; 64 ? 2 : 1)</span>
<span class="cp">#define T4_MAX_EQ_SIZE (65520 - T4_EQ_STATUS_ENTRIES)</span>
<span class="cp">#define T4_MAX_IQ_SIZE (65520 - 1)</span>
<span class="cp">#define T4_MAX_RQ_SIZE (8192 - T4_EQ_STATUS_ENTRIES)</span>
<span class="cp">#define T4_MAX_SQ_SIZE (T4_MAX_EQ_SIZE - 1)</span>
<span class="cp">#define T4_MAX_QP_DEPTH (T4_MAX_RQ_SIZE - 1)</span>
<span class="cp">#define T4_MAX_CQ_DEPTH (T4_MAX_IQ_SIZE - 1)</span>
<span class="cp">#define T4_MAX_NUM_STAG (1&lt;&lt;15)</span>
<span class="cp">#define T4_MAX_MR_SIZE (~0ULL - 1)</span>
<span class="cp">#define T4_PAGESIZE_MASK 0xffff000  </span><span class="cm">/* 4KB-128MB */</span><span class="cp"></span>
<span class="cp">#define T4_STAG_UNSET 0xffffffff</span>
<span class="cp">#define T4_FW_MAJ 0</span>
<span class="cp">#define T4_EQ_STATUS_ENTRIES (L1_CACHE_BYTES &gt; 64 ? 2 : 1)</span>
<span class="cp">#define A_PCIE_MA_SYNC 0x30b4</span>

<span class="k">struct</span> <span class="n">t4_status_page</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">rsvd1</span><span class="p">;</span>	<span class="cm">/* flit 0 - hw owns */</span>
	<span class="n">__be16</span> <span class="n">rsvd2</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">qid</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">cidx</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">pidx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">qp_err</span><span class="p">;</span>	<span class="cm">/* flit 1 - sw owns */</span>
	<span class="n">u8</span> <span class="n">db_off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">host_wq_pidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">host_cidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">host_pidx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define T4_EQ_ENTRY_SIZE 64</span>

<span class="cp">#define T4_SQ_NUM_SLOTS 5</span>
<span class="cp">#define T4_SQ_NUM_BYTES (T4_EQ_ENTRY_SIZE * T4_SQ_NUM_SLOTS)</span>
<span class="cp">#define T4_MAX_SEND_SGE ((T4_SQ_NUM_BYTES - sizeof(struct fw_ri_send_wr) - \</span>
<span class="cp">			sizeof(struct fw_ri_isgl)) / sizeof(struct fw_ri_sge))</span>
<span class="cp">#define T4_MAX_SEND_INLINE ((T4_SQ_NUM_BYTES - sizeof(struct fw_ri_send_wr) - \</span>
<span class="cp">			sizeof(struct fw_ri_immd)))</span>
<span class="cp">#define T4_MAX_WRITE_INLINE ((T4_SQ_NUM_BYTES - \</span>
<span class="cp">			sizeof(struct fw_ri_rdma_write_wr) - \</span>
<span class="cp">			sizeof(struct fw_ri_immd)))</span>
<span class="cp">#define T4_MAX_WRITE_SGE ((T4_SQ_NUM_BYTES - \</span>
<span class="cp">			sizeof(struct fw_ri_rdma_write_wr) - \</span>
<span class="cp">			sizeof(struct fw_ri_isgl)) / sizeof(struct fw_ri_sge))</span>
<span class="cp">#define T4_MAX_FR_IMMD ((T4_SQ_NUM_BYTES - sizeof(struct fw_ri_fr_nsmr_wr) - \</span>
<span class="cp">			sizeof(struct fw_ri_immd)) &amp; ~31UL)</span>
<span class="cp">#define T4_MAX_FR_DEPTH (T4_MAX_FR_IMMD / sizeof(u64))</span>

<span class="cp">#define T4_RQ_NUM_SLOTS 2</span>
<span class="cp">#define T4_RQ_NUM_BYTES (T4_EQ_ENTRY_SIZE * T4_RQ_NUM_SLOTS)</span>
<span class="cp">#define T4_MAX_RECV_SGE 4</span>

<span class="k">union</span> <span class="n">t4_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_rdma_write_wr</span> <span class="n">write</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_send_wr</span> <span class="n">send</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_rdma_read_wr</span> <span class="n">read</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_bind_mw_wr</span> <span class="n">bind</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_fr_nsmr_wr</span> <span class="n">fr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_inv_lstag_wr</span> <span class="n">inv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_status_page</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">flits</span><span class="p">[</span><span class="n">T4_EQ_ENTRY_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)</span> <span class="o">*</span> <span class="n">T4_SQ_NUM_SLOTS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">t4_recv_wr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_recv_wr</span> <span class="n">recv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_status_page</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">flits</span><span class="p">[</span><span class="n">T4_EQ_ENTRY_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)</span> <span class="o">*</span> <span class="n">T4_RQ_NUM_SLOTS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_wr_hdr</span><span class="p">(</span><span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wrid</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">fw_wr_opcodes</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">wrid</span> <span class="o">=</span> <span class="n">wrid</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">r1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">r1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">len16</span> <span class="o">=</span> <span class="n">len16</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CQE/AE status codes */</span>
<span class="cp">#define T4_ERR_SUCCESS                     0x0</span>
<span class="cp">#define T4_ERR_STAG                        0x1	</span><span class="cm">/* STAG invalid: either the */</span><span class="cp"></span>
						<span class="cm">/* STAG is offlimt, being 0, */</span>
						<span class="cm">/* or STAG_key mismatch */</span>
<span class="cp">#define T4_ERR_PDID                        0x2	</span><span class="cm">/* PDID mismatch */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_QPID                        0x3	</span><span class="cm">/* QPID mismatch */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_ACCESS                      0x4	</span><span class="cm">/* Invalid access right */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_WRAP                        0x5	</span><span class="cm">/* Wrap error */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_BOUND                       0x6	</span><span class="cm">/* base and bounds voilation */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_INVALIDATE_SHARED_MR        0x7	</span><span class="cm">/* attempt to invalidate a  */</span><span class="cp"></span>
						<span class="cm">/* shared memory region */</span>
<span class="cp">#define T4_ERR_INVALIDATE_MR_WITH_MW_BOUND 0x8	</span><span class="cm">/* attempt to invalidate a  */</span><span class="cp"></span>
						<span class="cm">/* shared memory region */</span>
<span class="cp">#define T4_ERR_ECC                         0x9	</span><span class="cm">/* ECC error detected */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_ECC_PSTAG                   0xA	</span><span class="cm">/* ECC error detected when  */</span><span class="cp"></span>
						<span class="cm">/* reading PSTAG for a MW  */</span>
						<span class="cm">/* Invalidate */</span>
<span class="cp">#define T4_ERR_PBL_ADDR_BOUND              0xB	</span><span class="cm">/* pbl addr out of bounds:  */</span><span class="cp"></span>
						<span class="cm">/* software error */</span>
<span class="cp">#define T4_ERR_SWFLUSH			   0xC	</span><span class="cm">/* SW FLUSHED */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_CRC                         0x10 </span><span class="cm">/* CRC error */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_MARKER                      0x11 </span><span class="cm">/* Marker error */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_PDU_LEN_ERR                 0x12 </span><span class="cm">/* invalid PDU length */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_OUT_OF_RQE                  0x13 </span><span class="cm">/* out of RQE */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_DDP_VERSION                 0x14 </span><span class="cm">/* wrong DDP version */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_RDMA_VERSION                0x15 </span><span class="cm">/* wrong RDMA version */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_OPCODE                      0x16 </span><span class="cm">/* invalid rdma opcode */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_DDP_QUEUE_NUM               0x17 </span><span class="cm">/* invalid ddp queue number */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_MSN                         0x18 </span><span class="cm">/* MSN error */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_TBIT                        0x19 </span><span class="cm">/* tag bit not set correctly */</span><span class="cp"></span>
<span class="cp">#define T4_ERR_MO                          0x1A </span><span class="cm">/* MO not 0 for TERMINATE  */</span><span class="cp"></span>
						<span class="cm">/* or READ_REQ */</span>
<span class="cp">#define T4_ERR_MSN_GAP                     0x1B</span>
<span class="cp">#define T4_ERR_MSN_RANGE                   0x1C</span>
<span class="cp">#define T4_ERR_IRD_OVERFLOW                0x1D</span>
<span class="cp">#define T4_ERR_RQE_ADDR_BOUND              0x1E </span><span class="cm">/* RQE addr out of bounds:  */</span><span class="cp"></span>
						<span class="cm">/* software error */</span>
<span class="cp">#define T4_ERR_INTERNAL_ERR                0x1F </span><span class="cm">/* internal error (opcode  */</span><span class="cp"></span>
						<span class="cm">/* mismatch) */</span>
<span class="cm">/*</span>
<span class="cm"> * CQE defs</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">stag</span><span class="p">;</span>
			<span class="n">__be32</span> <span class="n">msn</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">rcqe</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">nada1</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">nada2</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">cidx</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">scqe</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">wrid_hi</span><span class="p">;</span>
			<span class="n">__be32</span> <span class="n">wrid_low</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">gen</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">bits_type_ts</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* macros for flit 0 of the cqe */</span>

<span class="cp">#define S_CQE_QPID        12</span>
<span class="cp">#define M_CQE_QPID        0xFFFFF</span>
<span class="cp">#define G_CQE_QPID(x)     ((((x) &gt;&gt; S_CQE_QPID)) &amp; M_CQE_QPID)</span>
<span class="cp">#define V_CQE_QPID(x)	  ((x)&lt;&lt;S_CQE_QPID)</span>

<span class="cp">#define S_CQE_SWCQE       11</span>
<span class="cp">#define M_CQE_SWCQE       0x1</span>
<span class="cp">#define G_CQE_SWCQE(x)    ((((x) &gt;&gt; S_CQE_SWCQE)) &amp; M_CQE_SWCQE)</span>
<span class="cp">#define V_CQE_SWCQE(x)	  ((x)&lt;&lt;S_CQE_SWCQE)</span>

<span class="cp">#define S_CQE_STATUS      5</span>
<span class="cp">#define M_CQE_STATUS      0x1F</span>
<span class="cp">#define G_CQE_STATUS(x)   ((((x) &gt;&gt; S_CQE_STATUS)) &amp; M_CQE_STATUS)</span>
<span class="cp">#define V_CQE_STATUS(x)   ((x)&lt;&lt;S_CQE_STATUS)</span>

<span class="cp">#define S_CQE_TYPE        4</span>
<span class="cp">#define M_CQE_TYPE        0x1</span>
<span class="cp">#define G_CQE_TYPE(x)     ((((x) &gt;&gt; S_CQE_TYPE)) &amp; M_CQE_TYPE)</span>
<span class="cp">#define V_CQE_TYPE(x)     ((x)&lt;&lt;S_CQE_TYPE)</span>

<span class="cp">#define S_CQE_OPCODE      0</span>
<span class="cp">#define M_CQE_OPCODE      0xF</span>
<span class="cp">#define G_CQE_OPCODE(x)   ((((x) &gt;&gt; S_CQE_OPCODE)) &amp; M_CQE_OPCODE)</span>
<span class="cp">#define V_CQE_OPCODE(x)   ((x)&lt;&lt;S_CQE_OPCODE)</span>

<span class="cp">#define SW_CQE(x)         (G_CQE_SWCQE(be32_to_cpu((x)-&gt;header)))</span>
<span class="cp">#define CQE_QPID(x)       (G_CQE_QPID(be32_to_cpu((x)-&gt;header)))</span>
<span class="cp">#define CQE_TYPE(x)       (G_CQE_TYPE(be32_to_cpu((x)-&gt;header)))</span>
<span class="cp">#define SQ_TYPE(x)	  (CQE_TYPE((x)))</span>
<span class="cp">#define RQ_TYPE(x)	  (!CQE_TYPE((x)))</span>
<span class="cp">#define CQE_STATUS(x)     (G_CQE_STATUS(be32_to_cpu((x)-&gt;header)))</span>
<span class="cp">#define CQE_OPCODE(x)     (G_CQE_OPCODE(be32_to_cpu((x)-&gt;header)))</span>

<span class="cp">#define CQE_SEND_OPCODE(x)( \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x)-&gt;header)) == FW_RI_SEND) || \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x)-&gt;header)) == FW_RI_SEND_WITH_SE) || \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x)-&gt;header)) == FW_RI_SEND_WITH_INV) || \</span>
<span class="cp">	(G_CQE_OPCODE(be32_to_cpu((x)-&gt;header)) == FW_RI_SEND_WITH_SE_INV))</span>

<span class="cp">#define CQE_LEN(x)        (be32_to_cpu((x)-&gt;len))</span>

<span class="cm">/* used for RQ completion processing */</span>
<span class="cp">#define CQE_WRID_STAG(x)  (be32_to_cpu((x)-&gt;u.rcqe.stag))</span>
<span class="cp">#define CQE_WRID_MSN(x)   (be32_to_cpu((x)-&gt;u.rcqe.msn))</span>

<span class="cm">/* used for SQ completion processing */</span>
<span class="cp">#define CQE_WRID_SQ_IDX(x)	((x)-&gt;u.scqe.cidx)</span>

<span class="cm">/* generic accessor macros */</span>
<span class="cp">#define CQE_WRID_HI(x)		((x)-&gt;u.gen.wrid_hi)</span>
<span class="cp">#define CQE_WRID_LOW(x)		((x)-&gt;u.gen.wrid_low)</span>

<span class="cm">/* macros for flit 3 of the cqe */</span>
<span class="cp">#define S_CQE_GENBIT	63</span>
<span class="cp">#define M_CQE_GENBIT	0x1</span>
<span class="cp">#define G_CQE_GENBIT(x)	(((x) &gt;&gt; S_CQE_GENBIT) &amp; M_CQE_GENBIT)</span>
<span class="cp">#define V_CQE_GENBIT(x) ((x)&lt;&lt;S_CQE_GENBIT)</span>

<span class="cp">#define S_CQE_OVFBIT	62</span>
<span class="cp">#define M_CQE_OVFBIT	0x1</span>
<span class="cp">#define G_CQE_OVFBIT(x)	((((x) &gt;&gt; S_CQE_OVFBIT)) &amp; M_CQE_OVFBIT)</span>

<span class="cp">#define S_CQE_IQTYPE	60</span>
<span class="cp">#define M_CQE_IQTYPE	0x3</span>
<span class="cp">#define G_CQE_IQTYPE(x)	((((x) &gt;&gt; S_CQE_IQTYPE)) &amp; M_CQE_IQTYPE)</span>

<span class="cp">#define M_CQE_TS	0x0fffffffffffffffULL</span>
<span class="cp">#define G_CQE_TS(x)	((x) &amp; M_CQE_TS)</span>

<span class="cp">#define CQE_OVFBIT(x)	((unsigned)G_CQE_OVFBIT(be64_to_cpu((x)-&gt;bits_type_ts)))</span>
<span class="cp">#define CQE_GENBIT(x)	((unsigned)G_CQE_GENBIT(be64_to_cpu((x)-&gt;bits_type_ts)))</span>
<span class="cp">#define CQE_TS(x)	(G_CQE_TS(be64_to_cpu((x)-&gt;bits_type_ts)))</span>

<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="p">{</span>
	<span class="n">u64</span>			<span class="n">wr_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span>		<span class="n">cqe</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">read_len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">complete</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">signaled</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pgprot_t</span> <span class="nf">t4_pgprot_wc</span><span class="p">(</span><span class="n">pgprot_t</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(__i386__) || defined(__x86_64__) || defined(CONFIG_PPC64)</span>
	<span class="k">return</span> <span class="n">pgprot_writecombine</span><span class="p">(</span><span class="n">prot</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">pgprot_noncached</span><span class="p">(</span><span class="n">prot</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_ocqp_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(__i386__) || defined(__x86_64__) || defined(CONFIG_PPC64)</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">T4_SQ_ONCHIP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t4_sq</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">sw_sq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">oldest_read</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">udb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">memsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">in_use</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wq_pidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t4_swrqe</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">wr_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t4_rq</span> <span class="p">{</span>
	<span class="k">union</span>  <span class="n">t4_recv_wr</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">t4_swrqe</span> <span class="o">*</span><span class="n">sw_rq</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">udb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">memsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rqt_hwaddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rqt_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">in_use</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wq_pidx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">t4_wq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_sq</span> <span class="n">sq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_rq</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_rqes_posted</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_rq_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_rq_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">==</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t4_rq_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_rq_produce</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pidx</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len16</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="n">T4_EQ_ENTRY_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">&gt;=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_RQ_NUM_SLOTS</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">%=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_RQ_NUM_SLOTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_rq_consume</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">in_use</span><span class="o">--</span><span class="p">;</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">msn</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">cidx</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">t4_rq_host_wq_pidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">host_wq_pidx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">t4_rq_wq_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
		<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_RQ_NUM_SLOTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_sq_onchip</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">T4_SQ_ONCHIP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_sq_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_sq_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span> <span class="o">==</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t4_sq_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_sq_produce</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len16</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="n">T4_EQ_ENTRY_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">&gt;=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_SQ_NUM_SLOTS</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">%=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_SQ_NUM_SLOTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_sq_consume</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">in_use</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span> <span class="o">==</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">t4_sq_host_wq_pidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">host_wq_pidx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">t4_sq_wq_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
		<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_SQ_NUM_SLOTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_ring_sq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">QID</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">)</span> <span class="o">|</span> <span class="n">PIDX</span><span class="p">(</span><span class="n">inc</span><span class="p">),</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_ring_rq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">QID</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">)</span> <span class="o">|</span> <span class="n">PIDX</span><span class="p">(</span><span class="n">inc</span><span class="p">),</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_wq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">qp_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_set_wq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">qp_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_disable_wq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">db_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_enable_wq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">db_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_wq_db_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">db_off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">t4_cq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">sw_queue</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ugts</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">memsize</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">bits_type_ts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* including status page */</span>
	<span class="n">u16</span> <span class="n">cidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sw_pidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sw_cidx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sw_in_use</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cidx_inc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">error</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_arm_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span> <span class="o">&gt;</span> <span class="n">CIDXINC_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SEINTARM</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">CIDXINC</span><span class="p">(</span><span class="n">CIDXINC_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TIMERREG</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">INGRESSQID</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">gts</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span> <span class="o">-=</span> <span class="n">CIDXINC_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SEINTARM</span><span class="p">(</span><span class="n">se</span><span class="p">)</span> <span class="o">|</span> <span class="n">CIDXINC</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span><span class="p">)</span> <span class="o">|</span> <span class="n">TIMERREG</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
	      <span class="n">INGRESSQID</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">gts</span><span class="p">);</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_swcq_produce</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_in_use</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_pidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_swcq_consume</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_in_use</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_hwcq_consume</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cq</span><span class="o">-&gt;</span><span class="n">bits_type_ts</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span><span class="p">].</span><span class="n">bits_type_ts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span> <span class="o">==</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">SEINTARM</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">CIDXINC</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span><span class="p">)</span> <span class="o">|</span> <span class="n">TIMERREG</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">INGRESSQID</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">gts</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_valid_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">CQE_GENBIT</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_next_hw_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">**</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">prev_cidx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prev_cidx</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prev_cidx</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">prev_cidx</span><span class="p">].</span><span class="n">bits_type_ts</span> <span class="o">!=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">bits_type_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MOD</span> <span class="s">&quot;cq overflow cqid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t4_valid_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span><span class="p">]))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">cidx</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="nf">t4_next_sw_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_in_use</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_next_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">**</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_in_use</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">sw_cidx</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_next_hw_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_cq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">t4_status_page</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">qp_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t4_set_cq_in_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">t4_status_page</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">qp_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
