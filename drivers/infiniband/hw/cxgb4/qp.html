<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › cxgb4 › qp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>qp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;iw_cxgb4.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">db_delay_usecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">db_delay_usecs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">db_delay_usecs</span><span class="p">,</span> <span class="s">&quot;Usecs to delay awaiting db fifo to drain&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ocqp_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ocqp_support</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ocqp_support</span><span class="p">,</span> <span class="s">&quot;Support on-chip SQs (default=1)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">db_fc_threshold</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">db_fc_threshold</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">db_fc_threshold</span><span class="p">,</span> <span class="s">&quot;QP count/threshold that triggers automatic &quot;</span>
		 <span class="s">&quot;db flow control mode (default = 2000)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">c4iw_qp_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dealloc_oc_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c4iw_ocqp_pool_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dealloc_host_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">pci_unmap_addr</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dealloc_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_sq_onchip</span><span class="p">(</span><span class="n">sq</span><span class="p">))</span>
		<span class="n">dealloc_oc_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dealloc_host_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_oc_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ocqp_support</span> <span class="o">||</span> <span class="o">!</span><span class="n">t4_ocqp_supported</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">c4iw_ocqp_pool_alloc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">oc_mw_pa</span> <span class="o">+</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">-</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">ocq</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="p">)(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">oc_mw_kva</span> <span class="o">+</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">-</span>
					    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">ocq</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">T4_SQ_ONCHIP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_host_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">pci_unmap_addr_set</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">destroy_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * uP clears EQ contexts when the connection exits rdma mode,</span>
<span class="cm">	 * so no need to post a RESET WR for these EQs.</span>
<span class="cm">	 */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
	<span class="n">dealloc_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
	<span class="n">c4iw_rqtpool_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_hwaddr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">);</span>
	<span class="n">c4iw_put_qpid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="n">c4iw_put_qpid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">rcq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cq</span> <span class="o">*</span><span class="n">scq</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">c4iw_dev_ucontext</span> <span class="o">*</span><span class="n">uctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="n">uctx</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">uctx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="o">*</span><span class="n">res_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ri_res</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_wr_wait</span> <span class="n">wr_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eqsize</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span> <span class="o">=</span> <span class="n">c4iw_get_qpid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span> <span class="o">=</span> <span class="n">c4iw_get_qpid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">,</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span><span class="p">,</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RQT must be a power of 2.</span>
<span class="cm">	 */</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_size</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_hwaddr</span> <span class="o">=</span> <span class="n">c4iw_rqtpool_alloc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_hwaddr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alloc_oc_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">alloc_host_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alloc_host_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span><span class="p">);</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					  <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">),</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s sq base va 0x%p pa 0x%llx rq base va 0x%p pa 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">queue</span><span class="p">),</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">);</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">db_reg</span><span class="p">;</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">gts</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">gts_reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">udb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span> <span class="o">&lt;&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">qpshift</span><span class="p">);</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">udb</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">udb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span> <span class="o">&lt;&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">qpshift</span><span class="p">);</span>
		<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">udb</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">msn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* build fw_ri_res_wr */</span>
	<span class="n">wr_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">res_wr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">res_wr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_res_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">res_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">);</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">op_nres</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
			<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_RI_RES_WR</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_FW_RI_RES_WR_NRES</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">len16_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">res_wr</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">FW_RI_RES_TYPE_SQ</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_RES_OP_WRITE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * eqsize is the number of 64B entries plus the status page size.</span>
<span class="cm">	 */</span>
	<span class="n">eqsize</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_SQ_NUM_SLOTS</span> <span class="o">+</span> <span class="n">T4_EQ_STATUS_ENTRIES</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">fetchszm_to_iqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">V_FW_RI_RES_WR_HOSTFCMODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* no host cidx updates */</span>
		<span class="n">V_FW_RI_RES_WR_CPRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* don&#39;t keep in chip cache */</span>
		<span class="n">V_FW_RI_RES_WR_PCIECHN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* set by uP at ri_init time */</span>
		<span class="p">(</span><span class="n">t4_sq_onchip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)</span> <span class="o">?</span> <span class="n">F_FW_RI_RES_WR_ONCHIP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_IQID</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">dcaen_to_eqsize</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">V_FW_RI_RES_WR_DCAEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_DCACPU</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_FBMIN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_FBMAX</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_CIDXFTHRESHO</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_CIDXFTHRESH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_EQSIZE</span><span class="p">(</span><span class="n">eqsize</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">eqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">eqaddr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">res</span><span class="o">++</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">FW_RI_RES_TYPE_RQ</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_RES_OP_WRITE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * eqsize is the number of 64B entries plus the status page size.</span>
<span class="cm">	 */</span>
	<span class="n">eqsize</span> <span class="o">=</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">T4_RQ_NUM_SLOTS</span> <span class="o">+</span> <span class="n">T4_EQ_STATUS_ENTRIES</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">fetchszm_to_iqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">V_FW_RI_RES_WR_HOSTFCMODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* no host cidx updates */</span>
		<span class="n">V_FW_RI_RES_WR_CPRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* don&#39;t keep in chip cache */</span>
		<span class="n">V_FW_RI_RES_WR_PCIECHN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* set by uP at ri_init time */</span>
		<span class="n">V_FW_RI_RES_WR_IQID</span><span class="p">(</span><span class="n">rcq</span><span class="o">-&gt;</span><span class="n">cqid</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">dcaen_to_eqsize</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">V_FW_RI_RES_WR_DCAEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_DCACPU</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_FBMIN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_FBMAX</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_CIDXFTHRESHO</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_CIDXFTHRESH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_RES_WR_EQSIZE</span><span class="p">(</span><span class="n">eqsize</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">eqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sqrq</span><span class="p">.</span><span class="n">eqaddr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="n">c4iw_init_wr_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s sqid 0x%x rqid 0x%x kdb 0x%p squdb 0x%llx rqudb 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">udb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">udb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err7:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
			  <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
<span class="nl">err6:</span>
	<span class="n">dealloc_sq</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
<span class="nl">err5:</span>
	<span class="n">c4iw_rqtpool_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_hwaddr</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_size</span><span class="p">);</span>
<span class="nl">err4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">c4iw_put_qpid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">c4iw_put_qpid</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">wq</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">uctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_immd</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_ri_immd</span> <span class="o">*</span><span class="n">immdp</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">plenp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dstp</span><span class="p">,</span> <span class="o">*</span><span class="n">srcp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">dstp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">immdp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="n">srcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">plen</span> <span class="o">+=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dstp</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">])</span>
				<span class="n">dstp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">-</span> <span class="n">dstp</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">-</span> <span class="n">dstp</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dstp</span><span class="p">,</span> <span class="n">srcp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">dstp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">srcp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">rem</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">plen</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">immdp</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">plen</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">immdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dstp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">immdp</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_DATA_IMMD</span><span class="p">;</span>
	<span class="n">immdp</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">immdp</span><span class="o">-&gt;</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">immdp</span><span class="o">-&gt;</span><span class="n">immdlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="o">*</span><span class="n">plenp</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_isgl</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="n">queue_start</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">queue_end</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">fw_ri_isgl</span> <span class="o">*</span><span class="n">isglp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">num_sge</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">plenp</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">flitp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">isglp</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_sge</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">plen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="n">plen</span> <span class="o">+=</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flitp</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">flitp</span> <span class="o">==</span> <span class="n">queue_end</span><span class="p">)</span>
			<span class="n">flitp</span> <span class="o">=</span> <span class="n">queue_start</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flitp</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">flitp</span> <span class="o">==</span> <span class="n">queue_end</span><span class="p">)</span>
			<span class="n">flitp</span> <span class="o">=</span> <span class="n">queue_start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">flitp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be64</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">isglp</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_DATA_ISGL</span><span class="p">;</span>
	<span class="n">isglp</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isglp</span><span class="o">-&gt;</span><span class="n">nsge</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">num_sge</span><span class="p">);</span>
	<span class="n">isglp</span><span class="o">-&gt;</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plenp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">plenp</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">plen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">T4_MAX_SEND_SGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_WR_SEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SOLICITED</span><span class="p">)</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sendop_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
				<span class="n">V_FW_RI_SEND_WR_SENDOP</span><span class="p">(</span><span class="n">FW_RI_SEND_WITH_SE</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sendop_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
				<span class="n">V_FW_RI_SEND_WR_SENDOP</span><span class="p">(</span><span class="n">FW_RI_SEND</span><span class="p">));</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">stag_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_WR_SEND_WITH_INV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SOLICITED</span><span class="p">)</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sendop_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
				<span class="n">V_FW_RI_SEND_WR_SENDOP</span><span class="p">(</span><span class="n">FW_RI_SEND_WITH_SE_INV</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">sendop_pkd</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
				<span class="n">V_FW_RI_SEND_WR_SENDOP</span><span class="p">(</span><span class="n">FW_RI_SEND_WITH_INV</span><span class="p">));</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">stag_inv</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_INLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">build_immd</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span>
					 <span class="n">T4_MAX_SEND_INLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_immd</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">plen</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">build_isgl</span><span class="p">((</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">],</span>
					 <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">isgl_src</span><span class="p">,</span>
					 <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_isgl</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_sge</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_DATA_IMMD</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">immdlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_immd</span><span class="p">);</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">plen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">T4_MAX_SEND_SGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">stag_sink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">to_sink</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_INLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">build_immd</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span>
					 <span class="n">T4_MAX_WRITE_INLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_immd</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">plen</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">build_isgl</span><span class="p">((</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">],</span>
					 <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">isgl_src</span><span class="p">,</span>
					 <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_isgl</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_sge</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_DATA_IMMD</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">immdlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_immd</span><span class="p">);</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">plen</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_read</span><span class="p">(</span><span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">stag_src</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_src_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span>
							<span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_src_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">stag_sink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lkey</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_sink_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span>
							 <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_sink_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">stag_src</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_src_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_src_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">stag_sink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_sink_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">to_sink_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">r5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_rdma_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">union</span> <span class="n">t4_recv_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">build_isgl</span><span class="p">((</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">],</span>
			 <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">isgl</span><span class="p">,</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span> <span class="o">+</span>
			      <span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_sge</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_fastreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_sq</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">fw_ri_immd</span> <span class="o">*</span><span class="n">imdp</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pbllen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="mi">32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span> <span class="o">&gt;</span> <span class="n">T4_MAX_FR_DEPTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">qpbinde_to_dcacpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">pgsz_shift</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_shift</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">addr_type</span> <span class="o">=</span> <span class="n">FW_RI_VA_BASED_TO</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">mem_perms</span> <span class="o">=</span> <span class="n">c4iw_ib_to_tpt_access</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">access_flags</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">len_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">len_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">stag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">va_hi</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">iova_start</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">.</span><span class="n">va_lo_fbo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">iova_start</span> <span class="o">&amp;</span>
					<span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pbllen</span> <span class="o">&gt;</span> <span class="n">T4_MAX_FR_IMMD</span><span class="p">);</span>
	<span class="n">imdp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_immd</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">imdp</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_DATA_IMMD</span><span class="p">;</span>
	<span class="n">imdp</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imdp</span><span class="o">-&gt;</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imdp</span><span class="o">-&gt;</span><span class="n">immdlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pbllen</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="n">imdp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="n">pbllen</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">rem</span> <span class="o">-=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">])</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rem</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">-=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">])</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">fr</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">imdp</span> <span class="o">+</span> <span class="n">pbllen</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_inv_stag</span><span class="p">(</span><span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">len16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">inv</span><span class="p">.</span><span class="n">stag_inv</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">inv</span><span class="p">.</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">inv</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">c4iw_qp_add_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_qp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">c4iw_qp_rem_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_qp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_post_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="o">**</span><span class="n">bad_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fw_wr_opcodes</span> <span class="n">fw_opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fw_ri_wr_flags</span> <span class="n">fw_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_wrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t4_swsqe</span> <span class="o">*</span><span class="n">swsqe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">num_wrs</span> <span class="o">=</span> <span class="n">t4_sq_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="n">wr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t4_wr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">queue</span> <span class="o">+</span>
		      <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">*</span> <span class="n">T4_EQ_ENTRY_SIZE</span><span class="p">);</span>

		<span class="n">fw_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SOLICITED</span><span class="p">)</span>
			<span class="n">fw_flags</span> <span class="o">|=</span> <span class="n">FW_RI_SOLICITED_EVENT_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">)</span>
			<span class="n">fw_flags</span> <span class="o">|=</span> <span class="n">FW_RI_COMPLETION_FLAG</span><span class="p">;</span>
		<span class="n">swsqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">sw_sq</span><span class="p">[</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_WR_SEND_WITH_INV</span>:
		<span class="k">case</span> <span class="n">IB_WR_SEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_FENCE</span><span class="p">)</span>
				<span class="n">fw_flags</span> <span class="o">|=</span> <span class="n">FW_RI_READ_FENCE_FLAG</span><span class="p">;</span>
			<span class="n">fw_opcode</span> <span class="o">=</span> <span class="n">FW_RI_SEND_WR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_SEND</span><span class="p">)</span>
				<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_SEND</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_SEND_WITH_INV</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">,</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_RDMA_WRITE</span>:
			<span class="n">fw_opcode</span> <span class="o">=</span> <span class="n">FW_RI_RDMA_WRITE_WR</span><span class="p">;</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_RDMA_WRITE</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">,</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_RDMA_READ</span>:
		<span class="k">case</span> <span class="n">IB_WR_RDMA_READ_WITH_INV</span>:
			<span class="n">fw_opcode</span> <span class="o">=</span> <span class="n">FW_RI_RDMA_READ_WR</span><span class="p">;</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_READ_REQ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IB_WR_RDMA_READ_WITH_INV</span><span class="p">)</span>
				<span class="n">fw_flags</span> <span class="o">=</span> <span class="n">FW_RI_RDMA_READ_INVALIDATE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fw_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_read</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">read_len</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span><span class="p">)</span>
				<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">oldest_read</span> <span class="o">=</span> <span class="n">swsqe</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_FAST_REG_MR</span>:
			<span class="n">fw_opcode</span> <span class="o">=</span> <span class="n">FW_RI_FR_NSMR_WR</span><span class="p">;</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_FAST_REGISTER</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_fastreg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">,</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IB_WR_LOCAL_INV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_FENCE</span><span class="p">)</span>
				<span class="n">fw_flags</span> <span class="o">|=</span> <span class="n">FW_RI_LOCAL_FENCE_FLAG</span><span class="p">;</span>
			<span class="n">fw_opcode</span> <span class="o">=</span> <span class="n">FW_RI_INV_LSTAG_WR</span><span class="p">;</span>
			<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_LOCAL_INV</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_inv_stag</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s post of type=%d TBD!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">wr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="n">wr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span><span class="p">;</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">signaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">);</span>
		<span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>

		<span class="n">init_wr_hdr</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span><span class="p">,</span> <span class="n">fw_opcode</span><span class="p">,</span> <span class="n">fw_flags</span><span class="p">,</span> <span class="n">len16</span><span class="p">);</span>

		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cookie 0x%llx pidx 0x%x opcode 0x%x read_len %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">pidx</span><span class="p">,</span>
		     <span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">swsqe</span><span class="o">-&gt;</span><span class="n">read_len</span><span class="p">);</span>
		<span class="n">wr</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">num_wrs</span><span class="o">--</span><span class="p">;</span>
		<span class="n">t4_sq_produce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="n">len16</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len16</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="n">T4_EQ_ENTRY_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_wq_db_enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">t4_ring_sq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_post_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="o">**</span><span class="n">bad_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">t4_recv_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_wrs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">num_wrs</span> <span class="o">=</span> <span class="n">t4_rq_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="o">-&gt;</span><span class="n">num_sge</span> <span class="o">&gt;</span> <span class="n">T4_MAX_RECV_SGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="n">wr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">t4_recv_wr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span> <span class="o">+</span>
					   <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">wq_pidx</span> <span class="o">*</span>
					   <span class="n">T4_EQ_ENTRY_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_wrs</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">build_rdma_recv</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">wqe</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bad_wr</span> <span class="o">=</span> <span class="n">wr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">sw_rq</span><span class="p">[</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">pidx</span><span class="p">].</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>

		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_RECV_WR</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">wrid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">pidx</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">r2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">r2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">r2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">.</span><span class="n">len16</span> <span class="o">=</span> <span class="n">len16</span><span class="p">;</span>
		<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s cookie 0x%llx pidx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">pidx</span><span class="p">);</span>
		<span class="n">t4_rq_produce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="n">len16</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len16</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="n">T4_EQ_ENTRY_SIZE</span><span class="p">);</span>
		<span class="n">wr</span> <span class="o">=</span> <span class="n">wr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">num_wrs</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_wq_db_enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">t4_ring_rq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_bind_mw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_mw</span> <span class="o">*</span><span class="n">mw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_mw_bind</span> <span class="o">*</span><span class="n">mw_bind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">build_term_codes</span><span class="p">(</span><span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">err_cqe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">layer_type</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">ecode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tagged</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rqtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_inv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">DDP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">CQE_STATUS</span><span class="p">(</span><span class="n">err_cqe</span><span class="p">);</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">CQE_OPCODE</span><span class="p">(</span><span class="n">err_cqe</span><span class="p">);</span>
	<span class="n">rqtype</span> <span class="o">=</span> <span class="n">RQ_TYPE</span><span class="p">(</span><span class="n">err_cqe</span><span class="p">);</span>
	<span class="n">send_inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_SEND_WITH_INV</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_SEND_WITH_SE_INV</span><span class="p">);</span>
	<span class="n">tagged</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_RDMA_WRITE</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">rqtype</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_READ_RESP</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">T4_ERR_STAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">send_inv</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_INV_STAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_PDID</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_SEND_WITH_INV</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_RI_SEND_WITH_SE_INV</span><span class="p">))</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_STAG_NOT_ASSOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_QPID</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_STAG_NOT_ASSOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_ACCESS</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_ACC_VIOL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_WRAP</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_TO_WRAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_BOUND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tagged</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_TAGGED_ERR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPT_BASE_BOUNDS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_PROT</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_BASE_BOUNDS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_INVALIDATE_SHARED_MR</span>:
	<span class="k">case</span> <span class="n">T4_ERR_INVALIDATE_MR_WITH_MW_BOUND</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_CANT_INV_STAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_ECC</span>:
	<span class="k">case</span> <span class="n">T4_ERR_ECC_PSTAG</span>:
	<span class="k">case</span> <span class="n">T4_ERR_INTERNAL_ERR</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_OUT_OF_RQE</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_MSN_NOBUF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_PBL_ADDR_BOUND</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_TAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPT_BASE_BOUNDS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_CRC</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_MPA</span><span class="o">|</span><span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">MPA_CRC_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_MARKER</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_MPA</span><span class="o">|</span><span class="n">DDP_LLP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">MPA_MARKER_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_PDU_LEN_ERR</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_MSG_TOOBIG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_DDP_VERSION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tagged</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_TAGGED_ERR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPT_INV_VERS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_VERS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_RDMA_VERSION</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_INV_VERS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_OPCODE</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">RDMAP_REMOTE_OP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">RDMAP_INV_OPCODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_DDP_QUEUE_NUM</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_QN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_MSN</span>:
	<span class="k">case</span> <span class="n">T4_ERR_MSN_GAP</span>:
	<span class="k">case</span> <span class="n">T4_ERR_MSN_RANGE</span>:
	<span class="k">case</span> <span class="n">T4_ERR_IRD_OVERFLOW</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_MSN_RANGE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_TBIT</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T4_ERR_MO</span>:
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_DDP</span><span class="o">|</span><span class="n">DDP_UNTAGGED_ERR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">DDPU_INV_MO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">LAYER_RDMAP</span><span class="o">|</span><span class="n">DDP_LOCAL_CATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">post_terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t4_cqe</span> <span class="o">*</span><span class="n">err_cqe</span><span class="p">,</span>
			   <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">terminate_message</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p qid 0x%x tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>

	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">op_compl</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_RI_INIT_WR</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">16</span><span class="p">)));</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">terminate</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FW_RI_TYPE_TERMINATE</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">terminate</span><span class="p">.</span><span class="n">immdlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">term</span><span class="p">);</span>
	<span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">terminate_message</span> <span class="o">*</span><span class="p">)</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">terminate</span><span class="p">.</span><span class="n">termmsg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">layer_etype</span> <span class="o">==</span> <span class="p">(</span><span class="n">LAYER_MPA</span><span class="o">|</span><span class="n">DDP_LLP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">term</span><span class="o">-&gt;</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">layer_etype</span><span class="p">;</span>
		<span class="n">term</span><span class="o">-&gt;</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ecode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">build_term_codes</span><span class="p">(</span><span class="n">err_cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">layer_etype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">ecode</span><span class="p">);</span>
	<span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Assumes qhp lock is held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__flush_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">rchp</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">schp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flushed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p rchp %p schp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">rchp</span><span class="p">,</span> <span class="n">schp</span><span class="p">);</span>

	<span class="cm">/* locking hierarchy: cq lock first, then qp lock. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">c4iw_flush_hw_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
	<span class="n">c4iw_count_rcqes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">flushed</span> <span class="o">=</span> <span class="n">c4iw_flush_rq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flushed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* locking hierarchy: cq lock first, then qp lock. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">c4iw_flush_hw_cq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
	<span class="n">c4iw_count_scqes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">flushed</span> <span class="o">=</span> <span class="n">c4iw_flush_sq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flushed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">rchp</span><span class="p">,</span> <span class="o">*</span><span class="n">schp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">rchp</span> <span class="o">=</span> <span class="n">get_chp</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rcq</span><span class="p">);</span>
	<span class="n">schp</span> <span class="o">=</span> <span class="n">get_chp</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">scq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">t4_set_cq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span> <span class="n">rchp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">schp</span> <span class="o">!=</span> <span class="n">rchp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t4_set_cq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">comp_handler</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">,</span>
					<span class="n">schp</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cq_context</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">comp_handler_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">rchp</span><span class="p">,</span> <span class="n">schp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p qid 0x%x tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span>
	     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>

	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">op_compl</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_RI_INIT_WR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">;</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">fini</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FW_RI_TYPE_FINI</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span>
			     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_rtr_msg</span><span class="p">(</span><span class="n">u8</span> <span class="n">p2p_type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_ri_init</span> <span class="o">*</span><span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s p2p_type = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">p2p_type</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p2p_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_RI_INIT_P2PTYPE_RDMA_WRITE</span>:
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_RDMA_WRITE_WR</span><span class="p">;</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">stag_sink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">to_sink</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">immd_src</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">FW_RI_DATA_IMMD</span><span class="p">;</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span> <span class="o">+</span>
						   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_immd</span><span class="p">),</span>
						   <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_RI_INIT_P2PTYPE_READ_REQ</span>:
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">FW_RI_RDMA_READ_WR</span><span class="p">;</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">stag_src</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">to_src_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">stag_sink</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">to_sink_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">len16</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p qid 0x%x tid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">);</span>

	<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ri_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqe</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">op_compl</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_RI_INIT_WR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
		<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="mi">16</span><span class="p">)));</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">;</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FW_RI_TYPE_INIT</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">mpareqbit_p2ptype</span> <span class="o">=</span>
		<span class="n">V_FW_RI_WR_MPAREQBIT</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">V_FW_RI_WR_P2PTYPE</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">mpa_attrs</span> <span class="o">=</span> <span class="n">FW_RI_MPA_IETF_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">recv_marker_enabled</span><span class="p">)</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">mpa_attrs</span> <span class="o">|=</span> <span class="n">FW_RI_MPA_RX_MARKER_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">xmit_marker_enabled</span><span class="p">)</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">mpa_attrs</span> <span class="o">|=</span> <span class="n">FW_RI_MPA_TX_MARKER_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">crc_enabled</span><span class="p">)</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">mpa_attrs</span> <span class="o">|=</span> <span class="n">FW_RI_MPA_CRC_ENABLE</span><span class="p">;</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">qp_caps</span> <span class="o">=</span> <span class="n">FW_RI_QP_RDMA_READ_ENABLE</span> <span class="o">|</span>
			    <span class="n">FW_RI_QP_RDMA_WRITE_ENABLE</span> <span class="o">|</span>
			    <span class="n">FW_RI_QP_BIND_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">qp_caps</span> <span class="o">|=</span> <span class="n">FW_RI_QP_FAST_REGISTER_ENABLE</span> <span class="o">|</span>
				     <span class="n">FW_RI_QP_STAG0_ENABLE</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">nrqe</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">t4_rqes_posted</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">));</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">pdid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">qpid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">sq_eqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">rq_eqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">scqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">scq</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">rcqid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rcq</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">ord_max</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ord</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">ird_max</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ird</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">iss</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">snd_seq</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">irs</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rcv_seq</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">hwrqsize</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_size</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">hwrqaddr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">rqt_hwaddr</span> <span class="o">-</span>
					 <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">initiator</span><span class="p">)</span>
		<span class="n">build_rtr_msg</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span><span class="p">.</span><span class="n">p2p_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_ofld_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c4iw_wait_for_reply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">wr_wait</span><span class="p">,</span>
				  <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hwtid</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the library when the qp has user dbs disabled due to</span>
<span class="cm"> * a DB_FULL condition.  This function will single-thread all user</span>
<span class="cm"> * DB rings to avoid overflowing the hw db-fifo.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ring_kernel_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">db_delay_usecs</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_mutex</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * The interrupt threshold is dbfifo_int_thresh &lt;&lt; 6. So</span>
<span class="cm">		 * make sure we don&#39;t cross that and generate an interrupt.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cxgb4_dbfifo_count</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">dbfifo_int_thresh</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">V_QID</span><span class="p">(</span><span class="n">qid</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PIDX</span><span class="p">(</span><span class="n">inc</span><span class="p">),</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">db</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">delay</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_modify_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">c4iw_qp_attr_mask</span> <span class="n">mask</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">newattr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">terminate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p sqid 0x%x rqid 0x%x ep %p state %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">)</span> <span class="o">?</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Process attr changes if in IDLE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_VALID_MODIFY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_ENABLE_RDMA_READ</span><span class="p">)</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">enable_rdma_read</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">enable_rdma_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_ENABLE_RDMA_WRITE</span><span class="p">)</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">enable_rdma_write</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">enable_rdma_write</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_ENABLE_RDMA_BIND</span><span class="p">)</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">enable_bind</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">enable_bind</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_MAX_ORD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ord</span> <span class="o">&gt;</span> <span class="n">c4iw_max_read_depth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ord</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_MAX_IRD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ird</span> <span class="o">&gt;</span> <span class="n">c4iw_max_read_depth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">newattr</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">max_ird</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">newattr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_SQ_DB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ring_kernel_db</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">sq_db_inc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_RQ_DB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ring_kernel_db</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">rq_db_inc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_IDLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_RTS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_LLP_STREAM_HANDLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">C4IW_QP_ATTR_MPA_ATTR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mpa_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">mpa_attr</span><span class="p">;</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">llp_stream_handle</span><span class="p">;</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span><span class="p">;</span>
			<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_RTS</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Ref the endpoint here and deref when we</span>
<span class="cm">			 * disassociate the endpoint from the QP.  This</span>
<span class="cm">			 * happens in CLOSING-&gt;IDLE transition or *-&gt;ERROR</span>
<span class="cm">			 * transition.</span>
<span class="cm">			 */</span>
			<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdma_init</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_ERROR</span>:
			<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">);</span>
			<span class="n">flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_RTS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_CLOSING</span>:
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_CLOSING</span><span class="p">);</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span>
				<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdma_fini</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_TERMINATE</span>:
			<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">);</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">layer_etype</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">layer_etype</span><span class="p">;</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">ecode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span>
				<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span>
				<span class="n">terminate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_ERROR</span>:
			<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">uobject</span><span class="p">)</span>
				<span class="n">t4_set_wq_in_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
				<span class="n">c4iw_get_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_IDLE</span>:
			<span class="n">flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
			<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">);</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
			<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C4IW_QP_STATE_ERROR</span>:
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_ERROR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">next_state</span> <span class="o">!=</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t4_sq_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">t4_rq_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C4IW_QP_STATE_TERMINATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s in a bad state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s disassociating ep %p qpid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>

	<span class="cm">/* disassociate the LLP connection */</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">llp_stream_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">set_state</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">);</span>
	<span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">flush_qp</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">terminate</span><span class="p">)</span>
		<span class="n">post_terminate</span><span class="p">(</span><span class="n">qhp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">internal</span> <span class="o">?</span> <span class="n">GFP_ATOMIC</span> <span class="o">:</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If disconnect is 1, then we need to initiate a disconnect</span>
<span class="cm">	 * on the EP.  This can be a normal close (RTS-&gt;CLOSING) or</span>
<span class="cm">	 * an abnormal close (RTS/CLOSING-&gt;ERROR).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c4iw_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">internal</span> <span class="o">?</span> <span class="n">GFP_ATOMIC</span> <span class="o">:</span>
							 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If free is 1, then we&#39;ve disassociated the EP from the QP</span>
<span class="cm">	 * and we need to dereference the EP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="p">)</span>
		<span class="n">c4iw_put_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s exit state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_qp_db</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">t4_enable_wq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_destroy_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ib_qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">;</span>

	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">ib_qp</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>

	<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">C4IW_QP_STATE_TERMINATE</span><span class="p">)</span>
		<span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="o">!</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">remove_handle_nolock</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpidr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpcnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpcnt</span> <span class="o">&lt;=</span> <span class="n">db_fc_threshold</span> <span class="o">&amp;&amp;</span> <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_state</span> <span class="o">==</span> <span class="n">FLOW_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">db_state_transitions</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_state</span> <span class="o">=</span> <span class="n">NORMAL</span><span class="p">;</span>
		<span class="n">idr_for_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpidr</span><span class="p">,</span> <span class="n">enable_qp_db</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">));</span>

	<span class="n">ucontext</span> <span class="o">=</span> <span class="n">ib_qp</span><span class="o">-&gt;</span><span class="n">uobject</span> <span class="o">?</span>
		   <span class="n">to_c4iw_ucontext</span><span class="p">(</span><span class="n">ib_qp</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">destroy_qp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
		   <span class="n">ucontext</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">uctx</span><span class="p">);</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_qp %p qpid 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ib_qp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disable_qp_db</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">t4_disable_wq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="nf">c4iw_create_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_pd</span> <span class="o">*</span><span class="n">php</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">schp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="n">rchp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_create_qp_resp</span> <span class="n">uresp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sqsize</span><span class="p">,</span> <span class="n">rqsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_ucontext</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_mm_entry</span> <span class="o">*</span><span class="n">mm1</span><span class="p">,</span> <span class="o">*</span><span class="n">mm2</span><span class="p">,</span> <span class="o">*</span><span class="n">mm3</span><span class="p">,</span> <span class="o">*</span><span class="n">mm4</span><span class="p">,</span> <span class="o">*</span><span class="n">mm5</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_pd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">qp_type</span> <span class="o">!=</span> <span class="n">IB_QPT_RC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">php</span> <span class="o">=</span> <span class="n">to_c4iw_pd</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>
	<span class="n">schp</span> <span class="o">=</span> <span class="n">get_chp</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="p">)</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">);</span>
	<span class="n">rchp</span> <span class="o">=</span> <span class="n">get_chp</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="p">)</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schp</span> <span class="o">||</span> <span class="o">!</span><span class="n">rchp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_inline_data</span> <span class="o">&gt;</span> <span class="n">T4_MAX_SEND_INLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">rqsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqsize</span> <span class="o">&gt;</span> <span class="n">T4_MAX_RQ_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">E2BIG</span><span class="p">);</span>

	<span class="n">sqsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sqsize</span> <span class="o">&gt;</span> <span class="n">T4_MAX_SQ_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">E2BIG</span><span class="p">);</span>

	<span class="n">ucontext</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">uobject</span> <span class="o">?</span> <span class="n">to_c4iw_ucontext</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">uobject</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>


	<span class="n">qhp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qhp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qhp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">sqsize</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">rqsize</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">rqsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s sqsize %u sqmemsize %zu rqsize %u rqmemsize %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">sqsize</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span><span class="p">,</span> <span class="n">rqsize</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">create_qp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rchp</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span>
			<span class="n">ucontext</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">uctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">=</span> <span class="n">rqsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">=</span> <span class="n">sqsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_inline_data</span> <span class="o">=</span> <span class="n">T4_MAX_SEND_INLINE</span><span class="p">;</span>

	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span> <span class="o">=</span> <span class="n">rhp</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="n">php</span><span class="o">-&gt;</span><span class="n">pdid</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">scq</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="p">)</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rcq</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">c4iw_cq</span> <span class="o">*</span><span class="p">)</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">cqid</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sq_num_entries</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rq_num_entries</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sq_max_sges</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sq_max_sges_rdma_write</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rq_max_sges</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">C4IW_QP_STATE_IDLE</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">enable_rdma_read</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">enable_rdma_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">enable_bind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ord</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_ird</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_state</span> <span class="o">!=</span> <span class="n">NORMAL</span><span class="p">)</span>
		<span class="n">t4_disable_wq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpcnt</span> <span class="o">&gt;</span> <span class="n">db_fc_threshold</span> <span class="o">&amp;&amp;</span> <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_state</span> <span class="o">==</span> <span class="n">NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">db_state_transitions</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rhp</span><span class="o">-&gt;</span><span class="n">db_state</span> <span class="o">=</span> <span class="n">FLOW_CONTROL</span><span class="p">;</span>
		<span class="n">idr_for_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpidr</span><span class="p">,</span> <span class="n">disable_qp_db</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">insert_handle_nolock</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpidr</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mm1</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mm2</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mm3</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm3</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mm4</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t4_sq_onchip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mm5</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mm5</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">uresp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">C4IW_QPF_ONCHIP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">uresp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">qid_mask</span> <span class="o">=</span> <span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">qpmask</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">sqid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">sq_size</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">sq_memsize</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">rqid</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">qid</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">rq_size</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">rq_memsize</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mm5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uresp</span><span class="p">.</span><span class="n">ma_sync_key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
			<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">sq_key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">rq_key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">sq_db_gts_key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">uresp</span><span class="p">.</span><span class="n">rq_db_gts_key</span> <span class="o">=</span> <span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">mmap_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_copy_to_udata</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uresp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">uresp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err8</span><span class="p">;</span>
		<span class="n">mm1</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">sq_key</span><span class="p">;</span>
		<span class="n">mm1</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">;</span>
		<span class="n">mm1</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">memsize</span><span class="p">);</span>
		<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm1</span><span class="p">);</span>
		<span class="n">mm2</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">rq_key</span><span class="p">;</span>
		<span class="n">mm2</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">mm2</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">memsize</span><span class="p">);</span>
		<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm2</span><span class="p">);</span>
		<span class="n">mm3</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">sq_db_gts_key</span><span class="p">;</span>
		<span class="n">mm3</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">udb</span><span class="p">;</span>
		<span class="n">mm3</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm3</span><span class="p">);</span>
		<span class="n">mm4</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">rq_db_gts_key</span><span class="p">;</span>
		<span class="n">mm4</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">udb</span><span class="p">;</span>
		<span class="n">mm4</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mm5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mm5</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">uresp</span><span class="p">.</span><span class="n">ma_sync_key</span><span class="p">;</span>
			<span class="n">mm5</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">lldi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">+</span> <span class="n">A_PCIE_MA_SYNC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">mm5</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">insert_mmap</span><span class="p">(</span><span class="n">ucontext</span><span class="p">,</span> <span class="n">mm5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">.</span><span class="n">qp_num</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">));</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s qhp %p sq_num_entries %d, rq_num_entries %d qpid 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sq_num_entries</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">rq_num_entries</span><span class="p">,</span>
	     <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">ibqp</span><span class="p">;</span>
<span class="nl">err8:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm5</span><span class="p">);</span>
<span class="nl">err7:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm4</span><span class="p">);</span>
<span class="nl">err6:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm3</span><span class="p">);</span>
<span class="nl">err5:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm2</span><span class="p">);</span>
<span class="nl">err4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mm1</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">remove_handle</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">qpidr</span><span class="p">,</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">sq</span><span class="p">.</span><span class="n">qid</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">destroy_qp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
		   <span class="n">ucontext</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ucontext</span><span class="o">-&gt;</span><span class="n">uctx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">.</span><span class="n">uctx</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qhp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_ib_modify_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">attr_mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_udata</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_dev</span> <span class="o">*</span><span class="n">rhp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">c4iw_qp_attr_mask</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4iw_qp_attributes</span> <span class="n">attrs</span><span class="p">;</span>

	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_qp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ibqp</span><span class="p">);</span>

	<span class="cm">/* iwarp does not support the RTR state */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_STATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_state</span> <span class="o">==</span> <span class="n">IB_QPS_RTR</span><span class="p">))</span>
		<span class="n">attr_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IB_QP_STATE</span><span class="p">;</span>

	<span class="cm">/* Make sure we still have something left to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="n">qhp</span> <span class="o">=</span> <span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>
	<span class="n">rhp</span> <span class="o">=</span> <span class="n">qhp</span><span class="o">-&gt;</span><span class="n">rhp</span><span class="p">;</span>

	<span class="n">attrs</span><span class="p">.</span><span class="n">next_state</span> <span class="o">=</span> <span class="n">c4iw_convert_state</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_state</span><span class="p">);</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">enable_rdma_read</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_access_flags</span> <span class="o">&amp;</span>
			       <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">)</span> <span class="o">?</span>  <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">enable_rdma_write</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_access_flags</span> <span class="o">&amp;</span>
				<span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">enable_bind</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_access_flags</span> <span class="o">&amp;</span> <span class="n">IB_ACCESS_MW_BIND</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_STATE</span><span class="p">)</span> <span class="o">?</span> <span class="n">C4IW_QP_ATTR_NEXT_STATE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_ACCESS_FLAGS</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">C4IW_QP_ATTR_ENABLE_RDMA_READ</span> <span class="o">|</span>
			 <span class="n">C4IW_QP_ATTR_ENABLE_RDMA_WRITE</span> <span class="o">|</span>
			 <span class="n">C4IW_QP_ATTR_ENABLE_RDMA_BIND</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use SQ_PSN and RQ_PSN to pass in IDX_INC values for</span>
<span class="cm">	 * ringing the queue db when we&#39;re in DB_FULL mode.</span>
<span class="cm">	 */</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">sq_db_inc</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">sq_psn</span><span class="p">;</span>
	<span class="n">attrs</span><span class="p">.</span><span class="n">rq_db_inc</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">rq_psn</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_SQ_PSN</span><span class="p">)</span> <span class="o">?</span> <span class="n">C4IW_QP_ATTR_SQ_DB</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">attr_mask</span> <span class="o">&amp;</span> <span class="n">IB_QP_RQ_PSN</span><span class="p">)</span> <span class="o">?</span> <span class="n">C4IW_QP_ATTR_RQ_DB</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">c4iw_modify_qp</span><span class="p">(</span><span class="n">rhp</span><span class="p">,</span> <span class="n">qhp</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="nf">c4iw_get_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qpn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDBG</span><span class="p">(</span><span class="s">&quot;%s ib_dev %p qpn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">qpn</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="p">)</span><span class="n">get_qhp</span><span class="p">(</span><span class="n">to_c4iw_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">qpn</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">c4iw_ib_query_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">ibqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">attr_mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c4iw_qp</span> <span class="o">*</span><span class="n">qhp</span> <span class="o">=</span> <span class="n">to_c4iw_qp</span><span class="p">(</span><span class="n">ibqp</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">init_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">init_attr</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">qp_state</span> <span class="o">=</span> <span class="n">to_ib_qp_state</span><span class="p">(</span><span class="n">qhp</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
