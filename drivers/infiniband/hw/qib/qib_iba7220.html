<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › infiniband › hw › qib › qib_iba7220.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>qib_iba7220.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006, 2007, 2008, 2009, 2010 QLogic Corporation.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> * Copyright (c) 2003, 2004, 2005, 2006 PathScale, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * This file contains all of the code that is specific to the</span>
<span class="cm"> * QLogic_IB 7220 chip (except that specific to the SerDes)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>

<span class="cp">#include &quot;qib.h&quot;</span>
<span class="cp">#include &quot;qib_7220.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_setup_7220_setextled</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_7220_handle_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sendctrl_7220_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">op</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">qib_7220_iblink_state</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">qib_7220_phys_portstate</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_sdma_update_7220_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qib_set_ib_7220_lstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains almost all the chip-specific register information and</span>
<span class="cm"> * access functions for the QLogic QLogic_IB 7220 PCI-Express chip, with the</span>
<span class="cm"> * exception of SerDes support, which in in qib_sd7220.c.</span>
<span class="cm"> */</span>

<span class="cm">/* Below uses machine-generated qib_chipnum_regs.h file */</span>
<span class="cp">#define KREG_IDX(regname) (QIB_7220_##regname##_OFFS / sizeof(u64))</span>

<span class="cm">/* Use defines to tie machine-generated names to lower-case names */</span>
<span class="cp">#define kr_control KREG_IDX(Control)</span>
<span class="cp">#define kr_counterregbase KREG_IDX(CntrRegBase)</span>
<span class="cp">#define kr_errclear KREG_IDX(ErrClear)</span>
<span class="cp">#define kr_errmask KREG_IDX(ErrMask)</span>
<span class="cp">#define kr_errstatus KREG_IDX(ErrStatus)</span>
<span class="cp">#define kr_extctrl KREG_IDX(EXTCtrl)</span>
<span class="cp">#define kr_extstatus KREG_IDX(EXTStatus)</span>
<span class="cp">#define kr_gpio_clear KREG_IDX(GPIOClear)</span>
<span class="cp">#define kr_gpio_mask KREG_IDX(GPIOMask)</span>
<span class="cp">#define kr_gpio_out KREG_IDX(GPIOOut)</span>
<span class="cp">#define kr_gpio_status KREG_IDX(GPIOStatus)</span>
<span class="cp">#define kr_hrtbt_guid KREG_IDX(HRTBT_GUID)</span>
<span class="cp">#define kr_hwdiagctrl KREG_IDX(HwDiagCtrl)</span>
<span class="cp">#define kr_hwerrclear KREG_IDX(HwErrClear)</span>
<span class="cp">#define kr_hwerrmask KREG_IDX(HwErrMask)</span>
<span class="cp">#define kr_hwerrstatus KREG_IDX(HwErrStatus)</span>
<span class="cp">#define kr_ibcctrl KREG_IDX(IBCCtrl)</span>
<span class="cp">#define kr_ibcddrctrl KREG_IDX(IBCDDRCtrl)</span>
<span class="cp">#define kr_ibcddrstatus KREG_IDX(IBCDDRStatus)</span>
<span class="cp">#define kr_ibcstatus KREG_IDX(IBCStatus)</span>
<span class="cp">#define kr_ibserdesctrl KREG_IDX(IBSerDesCtrl)</span>
<span class="cp">#define kr_intclear KREG_IDX(IntClear)</span>
<span class="cp">#define kr_intmask KREG_IDX(IntMask)</span>
<span class="cp">#define kr_intstatus KREG_IDX(IntStatus)</span>
<span class="cp">#define kr_ncmodectrl KREG_IDX(IBNCModeCtrl)</span>
<span class="cp">#define kr_palign KREG_IDX(PageAlign)</span>
<span class="cp">#define kr_partitionkey KREG_IDX(RcvPartitionKey)</span>
<span class="cp">#define kr_portcnt KREG_IDX(PortCnt)</span>
<span class="cp">#define kr_rcvbthqp KREG_IDX(RcvBTHQP)</span>
<span class="cp">#define kr_rcvctrl KREG_IDX(RcvCtrl)</span>
<span class="cp">#define kr_rcvegrbase KREG_IDX(RcvEgrBase)</span>
<span class="cp">#define kr_rcvegrcnt KREG_IDX(RcvEgrCnt)</span>
<span class="cp">#define kr_rcvhdrcnt KREG_IDX(RcvHdrCnt)</span>
<span class="cp">#define kr_rcvhdrentsize KREG_IDX(RcvHdrEntSize)</span>
<span class="cp">#define kr_rcvhdrsize KREG_IDX(RcvHdrSize)</span>
<span class="cp">#define kr_rcvpktledcnt KREG_IDX(RcvPktLEDCnt)</span>
<span class="cp">#define kr_rcvtidbase KREG_IDX(RcvTIDBase)</span>
<span class="cp">#define kr_rcvtidcnt KREG_IDX(RcvTIDCnt)</span>
<span class="cp">#define kr_revision KREG_IDX(Revision)</span>
<span class="cp">#define kr_scratch KREG_IDX(Scratch)</span>
<span class="cp">#define kr_sendbuffererror KREG_IDX(SendBufErr0)</span>
<span class="cp">#define kr_sendctrl KREG_IDX(SendCtrl)</span>
<span class="cp">#define kr_senddmabase KREG_IDX(SendDmaBase)</span>
<span class="cp">#define kr_senddmabufmask0 KREG_IDX(SendDmaBufMask0)</span>
<span class="cp">#define kr_senddmabufmask1 (KREG_IDX(SendDmaBufMask0) + 1)</span>
<span class="cp">#define kr_senddmabufmask2 (KREG_IDX(SendDmaBufMask0) + 2)</span>
<span class="cp">#define kr_senddmahead KREG_IDX(SendDmaHead)</span>
<span class="cp">#define kr_senddmaheadaddr KREG_IDX(SendDmaHeadAddr)</span>
<span class="cp">#define kr_senddmalengen KREG_IDX(SendDmaLenGen)</span>
<span class="cp">#define kr_senddmastatus KREG_IDX(SendDmaStatus)</span>
<span class="cp">#define kr_senddmatail KREG_IDX(SendDmaTail)</span>
<span class="cp">#define kr_sendpioavailaddr KREG_IDX(SendBufAvailAddr)</span>
<span class="cp">#define kr_sendpiobufbase KREG_IDX(SendBufBase)</span>
<span class="cp">#define kr_sendpiobufcnt KREG_IDX(SendBufCnt)</span>
<span class="cp">#define kr_sendpiosize KREG_IDX(SendBufSize)</span>
<span class="cp">#define kr_sendregbase KREG_IDX(SendRegBase)</span>
<span class="cp">#define kr_userregbase KREG_IDX(UserRegBase)</span>
<span class="cp">#define kr_xgxs_cfg KREG_IDX(XGXSCfg)</span>

<span class="cm">/* These must only be written via qib_write_kreg_ctxt() */</span>
<span class="cp">#define kr_rcvhdraddr KREG_IDX(RcvHdrAddr0)</span>
<span class="cp">#define kr_rcvhdrtailaddr KREG_IDX(RcvHdrTailAddr0)</span>


<span class="cp">#define CREG_IDX(regname) ((QIB_7220_##regname##_OFFS - \</span>
<span class="cp">			QIB_7220_LBIntCnt_OFFS) / sizeof(u64))</span>

<span class="cp">#define cr_badformat CREG_IDX(RxVersionErrCnt)</span>
<span class="cp">#define cr_erricrc CREG_IDX(RxICRCErrCnt)</span>
<span class="cp">#define cr_errlink CREG_IDX(RxLinkMalformCnt)</span>
<span class="cp">#define cr_errlpcrc CREG_IDX(RxLPCRCErrCnt)</span>
<span class="cp">#define cr_errpkey CREG_IDX(RxPKeyMismatchCnt)</span>
<span class="cp">#define cr_rcvflowctrl_err CREG_IDX(RxFlowCtrlViolCnt)</span>
<span class="cp">#define cr_err_rlen CREG_IDX(RxLenErrCnt)</span>
<span class="cp">#define cr_errslen CREG_IDX(TxLenErrCnt)</span>
<span class="cp">#define cr_errtidfull CREG_IDX(RxTIDFullErrCnt)</span>
<span class="cp">#define cr_errtidvalid CREG_IDX(RxTIDValidErrCnt)</span>
<span class="cp">#define cr_errvcrc CREG_IDX(RxVCRCErrCnt)</span>
<span class="cp">#define cr_ibstatuschange CREG_IDX(IBStatusChangeCnt)</span>
<span class="cp">#define cr_lbint CREG_IDX(LBIntCnt)</span>
<span class="cp">#define cr_invalidrlen CREG_IDX(RxMaxMinLenErrCnt)</span>
<span class="cp">#define cr_invalidslen CREG_IDX(TxMaxMinLenErrCnt)</span>
<span class="cp">#define cr_lbflowstall CREG_IDX(LBFlowStallCnt)</span>
<span class="cp">#define cr_pktrcv CREG_IDX(RxDataPktCnt)</span>
<span class="cp">#define cr_pktrcvflowctrl CREG_IDX(RxFlowPktCnt)</span>
<span class="cp">#define cr_pktsend CREG_IDX(TxDataPktCnt)</span>
<span class="cp">#define cr_pktsendflow CREG_IDX(TxFlowPktCnt)</span>
<span class="cp">#define cr_portovfl CREG_IDX(RxP0HdrEgrOvflCnt)</span>
<span class="cp">#define cr_rcvebp CREG_IDX(RxEBPCnt)</span>
<span class="cp">#define cr_rcvovfl CREG_IDX(RxBufOvflCnt)</span>
<span class="cp">#define cr_senddropped CREG_IDX(TxDroppedPktCnt)</span>
<span class="cp">#define cr_sendstall CREG_IDX(TxFlowStallCnt)</span>
<span class="cp">#define cr_sendunderrun CREG_IDX(TxUnderrunCnt)</span>
<span class="cp">#define cr_wordrcv CREG_IDX(RxDwordCnt)</span>
<span class="cp">#define cr_wordsend CREG_IDX(TxDwordCnt)</span>
<span class="cp">#define cr_txunsupvl CREG_IDX(TxUnsupVLErrCnt)</span>
<span class="cp">#define cr_rxdroppkt CREG_IDX(RxDroppedPktCnt)</span>
<span class="cp">#define cr_iblinkerrrecov CREG_IDX(IBLinkErrRecoveryCnt)</span>
<span class="cp">#define cr_iblinkdown CREG_IDX(IBLinkDownedCnt)</span>
<span class="cp">#define cr_ibsymbolerr CREG_IDX(IBSymbolErrCnt)</span>
<span class="cp">#define cr_vl15droppedpkt CREG_IDX(RxVL15DroppedPktCnt)</span>
<span class="cp">#define cr_rxotherlocalphyerr CREG_IDX(RxOtherLocalPhyErrCnt)</span>
<span class="cp">#define cr_excessbufferovfl CREG_IDX(ExcessBufferOvflCnt)</span>
<span class="cp">#define cr_locallinkintegrityerr CREG_IDX(LocalLinkIntegrityErrCnt)</span>
<span class="cp">#define cr_rxvlerr CREG_IDX(RxVlErrCnt)</span>
<span class="cp">#define cr_rxdlidfltr CREG_IDX(RxDlidFltrCnt)</span>
<span class="cp">#define cr_psstat CREG_IDX(PSStat)</span>
<span class="cp">#define cr_psstart CREG_IDX(PSStart)</span>
<span class="cp">#define cr_psinterval CREG_IDX(PSInterval)</span>
<span class="cp">#define cr_psrcvdatacount CREG_IDX(PSRcvDataCount)</span>
<span class="cp">#define cr_psrcvpktscount CREG_IDX(PSRcvPktsCount)</span>
<span class="cp">#define cr_psxmitdatacount CREG_IDX(PSXmitDataCount)</span>
<span class="cp">#define cr_psxmitpktscount CREG_IDX(PSXmitPktsCount)</span>
<span class="cp">#define cr_psxmitwaitcount CREG_IDX(PSXmitWaitCount)</span>
<span class="cp">#define cr_txsdmadesc CREG_IDX(TxSDmaDescCnt)</span>
<span class="cp">#define cr_pcieretrydiag CREG_IDX(PcieRetryBufDiagQwordCnt)</span>

<span class="cp">#define SYM_RMASK(regname, fldname) ((u64)              \</span>
<span class="cp">	QIB_7220_##regname##_##fldname##_RMASK)</span>
<span class="cp">#define SYM_MASK(regname, fldname) ((u64)               \</span>
<span class="cp">	QIB_7220_##regname##_##fldname##_RMASK &lt;&lt;       \</span>
<span class="cp">	 QIB_7220_##regname##_##fldname##_LSB)</span>
<span class="cp">#define SYM_LSB(regname, fldname) (QIB_7220_##regname##_##fldname##_LSB)</span>
<span class="cp">#define SYM_FIELD(value, regname, fldname) ((u64) \</span>
<span class="cp">	(((value) &gt;&gt; SYM_LSB(regname, fldname)) &amp; \</span>
<span class="cp">	 SYM_RMASK(regname, fldname)))</span>
<span class="cp">#define ERR_MASK(fldname) SYM_MASK(ErrMask, fldname##Mask)</span>
<span class="cp">#define HWE_MASK(fldname) SYM_MASK(HwErrMask, fldname##Mask)</span>

<span class="cm">/* ibcctrl bits */</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_DISABLE 1</span>
<span class="cm">/* cycle through TS1/TS2 till OK */</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_POLL 2</span>
<span class="cm">/* wait for TS1, then go on */</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_SLEEP 3</span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKINITCMD_SHIFT 16</span>

<span class="cp">#define QLOGIC_IB_IBCC_LINKCMD_DOWN 1           </span><span class="cm">/* move to 0x11 */</span><span class="cp"></span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKCMD_ARMED 2          </span><span class="cm">/* move to 0x21 */</span><span class="cp"></span>
<span class="cp">#define QLOGIC_IB_IBCC_LINKCMD_ACTIVE 3 </span><span class="cm">/* move to 0x31 */</span><span class="cp"></span>

<span class="cp">#define BLOB_7220_IBCHG 0x81</span>

<span class="cm">/*</span>
<span class="cm"> * We could have a single register get/put routine, that takes a group type,</span>
<span class="cm"> * but this is somewhat clearer and cleaner.  It also gives us some error</span>
<span class="cm"> * checking.  64 bit register reads should always work, but are inefficient</span>
<span class="cm"> * on opteron (the northbridge always generates 2 separate HT 32 bit reads),</span>
<span class="cm"> * so we use kreg32 wherever possible.  User register and counter register</span>
<span class="cm"> * reads are always 32 bit reads, so only one form of those routines.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * qib_read_ureg32 - read 32-bit virtualized per-context register</span>
<span class="cm"> * @dd: device</span>
<span class="cm"> * @regno: register number</span>
<span class="cm"> * @ctxt: context number</span>
<span class="cm"> *</span>
<span class="cm"> * Return the contents of a register that is virtualized to be per context.</span>
<span class="cm"> * Returns -1 on errors (not distinguishable from valid contents at</span>
<span class="cm"> * runtime; we may add a separate error variable at some point).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">qib_read_ureg32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">qib_ureg</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			     <span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">+</span>
			      <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			     <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span> <span class="o">+</span>
			      <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
			      <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_write_ureg - write 32-bit virtualized per-context register</span>
<span class="cm"> * @dd: device</span>
<span class="cm"> * @regno: register number</span>
<span class="cm"> * @value: value</span>
<span class="cm"> * @ctxt: context</span>
<span class="cm"> *</span>
<span class="cm"> * Write the contents of a register that is virtualized to be per context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qib_write_ureg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">qib_ureg</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ubase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span><span class="p">)</span>
		<span class="n">ubase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">userbase</span> <span class="o">+</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ubase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span> <span class="o">+</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
			 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">*</span> <span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_write_kreg_ctxt - write a device&#39;s per-ctxt 64-bit kernel register</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @regno: the register number to write</span>
<span class="cm"> * @ctxt: the context containing the register</span>
<span class="cm"> * @value: the value to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qib_write_kreg_ctxt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ctxt</span><span class="p">,</span>
				       <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">regno</span> <span class="o">+</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_7220_creg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">read_7220_creg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">read_7220_creg32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_PRESENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span><span class="p">[</span><span class="n">regno</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* kr_revision bits */</span>
<span class="cp">#define QLOGIC_IB_R_EMULATORREV_MASK ((1ULL &lt;&lt; 22) - 1)</span>
<span class="cp">#define QLOGIC_IB_R_EMULATORREV_SHIFT 40</span>

<span class="cm">/* kr_control bits */</span>
<span class="cp">#define QLOGIC_IB_C_RESET (1U &lt;&lt; 7)</span>

<span class="cm">/* kr_intstatus, kr_intclear, kr_intmask bits */</span>
<span class="cp">#define QLOGIC_IB_I_RCVURG_MASK ((1ULL &lt;&lt; 17) - 1)</span>
<span class="cp">#define QLOGIC_IB_I_RCVURG_SHIFT 32</span>
<span class="cp">#define QLOGIC_IB_I_RCVAVAIL_MASK ((1ULL &lt;&lt; 17) - 1)</span>
<span class="cp">#define QLOGIC_IB_I_RCVAVAIL_SHIFT 0</span>
<span class="cp">#define QLOGIC_IB_I_SERDESTRIMDONE (1ULL &lt;&lt; 27)</span>

<span class="cp">#define QLOGIC_IB_C_FREEZEMODE 0x00000002</span>
<span class="cp">#define QLOGIC_IB_C_LINKENABLE 0x00000004</span>

<span class="cp">#define QLOGIC_IB_I_SDMAINT             0x8000000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_I_SDMADISABLED        0x4000000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_I_ERROR               0x0000000080000000ULL</span>
<span class="cp">#define QLOGIC_IB_I_SPIOSENT            0x0000000040000000ULL</span>
<span class="cp">#define QLOGIC_IB_I_SPIOBUFAVAIL        0x0000000020000000ULL</span>
<span class="cp">#define QLOGIC_IB_I_GPIO                0x0000000010000000ULL</span>

<span class="cm">/* variables for sanity checking interrupt and errors */</span>
<span class="cp">#define QLOGIC_IB_I_BITSEXTANT \</span>
<span class="cp">		(QLOGIC_IB_I_SDMAINT | QLOGIC_IB_I_SDMADISABLED | \</span>
<span class="cp">		(QLOGIC_IB_I_RCVURG_MASK &lt;&lt; QLOGIC_IB_I_RCVURG_SHIFT) | \</span>
<span class="cp">		(QLOGIC_IB_I_RCVAVAIL_MASK &lt;&lt; \</span>
<span class="cp">		 QLOGIC_IB_I_RCVAVAIL_SHIFT) | \</span>
<span class="cp">		QLOGIC_IB_I_ERROR | QLOGIC_IB_I_SPIOSENT | \</span>
<span class="cp">		QLOGIC_IB_I_SPIOBUFAVAIL | QLOGIC_IB_I_GPIO | \</span>
<span class="cp">		QLOGIC_IB_I_SERDESTRIMDONE)</span>

<span class="cp">#define IB_HWE_BITSEXTANT \</span>
<span class="cp">	       (HWE_MASK(RXEMemParityErr) | \</span>
<span class="cp">		HWE_MASK(TXEMemParityErr) | \</span>
<span class="cp">		(QLOGIC_IB_HWE_PCIEMEMPARITYERR_MASK &lt;&lt;	 \</span>
<span class="cp">		 QLOGIC_IB_HWE_PCIEMEMPARITYERR_SHIFT) | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIE1PLLFAILED | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIE0PLLFAILED | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIEPOISONEDTLP | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIECPLTIMEOUT | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIEBUSPARITYXTLH | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIEBUSPARITYXADM | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIEBUSPARITYRADM | \</span>
<span class="cp">		HWE_MASK(PowerOnBISTFailed) |	  \</span>
<span class="cp">		QLOGIC_IB_HWE_COREPLL_FBSLIP | \</span>
<span class="cp">		QLOGIC_IB_HWE_COREPLL_RFSLIP | \</span>
<span class="cp">		QLOGIC_IB_HWE_SERDESPLLFAILED | \</span>
<span class="cp">		HWE_MASK(IBCBusToSPCParityErr) | \</span>
<span class="cp">		HWE_MASK(IBCBusFromSPCParityErr) | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIECPLDATAQUEUEERR | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIECPLHDRQUEUEERR | \</span>
<span class="cp">		QLOGIC_IB_HWE_SDMAMEMREADERR | \</span>
<span class="cp">		QLOGIC_IB_HWE_CLK_UC_PLLNOTLOCKED | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIESERDESQ0PCLKNOTDETECT | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIESERDESQ1PCLKNOTDETECT | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIESERDESQ2PCLKNOTDETECT | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIESERDESQ3PCLKNOTDETECT | \</span>
<span class="cp">		QLOGIC_IB_HWE_DDSRXEQMEMORYPARITYERR | \</span>
<span class="cp">		QLOGIC_IB_HWE_IB_UC_MEMORYPARITYERR | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIE_UC_OCT0MEMORYPARITYERR | \</span>
<span class="cp">		QLOGIC_IB_HWE_PCIE_UC_OCT1MEMORYPARITYERR)</span>

<span class="cp">#define IB_E_BITSEXTANT							\</span>
<span class="cp">	(ERR_MASK(RcvFormatErr) | ERR_MASK(RcvVCRCErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvICRCErr) | ERR_MASK(RcvMinPktLenErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvMaxPktLenErr) | ERR_MASK(RcvLongPktLenErr) |	\</span>
<span class="cp">	 ERR_MASK(RcvShortPktLenErr) | ERR_MASK(RcvUnexpectedCharErr) | \</span>
<span class="cp">	 ERR_MASK(RcvUnsupportedVLErr) | ERR_MASK(RcvEBPErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvIBFlowErr) | ERR_MASK(RcvBadVersionErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvEgrFullErr) | ERR_MASK(RcvHdrFullErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvBadTidErr) | ERR_MASK(RcvHdrLenErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvHdrErr) | ERR_MASK(RcvIBLostLinkErr) |		\</span>
<span class="cp">	 ERR_MASK(SendSpecialTriggerErr) |				\</span>
<span class="cp">	 ERR_MASK(SDmaDisabledErr) | ERR_MASK(SendMinPktLenErr) |	\</span>
<span class="cp">	 ERR_MASK(SendMaxPktLenErr) | ERR_MASK(SendUnderRunErr) |	\</span>
<span class="cp">	 ERR_MASK(SendPktLenErr) | ERR_MASK(SendDroppedSmpPktErr) |	\</span>
<span class="cp">	 ERR_MASK(SendDroppedDataPktErr) |				\</span>
<span class="cp">	 ERR_MASK(SendPioArmLaunchErr) |				\</span>
<span class="cp">	 ERR_MASK(SendUnexpectedPktNumErr) |				\</span>
<span class="cp">	 ERR_MASK(SendUnsupportedVLErr) | ERR_MASK(SendBufMisuseErr) |	\</span>
<span class="cp">	 ERR_MASK(SDmaGenMismatchErr) | ERR_MASK(SDmaOutOfBoundErr) |	\</span>
<span class="cp">	 ERR_MASK(SDmaTailOutOfBoundErr) | ERR_MASK(SDmaBaseErr) |	\</span>
<span class="cp">	 ERR_MASK(SDma1stDescErr) | ERR_MASK(SDmaRpyTagErr) |		\</span>
<span class="cp">	 ERR_MASK(SDmaDwEnErr) | ERR_MASK(SDmaMissingDwErr) |		\</span>
<span class="cp">	 ERR_MASK(SDmaUnexpDataErr) |					\</span>
<span class="cp">	 ERR_MASK(IBStatusChanged) | ERR_MASK(InvalidAddrErr) |		\</span>
<span class="cp">	 ERR_MASK(ResetNegated) | ERR_MASK(HardwareErr) |		\</span>
<span class="cp">	 ERR_MASK(SDmaDescAddrMisalignErr) |				\</span>
<span class="cp">	 ERR_MASK(InvalidEEPCmd))</span>

<span class="cm">/* kr_hwerrclear, kr_hwerrmask, kr_hwerrstatus, bits */</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIEMEMPARITYERR_MASK  0x00000000000000ffULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIEMEMPARITYERR_SHIFT 0</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIEPOISONEDTLP      0x0000000010000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIECPLTIMEOUT       0x0000000020000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIEBUSPARITYXTLH    0x0000000040000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIEBUSPARITYXADM    0x0000000080000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIEBUSPARITYRADM    0x0000000100000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_COREPLL_FBSLIP       0x0080000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_COREPLL_RFSLIP       0x0100000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIE1PLLFAILED       0x0400000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIE0PLLFAILED       0x0800000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_SERDESPLLFAILED      0x1000000000000000ULL</span>
<span class="cm">/* specific to this chip */</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIECPLDATAQUEUEERR         0x0000000000000040ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIECPLHDRQUEUEERR          0x0000000000000080ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_SDMAMEMREADERR              0x0000000010000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_CLK_UC_PLLNOTLOCKED          0x2000000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIESERDESQ0PCLKNOTDETECT   0x0100000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIESERDESQ1PCLKNOTDETECT   0x0200000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIESERDESQ2PCLKNOTDETECT   0x0400000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIESERDESQ3PCLKNOTDETECT   0x0800000000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_DDSRXEQMEMORYPARITYERR       0x0000008000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_IB_UC_MEMORYPARITYERR        0x0000004000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIE_UC_OCT0MEMORYPARITYERR 0x0000001000000000ULL</span>
<span class="cp">#define QLOGIC_IB_HWE_PCIE_UC_OCT1MEMORYPARITYERR 0x0000002000000000ULL</span>

<span class="cp">#define IBA7220_IBCC_LINKCMD_SHIFT 19</span>

<span class="cm">/* kr_ibcddrctrl bits */</span>
<span class="cp">#define IBA7220_IBC_DLIDLMC_MASK        0xFFFFFFFFUL</span>
<span class="cp">#define IBA7220_IBC_DLIDLMC_SHIFT       32</span>

<span class="cp">#define IBA7220_IBC_HRTBT_MASK  (SYM_RMASK(IBCDDRCtrl, HRTBT_AUTO) | \</span>
<span class="cp">				 SYM_RMASK(IBCDDRCtrl, HRTBT_ENB))</span>
<span class="cp">#define IBA7220_IBC_HRTBT_SHIFT SYM_LSB(IBCDDRCtrl, HRTBT_ENB)</span>

<span class="cp">#define IBA7220_IBC_LANE_REV_SUPPORTED (1&lt;&lt;8)</span>
<span class="cp">#define IBA7220_IBC_LREV_MASK   1</span>
<span class="cp">#define IBA7220_IBC_LREV_SHIFT  8</span>
<span class="cp">#define IBA7220_IBC_RXPOL_MASK  1</span>
<span class="cp">#define IBA7220_IBC_RXPOL_SHIFT 7</span>
<span class="cp">#define IBA7220_IBC_WIDTH_SHIFT 5</span>
<span class="cp">#define IBA7220_IBC_WIDTH_MASK  0x3</span>
<span class="cp">#define IBA7220_IBC_WIDTH_1X_ONLY       (0 &lt;&lt; IBA7220_IBC_WIDTH_SHIFT)</span>
<span class="cp">#define IBA7220_IBC_WIDTH_4X_ONLY       (1 &lt;&lt; IBA7220_IBC_WIDTH_SHIFT)</span>
<span class="cp">#define IBA7220_IBC_WIDTH_AUTONEG       (2 &lt;&lt; IBA7220_IBC_WIDTH_SHIFT)</span>
<span class="cp">#define IBA7220_IBC_SPEED_AUTONEG       (1 &lt;&lt; 1)</span>
<span class="cp">#define IBA7220_IBC_SPEED_SDR           (1 &lt;&lt; 2)</span>
<span class="cp">#define IBA7220_IBC_SPEED_DDR           (1 &lt;&lt; 3)</span>
<span class="cp">#define IBA7220_IBC_SPEED_AUTONEG_MASK  (0x7 &lt;&lt; 1)</span>
<span class="cp">#define IBA7220_IBC_IBTA_1_2_MASK       (1)</span>

<span class="cm">/* kr_ibcddrstatus */</span>
<span class="cm">/* link latency shift is 0, don&#39;t bother defining */</span>
<span class="cp">#define IBA7220_DDRSTAT_LINKLAT_MASK    0x3ffffff</span>

<span class="cm">/* kr_extstatus bits */</span>
<span class="cp">#define QLOGIC_IB_EXTS_FREQSEL 0x2</span>
<span class="cp">#define QLOGIC_IB_EXTS_SERDESSEL 0x4</span>
<span class="cp">#define QLOGIC_IB_EXTS_MEMBIST_ENDTEST     0x0000000000004000</span>
<span class="cp">#define QLOGIC_IB_EXTS_MEMBIST_DISABLED    0x0000000000008000</span>

<span class="cm">/* kr_xgxsconfig bits */</span>
<span class="cp">#define QLOGIC_IB_XGXS_RESET          0x5ULL</span>
<span class="cp">#define QLOGIC_IB_XGXS_FC_SAFE        (1ULL &lt;&lt; 63)</span>

<span class="cm">/* kr_rcvpktledcnt */</span>
<span class="cp">#define IBA7220_LEDBLINK_ON_SHIFT 32 </span><span class="cm">/* 4ns period on after packet */</span><span class="cp"></span>
<span class="cp">#define IBA7220_LEDBLINK_OFF_SHIFT 0 </span><span class="cm">/* 4ns period off before next on */</span><span class="cp"></span>

<span class="cp">#define _QIB_GPIO_SDA_NUM 1</span>
<span class="cp">#define _QIB_GPIO_SCL_NUM 0</span>
<span class="cp">#define QIB_TWSI_EEPROM_DEV 0xA2 </span><span class="cm">/* All Production 7220 cards. */</span><span class="cp"></span>
<span class="cp">#define QIB_TWSI_TEMP_DEV 0x98</span>

<span class="cm">/* HW counter clock is at 4nsec */</span>
<span class="cp">#define QIB_7220_PSXMITWAIT_CHECK_RATE 4000</span>

<span class="cp">#define IBA7220_R_INTRAVAIL_SHIFT 17</span>
<span class="cp">#define IBA7220_R_PKEY_DIS_SHIFT 34</span>
<span class="cp">#define IBA7220_R_TAILUPD_SHIFT 35</span>
<span class="cp">#define IBA7220_R_CTXTCFG_SHIFT 36</span>

<span class="cp">#define IBA7220_HDRHEAD_PKTINT_SHIFT 32 </span><span class="cm">/* interrupt cnt in upper 32 bits */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * the size bits give us 2^N, in KB units.  0 marks as invalid,</span>
<span class="cm"> * and 7 is reserved.  We currently use only 2KB and 4KB</span>
<span class="cm"> */</span>
<span class="cp">#define IBA7220_TID_SZ_SHIFT 37 </span><span class="cm">/* shift to 3bit size selector */</span><span class="cp"></span>
<span class="cp">#define IBA7220_TID_SZ_2K (1UL &lt;&lt; IBA7220_TID_SZ_SHIFT) </span><span class="cm">/* 2KB */</span><span class="cp"></span>
<span class="cp">#define IBA7220_TID_SZ_4K (2UL &lt;&lt; IBA7220_TID_SZ_SHIFT) </span><span class="cm">/* 4KB */</span><span class="cp"></span>
<span class="cp">#define IBA7220_TID_PA_SHIFT 11U </span><span class="cm">/* TID addr in chip stored w/o low bits */</span><span class="cp"></span>
<span class="cp">#define PBC_7220_VL15_SEND (1ULL &lt;&lt; 63) </span><span class="cm">/* pbc; VL15, no credit check */</span><span class="cp"></span>
<span class="cp">#define PBC_7220_VL15_SEND_CTRL (1ULL &lt;&lt; 31) </span><span class="cm">/* control version of same */</span><span class="cp"></span>

<span class="cp">#define AUTONEG_TRIES 5 </span><span class="cm">/* sequential retries to negotiate DDR */</span><span class="cp"></span>

<span class="cm">/* packet rate matching delay multiplier */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">rate_to_delay</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 1x, 4x */</span>
	<span class="p">{</span>   <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* SDR */</span>
	<span class="p">{</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="p">}</span>  <span class="cm">/* DDR */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">ib_rate_to_delay</span><span class="p">[</span><span class="n">IB_RATE_120_GBPS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IB_RATE_2_5_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_5_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_10_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_RATE_20_GBPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#define IBA7220_LINKSPEED_SHIFT SYM_LSB(IBCStatus, LinkSpeedActive)</span>
<span class="cp">#define IBA7220_LINKWIDTH_SHIFT SYM_LSB(IBCStatus, LinkWidthActive)</span>

<span class="cm">/* link training states, from IBC */</span>
<span class="cp">#define IB_7220_LT_STATE_DISABLED        0x00</span>
<span class="cp">#define IB_7220_LT_STATE_LINKUP          0x01</span>
<span class="cp">#define IB_7220_LT_STATE_POLLACTIVE      0x02</span>
<span class="cp">#define IB_7220_LT_STATE_POLLQUIET       0x03</span>
<span class="cp">#define IB_7220_LT_STATE_SLEEPDELAY      0x04</span>
<span class="cp">#define IB_7220_LT_STATE_SLEEPQUIET      0x05</span>
<span class="cp">#define IB_7220_LT_STATE_CFGDEBOUNCE     0x08</span>
<span class="cp">#define IB_7220_LT_STATE_CFGRCVFCFG      0x09</span>
<span class="cp">#define IB_7220_LT_STATE_CFGWAITRMT      0x0a</span>
<span class="cp">#define IB_7220_LT_STATE_CFGIDLE 0x0b</span>
<span class="cp">#define IB_7220_LT_STATE_RECOVERRETRAIN  0x0c</span>
<span class="cp">#define IB_7220_LT_STATE_RECOVERWAITRMT  0x0e</span>
<span class="cp">#define IB_7220_LT_STATE_RECOVERIDLE     0x0f</span>

<span class="cm">/* link state machine states from IBC */</span>
<span class="cp">#define IB_7220_L_STATE_DOWN             0x0</span>
<span class="cp">#define IB_7220_L_STATE_INIT             0x1</span>
<span class="cp">#define IB_7220_L_STATE_ARM              0x2</span>
<span class="cp">#define IB_7220_L_STATE_ACTIVE           0x3</span>
<span class="cp">#define IB_7220_L_STATE_ACT_DEFER        0x4</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">qib_7220_physportstate</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_DISABLED</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_DISABLED</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_LINKUP</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_LINKUP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_POLLACTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_POLL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_POLLQUIET</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_POLL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_SLEEPDELAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_SLEEP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_SLEEPQUIET</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_SLEEP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_CFGDEBOUNCE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_CFGRCVFCFG</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_CFGWAITRMT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_CFGIDLE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_RECOVERRETRAIN</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_RECOVERWAITRMT</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IB_7220_LT_STATE_RECOVERIDLE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="n">IB_PHYSPORTSTATE_CFG_TRAIN</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">qib_special_trigger</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">special_trigger</span><span class="p">,</span> <span class="n">qib_special_trigger</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">special_trigger</span><span class="p">,</span> <span class="s">&quot;Enable SpecialTrigger arm/launch&quot;</span><span class="p">);</span>

<span class="cp">#define IBCBUSFRSPCPARITYERR HWE_MASK(IBCBusFromSPCParityErr)</span>
<span class="cp">#define IBCBUSTOSPCPARITYERR HWE_MASK(IBCBusToSPCParityErr)</span>

<span class="cp">#define SYM_MASK_BIT(regname, fldname, bit) ((u64) \</span>
<span class="cp">	(1ULL &lt;&lt; (SYM_LSB(regname, fldname) + (bit))))</span>

<span class="cp">#define TXEMEMPARITYERR_PIOBUF \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, TXEMemParityErrMask, 0)</span>
<span class="cp">#define TXEMEMPARITYERR_PIOPBC \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, TXEMemParityErrMask, 1)</span>
<span class="cp">#define TXEMEMPARITYERR_PIOLAUNCHFIFO \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, TXEMemParityErrMask, 2)</span>

<span class="cp">#define RXEMEMPARITYERR_RCVBUF \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 0)</span>
<span class="cp">#define RXEMEMPARITYERR_LOOKUPQ \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 1)</span>
<span class="cp">#define RXEMEMPARITYERR_EXPTID \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 2)</span>
<span class="cp">#define RXEMEMPARITYERR_EAGERTID \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 3)</span>
<span class="cp">#define RXEMEMPARITYERR_FLAGBUF \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 4)</span>
<span class="cp">#define RXEMEMPARITYERR_DATAINFO \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 5)</span>
<span class="cp">#define RXEMEMPARITYERR_HDRINFO \</span>
<span class="cp">	SYM_MASK_BIT(HwErrMask, RXEMemParityErrMask, 6)</span>

<span class="cm">/* 7220 specific hardware errors... */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qib_hwerror_msgs</span> <span class="n">qib_7220_hwerror_msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* generic hardware errors */</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">IBCBUSFRSPCPARITYERR</span><span class="p">,</span> <span class="s">&quot;QIB2IB Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">IBCBUSTOSPCPARITYERR</span><span class="p">,</span> <span class="s">&quot;IB2QIB Parity&quot;</span><span class="p">),</span>

	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">TXEMEMPARITYERR_PIOBUF</span><span class="p">,</span>
			  <span class="s">&quot;TXE PIOBUF Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">TXEMEMPARITYERR_PIOPBC</span><span class="p">,</span>
			  <span class="s">&quot;TXE PIOPBC Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">TXEMEMPARITYERR_PIOLAUNCHFIFO</span><span class="p">,</span>
			  <span class="s">&quot;TXE PIOLAUNCHFIFO Memory Parity&quot;</span><span class="p">),</span>

	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_RCVBUF</span><span class="p">,</span>
			  <span class="s">&quot;RXE RCVBUF Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_LOOKUPQ</span><span class="p">,</span>
			  <span class="s">&quot;RXE LOOKUPQ Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_EAGERTID</span><span class="p">,</span>
			  <span class="s">&quot;RXE EAGERTID Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_EXPTID</span><span class="p">,</span>
			  <span class="s">&quot;RXE EXPTID Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_FLAGBUF</span><span class="p">,</span>
			  <span class="s">&quot;RXE FLAGBUF Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_DATAINFO</span><span class="p">,</span>
			  <span class="s">&quot;RXE DATAINFO Memory Parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">RXEMEMPARITYERR_HDRINFO</span><span class="p">,</span>
			  <span class="s">&quot;RXE HDRINFO Memory Parity&quot;</span><span class="p">),</span>

	<span class="cm">/* chip-specific hardware errors */</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIEPOISONEDTLP</span><span class="p">,</span>
			  <span class="s">&quot;PCIe Poisoned TLP&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIECPLTIMEOUT</span><span class="p">,</span>
			  <span class="s">&quot;PCIe completion timeout&quot;</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * In practice, it&#39;s unlikely wthat we&#39;ll see PCIe PLL, or bus</span>
<span class="cm">	 * parity or memory parity error failures, because most likely we</span>
<span class="cm">	 * won&#39;t be able to talk to the core of the chip.  Nonetheless, we</span>
<span class="cm">	 * might see them, if they are in parts of the PCIe core that aren&#39;t</span>
<span class="cm">	 * essential.</span>
<span class="cm">	 */</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIE1PLLFAILED</span><span class="p">,</span>
			  <span class="s">&quot;PCIePLL1&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIE0PLLFAILED</span><span class="p">,</span>
			  <span class="s">&quot;PCIePLL0&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIEBUSPARITYXTLH</span><span class="p">,</span>
			  <span class="s">&quot;PCIe XTLH core parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIEBUSPARITYXADM</span><span class="p">,</span>
			  <span class="s">&quot;PCIe ADM TX core parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIEBUSPARITYRADM</span><span class="p">,</span>
			  <span class="s">&quot;PCIe ADM RX core parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_SERDESPLLFAILED</span><span class="p">,</span>
			  <span class="s">&quot;SerDes PLL&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIECPLDATAQUEUEERR</span><span class="p">,</span>
			  <span class="s">&quot;PCIe cpl header queue&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIECPLHDRQUEUEERR</span><span class="p">,</span>
			  <span class="s">&quot;PCIe cpl data queue&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_SDMAMEMREADERR</span><span class="p">,</span>
			  <span class="s">&quot;Send DMA memory read&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_CLK_UC_PLLNOTLOCKED</span><span class="p">,</span>
			  <span class="s">&quot;uC PLL clock not locked&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIESERDESQ0PCLKNOTDETECT</span><span class="p">,</span>
			  <span class="s">&quot;PCIe serdes Q0 no clock&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIESERDESQ1PCLKNOTDETECT</span><span class="p">,</span>
			  <span class="s">&quot;PCIe serdes Q1 no clock&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIESERDESQ2PCLKNOTDETECT</span><span class="p">,</span>
			  <span class="s">&quot;PCIe serdes Q2 no clock&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIESERDESQ3PCLKNOTDETECT</span><span class="p">,</span>
			  <span class="s">&quot;PCIe serdes Q3 no clock&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_DDSRXEQMEMORYPARITYERR</span><span class="p">,</span>
			  <span class="s">&quot;DDS RXEQ memory parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_IB_UC_MEMORYPARITYERR</span><span class="p">,</span>
			  <span class="s">&quot;IB uC memory parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIE_UC_OCT0MEMORYPARITYERR</span><span class="p">,</span>
			  <span class="s">&quot;PCIe uC oct0 memory parity&quot;</span><span class="p">),</span>
	<span class="n">QLOGIC_IB_HWE_MSG</span><span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIE_UC_OCT1MEMORYPARITYERR</span><span class="p">,</span>
			  <span class="s">&quot;PCIe uC oct1 memory parity&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define RXE_PARITY (RXEMEMPARITYERR_EAGERTID|RXEMEMPARITYERR_EXPTID)</span>

<span class="cp">#define QLOGIC_IB_E_PKTERRS (\</span>
<span class="cp">		ERR_MASK(SendPktLenErr) |				\</span>
<span class="cp">		ERR_MASK(SendDroppedDataPktErr) |			\</span>
<span class="cp">		ERR_MASK(RcvVCRCErr) |					\</span>
<span class="cp">		ERR_MASK(RcvICRCErr) |					\</span>
<span class="cp">		ERR_MASK(RcvShortPktLenErr) |				\</span>
<span class="cp">		ERR_MASK(RcvEBPErr))</span>

<span class="cm">/* Convenience for decoding Send DMA errors */</span>
<span class="cp">#define QLOGIC_IB_E_SDMAERRS ( \</span>
<span class="cp">		ERR_MASK(SDmaGenMismatchErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaOutOfBoundErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaTailOutOfBoundErr) | ERR_MASK(SDmaBaseErr) | \</span>
<span class="cp">		ERR_MASK(SDma1stDescErr) | ERR_MASK(SDmaRpyTagErr) |	\</span>
<span class="cp">		ERR_MASK(SDmaDwEnErr) | ERR_MASK(SDmaMissingDwErr) |	\</span>
<span class="cp">		ERR_MASK(SDmaUnexpDataErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaDescAddrMisalignErr) |			\</span>
<span class="cp">		ERR_MASK(SDmaDisabledErr) |				\</span>
<span class="cp">		ERR_MASK(SendBufMisuseErr))</span>

<span class="cm">/* These are all rcv-related errors which we want to count for stats */</span>
<span class="cp">#define E_SUM_PKTERRS \</span>
<span class="cp">	(ERR_MASK(RcvHdrLenErr) | ERR_MASK(RcvBadTidErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvBadVersionErr) | ERR_MASK(RcvHdrErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvLongPktLenErr) | ERR_MASK(RcvShortPktLenErr) |	\</span>
<span class="cp">	 ERR_MASK(RcvMaxPktLenErr) | ERR_MASK(RcvMinPktLenErr) |	\</span>
<span class="cp">	 ERR_MASK(RcvFormatErr) | ERR_MASK(RcvUnsupportedVLErr) |	\</span>
<span class="cp">	 ERR_MASK(RcvUnexpectedCharErr) | ERR_MASK(RcvEBPErr))</span>

<span class="cm">/* These are all send-related errors which we want to count for stats */</span>
<span class="cp">#define E_SUM_ERRS \</span>
<span class="cp">	(ERR_MASK(SendPioArmLaunchErr) | ERR_MASK(SendUnexpectedPktNumErr) | \</span>
<span class="cp">	 ERR_MASK(SendDroppedDataPktErr) | ERR_MASK(SendDroppedSmpPktErr) | \</span>
<span class="cp">	 ERR_MASK(SendMaxPktLenErr) | ERR_MASK(SendUnsupportedVLErr) |	\</span>
<span class="cp">	 ERR_MASK(SendMinPktLenErr) | ERR_MASK(SendPktLenErr) |		\</span>
<span class="cp">	 ERR_MASK(InvalidAddrErr))</span>

<span class="cm">/*</span>
<span class="cm"> * this is similar to E_SUM_ERRS, but can&#39;t ignore armlaunch, don&#39;t ignore</span>
<span class="cm"> * errors not related to freeze and cancelling buffers.  Can&#39;t ignore</span>
<span class="cm"> * armlaunch because could get more while still cleaning up, and need</span>
<span class="cm"> * to cancel those as they happen.</span>
<span class="cm"> */</span>
<span class="cp">#define E_SPKT_ERRS_IGNORE \</span>
<span class="cp">	(ERR_MASK(SendDroppedDataPktErr) | ERR_MASK(SendDroppedSmpPktErr) | \</span>
<span class="cp">	 ERR_MASK(SendMaxPktLenErr) | ERR_MASK(SendMinPktLenErr) |	\</span>
<span class="cp">	 ERR_MASK(SendPktLenErr))</span>

<span class="cm">/*</span>
<span class="cm"> * these are errors that can occur when the link changes state while</span>
<span class="cm"> * a packet is being sent or received.  This doesn&#39;t cover things</span>
<span class="cm"> * like EBP or VCRC that can be the result of a sending having the</span>
<span class="cm"> * link change state, so we receive a &quot;known bad&quot; packet.</span>
<span class="cm"> */</span>
<span class="cp">#define E_SUM_LINK_PKTERRS \</span>
<span class="cp">	(ERR_MASK(SendDroppedDataPktErr) | ERR_MASK(SendDroppedSmpPktErr) | \</span>
<span class="cp">	 ERR_MASK(SendMinPktLenErr) | ERR_MASK(SendPktLenErr) |		\</span>
<span class="cp">	 ERR_MASK(RcvShortPktLenErr) | ERR_MASK(RcvMinPktLenErr) |	\</span>
<span class="cp">	 ERR_MASK(RcvUnexpectedCharErr))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">autoneg_7220_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">qib_7220_getsendbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called when we might have an error that is specific to a particular</span>
<span class="cm"> * PIO buffer, and may need to cancel that buffer, so it can be re-used.</span>
<span class="cm"> * because we don&#39;t need to force the update of pioavail.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_disarm_7220_senderrbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s possible that sendbuffererror could have bits set; might</span>
<span class="cm">	 * have already done this as a result of hardware error handling.</span>
<span class="cm">	 */</span>
	<span class="cm">/* read these before writing errorclear */</span>
	<span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span><span class="p">);</span>
	<span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
		<span class="n">qib_disarm_piobufs_set</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">,</span>
				       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_txe_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Recovering from TXE PIO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qib_disarm_7220_senderrbufs</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called with interrupts disabled and sdma_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_sdma_sendctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">set_sendctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">clr_sendctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_ENABLE</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SDmaEnable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SDmaEnable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_INTENABLE</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SDmaIntEnable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SDmaIntEnable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SDMA_SENDCTRL_OP_HALT</span><span class="p">)</span>
		<span class="n">set_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SDmaHalt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clr_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SDmaHalt</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">set_sendctrl</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clr_sendctrl</span><span class="p">;</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_decode_7220_sdma_errs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span>
				      <span class="n">u64</span> <span class="n">err</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">errs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaGenMismatchErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaGenMismatch&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaOutOfBoundErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaOutOfBound&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaTailOutOfBoundErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaTailOutOfBound&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaBaseErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaBase&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDma1stDescErr</span><span class="p">),</span>
		  <span class="s">&quot;SDma1stDesc&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaRpyTagErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaRpyTag&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaDwEnErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaDwEn&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaMissingDwErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaMissingDw&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaUnexpDataErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaUnexpData&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaDescAddrMisalignErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaDescAddrMisalign&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendBufMisuseErr</span><span class="p">),</span>
		  <span class="s">&quot;SendBufMisuse&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaDisabledErr</span><span class="p">),</span>
		  <span class="s">&quot;SDmaDisabled&quot;</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">errs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">errs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">err</span><span class="p">)</span>
			<span class="n">bidx</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">bidx</span><span class="p">,</span> <span class="n">blen</span> <span class="o">-</span> <span class="n">bidx</span><span class="p">,</span>
					 <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">errs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called as part of link down clean up so disarm and flush</span>
<span class="cm"> * all send buffers so that SMP packets can be sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_sdma_hw_clean_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This will trigger the Abort interrupt */</span>
	<span class="n">sendctrl_7220_mod</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_DISARM_ALL</span> <span class="o">|</span> <span class="n">QIB_SENDCTRL_FLUSH</span> <span class="o">|</span>
			  <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">upd_pio_shadow</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* update our idea of what&#39;s busy */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_sdma_7220_setlengen</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set SendDmaLenGen and clear and set</span>
<span class="cm">	 * the MSB of the generation count to enable generation checking</span>
<span class="cm">	 * and load the internal generation counter.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmalengen</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_cnt</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmalengen</span><span class="p">,</span>
		       <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_cnt</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_7220_SendDmaLenGen_Generation_MSB</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_sdma_hw_start_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_sdma_7220_setlengen</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="n">qib_sdma_update_7220_tail</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Set SendDmaTail */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_head_dma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DISABLES_SDMA (							\</span>
<span class="cp">		ERR_MASK(SDmaDisabledErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaBaseErr) |					\</span>
<span class="cp">		ERR_MASK(SDmaTailOutOfBoundErr) |			\</span>
<span class="cp">		ERR_MASK(SDmaOutOfBoundErr) |				\</span>
<span class="cp">		ERR_MASK(SDma1stDescErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaRpyTagErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaGenMismatchErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaDescAddrMisalignErr) |			\</span>
<span class="cp">		ERR_MASK(SDmaMissingDwErr) |				\</span>
<span class="cp">		ERR_MASK(SDmaDwEnErr))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_7220_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="n">QLOGIC_IB_E_SDMAERRS</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmamsgbuf</span><span class="p">;</span>
	<span class="n">qib_decode_7220_sdma_errs</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmamsgbuf</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendBufMisuseErr</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span><span class="p">);</span>
		<span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendbuffererror</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
			    <span class="s">&quot;IB%u:%u SendBufMisuse: %04lx %016lx %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaUnexpDataErr</span><span class="p">))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;IB%u:%u SDmaUnexpData</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">qib_sdma_state_s00_hw_down</span>:
		<span class="cm">/* not expecting any interrupts */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s10_hw_start_up_wait</span>:
		<span class="cm">/* handled in intr path */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s20_idle</span>:
		<span class="cm">/* not expecting any interrupts */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s30_sw_clean_up_wait</span>:
		<span class="cm">/* not expecting any interrupts */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s40_hw_clean_up_wait</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaDisabledErr</span><span class="p">))</span>
			<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">qib_sdma_event_e50_hw_cleaned</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s50_hw_halt_wait</span>:
		<span class="cm">/* handled in intr path */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s99_running</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">DISABLES_SDMA</span><span class="p">)</span>
			<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">qib_sdma_event_e7220_err_halted</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decode the error status into strings, deciding whether to always</span>
<span class="cm"> * print * it or not depending on &quot;normal packet errors&quot; vs everything</span>
<span class="cm"> * else.   Return 1 if &quot;real&quot; errors, otherwise 0 if only packet</span>
<span class="cm"> * errors, so caller can decide what to print with the string.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_decode_7220_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iserr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_E_PKTERRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QLOGIC_IB_E_PKTERRS</span><span class="p">))</span>
			<span class="n">iserr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvICRCErr</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvVCRCErr</span><span class="p">)</span> <span class="o">|</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEBPErr</span><span class="p">))))</span>
			<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;CRC &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iserr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvHdrLenErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rhdrlen &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvBadTidErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rbadtid &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvBadVersionErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rbadversion &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvHdrErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rhdr &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendSpecialTriggerErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sendspecialtrigger &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvLongPktLenErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rlongpktlen &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvMaxPktLenErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rmaxpktlen &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvMinPktLenErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rminpktlen &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendMinPktLenErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sminpktlen &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvFormatErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rformaterr &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvUnsupportedVLErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;runsupvl &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvUnexpectedCharErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;runexpchar &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvIBFlowErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ribflow &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendUnderRunErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sunderrun &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendPioArmLaunchErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;spioarmlaunch &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendUnexpectedPktNumErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sunexperrpktnum &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendDroppedSmpPktErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sdroppedsmppkt &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendMaxPktLenErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;smaxpktlen &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendUnsupportedVLErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sunsupVL &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">InvalidAddrErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;invalidaddr &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rcvegrfull &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvHdrFullErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rcvhdrfull &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">IBStatusChanged</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ibcstatuschg &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvIBLostLinkErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;riblostlink &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">HardwareErr</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;hardware &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">ResetNegated</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;reset &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_E_SDMAERRS</span><span class="p">)</span>
		<span class="n">qib_decode_7220_sdma_errs</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">InvalidEEPCmd</span><span class="p">))</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;invalideepromcmd &quot;</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">iserr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reenable_7220_chase</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="p">)</span><span class="n">opaque</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qib_set_ib_7220_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">,</span>
		<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_POLL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_7220_chase</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ibcst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ibclt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tnow</span><span class="p">;</span>

	<span class="n">ibclt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ibcst</span><span class="p">,</span> <span class="n">IBCStatus</span><span class="p">,</span> <span class="n">LinkTrainingState</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect and handle the state chase issue, where we can</span>
<span class="cm">	 * get stuck if we are unlucky on timing on both sides of</span>
<span class="cm">	 * the link.   If we are, we disable, set a timer, and</span>
<span class="cm">	 * then re-enable.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ibclt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_7220_LT_STATE_CFGRCVFCFG</span>:
	<span class="k">case</span> <span class="n">IB_7220_LT_STATE_CFGWAITRMT</span>:
	<span class="k">case</span> <span class="n">IB_7220_LT_STATE_TXREVLANES</span>:
	<span class="k">case</span> <span class="n">IB_7220_LT_STATE_CFGENH</span>:
		<span class="n">tnow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qib_set_ib_7220_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
				<span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">,</span>
				<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">QIB_CHASE_DIS_TIME</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span><span class="p">)</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="n">tnow</span> <span class="o">+</span> <span class="n">QIB_CHASE_TIME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_7220_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">errs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ignore_this_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iserr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* don&#39;t report errors that are masked */</span>
	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">emsgbuf</span><span class="p">;</span>

	<span class="cm">/* do these first, they are most important */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">HardwareErr</span><span class="p">))</span>
		<span class="n">qib_7220_handle_hwerrors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">emsgbuf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">log_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">log_idx</span> <span class="o">&lt;</span> <span class="n">QIB_EEP_LOG_CNT</span><span class="p">;</span> <span class="o">++</span><span class="n">log_idx</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_masks</span><span class="p">[</span><span class="n">log_idx</span><span class="p">].</span><span class="n">errs_to_log</span><span class="p">)</span>
				<span class="n">qib_inc_eeprom_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">log_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_E_SDMAERRS</span><span class="p">)</span>
		<span class="n">sdma_7220_errors</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IB_E_BITSEXTANT</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;error interrupt with unknown errors &quot;</span>
			    <span class="s">&quot;%llx set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			    <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IB_E_BITSEXTANT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_ERRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_disarm_7220_senderrbufs</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This can happen when trying to bring the link</span>
<span class="cm">			 * up, but the IB link changes state at the &quot;wrong&quot;</span>
<span class="cm">			 * time. The IB logic then complains that the packet</span>
<span class="cm">			 * isn&#39;t valid.  We don&#39;t want to confuse people, so</span>
<span class="cm">			 * we just don&#39;t print them, except at debug</span>
<span class="cm">			 */</span>
			<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_LINKACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can happen when SMA is trying to bring the link</span>
<span class="cm">		 * up, but the IB link changes state at the &quot;wrong&quot; time.</span>
<span class="cm">		 * The IB logic then complains that the packet isn&#39;t</span>
<span class="cm">		 * valid.  We don&#39;t want to confuse people, so we just</span>
<span class="cm">		 * don&#39;t print them, except at debug</span>
<span class="cm">		 */</span>
		<span class="n">ignore_this_time</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_LINK_PKTERRS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="n">errs</span><span class="p">);</span>

	<span class="n">errs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ignore_this_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ones we mask off are handled specially below</span>
<span class="cm">	 * or above.  Also mask SDMADISABLED by default as it</span>
<span class="cm">	 * is too chatty.</span>
<span class="cm">	 */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">IBStatusChanged</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">)</span> <span class="o">|</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvHdrFullErr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">ERR_MASK</span><span class="p">(</span><span class="n">HardwareErr</span><span class="p">)</span> <span class="o">|</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaDisabledErr</span><span class="p">);</span>

	<span class="n">qib_decode_7220_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">emsgbuf</span><span class="p">,</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_PKTERRS</span><span class="p">)</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_rcverrs</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">E_SUM_ERRS</span><span class="p">)</span>
		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_txerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">iserr</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">E_SUM_PKTERRS</span> <span class="o">|</span> <span class="n">QLOGIC_IB_E_PKTERRS</span> <span class="o">|</span>
			 <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SDmaDisabledErr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">IBStatusChanged</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">ibcs</span><span class="p">;</span>

		<span class="n">ibcs</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcstatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span>
			<span class="n">handle_7220_chase</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>

		<span class="cm">/* Update our picture of width and speed from chip */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">ibcs</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7220_LINKWIDTH_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">IB_WIDTH_4X</span> <span class="o">:</span> <span class="n">IB_WIDTH_1X</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">ibcs</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7220_LINKSPEED_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">QIB_IB_DDR</span> <span class="o">:</span> <span class="n">QIB_IB_SDR</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Since going into a recovery state causes the link state</span>
<span class="cm">		 * to go down and since recovery is transitory, it is better</span>
<span class="cm">		 * if we &quot;miss&quot; ever seeing the link training state go into</span>
<span class="cm">		 * recovery (i.e., ignore this transition for link state</span>
<span class="cm">		 * special handling purposes) without updating lastibcstat.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qib_7220_phys_portstate</span><span class="p">(</span><span class="n">ibcs</span><span class="p">)</span> <span class="o">!=</span>
					    <span class="n">IB_PHYSPORTSTATE_LINK_ERR_RECOVER</span><span class="p">)</span>
			<span class="n">qib_handle_e_ibstatuschanged</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ibcs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">ResetNegated</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Got reset, requires re-init &quot;</span>
			    <span class="s">&quot;(unload and reload driver)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_INITTED</span><span class="p">;</span>  <span class="cm">/* needs re-init */</span>
		<span class="cm">/* mark as having had error */</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">devstatusp</span> <span class="o">|=</span> <span class="n">QIB_STATUS_HWERROR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">statusp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIB_STATUS_IB_CONF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">iserr</span><span class="p">)</span>
		<span class="n">qib_dev_porterr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">state_wanted</span> <span class="o">&amp;</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there were hdrq or egrfull errors, wake up any processes</span>
<span class="cm">	 * waiting in poll.  We used to try to check which contexts had</span>
<span class="cm">	 * the overflow, but given the cost of that and the chip reads</span>
<span class="cm">	 * to support it, it&#39;s better to just wake everybody up if we</span>
<span class="cm">	 * get an overflow; waiters can poll again if it&#39;s not them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">)</span> <span class="o">|</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvHdrFullErr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">qib_handle_urcv</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errs</span> <span class="o">&amp;</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">RcvEgrFullErr</span><span class="p">))</span>
			<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_buffull</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_hdrfull</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* enable/disable chip from delivering interrupts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_set_intr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_BADINTR</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intmask</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
		<span class="cm">/* force re-interrupt of any pending interrupts. */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to cleanup as much as possible for anything that might have gone</span>
<span class="cm"> * wrong while in freeze mode, such as pio buffers being written by user</span>
<span class="cm"> * processes (causing armlaunch), send errors due to going into freeze mode,</span>
<span class="cm"> * etc., and try to avoid causing extra interrupts while doing so.</span>
<span class="cm"> * Forcibly update the in-memory pioavail register copies after cleanup</span>
<span class="cm"> * because the chip won&#39;t do it while in freeze mode (the register values</span>
<span class="cm"> * themselves are kept correct).</span>
<span class="cm"> * Make sure that we don&#39;t lose any important interrupts by using the chip</span>
<span class="cm"> * feature that says that writing 0 to a bit in *clear that is set in</span>
<span class="cm"> * *status will cause an interrupt to be generated again (if allowed by</span>
<span class="cm"> * the *mask value).</span>
<span class="cm"> * This is in chip-specific code because of all of the register accesses,</span>
<span class="cm"> * even though the details are similar on most chips.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_clear_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable error interrupts, to avoid confusion */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

	<span class="cm">/* also disable interrupts; errormask is sometimes overwriten */</span>
	<span class="n">qib_7220_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qib_cancel_sends</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>

	<span class="cm">/* clear the freeze, and be sure chip saw it */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>

	<span class="cm">/* force in-memory update now we are out of freeze */</span>
	<span class="n">qib_force_pio_avail_update</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * force new interrupt if any hwerr, error or interrupt bits are</span>
<span class="cm">	 * still set, and clear &quot;safe&quot; send packet errors related to freeze</span>
<span class="cm">	 * and cancelling sends.  Re-enable error interrupts before possible</span>
<span class="cm">	 * force of re-interrupt on pending interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="n">E_SPKT_ERRS_IGNORE</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">);</span>
	<span class="n">qib_7220_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_handle_hwerrors - display hardware errors.</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @msg: the output buffer</span>
<span class="cm"> * @msgl: the size of the output buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Use same msg buffer as regular errors to avoid excessive stack</span>
<span class="cm"> * use.  Most hardware errors are catastrophic, but for right now,</span>
<span class="cm"> * we&#39;ll print them and continue.  We reuse the same message buffer as</span>
<span class="cm"> * handle_7220_errors() to avoid excessive stack usage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_handle_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">msgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hwerrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isfatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bitsmsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log_idx</span><span class="p">;</span>

	<span class="n">hwerrs</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwerrs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Read of hardware error status failed &quot;</span>
			    <span class="s">&quot;(all bits set); ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_hwerrs</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always clear the error status register, except MEMBISTFAIL,</span>
<span class="cm">	 * regardless of whether we continue or stop using the chip.</span>
<span class="cm">	 * We want that set so we know it failed, even across driver reload.</span>
<span class="cm">	 * We&#39;ll still ignore it in the hwerrmask.  We do this partly for</span>
<span class="cm">	 * diagnostics, but also for support.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span>
		       <span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">));</span>

	<span class="n">hwerrs</span> <span class="o">&amp;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">;</span>

	<span class="cm">/* We log some errors to EEPROM, check if we have any of those. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">log_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">log_idx</span> <span class="o">&lt;</span> <span class="n">QIB_EEP_LOG_CNT</span><span class="p">;</span> <span class="o">++</span><span class="n">log_idx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_masks</span><span class="p">[</span><span class="n">log_idx</span><span class="p">].</span><span class="n">hwerrs_to_log</span><span class="p">)</span>
			<span class="n">qib_inc_eeprom_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">log_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TXEMEMPARITYERR_PIOBUF</span> <span class="o">|</span> <span class="n">TXEMEMPARITYERR_PIOPBC</span> <span class="o">|</span>
		       <span class="n">RXE_PARITY</span><span class="p">))</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Hardware error: hwerr=0x%llx &quot;</span>
			 <span class="s">&quot;(cleared)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hwerrs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IB_HWE_BITSEXTANT</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;hwerror interrupt with unknown errors &quot;</span>
			    <span class="s">&quot;%llx set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			    <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IB_HWE_BITSEXTANT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_HWE_IB_UC_MEMORYPARITYERR</span><span class="p">)</span>
		<span class="n">qib_sd7220_clr_ibpar</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_C_FREEZEMODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Parity errors in send memory are recoverable by h/w</span>
<span class="cm">		 * just do housekeeping, exit freeze mode and continue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXEMEMPARITYERR_PIOBUF</span> <span class="o">|</span>
			      <span class="n">TXEMEMPARITYERR_PIOPBC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qib_7220_txe_recover</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="n">hwerrs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TXEMEMPARITYERR_PIOBUF</span> <span class="o">|</span>
				    <span class="n">TXEMEMPARITYERR_PIOPBC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span><span class="p">)</span>
			<span class="n">isfatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qib_7220_clear_freeze</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">isfatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;[Memory BIST test failed, &quot;</span>
			<span class="s">&quot;InfiniPath hardware unusable]&quot;</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
		<span class="cm">/* ignore from now on, so disable until driver reloaded */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qib_format_hwerrors</span><span class="p">(</span><span class="n">hwerrs</span><span class="p">,</span> <span class="n">qib_7220_hwerror_msgs</span><span class="p">,</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">qib_7220_hwerror_msgs</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>

	<span class="n">bitsmsg</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">bitsmsgbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QLOGIC_IB_HWE_PCIEMEMPARITYERR_MASK</span> <span class="o">&lt;&lt;</span>
		      <span class="n">QLOGIC_IB_HWE_PCIEMEMPARITYERR_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">hwerrs</span> <span class="o">&gt;&gt;</span>
			       <span class="n">QLOGIC_IB_HWE_PCIEMEMPARITYERR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">QLOGIC_IB_HWE_PCIEMEMPARITYERR_MASK</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">bitsmsg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">bitsmsgbuf</span><span class="p">,</span>
			 <span class="s">&quot;[PCIe Mem Parity Errs %x] &quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bitsmsg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#define _QIB_PLL_FAIL (QLOGIC_IB_HWE_COREPLL_FBSLIP |   \</span>
<span class="cp">			 QLOGIC_IB_HWE_COREPLL_RFSLIP)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">_QIB_PLL_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isfatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">bitsmsg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">bitsmsgbuf</span><span class="p">,</span>
			 <span class="s">&quot;[PLL failed (%llx), InfiniPath hardware unusable]&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">_QIB_PLL_FAIL</span><span class="p">);</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bitsmsg</span><span class="p">,</span> <span class="n">msgl</span><span class="p">);</span>
		<span class="cm">/* ignore from now on, so disable until driver reloaded */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">_QIB_PLL_FAIL</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwerrs</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_HWE_SERDESPLLFAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it occurs, it is left masked since the eternal</span>
<span class="cm">		 * interface is unused.</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_HWE_SERDESPLLFAILED</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;%s hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isfatal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Fatal Hardware Error, no longer&quot;</span>
			    <span class="s">&quot; usable, SN %.16s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * For /sys status file and user programs to print; if no</span>
<span class="cm">		 * trailing brace is copied, we&#39;ll know it was truncated.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">freezemsg</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">freezemsg</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">freezelen</span><span class="p">,</span>
				 <span class="s">&quot;{%s}&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">qib_disable_after_error</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">bail:</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_init_hwerrors - enable hardware errors</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * now that we have finished initializing everything that might reasonably</span>
<span class="cm"> * cause a hardware error, and cleared those errors bits as they occur,</span>
<span class="cm"> * we can enable hardware errors in the mask (potentially enabling</span>
<span class="cm"> * freeze mode), and enable hardware errors as errors (along with</span>
<span class="cm"> * everything else) in errormask</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_init_hwerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extsval</span><span class="p">;</span>

	<span class="n">extsval</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extsval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QLOGIC_IB_EXTS_MEMBIST_ENDTEST</span> <span class="o">|</span>
			 <span class="n">QLOGIC_IB_EXTS_MEMBIST_DISABLED</span><span class="p">)))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;MemBIST did not complete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extsval</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_EXTS_MEMBIST_DISABLED</span><span class="p">)</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;MemBIST is disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>    <span class="cm">/* default to all hwerrors become interrupts, */</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_HWE_IB_UC_MEMORYPARITYERR</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span> <span class="o">~</span><span class="n">HWE_MASK</span><span class="p">(</span><span class="n">PowerOnBISTFailed</span><span class="p">));</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">hwerrmask</span><span class="p">);</span>

	<span class="cm">/* clear all */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
	<span class="cm">/* enable errors that are masked, at least this first time. */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">);</span>
	<span class="cm">/* clear any interrupts up to this point (ints still not enabled) */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable and enable the armlaunch error.  Used for PIO bandwidth testing</span>
<span class="cm"> * on chips that are count-based, rather than trigger-based.  There is no</span>
<span class="cm"> * reference counting, but that&#39;s also fine, given the intended use.</span>
<span class="cm"> * Only chip-specific because it&#39;s all register accesses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_set_7220_armlaunch</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errclear</span><span class="p">,</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendPioArmLaunchErr</span><span class="p">));</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span> <span class="o">|=</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendPioArmLaunchErr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ERR_MASK</span><span class="p">(</span><span class="n">SendPioArmLaunchErr</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errmask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">errormask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Formerly took parameter &lt;which&gt; in pre-shifted,</span>
<span class="cm"> * pre-merged form with LinkCmd and LinkInitCmd</span>
<span class="cm"> * together, and assuming the zero was NOP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_set_ib_7220_lstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">linkcmd</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">linitcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mod_wd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linitcmd</span> <span class="o">==</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we are told to disable, note that so link-recovery</span>
<span class="cm">		 * code does not attempt to bring us back up.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linitcmd</span> <span class="o">||</span> <span class="n">linkcmd</span> <span class="o">==</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Any other linkinitcmd will lead to LINKDOWN and then</span>
<span class="cm">		 * to INIT (if all is well), so clear flag to let</span>
<span class="cm">		 * link-recovery code attempt to bring us back up.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_LINK_DISABLED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod_wd</span> <span class="o">=</span> <span class="p">(</span><span class="n">linkcmd</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_IBCC_LINKCMD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">linitcmd</span> <span class="o">&lt;&lt;</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SHIFT</span><span class="p">);</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|</span> <span class="n">mod_wd</span><span class="p">);</span>
	<span class="cm">/* write to chip to prevent back-to-back writes of ibc reg */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * All detailed interaction with the SerDes has been moved to qib_sd7220.c</span>
<span class="cm"> *</span>
<span class="cm"> * The portion of IBA7220-specific bringup_serdes() that actually deals with</span>
<span class="cm"> * registers and memory within the SerDes itself is qib_sd7220_init().</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_bringup_serdes - bring up the serdes</span>
<span class="cm"> * @ppd: physical port on the qlogic_ib device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_bringup_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">ibc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Put IBC in reset, sends disabled */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_C_LINKENABLE</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_compat_ddr_negotiate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_ibsymbolerr</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span>
			<span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_iblinkerrrecov</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* flowcontrolwatermark is in units of KBytes */</span>
	<span class="n">ibc</span> <span class="o">=</span> <span class="mh">0x5ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">FlowCtrlWaterMark</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * How often flowctrl sent.  More or less in usecs; balance against</span>
<span class="cm">	 * watermark value, so that in theory senders always get a flow</span>
<span class="cm">	 * control update in time to not let the IB link go idle.</span>
<span class="cm">	 */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mh">0x3ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">FlowCtrlPeriod</span><span class="p">);</span>
	<span class="cm">/* max error tolerance */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">PhyerrThreshold</span><span class="p">);</span>
	<span class="cm">/* use &quot;real&quot; buffer space for */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mi">4ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">CreditScale</span><span class="p">);</span>
	<span class="cm">/* IB credit flow control. */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">OverrunThreshold</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * set initial max size pkt IBC will send, including ICRC; it&#39;s the</span>
<span class="cm">	 * PIO buffer size in dwords, less 1; also see qib_set_mtu()</span>
<span class="cm">	 */</span>
	<span class="n">ibc</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">ibmaxlen</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">MaxPktLen</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">=</span> <span class="n">ibc</span><span class="p">;</span> <span class="cm">/* without linkcmd or linkinitcmd! */</span>

	<span class="cm">/* initially come up waiting for TS1, without sending anything. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|</span> <span class="p">(</span><span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span> <span class="o">&lt;&lt;</span>
		<span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SHIFT</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not on re-init after reset */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">==</span> <span class="p">(</span><span class="n">QIB_IB_SDR</span> <span class="o">|</span> <span class="n">QIB_IB_DDR</span><span class="p">))</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
				<span class="n">IBA7220_IBC_SPEED_AUTONEG_MASK</span> <span class="o">|</span>
				<span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span> <span class="o">?</span>
				<span class="n">IBA7220_IBC_SPEED_DDR</span> <span class="o">:</span> <span class="n">IBA7220_IBC_SPEED_SDR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">))</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span> <span class="n">IBA7220_IBC_WIDTH_AUTONEG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">==</span> <span class="n">IB_WIDTH_4X</span> <span class="o">?</span>
				<span class="n">IBA7220_IBC_WIDTH_4X_ONLY</span> <span class="o">:</span>
				<span class="n">IBA7220_IBC_WIDTH_1X_ONLY</span><span class="p">;</span>

		<span class="cm">/* always enable these on driver reload, not sticky */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
			<span class="n">IBA7220_IBC_RXPOL_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_IBC_RXPOL_SHIFT</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
			<span class="n">IBA7220_IBC_HRTBT_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_IBC_HRTBT_SHIFT</span><span class="p">;</span>

		<span class="cm">/* enable automatic lane reversal detection for receive */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span> <span class="n">IBA7220_IBC_LANE_REV_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* write to chip to prevent back-to-back writes of ibc reg */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ncmodectrl</span><span class="p">,</span> <span class="mi">0Ull</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_sd7220_init</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">);</span>
	<span class="n">prev_val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">QLOGIC_IB_XGXS_FC_SAFE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">prev_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_XGXS_RESET</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_XGXS_RESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">prev_val</span><span class="p">)</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* first time through, set port guid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">)</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">guid</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">base_guid</span><span class="p">;</span>
	<span class="n">guid</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">);</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hrtbt_guid</span><span class="p">,</span> <span class="n">guid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">QLOGIC_IB_C_LINKENABLE</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* write to chip to prevent back-to-back writes of ibc reg */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_quiet_serdes - set serdes to txidle</span>
<span class="cm"> * @ppd: physical port of the qlogic_ib device</span>
<span class="cm"> * Called when driver is being unloaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_quiet_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* disable IBC */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_C_LINKENABLE</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|</span> <span class="n">QLOGIC_IB_C_FREEZEMODE</span><span class="p">);</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="cm">/* if initted */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">||</span>
	    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">diagc</span><span class="p">;</span>

		<span class="cm">/* enable counter writes */</span>
		<span class="n">diagc</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">,</span>
			       <span class="n">diagc</span> <span class="o">|</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">HwDiagCtrl</span><span class="p">,</span> <span class="n">CounterWrEnable</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_ibsymbolerr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">-=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span><span class="p">;</span>
			<span class="n">write_7220_creg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_ibsymbolerr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">||</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_iblinkerrrecov</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">-=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span><span class="p">;</span>
			<span class="n">write_7220_creg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_iblinkerrrecov</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* and disable counter writes */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">,</span> <span class="n">diagc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_set_ib_7220_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_work</span><span class="p">);</span>

	<span class="n">shutdown_7220_relock_poll</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">QLOGIC_IB_XGXS_RESET</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_setup_7220_setextled - set the state of the two external LEDs</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @on: whether the link is up or not</span>
<span class="cm"> *</span>
<span class="cm"> * The exact combo of LEDs if on is true is determined by looking</span>
<span class="cm"> * at the ibcstatus.</span>
<span class="cm"> *</span>
<span class="cm"> * These LEDs indicate the physical and logical state of IB link.</span>
<span class="cm"> * For this chip (at least with recommended board pinouts), LED1</span>
<span class="cm"> * is Yellow (logical state) and LED2 is Green (physical state),</span>
<span class="cm"> *</span>
<span class="cm"> * Note:  We try to match the Mellanox HCA LED behavior as best</span>
<span class="cm"> * we can.  Green indicates physical link state is OK (something is</span>
<span class="cm"> * plugged in, and we can train).</span>
<span class="cm"> * Amber indicates the link is logically up (ACTIVE).</span>
<span class="cm"> * Mellanox further blinks the amber LED to indicate data packet</span>
<span class="cm"> * activity, but we have no hardware support for that, so it would</span>
<span class="cm"> * require waking up every 10-20 msecs and checking the counters</span>
<span class="cm"> * on the chip, and then turning the LED off if appropriate.  That&#39;s</span>
<span class="cm"> * visible overhead, so not something we will do.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_setup_7220_setextled</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">extctl</span><span class="p">,</span> <span class="n">ledblink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">ltst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The diags use the LED to indicate diag info, so we leave</span>
<span class="cm">	 * the external LED alone when the diags are running.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">led_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ltst</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">led_override</span> <span class="o">&amp;</span> <span class="n">QIB_LED_PHYS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">IB_PHYSPORTSTATE_LINKUP</span> <span class="o">:</span> <span class="n">IB_PHYSPORTSTATE_DISABLED</span><span class="p">,</span>
		<span class="n">lst</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">led_override</span> <span class="o">&amp;</span> <span class="n">QIB_LED_LOG</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">IB_PORT_ACTIVE</span> <span class="o">:</span> <span class="n">IB_PORT_DOWN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcstatus</span><span class="p">);</span>
		<span class="n">ltst</span> <span class="o">=</span> <span class="n">qib_7220_phys_portstate</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">lst</span> <span class="o">=</span> <span class="n">qib_7220_iblink_state</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ltst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">extctl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">LEDPriPortGreenOn</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">LEDPriPortYellowOn</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ltst</span> <span class="o">==</span> <span class="n">IB_PHYSPORTSTATE_LINKUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extctl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">LEDPriPortGreenOn</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * counts are in chip clock (4ns) periods.</span>
<span class="cm">		 * This is 1/16 sec (66.6ms) on,</span>
<span class="cm">		 * 3/16 sec (187.5 ms) off, with packets rcvd</span>
<span class="cm">		 */</span>
		<span class="n">ledblink</span> <span class="o">=</span> <span class="p">((</span><span class="mi">66600</span> <span class="o">*</span> <span class="mi">1000UL</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_LEDBLINK_ON_SHIFT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">((</span><span class="mi">187500</span> <span class="o">*</span> <span class="mi">1000UL</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_LEDBLINK_OFF_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lst</span> <span class="o">==</span> <span class="n">IB_PORT_ACTIVE</span><span class="p">)</span>
		<span class="n">extctl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">LEDPriPortYellowOn</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">=</span> <span class="n">extctl</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extctrl</span><span class="p">,</span> <span class="n">extctl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ledblink</span><span class="p">)</span> <span class="cm">/* blink the LED on packet receive */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvpktledcnt</span><span class="p">,</span> <span class="n">ledblink</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_nomsi</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qib_setup_7220_cleanup - clean up any per-chip chip-specific stuff</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * This is called during driver unload.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_setup_7220_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_7220_free_irq</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is only called for SDmaInt.</span>
<span class="cm"> * SDmaDisabled is handled on the error path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_7220_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">qib_sdma_state_s00_hw_down</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s10_hw_start_up_wait</span>:
		<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e20_hw_started</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s20_idle</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s30_sw_clean_up_wait</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s40_hw_clean_up_wait</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s50_hw_halt_wait</span>:
		<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e60_hw_halted</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">qib_sdma_state_s99_running</span>:
		<span class="cm">/* too chatty to print here */</span>
		<span class="n">__qib_sdma_intr</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_wantpiobuf_7220_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">needint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needint</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * blip the availupd off, next write will be on, so</span>
<span class="cm">		 * we ensure an avail update, regardless of threshold or</span>
<span class="cm">		 * buffers becoming free, whenever we want an interrupt</span>
<span class="cm">		 */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">));</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendIntBufAvail</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendIntBufAvail</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle errors and unusual events first, separate function</span>
<span class="cm"> * to improve cache hits for fast path interrupt handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">unlikely_7220_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">istat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QLOGIC_IB_I_BITSEXTANT</span><span class="p">))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
			    <span class="s">&quot;interrupt with unknown interrupts %Lx set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">istat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QLOGIC_IB_I_BITSEXTANT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_I_GPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gpiostatus</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Boards for this chip currently don&#39;t use GPIO interrupts,</span>
<span class="cm">		 * so clear by writing GPIOstatus to GPIOclear, and complain</span>
<span class="cm">		 * to alert developer. To avoid endless repeats, clear</span>
<span class="cm">		 * the bits in the mask, since there is some kind of</span>
<span class="cm">		 * programming error or chip problem.</span>
<span class="cm">		 */</span>
		<span class="n">gpiostatus</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_status</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * In theory, writing GPIOstatus to GPIOclear could</span>
<span class="cm">		 * have a bad side-effect on some diagnostic that wanted</span>
<span class="cm">		 * to poll for a status-change, but the various shadows</span>
<span class="cm">		 * make that problematic at best. Diags will just suppress</span>
<span class="cm">		 * all GPIO interrupts during such tests.</span>
<span class="cm">		 */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_clear</span><span class="p">,</span> <span class="n">gpiostatus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gpiostatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_mask</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">gpio_irq</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">gpiostatus</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * A bit set in status and (chip) Mask register</span>
<span class="cm">			 * would cause an interrupt. Since we are not</span>
<span class="cm">			 * expecting any, report it. Also check that the</span>
<span class="cm">			 * chip reflects our shadow, report issues,</span>
<span class="cm">			 * and refresh from the shadow.</span>
<span class="cm">			 */</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clear any troublemakers, and update chip</span>
<span class="cm">			 * from shadow</span>
<span class="cm">			 */</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio_irq</span><span class="p">;</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_mask</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_I_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">estat</span><span class="p">;</span>

		<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_errints</span><span class="o">++</span><span class="p">;</span>
		<span class="n">estat</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_errstatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">estat</span><span class="p">)</span>
			<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;error interrupt (%Lx), &quot;</span>
				 <span class="s">&quot;but no error bits set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">handle_7220_errors</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">estat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qib_7220intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">istat</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctxtrbits</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_PRESENT</span> <span class="o">|</span> <span class="n">QIB_BADINTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QIB_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This return value is not great, but we do not want the</span>
<span class="cm">		 * interrupt core code to remove our interrupt handler</span>
<span class="cm">		 * because we don&#39;t appear to be handling an interrupt</span>
<span class="cm">		 * during a chip reset.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">istat</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">istat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span> <span class="cm">/* not our interrupt, or already handled */</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_bad_intrstatus</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="cm">/* don&#39;t know if it was our interrupt or not */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qib_stats</span><span class="p">.</span><span class="n">sps_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">QLOGIC_IB_I_BITSEXTANT</span> <span class="o">|</span>
			      <span class="n">QLOGIC_IB_I_GPIO</span> <span class="o">|</span> <span class="n">QLOGIC_IB_I_ERROR</span><span class="p">)))</span>
		<span class="n">unlikely_7220_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt bits we found set, relatively early, so we</span>
<span class="cm">	 * &quot;know&quot; know the chip will have seen this by the time we process</span>
<span class="cm">	 * the queue, and will re-interrupt if necessary.  The processor</span>
<span class="cm">	 * itself won&#39;t take the interrupt again until we return.</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_intclear</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle kernel receive queues before checking for pio buffers</span>
<span class="cm">	 * available since receives can overflow; piobuf waiters can afford</span>
<span class="cm">	 * a few extra cycles, since they were waiting anyway.</span>
<span class="cm">	 */</span>
	<span class="n">ctxtrbits</span> <span class="o">=</span> <span class="n">istat</span> <span class="o">&amp;</span>
		<span class="p">((</span><span class="n">QLOGIC_IB_I_RCVAVAIL_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">QLOGIC_IB_I_RCVAVAIL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">QLOGIC_IB_I_RCVURG_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">QLOGIC_IB_I_RCVURG_SHIFT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxtrbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QLOGIC_IB_I_RCVAVAIL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QLOGIC_IB_I_RCVURG_SHIFT</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxtrbits</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctxtrbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rmask</span><span class="p">;</span>
				<span class="n">qib_kreceive</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxtrbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctxtrbits</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">ctxtrbits</span> <span class="o">&gt;&gt;</span> <span class="n">QLOGIC_IB_I_RCVAVAIL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ctxtrbits</span> <span class="o">&gt;&gt;</span> <span class="n">QLOGIC_IB_I_RCVURG_SHIFT</span><span class="p">);</span>
			<span class="n">qib_handle_urcv</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctxtrbits</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* only call for SDmaInt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_I_SDMAINT</span><span class="p">)</span>
		<span class="n">sdma_7220_intr</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">QLOGIC_IB_I_SPIOBUFAVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_INITTED</span><span class="p">))</span>
		<span class="n">qib_ib_piobufavail</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up our chip-specific interrupt handler.</span>
<span class="cm"> * The interrupt type has already been setup, so</span>
<span class="cm"> * we just need to do the registration and error checking.</span>
<span class="cm"> * If we are using MSI interrupts, we may fall back to</span>
<span class="cm"> * INTx later, if the interrupt handler doesn&#39;t get called</span>
<span class="cm"> * within 1/2 second (see verify_interrupt()).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_setup_7220_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;irq is 0, BIOS error?  Interrupts won&#39;t &quot;</span>
			    <span class="s">&quot;work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qib_7220intr</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">QIB_DRV_NAME</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t setup %s interrupt &quot;</span>
				    <span class="s">&quot;(irq=%d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span> <span class="o">?</span>
				    <span class="s">&quot;MSI&quot;</span> <span class="o">:</span> <span class="s">&quot;INTx&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_boardname - fill in the board name</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * info is based on the board revision register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_boardname</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">boardid</span><span class="p">,</span> <span class="n">namelen</span><span class="p">;</span>

	<span class="n">boardid</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision</span><span class="p">,</span>
			    <span class="n">BoardID</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">boardid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE7240&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;InfiniPath_QLE7280&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Unknown 7220 board with ID %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boardid</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="s">&quot;Unknown_InfiniPath_7220&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">namelen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for board name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">majrev</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">||</span> <span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span> <span class="o">||</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Unsupported InfiniPath hardware &quot;</span>
			    <span class="s">&quot;revision %u.%u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">majrev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardversion</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardversion</span><span class="p">),</span>
		 <span class="s">&quot;ChipABI %u.%u, %s, InfiniPath%u %u.%u, SW Compat %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">QIB_CHIP_VERS_MAJ</span><span class="p">,</span> <span class="n">QIB_CHIP_VERS_MIN</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">boardname</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span> <span class="n">Arch</span><span class="p">),</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">majrev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span> <span class="n">SW</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine sleeps, so it can only be called from user context, not</span>
<span class="cm"> * from interrupt context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_setup_7220_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmdval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">int_line</span><span class="p">,</span> <span class="n">clinesz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">qib_pcie_getcmd</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">int_line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clinesz</span><span class="p">);</span>

	<span class="cm">/* Use dev_err so it shows up in logs, etc. */</span>
	<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Resetting InfiniPath unit %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* no interrupts till re-initted */</span>
	<span class="n">qib_7220_set_intr_state</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep chip from being accessed until we are ready.  Use</span>
<span class="cm">	 * writeq() directly, to allow the write even though QIB_PRESENT</span>
<span class="cm">	 * isn&#39;t set.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QIB_INITTED</span> <span class="o">|</span> <span class="n">QIB_PRESENT</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">int_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* so we check interrupts work again */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|</span> <span class="n">QLOGIC_IB_C_RESET</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">kr_control</span><span class="p">]);</span>
	<span class="n">mb</span><span class="p">();</span> <span class="cm">/* prevent compiler reordering around actual reset */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allow MBIST, etc. to complete; longer on each retry.</span>
<span class="cm">		 * We sometimes get machine checks from bus timeout if no</span>
<span class="cm">		 * response, so for now, make it *really* long.</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">);</span>

		<span class="n">qib_pcie_reenable</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cmdval</span><span class="p">,</span> <span class="n">int_line</span><span class="p">,</span> <span class="n">clinesz</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use readq directly, so we don&#39;t need to mark it as PRESENT</span>
<span class="cm">		 * until we get a successful indication that all is well.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">kr_revision</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_PRESENT</span><span class="p">;</span> <span class="cm">/* it&#39;s back */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_reinit_intr</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* failed */</span>

<span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qib_pcie_params</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">lbus_width</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Reset failed to setup PCIe or &quot;</span>
				    <span class="s">&quot;interrupts; continuing anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* hold IBC in reset, no sends, etc till later */</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>

		<span class="cm">/* clear the reset error, init error/hwerror mask */</span>
		<span class="n">qib_7220_init_hwerrors</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

		<span class="cm">/* do setup similar to speed or link-width changes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&amp;</span> <span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">presets_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_FORCE_NOTIFY</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_put_tid - write a TID to the chip</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @tidptr: pointer to the expected TID (in chip) to update</span>
<span class="cm"> * @tidtype: 0 for eager, 1 for expected</span>
<span class="cm"> * @pa: physical address of in memory buffer; tidinvalid if freeing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_put_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tidptr</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidinvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">chippa</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7220_TID_PA_SHIFT</span><span class="p">;</span>

		<span class="cm">/* paranoia checks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">!=</span> <span class="p">(</span><span class="n">chippa</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_TID_PA_SHIFT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Physaddr %lx not 2KB aligned!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pa</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chippa</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_TID_SZ_SHIFT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Physical page address 0x%lx &quot;</span>
				<span class="s">&quot;larger than supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RCVHQ_RCV_TYPE_EAGER</span><span class="p">)</span>
			<span class="n">chippa</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidtemplate</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* for now, always full 4KB page */</span>
			<span class="n">chippa</span> <span class="o">|=</span> <span class="n">IBA7220_TID_SZ_4K</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">chippa</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">tidptr</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_clear_tids - clear all TID entries for a ctxt, expected and eager</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @ctxt: the ctxt</span>
<span class="cm"> *</span>
<span class="cm"> * clear all TID entries for a ctxt, expected and eager.</span>
<span class="cm"> * Used from qib_close().  On this chip, TIDs are only 32 bits,</span>
<span class="cm"> * not 64, but they are still on 64 bit boundaries, so tidbase</span>
<span class="cm"> * is declared as u64 * for the pointer math, even though we write 32 bits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_clear_tids</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tidbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tidinv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">||</span> <span class="o">!</span><span class="n">rcd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctxt</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">;</span>

	<span class="n">tidinv</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidinvalid</span><span class="p">;</span>
	<span class="n">tidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidbase</span> <span class="o">+</span>
		 <span class="n">ctxt</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tidbase</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_7220_put_tid</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tidbase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RCVHQ_RCV_TYPE_EXPECTED</span><span class="p">,</span>
				 <span class="n">tidinv</span><span class="p">);</span>

	<span class="n">tidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbase</span> <span class="o">+</span>
		 <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tidbase</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qib_7220_put_tid</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tidbase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RCVHQ_RCV_TYPE_EAGER</span><span class="p">,</span>
				 <span class="n">tidinv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_7220_tidtemplate - setup constants for TID updates</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> *</span>
<span class="cm"> * We setup stuff that we use a lot, to avoid calculating each time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_tidtemplate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span> <span class="o">==</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidtemplate</span> <span class="o">=</span> <span class="n">IBA7220_TID_SZ_2K</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidtemplate</span> <span class="o">=</span> <span class="n">IBA7220_TID_SZ_4K</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">tidinvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_init_7220_get_base_info - set chip-specific flags for user code</span>
<span class="cm"> * @rcd: the qlogic_ib ctxt</span>
<span class="cm"> * @kbase: qib_base_info pointer</span>
<span class="cm"> *</span>
<span class="cm"> * We set the PCIE flag because the lower bandwidth on PCIe vs</span>
<span class="cm"> * HyperTransport can affect some user packet algorithims.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_get_base_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">qib_base_info</span> <span class="o">*</span><span class="n">kinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">QIB_RUNTIME_PCIE</span> <span class="o">|</span>
		<span class="n">QIB_RUNTIME_NODMA_RTAIL</span> <span class="o">|</span> <span class="n">QIB_RUNTIME_SDMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_USE_SPCL_TRIG</span><span class="p">)</span>
		<span class="n">kinfo</span><span class="o">-&gt;</span><span class="n">spi_runtime_flags</span> <span class="o">|=</span> <span class="n">QIB_RUNTIME_SPECIAL_TRIGGER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qib_message_header</span> <span class="o">*</span>
<span class="nf">qib_7220_get_msgheader</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">rhf_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">qib_hdrget_offset</span><span class="p">(</span><span class="n">rhf_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_message_header</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">rhf_addr</span> <span class="o">-</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhf_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_config_ctxts</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nchipctxts</span><span class="p">;</span>

	<span class="n">nchipctxts</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_portcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">numctxts</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_n_krcv_queues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">qpn_mask</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">=</span> <span class="n">qib_n_krcv_queues</span> <span class="o">*</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">&gt;</span> <span class="n">nchipctxts</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">n_krcv_queues</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_cfgctxts</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nctxts</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span> <span class="o">+</span> <span class="n">num_online_cpus</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nctxts</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nctxts</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nctxts</span> <span class="o">&lt;=</span> <span class="n">nchipctxts</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qib_cfgctxts</span> <span class="o">&lt;=</span> <span class="n">nchipctxts</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">qib_cfgctxts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span><span class="p">)</span> <span class="cm">/* none of the above, set to max */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">=</span> <span class="n">nchipctxts</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Chip can be configured for 5, 9, or 17 ctxts, and choice</span>
<span class="cm">	 * affects number of eager TIDs per ctxt (1K, 2K, 4K).</span>
<span class="cm">	 * Lock to be paranoid about later motion, etc.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">2ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_CTXTCFG_SHIFT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_CTXTCFG_SHIFT</span><span class="p">;</span>
	<span class="cm">/* else configure for default 5 receive ctxts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">qpn_mask</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">QIB_7220_RcvCtrl_RcvQPMapEnable_LSB</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* kr_rcvegrcnt changes based on the number of contexts enabled */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvegrcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrcnt</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">,</span> <span class="n">IBA7220_KRCVEGRCNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_get_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">maskr</span><span class="p">;</span> <span class="cm">/* right-justified mask */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QIB_IB_CFG_LWID_ENB</span>: <span class="cm">/* Get allowed Link-width */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LWID</span>: <span class="cm">/* Get currently active Link-width */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_SPD_ENB</span>: <span class="cm">/* Get allowed Link speeds */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_SPD</span>: <span class="cm">/* Get current Link spd */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_RXPOL_ENB</span>: <span class="cm">/* Get Auto-RX-polarity enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_RXPOL_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_RXPOL_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LREV_ENB</span>: <span class="cm">/* Get Auto-Lane-reversal enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_LREV_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_LREV_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LINKLATENCY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrstatus</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">IBA7220_DDRSTAT_LINKLAT_MASK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OP_VLS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_VL_HIGH_CAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_VL_LOW_CAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OVERRUN_THRESH</span>: <span class="cm">/* IB overrun threshold */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">,</span> <span class="n">IBCCtrl</span><span class="p">,</span>
				<span class="n">OverrunThreshold</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PHYERR_THRESH</span>: <span class="cm">/* IB PHY error threshold */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">,</span> <span class="n">IBCCtrl</span><span class="p">,</span>
				<span class="n">PhyerrThreshold</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LINKDEFAULT</span>: <span class="cm">/* IB link default (sleep/poll) */</span>
		<span class="cm">/* will only take effect when the link state changes */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">&amp;</span>
		       <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">LinkDownDefaultState</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">IB_LINKINITCMD_SLEEP</span> <span class="o">:</span> <span class="n">IB_LINKINITCMD_POLL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_HRTBT</span>: <span class="cm">/* Get Heartbeat off/enable/auto */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_HRTBT_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_HRTBT_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PMA_TICKS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 0x00 = 10x link transfer rate or 4 nsec. for 2.5Gbs</span>
<span class="cm">		 * Since the clock is always 250MHz, the value is 1 or 0.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&gt;&gt;</span> <span class="n">lsb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">maskr</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_set_ib_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">maskr</span><span class="p">;</span> <span class="cm">/* right-justified mask */</span>
	<span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">setforce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lcmd</span><span class="p">,</span> <span class="n">licmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QIB_IB_CFG_LIDLMC</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Set LID and LMC. Combined to avoid possible hazard</span>
<span class="cm">		 * caller puts LMC in 16MSbits, DLID in 16LSbits of val</span>
<span class="cm">		 */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_DLIDLMC_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_DLIDLMC_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LWID_ENB</span>: <span class="cm">/* set allowed Link-width */</span>
		<span class="cm">/*</span>
<span class="cm">		 * As with speed, only write the actual register if</span>
<span class="cm">		 * the link is currently down, otherwise takes effect</span>
<span class="cm">		 * on next link change.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_LINKDOWN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We set the QIBL_IB_FORCE_NOTIFY bit so updown</span>
<span class="cm">		 * will get called because we want update</span>
<span class="cm">		 * link_width_active, and the change may not take</span>
<span class="cm">		 * effect for some time (if we are in POLL), so this</span>
<span class="cm">		 * flag will force the updown routine to be called</span>
<span class="cm">		 * on the next ibstatuschange down interrupt, even</span>
<span class="cm">		 * if it&#39;s not an down-&gt;up transition.</span>
<span class="cm">		 */</span>
		<span class="n">val</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* convert from IB to chip */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_WIDTH_MASK</span><span class="p">;</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_WIDTH_SHIFT</span><span class="p">;</span>
		<span class="n">setforce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_SPD_ENB</span>: <span class="cm">/* set allowed Link speeds */</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we turn off IB1.2, need to preset SerDes defaults,</span>
<span class="cm">		 * but not right now. Set a flag for the next time</span>
<span class="cm">		 * we command the link down.  As with width, only write the</span>
<span class="cm">		 * actual register if the link is currently down, otherwise</span>
<span class="cm">		 * takes effect on next link change.  Since setting is being</span>
<span class="cm">		 * explicitly requested (via MAD or sysfs), clear autoneg</span>
<span class="cm">		 * failure status if speed autoneg is enabled.</span>
<span class="cm">		 */</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&amp;</span> <span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">presets_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_LINKDOWN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We set the QIBL_IB_FORCE_NOTIFY bit so updown</span>
<span class="cm">		 * will get called because we want update</span>
<span class="cm">		 * link_speed_active, and the change may not take</span>
<span class="cm">		 * effect for some time (if we are in POLL), so this</span>
<span class="cm">		 * flag will force the updown routine to be called</span>
<span class="cm">		 * on the next ibstatuschange down interrupt, even</span>
<span class="cm">		 * if it&#39;s not an down-&gt;up transition.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="p">(</span><span class="n">QIB_IB_SDR</span> <span class="o">|</span> <span class="n">QIB_IB_DDR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">IBA7220_IBC_SPEED_AUTONEG_MASK</span> <span class="o">|</span>
				<span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span> <span class="o">?</span>
				<span class="n">IBA7220_IBC_SPEED_DDR</span> <span class="o">:</span> <span class="n">IBA7220_IBC_SPEED_SDR</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_SPEED_AUTONEG_MASK</span> <span class="o">|</span>
			<span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
		<span class="cm">/* IBTA 1.2 mode + speed bits are contiguous */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCDDRCtrl</span><span class="p">,</span> <span class="n">IB_ENHANCED_MODE</span><span class="p">);</span>
		<span class="n">setforce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_RXPOL_ENB</span>: <span class="cm">/* set Auto-RX-polarity enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_RXPOL_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_RXPOL_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LREV_ENB</span>: <span class="cm">/* set Auto-Lane-reversal enable */</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_LREV_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_LREV_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_OVERRUN_THRESH</span>: <span class="cm">/* IB overrun threshold */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">,</span> <span class="n">IBCCtrl</span><span class="p">,</span>
				  <span class="n">OverrunThreshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maskr</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">OverrunThreshold</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span>
				<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">OverrunThreshold</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PHYERR_THRESH</span>: <span class="cm">/* IB PHY error threshold */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">,</span> <span class="n">IBCCtrl</span><span class="p">,</span>
				  <span class="n">PhyerrThreshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maskr</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">PhyerrThreshold</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span>
				<span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">PhyerrThreshold</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_PKEYS</span>: <span class="cm">/* update pkeys */</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">pkeys</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_partitionkey</span><span class="p">,</span> <span class="n">maskr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LINKDEFAULT</span>: <span class="cm">/* IB link default (sleep/poll) */</span>
		<span class="cm">/* will only take effect when the link state changes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IB_LINKINITCMD_POLL</span><span class="p">)</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">LinkDownDefaultState</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* SLEEP */</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|=</span>
				<span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">LinkDownDefaultState</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_MTU</span>: <span class="cm">/* update the MTU in IBC */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update our housekeeping variables, and set IBC max</span>
<span class="cm">		 * size, same as init code; max IBC is max we allow in</span>
<span class="cm">		 * buffer, less the qword pbc, plus 1 for ICRC, in dwords</span>
<span class="cm">		 * Set even if it&#39;s unchanged, print debug message only</span>
<span class="cm">		 * on changes.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">ibmaxlen</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">MaxPktLen</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">MaxPktLen</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_LSTATE</span>: <span class="cm">/* set the IB link state */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_LINKCMD_DOWN</span>:
			<span class="n">lcmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_DOWN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">&amp;&amp;</span>
			    <span class="n">qib_compat_ddr_negotiate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span>
					<span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_ibsymbolerr</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span>
					<span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_iblinkerrrecov</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKCMD_ARMED</span>:
			<span class="n">lcmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_ARMED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKCMD_ACTIVE</span>:
			<span class="n">lcmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKCMD_ACTIVE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;bad linkcmd req 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_LINKINITCMD_NOP</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKINITCMD_POLL</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_POLL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKINITCMD_SLEEP</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_SLEEP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_LINKINITCMD_DISABLE</span>:
			<span class="n">licmd</span> <span class="o">=</span> <span class="n">QLOGIC_IB_IBCC_LINKINITCMD_DISABLE</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * stop state chase counter and timer, if running.</span>
<span class="cm">			 * wait forpending timer, but don&#39;t clear .data (ppd)!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;bad linkinitcmd req 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qib_set_ib_7220_lstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">lcmd</span><span class="p">,</span> <span class="n">licmd</span><span class="p">);</span>

		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_WIDTH_MASK</span><span class="p">;</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_WIDTH_SHIFT</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&gt;&gt;</span> <span class="n">lsb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">maskr</span><span class="p">;</span>
		<span class="cm">/* If the width active on the chip does not match the</span>
<span class="cm">		 * width in the shadow register, write the new active</span>
<span class="cm">		 * width to the chip.</span>
<span class="cm">		 * We don&#39;t have to worry about speed as the speed is taken</span>
<span class="cm">		 * care of by set_7220_ibspeed_fast called by ib_updown.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">maskr</span> <span class="o">&lt;&lt;</span> <span class="n">lsb</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
				<span class="p">(((</span><span class="n">u64</span><span class="p">)(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">maskr</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				 <span class="n">lsb</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrctrl</span><span class="p">,</span>
				       <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_FORCE_NOTIFY</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QIB_IB_CFG_HRTBT</span>: <span class="cm">/* set Heartbeat off/enable/auto */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">IBA7220_IBC_HRTBT_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">IBA7220_IBC_HRTBT_SHIFT</span><span class="p">;</span>
		<span class="n">maskr</span> <span class="o">=</span> <span class="n">IBA7220_IBC_HRTBT_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">maskr</span> <span class="o">&lt;&lt;</span> <span class="n">lsb</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">maskr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">lsb</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setforce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_FORCE_NOTIFY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">ddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="s">&quot;ibc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">Loopback</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* disable heart beat, so link will come up */</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Enabling IB%u:%u IBC loopback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">IBCCtrl</span><span class="p">,</span> <span class="n">Loopback</span><span class="p">);</span>
		<span class="cm">/* enable heart beat again */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">IBA7220_IBC_HRTBT_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_IBC_HRTBT_SHIFT</span><span class="p">;</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Disabling IB%u:%u IBC loopback &quot;</span>
			    <span class="s">&quot;(normal)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcctrl</span><span class="p">);</span>
		<span class="n">ddr</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IBA7220_IBC_HRTBT_MASK</span>
					     <span class="o">&lt;&lt;</span> <span class="n">IBA7220_IBC_HRTBT_SHIFT</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">=</span> <span class="n">ddr</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrctrl</span><span class="p">,</span>
			       <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_update_7220_usrhead</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">hd</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">updegr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">egrhd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">npkts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">updegr</span><span class="p">)</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvegrindexhead</span><span class="p">,</span> <span class="n">egrhd</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_7220_hdrqempty</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvhdrtail_kvaddr</span><span class="p">)</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">qib_get_rcvhdrtail</span><span class="p">(</span><span class="n">rcd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrtail</span><span class="p">,</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">head</span> <span class="o">==</span> <span class="n">tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Modify the RCVCTRL register in chip-specific way. This</span>
<span class="cm"> * is a function because bit positions and (future) register</span>
<span class="cm"> * location is chip-specifc, but the needed operations are</span>
<span class="cm"> * generic. &lt;op&gt; is a bit-mask because we often want to</span>
<span class="cm"> * do multiple modifications.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rcvctrl_7220_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_TAILUPD_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_TAILUPD_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_TAILUPD_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_TAILUPD_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_PKEY_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_PKEY_DIS_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_PKEY_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_PKEY_DIS_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctxtcnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_ENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* always done for specific ctxt */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">PortEnable</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_NODMA_RTAIL</span><span class="p">))</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_TAILUPD_SHIFT</span><span class="p">;</span>
		<span class="cm">/* Write these registers before the context is enabled. */</span>
		<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrtailaddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rcvhdrqtailaddr_phys</span><span class="p">);</span>
		<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdraddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rcvhdrq_phys</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">seq_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">RcvCtrl</span><span class="p">,</span> <span class="n">PortEnable</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_INTRAVAIL_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_INTRAVAIL_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_INTRAVAIL_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">IBA7220_R_INTRAVAIL_SHIFT</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_INTRAVAIL_ENB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* arm rcv interrupt */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span><span class="p">;</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_ENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Init the context registers also; if we were</span>
<span class="cm">		 * disabled, tail and head should both be zero</span>
<span class="cm">		 * already from the enable, but since we don&#39;t</span>
<span class="cm">		 * know, we have to do it explicitly.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvegrindextail</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvegrindexhead</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_ureg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrtail</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">ctxt</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="cm">/* If kctxt, interrupt on next receive. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span><span class="p">;</span>
		<span class="n">qib_write_ureg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ur_rcvhdrhead</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_RCVCTRL_CTXT_DIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrtailaddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdraddr</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrtailaddr</span><span class="p">,</span>
						    <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">qib_write_kreg_ctxt</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdraddr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Modify the SENDCTRL register in chip-specific way. This</span>
<span class="cm"> * is a function there may be multiple such registers with</span>
<span class="cm"> * slightly different layouts. To start, we assume the</span>
<span class="cm"> * &quot;canonical&quot; register layout of the first chips.</span>
<span class="cm"> * Chip requires no back-back sendctrl writes, so write</span>
<span class="cm"> * scratch register after writing sendctrl</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sendctrl_7220_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp_dd_sendctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* First the ones that are &quot;sticky&quot;, saved in shadow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_CLEAR</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_SEND_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SPioEnable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_SEND_ENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SPioEnable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_USE_SPCL_TRIG</span><span class="p">)</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span>
						 <span class="n">SSpecialTriggerEn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_DIS</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_ENB</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_DISARM_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

		<span class="n">tmp_dd_sendctrl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * disarm any that are not yet launched, disabling sends</span>
<span class="cm">		 * and updates until done.</span>
<span class="cm">		 */</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SPioEnable</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span>
				       <span class="n">tmp_dd_sendctrl</span> <span class="o">|</span>
				       <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">Disarm</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmp_dd_sendctrl</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_FLUSH</span><span class="p">)</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">Abort</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_DISARM</span><span class="p">)</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">|=</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">Disarm</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_7220_SendCtrl_DisarmPIOBuf_RMASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			 <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">DisarmPIOBuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">)))</span>
		<span class="n">tmp_dd_sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">SendBufAvailUpd</span><span class="p">);</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">tmp_dd_sendctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">QIB_SENDCTRL_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * ensure writes have hit chip, then do a few</span>
<span class="cm">		 * more reads, to allow DMA of pioavail registers</span>
<span class="cm">		 * to occur, so in-memory copy is in sync with</span>
<span class="cm">		 * the chip.  Not always safe to sleep.</span>
<span class="cm">		 */</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_portcntr_7220 - read a per-port counter</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @creg: the counter to snapshot</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">qib_portcntr_7220</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">creg</span><span class="p">;</span>
	<span class="cm">/* 0xffff for unimplemented or synthesized counters */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">xlator</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PKTSEND</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_pktsend</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_WORDSEND</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_wordsend</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSXMITDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psxmitdatacount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSXMITPKTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psxmitpktscount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSXMITWAIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psxmitwaitcount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_SENDSTALL</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_sendstall</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PKTRCV</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_pktrcv</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSRCVDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psrcvdatacount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSRCVPKTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psrcvpktscount</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RCVEBP</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_rcvebp</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RCVOVFL</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_rcvovfl</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_WORDRCV</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_wordrcv</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RXDROPPKT</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_rxdroppkt</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RXLOCALPHYERR</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_rxotherlocalphyerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_RXVLERR</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_rxvlerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRICRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_erricrc</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRVCRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_errvcrc</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRLPCRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_errlpcrc</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_BADFORMAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_badformat</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERR_RLEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_err_rlen</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_IBSYMBOLERR</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_ibsymbolerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_INVALIDRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_invalidrlen</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_UNSUPVL</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_txunsupvl</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_EXCESSBUFOVFL</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_excessbufferovfl</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRLINK</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_errlink</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_IBLINKDOWN</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_iblinkdown</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_IBLINKERRRECOV</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_iblinkerrrecov</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_LLI</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_locallinkintegrityerr</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSINTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psinterval</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSSTART</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psstart</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_PSSTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_psstat</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_VL15PKTDROP</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_vl15droppedpkt</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_ERRPKEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_errpkey</span><span class="p">,</span>
		<span class="p">[</span><span class="n">QIBPORTCNTR_KHDROVFL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xlator</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			 <span class="s">&quot;Unimplemented portcounter %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">creg</span> <span class="o">=</span> <span class="n">xlator</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">QIBPORTCNTR_KHDROVFL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* sum over all kernel contexts */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_portovfl</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * only fast incrementing counters are 64bit; use 32 bit reads to</span>
<span class="cm">	 * avoid two independent reads when on opteron</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">creg</span> <span class="o">==</span> <span class="n">cr_wordsend</span> <span class="o">||</span> <span class="n">creg</span> <span class="o">==</span> <span class="n">cr_wordrcv</span> <span class="o">||</span>
	     <span class="n">creg</span> <span class="o">==</span> <span class="n">cr_pktsend</span> <span class="o">||</span> <span class="n">creg</span> <span class="o">==</span> <span class="n">cr_pktrcv</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_7220_creg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="n">cr_ibsymbolerr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">-=</span> <span class="n">ret</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">-=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">creg</span> <span class="o">==</span> <span class="n">cr_iblinkerrrecov</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">-=</span> <span class="n">ret</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">-=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Device counter names (not port-specific), one line per stat,</span>
<span class="cm"> * single string.  Used by utilities like ipathstats to print the stats</span>
<span class="cm"> * in a way which works for different versions of drivers, without changing</span>
<span class="cm"> * the utility.  Names need to be 12 chars or less (w/o newline), for proper</span>
<span class="cm"> * display by utility.</span>
<span class="cm"> * Non-error counters are first.</span>
<span class="cm"> * Start of &quot;error&quot; conters is indicated by a leading &quot;E &quot; on the first</span>
<span class="cm"> * &quot;error&quot; counter, and doesn&#39;t count in label length.</span>
<span class="cm"> * The EgrOvfl list needs to be last so we truncate them at the configured</span>
<span class="cm"> * context count for the device.</span>
<span class="cm"> * cntr7220indices contains the corresponding register indices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cntr7220names</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Interrupts</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;HostBusStall</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;E RxTIDFull</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxTIDInvalid</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt0EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt1EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt2EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt3EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt4EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt5EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt6EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt7EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt8EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctxt9EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx10EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx11EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx12EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx13EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx14EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx15EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;Ctx16EgrOvfl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">cntr7220indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">cr_lbint</span><span class="p">,</span>
	<span class="n">cr_lbflowstall</span><span class="p">,</span>
	<span class="n">cr_errtidfull</span><span class="p">,</span>
	<span class="n">cr_errtidvalid</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span>
	<span class="n">cr_portovfl</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * same as cntr7220names and cntr7220indices, but for port-specific counters.</span>
<span class="cm"> * portcntr7220indices is somewhat complicated by some registers needing</span>
<span class="cm"> * adjustments of various kinds, and those are ORed with _PORT_VIRT_FLAG</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">portcntr7220names</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;TxPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxFlowPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxWords</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxFlowPkt</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxWords</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxFlowStall</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxDmaDesc</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;E RxDlidFltr</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;IBStatusChng</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBLinkDown</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBLnkRecov</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBRxLinkErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;IBSymbolErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxLLIErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxBadFormat</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxBadLen</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxBufOvrfl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxEBP</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxFlowCtlErr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxICRCerr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxLPCRCerr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxVCRCerr</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxInvalLen</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxInvalPKey</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxPktDropped</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxBadLength</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxDropped</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxInvalLen</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxUnderrun</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;TxUnsupVL</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;RxLclPhyErr</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;RxVL15Drop</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;RxVlErr</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7220 and 7322-only */</span>
	<span class="s">&quot;XcessBufOvfl</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* 7220 and 7322-only */</span>
	<span class="p">;</span>

<span class="cp">#define _PORT_VIRT_FLAG 0x8000 </span><span class="cm">/* &quot;virtual&quot;, need adjustments */</span><span class="cp"></span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">portcntr7220indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">QIBPORTCNTR_PKTSEND</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">cr_pktsendflow</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_WORDSEND</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_PKTRCV</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">cr_pktrcvflowctrl</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_WORDRCV</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_SENDSTALL</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">cr_txsdmadesc</span><span class="p">,</span>
	<span class="n">cr_rxdlidfltr</span><span class="p">,</span>
	<span class="n">cr_ibstatuschange</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_IBLINKDOWN</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_IBLINKERRRECOV</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRLINK</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_IBSYMBOLERR</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_LLI</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_BADFORMAT</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERR_RLEN</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RCVOVFL</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RCVEBP</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">cr_rcvflowctrl_err</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRICRC</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRLPCRC</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRVCRC</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_INVALIDRLEN</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_ERRPKEY</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RXDROPPKT</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">cr_invalidslen</span><span class="p">,</span>
	<span class="n">cr_senddropped</span><span class="p">,</span>
	<span class="n">cr_errslen</span><span class="p">,</span>
	<span class="n">cr_sendunderrun</span><span class="p">,</span>
	<span class="n">cr_txunsupvl</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RXLOCALPHYERR</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_VL15PKTDROP</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_RXVLERR</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
	<span class="n">QIBPORTCNTR_EXCESSBUFOVFL</span> <span class="o">|</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* do all the setup to make the counter reads efficient later */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_7220_cntrnames</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cntr7220names</span><span class="p">;</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we always have at least one counter before the egrovfl */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;Ctxt0EgrOvfl&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="p">)</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="cm">/* full list; size is without terminating null */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrnamelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cntr7220names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrnamelen</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">cntr7220names</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span>
		<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for counters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">portcntr7220names</span><span class="p">;</span> <span class="n">s</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrnamelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">portcntr7220names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span>
		<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">)</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed allocation for portcounters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_read_7220cntrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="o">**</span><span class="n">cntrp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">namep</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cntr7220names</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrnamelen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* final read after getting everything */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">cntr</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cntrs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntr</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* everything read, or couldn&#39;t get memory */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">cntrp</span> <span class="o">=</span> <span class="n">cntr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">ncntrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">cntr7220indices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_read_7220portcntrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">,</span> <span class="n">u64</span> <span class="o">**</span><span class="n">cntrp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">namep</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">portcntr7220names</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrnamelen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* final read after getting everything */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">cntr</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">portcntrs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntr</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* everything read, or couldn&#39;t get memory */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cntrp</span> <span class="o">=</span> <span class="n">cntr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">nportcntrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">portcntr7220indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">_PORT_VIRT_FLAG</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">qib_portcntr_7220</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">portcntr7220indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">_PORT_VIRT_FLAG</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">cntr</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
					   <span class="n">portcntr7220indices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_get_7220_faststats - get word counters from chip before they overflow</span>
<span class="cm"> * @opaque - contains a pointer to the qlogic_ib device qib_devdata</span>
<span class="cm"> *</span>
<span class="cm"> * This needs more work; in particular, decision on whether we really</span>
<span class="cm"> * need traffic_wds done the way it is</span>
<span class="cm"> * called from add_timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_get_7220_faststats</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">opaque</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">traffic_wds</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * don&#39;t access the chip while running diags, or memory diags can</span>
<span class="cm">	 * fail</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_INITTED</span><span class="p">)</span> <span class="o">||</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">diag_client</span><span class="p">)</span>
		<span class="cm">/* but re-arm the timer, for diags case; won&#39;t hurt other */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We now try to maintain an activity timer, based on traffic</span>
<span class="cm">	 * exceeding a threshold, so we need to check the word-counts</span>
<span class="cm">	 * even if they are 64-bit.</span>
<span class="cm">	 */</span>
	<span class="n">traffic_wds</span> <span class="o">=</span> <span class="n">qib_portcntr_7220</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">cr_wordsend</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">qib_portcntr_7220</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">cr_wordrcv</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">traffic_wds</span> <span class="o">-=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">traffic_wds</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">traffic_wds</span> <span class="o">+=</span> <span class="n">traffic_wds</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">traffic_wds</span>  <span class="o">&gt;=</span> <span class="n">QIB_TRAFFIC_ACTIVE_THRESHOLD</span><span class="p">)</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">active_time</span><span class="p">);</span> <span class="cm">/* S/B #define */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">ACTIVITY_TIMER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we are using MSI, try to fallback to INTx.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_intr_fallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">msi_lo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qib_devinfo</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;MSI interrupt not detected,&quot;</span>
		 <span class="s">&quot; trying INTx interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qib_7220_free_irq</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_enable_intx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some newer kernels require free_irq before disable_msi,</span>
<span class="cm">	 * and irq can be changed during disable and INTx enable</span>
<span class="cm">	 * and we need to therefore use the pcidev-&gt;irq value,</span>
<span class="cm">	 * not our saved MSI value.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">qib_setup_7220_interrupt</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the XGXS (between serdes and IBC).  Slightly less intrusive</span>
<span class="cm"> * than resetting the IBC or external link state, and useful in some</span>
<span class="cm"> * cases to cause some retraining.  To do this right, we reset IBC</span>
<span class="cm"> * as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_xgxs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">prev_val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">prev_val</span> <span class="o">|</span> <span class="n">QLOGIC_IB_XGXS_RESET</span><span class="p">;</span>
	<span class="n">prev_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLOGIC_IB_XGXS_RESET</span><span class="p">;</span> <span class="cm">/* be sure */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QLOGIC_IB_C_LINKENABLE</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_xgxs_cfg</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_control</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For this chip, we want to use the same buffer every time</span>
<span class="cm"> * when we are trying to bring the link up (they are always VL15</span>
<span class="cm"> * packets).  At that link state the packet should always go out immediately</span>
<span class="cm"> * (or at least be discarded at the tx interface if the link is down).</span>
<span class="cm"> * If it doesn&#39;t, and the buffer isn&#39;t available, that means some other</span>
<span class="cm"> * sender has gotten ahead of us, and is preventing our packet from going</span>
<span class="cm"> * out.  In that case, we flush all packets, and try again.  If that still</span>
<span class="cm"> * fails, we fail the request, and hope things work the next time around.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t need very complicated heuristics on whether the packet had</span>
<span class="cm"> * time to go out or not, since even at SDR 1X, it goes out in very short</span>
<span class="cm"> * time periods, covered by the chip reads done here and as part of the</span>
<span class="cm"> * flush.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">get_7220_link_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lbuf</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_cleanup</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * always blip to get avail list updated, since it&#39;s almost</span>
<span class="cm">	 * always needed, and is fairly cheap.</span>
<span class="cm">	 */</span>
	<span class="n">sendctrl_7220_mod</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
	<span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span> <span class="cm">/* extra chip flush */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">qib_getsendbuf_range</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">bnum</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">qib_sdma_state_s20_idle</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_state</span> <span class="o">!=</span> <span class="n">qib_sdma_state_s00_hw_down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">qib_sdma_event_e00_go_hw_down</span><span class="p">);</span>
		<span class="n">do_cleanup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">do_cleanup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qib_7220_sdma_hw_clean_up</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_cleanup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span> <span class="cm">/* extra chip flush */</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">qib_getsendbuf_range</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">bnum</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This code for non-IBTA-compliant IB speed negotiation is only known to</span>
<span class="cm"> * work for the SDR to DDR transition, and only between an HCA and a switch</span>
<span class="cm"> * with recent firmware.  It is based on observed heuristics, rather than</span>
<span class="cm"> * actual knowledge of the non-compliant speed negotiation.</span>
<span class="cm"> * It has a number of hard-coded fields, since the hope is to rewrite this</span>
<span class="cm"> * when a spec is available on how the negoation is intended to work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autoneg_7220_sendpkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">dcnt</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pbc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbc</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">dcnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 7 dword header, dword data, icrc */</span>
	<span class="n">pbc</span> <span class="o">|=</span> <span class="n">PBC_7220_VL15_SEND</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">=</span> <span class="n">get_7220_link_buf</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pnum</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sendctrl_7220_mod</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_DISARM_BUF</span><span class="p">(</span><span class="n">pnum</span><span class="p">));</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">pbc</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
	<span class="n">qib_flush_wc</span><span class="p">();</span>
	<span class="n">qib_pio_copy</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">qib_pio_copy</span><span class="p">(</span><span class="n">piobuf</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_USE_SPCL_TRIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">spcl_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">pnum</span> <span class="o">&gt;=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2047</span> <span class="o">:</span> <span class="mi">1023</span><span class="p">;</span>

		<span class="n">qib_flush_wc</span><span class="p">();</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xaebecede</span><span class="p">,</span> <span class="n">piobuf</span> <span class="o">+</span> <span class="n">spcl_off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qib_flush_wc</span><span class="p">();</span>
	<span class="n">qib_sendbuf_done</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * _start packet gets sent twice at start, _done gets sent twice at end</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autoneg_7220_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">swapped</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xf002ffff</span><span class="p">,</span> <span class="mh">0x48ffff</span><span class="p">,</span> <span class="mh">0x6400abba</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">madpayload_start</span><span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x1810103</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2c90000</span><span class="p">,</span> <span class="mh">0x2c9</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1388</span><span class="p">,</span> <span class="mh">0x15e</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="cm">/* rest 0&#39;s */</span>
		<span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">madpayload_done</span><span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x1810103</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2c90000</span><span class="p">,</span> <span class="mh">0x2c9</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="mh">0x40000001</span><span class="p">,</span> <span class="mh">0x1388</span><span class="p">,</span> <span class="mh">0x15e</span><span class="p">,</span> <span class="cm">/* rest 0&#39;s */</span>
		<span class="p">};</span>

	<span class="n">dcnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">madpayload_start</span><span class="p">);</span>
	<span class="n">hcnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for maintainability, do it at runtime */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">madpayload_start</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">madpayload_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
			<span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">madpayload_done</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">madpayload_done</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">which</span> <span class="o">?</span> <span class="n">madpayload_done</span> <span class="o">:</span> <span class="n">madpayload_start</span><span class="p">;</span>

	<span class="n">autoneg_7220_sendpkt</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">autoneg_7220_sendpkt</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">dcnt</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do the absolute minimum to cause an IB speed change, and make it</span>
<span class="cm"> * ready, but don&#39;t actually trigger the change.   The caller will</span>
<span class="cm"> * do that when ready (if link is in Polling training state, it will</span>
<span class="cm"> * happen immediately, otherwise when link next goes down)</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should only be used as part of the DDR autonegotation</span>
<span class="cm"> * code for devices that are not compliant with IB 1.2 (or code that</span>
<span class="cm"> * fixes things up for same).</span>
<span class="cm"> *</span>
<span class="cm"> * When link has gone down, and autoneg enabled, or autoneg has</span>
<span class="cm"> * failed and we give up until next time we set both speeds, and</span>
<span class="cm"> * then we want IBTA enabled as well as &quot;use max enabled speed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_7220_ibspeed_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IBA7220_IBC_SPEED_AUTONEG_MASK</span> <span class="o">|</span>
		<span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="p">(</span><span class="n">QIB_IB_SDR</span> <span class="o">|</span> <span class="n">QIB_IB_DDR</span><span class="p">))</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span> <span class="n">IBA7220_IBC_SPEED_AUTONEG_MASK</span> <span class="o">|</span>
			<span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">QIB_IB_DDR</span> <span class="o">?</span>
			<span class="n">IBA7220_IBC_SPEED_DDR</span> <span class="o">:</span> <span class="n">IBA7220_IBC_SPEED_SDR</span><span class="p">;</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ibcddrctrl</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is only used when we are not talking to another</span>
<span class="cm"> * IB 1.2-compliant device that we think can do DDR.</span>
<span class="cm"> * (This includes all existing switch chips as of Oct 2007.)</span>
<span class="cm"> * 1.2-compliant devices go directly to DDR prior to reaching INIT</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">try_7220_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Required for older non-IB1.2 DDR switches.  Newer</span>
<span class="cm">	 * non-IB-compliant switches don&#39;t need it, but so far,</span>
<span class="cm">	 * aren&#39;t bothered by it either.  &quot;Magic constant&quot;</span>
<span class="cm">	 */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ncmodectrl</span><span class="p">,</span> <span class="mh">0x3b9dc07</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">autoneg_7220_send</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_7220_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_DDR</span><span class="p">);</span>

	<span class="n">toggle_7220_rclkrls</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">);</span>
	<span class="cm">/* 2 msec is minimum length of a poll cycle */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ib_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_work</span><span class="p">,</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the empirically determined mechanism for auto-negotiation</span>
<span class="cm"> * of DDR speed with switches.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autoneg_7220_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">startms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qib_chippport_specific</span><span class="p">,</span>
			    <span class="n">autoneg_work</span><span class="p">.</span><span class="n">work</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pportdata</span><span class="p">;</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">startms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Busy wait for this first part, it should be at most a</span>
<span class="cm">	 * few hundred usec, since we scheduled ourselves for 2msec.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lastibcstat</span><span class="p">,</span> <span class="n">IBCStatus</span><span class="p">,</span> <span class="n">LinkTrainingState</span><span class="p">)</span>
		     <span class="o">==</span> <span class="n">IB_7220_LT_STATE_POLLQUIET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qib_set_linkstate</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_LINKDOWN_DISABLE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span> <span class="cm">/* we got there early or told to stop */</span>

	<span class="cm">/* we expect this to timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">,</span>
			       <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">),</span>
			       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">90</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">toggle_7220_rclkrls</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/* we expect this to timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">,</span>
			       <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">),</span>
			       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1700</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">set_7220_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_SDR</span><span class="p">);</span>
	<span class="n">toggle_7220_rclkrls</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait up to 250 msec for link to train and get to INIT at DDR;</span>
<span class="cm">	 * this should terminate early.</span>
<span class="cm">	 */</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">,</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">),</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">));</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">==</span> <span class="n">AUTONEG_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">|=</span> <span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_7220_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_7220_iblink_state</span><span class="p">(</span><span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ibcs</span><span class="p">,</span> <span class="n">IBCStatus</span><span class="p">,</span> <span class="n">LinkState</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_7220_L_STATE_INIT</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_INIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_7220_L_STATE_ARM</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_ARMED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_7220_L_STATE_ACTIVE</span>:
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IB_7220_L_STATE_ACT_DEFER</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_ACTIVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IB_7220_L_STATE_DOWN</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">IB_PORT_DOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns the IBTA port state, rather than the IBC link training state */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">qib_7220_phys_portstate</span><span class="p">(</span><span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">ibcs</span><span class="p">,</span> <span class="n">IBCStatus</span><span class="p">,</span> <span class="n">LinkTrainingState</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qib_7220_physportstate</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_ib_updown</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ibup</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ibcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">symadj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_FORCE_NOTIFY</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibup</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * When the link goes down we don&#39;t want AEQ running, so it</span>
<span class="cm">		 * won&#39;t interfere with IBC training, etc., and we need</span>
<span class="cm">		 * to go back to the static SerDes preset values.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_IB_AUTONEG_FAILED</span> <span class="o">|</span>
				     <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)))</span>
			<span class="n">set_7220_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qib_sd7220_presets</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="n">qib_cancel_sends</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span> <span class="cm">/* initial disarm, etc. */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__qib_sdma_running</span><span class="p">(</span><span class="n">ppd</span><span class="p">))</span>
				<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">qib_sdma_event_e70_go_idle</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* this might better in qib_sd7220_presets() */</span>
		<span class="n">set_7220_relock_poll</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibup</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qib_compat_ddr_negotiate</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_IB_AUTONEG_FAILED</span> <span class="o">|</span>
				     <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_SDR</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIB_IB_DDR</span> <span class="o">|</span> <span class="n">QIB_IB_SDR</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">QIB_IB_DDR</span> <span class="o">|</span> <span class="n">QIB_IB_SDR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">&lt;</span> <span class="n">AUTONEG_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we are SDR, and DDR auto-negotiation enabled */</span>
			<span class="o">++</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
					<span class="n">cr_ibsymbolerr</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span>
					<span class="n">cr_iblinkerrrecov</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">try_7220_autoneg</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no other IB status change processing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">==</span> <span class="n">QIB_IB_SDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">autoneg_7220_send</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_7220_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">QIB_IB_DDR</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">toggle_7220_rclkrls</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no other IB status change processing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">&amp;</span> <span class="n">QIB_IB_DDR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QIBL_IB_AUTONEG_INPROG</span> <span class="o">|</span>
						 <span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span>
						       <span class="n">flags</span><span class="p">);</span>
				<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">autoneg_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* re-enable SDR, for next link down */</span>
				<span class="n">set_7220_ibspeed_fast</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
						      <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span><span class="p">);</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">);</span>
				<span class="n">symadj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Clear autoneg failure flag, and do setup</span>
<span class="cm">				 * so we&#39;ll try next time link goes down and</span>
<span class="cm">				 * back to INIT (possibly connected to a</span>
<span class="cm">				 * different device).</span>
<span class="cm">				 */</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QIBL_IB_AUTONEG_FAILED</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags_lock</span><span class="p">,</span>
						       <span class="n">flags</span><span class="p">);</span>
				<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibcddrctrl</span> <span class="o">|=</span>
					<span class="n">IBA7220_IBC_IBTA_1_2_MASK</span><span class="p">;</span>
				<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_ncmodectrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">symadj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span>
			<span class="n">symadj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">delay_mult</span> <span class="o">=</span> <span class="n">rate_to_delay</span>
			    <span class="p">[(</span><span class="n">ibcs</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7220_LINKSPEED_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
			    <span class="p">[(</span><span class="n">ibcs</span> <span class="o">&gt;&gt;</span> <span class="n">IBA7220_LINKWIDTH_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>

			<span class="n">set_7220_relock_poll</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ibup</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Unlike 7322, the 7220 needs this, due to lack of</span>
<span class="cm">			 * interrupt in some cases when we have sdma active</span>
<span class="cm">			 * when the link goes down.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">current_state</span> <span class="o">!=</span>
			    <span class="n">qib_sdma_state_s20_idle</span><span class="p">)</span>
				<span class="n">__qib_sdma_process_event</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span>
					<span class="n">qib_sdma_event_e00_go_hw_down</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symadj</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymdelta</span> <span class="o">+=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
				<span class="n">cr_ibsymbolerr</span><span class="p">)</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span><span class="p">;</span>
			<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrdelta</span> <span class="o">+=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
				<span class="n">cr_iblinkerrrecov</span><span class="p">)</span> <span class="o">-</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibup</span> <span class="o">&amp;&amp;</span> <span class="n">qib_compat_ddr_negotiate</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">QIBL_IB_AUTONEG_INPROG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibdeltainprog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">ibsymsnap</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
							  <span class="n">cr_ibsymbolerr</span><span class="p">);</span>
		<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">iblnkerrsnap</span> <span class="o">=</span> <span class="n">read_7220_creg32</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
						     <span class="n">cr_iblinkerrrecov</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">qib_setup_7220_setextled</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">ibup</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Does read/modify/write to appropriate registers to</span>
<span class="cm"> * set output and direction bits selected by mask.</span>
<span class="cm"> * these are in their canonical postions (e.g. lsb of</span>
<span class="cm"> * dir will end up in D48 of extctrl on existing chips).</span>
<span class="cm"> * returns contents of GP Inputs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gpio_7220_mod</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">out</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">read_val</span><span class="p">,</span> <span class="n">new_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some bits being written, lock access to GPIO */</span>
		<span class="n">dir</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">out</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">GPIOOe</span><span class="p">));</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dir</span> <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">EXTCtrl</span><span class="p">,</span> <span class="n">GPIOOe</span><span class="p">));</span>
		<span class="n">new_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_out</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extctrl</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">extctrl</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_gpio_out</span><span class="p">,</span> <span class="n">new_out</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_out</span> <span class="o">=</span> <span class="n">new_out</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is unlikely that a read at this time would get valid</span>
<span class="cm">	 * data on a pin whose direction line was set in the same</span>
<span class="cm">	 * call to this function. We include the read here because</span>
<span class="cm">	 * that allows us to potentially combine a change on one pin with</span>
<span class="cm">	 * a read on another, and because the old code did something like</span>
<span class="cm">	 * this.</span>
<span class="cm">	 */</span>
	<span class="n">read_val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_extstatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">read_val</span><span class="p">,</span> <span class="n">EXTStatus</span><span class="p">,</span> <span class="n">GPIOIn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read fundamental info we need to use the chip.  These are</span>
<span class="cm"> * the registers that describe chip capabilities, and are</span>
<span class="cm"> * saved in shadow registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_7220_chip_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">piobufs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">uregbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_userregbase</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidcnt</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvtidcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvtidbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvtidbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvegrbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_palign</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpiobufbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio2k_bufbase</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpiosize</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize4k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">qib_ibmtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">QIB_DEFAULT_MTU</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">ibmtu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpiobufcnt</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="cm">/* these may be adjusted in init_chip_wc_pat() */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio2kbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio2k_bufbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pio4kbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobufbase</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * 4K buffers take 2 pages; we use roundup just to be</span>
<span class="cm">		 * paranoid; we calculate it once here, rather than on</span>
<span class="cm">		 * ever buf allocate</span>
<span class="cm">		 */</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">align4k</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize4k</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">palign</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">piobufs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavregs</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">piobufs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The chip base addresses in cspec and cpspec have to be set</span>
<span class="cm"> * after possible init_chip_wc_pat(), rather than in</span>
<span class="cm"> * qib_get_7220_chip_params(), so split out as separate function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_7220_baseaddrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cregbase</span><span class="p">;</span>
	<span class="cm">/* init after possible re-map in init_chip_wc_pat() */</span>
	<span class="n">cregbase</span> <span class="o">=</span> <span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_counterregbase</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">cregbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">cregbase</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">egrtidbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbase</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define SENDCTRL_SHADOWED (SYM_MASK(SendCtrl, SendIntBufAvail) |	\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SPioEnable) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SSpecialTriggerEn) |	\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SendBufAvailUpd) |	\</span>
<span class="cp">			   SYM_MASK(SendCtrl, AvailUpdThld) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SDmaEnable) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SDmaIntEnable) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SDmaHalt) |		\</span>
<span class="cp">			   SYM_MASK(SendCtrl, SDmaSingleDescriptor))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sendctrl_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">diag_observer</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">offs</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">only_32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">local_data</span><span class="p">,</span> <span class="n">all_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">kr_sendctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;SendCtrl Hook called with offs %X, %s-bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">offs</span><span class="p">,</span> <span class="n">only_32</span> <span class="o">?</span> <span class="s">&quot;32&quot;</span> <span class="o">:</span> <span class="s">&quot;64&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">all_bits</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">only_32</span><span class="p">)</span>
		<span class="n">all_bits</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">all_bits</span><span class="p">)</span> <span class="o">!=</span> <span class="n">all_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * At least some mask bits are zero, so we need</span>
<span class="cm">		 * to read. The judgement call is whether from</span>
<span class="cm">		 * reg or shadow. First-cut: read reg, and complain</span>
<span class="cm">		 * if any bits which should be shadowed are different</span>
<span class="cm">		 * from their shadowed value.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">only_32</span><span class="p">)</span>
			<span class="n">local_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">local_data</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Sendctrl -&gt; %X, Shad -&gt; %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">local_data</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">local_data</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_SHADOWED</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_SHADOWED</span><span class="p">))</span>
			<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Sendctrl read: %X shadow is %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">local_data</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * At least some mask bits are one, so we need</span>
<span class="cm">		 * to write, but only shadow some bits.</span>
<span class="cm">		 */</span>
		<span class="n">u64</span> <span class="n">sval</span><span class="p">,</span> <span class="n">tval</span><span class="p">;</span> <span class="cm">/* Shadowed, transient */</span>

		<span class="cm">/*</span>
<span class="cm">		 * New shadow val is bits we don&#39;t want to touch,</span>
<span class="cm">		 * ORed with bits we do, that are intended for shadow.</span>
<span class="cm">		 */</span>
		<span class="n">sval</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">sval</span> <span class="o">|=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SENDCTRL_SHADOWED</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">=</span> <span class="n">sval</span><span class="p">;</span>
		<span class="n">tval</span> <span class="o">=</span> <span class="n">sval</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SENDCTRL_SHADOWED</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Sendctrl &lt;- %X, Shad &lt;- %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tval</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sval</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendctrl</span><span class="p">,</span> <span class="n">tval</span><span class="p">);</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="mi">0Ull</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">only_32</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">diag_observer</span> <span class="n">sendctrl_observer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">sendctrl_hook</span><span class="p">,</span> <span class="n">kr_sendctrl</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
	<span class="n">kr_sendctrl</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * write the final few registers that depend on some of the</span>
<span class="cm"> * init setup.  Done late in init, just before bringing up</span>
<span class="cm"> * the serdes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_late_7220_initreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrentsize</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrentsize</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrsize</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrsize</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvhdrcnt</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrcnt</span><span class="p">);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpioavailaddr</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_phys</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_sendpioavailaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Catastrophic software error, &quot;</span>
			    <span class="s">&quot;SendPIOAvailAddr written as %lx, &quot;</span>
			    <span class="s">&quot;read back as %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pioavailregs_phys</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_register_observer</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sendctrl_observer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_init_7220_variables</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_chippport_specific</span> <span class="o">*</span><span class="n">cpspec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sbufs</span><span class="p">,</span> <span class="n">updthresh</span><span class="p">;</span>

	<span class="n">cpspec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_chippport_specific</span> <span class="o">*</span><span class="p">)(</span><span class="n">dd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">pportdata</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span> <span class="o">=</span> <span class="n">ppd</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qib_chip_specific</span> <span class="o">*</span><span class="p">)(</span><span class="n">cpspec</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">num_pports</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span> <span class="o">=</span> <span class="n">cpspec</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdepb_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvmod_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>

	<span class="cm">/* we haven&#39;t yet set QIB_PRESENT, so use read directly */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">kregbase</span><span class="p">[</span><span class="n">kr_revision</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0xffffffffU</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffffffffU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Revision register read failure, &quot;</span>
			    <span class="s">&quot;giving up initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_PRESENT</span><span class="p">;</span>  <span class="cm">/* now register routines work */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">majrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span>
				    <span class="n">ChipRevMajor</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">minrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision_R</span><span class="p">,</span>
				    <span class="n">ChipRevMinor</span><span class="p">);</span>

	<span class="n">get_7220_chip_params</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_7220_boardname</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GPIO bits for TWSI data and clock,</span>
<span class="cm">	 * used for serial EEPROM.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">gpio_sda_num</span> <span class="o">=</span> <span class="n">_QIB_GPIO_SDA_NUM</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">gpio_scl_num</span> <span class="o">=</span> <span class="n">_QIB_GPIO_SCL_NUM</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">twsi_eeprom_dev</span> <span class="o">=</span> <span class="n">QIB_TWSI_EEPROM_DEV</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QIB_HAS_INTX</span> <span class="o">|</span> <span class="n">QIB_HAS_LINK_LATENCY</span> <span class="o">|</span>
		<span class="n">QIB_NODMA_RTAIL</span> <span class="o">|</span> <span class="n">QIB_HAS_THRESH_UPDATE</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">qib_special_trigger</span> <span class="o">?</span>
		<span class="n">QIB_USE_SPCL_TRIG</span> <span class="o">:</span> <span class="n">QIB_HAS_SEND_DMA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * EEPROM error log 0 is TXE Parity errors. 1 is RXE Parity.</span>
<span class="cm">	 * 2 is Some Misc, 3 is reserved for future.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hwerrs_to_log</span> <span class="o">=</span> <span class="n">HWE_MASK</span><span class="p">(</span><span class="n">TXEMemParityErr</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">hwerrs_to_log</span> <span class="o">=</span> <span class="n">HWE_MASK</span><span class="p">(</span><span class="n">RXEMemParityErr</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_st_masks</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">errs_to_log</span> <span class="o">=</span> <span class="n">ERR_MASK</span><span class="p">(</span><span class="n">ResetNegated</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_wait</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">autoneg_work</span><span class="p">,</span> <span class="n">autoneg_7220_work</span><span class="p">);</span>

	<span class="n">qib_init_pportdata</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_supported</span> <span class="o">=</span> <span class="n">IB_WIDTH_1X</span> <span class="o">|</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span> <span class="o">=</span> <span class="n">QIB_IB_SDR</span> <span class="o">|</span> <span class="n">QIB_IB_DDR</span><span class="p">;</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_enabled</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_supported</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_enabled</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_supported</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the initial values to reasonable default, will be set</span>
<span class="cm">	 * for real when link is up.</span>
<span class="cm">	 */</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_width_active</span> <span class="o">=</span> <span class="n">IB_WIDTH_4X</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">link_speed_active</span> <span class="o">=</span> <span class="n">QIB_IB_SDR</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">delay_mult</span> <span class="o">=</span> <span class="n">rate_to_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span> <span class="o">=</span> <span class="n">IB_VL_VL0</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_operational</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">vls_supported</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_mini_init</span><span class="p">)</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_rcvbthqp</span><span class="p">,</span> <span class="n">QIB_KD_QP</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">);</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">reenable_7220_chase</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">chase_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ppd</span><span class="p">;</span>

	<span class="n">qib_num_cfg_vls</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* if any 7220&#39;s, only one VL */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrentsize</span> <span class="o">=</span> <span class="n">QIB_RCVHDR_ENTSIZE</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrsize</span> <span class="o">=</span> <span class="n">QIB_DFLT_RCVHDRSIZE</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhf_offset</span> <span class="o">=</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvhdrentsize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* we always allocate at least 2048 bytes for eager buffers */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ib_mtu_enum_to_int</span><span class="p">(</span><span class="n">qib_ibmtu</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="n">max</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">:</span> <span class="n">QIB_DEFAULT_MTU</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span><span class="p">));</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize_shift</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcvegrbufsize</span><span class="p">);</span>

	<span class="n">qib_7220_tidtemplate</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can request a receive interrupt for 1 or</span>
<span class="cm">	 * more packets from current offset.  For now, we set this</span>
<span class="cm">	 * up for a single packet.</span>
<span class="cm">	 */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">rhdrhead_intr_off</span> <span class="o">=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* setup the stats timer; the add_timer is done at end of init */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">qib_get_7220_faststats</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dd</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">stats_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ACTIVITY_TIMER</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Control[4] has been added to change the arbitration within</span>
<span class="cm">	 * the SDMA engine between favoring data fetches over descriptor</span>
<span class="cm">	 * fetches.  qib_sdma_fetch_arb==0 gives data fetches priority.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_sdma_fetch_arb</span><span class="p">)</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">ureg_align</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>  <span class="cm">/* 64KB alignment */</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2kmax_dwords</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2k</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">qib_7220_config_ctxts</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_set_ctxtcnt</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>  <span class="cm">/* needed for PAT setup */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_wc_pat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_chip_wc_pat</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_7220_baseaddrs</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span> <span class="cm">/* set chip access pointers now */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_mini_init</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_create_ctxts</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">init_7220_cntrnames</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/* use all of 4KB buffers for the kernel SDMA, zero if !SDMA.</span>
<span class="cm">	 * reserve the update threshold amount for other kernel use, such</span>
<span class="cm">	 * as sending SMI, MAD, and ACKs, or 3, whichever is greater,</span>
<span class="cm">	 * unless we aren&#39;t enabling SDMA, in which case we want to use</span>
<span class="cm">	 * all the 4k bufs for the kernel.</span>
<span class="cm">	 * if this was less than the update threshold, we could wait</span>
<span class="cm">	 * a long time for an update.  Coded this way because we</span>
<span class="cm">	 * sometimes change the update threshold for various reasons,</span>
<span class="cm">	 * and we want this to remain robust.</span>
<span class="cm">	 */</span>
	<span class="n">updthresh</span> <span class="o">=</span> <span class="mi">8U</span><span class="p">;</span> <span class="cm">/* update threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_SEND_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span> <span class="o">=</span>  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
		<span class="n">sbufs</span> <span class="o">=</span> <span class="n">updthresh</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">updthresh</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbufs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span> <span class="o">-</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">lastctxt_piobuf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span> <span class="o">-</span> <span class="n">sbufs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* range is &lt;= , not &lt; */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">last_pio</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">lastctxt_piobuf</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span> <span class="o">-</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we are at 16 user contexts, we will have one 7 sbufs</span>
<span class="cm">	 * per context, so drop the update threshold to match.  We</span>
<span class="cm">	 * want to update before we actually run out, at low pbufs/ctxt</span>
<span class="cm">	 * so give ourselves some margin</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">updthresh</span><span class="p">)</span>
		<span class="n">updthresh</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">pbufsctxt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span> <span class="o">=</span> <span class="n">updthresh</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">=</span> <span class="n">updthresh</span><span class="p">;</span>

	<span class="cm">/* before full enable, no interrupts, no locking needed */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">updthresh</span> <span class="o">&amp;</span> <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span>
			     <span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">psxmitwait_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">psxmitwait_check_rate</span> <span class="o">=</span> <span class="n">QIB_7220_PSXMITWAIT_CHECK_RATE</span><span class="p">;</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">qib_7220_getsendbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pbc</span><span class="p">,</span>
					<span class="n">u32</span> <span class="o">*</span><span class="n">pbufnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">plen</span> <span class="o">=</span> <span class="n">pbc</span> <span class="o">&amp;</span> <span class="n">QIB_PBC_LENGTH_MASK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">pbc</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PBC_7220_VL15_SEND_CTRL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QIBL_IB_AUTONEG_INPROG</span> <span class="o">|</span> <span class="n">QIBL_LINKACTIVE</span><span class="p">)))</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">get_7220_link_buf</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="n">pbufnum</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piosize2kmax_dwords</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* try 4k if all 2k busy, so same last for both sizes */</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">lastbuf_for_pio</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">qib_getsendbuf_range</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pbufnum</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* these 2 &quot;counters&quot; are really control registers, and are always RW */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_set_cntr_7220_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intv</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_7220_creg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_psinterval</span><span class="p">,</span> <span class="n">intv</span><span class="p">);</span>
	<span class="n">write_7220_creg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">cr_psstart</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: no real attempt is made to generalize the SDMA stuff.</span>
<span class="cm"> * At some point &quot;soon&quot; we will have a new more generalized</span>
<span class="cm"> * set of sdma interface, and then we&#39;ll clean this up.</span>
<span class="cm"> */</span>

<span class="cm">/* Must be called with sdma_lock held, or before init finished */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_sdma_update_7220_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Commit writes to memory and advance the tail on the chip */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmatail</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_sdma_set_7220_desc_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdma_set_state_action</span> <span class="n">sdma_7220_action_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s00_hw_down</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">go_s99_running_tofalse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s10_hw_start_up_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s20_idle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s30_sw_clean_up_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s40_hw_clean_up_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s50_hw_halt_wait</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">qib_sdma_state_s99_running</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">op_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_intenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_halt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">go_s99_running_totrue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_sdma_init_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">set_state_action</span> <span class="o">=</span> <span class="n">sdma_7220_action_table</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_sdma_7220_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* Set SendDmaBase */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmabase</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_phys</span><span class="p">);</span>
	<span class="n">qib_sdma_7220_setlengen</span><span class="p">(</span><span class="n">ppd</span><span class="p">);</span>
	<span class="n">qib_sdma_update_7220_tail</span><span class="p">(</span><span class="n">ppd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Set SendDmaTail */</span>
	<span class="cm">/* Set SendDmaHeadAddr */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmaheadaddr</span><span class="p">,</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_head_phys</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve all the former &quot;kernel&quot; piobufs, using high number range</span>
<span class="cm">	 * so we get as many 4K buffers as possible</span>
<span class="cm">	 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt2k</span> <span class="o">+</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">piobcnt4k</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">sdmabufcnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">word</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">word</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">senddmabufmask</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmabufmask0</span><span class="p">,</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmabufmask1</span><span class="p">,</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmabufmask2</span><span class="p">,</span> <span class="n">senddmabufmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">first_sendbuf</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_state</span><span class="p">.</span><span class="n">last_sendbuf</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sdma_lock must be held */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">qib_sdma_7220_gethead</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sane</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_dmahead</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">swhead</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">swtail</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hwhead</span><span class="p">;</span>

	<span class="n">use_dmahead</span> <span class="o">=</span> <span class="n">__qib_sdma_running</span><span class="p">(</span><span class="n">ppd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QIB_HAS_SDMA_TIMEOUT</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">hwhead</span> <span class="o">=</span> <span class="n">use_dmahead</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_head_dma</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">qib_read_kreg32</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmahead</span><span class="p">);</span>

	<span class="n">swhead</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_head</span><span class="p">;</span>
	<span class="n">swtail</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_tail</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">sdma_descq_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swhead</span> <span class="o">&lt;</span> <span class="n">swtail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not wrapped */</span>
		<span class="n">sane</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">&gt;=</span> <span class="n">swhead</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">&lt;=</span> <span class="n">swtail</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">swhead</span> <span class="o">&gt;</span> <span class="n">swtail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wrapped around */</span>
		<span class="n">sane</span> <span class="o">=</span> <span class="p">((</span><span class="n">hwhead</span> <span class="o">&gt;=</span> <span class="n">swhead</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">hwhead</span> <span class="o">&lt;=</span> <span class="n">swtail</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* empty */</span>
		<span class="n">sane</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwhead</span> <span class="o">==</span> <span class="n">swhead</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sane</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_dmahead</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* try one more time, directly from the register */</span>
			<span class="n">use_dmahead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* assume no progress */</span>
		<span class="n">hwhead</span> <span class="o">=</span> <span class="n">swhead</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hwhead</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_sdma_7220_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hwstatus</span> <span class="o">=</span> <span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">ppd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_senddmastatus</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus</span><span class="p">,</span> <span class="n">ScoreBoardDrainInProg</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus</span><span class="p">,</span> <span class="n">AbortInProg</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus</span><span class="p">,</span> <span class="n">InternalSDmaEnable</span><span class="p">))</span> <span class="o">||</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">hwstatus</span> <span class="o">&amp;</span> <span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendDmaStatus</span><span class="p">,</span> <span class="n">ScbEmpty</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute the amount of delay before sending the next packet if the</span>
<span class="cm"> * port&#39;s send rate differs from the static rate set for the QP.</span>
<span class="cm"> * Since the delay affects this packet but the amount of the delay is</span>
<span class="cm"> * based on the length of the previous packet, use the last delay computed</span>
<span class="cm"> * and save the delay count for this packet to be used next time</span>
<span class="cm"> * we get here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">qib_7220_setpbc_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_pportdata</span> <span class="o">*</span><span class="n">ppd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">plen</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">srate</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">snd_mult</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">delay_mult</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rcv_mult</span> <span class="o">=</span> <span class="n">ib_rate_to_delay</span><span class="p">[</span><span class="n">srate</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">last_delay_mult</span><span class="p">;</span>

	<span class="n">ppd</span><span class="o">-&gt;</span><span class="n">cpspec</span><span class="o">-&gt;</span><span class="n">last_delay_mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcv_mult</span> <span class="o">&gt;</span> <span class="n">snd_mult</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">plen</span> <span class="o">*</span> <span class="p">(</span><span class="n">rcv_mult</span> <span class="o">-</span> <span class="n">snd_mult</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Indicate VL15, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vl</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">PBC_7220_VL15_SEND_CTRL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_initvl15_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_init_ctxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">IBA7220_KRCVEGRCNT</span><span class="p">;</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">;</span>
		<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegr_tid_base</span> <span class="o">=</span> <span class="n">IBA7220_KRCVEGRCNT</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">ctxt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">rcvegrcnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qib_7220_txchk_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">which</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qib_ctxtdata</span> <span class="o">*</span><span class="n">rcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TXCHK_CHG_TYPE_KERN</span>:
		<span class="cm">/* see if we need to raise avail update threshold */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uctxt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">first_user_ctxt</span><span class="p">;</span>
		     <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">!=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span>
		     <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span> <span class="o">&amp;&amp;</span>
			   <span class="p">((</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">piocnt</span> <span class="o">/</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">rcd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			   <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">uctxt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cfgctxts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh_dflt</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">&amp;</span>
					 <span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
					   <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sendctrl_7220_mod</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TXCHK_CHG_TYPE_USER</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcd</span> <span class="o">&amp;&amp;</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">piocnt</span>
			<span class="o">/</span> <span class="n">rcd</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcd</span><span class="o">-&gt;</span><span class="n">piocnt</span> <span class="o">/</span>
						<span class="n">rcd</span><span class="o">-&gt;</span><span class="n">subctxt_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_MASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">updthresh</span> <span class="o">&amp;</span>
					<span class="n">SYM_RMASK</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">))</span>
					<span class="o">&lt;&lt;</span> <span class="n">SYM_LSB</span><span class="p">(</span><span class="n">SendCtrl</span><span class="p">,</span> <span class="n">AvailUpdThld</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sendctrl_7220_mod</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">QIB_SENDCTRL_AVAIL_BLIP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">sendctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">writescratch</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_scratch</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define VALID_TS_RD_REG_MASK 0xBF</span>
<span class="cm">/**</span>
<span class="cm"> * qib_7220_tempsense_read - read register of temp sensor via TWSI</span>
<span class="cm"> * @dd: the qlogic_ib device</span>
<span class="cm"> * @regnum: register to read from</span>
<span class="cm"> *</span>
<span class="cm"> * returns reg contents (0..255) or &lt; 0 for error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_tempsense_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return a bogus value for (the one) register we do not have */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">regnum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VALID_TS_RD_REG_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_twsi_blk_rd</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">QIB_TWSI_TEMP_DEV</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eep_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There are three possibilities here:</span>
<span class="cm">	 * ret is actual value (0..255)</span>
<span class="cm">	 * ret is -ENXIO or -EINVAL from twsi code or this file</span>
<span class="cm">	 * ret is -EINTR from mutex_lock_interruptible.</span>
<span class="cm">	 */</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Dummy function, as 7220 boards never disable EEPROM Write */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qib_7220_eeprom_wen</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qib_init_iba7220_funcs - set up the chip-specific function pointers</span>
<span class="cm"> * @dev: the pci_dev for qlogic_ib device</span>
<span class="cm"> * @ent: pci_device_id struct for this dev</span>
<span class="cm"> *</span>
<span class="cm"> * This is global, and is called directly at init to set up the</span>
<span class="cm"> * chip-specific function pointers for later use.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="nf">qib_init_iba7220_funcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qib_devdata</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">boardid</span><span class="p">,</span> <span class="n">minwidth</span><span class="p">;</span>

	<span class="n">dd</span> <span class="o">=</span> <span class="n">qib_alloc_devdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_chip_specific</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qib_chippport_specific</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_bringup_serdes</span>    <span class="o">=</span> <span class="n">qib_7220_bringup_serdes</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_cleanup</span>           <span class="o">=</span> <span class="n">qib_setup_7220_cleanup</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_clear_tids</span>        <span class="o">=</span> <span class="n">qib_7220_clear_tids</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_free_irq</span>          <span class="o">=</span> <span class="n">qib_7220_free_irq</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_base_info</span>     <span class="o">=</span> <span class="n">qib_7220_get_base_info</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_msgheader</span>     <span class="o">=</span> <span class="n">qib_7220_get_msgheader</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_getsendbuf</span>        <span class="o">=</span> <span class="n">qib_7220_getsendbuf</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_gpio_mod</span>          <span class="o">=</span> <span class="n">gpio_7220_mod</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_eeprom_wen</span>        <span class="o">=</span> <span class="n">qib_7220_eeprom_wen</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_hdrqempty</span>         <span class="o">=</span> <span class="n">qib_7220_hdrqempty</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_ib_updown</span>         <span class="o">=</span> <span class="n">qib_7220_ib_updown</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_init_ctxt</span>         <span class="o">=</span> <span class="n">qib_7220_init_ctxt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_initvl15_bufs</span>     <span class="o">=</span> <span class="n">qib_7220_initvl15_bufs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_intr_fallback</span>     <span class="o">=</span> <span class="n">qib_7220_intr_fallback</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_late_initreg</span>      <span class="o">=</span> <span class="n">qib_late_7220_initreg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_setpbc_control</span>    <span class="o">=</span> <span class="n">qib_7220_setpbc_control</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_portcntr</span>          <span class="o">=</span> <span class="n">qib_portcntr_7220</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_put_tid</span>           <span class="o">=</span> <span class="n">qib_7220_put_tid</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_quiet_serdes</span>      <span class="o">=</span> <span class="n">qib_7220_quiet_serdes</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_rcvctrl</span>           <span class="o">=</span> <span class="n">rcvctrl_7220_mod</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_read_cntrs</span>        <span class="o">=</span> <span class="n">qib_read_7220cntrs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_read_portcntrs</span>    <span class="o">=</span> <span class="n">qib_read_7220portcntrs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_reset</span>             <span class="o">=</span> <span class="n">qib_setup_7220_reset</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_init_sdma_regs</span>    <span class="o">=</span> <span class="n">init_sdma_7220_regs</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_busy</span>         <span class="o">=</span> <span class="n">qib_sdma_7220_busy</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_gethead</span>      <span class="o">=</span> <span class="n">qib_sdma_7220_gethead</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_sendctrl</span>     <span class="o">=</span> <span class="n">qib_7220_sdma_sendctrl</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_set_desc_cnt</span> <span class="o">=</span> <span class="n">qib_sdma_set_7220_desc_cnt</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_update_tail</span>  <span class="o">=</span> <span class="n">qib_sdma_update_7220_tail</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_hw_clean_up</span>  <span class="o">=</span> <span class="n">qib_7220_sdma_hw_clean_up</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_hw_start_up</span>  <span class="o">=</span> <span class="n">qib_7220_sdma_hw_start_up</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sdma_init_early</span>   <span class="o">=</span> <span class="n">qib_7220_sdma_init_early</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_sendctrl</span>          <span class="o">=</span> <span class="n">sendctrl_7220_mod</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_armlaunch</span>     <span class="o">=</span> <span class="n">qib_set_7220_armlaunch</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_cntr_sample</span>   <span class="o">=</span> <span class="n">qib_set_cntr_7220_sample</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_iblink_state</span>      <span class="o">=</span> <span class="n">qib_7220_iblink_state</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_ibphys_portstate</span>  <span class="o">=</span> <span class="n">qib_7220_phys_portstate</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_get_ib_cfg</span>        <span class="o">=</span> <span class="n">qib_7220_get_ib_cfg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_ib_cfg</span>        <span class="o">=</span> <span class="n">qib_7220_set_ib_cfg</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_ib_loopback</span>   <span class="o">=</span> <span class="n">qib_7220_set_loopback</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_set_intr_state</span>    <span class="o">=</span> <span class="n">qib_7220_set_intr_state</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_setextled</span>         <span class="o">=</span> <span class="n">qib_setup_7220_setextled</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_txchk_change</span>      <span class="o">=</span> <span class="n">qib_7220_txchk_change</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_update_usrhead</span>    <span class="o">=</span> <span class="n">qib_update_7220_usrhead</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_wantpiobuf_intr</span>   <span class="o">=</span> <span class="n">qib_wantpiobuf_7220_intr</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_xgxs_reset</span>        <span class="o">=</span> <span class="n">qib_7220_xgxs_reset</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_writescratch</span>      <span class="o">=</span> <span class="n">writescratch</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">f_tempsense_rd</span>	<span class="o">=</span> <span class="n">qib_7220_tempsense_rd</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do remaining pcie setup and save pcie values in dd.</span>
<span class="cm">	 * Any error printing is already done by the init code.</span>
<span class="cm">	 * On return, we have the chip mapped, but chip registers</span>
<span class="cm">	 * are not set up until start of qib_init_7220_variables.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_pcie_ddinit</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail_free</span><span class="p">;</span>

	<span class="cm">/* initialize chip-specific variables */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qib_init_7220_variables</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail_cleanup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_mini_init</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">boardid</span> <span class="o">=</span> <span class="n">SYM_FIELD</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">Revision</span><span class="p">,</span>
			    <span class="n">BoardID</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boardid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">10</span>:
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">minwidth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* x16 capable boards */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">minwidth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* x8 capable boards */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qib_pcie_params</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">minwidth</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">qib_dev_err</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s">&quot;Failed to setup PCIe or interrupts; &quot;</span>
			    <span class="s">&quot;continuing anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* save IRQ for possible later use */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">cspec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qib_read_kreg64</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrstatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">QLOGIC_IB_HWE_SERDESPLLFAILED</span><span class="p">)</span>
		<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwerrclear</span><span class="p">,</span>
			       <span class="n">QLOGIC_IB_HWE_SERDESPLLFAILED</span><span class="p">);</span>

	<span class="cm">/* setup interrupt handler (interrupt type handled above) */</span>
	<span class="n">qib_setup_7220_interrupt</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">qib_7220_init_hwerrors</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/* clear diagctrl register, in case diags were running and crashed */</span>
	<span class="n">qib_write_kreg</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">kr_hwdiagctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

<span class="nl">bail_cleanup:</span>
	<span class="n">qib_pcie_ddcleanup</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="nl">bail_free:</span>
	<span class="n">qib_free_devdata</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">dd</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
